!function(e,t){"use strict";class r{static registerProvider(e,t){if(r.registry[e])throw new Error("Overlapping batch optimization");r.registry[e]=t}static createProvider(e){return new(r.registry[e]||a)}}r.registry={};class a{batch(e,t,r,a){for(let a=t;a<=r;a++)e.add(e.elements[a])}reset(){}destroy(){}}class i{constructor(){this._num=0,this._updateRange=new t.Vector2(1e8,-1e8)}_modifyOneView(e){this._updateRange.y=Math.max(e.start+e.length,this._updateRange.y),this._updateRange.x=Math.min(e.start,this._updateRange.x)}addDataView(e){e._next=null,e._prev=null,this._first||(this._first=e),this._last&&(this._last._next=e,e._prev=this._last),e.owner=this,this._last=e,this._num++}removeDataView(e){e.owner=null,e._prev&&(e._prev._next=e._next),e._next&&(e._next._prev=e._prev),e==this._first&&(this._first=e._next),e==this._last&&(this._last=e._prev),e._next=null,e._prev=null,this._updateRange.x=Math.min(e.start,this._updateRange.x),this._updateRange.y=Math.max(e.start+e.length,this._updateRange.y),this._num--}destroy(){this._first=null,this._last=null,this._dataView=null,this.arrayBuffer=null}}class s extends i{resetData(e){this.arrayBuffer=new ArrayBuffer(e);let t=new Float32Array(this.arrayBuffer);this._dataView&&t.set(this._dataView),this._dataView=t,this._needResetData=!0}_upload(){if(this._needResetData){let e=this._first;for(;e;)e._updateView(this._dataView),e=e._next;this.buffer.setData(this.arrayBuffer,0,0,this.arrayBuffer.byteLength),this._needResetData=!1}else{if(this._updateRange.y<=this._updateRange.x)return;this.buffer.setData(this.arrayBuffer,4*this._updateRange.x,4*this._updateRange.x,4*(this._updateRange.y-this._updateRange.x))}this._updateRange.setValue(1e8,-1e8)}}class n extends i{resetData(e){this.arrayBuffer=new ArrayBuffer(e);let t=new Uint16Array(this.arrayBuffer);this._dataView&&t.set(this._dataView),this._dataView=t,this._needResetData=!0}_upload(){let e=this._first,t=0,r=0,a=e._geometry,i=!1,s=this._needResetData?0:this._updateRange.x;for(;e;)a!=e._geometry&&(i&&(a.clearRenderParams(),a.setDrawElemenParams(r,2*t)),a=e._geometry,t+=r,r=0),t+=r,i=this._needResetData||t>=s,i&&(e.start=t,e._updateView(this._dataView)),r+=e.length,e=e._next;i&&(a.clearRenderParams(),a.setDrawElemenParams(r,2*t));let n=this._last.start+this._last.length-s,l=2*s;l=4*Math.floor(l/4),this.buffer.setData(this.arrayBuffer,l,l,2*n+(2*s-l)),this._needResetData=!1}_modifyOneView(e){this.addDataView(e),e._prev?e.start=e._prev.start+e._prev.length:e.start=0,super._modifyOneView(e)}}class l extends n{_upload(){let e=this._first,t=this._needResetData?0:this._updateRange.x;for(;e;)(this._needResetData||e.start>=t)&&e._updateView(this._dataView),e=e._next;let r=this._last.start+this._last.length-t;if(0==r)return;let a=2*t;a=4*Math.floor(a/4);let i=2*r+(2*t-a);i+a>this.arrayBuffer.byteLength&&(a-=i+a-this.arrayBuffer.byteLength),this.buffer.setData(this.arrayBuffer,a,a,i),this._needResetData=!1}_modifyOneView(e){super._modifyOneView(e),e._geometry&&(e._geometry.clearRenderParams(),e._geometry.setDrawElemenParams(e.length,2*e.start))}clearBufferViews(){this._first=null,this._last=null,this._num=0,this._updateRange.setValue(1e8,-1e8)}_resetData(e){super.resetData(e)}}class _{constructor(){this.indexCount=0,this.maxIndexCount=0,this.bufferStates=new Map,this.indexBuffer=t.LayaGL.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic),this.indexBuffer.indexType=t.IndexFormat.UInt16,this.wholeBuffer=new l,this.wholeBuffer.buffer=this.indexBuffer,t.LayaGL.renderEngine.gl?this.add=this._addWebgl:this.add=this._addWebgpu}_addWebgl(e){let t=e.owner.renderDataHandler,r=t._getBlocks();if(!r)return null;let a=t.getCloneViews()[e._index],i=r[e._index].vertexBuffer,s=this.bindBuffer(i);return this.indexCount+=a.length,this.wholeBuffer._modifyOneView(a),a._geometry.bufferState!==s&&(a._geometry.bufferState=s),T.setBuffer(this.wholeBuffer),this.updateBufLength(),a._geometry}_addWebgpu(e){let t=e.owner.renderDataHandler,r=t._getBlocks();if(!r)return null;let a=t.getCloneViews()[e._index],i=r[e._index].vertexBuffer,s=this.bindBuffer(i);return this.indexCount+=a.length,this.wholeBuffer._modifyOneView(a),a._geometry._bufferState!==s&&(a._geometry.bufferState=s),T.setBuffer(this.wholeBuffer),this.updateBufLength(),a._geometry}add(e){return null}updateBufLength(){if(this.maxIndexCount<=this.indexCount){let e=Math.ceil(this.indexCount/d)*d,t=2*e;this.indexBuffer._setIndexDataLength(t),this.wholeBuffer._resetData(t),this.maxIndexCount=e}}bindBuffer(e){let r=this.bufferStates.get(e);return r||(r=t.LayaGL.renderDeviceFactory.createBufferState(),r.applyState([e],this.indexBuffer),this.bufferStates.set(e,r)),r}clear(){this.indexCount=0,this.wholeBuffer.clearBufferViews()}destroy(){this.clear(),this.bufferStates.forEach(e=>{e.destroy()}),this.bufferStates.clear(),this.indexBuffer.destroy(),this.indexBuffer=null,this.wholeBuffer.destroy(),this.wholeBuffer=null}}class h{constructor(){this.textureId=0,this.globalAlpha=1,this.clipInfo=null,this.subShader=null,this.bufferState=null,this.primitiveShaderData=null,this.materialShaderData=null,this.type=0,this.lowType=0,this.globalRenderData=null,this.fillTexture=!1,!!t.LayaGL.renderEngine.gl?(this.setHead=this._setHeadWebgl,this.isCompatible=this._isCompatibleWebgl):(this.setHead=this._setHeadWebgpu,this.isCompatible=this._isCompatibleWebgpu)}_setHeadWebgl(e){this.primitiveShaderData=e.primitiveShaderData,this.materialShaderData=e.materialShaderData,this.subShader=e.subShader,this.bufferState=e.geometry.bufferState,this.textureId=-64&e.type,this.globalAlpha=e.owner.globalAlpha,this.clipInfo=e.owner.getClipInfo(),this.type=e.type,this.lowType=63&e.type,this.globalRenderData=e.owner.globalRenderData,this.fillTexture=this.primitiveShaderData.hasDefine(t.ShaderDefines2D.FILLTEXTURE),this.texRange=this.primitiveShaderData.getVector(t.ShaderDefines2D.UNIFORM_TEXRANGE)}_setHeadWebgpu(e){this.primitiveShaderData=e._primitiveShaderData,this.materialShaderData=e._materialShaderData,this.subShader=e._subShader,this.bufferState=e.geometry._bufferState,this.textureId=-64&e.type,this.globalAlpha=e.owner.globalAlpha,this.clipInfo=e.owner.getClipInfo(),this.type=e.type,this.lowType=63&e.type,this.globalRenderData=e.owner.globalRenderData,this.fillTexture=this.primitiveShaderData.hasDefine(t.ShaderDefines2D.FILLTEXTURE),this.texRange=this.primitiveShaderData.getVector(t.ShaderDefines2D.UNIFORM_TEXRANGE)}setHead(e){}_isCompatibleWebgl(e){if(32&this.type)return!1;let r=e.type;if(32&r)return!1;let a=63&r,i=-64&r;if(0!==i&&i!==this.textureId&&0!==this.textureId)return!1;if(this.lowType!==a)return!1;let s=e.owner;if(this.globalAlpha!==s.globalAlpha)return!1;if(this.subShader!==e.subShader||this.bufferState!==e.geometry.bufferState||this.clipInfo!==s.getClipInfo()||s.globalRenderData!==this.globalRenderData)return!1;if(16&this.lowType&&e.materialShaderData!==this.materialShaderData)return!1;if(e.primitiveShaderData.hasDefine(t.ShaderDefines2D.FILLTEXTURE)){if(!this.fillTexture)return!1;if(!e.primitiveShaderData.getVector(t.ShaderDefines2D.UNIFORM_TEXRANGE).equal(this.texRange))return!1}else if(this.fillTexture)return!1;return 0===this.textureId&&0!==i&&(this.textureId=i,this.primitiveShaderData=e.primitiveShaderData),!0}_isCompatibleWebgpu(e){if(32&this.type)return!1;let r=e.type;if(32&r)return!1;let a=63&r,i=-64&r;if(0!==i&&i!==this.textureId&&0!==this.textureId)return!1;if(this.lowType!==a)return!1;let s=e.owner;if(this.globalAlpha!==s.globalAlpha)return!1;if(this.subShader!==e.subShader||this.bufferState!==e.geometry.bufferState||this.clipInfo!==s.getClipInfo()||s.globalRenderData!==this.globalRenderData)return!1;if(16&this.lowType&&e._materialShaderData!==this.materialShaderData)return!1;let n=e._primitiveShaderData;if(n.hasDefine(t.ShaderDefines2D.FILLTEXTURE)){if(!this.fillTexture)return!1;if(!n.getVector(t.ShaderDefines2D.UNIFORM_TEXRANGE).equal(this.texRange))return!1}else if(this.fillTexture)return!1;return 0===this.textureId&&0!==i&&(this.textureId=i,this.primitiveShaderData=n),!0}isCompatible(e){return!0}}class o{constructor(){this._buffer=new _,this._merged=[],this._context=new h}reset(){this._buffer.clear(),o._pool.recover(this._merged)}destroy(){this._buffer.destroy(),o._pool.recover(this._merged)}batch(e,t,r,a){let i=e.elements,s=this._context;s.setHead(i[t]);let n=r-t+1;if(n>1e3&&(a=!1),a){null==u&&(l=1e3,u=new Int16Array(l),m=new Int16Array(l),f=new Float32Array(l),c=new Float32Array(l),p=new Float32Array(l),g=new Float32Array(l));let r=0,a=1,_=1;m[0]=t,u[0]=0;for(let e=1;e<n;e++){let r=i[t+e];u[e]=-1;let a=r.owner.rect;f[e]=a.x,c[e]=a.y,p[e]=a.x+a.width,g[e]=a.y+a.height}for(let l=1;l<n;l++){let h=i[t+l],o=u[l];if(-2!==o){if(-1!==o){if(o===r){m[_++]=t+l;continue}}else{if(s.isCompatible(h)){m[_++]=t+l;continue}u[l]=o=a++}for(let e=l+1;e<n;e++){let a=i[t+e];if(-1!==u[e]){if(u[e]!==r)continue}else if(!s.isCompatible(a))continue;for(let t=e-1;t>=l;t--)if(-2!==u[t]&&f[e]<p[t]&&p[e]>f[t]&&c[e]<g[t]&&g[e]>c[t]){a=null;break}null!=a?(m[_++]=t+e,u[e]=-2):u[e]=r}e.add(this.merge(i,0,_-1,s,m)),_=1,m[0]=t+l,r=o,s.setHead(h)}}e.add(this.merge(i,0,_-1,s,m))}else{let a=t;for(let n=t+1;n<=r;n++){let t=i[n];s.isCompatible(t)||(e.add(this.merge(i,a,n-1,s)),a=n,s.setHead(t))}e.add(this.merge(i,a,r,s))}var l}merge(e,t,r,a,i){if(t===r){let r=e[void 0!==i?i[t]:t];return this._buffer.add(r),r}let s=o._pool.take();this._merged.push(s);let n=s.geometry,l=0,_=0,h=!0;for(let o=t;o<=r;o++){let r=e[void 0!==i?i[o]:o],d=this._buffer.add(r)||r.geometry;o===t&&(n.bufferState=d.bufferState,s.materialShaderData=r.materialShaderData,s.value2DShaderData=r.value2DShaderData,s.subShader=r.subShader,s.renderStateIsBySprite=r.renderStateIsBySprite,s.primitiveShaderData=a.primitiveShaderData,s.owner=r.owner);let u=d.drawParams.elements,m=d.drawParams.length;for(let e=0;e<m;e+=2){let t=u[e],r=u[e+1];h?(l=t,_=r,h=!1):l+2*_===t?_+=r:(n.setDrawElemenParams(_,l),l=t,_=r)}}return h||n.setDrawElemenParams(_,l),s}}o._pool=t.Pool.createPool2(()=>{let e=t.LayaGL.render2DRenderPassFactory.createPrimitiveRenderElement2D();return e.geometry=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),e.geometry.indexFormat=t.IndexFormat.UInt16,e.nodeCommonMap=["Sprite2D"],e.renderStateIsBySprite=!1,e},null,e=>{e.geometry.clearRenderParams(),e.geometry.bufferState=null,e.materialShaderData=null,e.value2DShaderData=null,e.primitiveShaderData=null,e.subShader=null,e.owner=null,e.renderStateIsBySprite=!1,e.globalShaderData=null});const d=1024;var u,m,f,c,p,g;r.registerProvider(t.BaseRender2DType.graphics,o);class E{constructor(){this.lists=new Map,this._indice=new Set,this._sortedIndice=[]}add(e,r){let a=this.lists.get(r);return a||this.lists.set(r,a=new t.FastSinglelist),a.add(e),1===a.length&&this._indice.add(r),a}reset(){this._indice.forEach(e=>this.lists.get(e).length=0),this._indice.clear(),this._sortedIndice.length=0}get indice(){let e=this._sortedIndice;if(0===e.length){for(let t of this._indice)e.push(t);e.sort((e,t)=>e-t)}return e}appendTo(e){this.indice.forEach(t=>e.addList(this.lists.get(t)))}}class T{get priority(){return this._priority}set priority(e){this._priority=e,this._mask&&this._mask.setMaskParentPass(this)}get mask(){return this._mask}set mask(e){this._mask&&this._mask.setMaskParentPass(null),this._mask=e,e&&e.setMaskParentPass(this)}get enableBatch(){return this._enableBatch}set enableBatch(e){this.repaint=!0,this._enableBatch=e}setClearColor(e,t,r,a){this._clearColor.setValue(e,t,r,a)}constructor(){this._renderElements=new t.FastSinglelist,this._elementGroups=new t.FastSinglelist,this._structs=new E,this._structsPool=t.Pool.createPool(E,null,e=>e.reset()),this._batchProviders=[],this._priority=0,this.enable=!0,this.isSupport=!1,this.postProcess=null,this.repaint=!0,this._clearColor=new t.Color,this.doClearColor=!0,this.finalize=null,this._enableBatch=!0,this._rtsize=new t.Vector2,this.root=null,this.offsetMatrix=new t.Matrix,this._invertMat_0=new t.Vector3(1,1),this._invertMat_1=new t.Vector3(0,0),this.shaderData=null,this.destroyed=!1,this.shaderData=t.LayaGL.renderDeviceFactory.createShaderData(null)}needRender(){return this.enable&&!this.isSupport&&(this.repaint||!this.renderTexture)}cullAndSort(e,t){if(!t.enabled||t.globalAlpha<.01||this._mask===t)return;let r=t.subStruct&&t!==this.root?t.subStruct:t;r._handleInterData();let a=t.globalRenderData;if(a){if(t._currentData.globalRenderData&&0===(t.renderLayer&a.renderLayerMask))return;let e=a.cullRect;if(t.inheritedEnableCulling&&e&&!this._isRectIntersect(t.rect,e))return}r.renderUpdate(e);let i=this._pStructs.add(r,t._effectZ);if(t.stackingRoot){var s=this._pStructs;this._pStructs=this._structsPool.take()}for(let a=0,i=r.children.length;a<i;a++){const i=r.children[a];i._effectZ=i.zIndex+t._effectZ,this.cullAndSort(e,i)}if(s&&(this._pStructs.appendTo(i),this._structsPool.recover(this._pStructs),this._pStructs=s),t.dcOptimize){let e=i.length-1;t.dcOptimizeEnd=i.elements[e]}}_isRectIntersect(e,t){let r=e.x,a=e.x+e.width,i=e.y,s=e.y+e.height;return!(a<t.x||r>t.y||s<t.z||i>t.w)}fowardRender(e){var r,a;if(this._initRenderProcess(e)){if(this.repaint){this._structs.reset(),this._renderElements.length=0;for(let e=0,t=this._batchProviders.length;e<t;e++)null===(r=this._batchProviders[e])||void 0===r||r.reset();if(this.root&&(this._pStructs=this._structs,this.cullAndSort(e,this.root),this.fillRenderElements(),this._enableBatch&&t.LayaEnv.isPlaying&&this.batch()),T.uploadBuffer(),e.drawRenderElementList(this._renderElements),this._mask){let t=this._mask.subStruct;t._handleInterData(),t.renderUpdate(e),e.drawRenderElementOne(t.renderElements[0])}(null===(a=this.postProcess)||void 0===a?void 0:a.enabled)&&this.postProcess.apply()}else this._structs.indice.forEach(t=>{let r=this._structs.lists.get(t);for(let t=0,a=r.length;t<a;t++){let a=r.elements[t];a._handleInterData(),a.renderUpdate(e)}}),T.uploadBuffer(),e.drawRenderElementList(this._renderElements);this.repaint=!1}}fillRenderElements(){this._elementGroups.length=0;let e,r=0,a=this._renderElements;this._structs.indice.forEach(i=>{let s=this._structs.lists.get(i);for(let i=0,n=s.length;i<n;i++){let n=s.elements[i],l=n.renderElements?n.renderElements.length:0;if(n.owner._getBit(t.NodeFlags.HIDE_BY_EDITOR)&&(l=0),n.dcOptimize&&!e&&n.dcOptimizeEnd!==n&&(e=n,r!==a.length&&(this._elementGroups.add(r),this._elementGroups.add(a.length-1),this._elementGroups.add(!1),r=a.length)),l>0)for(let e=0;e<l;e++){let t=n.renderElements[e];t._index=e,a.add(t)}(null==e?void 0:e.dcOptimizeEnd)===n&&(e=null,r!==a.length&&(this._elementGroups.add(r),this._elementGroups.add(a.length-1),this._elementGroups.add(!0),r=a.length))}}),r!==a.length&&(this._elementGroups.add(r),this._elementGroups.add(a.length-1),this._elementGroups.add(!1))}batch(){let e=this._renderElements,t=e.elements,r=this._elementGroups,a=r.elements;e.length=0;for(let i=0,s=r.length;i<s;i+=3){let r=a[i],s=a[i+1],n=a[i+2],l=t[r].owner.renderType,_=r;for(let a=r+1;a<=s;a++){let r=t[a].owner;l!==r.renderType&&(a-_>1?this.getBatchProvider(l).batch(e,_,a-1,n):e.add(t[_]),_=a,l=r.renderType)}s-_>0?this.getBatchProvider(l).batch(e,_,s,n):e.add(t[_])}}getBatchProvider(e){return this._batchProviders[e]||(this._batchProviders[e]=r.createProvider(e))}_initRenderProcess(e){if(!this.root||this.root.globalAlpha<.01)return!1;let r,a,i=this.renderTexture;if(i){if(0==i.width||0==i.height)return!1;e.invertY=i._invertY,e.setRenderTarget(i._renderTarget,this.doClearColor,this._clearColor),r=i.width,a=i.height,this._updateInvertMatrix(),this.shaderData.addDefine(t.ShaderDefines2D.RENDERTEXTURE)}else{if(r=t.RenderState2D.width,a=t.RenderState2D.height,0===r||0===a)return!1;e.invertY=!1,e.setOffscreenView(r,a),e.setRenderTarget(null,this.doClearColor,this._clearColor),this._setInvertMatrix(1,0,0,1,0,0),this.shaderData.removeDefine(t.ShaderDefines2D.RENDERTEXTURE)}return e.passData=this.shaderData,r===this._rtsize.x&&a===this._rtsize.y||(this._rtsize.setValue(r,a),this.shaderData.setVector2(t.ShaderDefines2D.UNIFORM_SIZE,this._rtsize)),!0}static setBuffer(e){e._inPass||(e._inPass=!0,T.buffers.add(e))}static uploadBuffer(){if(T.buffers.length>0){let e=T.buffers.elements;for(let t=0,r=T.buffers.length;t<r;t++){let r=e[t];r._upload(),r._inPass=!1}T.buffers.length=0}}_updateInvertMatrix(){let e=this.root.trans;if(!e)return this._setInvertMatrix(1,0,0,1,0,0);let r=S,a=this.mask,i=this.offsetMatrix;if(a&&a.trans){a.renderMatrix.copyTo(r)}else e.matrix.copyTo(r);t.Matrix.mul(i,r,r),r.invert(),this._setInvertMatrix(r.a,r.b,r.c,r.d,r.tx,r.ty)}_setInvertMatrix(e=1,r=0,a=0,i=1,s=0,n=0){e===this._invertMat_0.x&&r===this._invertMat_1.x&&a===this._invertMat_0.y&&i===this._invertMat_1.y&&s===this._invertMat_0.z&&n===this._invertMat_1.z||(this._invertMat_0.setValue(e,a,s),this._invertMat_1.setValue(r,i,n),this.shaderData.setVector3(t.ShaderDefines2D.UNIFORM_INVERTMAT_0,this._invertMat_0),this.shaderData.setVector3(t.ShaderDefines2D.UNIFORM_INVERTMAT_1,this._invertMat_1))}destroy(){if(!this.destroyed){this.destroyed=!0,this._renderElements.length=0;for(let e=0,t=this._batchProviders.length;e<t;e++)this._batchProviders[e]&&this._batchProviders[e].destroy();this._batchProviders.length=0,this.root=null,this.renderTexture=null,this.postProcess=null,this.shaderData.destroy(),this.shaderData=null}}}T.buffers=new t.FastSinglelist;class R{constructor(){this._modify=!1,this._passes=[]}removePass(e){let t=this._passes.indexOf(e);-1!==t&&(this._passes.splice(t,1),this._modify=!0)}apply(e){this._modify&&(this._modify=!1,this._passes.sort((e,t)=>t._priority-e._priority));for(const t of this._passes)t.needRender()&&t.fowardRender(e)}clear(){this._passes.length=0}addPass(e){-1===this._passes.indexOf(e)&&(this._passes.push(e),this._modify=!0)}}const S=new t.Matrix;class x{}class D extends x{_getData(){return this._view}_modify(){this.owner._modifyOneView(this),T.setBuffer(this.owner)}_updateView(e){this._view&&this._view.buffer===e.buffer||(this._view=new Float32Array(e.buffer,4*this.start,this.length))}setData(e){this._view.set(e),this._modify()}constructor(e,t,r,a=1){super(),this.stride=1,this.owner=e,this.start=t,this.length=r,this.stride=a,this._updateView(e._dataView),e.addDataView(this)}}class b extends x{setGeometry(e){this._geometry=e}setData(e){this._view.set(e),this._modify()}constructor(e,t,r=!0){super(),this.owner=e,this.length=t,r&&(this._view=new Uint16Array(t))}_updateView(e){e.set(this._view,this.start)}_modify(){this.owner._modifyOneView(this),T.setBuffer(this.owner)}_clone(e=!0,t=!0){let r=e?this.owner:null,a=new A(r,this.length,t);return t||this._cloneView(a),a}_cloneView(e){e._view=this._view,e.length=this.length}destroy(){this._view=null,this._geometry=null,this.owner=null,this._next=null,this._prev=null}}class A extends b{destroy(){super.destroy()}}class B{get owner(){return this._owner}set owner(e){this._owner=e}constructor(){this._nMatrix_0=new t.Vector3,this._nMatrix_1=new t.Vector3,this._needUseMatrix=!0}get needUseMatrix(){return this._needUseMatrix}set needUseMatrix(e){this._needUseMatrix=e,e||(this._nMatrix_0.set(1,0,0),this._nMatrix_1.set(0,1,0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1))}destroy(){}inheriteRenderData(e){if(this._owner.spriteShaderData&&this._needUseMatrix){let e=this._owner.renderMatrix;this._nMatrix_0.setValue(e.a,e.c,e.tx),this._nMatrix_1.setValue(e.b,e.d,e.ty),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1)}}}class P{}class C{}class y extends B{constructor(){super(...arguments),this.logicMatrix=null,this.mask=null,this._bufferBlocks=null,this._needUpdateBuffer=!1,this._modifiedFrame=-1}applyVertexBufferBlock(e){this._bufferBlocks=e.slice(),this._needUpdateBuffer=e.length>0,this.updateCloneView()}_getBlocks(){return this._bufferBlocks}inheriteRenderData(e){if(!this._owner.spriteShaderData)return;let r=this._owner.trans;if(this._needUpdateBuffer||this._modifiedFrame<r.modifiedFrame){let e=r.matrix;if(this._bufferBlocks&&this._bufferBlocks.length){let t=0,r=0,a=0,i=null,s=e.a,n=e.b,l=e.c,_=e.d,h=e.tx,o=e.ty,d=null,u=this._bufferBlocks,m=0,f=null,c=null,p=this._bufferBlocks[0].vertexBuffer.vertexDeclaration.vertexStride/4;for(let e=0,g=this._bufferBlocks.length;e<g;e++){let g=u[e].vertexs;for(let e=0,u=g.length;e<u;e++){f=g[e].positions,c=g[e].vertexViews,m=f.length/2,i=null,t=0,a=0,r=0;for(let e=0;e<m;e++){(!i||i.length<=t)&&(i=c[r],i._modify(),r++,t=0,d=i._getData());let e=f[a],u=f[a+1];d[t]=e*s+u*l+h,d[t+1]=e*n+u*_+o,t+=p,a+=2}}}this._needUpdateBuffer=!1}else{if(this.logicMatrix){let r=t.Matrix.TEMP;t.Matrix.mul(this.logicMatrix,e.copyTo(r),r),this._nMatrix_0.setValue(r.a,r.c,r.tx),this._nMatrix_1.setValue(r.b,r.d,r.ty)}else this._nMatrix_0.setValue(e.a,e.c,e.tx),this._nMatrix_1.setValue(e.b,e.d,e.ty);this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1)}this._modifiedFrame=r.modifiedFrame}}getCloneViews(){if(!this._clonesViews){this._clonesViews=[];for(let e=0,t=this._bufferBlocks.length;e<t;e++)this._clonesViews[e]=this._cloneView(this._bufferBlocks[e].indexView)}return this._clonesViews}updateCloneView(){let e=this.getCloneViews(),t=this._bufferBlocks.length,r=e.length;if(r>t)for(let a=t;a<r;a++){let t=e[a];t._geometry.destroy(),t.owner&&t.owner.removeDataView(t)}this._clonesViews.length=t;for(let r=0;r<t;r++){let t=e[r],a=this._bufferBlocks[r];a&&(e[r]=this._cloneView(a.indexView,t))}}_cloneView(e,r=null){let a;return r&&r._geometry?(a=r,e._cloneView(a)):(a=e._clone(!1,!1),a._geometry=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),a._geometry.indexFormat=t.IndexFormat.UInt16),a}destroy(){if(super.destroy(),this._clonesViews){for(let e=0,t=this._clonesViews.length;e<t;e++)this._clonesViews[e]._geometry.destroy();this._clonesViews=null}this._bufferBlocks=null}}class M extends B{constructor(){super(...arguments),this._lightReceive=!1}get lightReceive(){return this._lightReceive}set lightReceive(e){this._lightReceive=e,e?this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_ENABLE):this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_ENABLE)}get owner(){return this._owner}set owner(e){e!=this.owner&&(this._owner&&this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D),this._owner=e,this._owner&&this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D))}}const L=new t.Color(1,1,1,1);class F extends M{constructor(){super(...arguments),this._baseColor=new t.Color(1,1,1,1),this._tilingOffset=new t.Vector4,this._renderAlpha=-1}get baseColor(){return this._baseColor}set baseColor(e){e!=this._baseColor&&this._baseColor.equal(e)||((e=e||t.Color.BLACK).cloneTo(this._baseColor),this._renderAlpha=-1,this._owner.spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,this._baseColor))}get baseTexture(){return this._baseTexture}set baseTexture(e){null!=this._baseTexture&&e==this._baseTexture||(this._baseTexture&&this._baseTexture._removeReference(),this._baseTexture=e,e=e||t.Texture2D.whiteTexture,this._owner.spriteShaderData.setTexture(t.BaseRenderNode2D.BASERENDER2DTEXTURE,e),e&&(e._addReference(),1!=e.gammaCorrection?this._owner.spriteShaderData.addDefine(t.ShaderDefines2D.GAMMATEXTURE):this._owner.spriteShaderData.removeDefine(t.ShaderDefines2D.GAMMATEXTURE)))}get tilingOffset(){return this._tilingOffset}set tilingOffset(e){e&&(this._owner.spriteShaderData.setVector(t.BaseRenderNode2D.TILINGOFFSET,e),e&&e.cloneTo(this._tilingOffset))}get normal2DTexture(){return this._normal2DTexture}set normal2DTexture(e){e!==this._normal2DTexture&&(this._normal2DTexture&&this._normal2DTexture._removeReference(1),e&&e._addReference(),this._normal2DTexture=e,this._owner.spriteShaderData.setTexture(t.BaseRenderNode2D.NORMAL2DTEXTURE,e),this._normal2DStrength>0&&this._normal2DTexture?this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM):this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM))}get normal2DStrength(){return this._normal2DStrength}set normal2DStrength(e){e=Math.max(0,Math.min(1,e)),this._normal2DStrength!==e&&(this._normal2DStrength=e,this._owner.spriteShaderData.setNumber(t.BaseRenderNode2D.NORMAL2DSTRENGTH,e),e>0&&this._normal2DTexture?this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM):this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM))}inheriteRenderData(e){if(super.inheriteRenderData(e),this._renderAlpha!=this._owner.globalAlpha){let e=this._owner.globalAlpha*this._baseColor.a;L.setValue(this._baseColor.r,this._baseColor.g,this._baseColor.b,e),this._owner.spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,L),this._renderAlpha=this._owner.globalAlpha}}}class G extends M{constructor(){super(...arguments),this._renderAlpha=-1,this._baseColor=new t.Color(1,1,1,1)}get baseColor(){return this._baseColor}set baseColor(e){e!=this._baseColor&&this._baseColor.equal(e)||((e=e||t.Color.BLACK).cloneTo(this._baseColor),this._renderAlpha=-1,this._owner.spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,this._baseColor))}get owner(){return this._owner}set owner(e){if(e!=this.owner){if(this._owner){let e=this._owner.spriteShaderData;e.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D),e.removeDefine(t.SpineShaderInit.SPINE_UV),e.removeDefine(t.SpineShaderInit.SPINE_COLOR)}if(this._owner=e,this._owner){let e=this._owner.spriteShaderData;e.addDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D),e.addDefine(t.SpineShaderInit.SPINE_UV),e.addDefine(t.SpineShaderInit.SPINE_COLOR)}}}get offset(){return this._offset}set offset(e){this._offset=e}inheriteRenderData(e){if(!this._owner||!this._owner.spriteShaderData||!this.skeleton)return;let r=this.owner.spriteShaderData,a=this.owner.renderMatrix;if(this._offset){let e=this._offset.x,t=this._offset.y;this._nMatrix_0.setValue(a.a,a.b,a.tx+a.a*e+a.c*t),this._nMatrix_1.setValue(a.c,a.d,a.ty+a.b*e+a.d*t)}else this._nMatrix_0.setValue(a.a,a.b,a.tx),this._nMatrix_1.setValue(a.c,a.d,a.ty);if(r.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),r.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1),this._renderAlpha!=this._owner.globalAlpha){let e=this._owner.globalAlpha*this._baseColor.a;L.setValue(this._baseColor.r,this._baseColor.g,this._baseColor.b,e),this._owner.spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,L),this._renderAlpha=this._owner.globalAlpha}}}const U={clipMatrix:new t.Matrix,clipMatDir:new t.Vector4(t.Const.MAX_CLIP_SIZE,0,0,t.Const.MAX_CLIP_SIZE),clipMatPos:new t.Vector4(0,0,0,0),_updateFrame:0};class I{}var N;!function(e){e[e.All=-1]="All",e[e.None=0]="None",e[e.Clip=1]="Clip",e[e.Blend=2]="Blend",e[e.Alpha=4]="Alpha",e[e.Pass=8]="Pass",e[e.Global=16]="Global",e[e.Culling=32]="Culling",e[e.DcOptimize=64]="DcOptimize"}(N||(N={}));const w={clipInfo:U,blendMode:t.BlendMode.invalid,globalRenderData:null,pass:null,enableCulling:!1,dcOptimize:!1,globalAlpha:1};class v{get enableCulling(){return this._enableCulling}set enableCulling(e){this._enableCulling=e,this.updateChildren(N.Culling)}get inheritedEnableCulling(){return this._enableCulling||this._parentData.enableCulling}get dcOptimize(){return this._dcOptimize}set dcOptimize(e){this._dcOptimize=e,this.updateChildren(N.DcOptimize)}get inheritedDcOptimize(){return this._dcOptimize||this._parentData.dcOptimize}get renderMatrix(){return this.trans.matrix}set renderMatrix(e){this.trans?(this.trans.matrix=e,this.trans.modifiedFrame=t.Stat.loopCount):this.trans={matrix:e,modifiedFrame:t.Stat.loopCount}}get globalAlpha(){return this._currentData.globalAlpha}set globalAlpha(e){this._parentData.globalAlpha=e}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this._updateGlobalAlpha(e,this.parent?this.parent.globalAlpha:1),this.updateChildren(N.Alpha)}get blendMode(){return this._blendMode||this._currentData.blendMode||t.BlendMode.normal}set blendMode(e){this._updateBlendMode(e),this._setBlendMode(),this.updateChildren(N.Blend)}get renderDataHandler(){return this._renderDataHandler}set renderDataHandler(e){this._renderDataHandler=e,e&&(this._renderDataHandler.owner=this)}get globalRenderData(){return this._globalRenderData||this._currentData.globalRenderData}set globalRenderData(e){this._globalRenderData=e,this._updateGlobalShaderData(),this.updateChildren(N.Global)}_updateGlobalShaderData(){let e=this.globalRenderData;this._globalShaderData=e?e.globalShaderData:null,this._subStruct&&this._subStruct._updateGlobalShaderData()}_updatePriority(){this._pass&&(this._maskParentPass?this._pass.priority=this._maskParentPass.priority+1:this._parentData.pass?this._pass.priority=this._parentData.pass.priority+1:this._pass.priority=0)}setMaskParentPass(e){this._maskParentPass=e,this._updatePriority(),this._pass&&this.updateChildren(N.Pass)}get pass(){return this._pass||this._currentData.pass}set pass(e){e!==this._pass&&(this._pass=e,this._updatePriority(),this.updateChildren(N.Pass))}get subStruct(){return this._subStruct}set subStruct(e){if(e!=this._subStruct){let r=0;if(e){let a=this._parentData;e._blendMode=this._blendMode,e._currentData=a,e._maskParentPass=this._maskParentPass,1!==a.globalAlpha&&(r|=N.Alpha),!this._globalRenderData&&a.globalRenderData&&(r|=N.Global),!this._clipInfo&&a.clipInfo&&(r|=N.Clip),this._blendMode===t.BlendMode.invalid&&a.blendMode===t.BlendMode.invalid||(r|=N.Blend),this._blendMode=t.BlendMode.invalid,this._currentData=w}else if(this._subStruct){let e=this._parentData;this._subStruct._currentData=this._subStruct._parentData,this._blendMode=this._subStruct._blendMode,1!==e.globalAlpha&&(r|=N.Alpha),!this._clipInfo&&e.clipInfo&&(r|=N.Clip),!this._globalRenderData&&e.globalRenderData&&(r|=N.Global),this._blendMode===t.BlendMode.invalid&&e.blendMode===t.BlendMode.invalid||(r|=N.Blend),this._subStruct._blendMode=t.BlendMode.invalid,this._subStruct._maskParentPass=null,this._currentData=e}this._subStruct=e,this._updateGlobalShaderData(),this.updateChildren(r),this._setBlendMode()}}constructor(){this._parentData=Object.assign({},w),this._currentData=this._parentData,this.zIndex=0,this._effectZ=0,this.stackingRoot=!1,this.rect=new t.Rectangle,this._enableCulling=!1,this.renderLayer=1,this.children=[],this.renderType=-1,this.renderUpdateMask=0,this._alpha=1,this._blendMode=t.BlendMode.invalid,this.needUploadClip=-1,this.needUploadAlpha=!0,this.enabled=!0,this.isRenderStruct=!1,this.renderElements=null,this.spriteShaderData=null,this._globalShaderData=null,this._globalRenderData=null,this._clipRect=null,this._clipInfo=null,this._rnUpdateFun=null}get _parentClipInfo(){return this._currentData.clipInfo}setRenderUpdateCallback(e){this._rnUpdateFun=e}_handleInterData(){let e=this._clipRect;if(e){let t=this._clipInfo,r=this.trans,a=this._currentData.clipInfo,i=a&&a!==U?a._updateFrame:-1;if(r&&(t._updateFrame<r.modifiedFrame||t._updateFrame<i)){let s=r.matrix,n=t.clipMatrix,{x:l,y:_,width:h,height:o}=e,d=s.tx,u=s.ty;if(n.tx=l*s.a+_*s.c+d,n.ty=l*s.b+_*s.d+u,n.a=h*s.a,n.b=h*s.b,n.c=o*s.c,n.d=o*s.d,-1!==i){let e=a.clipMatPos,t=e.z-e.x,r=e.w-e.y;if(n.a>0&&n.d>0){let e=a.clipMatrix,t=e.tx,r=e.ty,i=t+e.a,s=r+e.d,l=d+n.a,_=u+n.d;l<=t||_<=r||d>=i||u>=s?(n.a=-.1,n.d=-.1):(d<t&&(n.a-=t-d,d=n.tx=t),l>i&&(n.a-=l-i),u<r&&(n.d-=r-u,u=n.ty=r),_>s&&(n.d-=_-s),n.a<=0&&(n.a=-.1),n.d<=0&&(n.d=-.1))}d+=t,u+=r}t.clipMatDir.setValue(n.a,n.b,n.c,n.d),t.clipMatPos.setValue(n.tx,n.ty,d,u),t._updateFrame=Math.max(r.modifiedFrame,i)}}if(this._renderDataHandler){let e=this.spriteShaderData,r=this.getClipInfo();this.needUploadClip<r._updateFrame&&(e.setVector(t.ShaderDefines2D.UNIFORM_CLIPMATDIR,r.clipMatDir),e.setVector(t.ShaderDefines2D.UNIFORM_CLIPMATPOS,r.clipMatPos),this.needUploadClip=r._updateFrame),this.needUploadAlpha&&(e.setNumber(t.ShaderDefines2D.UNIFORM_VERTALPHA,this.globalAlpha),this.needUploadAlpha=!1)}}_setBlendMode(){this.spriteShaderData&&(t.BlendModeHandler.setShaderData(this.blendMode,this.spriteShaderData),this._subStruct&&this._subStruct._setBlendMode())}setClipRect(e){this._clipRect=e,e?this._initClipInfo():this._clipInfo=null,this.updateChildren(N.Clip)}_initClipInfo(){this._clipInfo?this._clipInfo._updateFrame=-1:this._clipInfo={clipMatDir:new t.Vector4,clipMatPos:new t.Vector4,clipMatrix:new t.Matrix,_updateFrame:-1}}_updateGlobalAlpha(e,t=1){this._parentData.globalAlpha=t*e}_updateBlendMode(e){this._subStruct&&this._subStruct.enabled?this._subStruct._blendMode=e:this._blendMode=e}getClipInfo(){return this._clipInfo||this._currentData.clipInfo||U}updateChildren(e){if(e==N.None)return;let r,a,i,s=0,n=null,l=!1,_=!1,h=null,o=!1,d=!1,u=!1,m=!1,f=!1,c=!1,p=!1;e&N.Clip&&(r=this.getClipInfo(),this.needUploadClip=-1,this._subStruct&&(this._subStruct.needUploadClip=-1),d=!0),e&N.Blend&&(a=this.blendMode,o=!0),e&N.Alpha&&(i=this.globalAlpha,this.needUploadAlpha=!0,this._subStruct&&(this._subStruct.needUploadAlpha=!0),u=!0),e&N.Pass&&(n=this.pass,s=n?n.priority+1:0,m=!0),e&N.Global&&(f=!0,this._globalShaderData,h=this.globalRenderData),e&N.Culling&&(c=!0,l=this.inheritedEnableCulling),e&N.DcOptimize&&(p=!0,_=this.inheritedDcOptimize);for(const g of this.children){let E=!1,T=g._parentData;d&&(T.clipInfo=r,g._clipInfo||(E=!0)),o&&g._blendMode===t.BlendMode.invalid&&(T.blendMode=a,g._setBlendMode(),E=!0),u&&(g._updateGlobalAlpha(g.alpha,i),E=!0),m&&(T.pass=n,g._pass&&g._pass!==n&&(g._pass.priority=s),E=!0),f&&(T.globalRenderData=h,g._updateGlobalShaderData(),g._globalRenderData||(E=!0)),c&&(T.enableCulling=l,g._pass&&(g._pass.repaint=!0),E=!0),p&&(T.dcOptimize=_,g._pass&&(g._pass.repaint=!0),E=!0),E&&g.updateChildren(e)}}setRepaint(){this.pass&&(this.pass.repaint=!0)}addChild(e,t){e.parent=this,this.children.splice(t,0,e);let r=e._parentData;r.clipInfo=this.getClipInfo(),r.blendMode=this.blendMode,e._setBlendMode(),e._updateGlobalAlpha(e.alpha,this.globalAlpha);let a=this.pass;r.pass=a,e._updatePriority(),r.globalRenderData=this.globalRenderData,e._updateGlobalShaderData(),r.enableCulling=this.inheritedEnableCulling,r.dcOptimize=this.inheritedDcOptimize,e.updateChildren(N.All)}updateChildIndex(e,t,r){t!==r&&(this.children.splice(t,1),r>=this.children.length?this.children.push(e):this.children.splice(r,0,e))}removeChild(e){const r=this.children.indexOf(e);if(-1!==r){e.parent=null,this.children.splice(r,1);let a=e._parentData;a.pass=null,e._updatePriority(),a.clipInfo=null,a.blendMode=t.BlendMode.invalid,e._updateGlobalAlpha(e._alpha),a.globalRenderData=null,e._updateGlobalShaderData(),a.enableCulling=!1,a.dcOptimize=!1,e.updateChildren(N.All)}}renderUpdate(e){this.renderDataHandler&&this.renderDataHandler.inheriteRenderData(e),this._rnUpdateFun&&this._rnUpdateFun(e)}destroy(){this._clipInfo=null,this._currentData=null,this._parentData=null,this._clipRect=null,this.renderElements=null,this.spriteShaderData=null,this.parent=null,this.children.length=0,this.children=null,this.pass=null}}class O{constructor(){this._changeFlags=new Set,this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1;a>=0;a--){var i=r[a]&t[a];0===i&&a===this._length-1?this._length--:r[a]=i}}add(e){let t=!1;var r=e._index,a=r+1,i=this._mask,s=this._length;if(s<a){for(i.length<a&&(i.length=a);s<r;s++)i[s]=0;i[r]=e._value,this._length=a,t=!0}else{let a=i[r];i[r]|=e._value,t=a!=i[r]}return t&&this._notifyChangeFlag(),t}remove(e){var t=e._index,r=this._mask,a=this._length-1;if(t>a)return!1;let i=r[t];var s=r[t]&~e._value;t==a&&0===s?this._length--:r[t]=s;let n=i!=s;return n&&this._notifyChangeFlag(),n}addDefineDatas(e){var t=e._mask,r=e._length,a=this._mask,i=this._length;if(i<r){a.length=r;for(var s=0;s<i;s++)a[s]|=t[s];for(;s<r;s++)a[s]=t[s];this._length=r}else for(s=0;s<r;s++)a[s]|=t[s];this._notifyChangeFlag()}removeDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1,i=Math.min(e._length,a);i>=0;i--){var s=r[i]&~t[i];i==a&&0===s?(a--,this._length--):r[i]=s}this._notifyChangeFlag()}has(e){var t=e._index;return!(t>=this._length)&&0!==(this._mask[t]&e._value)}_notifyChangeFlag(){if(this._changeFlags.size>0)for(var e=0,r=this._changeFlags.size;e<r;e++)this._changeFlags.forEach(e=>{e.setValue(t.Stat.loopCount,t.LayaGL.renderEngine._framePassCount)})}addChangeFlagInfo(e){this._changeFlags.has(e)||(e.setValue(t.Stat.loopCount,t.LayaGL.renderEngine._framePassCount),this._changeFlags.add(e))}removeChangeFlagInfo(e){this._changeFlags.has(e)&&(e.setValue(t.Stat.loopCount,t.LayaGL.renderEngine._framePassCount),this._changeFlags.delete(e))}clear(){this._length=0,this._notifyChangeFlag()}cloneTo(e){var t=e._mask,r=this._mask,a=this._length;t.length=a;for(var i=0;i<a;i++)t[i]=r[i];e._length=a,e._notifyChangeFlag()}clone(){var e=new O;return this.cloneTo(e),e}destroy(){delete this._mask}isEual(e){var t=this._length;if(t!=e._length)return!1;let r=this._mask,a=e._mask;for(var i=0;i<t;i++)if(r[i]!=a[i])return!1;return!0}}var V,W;e.WebGLExtension=void 0,(V=e.WebGLExtension||(e.WebGLExtension={}))[V.OES_vertex_array_object=0]="OES_vertex_array_object",V[V.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",V[V.OES_texture_half_float=2]="OES_texture_half_float",V[V.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",V[V.OES_texture_float=4]="OES_texture_float",V[V.OES_element_index_uint=5]="OES_element_index_uint",V[V.OES_texture_float_linear=6]="OES_texture_float_linear",V[V.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",V[V.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",V[V.WEBGL_depth_texture=9]="WEBGL_depth_texture",V[V.EXT_sRGB=10]="EXT_sRGB",V[V.EXT_color_buffer_float=11]="EXT_color_buffer_float",V[V.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",V[V.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",V[V.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",V[V.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",V[V.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",V[V.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",V[V.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",V[V.OES_standard_derivatives=19]="OES_standard_derivatives";class X{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class k extends X{get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}_changeTexMemory(e){t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_GPUMemory,-this._gpuMemory+e),t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_RenderTexture,-this._gpuMemory+e),t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_AllTexture,-this._gpuMemory+e)}constructor(e,r,a,i,s,n){super(e),this._gpuMemory=0,this.colorFormat=r,this.depthStencilFormat=a,this._isCube=i,this._generateMipmap=s,this._samples=n,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),n>1&&(this._msaaFramebuffer=this._gl.createFramebuffer()),t.LayaGL.statAgent.recordCountData(t.StatElement.C_RenderTexture,1)}dispose(){this._textures.forEach(e=>{e&&e.dispose()}),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._changeTexMemory(0),this._gpuMemory=0,t.LayaGL.statAgent.recordCountData(t.StatElement.C_RenderTexture,-1)}}class H extends X{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}_getSource(){return this.resource}get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}constructor(e,r,a,i,s,n,l,_,h){super(e),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=a,this.height=i,this.depth=s;const o=e=>!(e&e-1);switch(this.isPotSize=o(a)&&o(i),n==t.TextureDimension.Tex3D&&(this.isPotSize=this.isPotSize&&o(this.depth)),n){case t.TextureDimension.Tex2D:this._statistics_M_Texture=t.StatElement.M_Texture2D,this._statistics_RC_Texture=t.StatElement.C_Texture2D;break;case t.TextureDimension.Tex3D:this._statistics_M_Texture=t.StatElement.M_Texture3D,this._statistics_RC_Texture=t.StatElement.C_Texture3D;break;case t.TextureDimension.Cube:this._statistics_M_Texture=t.StatElement.M_TextureCube,this._statistics_RC_Texture=t.StatElement.C_TextureCube;break;case t.TextureDimension.Texture2DArray:this._statistics_M_Texture=t.StatElement.M_Texture2DArray,this._statistics_RC_Texture=t.StatElement.C_Texture2DArray}this._mipmap=l&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(a))+1,Math.ceil(Math.log2(i))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=_,this.gammaCorrection=h,this.target=r,this.filterMode=t.FilterMode.Bilinear,this.wrapU=t.WrapMode.Repeat,this.wrapV=t.WrapMode.Repeat,this.wrapW=t.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=t.TextureCompareMode.None,t.LayaGL.statAgent.recordCountData(this._statistics_RC_Texture,1),t.LayaGL.statAgent.recordCountData(t.StatElement.C_AllTexture,1)}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,a=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,a);let i=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,i),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(e){if(this._warpW!=e&&this.resource){if(this._engine.getCapable(t.RenderCapable.Texture3D)){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_R,r)}this._warpW=e}}get anisoLevel(){return this._anisoLevel}set anisoLevel(r){let a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(a){this._gl;let e=this._engine.getParams(t.RenderParams.Max_AnisoLevel_Count),i=Math.max(1,Math.min(e,r));this._setTexParametexf(a.TEXTURE_MAX_ANISOTROPY_EXT,i),this._anisoLevel=i}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameteri(a,e,t),this._engine._bindTexture(a,null)}_setTexParametexf(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameterf(a,e,t),this._engine._bindTexture(a,null)}getFilteMinrParam(e,r){let a=this._gl;switch(e){case t.FilterMode.Point:return r?a.NEAREST_MIPMAP_NEAREST:a.NEAREST;case t.FilterMode.Bilinear:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR;case t.FilterMode.Trilinear:return r?a.LINEAR_MIPMAP_LINEAR:a.LINEAR;default:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR}}getFilterMagParam(e){let r=this._gl;switch(e){case t.FilterMode.Point:return r.NEAREST;case t.FilterMode.Bilinear:case t.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(e){let r=this._gl;switch(e){case t.WrapMode.Repeat:return r.REPEAT;case t.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case t.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}_changeTexMemory(e){t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_GPUMemory,-this._gpuMemory+e),t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_AllTexture,-this._gpuMemory+e),t.LayaGL.statAgent.recordMemoryData(this._statistics_M_Texture,-this._gpuMemory+e)}dispose(){this._gl.deleteTexture(this.resource),this._changeTexMemory(0),this._gpuMemory=0,t.LayaGL.statAgent.recordCountData(this._statistics_RC_Texture,-1),t.LayaGL.statAgent.recordCountData(t.StatElement.C_AllTexture,-1)}}class Y extends X{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this.needBitmap=!1,this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}createTexture3DInternal(e,t,r,a,i,s,n,l){return null}setTexture3DImageData(e,t,r,a,i){return null}setTexture3DPixelsData(e,t,r,a,i){return null}setTexture3DSubPixelsData(e,t,r,a,i,s,n,l,_,h,o,d){return null}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.Alpha8:this._glParam.internalFormat=a.ALPHA,this._glParam.format=a.ALPHA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_STENCIL,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(e){let r=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case t.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:case t.RenderTargetFormat.R16G16B16:case t.RenderTargetFormat.R16G16B16A16:case t.RenderTargetFormat.R32G32B32:case t.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(e){let r=this._gl;switch(e){case t.TextureDimension.Tex2D:return r.TEXTURE_2D;case t.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(e){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(e){case t.TextureFormat.Alpha8:return r.channels=1,r.bytesPerPixel=1,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case t.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0,n=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,l=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case r.ALPHA:a=1;break;case n:case r.RGB:a=3;break;case l:case r.RGBA:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D&&(s*=1),s}getGLRTTexMemory(e,r,a,i,s,n,l){let _=e=>{let r=0;switch(e){case t.RenderTargetFormat.R8G8B8:r=3;break;case t.RenderTargetFormat.R8G8B8A8:r=4;break;case t.RenderTargetFormat.R16G16B16A16:r=8;break;case t.RenderTargetFormat.R32G32B32:r=12;break;case t.RenderTargetFormat.R32G32B32A32:r=16;break;case t.RenderTargetFormat.R16G16B16:r=6;break;case t.RenderTargetFormat.DEPTH_16:r=2;break;case t.RenderTargetFormat.STENCIL_8:r=1;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:r=4}return r},h=_(a);return n>1&&(h*=2),l&&(h*=6),s&&(h*=1.333),h*e*r+_(i)*e*r}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(e){switch(e){case t.RenderTargetFormat.DEPTH_16:case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:case t.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(e){switch(e){case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ETC2SRGB_Alpha1:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,a,i,s,n){let l=this.isSRGBFormat(a)||s&&this.supportSRGB(a,i);n&&(l=!1);let _=1;!l&&s&&(_=2.2);let h=this.getTarget(e),o=new H(this._engine,h,t,r,1,e,i,l,_),d=this.glTextureParam(a,l);return o.internalFormat=d.internalFormat,o.format=d.format,o.type=d.type,o}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,l=e.type;e.width,e.height;let _=e._gl;r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),_.texImage2D(i,0,s,n,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&_.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let l=e.format,_=e.type;t.width,t.height;let h=e._gl;i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,a,l,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,a=e.type,i=e.width,s=e.height,n=e._gl;this._engine._bindTexture(e.target,e.resource),n.texImage2D(t,0,e.internalFormat,i,s,0,r,a,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&n.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,l=e.type,_=e.width,h=e.height,o=_%4==0&&h%4==0,d=e._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),o||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texImage2D(i,0,s,_,h,0,n,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),o||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,a,i,s,n,l,_,h){a=a&&0==r;let o=e.target;e.internalFormat;let d=e.format,u=e.type,m=n%4==0&&l%4==0,f=e._gl;_&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),m||f.pixelStorei(f.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),f.texSubImage2D(o,r,i,s,n,l,d,u,t),e.mipmap&&a&&f.generateMipmap(e.target),this._engine._bindTexture(e.target,null),_&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!1),m||f.pixelStorei(f.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.width,l=e.height,_=t.source,h=t.dataOffset,o=t.bpp,d=t.blockBytes,u=t.mipmapCount,m=t.compressed;e.maxMipmapLevel=u-1;let f=n%4==0&&l%4==0,c=e._gl;f||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let p=this.getFormatPixelsParams(t.format),g=p.bytesPerPixel/p.channels,E=p.dataTypedCons,T=n,R=l,S=0;for(let e=0;e<u;e++){if(m){let t=Math.max(4,T)/4*Math.max(4,R)/4*d,i=new Uint8Array(_,h,t);c.compressedTexImage2D(r,e,a,T,R,0,i),S+=i.length,h+=o?T*R*(o/8):t}else{let t=T*R*p.channels,n=new E(_,h,t);S+=n.length,c.texImage2D(r,e,a,T,R,0,i,s,n),h+=t*g}T*=.5,R*=.5,T=Math.max(1,T),R=Math.max(1,R)}e.gpuMemory=S,this._engine._bindTexture(e.target,null),f||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,a=t.compress,i=e.target,s=e.internalFormat,n=e.format,l=e.type,_=e.mipmapCount,h=e.width,o=e.height;e.maxMipmapLevel=_-1;let d=h%4==0&&o%4==0,u=e._gl;d||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let m=h,f=o,c=t.headerOffset+t.bytesOfKeyValueData,p=0;for(let e=0;e<t.mipmapCount;e++){let _=new Int32Array(r,c,1)[0];if(c+=4,a){let t=new Uint8Array(r,c,_);u.compressedTexImage2D(i,e,s,m,f,0,t),p+=t.length}else{let a=this.getFormatPixelsParams(t.format),h=_/a.typedSize,o=new a.dataTypedCons(r,c,h);u.texImage2D(i,e,s,m,f,0,n,l,o),p+=o.byteLength}c+=_,c+=3-(_+3)%4,m=Math.max(1,.5*m),f=Math.max(1,.5*f)}for(let r=t.mipmapCount;r<e.mipmapCount;r++)a||u.texImage2D(i,r,s,m,f,0,n,l,null),m=Math.max(1,.5*m),f=Math.max(1,.5*f);e.gpuMemory=p,this._engine._bindTexture(e.target,null),d||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.internalFormat,l=e.format,_=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,l,_,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let n=e.internalFormat,l=e.format,_=e.type,h=e.width,o=e.height,d=h%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),d||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,h,o,0,l,_,t[e])}e.mipmap&&i.generateMipmap(e.target)}else{for(let e=0;e<s.length;e++){let t=s[e];i.texImage2D(t,0,n,h,o,0,l,_,null)}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),d||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,a,i,s,n,l,_,h){a=a&&0==r;let o=e._gl;const d=[o.TEXTURE_CUBE_MAP_POSITIVE_Z,o.TEXTURE_CUBE_MAP_NEGATIVE_Z,o.TEXTURE_CUBE_MAP_POSITIVE_X,o.TEXTURE_CUBE_MAP_NEGATIVE_X,o.TEXTURE_CUBE_MAP_POSITIVE_Y,o.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let u=e.format,m=e.type,f=n%4==0;_&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),f||o.pixelStorei(o.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<d.length;e++){let a=d[e];o.texSubImage2D(a,r,i,s,n,l,u,m,t[e])}e.mipmap&&a&&o.generateMipmap(e.target),this._engine._bindTexture(e.target,null),_&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1),f||o.pixelStorei(o.UNPACK_ALIGNMENT,4)}setCubeDDSData(e,t){let r=e.internalFormat,a=e.format,i=e.type,s=e.width,n=e.height,l=t.source,_=t.dataOffset,h=t.bpp,o=t.blockBytes,d=t.mipmapCount;e.maxMipmapLevel=d-1;let u=s%4==0&&n%4==0;u=!0;let m=e._gl;this._engine._bindTexture(e.target,e.resource);const f=[m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Y,m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_Z];let c=this.getFormatPixelsParams(t.format),p=c.bytesPerPixel/c.channels,g=c.dataTypedCons,E=0;if(t.compressed)for(let t=0;t<6;t++){let a=f[t],i=s,u=n;for(let t=0;t<d;t++){let s=Math.max(4,i)/4*Math.max(4,u)/4*o,n=new Uint8Array(l,_,s);(e.mipmap||0==t)&&m.compressedTexImage2D(a,t,r,i,u,0,n),E+=n.byteLength,_+=h?i*u*(h/8):s,i*=.5,u*=.5,i=Math.max(1,i),u=Math.max(1,u)}}else for(let e=0;e<6;e++){let t=f[e],h=s,o=n;for(let e=0;e<d;e++){let s=h*o*c.channels,n=new g(l,_,s);m.texImage2D(t,e,r,h,o,0,a,i,n),E+=n.byteLength,_+=s*p,h*=.5,o*=.5,h=Math.max(1,h),o=Math.max(1,o)}}e.gpuMemory=E,this._engine._bindTexture(e.target,null)}setCubeKTXData(e,t){let r=t.source,a=t.compress,i=e.internalFormat,s=e.format,n=e.type,l=t.mipmapCount,_=e.width,h=e.height;e.maxMipmapLevel=l-1;let o=_%4==0&&h%4==0,d=e._gl;const u=[d.TEXTURE_CUBE_MAP_POSITIVE_X,d.TEXTURE_CUBE_MAP_NEGATIVE_X,d.TEXTURE_CUBE_MAP_POSITIVE_Y,d.TEXTURE_CUBE_MAP_NEGATIVE_Y,d.TEXTURE_CUBE_MAP_POSITIVE_Z,d.TEXTURE_CUBE_MAP_NEGATIVE_Z];o||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let m=_,f=h,c=t.headerOffset+t.bytesOfKeyValueData,p=0;for(let e=0;e<t.mipmapCount;e++){let l=new Int32Array(r,c,1)[0];c+=4;for(let _=0;_<6;_++){let h=u[_];if(a){let t=new Uint8Array(r,c,l);d.compressedTexImage2D(h,e,i,m,f,0,t),p+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),_=l/a.typedSize,o=new a.dataTypedCons(r,c,_);d.texImage2D(h,e,i,m,f,0,s,n,o),p+=o.byteLength}c+=l,c+=3-(l+3)%4}m=Math.max(1,.5*m),f=Math.max(1,.5*f)}for(let r=t.mipmapCount;r<e.mipmapCount;r++){for(let e=0;e<6;e++){let t=u[e];a||d.texImage2D(t,r,i,m,f,0,s,n,null)}m=Math.max(1,.5*m),f=Math.max(1,.5*f)}this._engine._bindTexture(e.target,null),e.gpuMemory=p,o||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){return t.TextureCompareMode.None}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl,a=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,a),e._isCube){let a=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.resource,0)}this.currentActiveRT=e}bindoutScreenTarget(){this.currentActiveRT!=re._lastFrameBuffer&&this.unbindRenderTarget(this.currentActiveRT)}unbindRenderTarget(e){let t=e._gl;e&&e._generateMipmap&&e._textures.forEach(e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)}),t.bindFramebuffer(t.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ),this.currentActiveRT=re._lastFrameBuffer}createRenderTextureCubeInternal(e,r,a,i,s){let n=!1;i=i&&this.supportGenerateMipmap(a);let l=this.getTarget(e),_=new H(this._engine,l,r,r,1,e,i,n,1),h=this.glRenderTextureParam(a,n);_.internalFormat=h.internalFormat,_.format=h.format,_.type=h.type;let o=_.internalFormat,d=_.format,u=_.type,m=_._gl;const f=[m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_Z,m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(_.target,_.resource);for(let e=0;e<f.length;e++){let t=f[e];m.texImage2D(t,0,o,r,r,0,d,u,null)}return this._engine._bindTexture(_.target,null),a!=t.RenderTargetFormat.DEPTH_16&&a!=t.RenderTargetFormat.DEPTH_32&&a!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(_.filterMode=t.FilterMode.Point),_}createRenderTargetInternal(e,r,a,i,s,n,l,_){let h=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,s,n),o=new k(this._engine,a,i,!1,h.mipmap,1);o.gpuMemory=this.getGLRTTexMemory(e,r,a,i,s,1,!1),o.colorFormat=a,o.depthStencilFormat=i,o._textures.push(h);let d=o._framebuffer,u=o._gl;u.bindFramebuffer(u.FRAMEBUFFER,d);let m=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,m,u.TEXTURE_2D,h.resource,0);let f=this.glRenderBufferParam(i,!1);if(f){let t=this.createRenderbuffer(e,r,f.internalFormat,o._samples);o._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,f.attachment,u.RENDERBUFFER,t)}return u.bindFramebuffer(u.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ),o}createRenderTargetCubeInternal(e,r,a,i,s,n){let l=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,s),_=new k(this._engine,r,a,!0,l.mipmap,1);_.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,1,!0),_._textures.push(l);let h=_._framebuffer,o=_._gl;o.bindFramebuffer(o.FRAMEBUFFER,h);let d=this.glRenderBufferParam(a,!1);if(d){let t=this.createRenderbuffer(e,e,d.internalFormat,_._samples);_._depthbuffer=t,o.framebufferRenderbuffer(o.FRAMEBUFFER,d.attachment,o.RENDERBUFFER,t)}return o.bindFramebuffer(o.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ),_}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(e,r,a,i,s,n){let l=!1;s=s&&this.supportGenerateMipmap(i);let _=this.getTarget(e),h=new H(this._engine,_,r,a,1,e,s,l,1),o=this.glRenderTextureParam(i,l);h.internalFormat=o.internalFormat,h.format=o.format,h.type=o.type;let d=h.internalFormat,u=h.format,m=h.type,f=h._gl;return this._engine._bindTexture(h.target,h.resource),f.texImage2D(_,0,d,r,a,0,u,m,null),this._engine._bindTexture(h.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=t.FilterMode.Point),h}createRenderTargetDepthTexture(e,r,a,i){let s=e._gl;if(e.depthStencilFormat==t.RenderTargetFormat.None)return null;let n=e._depthbuffer;n&&s.deleteRenderbuffer(n),e._depthbuffer=null;let l=e.depthStencilFormat,_=e._generateMipmap,h=e.isSRGB;e._depthTexture&&s.deleteTexture(e._depthTexture);let o=this.createRenderTextureInternal(r,a,i,l,_,h);e._depthTexture=o;let d=this.glRenderTargetAttachment(e.depthStencilFormat),u=e._framebuffer;return s.bindFramebuffer(s.FRAMEBUFFER,u),s.framebufferTexture2D(s.FRAMEBUFFER,d,s.TEXTURE_2D,o.resource,0),s.bindFramebuffer(s.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ),o}readRenderTargetPixelData(e,r,a,i,s,n){let l=e._gl;if(this.bindRenderTarget(e),!(l.checkFramebufferStatus(l.FRAMEBUFFER)==l.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(e),null;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:l.readPixels(r,a,i,s,l.RGB,l.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R8G8B8A8:l.readPixels(r,a,i,s,l.RGBA,l.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R16G16B16:l.readPixels(r,a,i,s,l.RGB,l.FLOAT,n);break;case t.RenderTargetFormat.R16G16B16A16:l.readPixels(r,a,i,s,l.RGBA,l.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32:l.readPixels(r,a,i,s,l.RGB,l.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32A32:l.readPixels(r,a,i,s,l.RGBA,l.FLOAT,n)}return this.unbindRenderTarget(e),n}readRenderTargetPixelDataAsync(e,t,r,a,i,s){return Promise.resolve(this.readRenderTargetPixelData(e,t,r,a,i,s))}updateVideoTexture(e,t,r,a){let i=e._gl,s=e.target,n=e.internalFormat,l=e.format,_=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texImage2D(s,0,n,l,_,t),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.pixelStorei(i.UNPACK_ALIGNMENT,4)}}class K extends Y{constructor(e){super(e)}getTarget(e){let r=-1;switch(e){case t.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case t.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case t.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case t.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.Alpha8:this._glParam.internalFormat=a.R8,this._glParam.format=a.RED,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB565,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:a.DEPTH24_STENCIL8,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_COMPONENT32F,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};case t.RenderTargetFormat.R8G8B8:return{internalFormat:r?a.SRGB8:a.RGB8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?a.SRGB8_ALPHA8:a.RGBA8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16:return{internalFormat:a.RGB16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16A16:return{internalFormat:a.RGBA16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32:return{internalFormat:a.RGB32F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32A32:return{internalFormat:a.RGBA32F,attachment:a.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT16,this._glParam.format=a.DEPTH_COMPONENT,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT_24_8;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0;switch(e.internalFormat){case r.R8:case r.ALPHA:a=1;break;case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:a=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case r.HALF_FLOAT:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D?s*=1:e.target==r.TEXTURE_2D_ARRAY&&(s*=t),s}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB);case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,l=e.type,_=e.width,h=e.height,o=e.mipmapCount,d=this._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),d.texStorage2D(i,o,s,_,h),d.texSubImage2D(i,0,0,0,_,h,n,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let l=e.format,_=e.type;e.width,e.height,e.mipmapCount;let h=this._gl;i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,a,t.width,t.height,l,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,l=e.type,_=e.width,h=e.height,o=e.mipmapCount,d=_%4==0&&h%4==0,u=this._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),d||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u.texStorage2D(i,o,s,_,h),e.gpuMemory=this.getGLtexMemory(e),t&&(u.texSubImage2D(i,0,0,0,_,h,n,l,t),e.mipmap&&u.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),d||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}createTexture3DInternal(e,t,r,a,i,s,n,l){let _=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s);l&&(_=!1);let h=1;!_&&n&&(h=2.2);let o=this.getTarget(e),d=new H(this._engine,o,t,r,a,e,s,_,h),u=this.glTextureParam(i,_);return d.internalFormat=u.internalFormat,d.format=u.format,d.type=u.type,d}setTexture3DImageData(e,t,r,a,i){let s=e.target,n=e.internalFormat,l=e.format,_=e.type,h=e.width,o=e.height,d=e.mipmapCount,u=this._gl;a&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),u.texStorage3D(s,d,n,h,o,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)u.texSubImage3D(s,0,0,0,e,h,o,1,l,_,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixelsData(e,t,r,a,i){let s=e.target,n=e.internalFormat,l=e.format,_=e.type,h=e.width,o=e.height,d=e.mipmapCount,u=h%4==0&&o%4==0,m=this._gl;a&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0),u||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),m.texStorage3D(s,d,n,h,o,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(m.texSubImage3D(s,0,0,0,0,h,o,r,l,_,t),e.mipmap&&m.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),a&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!1),u||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,a,i,s,n,l,_,h,o,d){a=a&&0==r;let u=e.target;e.internalFormat;let m=e.format,f=e.type,c=l%4==0&&_%4==0,p=this._gl;o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),d&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),c||p.pixelStorei(p.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),p.texSubImage3D(u,r,i,s,n,l,_,h,m,f,t),e.mipmap&&a&&p.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),d&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!1),c||p.pixelStorei(p.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.mipmapCount,l=e.width,_=e.height;e.maxMipmapLevel=n-1;let h=t.source,o=t.compress,d=l%4==0&&_%4==0,u=this._gl;d||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),o||u.texStorage2D(r,t.mipmapCount,a,l,_);let m=l,f=_,c=t.headerOffset+t.bytesOfKeyValueData,p=0;for(let e=0;e<t.mipmapCount;e++){let n=new Int32Array(h,c,1)[0];if(c+=4,o){let t=new Uint8Array(h,c,n);u.compressedTexImage2D(r,e,a,m,f,0,t),p+=t.length}else{let a=this.getFormatPixelsParams(t.format),l=n/a.typedSize,_=new a.dataTypedCons(h,c,l);u.texSubImage2D(r,e,0,0,m,f,i,s,_),p+=_.length}c+=n,c+=3-(n+3)%4,m=Math.max(1,.5*m),f=Math.max(1,.5*f)}this._engine._bindTexture(e.target,null),e.gpuMemory=p,d||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,l=e.internalFormat,_=e.format,h=e.type,o=e.width,d=e.height,u=e.mipmapCount;r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,u,l,o,d),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,_,h,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,l=e.internalFormat,_=e.format,h=e.type,o=e.width,d=e.height,u=e.mipmapCount,m=o%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),m||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,u,l,o,d),t){for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,o,d,_,h,t[e])}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),m||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,l=e.type;e.mipmapCount;let _=e.width,h=e.height;e.maxMipmapLevel=t.mipmapCount-1;let o=t.source,d=t.compress,u=_,m=h,f=t.headerOffset+t.bytesOfKeyValueData,c=_%4==0&&h%4==0;c||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d||r.texStorage2D(i,t.mipmapCount,s,_,h);let p=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(o,f,1)[0];f+=4;for(let _=0;_<6;_++){let h=a[_];if(d){let t=new Uint8Array(o,f,i);r.compressedTexImage2D(h,e,s,u,m,0,t),p+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),s=i/a.typedSize,_=new a.dataTypedCons(o,f,s);r.texSubImage2D(h,e,0,0,u,m,n,l,_),p+=_.byteLength}f+=i,f+=3-(i+3)%4}u=Math.max(1,.5*u),m=Math.max(1,.5*m)}e.gpuMemory=p,this._engine._bindTexture(e.target,null),c||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,l=e.type,_=e.mipmapCount,h=e.width,o=e.height;e.maxMipmapLevel=_-1;let d=t.source,u=t.compress,m=h,f=o,c=t.headerOffset+t.bytesOfKeyValueData,p=h%4==0&&o%4==0;p||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||r.texStorage2D(i,t.mipmapCount,s,h,o);let g=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(d,c,1)[0];c+=4;for(let s=0;s<6;s++){let _=a[s],h=this.getFormatPixelsParams(t.format),o=i/h.typedSize,u=new h.dataTypedCons(d,c,o);r.texSubImage2D(_,e,0,0,m,f,n,l,u),g+=u.byteLength}c+=i,c+=3-(i+3)%4}m=Math.max(1,.5*m),f=Math.max(1,.5*f),e.gpuMemory=g,this._engine._bindTexture(e.target,null),p||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){let a=this._gl;switch(r){case t.TextureCompareMode.LEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.LESS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LESS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GREATER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GREATER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.EQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.EQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NOTEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NOTEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.ALWAYS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.ALWAYS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NEVER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NEVER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.None:default:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.NONE)}return r}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),a>1?i.renderbufferStorageMultisample(i.RENDERBUFFER,a,r,e,t):i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(e,r,a,i,s,n){s=s&&this.supportGenerateMipmap(i);let l=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s),_=this.getTarget(e),h=new H(this._engine,_,r,a,1,e,s,l,1),o=this.glRenderTextureParam(i,l);h.internalFormat=o.internalFormat,h.format=o.format,h.type=o.type;let d=h.internalFormat;h.format,h.type;let u=this._gl;return this._engine._bindTexture(h.target,h.resource),u.texStorage2D(_,h.mipmapCount,d,r,a),this._engine._bindTexture(h.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=t.FilterMode.Point),h}createRenderTargetInternal(e,r,a,i,s,n,l,_){let h=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,s,n),o=new k(this._engine,a,i,!1,h.mipmap,l);o.gpuMemory=this.getGLRTTexMemory(e,r,a,i,s,l,!1),o._textures.push(h);let d=o._gl;if(o._samples>1){let t=o._msaaFramebuffer,s=this.glRenderBufferParam(a,n),l=o._msaaRenderbuffer=this.createRenderbuffer(e,r,s.internalFormat,o._samples);d.bindFramebuffer(d.FRAMEBUFFER,t),d.framebufferRenderbuffer(d.FRAMEBUFFER,s.attachment,d.RENDERBUFFER,l);let _=this.glRenderBufferParam(i,!1);if(_){let t=this.createRenderbuffer(e,r,_.internalFormat,o._samples);o._depthbuffer=t,d.framebufferRenderbuffer(d.FRAMEBUFFER,_.attachment,d.RENDERBUFFER,t)}d.bindFramebuffer(d.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ);let u=o._framebuffer;d.bindFramebuffer(d.FRAMEBUFFER,u);let m=this.glRenderTargetAttachment(a);d.framebufferTexture2D(d.FRAMEBUFFER,m,d.TEXTURE_2D,h.resource,0),d.bindFramebuffer(d.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ)}else{let t=o._framebuffer;d.bindFramebuffer(d.FRAMEBUFFER,t);let s=this.glRenderTargetAttachment(a);d.framebufferTexture2D(d.FRAMEBUFFER,s,d.TEXTURE_2D,h.resource,0);let n=this.glRenderBufferParam(i,!1);if(n){let t=this.createRenderbuffer(e,r,n.internalFormat,o._samples);o._depthbuffer=t,d.framebufferRenderbuffer(d.FRAMEBUFFER,n.attachment,d.RENDERBUFFER,t)}d.bindFramebuffer(d.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ)}return o}createRenderTargetCubeInternal(e,r,a,i,s,n){let l=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,s),_=new k(this._engine,r,a,!0,l.mipmap,n);_.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,n,!0),_.colorFormat=r,_.depthStencilFormat=a,_._textures.push(l),_.isSRGB=s;let h=_._gl;if(_._samples>1){let t=_._msaaFramebuffer,i=this.glRenderBufferParam(r,!1),s=_._msaaRenderbuffer=this.createRenderbuffer(e,e,i.internalFormat,_._samples);h.bindFramebuffer(h.FRAMEBUFFER,t),h.framebufferRenderbuffer(h.FRAMEBUFFER,i.attachment,h.RENDERBUFFER,s);let n=this.glRenderBufferParam(a,!1);if(n){let t=this.createRenderbuffer(e,e,n.internalFormat,_._samples);_._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ)}else{let t=_._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,t);let r=this.glRenderBufferParam(a,!1);if(r){let t=this.createRenderbuffer(e,e,r.internalFormat,_._samples);_._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,r.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ)}return _}createRenderTextureCubeInternal(e,t,r,a,i){a=a&&this.supportGenerateMipmap(r);let s=this.isSRGBFormat(r)||i&&this.supportSRGB(r,a),n=this.getTarget(e),l=new H(this._engine,n,t,t,1,e,a,s,1),_=this.glRenderTextureParam(r,s);l.internalFormat=_.internalFormat,l.format=_.format,l.type=_.type;let h=l.internalFormat;l.format,l.type;let o=this._gl;return this._engine._bindTexture(l.target,l.resource),o.texStorage2D(n,l.mipmapCount,h,t,t),this._engine._bindTexture(l.target,null),l}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl;if(e._isCube){let a=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,a);let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}this.currentActiveRT=e}unbindRenderTarget(e){let t=this._gl;if(e&&e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],a=t.COLOR_BUFFER_BIT;e._depthTexture&&(a|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,a,t.NEAREST)}e&&e._generateMipmap&&e._textures.forEach(e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)}),t.bindFramebuffer(t.FRAMEBUFFER,re._lastFrameBuffer_WebGLOBJ),this.currentActiveRT=re._lastFrameBuffer}}class z extends X{constructor(e,r,a){switch(super(e),this._byteLength=0,this._glTargetType=r,this._glBufferUsageType=a,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer(),r){case t.BufferTargetType.ARRAY_BUFFER:this._statistics_M_Buffer=t.StatElement.M_VertexBuffer,this._statistics_RC_Buffer=t.StatElement.C_VertexBuffer;break;case t.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._statistics_M_Buffer=t.StatElement.M_IndexBuffer,this._statistics_RC_Buffer=t.StatElement.C_IndexBuffer;break;case t.BufferTargetType.UNIFORM_BUFFER:this._statistics_M_Buffer=t.StatElement.M_UBOBuffer,this._statistics_RC_Buffer=t.StatElement.C_UBOBuffer}t.LayaGL.statAgent.recordCountData(t.StatElement.C_GPUBuffer,1),t.LayaGL.statAgent.recordCountData(this._statistics_RC_Buffer,1)}_getGLUsage(e){switch(e){case t.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case t.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case t.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(e){switch(e){case t.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case t.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case t.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(e){t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_GPUBuffer,-this._byteLength+e),t.LayaGL.statAgent.recordMemoryData(t.StatElement.M_GPUMemory,-this._byteLength+e),t.LayaGL.statAgent.recordMemoryData(this._statistics_M_Buffer,-this._byteLength+e)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(e),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer()}setData(e,r){let a=this._gl;this.bindBuffer(),a.bufferSubData(this._glTarget,r,e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_BufferUploadCount,1),this.unbindBuffer()}setDataEx(e,r,a){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,r,e,0,a),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_BufferUploadCount,1),this.unbindBuffer()}bindBufferBase(e){const t=this._gl;let r=this._engine._uboBindingMap[e];r&&r.buffer!=this._glBuffer&&(this._engine._getbindBuffer(this._glTargetType)!=this&&this._engine._setbindBuffer(this._glTargetType,this),t.bindBufferBase(this._glTarget,e,this._glBuffer),r.buffer=this._glBuffer,r.offset=0,r.size=this._byteLength)}bindBufferRange(e,t,r){const a=this._gl;let i=this._engine._uboBindingMap[e];i&&(i.buffer==this._glBuffer&&i.offset==t&&i.size==r||(this._engine._getbindBuffer(this._glTargetType)!=this&&this._engine._setbindBuffer(this._glTargetType,this),a.bindBufferRange(this._glTarget,e,this._glBuffer,t,r),i.buffer=this._glBuffer,i.offset=t,i.size=r))}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();this._gl.deleteBuffer(this._glBuffer),this._memorychange(0),t.LayaGL.statAgent.recordCountData(t.StatElement.C_GPUBuffer,-1),t.LayaGL.statAgent.recordCountData(this._statistics_RC_Buffer,-1),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}e.WebGLMode=void 0,(W=e.WebGLMode||(e.WebGLMode={}))[W.Auto=0]="Auto",W[W.WebGL2=1]="WebGL2",W[W.WebGL1=2]="WebGL1";class j{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const r=this._gl;this._glParamsData=new Map,this._glParamsData.set(t.RenderParams.Max_Active_Texture_Count,r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const a=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),i=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(t.RenderParams.Max_Uniform_Count,Math.min(a,i)),this._glParamsData.set(t.RenderParams.MAX_Texture_Size,r.getParameter(r.MAX_TEXTURE_SIZE)),this._glParamsData.set(t.RenderParams.MAX_Texture_Image_Uint,r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(t.RenderCapable.Texture_anisotropic)){const a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(t.RenderParams.Max_AnisoLevel_Count,r.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(t.RenderParams.FLOAT,r.FLOAT),this._glParamsData.set(t.RenderParams.UNSIGNED_BYTE,r.UNSIGNED_BYTE),this._glParamsData.set(t.RenderParams.UNSIGNED_SHORT,r.UNSIGNED_SHORT),this._glParamsData.set(t.RenderParams.BYTE,r.BYTE)}getParams(e){return this._glParamsData.get(e)}}class q extends X{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(e){switch(e){case t.MeshTopology.Points:return this._gl.POINTS;case t.MeshTopology.Lines:return this._gl.LINES;case t.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case t.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case t.MeshTopology.Triangles:return this._gl.TRIANGLES;case t.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case t.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(e){switch(e){case t.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case t.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case t.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(e,r,a,i,s){this._engine.isWebGL2?this._gl.drawElementsInstanced(e,r,a,i,s):this._angleInstancedArrays.drawElementsInstancedANGLE(e,r,a,i,s),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_Triangle,r/3*s)}drawArraysInstanced(e,r,a,i){this._engine.isWebGL2?this._gl.drawArraysInstanced(e,r,a,i):this._angleInstancedArrays.drawArraysInstancedANGLE(e,r,a,i),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_Triangle,(a-2)*i)}drawArrays(e,r,a){this._gl.drawArrays(e,r,a),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_Triangle,a-2)}drawElements(e,r,a,i){this._gl.drawElements(e,r,a,i),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_Triangle,r/3)}drawGeometryElement(e){e.bufferState.bind();let r=e.drawParams.elements,a=e.drawParams.length;switch(e.drawType){case t.DrawType.DrawArray:for(let t=0;t<a;t+=2)this.drawArrays(e._glmode,r[t],r[t+1]);break;case t.DrawType.DrawElement:for(let t=0;t<a;t+=2)this.drawElements(e._glmode,r[t+1],e._glindexFormat,r[t]);break;case t.DrawType.DrawArrayInstance:for(let t=0;t<a;t+=2)this.drawArraysInstanced(e._glmode,r[t],r[t+1],e.instanceCount);t.LayaGL.statAgent.recordCTData(t.StatElement.CT_Instancing_DrawCall,a/2);break;case t.DrawType.DrawElementInstance:for(let t=0;t<a;t+=2)this.drawElementsInstanced(e._glmode,r[t+1],e._glindexFormat,r[t],e.instanceCount);t.LayaGL.statAgent.recordCTData(t.StatElement.CT_Instancing_DrawCall,a/2)}t.LayaGL.statAgent.recordCTData(t.StatElement.CT_DrawCall,a/2)}}class Z{constructor(e){this._engine=e,this._gl=this._engine.gl}_initState(){this.setDepthFunc(t.CompareFunction.Less),this.setBlendEquationSeparate(t.BlendEquationSeparate.ADD,t.BlendEquationSeparate.ADD),this._blendEquation=t.BlendEquationSeparate.ADD,this._sFactor=t.BlendFactor.One,this._dFactor=t.BlendFactor.Zero,this._sFactorAlpha=t.BlendFactor.One,this._dFactorAlpha=t.BlendFactor.One}_getBlendFactor(e){const r=this._gl;switch(e){case t.BlendFactor.Zero:return r.ZERO;case t.BlendFactor.One:return r.ONE;case t.BlendFactor.SourceColor:return r.SRC_COLOR;case t.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case t.BlendFactor.DestinationColor:return r.DST_COLOR;case t.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case t.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case t.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case t.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case t.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case t.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case t.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case t.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(e){const r=this._gl;switch(e){case t.BlendEquationSeparate.ADD:return r.FUNC_ADD;case t.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case t.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(e){const r=this._gl;switch(e){case t.CompareFunction.Never:return r.NEVER;case t.CompareFunction.Less:return r.LESS;case t.CompareFunction.Equal:return r.EQUAL;case t.CompareFunction.LessEqual:return r.LEQUAL;case t.CompareFunction.Greater:return r.GREATER;case t.CompareFunction.NotEqual:return r.NOTEQUAL;case t.CompareFunction.GreaterEqual:return r.GEQUAL;case t.CompareFunction.Always:return r.ALWAYS;default:return r.LEQUAL}}_getGLStencilOperation(e){const r=this._gl;switch(e){case t.StencilOperation.Keep:return r.KEEP;case t.StencilOperation.Zero:return r.ZERO;case t.StencilOperation.Replace:return r.REPLACE;case t.StencilOperation.IncrementSaturate:return r.INCR;case t.StencilOperation.DecrementSaturate:return r.DECR;case t.StencilOperation.Invert:return r.INVERT;case t.StencilOperation.IncrementWrap:return r.INCR_WRAP;case t.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(e){return e==t.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(this._getGLCompareFunction(e)))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilWrite(e){this._stencilWrite=e}setStencilWriteMask(e){(e=this._stencilWrite?e:0)!==this._stencilWriteMask&&(this._stencilWriteMask=e,this._gl.stencilMask(e))}setStencilFunc(e,t,r){e==this._stencilFunc&&t==this._stencilRef&&r==this._stencilReadMask||(this._stencilFunc=e,this._stencilRef=t,this._stencilReadMask=r,this._gl.stencilFunc(this._getGLCompareFunction(e),t,r))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(this._getGLStencilOperation(e),this._getGLStencilOperation(t),this._getGLStencilOperation(r)))}setDepthBias(e){e!==this._depthBias&&(this._depthBias=e,e?this._gl.enable(this._gl.POLYGON_OFFSET_FILL):this._gl.disable(this._gl.POLYGON_OFFSET_FILL))}setDepthBiasFactor(e,t,r=0){e===this._depthBiasConstant&&t===this._depthBiasSlope&&r===this._depthBiasClamp||(this._depthBiasConstant=e,this._depthBiasSlope=t,this._depthBiasClamp=r,this._gl.polygonOffset(e,t))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(this._getBlendOperation(e)))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(this._getBlendOperation(e),this._getBlendOperation(t)))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(this._getBlendFactor(e),this._getBlendFactor(t)))}setBlendFuncSeperate(e,t,r,a){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&a===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=a,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(this._getBlendFactor(e),this._getBlendFactor(t),this._getBlendFactor(r),this._getBlendFactor(a)))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(this._getGLFrontfaceFactor(e)))}}class Q extends X{constructor(e,t,r,a){super(e),this._vs=t,this._ps=r,this._attributeMap=a,this._uniformMap=[],this._create()}_create(){re._lastShaderError=null,performance.now();const e=this._gl;if(re.instance.lost)return;let r,a=this._program=e.createProgram();if(this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),e.getShaderParameter(this._vshader,e.COMPILE_STATUS)||(r=e.getShaderInfoLog(this._vshader)),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.getShaderParameter(this._pshader,e.COMPILE_STATUS)||(r&&(r+="\n"),r+=e.getShaderInfoLog(this._pshader)),e.attachShader(a,this._vshader),e.attachShader(a,this._pshader),r)return void(re._lastShaderError=r);for(var i in this._attributeMap)e.bindAttribLocation(a,this._attributeMap[i][0],i);if(e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))return void(re._lastShaderError=e.getProgramInfoLog(a));const s=e.getProgramParameter(a,e.ACTIVE_UNIFORMS);let n,l;for(this.useProgram(),this._curActTexIndex=0,l=0;l<s;l++){var _=e.getActiveUniform(a,l),h=_.name;let r=e.getUniformLocation(a,h);(r||0==r)&&(n=new t.ShaderVariable,n.location=r,h.indexOf("[0]")>0?(n.name=h=h.substr(0,h.length-3),n.isArray=!0):(n.name=h,n.isArray=!1),n.type=_.type,this._addShaderUnifiormFun(n),this._uniformMap.push(n),n.dataOffset=this._engine.propertyNameToID(h))}if(this._engine.isWebGL2){const r=e;this._uniformObjectMap={};var o=e.getProgramParameter(a,e.ACTIVE_UNIFORM_BLOCKS);for(l=0;l<o;l++){var d=r.getActiveUniformBlockName(this._program,l);n=new t.ShaderVariable,n.name=d,n.isArray=!1,n.type=e.UNIFORM_BUFFER,n.dataOffset=this._engine.propertyNameToID(d);let i=n.location=r.getUniformBlockIndex(a,d),s=l;r.uniformBlockBinding(this._program,i,s),this._uniformObjectMap[n.name]=n,this._uniformMap.push(n),this._addShaderUnifiormFun(n)}}this._complete=!0}_createShader(e,t,r){let a=e.createShader(r);return e.shaderSource(a,t),e.compileShader(a),a}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=r?this._uniformMatrix3fv:this._uniformMatrix3f;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:re._lastShaderError=`unknown uniform type (${e.type})`}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,t.LayaGL.statAgent.recordCTData(t.StatElement.CT_ShaderChange,1),!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3f(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t.elements),1}_uniformMatrix3fv(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D,a),0}_uniform_sampler2DArray(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D_ARRAY,a),0}_uniform_sampler3D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_3D,a),0}_uniform_samplerCube(e,r){var a=r?r._getSource():t.TextureCube.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_CUBE_MAP,a),0}_uniform_UniformBuffer(e,t){return t.bind(e.location),1}_bindTexture(e,t,r){const a=this._gl;this._engine._activedTextureID!==e&&(a.activeTexture(e),this._engine._activedTextureID=e);const i=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[i]!==r&&(a.bindTexture(t,r),this._engine._activeTextures[i]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class J extends X{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach(e=>{var r=e._shaderValues;for(var a in this._vertexDeclaration[t++]=e._shaderValues,e.bind(),r){var i=parseInt(a),s=r[a];this._gl.enableVertexAttribArray(i),this._gl.vertexAttribPointer(i,s.elementCount,s.elementType,!!s.normalized,s.vertexStride,s.elementOffset),e.instanceBuffer&&this.vertexAttribDivisor(i,1)}})}clearVAO(){for(let a=0,i=this._vertexDeclaration.length;a<i;a++){var e=this._vertexDeclaration[a];for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._glBuffer.bindBuffer(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}!function(){var e={};function t(t,r){var a;e[t]=!0,void 0!==r&&(a=r,window.console&&window.console.error&&window.console.error(a))}var r=function e(t){var r=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var a=0;a<this.attribs.length;a++){var i=new e.VertexAttrib(r);this.attribs[a]=i}this.maxAttrib=0};(r.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var a;do{(a=r.apply(t))!=t.NO_ERROR&&(e[a]=!0)}while(a!=t.NO_ERROR);for(var i in e)if(e[i])return delete e[i],parseInt(i);return t.NO_ERROR}}(t);var a=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:a.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!0,a.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!1,a.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,i){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=i;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=i}return a.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,i){var s=r.currentVertexArrayObject.attribs[e];switch(i){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return s.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return s.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return s.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return s.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return s.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return s.normalized;default:return a.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,i,s,n,l){var _=r.currentVertexArrayObject;_.maxAttrib=Math.max(_.maxAttrib,e);var h=_.attribs[e];return h.buffer=r.currentArrayBuffer,h.size=t,h.type=i,h.normalized=s,h.stride=n,h.offset=l,h.recache(),a.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()},!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var t=this.gl;this.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new r(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var e=new r(this);return this.vertexArrayObjects.push(e),e},a.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof r&&e.hasBeenBound&&e.ext==this)},a.prototype.bindVertexArrayOES=function(e){var r=this.gl;if(!e||e.isAlive){var a=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var s=this.currentVertexArrayObject;if(i!=s){i&&s.elementArrayBuffer==i.elementArrayBuffer||a.bindBuffer.call(r,r.ELEMENT_ARRAY_BUFFER,s.elementArrayBuffer);for(var n=this.currentArrayBuffer,l=Math.max(i?i.maxAttrib:0,s.maxAttrib),_=0;_<=l;_++){var h=s.attribs[_],o=i?i.attribs[_]:null;if(i&&h.enabled==o.enabled||(h.enabled?a.enableVertexAttribArray.call(r,_):a.disableVertexAttribArray.call(r,_)),h.enabled){var d=!1;i&&h.buffer==o.buffer||(n!=h.buffer&&(a.bindBuffer.call(r,r.ARRAY_BUFFER,h.buffer),n=h.buffer),d=!0),(d||h.cached!=o.cached)&&a.vertexAttribPointer.call(r,_,h.size,h.type,h.normalized,h.stride,h.offset)}}this.currentArrayBuffer!=n&&a.bindBuffer.call(r,r.ARRAY_BUFFER,this.currentArrayBuffer)}}else t(r.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new a(this)),this.__OESVertexArrayObject))}}}();const $=["","WEBKIT_","MOZ_"];class ee{constructor(e){this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(r){this._capabilityMap=new Map;let a=r||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(t.RenderCapable.Element_Index_Uint32,a),this._capabilityMap.set(t.RenderCapable.Element_Index_Uint8,!0),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R16G16B16A16,a),a=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(t.RenderCapable.Texture_anisotropic,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)||!!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float):!(!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float)||!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear)),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R16G16B16A16,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear):!!this.getExtension(e.WebGLExtension.OES_texture_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_Depth,a),a=r,this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_ShadowMap,a),a=r||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(t.RenderCapable.Vertex_VAO,a),a=r||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(t.RenderCapable.DrawElement_Instance,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(t.RenderCapable.Shader_TextureLod,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_PVRTC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC1,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ASTC,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,a),a=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_FloatLinearFiltering,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_HalfFloatLinearFiltering,a),a=r,this._capabilityMap.set(t.RenderCapable.MSAA,a),this._capabilityMap.set(t.RenderCapable.UnifromBufferObject,a),this._capabilityMap.set(t.RenderCapable.Texture3D,a),this._capabilityMap.set(t.RenderCapable.ComputeShader,!1),this._capabilityMap.set(t.RenderCapable.StorageBuffer,!1)}initExtension(t){this._extensionMap=new Map;const r=e=>{for(const t in $){let r=this._gl.getExtension($[t]+e);if(r)return r}return null},a=(e,t,r)=>{t&&r.set(e,t)},i=r("EXT_texture_filter_anisotropic");a(e.WebGLExtension.EXT_texture_filter_anisotropic,i,this._extensionMap);const s=r("WEBGL_compressed_texture_s3tc");a(e.WebGLExtension.WEBGL_compressed_texture_s3tc,s,this._extensionMap);const n=r("WEBGL_compressed_texture_s3tc_srgb");a(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,n,this._extensionMap);const l=r("WEBGL_compressed_texture_pvrtc");a(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,l,this._extensionMap);const _=r("WEBGL_compressed_texture_etc1");a(e.WebGLExtension.WEBGL_compressed_texture_etc1,_,this._extensionMap);const h=r("WEBGL_compressed_texture_etc");a(e.WebGLExtension.WEBGL_compressed_texture_etc,h,this._extensionMap);const o=r("WEBGL_compressed_texture_astc");a(e.WebGLExtension.WEBGL_compressed_texture_astc,o,this._extensionMap);const d=r("OES_texture_float_linear");a(e.WebGLExtension.OES_texture_float_linear,d,this._extensionMap);const u=r("EXT_color_buffer_half_float");if(a(e.WebGLExtension.EXT_color_buffer_half_float,u,this._extensionMap),t){const t=r("EXT_color_buffer_float");a(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=r("OES_vertex_array_object");a(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const i=r("ANGLE_instanced_arrays");a(e.WebGLExtension.ANGLE_instanced_arrays,i,this._extensionMap);const s=r("OES_texture_half_float");a(e.WebGLExtension.OES_texture_half_float,s,this._extensionMap);const n=r("OES_texture_half_float_linear");a(e.WebGLExtension.OES_texture_half_float_linear,n,this._extensionMap);const l=r("OES_texture_float");a(e.WebGLExtension.OES_texture_float,l,this._extensionMap);const _=r("OES_element_index_uint");a(e.WebGLExtension.OES_element_index_uint,_,this._extensionMap);const h=r("EXT_shader_texture_lod");a(e.WebGLExtension.EXT_shader_texture_lod,h,this._extensionMap);const o=r("WEBGL_depth_texture");a(e.WebGLExtension.WEBGL_depth_texture,o,this._extensionMap);const d=r("EXT_sRGB");a(e.WebGLExtension.EXT_sRGB,d,this._extensionMap);const u=r("OES_standard_derivatives");a(e.WebGLExtension.OES_standard_derivatives,u,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.get(e)||null}turnOffSRGB(){this._extensionMap.set(e.WebGLExtension.EXT_sRGB,null),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,!1)}}class te extends t.UniformBufferManager{constructor(e,t){super(!0),this.engine=e,this.byteAlign=t,e.on("endFrame",this,this.endFrame),e.on("startFrame",this,this.startFrame)}createGPUBuffer(e,r,a){let i=this.engine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,t.BufferUsage.Dynamic);return i.bindBuffer(),i.setDataLength(e),a&&i.setData(a,0),i}writeBuffer(e,r,a,i){e.bindBuffer(),this.engine.gl.bufferSubData(e._glTarget,a,new Float32Array(r,a,i/4)),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_UBOBufferUploadCount,1),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_UBOBufferUploadMemory,i/1048576)}}class re extends t.EventDispatcher{get lost(){return this._lost}constructor(r,a=e.WebGLMode.Auto){super(),this._framePassCount=0,this._lost=!1,this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._lastClearColor=new t.Color,this._lastClearDepth=-1,this._remapZ=!0,this._screenInvertY=!1,this._lodTextureSample=!0,this._breakTextureSample=!0,this._config=r,this._isWebGL2=!1,this._lastViewport=new t.Vector4(0,0,0,0),this._lastClearColor=new t.Color(0,0,0,0),this._lastScissor=new t.Vector4(0,0,0,0),this._webglMode=a,re.instance=this}startFrame(){this._framePassCount=0,this.event("startFrame",null)}endFrame(){this.event("endFrame",null)}getInnerWidth(){return this._globalWidth}getInnerHeight(){return this._globalHeight}resizeOffScreen(e,t){this._globalWidth=e,this._globalHeight=t}addTexGammaDefine(e,t){re._texGammaDefine[e]=t}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}initRenderEngine(r){let a,i;switch(this._webglMode){case e.WebGLMode.Auto:a=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:a=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:a=["webgl2","experimental-webgl2"]}for(let e=0;e<a.length;e++){try{i=r.getContext(a[e],this._config)}catch(e){}if(i){"webgl2"!==a[e]&&"experimental-webgl2"!==a[e]||(this._isWebGL2=!0);break}}this._context=i,this.scissorTest(!0),this._initBindBufferMap(),this._supportCapatable=new ee(this),this._GLParams=new j(this),this._GLRenderState=new Z(this),this._glTextureIDParams=[i.TEXTURE0,i.TEXTURE1,i.TEXTURE2,i.TEXTURE3,i.TEXTURE4,i.TEXTURE5,i.TEXTURE6,i.TEXTURE7,i.TEXTURE8,i.TEXTURE9,i.TEXTURE10,i.TEXTURE11,i.TEXTURE12,i.TEXTURE13,i.TEXTURE14,i.TEXTURE15,i.TEXTURE16,i.TEXTURE17,i.TEXTURE18,i.TEXTURE19,i.TEXTURE20,i.TEXTURE21,i.TEXTURE22,i.TEXTURE23,i.TEXTURE24,i.TEXTURE25,i.TEXTURE26,i.TEXTURE27,i.TEXTURE28,i.TEXTURE29,i.TEXTURE30,i.TEXTURE31],this._activedTextureID=i.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new K(this):new Y(this),this._GLRenderDrawContext=new q(this),r.addEventListener("webglcontextlost",this.webglContextLost),t.Config._uniformBlock=t.Config.enableUniformBufferObject&&this.getCapable(t.RenderCapable.UnifromBufferObject),t.Config.matUseUBO=t.Config.matUseUBO&&this.getCapable(t.RenderCapable.UnifromBufferObject),this._initBufferBlock()}_initBufferBlock(){if(t.Config._uniformBlock||t.Config.matUseUBO){const e=this._context;let t=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);this.bufferMgr=new te(this,t);let r=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);this._uboBindingMap=new Array(r);for(let e=0;e<r;e++)this._uboBindingMap[e]={buffer:null,offset:0,size:0}}}webglContextLost(e){console.log("lost webgl context"),t.Laya.stage.event("GraphicContextLost",e),this._lost=!0}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[t.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,r,a,i){const s=this._context,n=this._lastViewport;t.LayaEnv.isConch?s.viewport(e,r,a,i):e===n.x&&r===n.y&&a===n.z&&i===n.w||(s.viewport(e,r,a,i),n.setValue(e,r,a,i))}scissor(e,r,a,i){const s=this._context,n=this._lastScissor;t.LayaEnv.isConch?s.scissor(e,r,a,i):e===n.x&&r===n.y&&a===n.z&&i===n.w||(s.scissor(e,r,a,i),n.setValue(e,r,a,i))}scissorTest(e){this._scissorState!=e&&(this._scissorState=e,e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST))}clearRenderTexture(e,r=null,a=1,i=0){var s;e&t.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),s|=this.gl.COLOR_BUFFER_BIT),e&t.RenderClearFlag.Depth&&(this._lastClearDepth!=a&&(this._context.clearDepth(a),this._lastClearDepth=a),this._GLRenderState.setDepthMask(!0),s|=this._context.DEPTH_BUFFER_BIT),e&t.RenderClearFlag.Stencil&&(this._context.clearStencil(i),this._GLRenderState.setStencilWrite(!0),s|=this._context.STENCIL_BUFFER_BIT),s&&this._context.clear(s)}copySubFrameBuffertoTex(e,t,r,a,i,s,n,l){this._bindTexture(e.target,e.resource),this._context.copyTexSubImage2D(e.target,t,r,a,i,s,n,l)}colorMask(e,t,r,a){this._context.colorMask(e,t,r,a)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new z(this,e,t)}createShaderInstance(e,t,r){return new Q(this,e,t,r)}createVertexState(){return new J(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}getNamesByDefineData(e,t){var r=re._maskMap,a=e._mask;t.length=0;for(var i=0,s=e._length;i<s;i++)for(var n=r[i],l=a[i],_=0;_<32;_++){var h=1<<_;if(l>0&&h>l)break;l&h&&t.push(n[h])}}getDefineByName(e){var r=re._defineMap[e];if(!r){var a=re._maskMap,i=re._defineCounter,s=Math.floor(i/32),n=1<<i%32;r=new t.ShaderDefine(s,n),re._defineMap[e]=r,s==a.length&&(a.length++,a[s]={}),a[s][n]=e,re._defineCounter++}return r}uploadUniforms(e,t,r,a){for(var i=r._data,s=t.getArrayData(),n=0,l=0,_=s.length;l<_;l++){var h=s[l];if(a||-1!==h.textureID){var o=i[h.dataOffset];null!=o&&(n+=h.fun.call(h.caller,h,o))}}return n}uploadOneUniforms(e,t,r){e.bind(),t&&null!=r&&t.fun.call(t.caller,t,r)}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}re._texGammaDefine={},re._lastFrameBuffer=null,re._lastFrameBuffer_WebGLOBJ=null,re._defineMap={},re._defineCounter=0,re._maskMap=[];class ae{setInt(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setFloat(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setVector2(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,this.needUpload=!0)}setVector3(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,this.needUpload=!0)}setVector4(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,r.view[3]=t.w,this.needUpload=!0)}setMatrix3x3(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=t.elements;for(let t=0;t<3;t++)for(let a=0;a<3;a++)r.view[4*t+a]=e[3*t+a];this.needUpload=!0}}setMatrix4x4(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view.set(t.elements),this.needUpload=!0)}setBuffer(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view.set(t),this.needUpload=!0)}setArrayBuffer(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=r.arrayLength,a=r.size,i=r.alignStride;for(let s=0;s<e;s++)r.view.set(t.subarray(s*a,(s+1)*a),s*i);this.needUpload=!0}}setMatrix3x3Array(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=r.arrayLength;r.size;let a=r.alignStride;for(let i=0;i<e;i++)for(let e=0;e<3;e++)for(let s=0;s<3;s++)r.view[i*a+4*e+s]=t[9*i+3*e+s];this.needUpload=!0}}setUniformData(e,r,a){let i=this.descriptor.uniforms.get(e);if(i)switch(r){case t.ShaderDataType.Bool:i.arrayLength>0?console.warn("ShaderDataType.Bool array not support"):this.setInt(e,a?1:0);break;case t.ShaderDataType.Int:i.arrayLength>0?this.setArrayBuffer(e,a):this.setInt(e,a);break;case t.ShaderDataType.Float:i.arrayLength>0?this.setArrayBuffer(e,a):this.setFloat(e,a);break;case t.ShaderDataType.Vector2:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector2(e,a);break;case t.ShaderDataType.Vector3:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector3(e,a);break;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector4(e,a);break;case t.ShaderDataType.Matrix3x3:i.arrayLength>0?this.setMatrix3x3Array(e,a):this.setMatrix3x3(e,a);break;case t.ShaderDataType.Matrix4x4:i.arrayLength>0?this.setArrayBuffer(e,a):this.setMatrix4x4(e,a);case t.ShaderDataType.Buffer:case t.ShaderDataType.None:case t.ShaderDataType.Texture2D:case t.ShaderDataType.Texture3D:case t.ShaderDataType.TextureCube:case t.ShaderDataType.Texture2DArray:}}}class ie{get byteLength(){return this._byteLength}constructor(e){this._currentLength=0,this._byteLength=0,this._maxAlignment=4,this.name=e,this.uniforms=new Map}alignmentPadding(e){let t=this._currentLength%e;0!=t&&(t=e-t,this._currentLength+=t,this._byteLength+=4*t),this._maxAlignment=Math.max(this._maxAlignment,e)}addUniformItem(e,t,r,a,i){if(a>0){r=r>4?r:4,this.alignmentPadding(4);let s,n=a*r,l={index:e,view:s,size:t,alignStride:r,offset:4*this._currentLength,dataView:i,viewByteLength:i.BYTES_PER_ELEMENT*n,arrayLength:a};this.uniforms.set(e,l),this._currentLength+=n,this._byteLength+=l.viewByteLength}else{let a;this.alignmentPadding(t<=2?t:4);let s={index:e,view:a,size:t,alignStride:r,offset:4*this._currentLength,dataView:i,viewByteLength:i.BYTES_PER_ELEMENT*r,arrayLength:0};this.uniforms.set(e,s),this._currentLength+=t,this._byteLength+=t*i.BYTES_PER_ELEMENT}}addUniform(e,r,a=0){let i=0;switch(r){case t.ShaderDataType.Int:case t.ShaderDataType.Bool:i=1,this.addUniformItem(e,1,i,a,Int32Array);break;case t.ShaderDataType.Float:i=1,this.addUniformItem(e,1,i,a,Float32Array);break;case t.ShaderDataType.Vector2:i=2,this.addUniformItem(e,2,i,a,Float32Array);break;case t.ShaderDataType.Vector3:i=3,this.addUniformItem(e,3,i,a,Float32Array);break;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:i=4,this.addUniformItem(e,4,i,a,Float32Array);break;case t.ShaderDataType.Matrix3x3:i=12,this.addUniformItem(e,12,i,a,Float32Array);break;case t.ShaderDataType.Matrix4x4:i=16,this.addUniformItem(e,16,i,a,Float32Array);break;case t.ShaderDataType.Buffer:console.log("ShaderDataType.Buffer not support");case t.ShaderDataType.Texture2D:case t.ShaderDataType.Texture3D:case t.ShaderDataType.TextureCube:case t.ShaderDataType.Texture2DArray:case t.ShaderDataType.None:}}finish(e=0){e=e>this._maxAlignment?e:this._maxAlignment,this._maxAlignment=e,this.alignmentPadding(e)}clone(){let e=new ie(this.name);return this.cloneTo(e),e}cloneTo(e){this.uniforms.forEach(t=>{e.addUniformItem(t.index,t.size,t.alignStride,t.arrayLength,t.dataView)}),e.finish(this._maxAlignment)}destroy(){this.uniforms.clear()}}class se extends ae{constructor(e){super(),this.name=e,this.descriptor=new ie(e)}create(){let e=this.descriptor;e.finish();const r=new Uint8Array(e.byteLength).buffer;this._data=new Float32Array(r);for(const[t,a]of e.uniforms)a.view=new a.dataView(r,a.offset,a.viewByteLength/a.dataView.BYTES_PER_ELEMENT);this._buffer=t.LayaGL.renderEngine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,t.BufferUsage.Dynamic),this._buffer.bindBuffer(),this._buffer.setDataLength(e.byteLength),this.needUpload=!0}addUniform(e,t,r=0){this.descriptor.addUniform(e,t,r)}upload(){this.needUpload&&(this._buffer.setData(this._data,0),this.needUpload=!1)}bind(e){this._buffer.bindBufferBase(e)}clone(){let e=new se(this.name);return this.cloneTo(e),e}cloneTo(e){this.descriptor.cloneTo(e.descriptor),e.create(),e._data.set(this._data)}destroy(){this._data=null,this._buffer.destroy(),this.descriptor.destroy(),this.descriptor=null}}class ne extends ae{upload(){this.needUpload&&this.bufferBlock.needUpload()}bind(e){this.bufferBlock.cluster.buffer.bindBufferRange(e,this.bufferBlock.offset,this.bufferBlock.size)}constructor(e,t,r,a){super(),this.name=e,this.manager=r,this.data=a,this.uniformMap=t;let i=new ie(e);t.forEach(e=>{i.addUniform(e.id,e.uniformtype,e.arrayLength)}),i.finish(this.manager.byteAlign/4);let s=i.byteLength;this.descriptor=i,this.size=s,this.bufferBlock=r.getBlock(s,this),this.needUpload=!0}updateOver(){this.needUpload=!1}clearGPUBufferBind(){}notifyGPUBufferChange(e){this.offset=this.bufferBlock.offset,this.needUpload=!0,this.descriptor.uniforms.forEach(e=>{let t=e.viewByteLength/e.dataView.BYTES_PER_ELEMENT,r=e.offset+this.bufferBlock.offset;e.view=new e.dataView(this.bufferBlock.cluster.data,r,t)}),this.needUpload=!0}destroy(){this.name=null,this.data=null,this.uniformMap=null,this.descriptor.destroy(),this.descriptor=null,this.manager.freeBlock(this.bufferBlock)}}class le extends t.ShaderData{constructor(e=null){super(e),this._data=null,this._defineDatas=new O,this._needCacheData=!1,this._updateCacheArray=null,this._subUboBufferNumber=0,this._initData()}_initData(){this._data={},this._updateCacheArray={},this._gammaColorMap=new Map,this._uniformBuffers=new Map,this._subUniformBuffers=new Map,this._uniformBuffersPropertyMap=new Map}createUniformBuffer(e,r){if(this._uniformBuffers.has(e))return this._uniformBuffers.get(e);this._needCacheData=!0;let a=new se(e);r.forEach(e=>{a.addUniform(e.id,e.uniformtype,e.arrayLength)}),a.create(),this._uniformBuffers.set(e,a);let i=t.Shader3D.propertyNameToID(e);return this._data[i]=a,r.forEach(e=>{let t=e.id,r=this._data[t];null!=r&&a.setUniformData(t,e.uniformtype,r),this._uniformBuffersPropertyMap.set(t,a)}),a}updateUBOBuffer(e){if(!t.Config._uniformBlock)return;let r=this._uniformBuffers.get(e)||this._subUniformBuffers.get(e);if(r){for(var a in this._updateCacheArray){let e=parseInt(a),t=this._uniformBuffersPropertyMap.get(e);t&&this._updateCacheArray[a].call(t,e,this._data[e])}this._updateCacheArray={},r.needUpload&&r.upload()}}createSubUniformBuffer(e,r,a){let i=this._subUniformBuffers.get(r);if(i){if(this._subUboBufferNumber<2){for(var s in this._updateCacheArray){let e=parseInt(s),t=this._uniformBuffersPropertyMap.get(e);t&&this._updateCacheArray[s].call(t,e,this._data[e])}this._updateCacheArray={}}else a.forEach((e,t)=>{this._data[t]&&this._updateCacheArray[t]&&this._updateCacheArray[t].call(i,t,this._data[t])});return i}let n=re.instance.bufferMgr,l=new ne(e,a,n,this);this._subUboBufferNumber++,this._needCacheData=!0,l.notifyGPUBufferChange(),this._subUniformBuffers.set(r,l);let _=t.Shader3D.propertyNameToID(e);return this._data[_]=l,a.forEach(e=>{let t=e.id,r=this._data[t];null!=r&&l.setUniformData(t,e.uniformtype,r),this._uniformBuffersPropertyMap.set(t,l)}),l}getData(){return this._data}addDefine(e){this._defineDatas.add(e)}addDefines(e){this._defineDatas.addDefineDatas(e)}removeDefine(e){this._defineDatas.remove(e)}removeDefines(e){this._defineDatas.removeDefineDatas(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}clearData(){for(const e in this._data)this._data[e]instanceof t.Resource&&this._data[e]._removeReference();this._uniformBuffersPropertyMap.clear(),this._uniformBuffers.forEach(e=>{e.destroy()}),this._uniformBuffers.clear(),this._subUniformBuffers.forEach(e=>{e.destroy()}),this._subUniformBuffers.clear(),this._data={},this._gammaColorMap.clear(),this.clearDefine(),this._needCacheData=!1,this._subUboBufferNumber=0}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t,this._needCacheData}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setInt)}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setFloat)}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setVector2)}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setVector3)}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setVector4)}getColor(e){return this._gammaColorMap.get(e)}setColor(e,r){if(r){if(this._data[e]){let a=this._gammaColorMap.get(e);r.cloneTo(a);let i=this._data[e];i.x=t.Color.gammaToLinearSpace(r.r),i.y=t.Color.gammaToLinearSpace(r.g),i.z=t.Color.gammaToLinearSpace(r.b),i.w=r.a}else{let a=new t.Vector4;a.x=t.Color.gammaToLinearSpace(r.r),a.y=t.Color.gammaToLinearSpace(r.g),a.z=t.Color.gammaToLinearSpace(r.b),a.w=r.a,this._data[e]=a,this._gammaColorMap.set(e,r.clone())}this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setVector4)}}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setMatrix4x4)}getMatrix3x3(e){return this._data[e]}setMatrix3x3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setMatrix3x3)}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=ae.prototype.setArrayBuffer)}setTexture(e,t){var r=this._data[e];if(t){let r=re._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}_setInternalTexture(e,t){if(this._data[e],t){let r=re._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}cloneTo(e){e.clearData();var r=e._data;for(var a in this._data){var i=this._data[a];if(null!=i)if("number"==typeof i)r[a]=i;else if("boolean"==typeof i)r[a]=i;else if(i instanceof t.Vector2){let e=r[a]||(r[a]=new t.Vector2);i.cloneTo(e)}else if(i instanceof t.Vector3){let e=r[a]||(r[a]=new t.Vector3);i.cloneTo(e)}else if(i instanceof t.Vector4){let s=this.getColor(parseInt(a));if(s){let t=s.clone();e.setColor(parseInt(a),t)}else{let e=r[a]||(r[a]=new t.Vector4);i.cloneTo(e)}}else if(i instanceof t.Matrix3x3){let e=r[a]||(r[a]=new t.Matrix3x3);i.cloneTo(e)}else if(i instanceof t.Matrix4x4){let e=r[a]||(r[a]=new t.Matrix4x4);i.cloneTo(e)}else i instanceof t.Resource&&(r[a]=i,i._addReference())}this._defineDatas.cloneTo(e._defineDatas),this._gammaColorMap.forEach((t,r)=>{e._gammaColorMap.set(r,t.clone())})}getDefineData(){return this._defineDatas}clone(){var e=new le;return this.cloneTo(e),e}destroy(){this.destroyed||(this.clearData(),this._defineDatas.destroy(),this._defineDatas=null,this.destroyed=!0)}}class _e{get renderState(){return this._renderState}set renderState(e){this._renderState=e}get validDefine(){return this._validDefine}set validDefine(e){this._validDefine=e}constructor(e){this._cacheShaderHierarchy=1,this._cacheSharders={},this._renderState=new t.RenderState,this._renderState.setNull()}_resizeCacheShaderMap(e,t,r){var a=this._cacheShaderHierarchy-1;if(t==a)for(var i in e)for(var s=e[i],n=0,l=r-a;n<l;n++)n===l-1?e[0]=s:e=e[0==n?i:0]={};else for(var i in++t,e)this._resizeCacheShaderMap(e[i],t,r)}setCacheShader(e,t){for(var r=this._cacheSharders,a=e._mask,i=e._length-1,s=this._cacheShaderHierarchy-1,n=0;n<s;n++){var l=i<n?0:a[n],_=r[l];_||(r[l]=_={}),r=_}r[i<s?0:a[s]]=t}getCacheShader(e){e._intersectionDefineDatas(this._validDefine);var t=this._cacheSharders,r=e._length;r>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(t,0,r),this._cacheShaderHierarchy=r);for(var a=e._mask,i=e._length-1,s=this._cacheShaderHierarchy-1,n=0;n<s;n++){var l=i<n?0:a[n],_=t[l];_||(t[l]=_={}),t=_}return t[i<s?0:a[s]]}destroy(){}}class he{setUniformMap(e){}destroy(){throw new t.NotImplementedError}addShaderPass(e){}}class oe{createSubShader(){return new he}createShaderPass(e){return new _e(e)}createRenderState(){return new t.RenderState}createDefineDatas(){return new O}}t.Laya.addBeforeInitCallback(()=>{t.LayaGL.unitRenderModuleDataFactory||(t.LayaGL.unitRenderModuleDataFactory=new oe)});class de extends t.SetRendertarget2DCMD{constructor(){super(),this.type=t.RenderCMDType.ChangeRenderTarget,this._clearColorValue=new t.Color}apply(e){this.rt?e.invertY=this.invertY:e.invertY=!1,e.setRenderTarget(this.rt,this.clearColor,this.clearColorValue),e.passData.setVector2(t.ShaderDefines2D.UNIFORM_SIZE,this.size)}}class ue extends t.Draw2DElementCMD{constructor(){super(),this.type=t.RenderCMDType.DrawElement}setRenderelements(e){this._elements=e}apply(e){1==this._elements.length?e.drawRenderElementOne(this._elements[0]):this._elements.forEach(t=>{e.drawRenderElementOne(t)})}}class me extends t.Blit2DQuadCMD{static _init_(){me.SCREENTEXTURE_ID=t.Shader3D.propertyNameToID("u_MainTex"),me.SCREENTEXTUREOFFSETSCALE_ID=t.Shader3D.propertyNameToID("u_OffsetScale"),me.MAINTEXTURE_TEXELSIZE_ID=t.Shader3D.propertyNameToID("u_MainTex_TexelSize"),me.GammaCorrect=t.Shader3D.getDefineByName("GAMMACORRECT")}constructor(){super(),me.SCREENTEXTURE_ID||me._init_(),this.type=t.RenderCMDType.Blit,this._offsetScale=new t.Vector4,this._sourceTexelSize=new t.Vector4}set source(e){this._source=e,this._source&&this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height)}apply(e){let r=e.invertY;this._dest?this.element.materialShaderData.removeDefine(me.GammaCorrect):(e.invertY=!1,this.element.materialShaderData.addDefine(me.GammaCorrect)),this.element.materialShaderData._setInternalTexture(me.SCREENTEXTURE_ID,this._source),this.element.materialShaderData.setVector(me.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale),this.element.materialShaderData.setVector(me.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),e.setRenderTarget(this._dest,!1,t.Color.BLACK),e.drawRenderElementOne(this.element),e.invertY=r}}class fe{constructor(){this.renderStateIsBySprite=!0,this.type=0,this._shaderInstances=new t.FastSinglelist}_compileShader(e){var r=this.subShader._passes;this._shaderInstances.clear();for(var a=0,i=r.length;a<i;a++){var s=r[a];if(s.pipelineMode!==e.pipelineMode)continue;var n=fe._compileDefine;this.globalShaderData?this.globalShaderData._defineDatas.cloneTo(n):e._globalConfigShaderData.cloneTo(n),e.passData&&n.addDefineDatas(e.passData._defineDatas),!e._destRT||1!=e._destRT._textures[0].gammaCorrection?n.add(t.ShaderDefines2D.GAMMASPACE):n.remove(t.ShaderDefines2D.GAMMASPACE),e.invertY?n.add(t.ShaderDefines2D.INVERTY):n.remove(t.ShaderDefines2D.INVERTY),this.value2DShaderData&&(n.addDefineDatas(this.value2DShaderData.getDefineData()),s.nodeCommonMap=this.nodeCommonMap),this.materialShaderData&&n.addDefineDatas(this.materialShaderData._defineDatas);var l=s.withCompile(n,!0);this._shaderInstances.add(l)}}_prepare(e){this.globalShaderData=this.owner&&this.owner._globalShaderData,this._compileShader(e)}_render(e){if(1==this._shaderInstances.length)this.renderByShaderInstance(this._shaderInstances.elements[0],e);else for(var t=this._shaderInstances.elements,r=0,a=this._shaderInstances.length;r<a;r++)this.renderByShaderInstance(t[r],e)}_uploadGlobalAndPass(e,t){this.globalShaderData&&e.uploadUniforms(e._cameraUniformParamsMap,this.globalShaderData,!0),t.passData&&e.uploadUniforms(e._sceneUniformParamsMap,t.passData,!0)}renderByShaderInstance(e,t){e.complete&&this.geometry&&(e.bind(),this._uploadGlobalAndPass(e,t),this.value2DShaderData&&e.uploadUniforms(e._sprite2DUniformParamsMap,this.value2DShaderData,!0),this.materialShaderData&&e.uploadUniforms(e._materialUniformParamsMap,this.materialShaderData,!0),this.renderStateIsBySprite||!this.materialShaderData?(e.uploadRenderStateBlendDepth(this.value2DShaderData),e.uploadRenderStateFrontFace(this.value2DShaderData,!1,t.invertY)):(e.uploadRenderStateBlendDepth(this.materialShaderData),e.uploadRenderStateFrontFace(this.materialShaderData,!1,t.invertY)),re.instance.getDrawContext().drawGeometryElement(this.geometry))}destroy(){this.globalShaderData=null}}fe._compileDefine=new O;class ce extends fe{_compileShader(e){var r=this.subShader._passes;this._shaderInstances.clear();for(var a=0,i=r.length;a<i;a++){var s=r[a];if(s.pipelineMode!==e.pipelineMode)continue;var n=fe._compileDefine;this.globalShaderData?this.globalShaderData._defineDatas.cloneTo(n):e._globalConfigShaderData.cloneTo(n),e.passData&&n.addDefineDatas(e.passData._defineDatas),!e._destRT||1!=e._destRT._textures[0].gammaCorrection?n.add(t.ShaderDefines2D.GAMMASPACE):n.remove(t.ShaderDefines2D.GAMMASPACE),e.invertY?n.add(t.ShaderDefines2D.INVERTY):n.remove(t.ShaderDefines2D.INVERTY),this.value2DShaderData&&(n.addDefineDatas(this.value2DShaderData.getDefineData()),s.nodeCommonMap=this.nodeCommonMap),this.materialShaderData&&n.addDefineDatas(this.materialShaderData._defineDatas),this.primitiveShaderData&&(s.additionShaderData=["Sprite2DGraphics"],n.addDefineDatas(this.primitiveShaderData.getDefineData()));var l=s.withCompile(n,!0);this._shaderInstances.add(l)}}renderByShaderInstance(e,t){if(!e.complete||!this.geometry)return;e.bind(),this._uploadGlobalAndPass(e,t),this.value2DShaderData&&e.uploadUniforms(e._sprite2DUniformParamsMap,this.value2DShaderData,!0),this.materialShaderData&&e.uploadUniforms(e._materialUniformParamsMap,this.materialShaderData,!0);let r=e._additionUniformParamsMaps.get("Sprite2DGraphics");r&&this.primitiveShaderData&&e.uploadUniforms(r,this.primitiveShaderData,!0);let a=this.value2DShaderData;this.renderStateIsBySprite||(this.materialShaderData?a=this.materialShaderData:this.primitiveShaderData&&(a=this.primitiveShaderData)),e.uploadRenderStateBlendDepth(a),e.uploadRenderStateFrontFace(a,!1,t.invertY),re.instance.getDrawContext().drawGeometryElement(this.geometry)}}class pe extends t.SetRenderDataCMD{get dataType(){return this._dataType}set dataType(e){this._dataType=e}get propertyID(){return this._propertyID}set propertyID(e){this._propertyID=e}get dest(){return this._dest}set dest(e){this._dest=e}get value(){return this._value}set value(e){switch(this.dataType){case t.ShaderDataType.Int:case t.ShaderDataType.Float:case t.ShaderDataType.Bool:this.data_number=e,this._value=this.data_number;break;case t.ShaderDataType.Matrix4x4:!this.data_mat&&(this.data_mat=new t.Matrix4x4),e.cloneTo(this.data_mat),this._value=this.data_mat;break;case t.ShaderDataType.Color:!this.data_Color&&(this.data_Color=new t.Color),e.cloneTo(this.data_Color),this._value=this.data_Color;break;case t.ShaderDataType.Texture2D:this._value=this.data_texture=e;break;case t.ShaderDataType.Vector4:!this.data_v4&&(this.data_v4=new t.Vector4),e.cloneTo(this.data_v4),this._value=this.data_v4;break;case t.ShaderDataType.Vector2:!this.data_v2&&(this.data_v2=new t.Vector2),e.cloneTo(this.data_v2),this._value=this.data_v2;break;case t.ShaderDataType.Vector3:!this.data_v3&&(this.data_v3=new t.Vector3),e.cloneTo(this.data_v3),this._value=this.data_v3;break;case t.ShaderDataType.Buffer:this._value=this.data_Buffer=e}}constructor(){super(),this.type=t.RenderCMDType.ChangeData}apply(e){switch(this.dataType){case t.ShaderDataType.Int:this.dest.setInt(this.propertyID,this.value);break;case t.ShaderDataType.Float:this.dest.setNumber(this.propertyID,this.value);break;case t.ShaderDataType.Bool:this.dest.setBool(this.propertyID,this.value);break;case t.ShaderDataType.Matrix4x4:this.dest.setMatrix4x4(this.propertyID,this.value);break;case t.ShaderDataType.Color:this.dest.setColor(this.propertyID,this.value);break;case t.ShaderDataType.Texture2D:this.dest.setTexture(this.propertyID,this.value);break;case t.ShaderDataType.Vector4:this.dest.setVector(this.propertyID,this.value);break;case t.ShaderDataType.Vector2:this.dest.setVector2(this.propertyID,this.value);break;case t.ShaderDataType.Vector3:this.dest.setVector3(this.propertyID,this.value);break;case t.ShaderDataType.Buffer:this.dest.setBuffer(this.propertyID,this.value)}}}class ge extends t.SetShaderDefineCMD{get define(){return this._define}set define(e){this._define=e}get dest(){return this._dest}set dest(e){this._dest=e}get add(){return this._add}set add(e){this._add=e}constructor(){super(),this.type=t.RenderCMDType.ChangeShaderDefine}apply(e){this.add?this._dest.addDefine(this.define):this._dest.removeDefine(this.define)}}class Ee{constructor(){this._clearColor=new t.Color(0,0,0,0),this.invertY=!1,this.pipelineMode="Forward",this._globalConfigShaderData=t.Shader3D._configDefineValues}drawRenderElementList(e){let r=performance.now();for(var a=0,i=e.length;a<i;a++){e.elements[a]._prepare(this)}t.LayaGL.statAgent.recordTimeData(t.StatElement.T_2DContextPre,performance.now()-r),r=performance.now();for(a=0,i=e.length;a<i;a++){e.elements[a]._render(this)}return t.LayaGL.statAgent.recordCTData(t.StatElement.CT_2DDrawCall,e.length),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_2DContextRender,performance.now()-r),t.LayaGL.renderEngine._framePassCount++,0}setOffscreenView(e,t){this._offscreenWidth=e,this._offscreenHeight=t}setRenderTarget(e,r,a){this._destRT=e,a.cloneTo(this._clearColor),this._destRT?(re.instance.getTextureContext().bindRenderTarget(this._destRT),re.instance.viewport(0,0,this._destRT._textures[0].width,this._destRT._textures[0].height)):(re.instance.getTextureContext().bindoutScreenTarget(),re.instance.viewport(0,0,this._offscreenWidth,this._offscreenHeight)),re.instance.scissorTest(!1),re.instance.clearRenderTexture(r?t.RenderClearFlag.Color:t.RenderClearFlag.Nothing,this._clearColor)}getRenderTarget(){return this._destRT}drawRenderElementOne(e){e._prepare(this),e._render(this),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_2DDrawCall,1),t.LayaGL.renderEngine._framePassCount++}runOneCMD(e){e.apply(this)}runCMDList(e){e.forEach(e=>{e.apply(this)})}}class Te{constructor(){}createGraphic2DBufferBlock(){return new P}createGraphic2DVertexBlock(){return new C}create2DGraphicVertexDataView(e,t,r,a){return new D(e,t,r,a)}create2DGraphicIndexDataView(e,t){return new b(e,t)}create2DGraphicIndexBuffer(){return new n}createPrimitiveRenderElement2D(){return new ce}create2DGraphicVertexBuffer(){return new s}createRender2DPassManager(){return new R}create2DGlobalRenderDataHandle(){return new I}createSpineRenderDataHandle(){return new G}create2D2DPrimitiveDataHandle(){return new y}create2DBaseRenderDataHandle(){return new M}createMesh2DRenderDataHandle(){return new F}createSetRenderDataCMD(){return new pe}createSetShaderDefineCMD(){return new ge}createBlit2DQuadCMDData(){return new me}createDraw2DElementCMDData(){return new ue}createSetRendertarget2DCMD(){return new de}createRenderElement2D(){return new fe}createRenderContext2D(){return new Ee}createRender2DPass(){return new T}createRenderStruct2D(){return new v}}t.Laya.addBeforeInitCallback(()=>{t.LayaGL.render2DRenderPassFactory||(t.LayaGL.render2DRenderPassFactory=new Te)});class Re{constructor(){this._glVertexState=re.instance.createVertexState()}applyVertexBuffers(){this._glVertexState.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._glVertexState.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this._vertexBuffers=e.slice(),this._bindedIndexBuffer=t,t&&t._glBuffer.unbindBuffer(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t._glBuffer.unbindBuffer()}bind(){this._glVertexState.bindVertexArray(),Re._curBindedBufferState=this}unBind(){if(Re._curBindedBufferState!=this)throw new Error("BufferState: must call bind() function first.");this._glVertexState.unbindVertexArray(),Re._curBindedBufferState=null}isBind(){return Re._curBindedBufferState==this}destroy(){Re._curBindedBufferState==this&&(this._glVertexState.unbindVertexArray(),Re._curBindedBufferState=null),this._glVertexState.destroy(),this._vertexBuffers=null,this._bindedIndexBuffer=null}}class Se extends t.CommandUniformMap{constructor(e){super(e),this._idata=new Map,this._stateName=e,this._stateID=t.Shader3D.propertyNameToID(e)}hasPtrID(e){return this._stateID==e||this._idata.has(e)}addShaderUniform(e,t,r){this._idata.set(e,{id:e,uniformtype:r,propertyName:t,arrayLength:0})}addShaderUniformArray(e,t,r,a,i=""){this._idata.set(e,{id:e,uniformtype:r,propertyName:t,arrayLength:a})}}class xe{constructor(e,t){this._glBuffer=this._glBuffer=re.instance.createBuffer(e,t)}_setIndexDataLength(e){var t=Re._curBindedBufferState;t?(t.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e),t.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e))}setData(e,r,a,i){let s=Re._curBindedBufferState;if(s&&s.unBind(),this._glBuffer.bindBuffer(),0!==a||i!==Number.MAX_SAFE_INTEGER){var n=new Uint8Array(e,a,i);this._glBuffer.setData(n,r)}else this._glBuffer.setData(e,r);s&&s.bind(),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_GeometryBufferUploadCount,1)}_setIndexData(e,r){var a=Re._curBindedBufferState;a?(a.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setData(e,r),a.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setData(e,r)),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_GeometryBufferUploadCount,1)}destroy(){this._glBuffer.destroy()}}class De{get indexFormat(){return this._indexFormat}set indexFormat(e){this._indexFormat=e,this._glindexFormat=re.instance.getDrawContext().getIndexType(this._indexFormat)}get mode(){return this._mode}set mode(e){this._mode=e,this._glmode=re.instance.getDrawContext().getMeshTopology(this._mode)}constructor(e,r){this._id=++De._idCounter,this.mode=e,this.drawParams=new t.FastSinglelist,this.drawType=r}getDrawDataParams(e){e&&this.drawParams.cloneTo(e)}setDrawArrayParams(e,t){this.drawParams.add(e),this.drawParams.add(t)}setDrawElemenParams(e,t){this.drawParams.add(t),this.drawParams.add(e)}destroy(){delete this.drawParams}clearRenderParams(){this.drawParams.length=0}cloneTo(e){e.mode=this.mode,e.drawType=this.drawType,e.indexFormat=this.indexFormat,e.instanceCount=this.instanceCount,e.drawParams.elements=this.drawParams.elements.slice(),e.drawParams.length=this.drawParams.length}}De._idCounter=0;class be{constructor(){this._cacheShaerVariable={},this._uploadMark=-1,this._uploadRenderType=-1,this._additionUniformParamsMaps=new Map,this._additionShaderData=new Map}_serializeShader(){return null}_deserialize(e){return!1}get complete(){return this._renderShaderInstance._complete}_create(e,r){let a=t.Config.matUseUBO;t.Config.matUseUBO=!e.is2D&&t.Config.matUseUBO;let i=t.GLSLCodeGenerator.GLShaderLanguageProcess3D(e.defineString,e.attributeMap,e.uniformMap,e.vs,e.ps);this._renderShaderInstance=re.instance.createShaderInstance(i.vs,i.fs,e.attributeMap),t.Config.matUseUBO=a,re._lastShaderError&&console.warn(`[ShaderCompile]Error compiling shader '${r._owner._owner.name}' (pipelineMode=${r.pipelineMode})\n`,re._lastShaderError),this._renderShaderInstance._complete&&(this._shaderPass=r.moduleData,e.is2D?this._create2D():this._create3D())}_create3D(){this._sceneUniformParamsMap=new t.CommandEncoder,this._cameraUniformParamsMap=new t.CommandEncoder,this._spriteUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder;let e=t.WebGLRenderContext3D._instance._preDrawUniformMaps,r=[];for(let a of e){let e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(a);r.push(e)}const a=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("BaseCamera");let i,s,n=this._renderShaderInstance.getUniformMap();for(i=0,s=n.length;i<s;i++){let e=n[i];if(r.find(t=>t.hasPtrID(e.dataOffset)))this._sceneUniformParamsMap.addShaderUniform(e);else if(a.hasPtrID(e.dataOffset))this._cameraUniformParamsMap.addShaderUniform(e);else if(this.hasSpritePtrID(e.dataOffset))this._spriteUniformParamsMap.addShaderUniform(e);else if(this._hasAdditionShaderData(e.dataOffset)){let r=this._hasAdditionShaderData(e.dataOffset);if(!this._additionUniformParamsMaps.get(r)){let e=new t.CommandEncoder;this._additionUniformParamsMaps.set(r,e)}this._additionUniformParamsMaps.get(r).addShaderUniform(e)}else this._materialUniformParamsMap.addShaderUniform(e)}}_create2D(){this._sprite2DUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder,this._sceneUniformParamsMap=new t.CommandEncoder,this._cameraUniformParamsMap=new t.CommandEncoder;const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DPass"),r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal");let a,i,s=this._renderShaderInstance.getUniformMap();for(a=0,i=s.length;a<i;a++){let i=s[a];if(this.hasSpritePtrID(i.dataOffset))this._sprite2DUniformParamsMap.addShaderUniform(i);else if(e.hasPtrID(i.dataOffset))this._sceneUniformParamsMap.addShaderUniform(i);else if(r.hasPtrID(i.dataOffset))this._cameraUniformParamsMap.addShaderUniform(i);else if(this._hasAdditionShaderData(i.dataOffset)){let e=this._hasAdditionShaderData(i.dataOffset);if(!this._additionUniformParamsMaps.get(e)){let r=new t.CommandEncoder;this._additionUniformParamsMaps.set(e,r)}this._additionUniformParamsMaps.get(e).addShaderUniform(i)}else this._materialUniformParamsMap.addShaderUniform(i)}}hasSpritePtrID(e){let r=this._shaderPass.nodeCommonMap;if(r){for(let a=0,i=r.length;a<i;a++)if(t.LayaGL.renderDeviceFactory.createGlobalUniformMap(r[a]).hasPtrID(e))return!0;return!1}return!1}_hasAdditionShaderData(e){let r=this._shaderPass.additionShaderData;if(!r)return null;for(let a=0,i=r.length;a<i;a++)if(t.LayaGL.renderDeviceFactory.createGlobalUniformMap(r[a]).hasPtrID(e))return r[a];return null}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._sprite2DUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null,this._additionShaderData=null}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,t,r){re.instance.uploadUniforms(this._renderShaderInstance,e,t,r)}uploadRenderStateBlendDepth(e){this._shaderPass.statefirst?this.uploadRenderStateBlendDepthByShader(e):this.uploadRenderStateBlendDepthByMaterial(e)}uploadRenderStateBlendDepthByShader(e){var r,a,i,s,n,l,_,h,o,d,u,m,f,c,p,g,E,T,R,S,x,D,b,A,B,P,C,y,M,L,F,G,U,I,N,w,v,O,V,W,X,k,H,Y;const K=re.instance._GLRenderState;var z=e._data,j=this._shaderPass.renderState,q=null!==(a=null!==(r=j.depthWrite)&&void 0!==r?r:z[t.Shader3D.DEPTH_WRITE])&&void 0!==a?a:t.RenderState.Default.depthWrite;K.setDepthMask(q);var Z=null!==(s=null!==(i=j.depthTest)&&void 0!==i?i:z[t.Shader3D.DEPTH_TEST])&&void 0!==s?s:t.RenderState.Default.depthTest;Z==t.RenderState.DEPTHTEST_OFF?K.setDepthTest(!1):(K.setDepthTest(!0),K.setDepthFunc(Z));var Q=null!==(l=null!==(n=j.stencilWrite)&&void 0!==n?n:z[t.Shader3D.STENCIL_WRITE])&&void 0!==l?l:t.RenderState.Default.stencilWrite;K.setStencilWrite(Q);let J=Q?null!==(h=null!==(_=j.stencilWriteMask)&&void 0!==_?_:z[t.Shader3D.STENCIL_WRITE_MASK])&&void 0!==h?h:t.RenderState.Default.stencilWriteMask:0;if(K.setStencilWriteMask(J),Q){var $=null!==(d=null!==(o=j.stencilOp)&&void 0!==o?o:z[t.Shader3D.STENCIL_Op])&&void 0!==d?d:t.RenderState.Default.stencilOp;K.setstencilOp($.x,$.y,$.z)}var ee=null!==(m=null!==(u=j.stencilTest)&&void 0!==u?u:z[t.Shader3D.STENCIL_TEST])&&void 0!==m?m:t.RenderState.Default.stencilTest;if(ee==t.RenderState.STENCILTEST_OFF)K.setStencilTest(!1);else{K.setStencilTest(!0);var te=null!==(c=null!==(f=j.stencilRef)&&void 0!==f?f:z[t.Shader3D.STENCIL_Ref])&&void 0!==c?c:t.RenderState.Default.stencilRef;let e=null!==(g=null!==(p=j.stencilReadMask)&&void 0!==p?p:z[t.Shader3D.STENCIL_READ_MASK])&&void 0!==g?g:t.RenderState.Default.stencilReadMask;K.setStencilFunc(ee,te,e)}let ae=null!==(T=null!==(E=j.depthBias)&&void 0!==E?E:z[t.Shader3D.DEPTH_BIAS])&&void 0!==T?T:t.RenderState.Default.depthBias;if(K.setDepthBias(ae),ae){let e=null!==(S=null!==(R=j.depthBiasConstant)&&void 0!==R?R:z[t.Shader3D.DEPTH_BIAS_CONSTANT])&&void 0!==S?S:t.RenderState.Default.depthBiasConstant,r=null!==(D=null!==(x=j.depthBiasSlopeScale)&&void 0!==x?x:z[t.Shader3D.DEPTH_BIAS_SLOPESCALE])&&void 0!==D?D:t.RenderState.Default.depthBiasSlopeScale,a=null!==(A=null!==(b=j.depthBiasClamp)&&void 0!==b?b:z[t.Shader3D.DEPTH_BIAS_CLAMP])&&void 0!==A?A:t.RenderState.Default.depthBiasClamp;K.setDepthBiasFactor(e,r,a)}switch(null!==(P=null!==(B=j.blend)&&void 0!==B?B:z[t.Shader3D.BLEND])&&void 0!==P?P:t.RenderState.Default.blend){case t.RenderState.BLEND_DISABLE:K.setBlend(!1);break;case t.RenderState.BLEND_ENABLE_ALL:var ie=null!==(y=null!==(C=j.blendEquation)&&void 0!==C?C:z[t.Shader3D.BLEND_EQUATION])&&void 0!==y?y:t.RenderState.Default.blendEquation,se=null!==(L=null!==(M=j.srcBlend)&&void 0!==M?M:z[t.Shader3D.BLEND_SRC])&&void 0!==L?L:t.RenderState.Default.srcBlend,ne=null!==(G=null!==(F=j.dstBlend)&&void 0!==F?F:z[t.Shader3D.BLEND_DST])&&void 0!==G?G:t.RenderState.Default.dstBlend;K.setBlend(!0),K.setBlendEquation(ie),K.setBlendFunc(se,ne);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var le=null!==(I=null!==(U=j.blendEquationRGB)&&void 0!==U?U:z[t.Shader3D.BLEND_EQUATION_RGB])&&void 0!==I?I:t.RenderState.Default.blendEquationRGB,_e=null!==(w=null!==(N=j.blendEquationAlpha)&&void 0!==N?N:z[t.Shader3D.BLEND_EQUATION_ALPHA])&&void 0!==w?w:t.RenderState.Default.blendEquationAlpha,he=null!==(O=null!==(v=j.srcBlendRGB)&&void 0!==v?v:z[t.Shader3D.BLEND_SRC_RGB])&&void 0!==O?O:t.RenderState.Default.srcBlendRGB,oe=null!==(W=null!==(V=j.dstBlendRGB)&&void 0!==V?V:z[t.Shader3D.BLEND_DST_RGB])&&void 0!==W?W:t.RenderState.Default.dstBlendRGB,de=null!==(k=null!==(X=j.srcBlendAlpha)&&void 0!==X?X:z[t.Shader3D.BLEND_SRC_ALPHA])&&void 0!==k?k:t.RenderState.Default.srcBlendAlpha,ue=null!==(Y=null!==(H=j.dstBlendAlpha)&&void 0!==H?H:z[t.Shader3D.BLEND_DST_ALPHA])&&void 0!==Y?Y:t.RenderState.Default.dstBlendAlpha;K.setBlend(!0),K.setBlendEquationSeparate(le,_e),K.setBlendFuncSeperate(he,oe,de,ue)}}uploadRenderStateBlendDepthByMaterial(e){var r,a,i;const s=re.instance._GLRenderState;var n=e.getData(),l=n[t.Shader3D.DEPTH_WRITE];l=null!=l?l:t.RenderState.Default.depthWrite,s.setDepthMask(l);var _=n[t.Shader3D.DEPTH_TEST];(_=null!=_?_:t.RenderState.Default.depthTest)===t.RenderState.DEPTHTEST_OFF?s.setDepthTest(!1):(s.setDepthTest(!0),s.setDepthFunc(_));var h=n[t.Shader3D.STENCIL_WRITE];h=null!=h?h:t.RenderState.Default.stencilWrite,s.setStencilWrite(h);let o=h?null!==(r=n[t.Shader3D.STENCIL_WRITE_MASK])&&void 0!==r?r:t.RenderState.Default.stencilWriteMask:0;if(s.setStencilWriteMask(o),h){var d=n[t.Shader3D.STENCIL_Op];d=null!=d?d:t.RenderState.Default.stencilOp,s.setstencilOp(d.x,d.y,d.z)}var u=n[t.Shader3D.STENCIL_TEST];if((u=null!=u?u:t.RenderState.Default.stencilTest)==t.RenderState.STENCILTEST_OFF)s.setStencilTest(!1);else{let e=null!==(a=n[t.Shader3D.STENCIL_READ_MASK])&&void 0!==a?a:t.RenderState.Default.stencilReadMask;var m=n[t.Shader3D.STENCIL_Ref];m=null!=m?m:t.RenderState.Default.stencilRef,s.setStencilTest(!0),s.setStencilFunc(u,m,e)}let f=null!==(i=n[t.Shader3D.DEPTH_BIAS])&&void 0!==i?i:t.RenderState.Default.depthBias;if(s.setDepthBias(f),f){let e=n[t.Shader3D.DEPTH_BIAS_CONSTANT];e=null!=e?e:t.RenderState.Default.depthBiasConstant;let r=n[t.Shader3D.DEPTH_BIAS_SLOPESCALE];r=null!=r?r:t.RenderState.Default.depthBiasSlopeScale;let a=n[t.Shader3D.DEPTH_BIAS_CLAMP];a=null!=a?a:t.RenderState.Default.depthBiasClamp,s.setDepthBiasFactor(e,r,a)}var c=n[t.Shader3D.BLEND];switch(c=null!=c?c:t.RenderState.Default.blend){case t.RenderState.BLEND_ENABLE_ALL:var p=n[t.Shader3D.BLEND_EQUATION];p=null!=p?p:t.RenderState.Default.blendEquation;var g=n[t.Shader3D.BLEND_SRC];g=null!=g?g:t.RenderState.Default.srcBlend;var E=n[t.Shader3D.BLEND_DST];E=null!=E?E:t.RenderState.Default.dstBlend,s.setBlend(!0),s.setBlendEquation(p),s.setBlendFunc(g,E);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var T=n[t.Shader3D.BLEND_EQUATION_RGB];T=null!=T?T:t.RenderState.Default.blendEquationRGB;var R=n[t.Shader3D.BLEND_EQUATION_ALPHA];R=null!=R?R:t.RenderState.Default.blendEquationAlpha;var S=n[t.Shader3D.BLEND_SRC_RGB];S=null!=S?S:t.RenderState.Default.srcBlendRGB;var x=n[t.Shader3D.BLEND_DST_RGB];x=null!=x?x:t.RenderState.Default.dstBlendRGB;var D=n[t.Shader3D.BLEND_SRC_ALPHA];D=null!=D?D:t.RenderState.Default.srcBlendAlpha;var b=n[t.Shader3D.BLEND_DST_ALPHA];b=null!=b?b:t.RenderState.Default.dstBlendAlpha,s.setBlend(!0),s.setBlendEquationSeparate(T,R),s.setBlendFuncSeperate(S,x,D,b);break;case t.RenderState.BLEND_DISABLE:default:s.setBlend(!1)}}uploadRenderStateFrontFace(e,r,a){var i;const s=re.instance._GLRenderState;var n,l=this._shaderPass.renderState,_=e.getData()[t.Shader3D.CULL];switch(this._shaderPass.statefirst&&(_=null!==(i=l.cull)&&void 0!==i?i:_),_=null!=_?_:t.RenderState.Default.cull){case t.RenderState.CULL_NONE:s.setCullFace(!1),n=r!=a?t.CullMode.Front:t.CullMode.Back,s.setFrontFace(n);break;case t.RenderState.CULL_FRONT:s.setCullFace(!0),n=r==a?t.CullMode.Front:t.CullMode.Back,s.setFrontFace(n);break;case t.RenderState.CULL_BACK:default:s.setCullFace(!0),n=r!=a?t.CullMode.Front:t.CullMode.Back,s.setFrontFace(n)}}}class Ae{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e,this._shaderValues=this._vertexDeclaration._shaderValues}constructor(e,t){this._glBuffer=re.instance.createBuffer(e,t)}setDataLength(e){this._glBuffer.setDataLength(e)}setData(e,r,a,i){if(this.bind(),0!==a||i!==Number.MAX_SAFE_INTEGER){var s=new Uint8Array(e,a,i);this._glBuffer.setData(s,r)}else this._glBuffer.setData(e,r);t.LayaGL.statAgent.recordCTData(t.StatElement.CT_GeometryBufferUploadCount,1)}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}orphanStorage(){this.bind(),this._glBuffer.setDataLength(this._glBuffer._byteLength)}destroy(){this._glBuffer.destroy(),this._vertexDeclaration=null}}class Be{constructor(){this.globalBlockMap={}}createShaderData(e){return new le(e)}createShaderInstance(e,r){let a=new be;if(a._create(e,r),t.Shader3D.debugMode){let a=e.defineString,i=e.is2D;t.ShaderVariantCollection.active.add(r,a,i)}return a}createIndexBuffer(e){return new xe(t.BufferTargetType.ELEMENT_ARRAY_BUFFER,e)}createVertexBuffer(e){return new Ae(t.BufferTargetType.ARRAY_BUFFER,e)}createBufferState(){return new Re}createRenderGeometryElement(e,t){return new De(e,t)}createGlobalUniformMap(e){let t=this.globalBlockMap[e];return t||(t=this.globalBlockMap[e]=new Se(e)),t}createEngine(r,a){let i,s={stencil:t.Config.isStencil,alpha:t.Config.isAlpha,antialias:t.Config.isAntialias,premultipliedAlpha:t.Config.premultipliedAlpha,preserveDrawingBuffer:t.Config.preserveDrawingBuffer,depth:t.Config.isDepth,failIfMajorPerformanceCaveat:t.Config.isfailIfMajorPerformanceCaveat,powerPreference:t.Config.powerPreference};const n=t.Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;i=new re(s,n),i.initRenderEngine(a.source);var l=i._context;return t.Config.printWebglOrder&&this._replaceWebglcall(l),l&&new t.LayaGL,t.LayaGL.renderEngine=i,t.LayaGL.textureContext=i.getTextureContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}}t.Laya.addBeforeInitCallback(()=>{t.LayaGL.renderDeviceFactory||(t.LayaGL.renderDeviceFactory=new Be)}),e.BatchManager=r,e.GL2TextureContext=K,e.GLBuffer=z,e.GLObject=X,e.GLParams=j,e.GLRenderDrawContext=q,e.GLRenderState=Z,e.GLShaderInstance=Q,e.GLTextureContext=Y,e.GLVertexState=J,e.GlCapable=ee,e.VertexArrayObject=class{constructor(){}},e.Web2DBaseRenderDataHandle=M,e.Web2DGraphic2DIndexCloneDataView=A,e.Web2DGraphic2DIndexDataView=b,e.Web2DGraphic2DVertexDataView=D,e.Web2DGraphicWholeBuffer=i,e.Web2DGraphicsBufferDataView=x,e.Web2DGraphicsIndexBatchBuffer=l,e.Web2DGraphicsIndexBuffer=n,e.Web2DGraphicsVertexBuffer=s,e.WebDefineDatas=O,e.WebGLBlit2DQuadCMD=me,e.WebGLBufferState=Re,e.WebGLCommandUniformMap=Se,e.WebGLConfig=class{},e.WebGLDraw2DElementCMD=ue,e.WebGLEngine=re,e.WebGLIndexBuffer=xe,e.WebGLInternalRT=k,e.WebGLInternalTex=H,e.WebGLPrimitiveRenderElement2D=ce,e.WebGLRender2DProcess=Te,e.WebGLRenderDeviceFactory=Be,e.WebGLRenderElement2D=fe,e.WebGLRenderGeometryElement=De,e.WebGLSetRenderData=pe,e.WebGLSetRendertarget2DCMD=de,e.WebGLSetShaderDefine=ge,e.WebGLShaderData=le,e.WebGLShaderInstance=be,e.WebGLSubUniformBuffer=ne,e.WebGLUniformBuffer=se,e.WebGLUniformBufferBase=ae,e.WebGLUniformBufferDescriptor=ie,e.WebGLUniformBufferManager=te,e.WebGLVertexBuffer=Ae,e.WebGlobalRenderData=I,e.WebGraphics2DBufferBlock=P,e.WebGraphics2DVertexBlock=C,e.WebGraphicsBatch=o,e.WebMesh2DRenderDataHandle=F,e.WebPrimitiveDataHandle=y,e.WebRender2DDataHandle=B,e.WebRender2DPass=T,e.WebRender2DPassManager=R,e.WebRenderStruct2D=v,e.WebShaderPass=_e,e.WebSpineRenderDataHandle=G,e.WebSubShader=he,e.WebUnitRenderModuleDataFactory=oe,e.WebglRenderContext2D=Ee}(window.Laya=window.Laya||{},Laya);