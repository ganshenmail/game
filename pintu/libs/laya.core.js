window.Laya=function(e){"use strict";class t{}t.isAntialias=!0,t.useWebGL2=!0,t.useSPRIV=!1,t.matUseUBO=!0,t.enableUniformBufferObject=!0,t.FPS=60,t.useRetinalCanvas=!1,t.animationInterval=50,t.webGL2D_MeshAllocMaxMem=!0,t.defaultFontSize=12,t.defaultFont="Arial",t.isAlpha=!1,t.isDepth=!1,t.isfailIfMajorPerformanceCaveat=!1,t.powerPreference="default",t.premultipliedAlpha=!0,t.isStencil=!0,t.preserveDrawingBuffer=!1,t.printWebglOrder=!1,t.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},t.fixedFrames=!0,t.destroyResourceImmediatelyDefault=!0,t.audioBufferCacheMaxSize=5242880;const s={};class r{static isZero(e){return Math.abs(e)<r.zeroTolerance}static nearEqual(e,t){return r.isZero(e-t)}static fastInvSqrt(e){return r.isZero(e)?e:1/Math.sqrt(e)}}r.zeroTolerance=1e-6,r.MaxValue=340282347e30,r.MinValue=-340282347e30,r.Deg2Rad=Math.PI/180;class i{constructor(e=0,t=0,s=0,r=0){this.x=e,this.y=t,this.z=s,this.w=r}setValue(e,t,s,r){return this.x=e,this.y=t,this.z=s,this.w=r,this}fromArray(e,t=0){return this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(e,t=0){return e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}cloneTo(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e}clone(){var e=new i;return this.cloneTo(e),e}static lerp(e,t,s,r){var i=e.x,a=e.y,n=e.z,o=e.w;r.x=i+s*(t.x-i),r.y=a+s*(t.y-a),r.z=n+s*(t.z-n),r.w=o+s*(t.w-o)}static transformByM4x4(e,t,s){var r=e.x,i=e.y,a=e.z,n=e.w,o=t.elements;s.x=r*o[0]+i*o[4]+a*o[8]+n*o[12],s.y=r*o[1]+i*o[5]+a*o[9]+n*o[13],s.z=r*o[2]+i*o[6]+a*o[10]+n*o[14],s.w=r*o[3]+i*o[7]+a*o[11]+n*o[15]}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)&&r.nearEqual(e.z,t.z)&&r.nearEqual(e.w,t.w)}equal(e){return i.equals(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var s=e.length();if(s>0){var r=1/s;t.x=e.x*r,t.y=e.y*r,t.z=e.z*r,t.w=e.w*r}}static add(e,t,s){s.x=e.x+t.x,s.y=e.y+t.y,s.z=e.z+t.z,s.w=e.w+t.w}static subtract(e,t,s){s.x=e.x-t.x,s.y=e.y-t.y,s.z=e.z-t.z,s.w=e.w-t.w}static multiply(e,t,s){s.x=e.x*t.x,s.y=e.y*t.y,s.z=e.z*t.z,s.w=e.w*t.w}static scale(e,t,s){s.x=e.x*t,s.y=e.y*t,s.z=e.z*t,s.w=e.w*t}static Clamp(e,t,s,r){var i=e.x,a=e.y,n=e.z,o=e.w,l=t.x,h=t.y,d=t.z,u=t.w,c=s.x,_=s.y,p=s.z,g=s.w;i=(i=i>c?c:i)<l?l:i,a=(a=a>_?_:a)<h?h:a,n=(n=n>p?p:n)<d?d:n,o=(o=o>g?g:o)<u?u:o,r.x=i,r.y=a,r.z=n,r.w=o}static distanceSquared(e,t){var s=e.x-t.x,r=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return s*s+r*r+i*i+a*a}static distance(e,t){var s=e.x-t.x,r=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return Math.sqrt(s*s+r*r+i*i+a*a)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,s){s.x=Math.min(e.x,t.x),s.y=Math.min(e.y,t.y),s.z=Math.min(e.z,t.z),s.w=Math.min(e.w,t.w)}static max(e,t,s){s.x=Math.max(e.x,t.x),s.y=Math.max(e.y,t.y),s.z=Math.max(e.z,t.z),s.w=Math.max(e.w,t.w)}}i.ZERO=new i,i.ONE=new i(1,1,1,1),i.UnitX=new i(1,0,0,0),i.UnitY=new i(0,1,0,0),i.UnitZ=new i(0,0,1,0),i.UnitW=new i(0,0,0,1),i.TEMP=new i(0,0,0,0);class a{static distanceSquared(e,t){var s=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return s*s+r*r+i*i}static distance(e,t){var s=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return Math.sqrt(s*s+r*r+i*i)}static min(e,t,s){s.x=Math.min(e.x,t.x),s.y=Math.min(e.y,t.y),s.z=Math.min(e.z,t.z)}static max(e,t,s){s.x=Math.max(e.x,t.x),s.y=Math.max(e.y,t.y),s.z=Math.max(e.z,t.z)}static transformQuat(e,t,s){var r=e.x,i=e.y,a=e.z,n=t.x,o=t.y,l=t.z,h=t.w,d=h*r+o*a-l*i,u=h*i+l*r-n*a,c=h*a+n*i-o*r,_=-n*r-o*i-l*a;s.x=d*h+_*-n+u*-l-c*-o,s.y=u*h+_*-o+c*-n-d*-l,s.z=c*h+_*-l+d*-o-u*-n}static scalarLength(e){var t=e.x,s=e.y,r=e.z;return Math.sqrt(t*t+s*s+r*r)}static scalarLengthSquared(e){var t=e.x,s=e.y,r=e.z;return t*t+s*s+r*r}static normalize(e,t){var s=e.x,r=e.y,i=e.z,a=s*s+r*r+i*i;a>0&&(a=1/Math.sqrt(a),t.x=s*a,t.y=r*a,t.z=i*a)}static multiply(e,t,s){s.x=e.x*t.x,s.y=e.y*t.y,s.z=e.z*t.z}static scale(e,t,s){s.x=e.x*t,s.y=e.y*t,s.z=e.z*t}static lerp(e,t,s,r){var i=e.x,a=e.y,n=e.z;r.x=i+s*(t.x-i),r.y=a+s*(t.y-a),r.z=n+s*(t.z-n)}static transformV3ToV3(e,t,s){a.transformV3ToV4(e,t,n),s.x=n.x,s.y=n.y,s.z=n.z}static transformV3ToV4(e,t,s){var r=e.x,i=e.y,a=e.z,n=t.elements;s.x=r*n[0]+i*n[4]+a*n[8]+n[12],s.y=r*n[1]+i*n[5]+a*n[9]+n[13],s.z=r*n[2]+i*n[6]+a*n[10]+n[14],s.w=r*n[3]+i*n[7]+a*n[11]+n[15]}static TransformNormal(e,t,s){var r=e.x,i=e.y,a=e.z,n=t.elements;s.x=r*n[0]+i*n[4]+a*n[8],s.y=r*n[1]+i*n[5]+a*n[9],s.z=r*n[2]+i*n[6]+a*n[10]}static transformCoordinate(e,t,s){var r=e.x,i=e.y,a=e.z,n=t.elements,o=r*n[3]+i*n[7]+a*n[11]+n[15];s.x=(r*n[0]+i*n[4]+a*n[8]+n[12])/o,s.y=(r*n[1]+i*n[5]+a*n[9]+n[13])/o,s.z=(r*n[2]+i*n[6]+a*n[10]+n[14])/o}static Clamp(e,t,s,r){var i=e.x,a=e.y,n=e.z,o=t.x,l=t.y,h=t.z,d=s.x,u=s.y,c=s.z;i=(i=i>d?d:i)<o?o:i,a=(a=a>u?u:a)<l?l:a,n=(n=n>c?c:n)<h?h:n,r.x=i,r.y=a,r.z=n}static add(e,t,s){s.x=e.x+t.x,s.y=e.y+t.y,s.z=e.z+t.z}static subtract(e,t,s){s.x=e.x-t.x,s.y=e.y-t.y,s.z=e.z-t.z}static cross(e,t,s){var r=e.x,i=e.y,a=e.z,n=t.x,o=t.y,l=t.z;s.x=i*l-a*o,s.y=a*n-r*l,s.z=r*o-i*n}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)&&r.nearEqual(e.z,t.z)}constructor(e=0,t=0,s=0){this.x=e,this.y=t,this.z=s}equal(e){return a.equals(this,e)}setValue(e,t,s){return this.x=e,this.y=t,this.z=s,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}toArray(){return[this.x,this.y,this.z]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}vadd(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}scale(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}normalize(){let e=this.x,t=this.y,s=this.z;var r=e*e+t*t+s*s;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=s*r),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e,t){var s=this.x,r=this.y,i=this.z,a=e.x,n=e.y,o=e.z;return t.x=r*o-i*n,t.y=i*a-s*o,t.z=s*n-r*a,t}cloneTo(e){return e.x=this.x,e.y=this.y,e.z=this.z,e}clone(){var e=new a;return this.cloneTo(e),e}toDefault(){this.x=0,this.y=0,this.z=0}}a.ZERO=new a(0,0,0),a.ONE=new a(1,1,1),a.NegativeUnitX=new a(-1,0,0),a.UnitX=new a(1,0,0),a.UnitY=new a(0,1,0),a.UnitZ=new a(0,0,1),a.ForwardRH=new a(0,0,-1),a.ForwardLH=new a(0,0,1),a.Up=new a(0,1,0),a.TEMP=new a;const n=new i;class o{static setResolution(e,t){o.customResolution=!0,o._resoluWidth=e,o._resoluHeight=t}}o.enableDynamicBatch=!0,o.enableStaticBatch=!0,o.pixelRatio=1,o.customResolution=!1,o.defaultCacheRTMemory=256,o.defaultPhysicsMemory=16,o.enableMultiLight=!0,o.maxLightCount=32,o.lightClusterCount=new a(12,12,12),o.maxMorphTargetCount=32,o.useBVHCull=!1,o.BVH_max_SpatialCount=7,o.BVH_limit_size=32,o.BVH_Min_Build_nums=10,o._resoluWidth=-1,o._resoluHeight=-1,o.debugFrustumCulling=!1;class l{}l.Laya=null,l.Loader=null,l.InputManager=null,l.Scene3D=null,l.Laya3D=null,l.loader=null,l.timer=null,l.systemTimer=null,l.physicsTimer=null,l.stage=null;class h{static getPoolBySign(e){return h._poolDic[e]||(h._poolDic[e]=[])}static clearBySign(e){h._poolDic[e]&&(h._poolDic[e].length=0)}static recover(e,t){t[h.POOLSIGN]||(t[h.POOLSIGN]=!0,h.getPoolBySign(e).push(t))}static recoverByClass(e){if(e){var t=e.__className||e.constructor._$gid;t&&h.recover(t,e)}}static _getClassSign(e){var t=e.__className||e._$gid;return t||(e._$gid=t=h._CLSID+"",h._CLSID++),t}static createByClass(e){return h.getItemByClass(h._getClassSign(e),e)}static getItemByClass(e,t){let s,r=h.getPoolBySign(e);return s=r.length?r.pop():new t,s[h.POOLSIGN]=!1,s}static getItemByCreateFun(e,t,s=null){var r=h.getPoolBySign(e),i=r.length?r.pop():t.call(s);return i[h.POOLSIGN]=!1,i}static getItem(e){var t=h.getPoolBySign(e),s=t.length?t.pop():null;return s&&(s[h.POOLSIGN]=!1),s}static createPool(e,t,s){let r=new d;return r._ct=e,r._init=t,r._reset=s,r}static createPool2(e,t,s){let r=new d;return r._create=e,r._init=t,r._reset=s,r}}h._CLSID=0,h.POOLSIGN="__InPool",h._poolDic={};class d{constructor(){this.pool=[]}take(...e){let t;return t=this.pool.length>0?this.pool.pop():this._create?this._create():new this._ct,this._init&&this._init(t,...e),t}recover(e){if(Array.isArray(e)){for(let t=0,s=e.length;t<s;t++){let s=e[t];this._reset&&this._reset(s),this.pool.push(s)}e.length=0}else this._reset&&this._reset(e),this.pool.push(e)}}class u{constructor(e=0,t=0){this.x=e,this.y=t}static create(){return h.getItemByClass("Point",u)}setTo(e,t){return this.x=e,this.y=t,this}reset(){return this.x=this.y=0,this}recover(){h.recover("Point",this.reset())}distance(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}toString(){return this.x+","+this.y}normalize(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}copy(e){return this.setTo(e.x,e.y)}}u.TEMP=new u,u.EMPTY=new u;class c{static isMouseEvent(e){return _.has(e)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new u}setTo(e,t,s){return this.type=e,this.currentTarget=t,this.target=s,this}stopPropagation(){this._stopped=!0}preventDefault(){this._defaultPrevented=!0}get touches(){return this._touches}get altKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.altKey}get ctrlKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.ctrlKey}get shiftKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.shiftKey}get metaKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}c.EMPTY=new c,c.MOUSE_DOWN="mousedown",c.MOUSE_UP="mouseup",c.RIGHT_MOUSE_DOWN="rightmousedown",c.RIGHT_MOUSE_UP="rightmouseup",c.CLICK="click",c.RIGHT_CLICK="rightclick",c.MOUSE_MOVE="mousemove",c.MOUSE_OVER="mouseover",c.MOUSE_OUT="mouseout",c.MOUSE_WHEEL="mousewheel",c.ROLL_OVER="mouseover",c.ROLL_OUT="mouseout",c.DOUBLE_CLICK="doubleclick",c.MOUSE_DRAG="mousedrag",c.MOUSE_DRAG_END="mousedragend",c.DRAG_START="dragstart",c.DRAG_MOVE="dragmove",c.DRAG_END="dragend",c.DROP="drop",c.KEY_DOWN="keydown",c.KEY_PRESS="keypress",c.KEY_UP="keyup",c.CHANGE="change",c.CHANGED="changed",c.MOVED="moved",c.WILL_RESIZE="willResize",c.RESIZE="resize",c.ADDED="added",c.REMOVED="removed",c.DISPLAY="display",c.UNDISPLAY="undisplay",c.ERROR="error",c.COMPLETE="complete",c.LOADED="loaded",c.READY="ready",c.PROGRESS="progress",c.INPUT="input",c.RENDER="render",c.OPEN="open",c.MESSAGE="message",c.CLOSE="close",c.FRAME="enterframe",c.ENTER="enter",c.SELECT="select",c.BLUR="blur",c.FOCUS="focus",c.VISIBILITY_CHANGE="visibilitychange",c.ORIENTATION_CHANGE="orientationchange",c.FOCUS_CHANGE="focuschange",c.PLAYED="played",c.PAUSED="paused",c.STOPPED="stopped",c.START="start",c.END="end",c.LINK="link",c.LABEL="label",c.FULL_SCREEN_CHANGE="fullscreenchange",c.DEVICE_LOST="devicelost",c.TRANSFORM_CHANGED="transformchanged",c.LAYER_CHANGE="layerChange",c.STATIC_MASK="staticMask",c.TRIGGER_ENTER="triggerenter",c.TRIGGER_STAY="triggerstay",c.TRIGGER_EXIT="triggerexit",c.COLLISION_ENTER="collisionenter",c.COLLISION_STAY="collisionstay",c.COLLISION_EXIT="collisionexit",c.JOINT_BREAK="jointbreak",c.UPDATE_PHY_EVENT_FILTER="physics3dEventFilter";const _=new Set([c.MOUSE_DOWN,c.MOUSE_UP,c.MOUSE_MOVE,c.CLICK,c.DOUBLE_CLICK,c.RIGHT_CLICK,c.RIGHT_MOUSE_DOWN,c.RIGHT_MOUSE_UP,c.MOUSE_OVER,c.MOUSE_OUT,c.MOUSE_WHEEL,c.MOUSE_DRAG,c.MOUSE_DRAG_END]);class p{}var g;p.version="3.3.5",p.isPlaying=!0,p.isPreview=!1,p.isConch=!!window&&null!=window.conch,p.isEditor=!1,e.StatElement=void 0,(g=e.StatElement||(e.StatElement={}))[g.CT_FPS=0]="CT_FPS",g[g.T_Frame_Time=1]="T_Frame_Time",g[g.T_AllRender3D=2]="T_AllRender3D",g[g.T_DepthPass=3]="T_DepthPass",g[g.T_ShadowPass=4]="T_ShadowPass",g[g.T_3DMainPass=5]="T_3DMainPass",g[g.T_3DContextPre=6]="T_3DContextPre",g[g.T_3DContextRender=7]="T_3DContextRender",g[g.T_3DMainPass_Opaque=8]="T_3DMainPass_Opaque",g[g.T_3DMainPass_Trans=9]="T_3DMainPass_Trans",g[g.T_3DBatchTime=10]="T_3DBatchTime",g[g.T_CullMain=11]="T_CullMain",g[g.T_CullShadow=12]="T_CullShadow",g[g.T_Render_PostProcess=13]="T_Render_PostProcess",g[g.T_AllRender2D=14]="T_AllRender2D",g[g.T_2DPass=15]="T_2DPass",g[g.T_2DContextPre=16]="T_2DContextPre",g[g.T_2DContextRender=17]="T_2DContextRender",g[g.T_ScriptUpdateTime=18]="T_ScriptUpdateTime",g[g.T_ScriptLateUpdateTime=19]="T_ScriptLateUpdateTime",g[g.CT_OpaqueDrawCall=20]="CT_OpaqueDrawCall",g[g.CT_TransDrawCall=21]="CT_TransDrawCall",g[g.CT_DepthCastDrawCall=22]="CT_DepthCastDrawCall",g[g.CT_ShadowDrawCall=23]="CT_ShadowDrawCall",g[g.CT_2DDrawCall=24]="CT_2DDrawCall",g[g.CT_3DDrawCall=25]="CT_3DDrawCall",g[g.CT_DrawCall=26]="CT_DrawCall",g[g.CT_IndirectDrawCall=27]="CT_IndirectDrawCall",g[g.CT_Instancing_DrawCall=28]="CT_Instancing_DrawCall",g[g.M_GPUBuffer=29]="M_GPUBuffer",g[g.C_GPUBuffer=30]="C_GPUBuffer",g[g.M_VertexBuffer=31]="M_VertexBuffer",g[g.C_VertexBuffer=32]="C_VertexBuffer",g[g.M_IndexBuffer=33]="M_IndexBuffer",g[g.C_IndexBuffer=34]="C_IndexBuffer",g[g.M_UBOBuffer=35]="M_UBOBuffer",g[g.C_UBOBuffer=36]="C_UBOBuffer",g[g.M_DeviceBuffer=37]="M_DeviceBuffer",g[g.C_DeviceBuffer=38]="C_DeviceBuffer",g[g.M_AllTexture=39]="M_AllTexture",g[g.C_AllTexture=40]="C_AllTexture",g[g.M_Texture2D=41]="M_Texture2D",g[g.C_Texture2D=42]="C_Texture2D",g[g.M_TextureCube=43]="M_TextureCube",g[g.C_TextureCube=44]="C_TextureCube",g[g.M_Texture3D=45]="M_Texture3D",g[g.C_Texture3D=46]="C_Texture3D",g[g.M_Texture2DArray=47]="M_Texture2DArray",g[g.C_Texture2DArray=48]="C_Texture2DArray",g[g.M_RenderTexture=49]="M_RenderTexture",g[g.C_RenderTexture=50]="C_RenderTexture",g[g.M_GPUMemory=51]="M_GPUMemory",g[g.CT_ShaderChange=52]="CT_ShaderChange",g[g.CT_Triangle=53]="CT_Triangle",g[g.CT_BufferUploadCount=54]="CT_BufferUploadCount",g[g.CT_GeometryBufferUploadCount=55]="CT_GeometryBufferUploadCount",g[g.CT_UBOBufferUploadCount=56]="CT_UBOBufferUploadCount",g[g.CT_UBOBufferUploadMemory=57]="CT_UBOBufferUploadMemory",g[g.C_Sprite2DCount=58]="C_Sprite2DCount",g[g.C_Sprite3DCount=59]="C_Sprite3DCount",g[g.C_BaseRenderCount=60]="C_BaseRenderCount",g[g.C_MeshRenderCount=61]="C_MeshRenderCount",g[g.C_SkinnedMeshRenderCount=62]="C_SkinnedMeshRenderCount",g[g.C_ShurikenParticleRenderCount=63]="C_ShurikenParticleRenderCount",g[g.T_AnimatorUpdate=64]="T_AnimatorUpdate",g[g.T_SkinBoneUpdate=65]="T_SkinBoneUpdate",g[g.T_ShurikenUpdate=66]="T_ShurikenUpdate",g[g.T_Physics_Simulation=67]="T_Physics_Simulation",g[g.T_Physics_UpdateNode=68]="T_Physics_UpdateNode",g[g.T_PhysicsEvent=69]="T_PhysicsEvent",g[g.C_PhysicsEventCount=70]="C_PhysicsEventCount",g[g.T_PhysicsCollider=71]="T_PhysicsCollider",g[g.T_PhysicsTrigger=72]="T_PhysicsTrigger",g[g.T_PhysicsColliderEnter=73]="T_PhysicsColliderEnter",g[g.T_PhysicsColliderExit=74]="T_PhysicsColliderExit",g[g.T_PhysicsColliderStay=75]="T_PhysicsColliderStay",g[g.T_PhysicsTriggerEnter=76]="T_PhysicsTriggerEnter",g[g.T_PhysicsTriggerExit=77]="T_PhysicsTriggerExit",g[g.T_PhysicsTriggerStay=78]="T_PhysicsTriggerStay",g[g.C_PhysicaDynamicRigidBody=79]="C_PhysicaDynamicRigidBody",g[g.C_PhysicaStaticRigidBody=80]="C_PhysicaStaticRigidBody",g[g.C_PhysicaKinematicRigidBody=81]="C_PhysicaKinematicRigidBody",g[g.C_PhysicaCharacterController=82]="C_PhysicaCharacterController",g[g.C_PhysicsJoint=83]="C_PhysicsJoint",g[g.T_LoadResourceTime=84]="T_LoadResourceTime",g[g.C_LoadResourceCount=85]="C_LoadResourceCount",g[g.C_LoadRequestCount=86]="C_LoadRequestCount",g[g.T_LoadRequestTime=87]="T_LoadRequestTime",g[g.StatEnd=88]="StatEnd";class m{constructor(){this._tQueue=new Set,this._ctQueue=new Set,this._cacheCount=0,this._cacheTime=0,this._cacheTime=performance.now(),this._createStatBuffer();for(let t=0;t<e.StatElement.StatEnd;t++){const s=e.StatElement[t];s&&(s.startsWith("T_")&&this._tQueue.add(t),s.startsWith("CT_")&&this._ctQueue.add(t))}}_createStatBuffer(){this._statArray=new Float32Array(e.StatElement.StatEnd),this._timeArray=new Float32Array(e.StatElement.StatEnd)}cloneTo(t){for(let s=0;s<e.StatElement.StatEnd;s++){const r=e.StatElement[s];r&&(r.startsWith("C_")?t.recordCountData(s,this._statArray[s]):r.startsWith("M_")&&t.recordMemoryData(s,1024*this._statArray[s]*1024))}}recordCountData(e,t){this._statArray[e]+=t}recordTimeData(e,t){this._timeArray[e]+=t}recordCTData(e,t){this._timeArray[e]+=t}recordMemoryData(e,t){this._statArray[e]+=t/1024/1024}getElementData(e){return this._statArray[e]}startFrameLogic(){}endFrameLogic(t){this._cacheCount++;let s=t-this._cacheTime;if(s<1e3)return;let r=Math.round(1e3*this._cacheCount)/s;for(let e of this._tQueue)this._statArray[e]=this._timeArray[e]/this._cacheCount,this._timeArray[e]=0;for(let e of this._ctQueue)this._statArray[e]=this._timeArray[e]/this._cacheCount,this._timeArray[e]=0;this._statArray[e.StatElement.CT_FPS]=Math.round(r),this._statArray[e.StatElement.T_Frame_Time]=r>0?Math.floor(1e3/r):0,this._cacheTime=t,this._cacheCount=0}}class f{}f.statAgent=new m;const T={purple:8388736,orange:16753920,white:16777215,red:16711680,green:65280,blue:255,black:0,yellow:16776960,gray:8421504};class y{static hexToString(e){return x.parse(e),x.toString()}static stringToHex(e){return x.parse(e),x.getRGB()}static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}constructor(e=1,t=1,s=1,r=1){this.r=e,this.g=t,this.b=s,this.a=r}equal(e){if(!e)return!1;const t=(e,t)=>{var s=1e-5;return-s<e-t&&e-t<s};return t(e.r,this.r)&&t(e.g,this.g)&&t(e.b,this.b)&&t(e.a,this.a)}parse(e){if(null==e&&(e=0),"number"==typeof e)(e<0||isNaN(e))&&(e=0),this.setRGB(e);else if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){let t=e.indexOf("("),s=e.indexOf(")");if(-1==t||-1==s)return this.setValue(0,0,0,1),this;let r=(e=e.substring(t+1,s)).split(","),i=r.length;for(let e=0;e<i;e++)r[e]=parseFloat(r[e]),isNaN(r[e])&&(r[e]=0);this.r=r[0]/255,this.g=r[1]/255,this.b=r[2]/255,4==r.length?this.a=r[3]:this.a=1}else{if("#"===e.charAt(0))e=e.substring(1);else{let t=T[e];if(t)return this.setRGB(t),this}let t,s=e.length;if(3===s||4===s){let t="";for(let r=0;r<s;r++)t+=e[r]+e[r];e=t}let r=1;8==s?(t=parseInt(e.substring(0,6),16),r=parseInt(e.substring(6,8),16)/255):(t=parseInt(e,16),r=1),this.setRGB(t),this.a=r}return this}toLinear(e){e.r=y.gammaToLinearSpace(this.r),e.g=y.gammaToLinearSpace(this.g),e.b=y.gammaToLinearSpace(this.b),e.a=this.a}toGamma(e){e.r=y.linearToGammaSpace(this.r),e.g=y.linearToGammaSpace(this.g),e.b=y.linearToGammaSpace(this.b),e.a=this.a}cloneTo(e){e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a}scale(e){return this.r=this.r*e,this.g=this.g*e,this.b=this.b*e,this}setValue(e,t,s,r){return this.r=e,this.g=t,this.b=s,this.a=r,this}fromArray(e,t=0){this.r=e[t+0],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3]}toArray(){return[this.r,this.g,this.b,this.a]}writeTo(e,t=0){e[t+0]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a}clone(){var e=new y;return this.cloneTo(e),e}getRGB(){return(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)}setRGB(e){this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this.a=1}getARGB(){return(Math.round(255*this.a)<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)}getABGR(){return(Math.round(255*this.a)<<24)+(Math.round(255*this.b)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.r)}setABGR(e){this.a=(e>>24&255)/255,this.b=(e>>16&255)/255,this.g=(e>>8&255)/255,this.r=(255&e)/255}toString(){let e=this.getRGB().toString(16);for(;e.length<6;)e="0"+e;return"#"+e}getStyleString(){return 1==this.a?this.toString():"rgba("+Math.round(255*this.r)+","+Math.round(255*this.g)+","+Math.round(255*this.b)+","+this.a+")"}}y.RED=new y(1,0,0,1),y.GREEN=new y(0,1,0,1),y.BLUE=new y(0,0,1,1),y.CYAN=new y(0,1,1,1),y.YELLOW=new y(1,.92,.016,1),y.MAGENTA=new y(1,0,1,1),y.GRAY=new y(.5,.5,.5,1),y.WHITE=new y(1,1,1,1),y.BLACK=new y(0,0,0,1),y.CLEAR=new y(0,0,0,0);const x=new y;var S,E,v,D,w;function b(t){switch(t){case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return e.RenderCapable.COMPRESS_TEXTURE_ASTC;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return e.RenderCapable.COMPRESS_TEXTURE_S3TC;case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:return e.RenderCapable.COMPRESS_TEXTURE_PVRTC;case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.ETC2RGB_Alpha1:case e.TextureFormat.ETC2SRGB_Alpha1:return e.RenderCapable.COMPRESS_TEXTURE_ETC;case e.TextureFormat.ETC1RGB:return e.RenderCapable.COMPRESS_TEXTURE_ETC1;default:return null}}e.RenderTargetFormat=void 0,(S=e.RenderTargetFormat||(e.RenderTargetFormat={}))[S.None=-1]="None",S[S.R8G8B8=0]="R8G8B8",S[S.R8G8B8A8=1]="R8G8B8A8",S[S.R16G16B16A16=17]="R16G16B16A16",S[S.R32G32B32=30]="R32G32B32",S[S.R32G32B32A32=15]="R32G32B32A32",S[S.R16G16B16=31]="R16G16B16",S[S.DEPTH_16=35]="DEPTH_16",S[S.STENCIL_8=36]="STENCIL_8",S[S.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",S[S.DEPTH_32=38]="DEPTH_32",S[S.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus",e.TextureDimension=void 0,(E=e.TextureDimension||(e.TextureDimension={}))[E.Tex2D=0]="Tex2D",E[E.Cube=1]="Cube",E[E.Tex3D=2]="Tex3D",E[E.Texture2DArray=3]="Texture2DArray",E[E.CubeArray=4]="CubeArray",E[E.Unkonw=5]="Unkonw",E[E.None=6]="None",e.HDREncodeFormat=void 0,(v=e.HDREncodeFormat||(e.HDREncodeFormat={}))[v.NONE=0]="NONE",v[v.RGBM=1]="RGBM",v[v.RGBD=2]="RGBD",e.RenderCapable=void 0,(D=e.RenderCapable||(e.RenderCapable={}))[D.Element_Index_Uint32=0]="Element_Index_Uint32",D[D.Element_Index_Uint8=1]="Element_Index_Uint8",D[D.TextureFormat_R32G32B32A32=2]="TextureFormat_R32G32B32A32",D[D.TextureFormat_R16G16B16A16=3]="TextureFormat_R16G16B16A16",D[D.Texture_anisotropic=4]="Texture_anisotropic",D[D.RenderTextureFormat_R16G16B16A16=5]="RenderTextureFormat_R16G16B16A16",D[D.RenderTextureFormat_R32G32B32A32=6]="RenderTextureFormat_R32G32B32A32",D[D.RenderTextureFormat_Depth=7]="RenderTextureFormat_Depth",D[D.RenderTextureFormat_ShadowMap=8]="RenderTextureFormat_ShadowMap",D[D.Vertex_VAO=9]="Vertex_VAO",D[D.DrawElement_Instance=10]="DrawElement_Instance",D[D.Shader_TextureLod=11]="Shader_TextureLod",D[D.COMPRESS_TEXTURE_S3TC=12]="COMPRESS_TEXTURE_S3TC",D[D.COMPRESS_TEXTURE_S3TC_SRGB=13]="COMPRESS_TEXTURE_S3TC_SRGB",D[D.COMPRESS_TEXTURE_PVRTC=14]="COMPRESS_TEXTURE_PVRTC",D[D.COMPRESS_TEXTURE_ETC1=15]="COMPRESS_TEXTURE_ETC1",D[D.COMPRESS_TEXTURE_ETC=16]="COMPRESS_TEXTURE_ETC",D[D.COMPRESS_TEXTURE_ASTC=17]="COMPRESS_TEXTURE_ASTC",D[D.Texture_SRGB=18]="Texture_SRGB",D[D.MSAA=19]="MSAA",D[D.UnifromBufferObject=20]="UnifromBufferObject",D[D.Texture3D=21]="Texture3D",D[D.Texture_FloatLinearFiltering=22]="Texture_FloatLinearFiltering",D[D.Texture_HalfFloatLinearFiltering=23]="Texture_HalfFloatLinearFiltering",D[D.StorageBuffer=24]="StorageBuffer",D[D.ComputeShader=25]="ComputeShader",D[D.IndirectDraw=26]="IndirectDraw",e.TextureFormat=void 0,(w=e.TextureFormat||(e.TextureFormat={}))[w.R8G8B8=0]="R8G8B8",w[w.R8G8B8A8=1]="R8G8B8A8",w[w.R5G6B5=16]="R5G6B5",w[w.Alpha8=2]="Alpha8",w[w.DXT1=3]="DXT1",w[w.DXT3=29]="DXT3",w[w.DXT5=4]="DXT5",w[w.ETC1RGB=5]="ETC1RGB",w[w.ETC2RGB=6]="ETC2RGB",w[w.ETC2RGBA=7]="ETC2RGBA",w[w.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",w[w.ETC2SRGB=28]="ETC2SRGB",w[w.ETC2RGB_Alpha1=32]="ETC2RGB_Alpha1",w[w.ETC2SRGB_Alpha1=33]="ETC2SRGB_Alpha1",w[w.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",w[w.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",w[w.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",w[w.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",w[w.R32G32B32A32=15]="R32G32B32A32",w[w.R32G32B32=30]="R32G32B32",w[w.R16G16B16A16=17]="R16G16B16A16",w[w.R16G16B16=31]="R16G16B16",w[w.ASTC4x4=18]="ASTC4x4",w[w.ASTC4x4SRGB=23]="ASTC4x4SRGB",w[w.ASTC6x6=19]="ASTC6x6",w[w.ASTC6x6SRGB=24]="ASTC6x6SRGB",w[w.ASTC8x8=20]="ASTC8x8",w[w.ASTC8x8SRGB=25]="ASTC8x8SRGB",w[w.ASTC10x10=21]="ASTC10x10",w[w.ASTC10x10SRGB=26]="ASTC10x10SRGB",w[w.ASTC12x12=22]="ASTC12x12",w[w.ASTC12x12SRGB=27]="ASTC12x12SRGB",w[w.KTXTEXTURE=-1]="KTXTEXTURE",w[w.PVRTEXTURE=-2]="PVRTEXTURE";class C extends Error{constructor(){super("Not implemented.")}}class R extends Error{constructor(e){super(`Index out of range: ${e}`)}}class M extends Error{constructor(){super("readable flag need to be true.")}}function A(e){if(null!=e&&"object"==typeof e){let t;for(let s in P)if(t=e[P[s]],null!=t)return I(t)}return I(e)}function I(e){return"number"==typeof e?`error code=${e}`:"string"!=typeof e?"error! "+e:e}const P=["errMsg","errorMessage","message","reason","error","errCode","statusCode"];class B{constructor(){this._flag=0,this._items=[]}add(e,t,s){t=t||null;let r=this._items,i=r.findIndex((s,r,i)=>s===e&&i[r+1]===t);-1!=i?(r[i+2]=s,r[i+3]=1):r.push(e,t,s,1)}once(e,t,s){t=t||null;let r=this._items,i=r.findIndex((s,r,i)=>s===e&&i[r+1]===t);-1!=i?(r[i+2]=s,r[i+3]=2):r.push(e,t,s,2)}remove(e,t){t=t||null;let s=this._items,r=s.findIndex((s,r,i)=>s===e&&i[r+1]===t);-1!=r&&(0!=this._flag?(s[r+3]=0,this._flag=2):s.splice(r,4))}clear(){let e=this._items;0!=this._flag?(e.forEach((e,t,s)=>{t%4==3&&(s[t]=0)}),this._flag=2):e.length=0}clearForTarget(e){if(!e)return;let t=this._items;if(0!=this._flag)t.forEach((t,s,r)=>{s%4==1&&r[s]===e&&(r[s+2]=0)}),this._flag=2;else{let s=t.length-4;for(;s>=0;)t[s+1]===e&&t.splice(s,4),s-=4}}get count(){return this._items.length/4}invoke(...e){if(0!=this._flag)return;this._flag=1;let t=this._items,s=t.length;for(let r=0;r<s;r+=4){if(0===t[r+3])continue;let s=t[r+2];try{null!=s?t[r].call(t[r+1],...s,...e):t[r].call(t[r+1],...e)}catch(e){console.error(e)}2===t[r+3]&&(t[r+3]=0,this._flag=2)}if(2===this._flag){let e=t.length,s=0;for(;s<e;)0!==t[s+3]?s+=4:(t.splice(s,4),e-=4)}this._flag=0}}const L=[];class N{onStartListeningToType(e){}hasListener(e){let t=this._events&&this._events[e];return!!t&&t.count>0}event(e,t){let s=this._events&&this._events[e];if(!s)return!1;let r=s.count>0;if(Array.isArray(t))s.invoke(...t);else if(void 0!==t)s.invoke(t);else if(t===c.EMPTY){let t=L.length>0?L.pop():new c;s.invoke(t.setTo(e,this,this)),t.target=t.currentTarget=null,L.push(t)}else s.invoke();return r}on(e,t,s,r){2==arguments.length&&(s=t,t=null),this._events||(this._events={});let i=this._events[e];return i||(this.onStartListeningToType(e),this._events[e]=i=new B),i.add(s,t,r),this}once(e,t,s,r){2==arguments.length&&(s=t,t=null),this._events||(this._events={});let i=this._events[e];return i||(this.onStartListeningToType(e),this._events[e]=i=new B),i.once(s,t,r),this}off(e,t,s){2==arguments.length&&(s=t,t=null);let r=this._events&&this._events[e];return r&&r.remove(s,t),this}offAll(e){if(!this._events)return this;if(null==e)for(let e in this._events)this._events[e].clear();else{let t=this._events[e];t&&t.clear()}return this}offAllCaller(e){if(e&&this._events)for(let t in this._events)this._events[t].clearForTarget(e);return this}}var F,O=0,U=0,k=0;class V extends N{static get cpuMemory(){return V._cpuMemory}static get gpuMemory(){return V._gpuMemory}static _addCPUMemory(e){V._cpuMemory+=e}static _addGPUMemory(e){V._gpuMemory+=e}static _addMemory(e,t){V._cpuMemory+=e,V._gpuMemory+=t}static destroyUnusedResources(){U=0,k=0,l.loader.loading?l.timer.frameLoop(1,V,V._destroyUnusedResources):V._destroyUnusedResources(!0)}static _destroyUnusedResources(e){if(!e&&l.loader.loading)return;l.timer.clear(V,V._destroyUnusedResources);let t=0;for(let e in V._idResourcesMap){let s=V._idResourcesMap[e];s.lock||0!==s._referenceCount||(s.destroy(),t++)}V.DEBUG&&t>0&&console.debug(`destroyUnusedResources(${t})`),t>0&&k<5&&(k++,l.timer.frameLoop(1,V,V._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute!=e&&(this._obsolute=e,e&&!p.isPlaying&&this.event("obsolute"))}get deps(){return this._deps}get referenceCount(){return this._referenceCount}constructor(e){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++O,this._destroyed=!1,this._referenceCount=0,(null==e||e)&&(V._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0,this._deps=[],this._traceDeps=!1}_setCPUMemory(e){var t=e-this._cpuMemory;this._cpuMemory=e,V._addCPUMemory(t)}_setGPUMemory(e){var t=e-this._gpuMemory;this._gpuMemory=e,V._addGPUMemory(t)}_setCreateURL(e,t){this.url=e,this.uuid=t}isCreateFromURL(e){return this.uuid&&e.length===this.uuid.length+6&&e.endsWith(this.uuid)||this.url===e}_addReference(e=1){this._referenceCount+=e}_removeReference(e=1){this._referenceCount-=e,U>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}addDep(e){e instanceof V&&(e._addReference(),this._deps.push(e),!p.isPlaying&&e._traceDeps&&e.on("obsolute",this,this.onDepObsolute))}addDeps(e){for(let t of e)t instanceof V&&(t._addReference(),this._deps.push(t),!p.isPlaying&&t._traceDeps&&t.on("obsolute",this,this.onDepObsolute))}onDepObsolute(){this.obsolute=!0}_disposeResource(){}destroy(){if(!this._destroyed){this._destroyed=!0,this.lock=!1,U++,this._disposeResource();for(let e of this._deps)e._removeReference(),!p.isPlaying&&e._traceDeps&&e.off("obsolute",this,this.onDepObsolute);U--,this.offAll(),delete V._idResourcesMap[this.id],this.url&&(V.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),l.loader.clearRes(this.url,this))}}}V._idResourcesMap={},V._cpuMemory=0,V._gpuMemory=0,V.DEBUG=!1;class G extends V{get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(e){this._texture.anisoLevel=e}get filterMode(){return this._texture.filterMode}set filterMode(e){this._texture.filterMode=e}get wrapModeU(){return this._texture.wrapU}set wrapModeU(e){this._texture.wrapU=e}get wrapModeV(){return this._texture.wrapV}set wrapModeV(e){this._texture.wrapV=e}get wrapModeW(){return this._texture.wrapW}set wrapModeW(e){this._texture.wrapW=e}get compareMode(){return this._texture.compareMode}set compareMode(e){this._texture.compareMode=f.textureContext.setTextureCompareMode(this._texture,e)}get gammaCorrection(){return this._texture.gammaCorrection}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set baseMipmapLevel(e){this._texture.baseMipmapLevel=e}get maxMipmapLevel(){return this._texture.maxMipmapLevel}set maxMipmapLevel(e){this._texture.maxMipmapLevel=e}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(s,r,i){super(),this._gammaSpace=!1,this._width=s,this._height=r,this._format=i,this.destroyedImmediately=t.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=e.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:case e.TextureFormat.R16G16B16:case e.TextureFormat.R16G16B16A16:case e.TextureFormat.R32G32B32:case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return!1;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.ETC2RGB_Alpha1:case e.TextureFormat.ETC2SRGB_Alpha1:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R16G16B16A16:return 2;case e.TextureFormat.R32G32B32A32:return 4;default:throw new Error("unknown format.")}}_getSource(){return this._texture.resource}get defaultTexture(){throw new C}_disposeResource(){this._texture&&this._texture.dispose()}}e.DepthTextureMode=void 0,(F=e.DepthTextureMode||(e.DepthTextureMode={}))[F.None=0]="None",F[F.Depth=1]="Depth",F[F.DepthNormals=2]="DepthNormals",F[F.DepthAndDepthNormals=3]="DepthAndDepthNormals",F[F.MotionVectors=4]="MotionVectors";class z extends G{static createFromPool(e,t,s,r,i=!1,a=1,n=!1,o=!1,l=!1){i=i&&!(e&e-1)&&!(t&t-1);let h=z._pool.length;for(let d=0;d<h;d++){let u=z._pool[d];if(u.width==e&&u.height==t&&u.colorFormat==s&&u.depthStencilFormat==r&&u._generateMipmap==i&&u.multiSamples==a&&u.generateDepthTexture==n&&u._gammaSpace==o&&u._storage==l){u._inPool=!1;let e=z._pool[h-1];return z._pool[d]=e,z._pool.length-=1,z._poolMemory-=u._renderTarget.gpuMemory/1024/1024,u}}let d=new z(e,t,s,r,i,a,n,o,l);return d.lock=!0,d}static recoverToPool(e){e._inPool||e.destroyed||(z._pool.push(e),z._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0)}static clearPool(){if(!(z._poolMemory<o.defaultCacheRTMemory)){for(var e in z._pool)z._pool[e].destroy();z._pool=[],z._poolMemory=0}}static get bindCanvasRender(){return z._bindCanvasRender}static set bindCanvasRender(e){e!=this._bindCanvasRender&&(this._bindCanvasRender=e)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(t){this.depthStencilFormat!=e.RenderTargetFormat.None?(t&&!this._depthStencilTexture&&(this._depthStencilTexture=new G(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=e.TextureDimension.Tex2D,this._depthStencilTexture._texture=f.textureContext.createRenderTargetDepthTexture(this._renderTarget,e.TextureDimension.Tex2D,this.width,this.height)),this._generateDepthTexture=t):this._generateDepthTexture=!1}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(t,s,r,i,a=!1,n=1,o=!1,l=!1,h=!1){super(t,s,r),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._storage=!1,this._gammaSpace=l,this._depthStencilFormat=null==i?e.RenderTargetFormat.None:i,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=o,this._storage=h,this._createRenderTarget()}_createRenderTarget(){this._dimension=e.TextureDimension.Tex2D,this._renderTarget=f.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples,this._storage),this._generateMipmap=this._renderTarget._generateMipmap,this._renderTarget._texturesResolve?this._texture=this._renderTarget._texturesResolve[0]:this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(t,s,r,i,a=!1,n=1,o=!1,l=!1,h=!1){this._width=t,this._height=s,this._format=r,this._gammaSpace=l,this._depthStencilFormat=null==i?e.RenderTargetFormat.None:i,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=o,this._storage=h,this._disposeResource(),this._createRenderTarget()}getData(e,t,s,r,i){return f.textureContext.readRenderTargetPixelData(this._renderTarget,e,t,s,r,i),i}getDataAsync(e,t,s,r,i){return f.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,e,t,s,r,i)}_disposeResource(){var e;this._renderTarget.dispose(),this._renderTarget=null,null===(e=this._depthStencilTexture)||void 0===e||e.destroy(),this._depthStencilTexture=null}}z._pool=[],z._poolMemory=0;const H=["browser","fs","storage","font","textInput","media","device"];class W{static __init__(){for(let e of H){let t=W._classes[e];t&&(W[e]=new t)}}static register(e,t){p.isPlaying&&(W._classes[e]=t)}static warnIncompatibility(e){X.has(e)||(X.add(e),console.warn(`${e} is not supported in this platform.`))}static hasAPI(e,t){let s=t&&e||W.g,r=t||e;return s.willGenerateUndefinedAPIs?null!=Object.getOwnPropertyDescriptor(s,r):null!=s[r]}}W.g=null,W._classes={};const X=new Set;class Y{static createElement(e){return W.browser.createElement(e)}static getElementById(e){return Y.document.getElementById(e)}static removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}static now(){return performance.now()}static get clientWidth(){return null!=this._clientWidth?this._clientWidth:W.browser.getClientWidth()}static set clientWidth(e){Y._clientWidth=e}static get clientHeight(){return null!=this._clientHeight?this._clientHeight:W.browser.getClientHeight()}static set clientHeight(e){Y._clientHeight=e}static get width(){return(l.stage&&l.stage.canvasRotation?Y.clientHeight:Y.clientWidth)*Y.pixelRatio}static get height(){return(l.stage&&l.stage.canvasRotation?Y.clientWidth:Y.clientHeight)*Y.pixelRatio}static get pixelRatio(){return W.browser.getPixelRatio()}static get container(){return Y.mainCanvas.source.parentElement||document.body}static getQueryString(e){if(!Y.window.location||!Y.window.location.search)return null;let t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),s=Y.window.location.search.substring(1).match(t);return null!=s?unescape(s[2]):null}static loadLib(e,t){return new Promise((s,r)=>{let i=document.createElement("script");i.onload=function(){s()},i.onerror=function(){r(`load ${e} failed`)},null!=t&&(i.async=t),i.src=ee.postFormatURL(ee.formatURL(e)),Y.document.body.appendChild(i)})}}Y.platform=0,Y.platformName="",Y.PLATFORM_PC=0,Y.PLATFORM_ANDROID=1,Y.PLATFORM_IOS=2,Y.isDomSupported=!0,Y.systemVersion="",Y.SDKVersion="",Y.bundles=new Map,Y.window=void 0!==typeof window?window:null,Y.document=void 0!==typeof document?document:null;let q=window;q.__getBundle_=function(e){let t=Y.bundles.get(e);return t||Y.bundles.set(e,t={}),t},q.__setBundle_=function(e,t,s){let r=Y.bundles.get(e);r&&function(e,t,s){var r;if(t&&"object"==typeof t||"function"==typeof t)for(let i of Object.getOwnPropertyNames(t))e.hasOwnProperty(i)||i===s||Object.defineProperty(e,i,{get:()=>t[i],enumerable:!(r=Object.getOwnPropertyDescriptor(t,i))||r.enumerable})}(r,t,"default"),Y.bundles.set(e,t),s&&(q[s]=t)};var j=1;const K=180/Math.PI,$=Math.PI/180;class Q{static toRadian(e){return e*$}static toAngle(e){return e*K}static toHexColor(e){return y.hexToString(e)}static fromStringColor(e){return y.stringToHex(e)}static getGID(e,t){return(e?e[Z]||(e[Z]=j++):0)+"_"+(t?"string"==typeof t?t:t[Z]||(t[Z]=j++):0)}static copyArray(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var s=t.length;for(let r=0;r<s;r++)e[r]=t[r];return e}static parseInt(e,t=0){var s=parseInt(e,t);return isNaN(s)?0:s}static getBaseName(e,t){let s=e.lastIndexOf("/");return-1!=s&&(e=e.substring(s+1)),s=e.indexOf("?"),-1!=s&&(e=e.substring(0,s)),t&&(s=e.lastIndexOf("."),-1!=s&&(e=e.substring(0,s))),e}static getFileExtension(e){let t=e.lastIndexOf(".");if(-1!=t){let s=e.substring(t+1).toLowerCase(),r=s.indexOf("?");if(-1!=r&&(s=s.substring(0,r)),"ls"===s){let r=e.lastIndexOf(".",t-1);if(-1!=r){let i=e.substring(r+1,t+1)+s;if("lanit.ls"===i||"ltcb.ls"===i)return i}}return s}return""}static replaceFileExtension(e,t,s){if(!e)return e;let r=e.lastIndexOf(".");if(t.length>0&&!s&&(t="."+t),-1!=r){let s=e.indexOf("?",r);return-1!=s?e.substring(0,r)+t+e.substring(s):e.substring(0,r)+t}return e+t}static isUUID(e){return e&&e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)}static uint8ArrayToArrayBuffer(t){let s;const r=t.width,i=t.height,a=r*i*4,n=t instanceof z?t.colorFormat:t.getColorFormat();switch(n){case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:s=new Uint8Array(a);break;case e.RenderTargetFormat.R16G16B16A16:s=new Float32Array(a);break;default:throw new Error("uint8ArrayToArrayBuffer is not supported for "+t.format.toString()+"format")}if(f.textureContext.readRenderTargetPixelData(t._renderTarget,0,0,r,i,s),n===e.RenderTargetFormat.R16G16B16A16){const e=s,t=new Uint8Array(a);for(let s=0,r=e.length;s<r;s++)t[s]=Math.min(Math.floor(255*e[s]),255);s=t}const o=s,l=Y.createElement("canvas");l.height=i,l.width=r;const h=l.getContext("2d"),d=h.createImageData(r,i);d.data.set(new Uint8ClampedArray(o)),h.putImageData(d,0,0);const u=l.toDataURL();return l.remove(),u}static uint8ArrayToArrayBufferAsync(t){let s;const r=t.width,i=t.height,a=r*i*4,n=t instanceof z?t.colorFormat:t.getColorFormat();switch(n){case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:s=new Uint8Array(a);break;case e.RenderTargetFormat.R16G16B16A16:s=new Float32Array(a);break;default:throw"this function is not supported "+t.format.toString()+"format Material"}return t.getDataAsync(0,0,r,i,s).then(()=>{if(n===e.RenderTargetFormat.R16G16B16A16){const e=s,t=new Uint8Array(a);for(let s=0,r=e.length;s<r;s++)t[s]=Math.min(Math.floor(255*e[s]),255);s=t}const t=s,o=Y.createElement("canvas");o.height=i,o.width=r;const l=o.getContext("2d"),h=l.createImageData(r,i);h.data.set(new Uint8ClampedArray(t)),l.putImageData(h,0,0);const d=o.toDataURL();return o.remove(),Promise.resolve(d)})}static parseTemplate(e,t){let s,r,i,a,n=0,o="";for(;-1!=(s=e.indexOf("{",n));)if(s>0&&92==e.charCodeAt(s-1))o+=e.substring(n,s-1),o+="{",n=s+1;else{if(o+=e.substring(n,s),n=s,s=e.indexOf("}",n),-1==s)break;s!=n+1?(i=e.substring(n+1,s),r=i.indexOf("="),-1!=r?(a=t[i.substring(0,r)],o+=null==a?i.substring(r+1):a):(a=t[i],null!=a&&(o+=a)),n=s+1):(o+=e.substring(n,n+2),n=s+1)}return n<e.length&&(o+=e.substring(n)),o}static sleep(e){return e<1?Promise.resolve():new Promise(t=>setTimeout(t,e))}static until(e,t){return e()?Promise.resolve():new Promise(s=>{let r=performance.now();setTimeout(function i(){e()||null!=t&&performance.now()-r>t?s():setTimeout(i,10)},10)})}static runTasks(e,t,s,r){let i;"number"!=typeof t&&(i=t,t=0);let a=e.length;if(t>=a)return Promise.all(e.map((e,t)=>r&&r.aborted?Promise.reject("aborted"):s(e,t)));const n=new Array(a),o=[];let l=0;function h(){if(l>=a||(null==r?void 0:r.aborted))return Promise.resolve();const d=l++,u=e[d],c=Promise.resolve().then(()=>(null==r?void 0:r.aborted)?Promise.reject("aborted"):s(u,d)).then(e=>{n[d]=e,o.splice(o.indexOf(c),1)});return o.push(c),(i?i(o.length):o.length>=t)?Promise.race(o).then(h):h()}const d=[],u=Math.min(t,a);for(let e=0;e<u;e++)d.push(h());return Promise.all(d).then(()=>o.length>0?Promise.all(o):null).then(()=>n)}static runAllTasks(e,t,s,r){let i;"number"!=typeof t&&(i=t,t=0);let a=e.length;if(t>=a)return Promise.allSettled(e.map((e,t)=>Promise.resolve().then(()=>r&&r.aborted?Promise.reject("aborted"):s(e,t))));const n=new Array(a),o=[];let l=0;function h(){if(l>=a||(null==r?void 0:r.aborted))return Promise.resolve();const d=l++,u=e[d],c=Promise.resolve().then(()=>r&&r.aborted?Promise.reject("aborted"):s(u,d)).then(e=>{n[d]={status:"fulfilled",value:e},o.splice(o.indexOf(c),1)}).catch(e=>{n[d]={status:"rejected",reason:e},o.splice(o.indexOf(c),1)});return o.push(c),(i?i(o.length):o.length>=t)?Promise.race(o).then(h):h()}const d=[],u=Math.min(t,a);for(let e=0;e<u;e++)d.push(h());return Promise.allSettled(d).then(()=>o.length>0?Promise.allSettled(o):null).then(()=>n)}static compareVersion(e,t){let s=e.split("."),r=t.split(".");const i=Math.max(s.length,r.length);for(;s.length<i;)s.push("0");for(;r.length<i;)r.push("0");for(let e=0;e<i;e++){const t=parseInt(s[e]),i=parseInt(r[e]);if(t>i)return 1;if(t<i)return-1}return 0}static testPointInPolygon(e,t,s){var r,i,a,n,o,l=0;o=s.length;for(var h=0;h<o;h+=2){if(r=s[h],i=s[h+1],a=s[(h+2)%o],i!=(n=s[(h+3)%o]))if(!(t<Math.min(i,n)))if(!(t>=Math.max(i,n)))(t-i)*(a-r)/(n-i)+r>e&&l++}return l%2==1}}const Z=Symbol();class J{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={},this.i18nUrlMap={}}UUID_to_URL(e){return this.uuidMap[e]}UUID_to_URL_async(e){return Promise.resolve(null)}URL_to_UUID_async(e){return Promise.resolve(null)}resolveURL(e,t){if(e.startsWith("res://")){let s=e.substring(6);return J.inst.UUID_to_URL_async(s).then(e=>(t&&t(e),e))}return t&&t(e),Promise.resolve(e)}shaderName_to_URL(e){return this.shaderNameMap[e]}shaderName_to_URL_async(e){return Promise.resolve(null)}getMeta(e,t){return Promise.resolve(null)}getSubAssetURL(e,t,s,r){return s?`${Q.replaceFileExtension(e,"")}@${s}.${r}`:e}getI18nSettingsURL(e){return this.i18nUrlMap[e]}}J.inst=new J;class ee{static initMiniGameExtensionOverrides(){p.isPreview||(Object.assign(this.overrideFileExts,this.safeFileExtConversionMap,s.safeFileExtConversionMap),this.hasExtOverrides=!0,this.usingSafeFileExts=!0)}constructor(e){this._url=ee.formatURL(e),this._path=ee.getPath(e)}get url(){return this._url}get path(){return this._path}static get rootPath(){return ee.basePaths["~/"]}static set rootPath(e){ee.basePaths["~/"]=e}static formatURL(e,t){if(!e)return t||ee.basePath||"";if(e.startsWith("res://")){let t=e.substring(6),s=J.inst.UUID_to_URL(t);if(!s)return e;e=s}if(-1==e.indexOf(":")&&47!==e.charCodeAt(0)){let s=ee.urlMapping[e];s&&(e=s),null!=ee.customFormat&&(e=ee.customFormat(e));let r=ee.version[e];if(null!=r){let t=e.lastIndexOf(".");e=e.substring(0,t)+"-"+r+e.substring(t)}if(null==t){t=ee.basePath;for(let s in ee.basePaths)if(e.startsWith(s)){126===s.charCodeAt(0)&&(e=e.substring(s.length)),t=ee.basePaths[s];break}}e=ee.join(t,e)}return e}static postFormatURL(e){if(ee.hasExtOverrides){let t=Q.getFileExtension(e),s=ee.overrideFileExts[t];null!=s&&(e=Q.replaceFileExtension(e,s))}return e}static normalize(e){if(-1==e.indexOf("./"))return e;let t=e.split("/"),s=t.length,r=0;for(;r<s;)if("."!=t[r]){if(".."==t[r]){let e=r-1;if(e>=0&&".."!==t[e]){t.splice(e,2),s-=2,r--;continue}}r++}else t.splice(r,1),s--;return t.length=s,t.join("/")}static getResURLByUUID(e){return Q.isUUID(e)?"res://"+e:e}static join(e,t){if(!t)return"";if(t.indexOf(":")>0)return t;if(e){let s=t.charCodeAt(0);126!==s&&47!==s&&(t=47!==e.charCodeAt(e.length-1)?e+"/"+t:e+t)}return ee.normalize(t)}static getPath(e){var t=e.lastIndexOf("/");return t>0?e.substring(0,t+1):""}static getFileName(e){var t=e.lastIndexOf("/");return t>0?e.substring(t+1):e}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substring(t):null}static overrideExtension(e,t,s){if(!s||ee.usingSafeFileExts){for(let s of e)ee.overrideFileExts[s]=t;ee.hasExtOverrides=!0}else for(let s of e)ee.safeFileExtConversionMap[s]=t}}ee.version={},ee.basePath="",ee.basePaths={},ee.urlMapping={},ee.overrideFileExts={},ee.hasExtOverrides=!1,ee.usingSafeFileExts=!1,ee.safeFileExtConversionMap={rendertexture:"rt.json",videotexture:"rt.json",controller:"controller.json",mc:"mc.bin",mcc:"mcc.json",shader:"shader.txt",fui:"fui.json",glsl:"glsl.txt",skel:"skel.bin",lavm:"lavm.json",bp:"bp.json",tres:"tres.json"};class te{constructor(e=0,t=0,s=0,r=0){this.x=e,this.y=t,this.width=s,this.height=r}get right(){return this.x+this.width}set right(e){this.width=e-this.x}get bottom(){return this.y+this.height}set bottom(e){this.height=e-this.y}setTo(e,t,s,r){return this.x=e,this.y=t,this.width=s,this.height=r,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=te.TEMP&&this!=te.EMPTY&&h.recover("Rectangle",this.reset())}static create(){return h.getItemByClass("Rectangle",te)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}contains(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}intersects(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}intersection(e,t){if(!this.intersects(e))return null;let s=Math.max(this.x,e.x),r=Math.max(this.y,e.y),i=Math.min(this.right,e.right)-s,a=Math.min(this.bottom,e.bottom)-r;return t||(t=new te),t.setTo(s,r,i,a)}union(e,t){let s=e.x,r=e.y,i=e.width,a=e.height;return t||(t=new te),this.cloneTo(t),i<=0||a<=0?t:this.width<=0||this.height<=0?t.setTo(s,r,i,a):(t.addPoint(s,r),t.addPoint(s+i,r+a),t)}scale(e,t){return this.x*=e,this.y*=t,this.width*=e,this.height*=t,this}transform(e,t){let s=e.a,r=e.b,i=e.c,a=e.d,n=e.tx,o=e.ty,l=this.x,h=this.y,d=l+this.width,u=h+this.height,c=l*s,_=d*s,p=h*i,g=u*i,m=l*r,f=d*r,T=h*a,y=u*a,x=Math.min(c+p,c+g,_+p,_+g),S=Math.max(c+p,c+g,_+p,_+g),E=Math.min(m+T,m+y,f+T,f+y),v=Math.max(m+T,m+y,f+T,f+y);return t||(t=new te),t.setTo(x+n,E+o,S-x,v-E)}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}addPoint(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}getBoundPoints(e){return e=e||[],0==this.width||0==this.height||e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e}static _getWrapRec(e,t){if(t=t||new te,!e||e.length<1)return t.setTo(0,0,0,0);let s,r,i,a,n,o=e.length;for(r=a=99999,i=n=-r,s=0;s<o;s+=2){let t=e[s],o=e[s+1];r=r<t?r:t,a=a<o?a:o,i=i>t?i:t,n=n>o?n:o}return t.setTo(r,a,i-r,n-a)}static minMaxRect(e,t,s,r,i){return(i=i||new te).setTo(e,t,s-e,r-t)}isEmpty(){return this.width<=0||this.height<=0}clone(e){return e||(e=new te),this.cloneTo(e),e}cloneTo(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height}}te.EMPTY=new te,te.TEMP=new te;const se=new te,re=new te;class ie extends V{static create(e,t,s,r,i,a=0,n=0,o=0,l=0){return ie._create(e,t,s,r,i,a,n,o,l)}static _create(e,t,s,r,i,a=0,n=0,o=0,l=0,h=null){var d,u=e instanceof ie,c=u?e.uv:ie.DEF_UV,_=u?e.bitmap:e;_.width&&t+r>_.width&&(r=_.width-t),_.height&&s+i>_.height&&(i=_.height-s),h?(d=h).setTo(_,null,o||r,l||i):d=new ie(_,null,o||r,l||i),d.width=r,d.height=i,d.offsetX=a,d.offsetY=n;var p=1/_.width,g=1/_.height;t*=p,s*=g,r*=p,i*=g;var m=d.uv[0],f=d.uv[1],T=d.uv[4],y=d.uv[5],x=T-m,S=y-f,E=function(e,t,s){for(var r=0;r<8;r+=2)s[r]+=e,s[r+1]+=t;return s}(c[0],c[1],[t,s,t+r,s,t+r,s+i,t,s+i]);d.uv=new Float32Array([m+E[0]*x,f+E[1]*S,T-(1-E[2])*x,f+E[3]*S,T-(1-E[4])*x,y-(1-E[5])*S,m+E[6]*x,y-(1-E[7])*S]);var v=e.scaleRate;return v&&1!=v?(d.sourceWidth/=v,d.sourceHeight/=v,d.width/=v,d.height/=v,d.scaleRate=v,d.offsetX/=v,d.offsetY/=v):d.scaleRate=1,d}static createFromTexture(e,t,s,r,i){var a=e.scaleRate;1!=a&&(t*=a,s*=a,r*=a,i*=a);var n=te.TEMP.setTo(t-e.offsetX,s-e.offsetY,r,i),o=n.intersection(se.setTo(0,0,e.width,e.height),re);if(o){let t=ie.create(e,o.x,o.y,o.width,o.height,o.x-n.x,o.y-n.y,r,i);return t._sizeGrid=e._sizeGrid,t._atlas=e._atlas,t}return null}get uv(){return this._uv}set uv(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==ie.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==ie.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}get bitmap(){return this._bitmap}set bitmap(e){this._bitmap!=e&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount))}constructor(e=null,t=null,s=0,r=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let i=e instanceof ie?e.bitmap:e;this.setTo(i,t,s,r)}_addReference(e=1){var t,s;super._addReference(e),null===(t=this._bitmap)||void 0===t||t._addReference(e),null===(s=this._atlas)||void 0===s||s._addReference(e)}_removeReference(e=1){var t,s;null===(t=this._bitmap)||void 0===t||t._removeReference(e),null===(s=this._atlas)||void 0===s||s._removeReference(e),super._removeReference(e)}_getSource(e=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(e=null,t=null,s=0,r=0){this.bitmap=e,this.sourceWidth=s,this.sourceHeight=r,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||ie.DEF_UV}load(e,t){return this._destroyed?Promise.resolve():l.loader.load(e).then(e=>{let s=e.bitmap;this.bitmap=s,this.sourceWidth=this._w=s.width,this.sourceHeight=this._h=s.height,t&&t.run(),this.event(c.READY,this)})}getTexturePixels(e,t,s,r){var i,a,n=this.bitmap,o=this._w,l=this._h,h=this.sourceWidth,d=this.sourceHeight,u=n.width,c=n.height,_=this.offsetX,p=this.offsetY;let g=s,m=r;if(e+s>o+_&&(g-=e+s-o-_),e+s>h&&(s-=e+s-h),t+r>l+p&&(m-=t+r-l-p),t+r>d&&(r-=t+r-d),s<=0||r<=0)return null;let f=_>e?_-e:0,T=p>t?p-t:0,y=e>_?e-_:0,x=t>p?t-p:0;g-=f,m-=T;var S=4*s,E=null;try{E=n.getPixels()}catch(e){}if(E){if(0==e&&0==t&&s==u&&r==c)return E;let n=this._uv.slice(),o=Math.round(n[0]*u),l=Math.round(n[1]*c);var v=new Uint8Array(s*r*4);for(i=4*o+4*y+(l+x)*(S=4*u),a=0;a<m;a++)v.set(E.slice(i,i+4*g),4*s*(a+T)+4*f),i+=S;return v}return v}getPixels(e,t,s,r){return this.getTexturePixels(e,t,s,r)}recoverBitmap(e){var t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||l.loader.load(t,"image").then(t=>{this.bitmap=t.bitmap,e&&e()})}disposeBitmap(){!this._destroyed&&this._bitmap&&(this._bitmap.destroy(),this.event("dispose"))}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(e){this._obsolute=e}_disposeResource(){let e=this._bitmap;this._bitmap=null,e&&e._removeReference(this._referenceCount);let t=this._atlas;this._atlas=null,t&&t._removeReference(this._referenceCount)}getCachedClip(e,t,s,r){if(this.destroyed)return null;let i=`${e}_${t}_${s}_${r}`;this._clipCache||(this._clipCache=new Map);let a=this._clipCache.get(i);return a||(a=ie.createFromTexture(this,e,t,s,r),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(i,a),a)}}ie.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),ie.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),ie.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class ae{static enable(e,t=null){l.loader.fetch(e,"json").then(e=>{e&&(ae.addAtlases(e),t&&t.run())})}static addAtlases(e){let t=ae._fileLoadDic;for(let s in e){let r=e[s],i=ee.formatURL(r[0]),a=r[1],n=a.length,o={url:s};for(let e=0;e<n;e++)t[i+a[e]]=o}}static addAtlas(e,t,s,r){t=ee.formatURL(t),null==r&&(r=!0);let i=ae._fileLoadDic,a={url:e};for(let e of s){let s=t+e;!r&&i[s]||(i[s]=a)}}static getFileLoadPath(e){return ae._fileLoadDic[e]}}ae._fileLoadDic={};class ne{static workerSupported(){return!!Worker}static get enable(){return ne._enable}static set enable(e){if(ne._enable!=e){if(e){if(!Worker)return;ne._worker||(ne._worker=new Worker(s.workerLoaderLib||ne.workerPath),ne._worker.onmessage=ne.workerMessage)}ne._enable=e}}static load(e,t){let s=ne._queue[e];return s?new Promise((e,t)=>{s.push(e,t)}):(ne._queue[e]=s=[],new Promise((r,i)=>{s.push(r,i),ne._worker.postMessage({url:e,options:t})}))}static workerMessage(e){let t=e.data;if(t&&"Image"===t.type){let e=ne._queue[t.url];if(e){delete ne._queue[t.url];let s=t.imageBitmap?t.imageBitmap:t.msg;for(let r=t.imageBitmap?0:1;r<e.length;r+=2)e[r](s)}}}}ne.workerPath="libs/laya.workerloader.js",ne._enable=!1,ne._queue={};class oe extends V{constructor(e,t,s){super(),this.dir=e,this.textures=t,this.frames=s;for(let e of s)e._addReference(),e._atlas=this;for(let e of t)e._addReference(),e._atlas=this}update(e,t){this._disposeResource(),this.textures.push(...e),this.frames.push(...t);for(let e of t)e._addReference(),e._atlas=this;for(let t of e)t._addReference(),t._atlas=this}_disposeResource(){for(let e of this.textures)e._atlas=null,e._removeReference();for(let e of this.frames)e._atlas=null,e._removeReference();this.frames.length=0,this.textures.length=0}}class le{constructor(e){this._callback=e,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(e){let t=this._items.length;return this._items.push(0),null==e?this._weights.push(null):this._weights.push(Math.max(0,Math.min(e,1))),e=>this.update(t,e)}update(e,t){if(-1!=e){this._items[e]=Math.max(0,Math.min(t,1));let s=0,r=this._items,i=this._weights,a=1/r.length;for(let e=0;e<r.length;e++){let t=r[e],n=i[e];null!=t&&(s+=t*(null!=n?n:a))}(t=s)>1&&(t=1)}t>this._progress&&(this._progress=t,this._callback(t))}}class he{constructor(e=null,t=null,s=null,r=!1){this.once=!1,this._id=0,this.setTo(e,t,s,r)}setTo(e,t,s,r=!1){return this._id=he._gid++,this.caller=e,this.method=t,this.args=s,this.once=r,this}run(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}runWith(e){if(null==this.method)return null;var t=this._id;if(null==e)var s=this.method.apply(this.caller,this.args);else s=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),s}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,he._pool.push(this.clear()))}static create(e,t,s=null,r=!0){return he._pool.length?he._pool.pop().setTo(e,t,s,r):new he(e,t,s,r)}}he._pool=[],he._gid=1;class de{static decodeString(e){let t=e.length,s="",r=0,i=0;for(;;){if(i=e.indexOf("&",r),-1==i){s+=e.substring(r);break}s+=e.substring(r,i),r=i+1,i=r;let a=Math.min(t,i+10);for(;i<a&&";"!=e[i];i++);if(i<a&&i>r){let t=e.substring(r,i),a=0;if("#"==t[0])t.length>1?(a="x"==t[1]?parseInt(t.substring(2),16):parseInt(t.substring(1)),s+=String.fromCharCode(a),r=i+1):s+="&";else{switch(t){case"amp":a=38;break;case"apos":a=39;break;case"gt":a=62;break;case"lt":a=60;break;case"nbsp":a=32;break;case"quot":a=34}a>0?(s+=String.fromCharCode(a),r=i+1):s+="&"}}else s+="&"}return s}static encodeString(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(e,t,s){if(null==e)return null==s?null:s;let r=e[t];return null!=r?""+r:null==s?null:s}static getInt(e,t,s){let r=this.getString(e,t);if(null!=r&&r.length>0)if("%"==r[r.length-1]){let e=parseInt(r.substring(0,r.length-1));if(!isNaN(e))return Math.ceil(e/100*s)}else{let e=parseInt(r);if(!isNaN(e))return e}return null==s?0:s}static getFloat(e,t,s){let r=this.getString(e,t);if(null==r||0==r.length)return null==s?0:s;let i=parseFloat(r);return isNaN(i)?null==s?0:s:i}static getBool(e,t,s){let r=this.getString(e,t);return null==r||0==r.length?null!=s&&s:"true"==r||"1"==r||"false"!=r&&"0"!=r&&(null!=s&&s)}}var ue;e.XMLTagType=void 0,(ue=e.XMLTagType||(e.XMLTagType={}))[ue.Start=0]="Start",ue[ue.End=1]="End",ue[ue.Void=2]="Void",ue[ue.CDATA=3]="CDATA",ue[ue.Comment=4]="Comment",ue[ue.Instruction=5]="Instruction";class ce{static begin(e,t){ce.source=e,ce.lowerCaseName=t,this.sourceLen=e.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let t,s,r="";for(this.tagType=e.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(t=this.source.indexOf("<",this.parsePos))&&(this.parsePos=t,t++,t!=this.sourceLen);){if(s=this.source[t],"!"==s){if(this.sourceLen>t+7&&"<![CDATA["==this.source.substring(t-1,t+8))return t=this.source.indexOf("]]>",t),this.tagType=e.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>t+2&&"\x3c!--"==this.source.substring(t-1,t+3))return t=this.source.indexOf("--\x3e",t),this.tagType=e.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;t++,this.tagType=e.XMLTagType.Instruction}else"/"==s?(t++,this.tagType=e.XMLTagType.End):"?"==s&&(t++,this.tagType=e.XMLTagType.Instruction);for(;t<this.sourceLen&&(s=this.source[t],-1==" \t\n\r\v".indexOf(s)&&">"!=s&&"/"!=s);t++);if(t==this.sourceLen)break;r+=this.source.substring(this.parsePos+1,t),r.length>0&&"/"==r[0]&&(r=r.substring(1));let i=!1,a=!1,n=-1;for(;t<this.sourceLen;t++)if(s=this.source[t],'"'==s?i||(a=!a):"'"==s&&(a||(i=!i)),">"==s){if(!i&&!a){n=-1;break}n=t}else if("<"==s)break;if(-1!=n&&(t=n),t==this.sourceLen)break;return"/"==this.source[t-1]&&(this.tagType=e.XMLTagType.Void),this.tagName=r,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=t+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":this.source.substring(e,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":de.decodeString(this.source.substring(e,this.tagPos)).trimEnd()}return de.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let e in this._attrs)delete this._attrs[e];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(e){return this.attributes[e]}static parseAttributes(e){let t,s=0,r=0,i=!1,a=0,n="",o=this.tagPos,l=this.tagPos+this.tagLength;if(o<l&&"<"==this.source[o])for(;o<l;o++){let e=this.source[o];if(-1!=" \t\n\r\v".indexOf(e)||">"==e||"/"==e)break}for(;o<l;o++){let h=this.source[o];if("="==h){s=-1,r=-1,a=0;for(let e=o+1;e<l;e++){let t=this.source[e];if(-1!=" \t\n\r\v".indexOf(t)){if(-1!=s&&0==a){r=e-1;break}}else if(">"==t){if(0==a){r=e-1;break}}else if('"'==t)if(-1!=s){if(1!=a){r=e-1;break}}else a=2,s=e+1;else if("'"==t)if(-1!=s){if(2!=a){r=e-1;break}}else a=1,s=e+1;else-1==s&&(s=e)}if(-1==s||-1==r)break;t=n,this.lowerCaseName&&(t=t.toLowerCase()),n="",e[t]=de.decodeString(this.source.substring(s,r+1)),o=r+1}else-1==" \t\n\r\v".indexOf(h)?((i||"/"==h||">"==h)&&(n.length>0&&(t=n,this.lowerCaseName&&(t=t.toLowerCase()),e[t]="",n=""),i=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(i=!0)}}}ce._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class _e{constructor(e){e&&this.parse(e)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(e,t){return de.getString(this._attrs,e,t)}getAttrInt(e,t){return de.getInt(this._attrs,e,t)}getAttrFloat(e,t){return de.getFloat(this._attrs,e,t)}getAttrBool(e,t){return de.getBool(this._attrs,e,t)}setAttribute(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t}getNode(e){return this._children?this._children.find(t=>t.name==e):null}elements(e){return this._children||(this._children=new Array),e?this._children.filter(t=>t.name==e):this._children}parse(t){let s;this.reset();let r=new Array;for(ce.begin(t);ce.nextTag();)if(ce.tagType==e.XMLTagType.Start||ce.tagType==e.XMLTagType.Void){let t;if(s)t=new _e;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");t=this}t.name=ce.tagName,t._attrs=Object.assign({},ce.attributes),s&&(ce.tagType!=e.XMLTagType.Void&&r.push(s),null==s._children&&(s._children=new Array),s._children.push(t)),ce.tagType!=e.XMLTagType.Void&&(s=t)}else if(ce.tagType==e.XMLTagType.End){if(null==s||s.name!=ce.tagName)throw this.reset(),new Error("Invalid xml format - <"+ce.tagName+"> dismatched.");null!=s._children&&0!=s._children.length||(s.text=ce.getText()),s=r.length>0?r.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class pe extends N{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(e,t=null,s="get",r="text",i){this._responseType=r,this._data=null,this._url=e;let a=this._http;a.open(s,e,!0);let n=i&&-1!==i.indexOf("Content-Type");if(t?"string"==typeof t?n||a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(n||a.setRequestHeader("Content-Type","application/json"),t instanceof ArrayBuffer||(t=JSON.stringify(t))):Y.onBLMiniGame&&Y.onAndroid&&(t={}),i)for(let e=0;e<i.length;e++)a.setRequestHeader(i[e++],i[e]);let o="arraybuffer"!==r?"text":"arraybuffer";a.responseType=o,a.dataType&&(a.dataType=o),a.onerror=e=>this._onError(e),a.onabort=e=>this._onAbort(e),a.onprogress=e=>this._onProgress(e),a.onload=e=>this._onLoad(e),a.send(t)}_onProgress(e){e&&e.lengthComputable&&this.event(c.PROGRESS,e.loaded/e.total)}_onAbort(e){this.error("Request was aborted by user")}_onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(e){var t=this._http,s=void 0!==t.status?t.status:200;200===s||204===s||0===s?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}error(e){this.clear(),this.event(c.ERROR,e)}complete(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new _e(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(c.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}class ge{constructor(){this.httpRequestPool=[]}common(e,t,s,r,i,a){let n=this.getRequestInst();n.on(c.COMPLETE,()=>{let e=n.data;this.returnRequestInst(n),a(e)}),n.on(c.ERROR,null,e=>{this.returnRequestInst(n),a(null,e)}),i&&n.on(c.PROGRESS,i),n.send(t,null,"get",r),e.$ref=n}image(e,t,s,r,i){let a=new Y.window.Image;a.crossOrigin="",a.onload=()=>{a.onload=null,a.onerror=null,i(a)},a.onerror=()=>{a.onload=null,a.onerror=null,i(null,"")},a.src=t,e.$ref=a}imageWithBlob(e,t,s,r,i){let a=W.browser.createBufferURL(t);a?this.image(e,a,s,r,i):i(null,"Blob URL creation not supported.")}imageWithWorker(e,t,s,r,i){ne.enable=!0,ne.enable?ne.load(t,e.workerLoaderOptions).then(i).catch(e=>i(null,e)):this.image(e,t,s,r,i)}audio(e,t,s,r,i){let a=Y.createElement("audio");a.crossOrigin="",a.oncanplaythrough=()=>{a.oncanplaythrough=null,a.onerror=null,i(a)},a.onerror=()=>{a.oncanplaythrough=null,a.onerror=null,i(null,"")},a.src=t,e.$ref=a}package(e,t,s){s(null)}getRequestInst(){return 0==this.httpRequestPool.length||Y.onVVMiniGame||Y.onHWMiniGame?new pe:this.httpRequestPool.pop()}returnRequestInst(e){e.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(e)}}var me=0;const fe={ext:null,typeId:null,main:!1,loaderType:null};class Te extends N{static registerLoader(e,t,s,r){let i;s?(i=Te.typeMap[s],i?i.loaderType!=t&&(i={typeId:i.typeId,loaderType:t}):Te.typeMap[s]=i={typeId:me++,loaderType:t}):i={typeId:me++,loaderType:t},r&&(Te.hotReloadableFlags[i.typeId]=!0);for(let r of e){let e=Te.extMap[r];if(e&&s){let s=e.findIndex(e=>e.typeId==i.typeId);-1===s?e.push(i):e[s].loaderType=t}else Te.extMap[r]=[i]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(e,t,s,r,i,a,n,o,l){let h,d,u,c,_=Se;if(t instanceof he?(h=t,d=r):"string"==typeof t?d=t:null!=t&&(d=t.type,_=t),null==i&&null==a&&null==o&&null==n&&null==l||(_=_===Se?{priority:i,cache:a,ignoreCache:o,group:n,useWorkerLoader:l}:Object.assign(_,{priority:i,cache:a,ignoreCache:o,group:n,useWorkerLoader:l})),!1===_.cache&&(_.ignoreCache=!0),u=s instanceof he?e=>s.runWith(e):s,Array.isArray(e)){let t;u&&(t=new le(u));let s=[];for(let r=0;r<e.length;r++){let i=e[r];i&&("string"==typeof i?s.push(this._load1(i,d,_,null==t?void 0:t.createCallback())):s.push(this._load1(i.url,i.type||d,_!==Se?Object.assign({},_,i):i,null==t?void 0:t.createCallback())))}c=Promise.all(s)}else c="string"==typeof e?this._load1(e,d,_,u):this._load1(e.url,e.type||d,_!==Se?Object.assign({},_,e):e,u);return h?c.then(e=>(h.runWith(e),e)):c}_load1(e,t,s,r){if(p.isPreview){if(e.startsWith("res://")){let i=e.substring(6);return J.inst.UUID_to_URL_async(i).then(a=>{var n;return a?this._load2(a,i,t,s,r):(!s.silent&&Te.warnFailed(e,void 0,null===(n=s.initiator)||void 0===n?void 0:n.url),Promise.resolve(null))})}return J.inst.URL_to_UUID_async(e).then(i=>this._load2(e,i,t,s,r))}return this._load2(e,null,t,s,r)}_load2(t,s,r,i,a){var n,o;let{ext:l,typeId:h,main:d,loaderType:u}=Te.getURLInfo(t,r,i.maybeType);if(!u)return!i.silent&&Te.warnFailed(t,r?`unsupported load type:${r}`:t.startsWith("res://")?"":"unsupported suffix",null===(n=i.initiator)||void 0===n?void 0:n.url),Promise.resolve(null);let _,p=ee.formatURL(t);if(i.group){let e=Te.groupMap[i.group];e||(e=Te.groupMap[i.group]=new Set),e.add(p)}if(!i.ignoreCache){let e=Te._getRes(p,r);if(void 0!==e){if(null==e)return Promise.resolve(null);if(!(e instanceof V))return Promise.resolve(e);if(e.obsolute&&(_=e),!(_||e.uuid&&s&&s!=e.uuid))return Promise.resolve(e)}}let g=p;d||(g+="@"+h);let m=this._loadings.get(g);if(m){let e=i.initiator;for(;e;){if(e===m)return Promise.resolve();e=e.options.initiator}return null!=m.result?m.result:(a&&m.onProgress.add(a),new Promise(e=>m.onComplete.add(e)))}let T=ae.getFileLoadPath(p);if(T)return this.load(T.url,{type:Te.ATLAS,baseUrl:T.baseUrl}).then(()=>Te.getRes(t,r));m=xe.length>0?xe.pop():new ye,m.type=r,m.url=t,m.uuid=s,m.ext=l,delete(i=Object.assign(m.options,i)).type,null==i.priority&&(i.priority=0),null==i.useWorkerLoader&&(i.useWorkerLoader=ne.enable),a&&m.onProgress.add(a),m.loader=this,m.obsoluteInst=_;let y,x=new u;this._loadings.set(g,m);let S=performance.now();try{f.statAgent.recordCountData(e.StatElement.C_LoadResourceCount,1),y=x.load(m)}catch(e){!i.silent&&Te.warnFailed(t,e,null===(o=i.initiator)||void 0===o?void 0:o.url),y=Promise.resolve(null)}return y.then(r=>(f.statAgent.recordTimeData(e.StatElement.T_LoadResourceTime,performance.now()-S),r instanceof V&&(r.obsolute=!1,r._setCreateURL(t,s)),!1!==m.options.cache&&Te._cacheRes(p,r,h,d),null!=r&&null!=x.postLoad?(m.result=r,x.postLoad(m,r).then(()=>(m.progress.update(-1,1),m.onComplete.invoke(r),r))):(m.progress.update(-1,1),m.onComplete.invoke(r),r))).catch(e=>{var s;return!i.silent&&Te.warnFailed(t,e,null===(s=i.initiator)||void 0===s?void 0:s.url),!1!==m.options.cache&&Te._cacheRes(p,null,h,d),m.onComplete.invoke(null),null}).then(e=>(this._loadings.delete(g),m.reset(),xe.push(m),0==this._loadings.size&&this.event(c.COMPLETE),e))}fetch(e,t,s,r){var i;let a={originalUrl:e,url:e,contentType:t,priority:null!==(i=(r=r||Se).priority)&&void 0!==i?i:1,retryCnt:0,onProgress:s,onComplete:null};return r.useWorkerLoader&&(a.useWorkerLoader=!0,a.workerLoaderOptions=r.workerLoaderOptions),r.blob&&(a.blob=r.blob),r.noRetry&&(a.retryCnt=-1),r.silent&&(a.silent=!0),J.inst.resolveURL(e).then(e=>e?new Promise(t=>{a.url=ee.formatURL(e),a.onComplete=t,this.queueToDownload(a)}):null)}queueToDownload(e){if(this._downloadings.size<this.maxLoader)return void this.download(e);let t=e.priority;if(0==t)this._queue.push(e);else{let s=this._queue.findIndex(e=>e.priority<t);-1!=s?this._queue.splice(s,0,e):this._queue.push(e)}}download(t){this._downloadings.add(t),f.statAgent.recordCountData(e.StatElement.C_LoadRequestCount,1),t.startTime=performance.now();let s=ee.postFormatURL(t.url);if("image"==t.contentType){let e=Te.preLoadedMap[t.url];if(e){if(!(e instanceof ArrayBuffer))return void this.completeItem(t,e);t.blob=e}t.blob?Te.downloader.imageWithBlob(t,t.blob,t.originalUrl,t.onProgress,(e,s)=>{e||(t.retryCnt=-1),this.completeItem(t,e,s)}):t.useWorkerLoader?Te.downloader.imageWithWorker(t,s,t.originalUrl,t.onProgress,(e,s)=>{e||(t.useWorkerLoader=!1,t.silent||Te.warnFailed(t.url,s)),this.completeItem(t,e,s)}):Te.downloader.image(t,s,t.originalUrl,t.onProgress,(e,s)=>this.completeItem(t,e,s))}else if("sound"==t.contentType)Te.downloader.audio(t,s,t.originalUrl,t.onProgress,(e,s)=>this.completeItem(t,e,s));else{let e=Te.preLoadedMap[t.url];if(e)return void this.completeItem(t,e);Te.downloader.common(t,s,t.originalUrl,t.contentType,t.onProgress,(e,s)=>this.completeItem(t,e,s))}}completeItem(t,s,r){this._downloadings.delete(t),f.statAgent.recordTimeData(e.StatElement.T_LoadRequestTime,performance.now()-t.startTime),s?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onProgress&&t.onProgress(1),t.onComplete(s)):-1!=t.retryCnt&&t.retryCnt<this.retryNum?(t.retryCnt++,t.silent||console.debug(`Retry to load ${t.url} (${t.retryCnt})`),l.systemTimer.once(this.retryDelay,this,this.queueToDownload,[t],!1)):(!t.silent&&Te.warnFailed(t.url,r),t.onProgress&&t.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onComplete(null))}static getURLInfo(e,t,s){let r,i,a,n,o=e.startsWith("data:")?"png":Q.getFileExtension(e);if(o.length>0&&(r=Te.extMap[o]),r||t||(t=s),t){let e=Te.typeMap[t];if(!e)return fe;i=e.typeId;let s=0;r?r[0].typeId===i||-1!=(s=r.findIndex(e=>e.typeId===i))?(a=0===s,n=r[s].loaderType):(a=!1,n=e.loaderType):(a=t!=Te.TEXTURE2D,n=e.loaderType)}else{if(!r)return fe;a=!0,i=r[0].typeId,n=r[0].loaderType}return{ext:o,main:a,typeId:i,loaderType:n}}static warnFailed(e,t,s){s?this.warn(`Failed to load '${e}' (in '${s}')`,t):this.warn(`Failed to load '${e}'`,t)}static warn(e,t){t?console.warn(e,t):console.warn(e)}static getRes(e,t){return e=ee.formatURL(e),Te._getRes(e,t)||null}static _getRes(e,t){let s,r=Te.loadedMap[e];if(r){if(t){let e=Te.typeMap[t];if(!e)return;if(2==r.length)r[0]==e.typeId&&(s=r[1]);else{let t=r.indexOf(e.typeId);-1!=t&&(s=r[t+1])}}else s=r[1];return s instanceof V&&s.destroyed?void 0:s}}static getTexture2D(e){return Te.getRes(e,Te.TEXTURE2D)}static getBaseTexture(e){return Te.getRes(e,Te.TEXTURE2D)}static getAtlas(e){return Te.getRes(e,Te.ATLAS)}getRes(e,t){return Te.getRes(e,t)}static createNodes(e){var t;return null===(t=Te.getRes(e))||void 0===t?void 0:t.create()}static cacheRes(e,t,s){e=ee.formatURL(e);let r=Te.getURLInfo(e,s);null!=r.typeId&&Te._cacheRes(e,t,r.typeId,r.main)}static _cacheRes(e,t,s,r){let i=Te.loadedMap[e];if(r)i?(i[0]=s,i[1]=t):i=Te.loadedMap[e]=[s,t];else if(i){let e=i.findIndex(e=>e===s);-1!=e?i[e+1]=t:i.push(s,t)}else i=Te.loadedMap[e]=[null,void 0,s,t]}cacheRes(e,t,s){Te.cacheRes(e,t,s)}static clearRes(e,t){e=ee.formatURL(e),Te._clearRes(e,t)}clearRes(e,t){e=ee.formatURL(e),Te._clearRes(e,t)}static _clearRes(e,t){let s=Te.loadedMap[e];if(s)if(t){if(s[1]==t)2==s.length?delete Te.loadedMap[e]:s[1]=void 0;else{let r=s.indexOf(t);if(-1===r)return;4==s.length&&null==s[0]?delete Te.loadedMap[e]:s.splice(r-1,2)}t instanceof V&&!t.destroyed&&t.destroy()}else if(delete Te.loadedMap[e],s.length>2)for(let e=1;e<s.length;e+=2){let t=s[e];t instanceof V&&!t.destroyed&&t.destroy()}else{let e=s[1];e instanceof V&&!e.destroyed&&e.destroy()}}clearTextureRes(e){e=ee.formatURL(e);let t=Te.loadedMap[e];if(!t)return;let s=t[1];if(s instanceof ie)s.disposeBitmap();else if(s instanceof oe)for(let e of s.textures)e.disposeBitmap()}static setGroup(e,t){e=ee.formatURL(e);let s=Te.groupMap[t];s||(s=Te.groupMap[t]=new Set),s.add(e)}static clearResByGroup(e){let t=Te.groupMap[e];if(t)for(let e of t)Te._clearRes(e)}clearUnLoaded(){if(0==this._queue.length)return;let e=this._queue.concat();this._queue.length=0;for(let t of e)t.onComplete(null)}cancelLoadByUrls(e){if(e)for(var t=0,s=e.length;t<s;t++)this.cancelLoadByUrl(e[t])}cancelLoadByUrl(e){e=ee.formatURL(e);let t=this._queue.findIndex(t=>t.url==e);if(-1!=t){let e=this._queue[t];this._queue.splice(t,1),e.onComplete(null)}}loadPackage(e,t,s){let r,i;return"string"==typeof t?(i=t,r=s):r=s||t,i?(i.endsWith("/")||(i+="/"),ee.basePaths[e.length>0?e+"/":e]=i,this._loadFileConfig(e,!0,r)):p.isPreview?Promise.resolve(!0):0===e.length?this._loadFileConfig(e,!0,r):new Promise(t=>{Te.downloader.package(e,r,(s,i)=>{var a;if(null!=i)return Te.warn(`Failed to load package '${e}'`,i),void t(!1);this._loadFileConfig(e,null===(a=null==s?void 0:s.loadScript)||void 0===a||a,r).then(()=>t(!0))})})}_loadFileConfig(e,t,s){return e.length>0&&(e+="/"),this.fetch(e+"fileconfig.json","json",s).then(s=>null!=s&&(this._parseFileConfig(s),!t||!s.entry||Y.loadLib(e+s.entry).then(()=>!0)))}_parseFileConfig(e){let t=[],s=e.files;for(let e in s)if(e.length>0)for(let r of s[e])t.push(e+"/"+r);else for(let r of s[e])t.push(r);if(e.hash){let s=0,r=ee.version;for(let i of e.hash)null!=i&&(r[t[s]]=i),s++}let r,i,a=e.config,n=a.length,o=0,l=0,h=0,d=0,u=0,c=J.inst.metaMap;for(;;){if(null==r){if(o>=n)break;i=a[o],r=i.i,Array.isArray(r)?u=r.length:(h=r,u=0,d=1),l=0}if(0==d){if(l>=u){o++,r=null;continue}d=r[l++],d>0?(h=d,d=0):d=-d}else d--;let e=t[h+d];switch(i.t){case 0:c[e]=i;break;case 1:ae.addAtlas(e,i.prefix,i.frames);break;case 2:J.inst.shaderNameMap[i.shaderName]=e;break;case 3:Te.preLoadedMap[ee.formatURL(e)]=i;break;case 4:ee.urlMapping[Q.getBaseName(e)]=e}}}}Te.TEXT="text",Te.JSON="json",Te.XML="xml",Te.BUFFER="arraybuffer",Te.IMAGE="image",Te.SOUND="sound",Te.VIDEO="video",Te.ATLAS="atlas",Te.FONT="font",Te.TTF="ttf",Te.HIERARCHY="HIERARCHY",Te.MESH="MESH",Te.MATERIAL="MATERIAL",Te.TEXTURE2D="TEXTURE2D",Te.TEXTURECUBE="TEXTURE2D",Te.TEXTURE2DARRAY="TEXTURE2D",Te.ANIMATIONCLIP="ANIMATIONCLIP",Te.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Te.TERRAINRES="TERRAIN",Te.SPINE="SPINE",Te.extMap={},Te.typeMap={},Te.hotReloadableFlags={},Te.assetTypeToLoadType={Image:Te.IMAGE,Texture2D:Te.TEXTURE2D,RenderTexture:Te.TEXTURE2D,TextureCube:Te.TEXTURECUBE,Prefab:Te.HIERARCHY,Material:Te.MATERIAL,Mesh:Te.MESH,Spine:Te.SPINE},Te.downloader=new ge,Te.groupMap={},Te.loadedMap={},Te.preLoadedMap={};class ye{constructor(){this.options={},this.onProgress=new B,this.onComplete=new B,this.progress=new le(e=>this.onProgress.invoke(e))}reset(){for(let e in this.options)delete this.options[e];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null,this.result=null}}const xe=[],Se={};class Ee{static regClass(e,t){Ee._classMap[e]=t}static getClass(e){return Ee._classMap[e]}static regRuntime(e,t){Ee._runtimeMap[e]=t}static getRuntime(e){return Ee._runtimeMap[e]}}function ve(){}Ee._classMap={},Ee._runtimeMap={};class De{}De.MAX_CLIP_SIZE=99999999;class we{}we.ACTIVE=1,we.ACTIVE_INHIERARCHY=2,we.AWAKED=4,we.DISPLAY=16,we.HAS_ZORDER=32,we.DISPLAYED_INSTAGE=128,we.CHECK_INPUT=512,we.DEMAND_TRANS_EVENT=1024,we.HAS_SCRIPT=2048,we.ESCAPE_DRAWING_TO_TEXTURE=4096,we.DISABLE_INNER_CLIPPING=8192,we.DISABLE_OUTER_CLIPPING=16384,we.FORCE_VISIBLE=32768,we.EDITING_NODE=65536,we.HIDE_BY_EDITOR=131072,we.LOCK_BY_EDITOR=262144,we.EDITING_ROOT_NODE=524288,we.FORCE_HIDDEN=1048576,we.NOT_IN_PAGE=2097152,we.ESCAPE_LAYOUT=4194304;class be{}be.HideInHierarchy=1,be.HideInInspector=2,be.DontSave=4,be.HideAndDontSave=7;class Ce{static equals(e,t){return r.nearEqual(e.a,t.a)&&r.nearEqual(e.b,t.b)&&r.nearEqual(e.c,t.c)&&r.nearEqual(e.d,t.d)&&r.nearEqual(e.tx,t.tx)&&r.nearEqual(e.ty,t.ty)}static extractTransformInfo(e){let{a:t,b:s,c:r,d:i,tx:a,ty:n}=e,o=a,l=n;const h=t*i-s*r<0?-1:1;let d=Math.sqrt(t*t+s*s),u=h*Math.sqrt(r*r+i*i),c=Q.toAngle(Math.atan2(s,t)),_=0,p=0;if(0!==d&&0!==u){const e=t/d,a=s/d,n=r/u,o=i/u,l=n*e+o*a,h=-n*a+o*e;_=Q.toAngle(Math.atan2(l,h));const c=t*r+s*i,g=Math.sqrt(t*t+s*s),m=Math.sqrt(r*r+i*i);if(0!==g&&0!==m){const e=c/(g*m),t=Math.max(-1,Math.min(1,e));p=Q.toAngle(Math.PI/2-Math.acos(t))}}return{x:o,y:l,scaleX:d,scaleY:u,rotation:c,skewX:_,skewY:p}}constructor(e=1,t=0,s=0,r=1,i=0,a=0,n=0){if(this._bTransform=!1,null!=Ce._createFun)return Ce._createFun(e,t,s,r,i,a,n);this.a=e,this.b=t,this.c=s,this.d=r,this.tx=i,this.ty=a,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(e,t){return this.tx=e,this.ty=t,this}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}rotate(e){var t=Math.cos(e),s=Math.sin(e),r=this.a,i=this.c,a=this.tx;return this.a=r*t-this.b*s,this.b=r*s+this.b*t,this.c=i*t-this.d*s,this.d=i*s+this.d*t,this.tx=a*t-this.ty*s,this.ty=a*s+this.ty*t,this._bTransform=!0,this}skew(e,t){var s=Math.sin(e),r=Math.cos(e),i=Math.sin(t),a=Math.cos(t),n=this.a,o=this.c,l=this.tx;return this.a=a*n+s*this.b,this.b=i*n+r*this.b,this.c=a*o+s*this.d,this.d=i*o+r*this.d,this.tx=a*l+s*this.ty,this.ty=i*l+r*this.ty,this._bTransform=!0,this}invertTransformPoint(e){var t=this.a,s=this.b,r=this.c,i=this.d,a=this.tx,n=t*i-s*r,o=i/n,l=-s/n,h=-r/n,d=t/n,u=(r*this.ty-i*a)/n,c=-(t*this.ty-s*a)/n;return e.setTo(o*e.x+h*e.y+u,l*e.x+d*e.y+c)}transformPoint(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}transformPointN(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var e=this.a,t=this.b,s=this.c,r=this.d,i=this.tx,a=e*r-t*s;return this.a=r/a,this.b=-t/a,this.c=-s/a,this.d=e/a,this.tx=(s*this.ty-r*i)/a,this.ty=-(e*this.ty-t*i)/a,this}setTo(e,t,s,r,i,a){return this.a=e,this.b=t,this.c=s,this.d=r,this.tx=i,this.ty=a,this}concat(e){var t=this.a,s=this.c,r=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=s*e.a+this.d*e.c,this.d=s*e.b+this.d*e.d,this.tx=r*e.a+this.ty*e.c+e.tx,this.ty=r*e.b+this.ty*e.d+e.ty,this}static mul(e,t,s){var r=e.a,i=e.b,a=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,d=t.b,u=t.c,c=t.d,_=t.tx,p=t.ty;return 0!==d||0!==u?(s.a=r*h+i*u,s.b=r*d+i*c,s.c=a*h+n*u,s.d=a*d+n*c,s.tx=h*o+u*l+_,s.ty=d*o+c*l+p):(s.a=r*h,s.b=i*c,s.c=a*h,s.d=n*c,s.tx=h*o+_,s.ty=c*l+p),s}static mul16(e,t,s){var r=e.a,i=e.b,a=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,d=t.b,u=t.c,c=t.d,_=t.tx,p=t.ty;return 0!==d||0!==u?(s[0]=r*h+i*u,s[1]=r*d+i*c,s[4]=a*h+n*u,s[5]=a*d+n*c,s[12]=h*o+u*l+_,s[13]=d*o+c*l+p):(s[0]=r*h,s[1]=i*c,s[4]=a*h,s[5]=n*c,s[12]=h*o+_,s[13]=c*l+p),s}scaleEx(e,t){var s=this.a,r=this.b,i=this.c,a=this.d;0!==r||0!==i?(this.a=e*s,this.b=e*r,this.c=t*i,this.d=t*a):(this.a=e*s,this.b=0*a,this.c=0*s,this.d=t*a),this._bTransform=!0}rotateEx(e){var t=Math.cos(e),s=Math.sin(e),r=this.a,i=this.b,a=this.c,n=this.d;0!==i||0!==a?(this.a=t*r+s*a,this.b=t*i+s*n,this.c=-s*r+t*a,this.d=-s*i+t*n):(this.a=t*r,this.b=s*n,this.c=-s*r,this.d=t*n),this._bTransform=!0}clone(){var e=new Ce;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}cloneTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}setMatrix(e,t,s,r,i,a,n,o,l){i=Q.toRadian(i),a=Q.toRadian(a),n=Q.toRadian(n);const h=Math.cos(i),d=Math.sin(i),u=Math.cos(a),c=Math.sin(a),_=Math.cos(n),p=Math.sin(n);return this.a=(h*_-d*p)*s,this.b=(d*_+h*p)*s,this.c=(h*c-d*u)*r,this.d=(d*c+h*u)*r,this.tx=e-this.a*o-this.c*l,this.ty=t-this.b*o-this.d*l,this._checkTransform(),this}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){h.recover("Matrix",this.identity())}static create(){return h.getItemByClass("Matrix",Ce)}}Ce.EMPTY=new Ce,Ce.TEMP=new Ce,Ce._createFun=null;class Re{constructor(e){(null==e||e)&&(this.source=Y.createElement("canvas"))}clear(){this.source&&this.context.clearRect(0,0,this.source.width,this.source.height)}get context(){return this._ctx||(this._ctx=this.source.getContext("2d"))}set context(e){this._ctx=e}size(e,t){this.source&&(this.source.height=t,this.source.width=e)}}const Me="RestoreCmd";class Ae{static create(){return h.getItemByClass(Me,Ae)}recover(){h.recover(Me,this)}run(e){e.restore()}get cmdID(){return Ae.ID}}Ae.ID=Me;class Ie{static scanPList(e,t){let s=Math.floor(e.length/2);Pe.length=s,s>Le.length&&(Le.length=s);for(let t=0;t<s;t++){let s=Le[t]||(Le[t]=new u);s.setTo(e[t+t],e[t+t+1]),Pe[t]=s}let r=Ie.scan(Pe,Pe);(t=t||[]).length=0;for(let e=0,s=r.length;e<s;e++)t.push(r[e].x,r[e].y);return t}static scan(e,t){let s=function(e){Ne.clear(),Be.length=0;for(let t=e.length-1;t>=0;t--){let s=e[t],r=s.x+"_"+s.y;Ne.has(r)||(Ne.add(r),Be.push(s))}return Be}(e),r=s.length,i=0;for(let e=1;e<r;e++)(s[e].y<s[i].y||s[e].y==s[i].y&&s[e].x<s[i].x)&&(i=e);let a=s[0];s[0]=s[i],s[i]=a;for(let e=1;e<r-1;e++){i=e;for(let t=e+1;t<r;t++)(Fe(s[t],s[i],s[0])>0||0==Fe(s[t],s[i],s[0])&&Oe(s[0],s[t])<Oe(s[0],s[i]))&&(i=t);let t=s[e];s[e]=s[i],s[i]=t}if((t=t||[]).length=0,s.length<3)return t.push(...s),t;t.push(s[0],s[1],s[2]);for(let e=3;e<r;e++){for(;t.length>=2&&Fe(s[e],t[t.length-1],t[t.length-2])>=0;)t.pop();t.push(s[e])}return t}}const Pe=[],Be=[],Le=[],Ne=new Set;function Fe(e,t,s){return(e.x-s.x)*(t.y-s.y)-(t.x-s.x)*(e.y-s.y)}function Oe(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}const Ue="SaveCmd";class ke{static create(){return h.getItemByClass(Ue,ke)}recover(){h.recover(Ue,this)}run(e){e.save()}get cmdID(){return ke.ID}}ke.ID=Ue;class Ve{destroy(){this._cached=!1,this._bounds=null,this._bound2=null,h.recover("GraphicsBounds",this)}static create(){return h.getItemByClass("GraphicsBounds",Ve)}reset(){this._cached=!1}getBounds(e){return this._cached||(e._useSpriteRect?(this._bounds=(this._bounds||new te).setTo(0,0,e.owner.width,e.owner.height),this._bound2=this._bounds.getBoundPoints(this._bound2)):(this._bound2=this._getCmdPoints(e),this._bounds=te._getWrapRec(this._bound2,this._bounds)),this._cached=!0),this._bounds}getBoundPoints(e){return this.getBounds(e),this._bound2}_getCmdPoints(e){let t=this._bound2||(this._bound2=[]);t.length=0;let s=e.cmds,r=e.owner;if(0==s.length)return t;Ge.allPoints=t,Ge.width=r._width,Ge.height=r._height,Ge.matrix.identity();let i=He;i.length=0;for(let e=0,t=s.length;e<t;e++){let t=s[e];switch(t.cmdID){case ke.ID:i.push(Ge.matrix),Ge.matrix=Ge.matrix.clone();break;case Ae.ID:Ge.matrix=i.pop();break;default:Ge.points.length=0,t.getBounds?t.getBounds(Ge):We.setTo(r.x,r.y,r._width,r._height).getBoundPoints(Ge.points),Ge.points.length>0&&Ge.flushPoints()}}if(t.length>200){let e=te._getWrapRec(t,We);t.length=0,e.getBoundPoints(t)}else t.length>8&&Ie.scanPList(t,t);return t}}const Ge=new class{constructor(){this.points=[],this.matrix=new Ce}flushPoints(e,t,s){null==e&&(e=0),null==t&&(t=0),s?(this.matrix.copyTo(ze),ze.concat(s),s=ze):s=this.matrix;let r=this.points.length,i=u.TEMP;for(let a=0;a<r;a+=2)i.setTo(this.points[a]+e,this.points[a+1]+t),null==i.x&&(i.x=0),null==i.y&&(i.y=0),s.transformPoint(i),this.allPoints.push(i.x,i.y);this.points.length=0}concatMatrix(e){e.copyTo(ze),ze.concat(this.matrix),ze.copyTo(this.matrix)}},ze=new Ce,He=[],We=new te;var Xe,Ye,qe,je,Ke;class $e{}Xe=$e,$e.TEXT=1,$e.AREA2D=2,$e.CANVAS=8,$e.POSTPROCESS=16,$e.MASK=32,$e.CLIP=64,$e.GRAPHICS=256,$e.RENDERNODE2D=2048,$e.DRAW2RT=Xe.CANVAS|Xe.POSTPROCESS|Xe.MASK,$e.UPDATETRANS=Xe.CANVAS|Xe.POSTPROCESS|Xe.MASK|Xe.CLIP|Xe.GRAPHICS|Xe.RENDERNODE2D,e.RepaintFlag=void 0,(Ye=e.RepaintFlag||(e.RepaintFlag={}))[Ye.Normal=0]="Normal",Ye[Ye.Size=1]="Size",Ye[Ye.Graphics=2]="Graphics",Ye[Ye.ChildChange=4]="ChildChange",Ye[Ye.UpdateRT=7]="UpdateRT",e.TransformKind=void 0,(qe=e.TransformKind||(e.TransformKind={}))[qe.Pos=1]="Pos",qe[qe.Width=2]="Width",qe[qe.Height=4]="Height",qe[qe.Anchor=8]="Anchor",qe[qe.Scale=16]="Scale",qe[qe.Skew=32]="Skew",qe[qe.Rotation=64]="Rotation",qe[qe.Matrix=128]="Matrix",qe[qe.Size=6]="Size",qe[qe.Layout=30]="Layout",qe[qe.TRS=113]="TRS",e.BaseRender2DType=void 0,(je=e.BaseRender2DType||(e.BaseRender2DType={}))[je.empty=-1]="empty",je[je.baseRenderNode=0]="baseRenderNode",je[je.spine=1]="spine",je[je.particle=2]="particle",je[je.spineSimple=3]="spineSimple",je[je.graphics=4]="graphics",e.SubPassFlag=void 0,(Ke=e.SubPassFlag||(e.SubPassFlag={}))[Ke.PostProcess=1]="PostProcess",Ke[Ke.CacheAsBitmap=2]="CacheAsBitmap",Ke[Ke.Mask=4]="Mask",Ke[Ke.RenderTexture=8]="RenderTexture",Ke[Ke.UPDATE_POSTPROCESS=9]="UPDATE_POSTPROCESS";const Qe="AlphaCmd";class Ze{static create(e){var t=h.getItemByClass(Qe,Ze);return t.alpha=e,t}recover(){h.recover(Qe,this)}run(e,t,s){e.alpha(this.alpha)}getBounds(e){}get cmdID(){return Ze.ID}}Ze.ID=Qe;const Je="ClipRectCmd";class et{static create(e,t,s,r){var i=h.getItemByClass(Je,et);return i.x=e,i.y=t,i.width=s,i.height=r,i}recover(){h.recover(Je,this)}run(e,t,s){e.clipRect(this.x+t,this.y+s,this.width,this.height)}get cmdID(){return et.ID}}et.ID=Je;const tt=[-1,0,-1,2,4,3,-1,1,-1],st=[4,0,1,1,5,4,5,1,2,2,6,5,6,2,3,3,7,6,8,4,5,5,9,8,9,5,6,6,10,9,10,6,7,7,11,10,12,8,9,9,13,12,13,9,10,10,14,13,14,10,11,11,15,14],rt=[0,0,0,0],it=[0,0,0,0],at=[0,0,0,0],nt=[0,0,0,0];function ot(e,t,s,r,i){const a=e.mainTex.sourceWidth,n=e.mainTex.sourceHeight,o=s.width/a,l=s.height/n,h=r.right,d=r.bottom;if(rt.length=0,rt.push(s.x,s.x+r.x*o,s.x+h*o,s.right),it.length=0,it.push(s.y,s.y+r.y*l,s.y+d*l,s.bottom),at[0]=t.x,t.width>=a-r.width)at[1]=at[0]+r.x,at[2]=t.right-(a-h),at[3]=t.right;else{const e=r.x/(a-h),s=at[0]+t.width*e/(1+e);at[1]=s,at[2]=s,at[3]=t.right}if(nt[0]=t.y,t.height>=n-r.height)nt[1]=nt[0]+r.y,nt[2]=t.bottom-(n-d),nt[3]=t.bottom;else{const e=r.y/(n-d),s=nt[0]+t.height*e/(1+e);nt[1]=s,nt[2]=s,nt[3]=t.bottom}if(0===i){for(let t=0;t<4;t++)for(let s=0;s<4;s++)e.addVert(at[s],nt[t],null,rt[s],it[t]);e.addTriangles(st)}else{const t=te.create(),s=te.create();let a=e.vertCount;for(let n=0;n<9;n++){const o=n%3,l=Math.floor(n/3),h=tt[n];te.minMaxRect(at[o],nt[l],at[o+1],nt[l+1],t),te.minMaxRect(rt[o],it[l],rt[o+1],it[l+1],s),-1!==h&&i&1<<h?(a!==e.vertCount&&e.triangulateQuad(a),lt(e,t,s,0===h||1===h||4===h?r.width:t.width,2===h||3===h||4===h?r.height:t.height,!0,!0),a=e.vertCount):e.addQuad(t,null,s)}a!==e.vertCount&&e.triangulateQuad(a),t.recover(),s.recover()}}function lt(e,t,s,r,i,a,n){let o=a?Math.ceil(t.width/r)-1:0,l=n?Math.ceil(t.height/i)-1:0,h=t.width-o*r,d=t.height-l*i;const u=te.create(),c=te.create();let _=e.vertCount;for(let _=0;_<=o;_++)for(let p=0;p<=l;p++)u.setTo(t.x+_*r,t.y+p*i,_<o?r:h,p<l?i:d),c.setTo(s.x,s.y,_<o||!a?s.width:s.width*h/r,p<l||!n?s.height:s.height*d/i),e.addQuad(u,null,c);e.triangulateQuad(_),u.recover(),c.recover()}class ht{constructor(e){if(this.arrColor=[],null==e||"none"==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);dt.parse(e),this.strColor="string"==typeof e?e:dt.getStyleString(),dt.writeTo(this.arrColor),this.numColor=dt.getABGR()}static _initSaveMap(){ht._SAVE_SIZE=0,ht._SAVE={}}static create(e){let t=e+"",s=ht._SAVE[t];return null!=s?s:(ht._SAVE_SIZE>500&&ht._initSaveMap(),ht._SAVE_SIZE++,ht._SAVE[t]=new ht(e))}}ht._SAVE={},ht._SAVE_SIZE=0;const dt=new y;class ut{static lerp(e,t,s){return e*(1-s)+t*s}static repeat(e,t){return e-Math.floor(e/t)*t}static distance(e,t,s,r){return Math.sqrt(Math.pow(e-s,2)+Math.pow(t-r,2))}static clamp(e,t,s){return e<t?e=t:e>s&&(e=s),e}static clamp01(e){return isNaN(e)?e=0:e>1?e=1:e<0&&(e=0),e}static slerpQuaternionArray(e,t,s,r,i,a,n){var o,l,h,d,u,c=e[t+0],_=e[t+1],p=e[t+2],g=e[t+3],m=s[r+0],f=s[r+1],T=s[r+2],y=s[r+3];return(l=c*m+_*f+p*T+g*y)<0&&(l=-l,m=-m,f=-f,T=-T,y=-y),1-l>1e-6?(o=Math.acos(l),h=Math.sin(o),d=Math.sin((1-i)*o)/h,u=Math.sin(i*o)/h):(d=1-i,u=i),a[n+0]=d*c+u*m,a[n+1]=d*_+u*f,a[n+2]=d*p+u*T,a[n+3]=d*g+u*y,a}static getRotation(e,t,s,r){return Math.atan2(r-t,s-e)/Math.PI*180}static sortBigFirst(e,t){return e==t?0:t>e?1:-1}static sortSmallFirst(e,t){return e==t?0:t>e?-1:1}static sortNumBigFirst(e,t){return parseFloat(t)-parseFloat(e)}static sortNumSmallFirst(e,t){return parseFloat(e)-parseFloat(t)}static sortByKey(e,t=!1,s=!0){var r;return r=t?s?ut.sortNumBigFirst:ut.sortBigFirst:s?ut.sortNumSmallFirst:ut.sortSmallFirst,function(t,s){return r(t[e],s[e])}}static roundTo(e,t=3,s=1e-6){if(!isFinite(e))return e;const r=Math.pow(10,t),i=Math.round(e*r)/r;return Math.abs(i)<s?0:i}}class ct{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){return this.x=e,this.y=t,this}static scale(e,t,s){s.x=e.x*t,s.y=e.y*t}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}toArray(){return[this.x,this.y]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y}cloneTo(e){return e.x=this.x,e.y=this.y,e}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var s=e.x,r=e.y,i=s*s+r*r;i>0&&(i=1/Math.sqrt(i),t.x=s*i,t.y=r*i)}static scalarLength(e){var t=e.x,s=e.y;return Math.sqrt(t*t+s*s)}static distance(e,t){let s=e.x-t.x,r=e.y-t.y;return Math.sqrt(s*s+r*r)}clone(){var e=new ct;return this.cloneTo(e),e}}ct.ZERO=new ct(0,0),ct.ONE=new ct(1,1),ct.TEMP=new ct;class _t{constructor(){this._vp=0,this._ip=0,this.contentRect=new te,this.uvRect=new te,this.color=new y,this._vertices=this.resizeBuf(Float32Array,20),this._uvs=this.resizeBuf(Float32Array,20),this._colors=this.resizeBuf(Float32Array,40),this._indices=this.resizeBuf(Uint16Array,30),this._vec=new ct}init(e){if(this.mainTex=e,e){let t=e.uvrect;if(e.width===e.sourceWidth&&e.height===e.sourceHeight)this.uvRect.setTo(t[0],t[1],t[2],t[3]);else{let s=t[2]/e.width,r=t[3]/e.height;this.uvRect.setTo(t[0]-e.offsetX*s,t[1]-e.offsetY*r,e.sourceWidth*s,e.sourceHeight*r)}}else this.uvRect.setTo(0,0,1,1);this.color.setValue(1,1,1,1),this._vp=0,this._ip=0}addVert(e,t,s,r,i){this.checkVBuf(2);let a=this._vp;this._vp+=2,this._vertices[a]=e,this._vertices[a+1]=t,this._uvs[a]=null!=r?r:ut.lerp(this.uvRect.x,this.uvRect.right,(e-this.contentRect.x)/(this.contentRect.width||1)),this._uvs[a+1]=null!=i?i:ut.lerp(this.uvRect.y,this.uvRect.bottom,(t-this.contentRect.y)/(this.contentRect.height||1)),(s||this.color).writeTo(this._colors,2*a)}addQuad(e,t,s){s?(this.addVert(e.x,e.y,t,s.x,s.y),this.addVert(e.right,e.y,t,s.right,s.y),this.addVert(e.right,e.bottom,t,s.right,s.bottom),this.addVert(e.x,e.bottom,t,s.x,s.bottom)):(this.addVert(e.x,e.y,t),this.addVert(e.right,e.y,t),this.addVert(e.right,e.bottom,t),this.addVert(e.x,e.bottom,t))}addTriangle(e,t,s){this.checkIBuf(3);let r=this._ip;this._ip+=3,this._indices[r]=e,this._indices[r+1]=t,this._indices[r+2]=s}addTriangles(e){this.checkIBuf(e.length);let t=this._indices,s=this._ip,r=e.length;this._ip+=r;for(let i=0;i<r;i++)t[s+i]=e[i]}triangulateQuad(e){let t=this._vp/2;e<0&&(e=t+e);let s=(t-e)/4*6;this.checkIBuf(s);let r=this._indices;for(let s=e,i=this._ip;s<t;s+=4,i+=6)r[i]=s,r[i+1]=s+1,r[i+2]=s+2,r[i+3]=s+2,r[i+4]=s+3,r[i+5]=s;this._ip+=s}getPos(e){return e<0&&(e=this._vp/2+e),e*=2,this._vec.setValue(this._vertices[e],this._vertices[e+1]),this._vec}get vertCount(){return this._vp/2}getVertices(){return new Float32Array(this._vertices.buffer,0,this._vp)}getUVs(){return new Float32Array(this._uvs.buffer,0,this._vp)}getColors(){return new Float32Array(this._colors.buffer,0,2*this._vp)}getIndices(){return new Uint16Array(this._indices.buffer,0,this._ip)}checkVBuf(e){if(this._vp+e<this._vertices.length)return;let t=this._vp+Math.max(20,e);this._vertices=this.resizeBuf(Float32Array,t,this._vertices),this._uvs=this.resizeBuf(Float32Array,t,this._uvs),this._colors=this.resizeBuf(Float32Array,2*t,this._colors)}checkIBuf(e){if(this._ip+e<this._indices.length)return;let t=this._ip+Math.max(30,e);this._indices=this.resizeBuf(Uint16Array,t,this._indices)}resizeBuf(e,t,s){let r=new e(new ArrayBuffer(e.BYTES_PER_ELEMENT*t));return s&&r.set(s),r}}_t.pool=h.createPool(_t,(e,t)=>e.init(t));const pt="Draw9GridTextureCmd";class gt{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.color=4294967295,this.percent=!0}static create(e,t,s,r,i,a,n,o){let l=h.getItemByClass(pt,gt);return l.texture=e,e._addReference(),l.x=t,l.y=s,l.width=r,l.height=i,l.sizeGrid=a,l.percent=n,l.color=null!=o?ht.create(o).numColor:4294967295,l}recover(){var e;null===(e=this.texture)||void 0===e||e._removeReference(),this.texture=null,h.recover(pt,this)}run(e,t,s){if(this.texture){let r=this.sizeGrid||this.texture._sizeGrid||mt,i=this.x,a=this.y,n=this.width,o=this.height;this.percent&&e.sprite&&(i*=e.sprite.width,a*=e.sprite.height,n*=e.sprite.width,o*=e.sprite.height);let l=_t.pool.take(this.texture);l.contentRect.setTo(0,0,n,o),this.color&&l.color.setABGR(this.color);let h=te.create(),d=l.mainTex.sourceWidth,u=l.mainTex.sourceHeight;h.setTo(r[3],r[0],d-r[1]-r[3],u-r[0]-r[2]),ot(l,l.contentRect,l.uvRect,h,1===r[4]?255:0),e.drawTriangles(this.texture,i+t,a+s,l.getVertices(),l.getUVs(),l.getIndices(),null,1,null,null,l.getColors(),this.texture.uvrect),_t.pool.recover(l)}}get cmdID(){return gt.ID}getBounds(e){let t=te.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}}gt.ID=pt;const mt=[0,0,0,0,0];Ee.regClass(pt,gt);const ft="DrawCircleCmd";class Tt{constructor(){this.lineWidth=0}static create(e,t,s,r,i,a,n){var o=h.getItemByClass(ft,Tt);return o.x=e,o.y=t,o.radius=s,o.fillColor=r,o.lineColor=i,o.lineWidth=a,o.percent=n,o}recover(){this.fillColor=null,this.lineColor=null,h.recover(ft,this)}run(e,t,s){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let i=e.sprite.width,a=e.sprite.height;e._drawCircle(this.x*i+t,this.y*a+s,this.radius*Math.min(i,a)-r,this.fillColor,this.lineColor,this.lineWidth,0)}else e._drawCircle(this.x+t,this.y+s,this.radius-r,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return Tt.ID}getBounds(e){let t=te.TEMP.setTo(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius);this.percent&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}}Tt.ID=ft,Ee.regClass(ft,Tt);class yt{static getPoints(e,t=5,s=2,r){r=r||[];let i=e.length;if(i<2*(s+1))return r;switch(s){case 2:St=wt;break;case 3:St=bt;break;default:return[]}for(;xt.length<=s;)xt.push(new u);for(let t=0;t<2*s;t+=2)Dt(e[t],e[t+1]);for(let a=2*s;a<i;a+=2)Dt(e[a],e[a+1]),a/2%s==0&&Ct(t,r);return r}static getRate(e,t,s,r,i){let a,n=function(e,t,s,r){return 100*(100*(100*(100*e+t)+s)+r)}(t,s,r,i),o=100*n+e;if(Et[o])return Et[o];var l;vt[n]?a=vt[n]:(l=[0,0,t,s,r,i,1,1],a=yt.getPoints(l,100,3),vt[n]=a);let h=a.length;for(let t=0;t<h;t+=2)if(e<=a[t])return Et[o]=a[t+1],a[t+1];return Et[o]=1,1}}const xt=[new u,new u,new u];var St=wt;const Et={},vt={};function Dt(e,t){let s=xt.pop();s.setTo(e,t),xt.unshift(s)}function wt(e,t){var s=xt[2],r=xt[1],i=xt[0],a=Math.pow(1-e,2)*s.x+2*e*(1-e)*r.x+Math.pow(e,2)*i.x,n=Math.pow(1-e,2)*s.y+2*e*(1-e)*r.y+Math.pow(e,2)*i.y;t.push(a,n)}function bt(e,t){var s=xt[3],r=xt[2],i=xt[1],a=xt[0],n=Math.pow(1-e,3)*s.x+3*r.x*e*(1-e)*(1-e)+3*i.x*e*e*(1-e)+a.x*Math.pow(e,3),o=Math.pow(1-e,3)*s.y+3*r.y*e*(1-e)*(1-e)+3*i.y*e*e*(1-e)+a.y*Math.pow(e,3);t.push(n,o)}function Ct(e,t){var s,r;for(r=1/(e=e>0?e:5),s=0;s<=1;s+=r)St(s,t)}const Rt="DrawCurvesCmd";class Mt{static create(e,t,s,r,i){var a=h.getItemByClass(Rt,Mt);return a.x=e,a.y=t,a.points=s,a.lineColor=r,a.lineWidth=i,a}recover(){this.points=null,this.lineColor=null,h.recover(Rt,this)}run(e,t,s){this.points&&e.drawCurves(this.x+t,this.y+s,this.points,this.lineColor,this.lineWidth)}get cmdID(){return Mt.ID}getBounds(e){yt.getPoints(this.points,5,2,e.points),e.flushPoints(this.x,this.y)}}Mt.ID=Rt,Ee.regClass(Rt,Mt);const At="DrawImageCmd";class It{constructor(){this.color=4294967295}static create(e,t,s,r,i,a){let n=h.getItemByClass(At,It);return n.texture=e,e&&e._addReference(),n.x=null!=t?t:0,n.y=null!=s?s:0,n.width=null!=r?r:e.sourceWidth,n.height=null!=i?i:e.sourceHeight,n.color=null!=a?ht.create(a).numColor:4294967295,n}recover(){this.texture&&this.texture._removeReference(),this.texture=null,h.recover(At,this)}run(e,t,s){let r=this.texture;if(!r)return;let i=this.x,a=this.y,n=this.width,o=this.height,l=n/r.sourceWidth,h=o/r.sourceHeight;n=r.width*l,o=r.height*h,i+=r.offsetX*l,a+=r.offsetY*h,e.drawTexture(this.texture,i+t,a+s,n,o,this.color)}getBounds(e){te.TEMP.setTo(this.x,this.y,this.width,this.height).getBoundPoints(e.points)}get cmdID(){return It.ID}}It.ID=At;const Pt="DrawLineCmd";class Bt{constructor(){this.lineWidth=0}static create(e,t,s,r,i,a,n){var o=h.getItemByClass(Pt,Bt);return o.fromX=e,o.fromY=t,o.toX=s,o.toY=r,o.lineColor=i,o.lineWidth=a,o.percent=n,o}recover(){h.recover(Pt,this)}run(e,t,s){let r=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&e.sprite){let i=e.sprite.width,a=e.sprite.height;e._drawLine(t,s,this.fromX*i+r,this.fromY*a+r,this.toX*i+r,this.toY*a+r,this.lineColor,this.lineWidth,0)}else e._drawLine(t,s,this.fromX+r,this.fromY+r,this.toX+r,this.toY+r,this.lineColor,this.lineWidth,0)}get cmdID(){return Bt.ID}getBounds(e){let t;t=.5*this.lineWidth;let s=this.fromX,r=this.fromY,i=this.toX,a=this.toY;this.percent&&(s*=e.width,r*=e.height,i*=e.width,a*=e.height),s==i?e.points.push(s+t,r,i+t,a,s-t,r,i-t,a):r==a?e.points.push(s,r+t,i,a+t,s,r-t,i,a-t):e.points.push(s,r,i,a)}}Bt.ID=Pt,Ee.regClass(Pt,Bt);const Lt="DrawLinesCmd";class Nt{constructor(){this.lineWidth=0}static create(e,t,s,r,i){var a=h.getItemByClass(Lt,Nt);return a.x=e,a.y=t,a.points=s,a.lineColor=r,a.lineWidth=i,a}recover(){this.points=null,this.lineColor=null,h.recover(Lt,this)}run(e,t,s){let r=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&e._drawLines(this.x+r+t,this.y+r+s,this.points,this.lineColor,this.lineWidth,0)}getBounds(e){e.points.push(...this.points),e.flushPoints(this.x,this.y)}get cmdID(){return Nt.ID}}Nt.ID=Lt,Ee.regClass(Lt,Nt);const Ft="DrawPathCmd";class Ot{static create(e,t,s,r,i){var a=h.getItemByClass(Ft,Ot);return a.x=e,a.y=t,a.paths=s,a.brush=r,a.pen=i,a}recover(){this.paths=null,this.brush=null,this.pen=null,h.recover(Ft,this)}run(e,t,s){this.paths&&e._drawPath(this.x+t,this.y+s,this.paths,this.brush,this.pen)}get cmdID(){return Ot.ID}getBounds(e){let t=this.paths,s=t.length;for(let r=0;r<s;r++){let s=t[r];s.length>1&&(e.points.push(s[1],s[2]),s.length>3&&e.points.push(s[3],s[4]))}e.flushPoints(this.x,this.y)}}Ot.ID=Ft,Ee.regClass(Ft,Ot);const Ut="DrawPieCmd";class kt{constructor(){this.radius=0,this.lineWidth=0}static create(e,t,s,r,i,a,n,o){var l=h.getItemByClass(Ut,kt);return l.x=e,l.y=t,l.radius=s,l._startAngle=r,l._endAngle=i,l.fillColor=a,l.lineColor=n,l.lineWidth=o,l}recover(){this.fillColor=null,this.lineColor=null,h.recover(Ut,this)}run(e,t,s){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,i=this.lineColor?this.lineWidth:0;e._drawPie(this.x+r+t,this.y+r+s,this.radius-i,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return kt.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(e){this._startAngle=e*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(e){this._endAngle=e*Math.PI/180}getBounds(e){let t=e.points,s=Math.PI/180,r=this.endAngle-this.startAngle,i=this.x,a=this.y,n=this.radius;if(r>=360||r<=-360)return t.push(i-n,a-n),t.push(i+n,a-n),t.push(i+n,a+n),void t.push(i-n,a+n);t.push(i,a);var o=r%360;o<0&&(o+=360);var l=this.startAngle+o,h=this.startAngle*s,d=l*s;t.push(i+n*Math.cos(h),a+n*Math.sin(h)),t.push(i+n*Math.cos(d),a+n*Math.sin(d));for(var u=90*Math.ceil(this.startAngle/90),c=90*Math.floor(l/90),_=u;_<=c;_+=90){var p=_*s;t.push(i+n*Math.cos(p),a+n*Math.sin(p))}}}kt.ID=Ut,Ee.regClass(Ut,kt);const Vt="DrawPolyCmd";class Gt{static create(e,t,s,r,i,a){var n=h.getItemByClass(Vt,Gt);return n.x=e,n.y=t,n.points=s,n.fillColor=r,n.lineColor=i,n.lineWidth=a,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,h.recover(Vt,this)}run(e,t,s){let r=this.points.length<=6,i=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&e._drawPoly(this.x+i+t,this.y+i+s,this.points,this.fillColor,this.lineColor,this.lineWidth,r,0)}getBounds(e){e.points.push(...this.points),e.flushPoints(this.x,this.y)}get cmdID(){return Gt.ID}}Gt.ID=Vt,Ee.regClass(Vt,Gt);const zt="DrawRectCmd";class Ht{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.lineWidth=0,this.percent=!0}static create(e,t,s,r,i,a,n,o){var l=h.getItemByClass(zt,Ht);return l.x=e,l.y=t,l.width=s,l.height=r,l.fillColor=i,l.lineColor=a,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,h.recover(zt,this)}run(e,t,s){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,i=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let a=e.sprite.width,n=e.sprite.height;e.drawRect(this.x*a+r+t,this.y*n+r+s,this.width*a-i,this.height*n-i,this.fillColor,this.lineColor,this.lineWidth)}else e.drawRect(this.x+r+t,this.y+r+s,this.width-i,this.height-i,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Ht.ID}getBounds(e){let t=te.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}}Ht.ID=zt,Ee.regClass(zt,Ht);const Wt="DrawTextureCmd";class Xt{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.percent=!0,this.alpha=1,this.color=4294967295,this.uv=null}static create(e,t,s,r,i,a,n,o,l,d,u){let c=h.getItemByClass(Wt,Xt);return c.texture=e,e&&e._addReference(),c.x=null!=t?t:0,c.y=null!=s?s:0,c.width=null!=r?r:e.sourceWidth,c.height=null!=i?i:e.sourceHeight,c.percent=u,c.matrix=a,c.alpha=null!=n?n:1,c.blendMode=l,c.uv=d,c.color=null!=o?ht.create(o).numColor:4294967295,c}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,h.recover(Wt,this)}run(e,t,s){let r=this.texture;if(!r)return;let i=this.x,a=this.y,n=this.width,o=this.height;this.percent&&e.sprite&&(i*=e.sprite.width,a*=e.sprite.height,n*=e.sprite.width,o*=e.sprite.height);let l=n/r.sourceWidth,h=o/r.sourceHeight;n=r.width*l,o=r.height*h,i+=r.offsetX*l,a+=r.offsetY*h,e.drawTextureWithTransform(this.texture,i,a,n,o,this.matrix,t,s,this.alpha,this.blendMode,this.uv,this.color)}getBounds(e){let t=te.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}get cmdID(){return Xt.ID}}Xt.ID=Wt,Ee.regClass(Wt,Xt);const Yt="DrawTexturesCmd";class qt{static create(e,t,s){var r=h.getItemByClass(Yt,qt);return r.texture=e,e._addReference(),r.pos=t,r.colors=s||[],r}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,h.recover(Yt,this)}run(e,t,s){e.drawTextures(this.texture,this.pos,t,s,this.colors)}getBounds(e){if(this.texture){let t=this.texture.width,s=this.texture.height;for(let r=0,i=this.pos.length;r<i;r+=2){let i=this.pos[r],a=this.pos[r+1];te.TEMP.setTo(i,a,t,s).getBoundPoints(e.points)}}}get cmdID(){return qt.ID}}qt.ID=Yt;const jt="DrawTrianglesCmd";class Kt{constructor(){this.x=0,this.y=0}static create(e,t,s,r,i,a,n,o,l,d){var u=h.getItemByClass(jt,Kt);return u.texture=e,null==e||e._addReference(),u.x=t,u.y=s,u.vertices=r,u.uvs=i,u.indices=a,u.matrix=n,u.alpha=null!=o?o:1,u.color=null!=l?ht.create(l).numColor:4294967295,u.blendMode=d,u}static create2(e,t,s){var r=h.getItemByClass(jt,Kt);return r.texture=e,null==e||e._addReference(),r.x=0,r.y=0,r.mesh=t,r.color=null!=s?ht.create(s).numColor:4294967295,r}recover(){var e;null===(e=this.texture)||void 0===e||e._removeReference(),this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,this.mesh=null,h.recover(jt,this)}run(e,t,s){var r;if(this.mesh){let i=_t.pool.take(this.texture);i.contentRect.setTo(0,0,e.sprite.width,e.sprite.height),this.color&&i.color.setABGR(this.color);try{this.mesh.onPopulateMesh(i)}catch(e){console.error(e)}e.drawTriangles(this.texture,this.x+t,this.y+s,i.getVertices(),i.getUVs(),i.getIndices(),this.matrix,this.alpha,this.blendMode,null,i.getColors(),null===(r=this.texture)||void 0===r?void 0:r.uvrect),_t.pool.recover(i)}else this.vertices&&this.uvs&&this.indices&&e.drawTriangles(this.texture,this.x+t,this.y+s,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return Kt.ID}getBounds(e){te.TEMP.setTo(0,0,e.width,e.height).getBoundPoints(e.points)}}Kt.ID=jt,Ee.regClass(jt,Kt);class $t{static getSystemEndian(){if(!$t._sysEndian){let e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),$t._sysEndian=256===new Int16Array(e)[0]?$t.LITTLE_ENDIAN:$t.BIG_ENDIAN}return $t._sysEndian}constructor(e){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){let e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}get rawBuffer(){return this._d_.buffer}get endian(){return this._xd_?$t.LITTLE_ENDIAN:$t.BIG_ENDIAN}set endian(e){this._xd_=e===$t.LITTLE_ENDIAN}set length(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e}get length(){return this._length}_resizeBuffer(e){try{let t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw new Error("Invalid typed array length:"+e)}}readString(){return this._rUTF(this.readUint16())}readTypedArray(e,t,s){let r=e+t;r=r>this._length?this._length:r;let i=new s(this._d_.buffer.slice(e,r));return this._pos_=r,i}readFloat32Array(e,t){return this.readTypedArray(e,t,Float32Array)}readUint8Array(e,t){return this.readTypedArray(e,t,Uint8Array)}readInt8Array(e,t){return this.readTypedArray(e,t,Int8Array)}readInt16Array(e,t){return this.readTypedArray(e,t,Int16Array)}readFloat32(){if(this._pos_+4>this._length)throw new R(this._pos_+4);var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}readFloat64(){if(this._pos_+8>this._length)throw new R(this._pos_+8);var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}writeFloat32(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}writeFloat64(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}readInt32(){if(this._pos_+4>this._length)throw new R(this._pos_+4);var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}readUint32(){if(this._pos_+4>this._length)throw new R(this._pos_+4);var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}writeInt32(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}writeUint32(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}readInt16(){if(this._pos_+2>this._length)throw new R(this._pos_+2);var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}readUint16(){if(this._pos_+2>this._length)throw new R(this._pos_+2);var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}writeUint16(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}writeInt16(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}readUint8(){if(this._pos_+1>this._length)throw new R(this._pos_+1);return this._u8d_[this._pos_++]}writeUint8(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}_getMatrix(){return this._readMatrix()}_readMatrix(){return new Ce(this.readFloat32(),this.readFloat32(),this.readFloat32(),this.readFloat32(),this.readFloat32(),this.readFloat32())}_rUTF(e){let t,s,r,i=this._pos_+e,a=String.fromCharCode,n=this._u8d_,o=[],l=0;for(o.length=1e3;this._pos_<i;)if(t=n[this._pos_++],t<128)0!=t&&(o[l++]=a(t));else if(t<224)o[l++]=a((63&t)<<6|127&n[this._pos_++]);else if(t<240)s=n[this._pos_++],o[l++]=a((31&t)<<12|(127&s)<<6|127&n[this._pos_++]);else{s=n[this._pos_++],r=n[this._pos_++];const e=(15&t)<<18|(127&s)<<12|(127&r)<<6|127&n[this._pos_++];if(e>=65536){const t=e-65536,s=55296|t>>10,r=56320|1023&t;o[l++]=a(s),o[l++]=a(r)}else o[l++]=a(e)}return o.length=l,o.join("")}readCustomString(e){for(var t,s="",r=0,i=String.fromCharCode,a=this._u8d_;e>0;)if((t=a[this._pos_])<128)s+=i(t),this._pos_++,e--;else for(r=t-128,this._pos_++,e-=r;r>0;)t=a[this._pos_++],s+=i(a[this._pos_++]<<8|t),r--;return s}get pos(){return this._pos_}set pos(e){this._pos_=e}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}writeUTFBytes(e){for(var t=0,s=(e+="").length;t<s;t++){var r=e.charCodeAt(t);if(r<=127)this.writeByte(r);else if(r<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|r>>6,128|63&r],this._pos_),this._pos_+=2;else if(r>=55296&&r<=56319){t++;const s=e.charCodeAt(t);if(!Number.isNaN(s)&&s>=56320&&s<=57343){const e=64+(1023&r),t=1023&s,i=240|e>>8&63,a=128|e>>2&63,n=128|(3&e)<<4|t>>6&15,o=128|63&t;this._ensureWrite(this._pos_+4),this._u8d_.set([i,a,n,o],this._pos_),this._pos_+=4}}else r<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|r>>12,128|r>>6&63,128|63&r],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r],this._pos_),this._pos_+=4)}}writeUTFString(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var s=this.pos-t-2;this._d_.setUint16(t,s,this._xd_)}writeUTFString32(e){var t=this.pos;this.writeUint32(1),this.writeUTFBytes(e);var s=this.pos-t-4;this._d_.setUint32(t,s,this._xd_)}readUTFString(){return this.readUTFBytes(this.readUint16())}readUTFString32(){return this.readUTFBytes(this.readUint32())}readUTFBytes(e){if(null==e&&(e=-1),0===e)return"";var t=this.bytesAvailable;if(e>t)throw new R(this._pos_+e);return e=e>0?e:t,this._rUTF(e)}writeByte(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw new R(this._pos_+1);return this._d_.getInt8(this._pos_++)}_ensureWrite(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}writeArrayBuffer(e,t,s){if(null==t&&(t=0),null==s&&(s=0),t<0||s<0)throw new R(t+s);0==s&&(s=e.byteLength-t),this._ensureWrite(this._pos_+s);let r=new Uint8Array(e);this._u8d_.set(r.subarray(t,t+s),this._pos_),this._pos_+=s}readArrayBuffer(e){let t=this._u8d_.buffer.slice(this._pos_,this._pos_+e);return this._pos_=this._pos_+e,t}__getBuffer(){return this._d_.buffer}getByte(){return this.readByte()}getUint8(){return this.readUint8()}getInt16(){return this.readInt16()}getUint16(){return this.readUint16()}getInt32(){return this.readInt32()}getUint32(){return this.readUint32()}getFloat32(){return this.readFloat32()}getFloat64(){return this.readFloat64()}getUint8Array(e,t){return this.readUint8Array(e,t)}getInt16Array(e,t){return this.readInt16Array(e,t)}getFloat32Array(e,t){return this.readFloat32Array(e,t)}getUTFString(){return this.readUTFString()}getString(){return this.readString()}getCustomString(e){return this.readCustomString(e)}getUTFBytes(e=-1){return this.readUTFBytes(e)}}$t.BIG_ENDIAN="bigEndian",$t.LITTLE_ENDIAN="littleEndian",$t._sysEndian=null;class Qt{static __init__(){for(var e=0;e<256;++e){var t=e-127;t<-27?(ts[0|e]=0,ts[256|e]=32768,ss[0|e]=24,ss[256|e]=24):t<-14?(ts[0|e]=1024>>-t-14,ts[256|e]=1024>>-t-14|32768,ss[0|e]=-t-1,ss[256|e]=-t-1):t<=15?(ts[0|e]=t+15<<10,ts[256|e]=t+15<<10|32768,ss[0|e]=13,ss[256|e]=13):t<128?(ts[0|e]=31744,ts[256|e]=64512,ss[0|e]=24,ss[256|e]=24):(ts[0|e]=31744,ts[256|e]=64512,ss[0|e]=13,ss[256|e]=13)}for(rs[0]=0,e=1;e<1024;++e){var s=e<<13;for(t=0;!(8388608&s);)t-=8388608,s<<=1;s&=-8388609,t+=947912704,rs[e]=s|t}for(e=1024;e<2048;++e)rs[e]=939524096+(e-1024<<13);for(is[0]=0,e=1;e<31;++e)is[e]=e<<23;for(is[31]=1199570944,is[32]=2147483648,e=33;e<63;++e)is[e]=2147483648+(e-32<<23);for(is[63]=3347054592,as[0]=0,e=1;e<64;++e)as[e]=32===e?0:1024}static roundToFloat16Bits(e){Jt[0]=e;var t=es[0],s=t>>23&511;return ts[s]+((8388607&t)>>ss[s])}static convertToNumber(e){var t=e>>10;return es[0]=rs[as[t]+(1023&e)]+is[t],Jt[0]}}const Zt=new ArrayBuffer(4),Jt=new Float32Array(Zt),es=new Uint32Array(Zt),ts=new Uint32Array(512),ss=new Uint32Array(512),rs=new Uint32Array(2048),is=new Uint32Array(64),as=new Uint32Array(64);var ns;e.FilterMode=void 0,(ns=e.FilterMode||(e.FilterMode={}))[ns.Point=0]="Point",ns[ns.Bilinear=1]="Bilinear",ns[ns.Trilinear=2]="Trilinear";const os=827611204,ls=861165636,hs=877942852,ds=894720068,us=131072;class cs{constructor(e,t,s,r,i,a,n,o,l,h){this.width=e,this.height=t,this.mipmapCount=s,this.isCube=r,this.blockBytes=a,this.dataOffset=n,this.format=o,this.source=h,this.bpp=i,this.compressed=l}static getDDSTextureInfo(t){let s=new Int32Array(t,0,31),r=s[4],i=s[3],a=1;131072&s[2]&&(a=Math.max(1,s[7]));let n=s[21],o=!(4&~s[20]),l=!(64&~s[20]),h=(s[20]&us)===us,d=!(512&~s[28]),u=n===os||n===ls||n===ds||n===hs,c=e.TextureFormat.DXT1,_=s[1]+4,p=1;switch(n){case os:c=e.TextureFormat.DXT1,p=8;break;case ls:c=e.TextureFormat.DXT3,p=16;break;case hs:case ds:c=e.TextureFormat.DXT5,p=16;break;case 113:c=e.TextureFormat.R16G16B16A16,p=4;break;case 116:c=e.TextureFormat.R32G32B32A32,p=4;break;default:throw"Unsupported format "+(g=n,String.fromCharCode(255&g,g>>8&255,g>>16&255,g>>24&255))}var g;if(542327876!==s[0])throw"Invalid magic number in DDS header";if(!o&&!l&&!h)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let m=f.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC)||f.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(u&&!m)throw"Compressed textures are not supported on this platform.";return new cs(r,i,a,d,0,p,_,c,u,t)}}const _s=6408,ps=6407,gs=5121;class ms{static getLayaFormat(t,s,r,i){if(0!=t){if(t==_s&&32856==s&&r==gs)return{format:e.TextureFormat.R8G8B8A8,sRGB:!1};if(t==_s&&35907==s&&r==gs)return{format:e.TextureFormat.R8G8B8A8,sRGB:!0};if(t==_s&&34836==s&&5126==r)return{format:e.TextureFormat.R32G32B32A32,sRGB:!1};if(t==_s&&34842==s&&5131==r)return{format:e.TextureFormat.R16G16B16A16,sRGB:!1};if(t==ps&&34837==s&&5126==r)return{format:e.TextureFormat.R32G32B32,sRGB:!1};if(t==ps&&34843==s&&5131==r)return{format:e.TextureFormat.R16G16B16,sRGB:!1};if(t==ps&&35905==s&&r==gs)return{format:e.TextureFormat.R8G8B8,sRGB:!0};if(t==ps&&32849==s&&r==gs)return{format:e.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(s){case 36196:return{format:e.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:e.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:e.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:e.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:e.TextureFormat.ETC2SRGB,sRGB:!0};case 37494:return{format:e.TextureFormat.ETC2RGB_Alpha1,sRGB:!1};case 37495:return{format:e.TextureFormat.ETC2SRGB_Alpha1,sRGB:!0};case 37808:return{format:e.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:e.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:e.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:e.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:e.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:e.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:e.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:e.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:e.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:e.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(e){let t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])throw"ktx2 !";if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return ms.createKTX1Info(e);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(t){let s=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(t,12,13*s),i=67305985==r.getUint32(0,!0),a=r.getUint32(1*s,i),n=r.getUint32(2*s,i),o=r.getUint32(3*s,i),l=r.getUint32(4*s,i);r.getUint32(5*s,i);let h=r.getUint32(6*s,i),d=r.getUint32(7*s,i);r.getUint32(8*s,i);let u=r.getUint32(9*s,i),c=r.getUint32(10*s,i),_=r.getUint32(11*s,i),p=r.getUint32(12*s,i),g=ms.getLayaFormat(o,l,a,n),m=g.format,f=g.sRGB,T=e.TextureDimension.Tex2D;c>1&&u>1?T=e.TextureDimension.CubeArray:c>1&&u<=1?T=e.TextureDimension.Cube:c<=1&&u>1&&(T=e.TextureDimension.Texture2DArray);return new ms(t,0==o,f,T,h,d,m,_||1,p,64)}constructor(e,t,s,r,i,a,n,o,l,h){this.source=e,this.compress=t,this.sRGB=s,this.dimension=r,this.width=i,this.height=a,this.format=n,this.mipmapCount=o,this.bytesOfKeyValueData=l,this.headerOffset=h}}class fs extends G{static __init__(){var t=new Uint8Array(4);if(t[0]=128,t[1]=128,t[2]=128,t[3]=255,fs.grayTexture=new fs(1,1,e.TextureFormat.R8G8B8A8,!1,!1),fs.grayTexture.setPixelsData(t,!1,!1),fs.grayTexture.lock=!0,fs.grayTexture.name="Default_Gray",t[0]=255,t[1]=255,t[2]=255,t[3]=255,fs.whiteTexture=new fs(1,1,e.TextureFormat.R8G8B8A8,!1,!1),fs.whiteTexture.setPixelsData(t,!1,!1),fs.whiteTexture.lock=!0,fs.whiteTexture.name="Default_White",t[0]=0,t[1]=0,t[2]=0,t[3]=255,fs.blackTexture=new fs(1,1,e.TextureFormat.R8G8B8A8,!1,!1),fs.blackTexture.setPixelsData(t,!1,!1),fs.blackTexture.lock=!0,fs.blackTexture.name="Default_Black",f.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16)){let t=new Uint16Array(4);t[0]=14336,t[1]=14336,t[2]=15360,t[3]=15360,fs.normalTexture=new fs(1,1,e.TextureFormat.R16G16B16A16,!1,!1,!1),fs.normalTexture.setPixelsData(t,!1,!1)}else t[0]=128,t[1]=128,t[2]=255,t[3]=255,fs.normalTexture=new fs(1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),fs.normalTexture.setPixelsData(t,!1,!1);fs.normalTexture.lock=!0,fs.normalTexture.name="Default_Normal",fs.errorTexture=fs.whiteTexture}static _SimpleAnimatorTextureParse(t,s=null,r=null){var i,a,n=new $t(t);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,l=n.readInt32(),h=n.readInt32();i=new Float32Array(l*l*4),a=new Float32Array(n.readArrayBuffer(4*h)),i.set(a,0),(o=new fs(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(i,!1,!1),o.filterMode=e.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":l=n.readInt32(),h=n.readInt32();if(i=new Uint16Array(n.readArrayBuffer(2*h)),f.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16))(a=new Uint16Array(l*l*4)).set(i,0),(o=new fs(l,l,e.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=e.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),f.renderEngine.getCapable(e.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),a=new Float32Array(l*l*4);for(var d=0,u=i.length;d<u;d++)a[d]=Qt.convertToNumber(i[d]);(o=new fs(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=e.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(t,s=null,r=null){let i=r?r[2]:e.TextureFormat.R8G8B8A8,a=!r||r[3],n=!!r&&r[4],o=!!r&&r[5],l=!!s&&s.premultiplyAlpha,h=new fs(t.width,t.height,i,a,n,o,l);return s?(h.setImageData(t,l,!1),h.setProperties(s)):h.setImageData(t,!1,!1),n&&(p.isConch&&t._nativeObj?h._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,t.width,t.height)):(Y.canvas.size(t.width,t.height),Y.canvas.clear(),Y.context.drawImage(t,0,0,t.width,t.height),h._pixels=new Uint8Array(Y.context.getImageData(0,0,t.width,t.height).data.buffer))),h}static _parseDDS(e,t=null,s=null){let r=cs.getDDSTextureInfo(e),i=!!s&&s[5],a=new fs(r.width,r.height,r.format,r.mipmapCount>1,!1,i);return a.setDDSData(r),t&&a.setProperties(t),a._premultiplyAlpha=t.premultiplyAlpha,a}static _parseKTX(e,t=null,s=null){let r=ms.getKTXTextureInfo(e),i=new fs(r.width,r.height,r.format,r.mipmapCount>1,!1,r.sRGB);return i.setKTXData(r),t&&i.setProperties(t),i._premultiplyAlpha=t.premultiplyAlpha,i}static _parsePVR(e,t=null,s=null){throw new C}static load(e,t){l.loader.load(e,t,null,l.Loader.TEXTURE2D)}constructor(t,s,r,i=!0,a,n=!1,o=!1){super(t,s,r),this._canRead=!1,this._premultiplyAlpha=!1,this._dimension=e.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=a,this._premultiplyAlpha=o,this._texture=f.textureContext.createTextureInternal(this._dimension,t,s,r,i,n,o)}setImageData(e,t,s){let r=this._texture;f.textureContext.setTextureImageData(r,e,t,s)}setPixelsData(e,t,s){let r=this._texture;f.textureContext.setTexturePixelsData(r,e,t,s)}setSubPixelsData(e,t,s,r,i,a,n,o,l){let h=this._texture;f.textureContext.setTextureSubPixelsData(h,i,a,n,e,t,s,r,o,l)}setDDSData(e){let t=this._texture;f.textureContext.setTextureDDSData(t,e)}setKTXData(e){let t=this._texture;f.textureContext.setTextureKTXData(t,e)}setHDRData(e){let t=this._texture;f.textureContext.setTextureHDRData(t,e)}get defaultTexture(){return fs.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(e){e&&(null!=e.wrapModeU&&(this.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(this.wrapModeV=e.wrapModeV),null!=e.filterMode&&(this.filterMode=e.filterMode),null!=e.anisoLevel&&(this.anisoLevel=e.anisoLevel))}}var Ts,ys,xs,Ss,Es,vs,Ds;fs.TEXTURE2D="TEXTURE2D",fs.grayTexture=null,fs.whiteTexture=null,fs.blackTexture=null,fs.normalTexture=null,fs.errorTexture=null,e.BlendEquationSeparate=void 0,(Ts=e.BlendEquationSeparate||(e.BlendEquationSeparate={}))[Ts.ADD=0]="ADD",Ts[Ts.SUBTRACT=1]="SUBTRACT",Ts[Ts.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",Ts[Ts.MIN=3]="MIN",Ts[Ts.MAX=4]="MAX",e.BlendFactor=void 0,(ys=e.BlendFactor||(e.BlendFactor={}))[ys.Zero=0]="Zero",ys[ys.One=1]="One",ys[ys.SourceColor=2]="SourceColor",ys[ys.OneMinusSourceColor=3]="OneMinusSourceColor",ys[ys.DestinationColor=4]="DestinationColor",ys[ys.OneMinusDestinationColor=5]="OneMinusDestinationColor",ys[ys.SourceAlpha=6]="SourceAlpha",ys[ys.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",ys[ys.DestinationAlpha=8]="DestinationAlpha",ys[ys.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",ys[ys.SourceAlphaSaturate=10]="SourceAlphaSaturate",ys[ys.BlendColor=11]="BlendColor",ys[ys.OneMinusBlendColor=12]="OneMinusBlendColor",e.BlendType=void 0,(xs=e.BlendType||(e.BlendType={}))[xs.BLEND_DISABLE=0]="BLEND_DISABLE",xs[xs.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",xs[xs.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",e.CompareFunction=void 0,(Ss=e.CompareFunction||(e.CompareFunction={}))[Ss.Never=0]="Never",Ss[Ss.Less=1]="Less",Ss[Ss.Equal=2]="Equal",Ss[Ss.LessEqual=3]="LessEqual",Ss[Ss.Greater=4]="Greater",Ss[Ss.NotEqual=5]="NotEqual",Ss[Ss.GreaterEqual=6]="GreaterEqual",Ss[Ss.Always=7]="Always",Ss[Ss.Off=8]="Off",e.CullMode=void 0,(Es=e.CullMode||(e.CullMode={}))[Es.Off=0]="Off",Es[Es.Front=1]="Front",Es[Es.Back=2]="Back",e.FrontFace=void 0,(vs=e.FrontFace||(e.FrontFace={}))[vs.CW=0]="CW",vs[vs.CCW=1]="CCW",e.StencilOperation=void 0,(Ds=e.StencilOperation||(e.StencilOperation={}))[Ds.Keep=0]="Keep",Ds[Ds.Zero=1]="Zero",Ds[Ds.Replace=2]="Replace",Ds[Ds.IncrementSaturate=3]="IncrementSaturate",Ds[Ds.DecrementSaturate=4]="DecrementSaturate",Ds[Ds.Invert=5]="Invert",Ds[Ds.IncrementWrap=6]="IncrementWrap",Ds[Ds.DecrementWrap=7]="DecrementWrap";class ws{get cull(){return this._cull}set cull(e){this._cull=e}get blend(){return this._blend}set blend(e){this._blend=e}get srcBlend(){return this._srcBlend}set srcBlend(e){this._srcBlend=e}get dstBlend(){return this._dstBlend}set dstBlend(e){this._dstBlend=e}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(e){this._srcBlendRGB=e}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(e){this._dstBlendRGB=e}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(e){this._srcBlendAlpha=e}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(e){this._dstBlendAlpha=e}get blendEquation(){return this._blendEquation}set blendEquation(e){this._blendEquation=e}get blendEquationRGB(){return this._blendEquationRGB}set blendEquationRGB(e){this._blendEquationRGB=e}get blendEquationAlpha(){return this._blendEquationAlpha}set blendEquationAlpha(e){this._blendEquationAlpha=e}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest=e}get depthWrite(){return this._depthWrite}set depthWrite(e){this._depthWrite=e}get stencilWrite(){return this._stencilWrite}set stencilWrite(e){this._stencilWrite=e}get stencilTest(){return this._stencilTest}set stencilTest(e){this._stencilTest=e}get stencilWriteMask(){return this._stencilWriteMask}set stencilWriteMask(e){this._stencilWriteMask=e}get stencilReadMask(){return this._stencilReadMask}set stencilReadMask(e){this._stencilReadMask=e}get stencilRef(){return this._stencilRef}set stencilRef(e){this._stencilRef=e}get stencilOp(){return this._stencilOp}set stencilOp(e){this._stencilOp=e}get depthBias(){return this._depthBias}set depthBias(e){this._depthBias=e}get depthBiasConstant(){return this._depthBiasConstant}set depthBiasConstant(e){this._depthBiasConstant=e}get depthBiasSlopeScale(){return this._depthBiasSlopeScale}set depthBiasSlopeScale(e){this._depthBiasSlopeScale=e}get depthBiasClamp(){return this._depthBiasClamp}set depthBiasClamp(e){this._depthBiasClamp=e}createObj(){}constructor(){this._stencilOp=new a,this.createObj(),this.cull=ws.CULL_BACK,this.blend=ws.BLEND_DISABLE,this.srcBlend=ws.BLENDPARAM_ONE,this.dstBlend=ws.BLENDPARAM_ZERO,this.srcBlendRGB=ws.BLENDPARAM_ONE,this.dstBlendRGB=ws.BLENDPARAM_ZERO,this.srcBlendAlpha=ws.BLENDPARAM_ONE,this.dstBlendAlpha=ws.BLENDPARAM_ZERO,this.blendEquation=ws.BLENDEQUATION_ADD,this.blendEquationRGB=ws.BLENDEQUATION_ADD,this.blendEquationAlpha=ws.BLENDEQUATION_ADD,this.depthTest=ws.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilReadMask=255,this.stencilRef=1,this.stencilTest=ws.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new a(ws.STENCILOP_KEEP,ws.STENCILOP_KEEP,ws.STENCILOP_REPLACE),this.depthBias=!1,this.depthBiasConstant=0,this.depthBiasSlopeScale=0,this.depthBiasClamp=0}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilWriteMask=null,this.stencilReadMask=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null),this.depthBias=null,this.depthBiasConstant=null,this.depthBiasSlopeScale=null,this.depthBiasClamp=null}cloneTo(e){e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.stencilWriteMask=this.stencilWriteMask,e.stencilReadMask=this.stencilReadMask,e.stencilRef=this.stencilRef,e.stencilTest=this.stencilTest,e.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(e.stencilOp),e.depthBias=this.depthBias,e.depthBiasConstant=this.depthBiasConstant,e.depthBiasSlopeScale=this.depthBiasSlopeScale,e.depthBiasClamp=this.depthBiasClamp}clone(){var e=new ws;return this.cloneTo(e),e}}ws.CULL_NONE=e.CullMode.Off,ws.CULL_FRONT=e.CullMode.Front,ws.CULL_BACK=e.CullMode.Back,ws.BLEND_DISABLE=e.BlendType.BLEND_DISABLE,ws.BLEND_ENABLE_ALL=e.BlendType.BLEND_ENABLE_ALL,ws.BLEND_ENABLE_SEPERATE=e.BlendType.BLEND_ENABLE_SEPERATE,ws.BLENDPARAM_ZERO=e.BlendFactor.Zero,ws.BLENDPARAM_ONE=e.BlendFactor.One,ws.BLENDPARAM_SRC_COLOR=e.BlendFactor.SourceColor,ws.BLENDPARAM_ONE_MINUS_SRC_COLOR=e.BlendFactor.OneMinusSourceColor,ws.BLENDPARAM_DST_COLOR=e.BlendFactor.DestinationColor,ws.BLENDPARAM_ONE_MINUS_DST_COLOR=e.BlendFactor.OneMinusDestinationColor,ws.BLENDPARAM_SRC_ALPHA=e.BlendFactor.SourceAlpha,ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA=e.BlendFactor.OneMinusSourceAlpha,ws.BLENDPARAM_DST_ALPHA=e.BlendFactor.DestinationAlpha,ws.BLENDPARAM_ONE_MINUS_DST_ALPHA=e.BlendFactor.OneMinusDestinationAlpha,ws.BLENDPARAM_SRC_ALPHA_SATURATE=e.BlendFactor.SourceAlphaSaturate,ws.BLENDPARAM_BLENDCOLOR=e.BlendFactor.BlendColor,ws.BLENDPARAM_BLEND_ONEMINUS_COLOR=e.BlendFactor.OneMinusBlendColor,ws.BLENDEQUATION_ADD=e.BlendEquationSeparate.ADD,ws.BLENDEQUATION_SUBTRACT=e.BlendEquationSeparate.SUBTRACT,ws.BLENDEQUATION_REVERSE_SUBTRACT=e.BlendEquationSeparate.REVERSE_SUBTRACT,ws.BLENDEQUATION_MIN=e.BlendEquationSeparate.MIN,ws.BLENDEQUATION_MAX=e.BlendEquationSeparate.MAX,ws.DEPTHTEST_OFF=e.CompareFunction.Off,ws.DEPTHTEST_NEVER=e.CompareFunction.Never,ws.DEPTHTEST_LESS=e.CompareFunction.Less,ws.DEPTHTEST_EQUAL=e.CompareFunction.Equal,ws.DEPTHTEST_LEQUAL=e.CompareFunction.LessEqual,ws.DEPTHTEST_GREATER=e.CompareFunction.Greater,ws.DEPTHTEST_NOTEQUAL=e.CompareFunction.NotEqual,ws.DEPTHTEST_GEQUAL=e.CompareFunction.GreaterEqual,ws.DEPTHTEST_ALWAYS=e.CompareFunction.Always,ws.STENCILTEST_OFF=e.CompareFunction.Off,ws.STENCILTEST_NEVER=e.CompareFunction.Never,ws.STENCILTEST_LESS=e.CompareFunction.Less,ws.STENCILTEST_EQUAL=e.CompareFunction.Equal,ws.STENCILTEST_LEQUAL=e.CompareFunction.LessEqual,ws.STENCILTEST_GREATER=e.CompareFunction.Greater,ws.STENCILTEST_NOTEQUAL=e.CompareFunction.NotEqual,ws.STENCILTEST_GEQUAL=e.CompareFunction.GreaterEqual,ws.STENCILTEST_ALWAYS=e.CompareFunction.Always,ws.STENCILOP_KEEP=e.StencilOperation.Keep,ws.STENCILOP_ZERO=e.StencilOperation.Zero,ws.STENCILOP_REPLACE=e.StencilOperation.Replace,ws.STENCILOP_INCR=e.StencilOperation.IncrementSaturate,ws.STENCILOP_INCR_WRAP=e.StencilOperation.IncrementWrap,ws.STENCILOP_DECR=e.StencilOperation.DecrementSaturate,ws.STENCILOP_DECR_WRAP=e.StencilOperation.DecrementWrap,ws.STENCILOP_INVERT=e.StencilOperation.Invert,ws.Default=new ws;class bs{static splitToWords(e,t){let s,r,i=[],a=-1,n=e.length;for(let o=0;o<n;o++)if(s=e.charAt(o)," \t=+-*/&%!<>()'\",;".indexOf(s)>=0){if(a>=0&&o-a>1&&(r=e.substring(a,o),i.push(r)),'"'==s||"'"==s){let t=e.indexOf(s,o+1);if(t<0)throw new Error("Sharder err:"+e);i.push(e.substring(o+1,t)),o=t,a=-1;continue}"("==s&&t&&i.length>0&&(r=i[i.length-1]+";","vec4;main;".indexOf(r)<0&&(t.useFuns+=r)),a=-1}else a<0&&(a=o);return a<n&&n-a>1&&(r=e.substring(a,n),i.push(r)),i}constructor(e){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;let t,s,r=0;for(;r=e.indexOf("#begin",r),!(r<0);){for(s=r+5;!(s=e.indexOf("#end",s),s<0||"i"!==e.charAt(s+4));)s+=5;if(s<0)throw new Error("add include err,no #end:"+e);t=e.indexOf("\n",r);let i=bs.splitToWords(e.substring(r,t),null);"code"==i[1]?this.codes[i[2]]=e.substring(t+1,s):"function"==i[1]&&(t=e.indexOf("function",r),t+=8,this.funs[i[3]]=e.substring(t+1,s),this.funnames+=i[3]+";"),r=s+1}}getWith(e=null){let t=e?this.codes[e]:this.script;if(!t)throw new Error("get with error:"+e);return t}getFunsScript(e){let t="";for(let s in this.funs)e.indexOf(s+";")>=0&&(t+=this.funs[s]);return t}}class Cs{constructor(e){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}setParent(e){e.childs.push(this),this.z=e.z+1,this.parent=e}setCondition(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}toscript(e,t){return this._toscript(e,t,++Cs.__id)}_toscript(e,t,s){if(this.childs.length<1&&!this.text)return t;if(t.length,this.condition){var r=!!this.condition.call(e);if(2===this.conditionType&&(r=!r),!r&&Cs.__noCompileEnable)return t}if(!this.noCompile&&Cs.__noCompileEnable||this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach(function(r,i,a){r._toscript(e,t,s)}),this.includefiles.length>0&&this.useFuns.length>0)for(var i,a=0,n=this.includefiles.length;a<n;a++)this.includefiles[a].curUseID!=s&&(i=this.includefiles[a].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[a].curUseID=s,t[0]=i+t[0]);return t}}Cs.__id=1,Cs.__noCompileEnable=!0;const Rs=new RegExp("\r","g"),Ms=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),As={Back:e.CullMode.Back,Front:e.CullMode.Front,Off:e.CullMode.Off},Is={Disable:e.BlendType.BLEND_DISABLE,All:e.BlendType.BLEND_ENABLE_ALL,Seperate:e.BlendType.BLEND_ENABLE_SEPERATE},Ps={Zero:e.BlendFactor.Zero,One:e.BlendFactor.One,SourceColor:e.BlendFactor.SourceColor,OneMinusSourceColor:e.BlendFactor.OneMinusSourceColor,DestinationColor:e.BlendFactor.DestinationColor,OneMinusDestinationColor:e.BlendFactor.OneMinusDestinationColor,SourceAlpha:e.BlendFactor.SourceAlpha,OneMinusSourceAlpha:e.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:e.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:e.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:e.BlendFactor.SourceAlphaSaturate,BlendColor:e.BlendFactor.BlendColor,OneMinusBlendColor:e.BlendFactor.OneMinusBlendColor},Bs={Add:e.BlendEquationSeparate.ADD,Subtract:e.BlendEquationSeparate.SUBTRACT,Reverse_substract:e.BlendEquationSeparate.REVERSE_SUBTRACT,Min:e.BlendEquationSeparate.MIN,Max:e.BlendEquationSeparate.MAX},Ls={Never:e.CompareFunction.Never,Less:e.CompareFunction.Less,Equal:e.CompareFunction.Equal,LessEqual:e.CompareFunction.LessEqual,Greater:e.CompareFunction.Greater,NotEqual:e.CompareFunction.NotEqual,GreaterEqual:e.CompareFunction.GreaterEqual,Always:e.CompareFunction.Always,Off:e.CompareFunction.Off},Ns={Keep:e.StencilOperation.Keep,Zero:e.StencilOperation.Zero,Replace:e.StencilOperation.Replace,IncrementSaturate:e.StencilOperation.IncrementSaturate,DecrementSaturate:e.StencilOperation.DecrementSaturate,Invert:e.StencilOperation.Invert,IncrementWrap:e.StencilOperation.IncrementWrap,DecrementWrap:e.StencilOperation.DecrementWrap};class Fs{static addInclude(e,t,s){if(!t||0===t.length)return console.error("shader include file err:"+e),null;if(!s&&Fs.includes[e])return console.warn("shader include file already exists:"+e),Fs.includes[e];t=t.replace(Rs,"");let r=new bs(t);return Fs.includes[e]=r,r}static compile(e,t,s){let r={vsNode:new Cs([]),psNode:new Cs([]),includeNames:new Set,defs:new Set},i=[];e=e.replace(Rs,""),t=t.replace(Rs,""),Fs._compileToTree(r.vsNode,e,r.defs,i,s),Fs._compileToTree(r.psNode,t,r.defs,i,s);for(let e of i)e.file?r.includeNames.add(e.name):console.warn(`ShaderCompile missing file ${e.name}`);return r}static compileAsync(e,t,s){let r={vsNode:new Cs([]),psNode:new Cs([]),includeNames:new Set,defs:new Set},i=[];return e=e.replace(Rs,""),t=t.replace(Rs,""),Fs._compileToTree(r.vsNode,e,r.defs,i,s),Fs._compileToTree(r.psNode,t,r.defs,i,s),this._loadIncludesDeep(r,i,0)}static _loadIncludesDeep(e,t,s){let r,i=t.length;for(let a=s;a<i;a++){let s=t[a];s.file?e.includeNames.add(s.name):(r||(r=[]),r.push(s))}return r?l.loader.load(r.map(e=>e.name)).then(s=>{let a=r.length;for(let i=0;i<a;i++){let a=r[i],n=s[i];if(n){e.includeNames.add(a.name);let s=n.getWith(a.codeName);a.node.condition?a.node.text=s:(Fs._compileToTree(a.node,s,e.defs,t,ee.getPath(a.name)),a.node.text="")}else{let e=a.node.parent.childs;e.splice(e.indexOf(a.node),1)}}return t.length>i?Fs._loadIncludesDeep(e,t,i):e}):Promise.resolve(e)}static _compileToTree(e,t,s,r,i){let a,n,o,l,h,d,u,c,_,p,g=t.split("\n");for(c=0;c<g.length;c++)if(o=g[c],!(o.length<1)&&(d=o.indexOf("//"),0!==d)){if(d>=0&&(o=o.substr(0,d)),(d=o.indexOf("#"))<0){n=e.childs[e.childs.length-1];let t=e.includefiles;if(n&&!n.name){t.length>0&&bs.splitToWords(o,n),n.text+="\n"+o;continue}a=new Cs(t),a.text=o,a.noCompile=!0,t.length>0&&bs.splitToWords(o,a),a.setParent(e);continue}for(a=new Cs(e.includefiles),a.text=o,a.noCompile=!0,l="#",p=d+1,_=o.length;p<_;p++){let e=o.charAt(p);if(" "===e||"\t"===e||"?"===e)break;l+=e}switch(a.name=l,l){case"#ifdef":case"#ifndef":for(a.src=o,a.noCompile=null!=o.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+o.substr(d+a.name.length)+"}"):(u=o.replace(/^\s*/,"").split(/\s+/),a.setCondition(u[1],"#ifdef"===l?Fs.IFDEF_YES:Fs.IFDEF_ELSE),a.text=a.text),a.setParent(e),e=a,u=o.substr(p).split(Ms),p=0;p<u.length;p++)o=u[p],o.length&&s.add(o);break;case"#if":case"#elif":for(a.src=o,a.noCompile=!0,"#elif"==l&&(n=(e=e.parent).childs[e.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),a.setParent(e),e=a,u=o.substr(p).split(Ms),p=0;p<u.length;p++)o=u[p],o.length&&"defined"!=o&&s.add(o);break;case"#else":a.src=o,n=(e=e.parent).childs[e.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.condition=n.condition,a.conditionType=n.conditionType==Fs.IFDEF_YES?Fs.IFDEF_ELSE:Fs.IFDEF_YES),a.setParent(e),e=a;break;case"#endif":n=(e=e.parent).childs[e.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.text=a.text),a.setParent(e);break;case"#include":u=bs.splitToWords(o,null);let t,c=u[1];c.startsWith(".")?c=ee.join(i,c):c.startsWith("/")?c=ee.formatURL(c.substring(1)):(t=Fs.includes[c],t||(c="internal/"+c)),t=Fs.includes[c],!t&&Fs.loadIncludeFileSync&&(Fs.loadIncludeFileSync(c),t=Fs.includes[c]);let _="with"==u[2]?u[3]:null;r.push({name:c,codeName:_,node:a,file:t}),a.setParent(e),(d=u[0].indexOf("?"))<0?(t&&(o=t.getWith(_),this._compileToTree(a,o,s,r,ee.getPath(c))),a.text=""):(a.setCondition(u[0].substr(d+1),Fs.IFDEF_YES),t&&(a.text=t.getWith(_)));break;case"#import":u=bs.splitToWords(o,null),h=u[1],a.includefiles.push({node:a,file:Fs.includes[h],ofs:a.text.length});break;default:a.setParent(e)}}}static getRenderState(e,t){if(!e)return;t.cull=As[e.cull],t.blend=Is[e.blend],t.srcBlend=Ps[e.srcBlend],t.dstBlend=Ps[e.dstBlend],t.srcBlendRGB=Ps[e.srcBlendRGB],t.dstBlendRGB=Ps[e.dstBlendRGB],t.srcBlendAlpha=Ps[e.srcBlendAlpha],t.dstBlendAlpha=Ps[e.dstBlendAlpha],t.blendEquation=Bs[e.blendEquation],t.blendEquationRGB=Bs[e.blendEquationRGB],t.blendEquationAlpha=Bs[e.blendEquationAlpha],t.depthTest=Ls[e.depthTest],t.depthWrite=e.depthWrite,t.stencilRef=e.stencilRef,t.stencilTest=Ls[e.stencilTest],t.stencilWrite=e.stencilWrite,t.stencilWriteMask=e.stencilWriteMask,t.stencilReadMask=e.stencilReadMask;let s=e.stencilOp,r=s?s[0]:null,i=s?s[1]:null,a=s?s[2]:null;t.stencilOp.x=Ns[r],t.stencilOp.y=Ns[i],t.stencilOp.z=Ns[a],t.depthBias=e.depthBias,t.depthBiasConstant=e.depthBiasConstant,t.depthBiasSlopeScale=e.depthBiasSlopeScale,t.depthBiasClamp=e.depthBiasClamp}}Fs.IFDEF_NO=0,Fs.IFDEF_YES=1,Fs.IFDEF_ELSE=2,Fs.IFDEF_PARENT=3,Fs.includes={};const Os=new Float32Array([1,0,0,0,1,0,0,0,1]);class Us{static createRotationQuaternion(e,t){var s=e.x,r=e.y,i=e.z,a=e.w,n=s*s,o=r*r,l=i*i,h=s*r,d=i*a,u=i*s,c=r*a,_=r*i,p=s*a,g=t.elements;g[0]=1-2*(o+l),g[1]=2*(h+d),g[2]=2*(u-c),g[3]=2*(h-d),g[4]=1-2*(l+n),g[5]=2*(_+p),g[6]=2*(u+c),g[7]=2*(_-p),g[8]=1-2*(o+n)}static createFromTranslation(e,t){var s=t.elements;s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=e.x,s[7]=e.y,s[8]=1}static createMatrixFromValue(e,t,s=ct.ONE,r){var i=r.elements,a=Math.sin(t),n=Math.cos(t);i[0]=n*s.x,i[1]=a*s.x,i[2]=0,i[3]=-a*s.y,i[4]=n*s.y,i[5]=0,i[6]=e.x,i[7]=e.y,i[8]=1}static createFromRotation(e,t){var s=t.elements,r=Math.sin(e),i=Math.cos(e);s[0]=i,s[1]=r,s[2]=0,s[3]=-r,s[4]=i,s[5]=0,s[6]=0,s[7]=0,s[8]=1}static createFromScaling(e,t){var s=t.elements;s[0]=e.x,s[1]=0,s[2]=0,s[3]=0,s[4]=e.y,s[5]=0,s[6]=0,s[7]=0,s[8]=e.z}static createFromMatrix4x4(e,t){var s=e.elements,r=t.elements;r[0]=s[0],r[1]=s[1],r[2]=s[2],r[3]=s[4],r[4]=s[5],r[5]=s[6],r[6]=s[8],r[7]=s[9],r[8]=s[10]}static multiply(e,t,s){var r=e.elements,i=t.elements,a=s.elements,n=r[0],o=r[1],l=r[2],h=r[3],d=r[4],u=r[5],c=r[6],_=r[7],p=r[8],g=i[0],m=i[1],f=i[2],T=i[3],y=i[4],x=i[5],S=i[6],E=i[7],v=i[8];a[0]=g*n+m*h+f*c,a[1]=g*o+m*d+f*E,a[2]=g*l+m*u+f*p,a[3]=T*n+y*h+x*c,a[4]=T*o+y*d+x*_,a[5]=T*l+y*u+x*p,a[6]=S*n+E*h+v*c,a[7]=S*o+E*d+v*_,a[8]=S*l+E*u+v*p}constructor(e=!0){e&&(this.elements=Os.slice())}cloneByArray(e){this.elements.set(e)}determinant(){var e=this.elements,t=e[0],s=e[1],r=e[2],i=e[3],a=e[4],n=e[5],o=e[6],l=e[7],h=e[8];return t*(h*a-n*l)+s*(-h*i+n*o)+r*(l*i-a*o)}translate(e,t){var s=t.elements,r=this.elements,i=r[0],a=r[1],n=r[2],o=r[3],l=r[4],h=r[5],d=r[6],u=r[7],c=r[8],_=e.x,p=e.y;s[0]=i,s[1]=a,s[2]=n,s[3]=o,s[4]=l,s[5]=h,s[6]=_*i+p*o+d,s[7]=_*a+p*l+u,s[8]=_*n+p*h+c}rotate(e,t){var s=t.elements,r=this.elements,i=r[0],a=r[1],n=r[2],o=r[3],l=r[4],h=r[5],d=r[6],u=r[7],c=r[8],_=Math.sin(e),p=Math.cos(e);s[0]=p*i+_*o,s[1]=p*a+_*l,s[2]=p*n+_*h,s[3]=p*o-_*i,s[4]=p*l-_*a,s[5]=p*h-_*n,s[6]=d,s[7]=u,s[8]=c}scale(e,t){var s=t.elements,r=this.elements,i=e.x,a=e.y;s[0]=i*r[0],s[1]=i*r[1],s[2]=i*r[2],s[3]=a*r[3],s[4]=a*r[4],s[5]=a*r[5],s[6]=r[6],s[7]=r[7],s[8]=r[8]}invert(e){var t=e.elements,s=this.elements,r=s[0],i=s[1],a=s[2],n=s[3],o=s[4],l=s[5],h=s[6],d=s[7],u=s[8],c=u*o-l*d,_=-u*n+l*h,p=d*n-o*h,g=r*c+i*_+a*p;g&&(g=1/g,t[0]=c*g,t[1]=(-u*i+a*d)*g,t[2]=(l*i-a*o)*g,t[3]=_*g,t[4]=(u*r-a*h)*g,t[5]=(-l*r+a*n)*g,t[6]=p*g,t[7]=(-d*r+i*h)*g,t[8]=(o*r-i*n)*g)}transpose(e){var t=e.elements,s=this.elements;if(e===this){var r=s[1],i=s[2],a=s[5];t[1]=s[3],t[2]=s[6],t[3]=r,t[5]=s[7],t[6]=i,t[7]=a}else t[0]=s[0],t[1]=s[3],t[2]=s[6],t[3]=s[1],t[4]=s[4],t[5]=s[7],t[6]=s[2],t[7]=s[5],t[8]=s[8]}identity(){this.elements.set(Os)}cloneTo(e){var t,s;(t=this.elements)!==(s=e.elements)&&s.set(t)}clone(){var e=new Us(!1);return e.elements=this.elements.slice(),e}static lookAt(e,t,s,r){a.subtract(e,t,ks),a.normalize(ks,ks),a.cross(s,ks,Vs),a.normalize(Vs,Vs),a.cross(ks,Vs,Gs);var i=ks,n=Vs,o=Gs,l=r.elements;l[0]=n.x,l[3]=n.y,l[6]=n.z,l[1]=o.x,l[4]=o.y,l[7]=o.z,l[2]=i.x,l[5]=i.y,l[8]=i.z}static forwardLookAt(e,t,s,r){var i=Vs,a=Gs,n=ks;t.vsub(e,n).normalize(),s.cross(n,i).normalize(),n.cross(i,a);var o=r.elements;o[0]=i.x,o[1]=i.y,o[2]=i.z,o[3]=a.x,o[4]=a.y,o[5]=a.z,o[6]=n.x,o[7]=n.y,o[8]=n.z}}Us.DEFAULT=new Us,Us.TEMP=new Us;const ks=new a,Vs=new a,Gs=new a;class zs{static createFromYawPitchRoll(e,t,s,r){var i=.5*s,a=.5*t,n=.5*e,o=Math.sin(i),l=Math.cos(i),h=Math.sin(a),d=Math.cos(a),u=Math.sin(n),c=Math.cos(n);r.x=c*h*l+u*d*o,r.y=u*d*l-c*h*o,r.z=c*d*o-u*h*l,r.w=c*d*l+u*h*o}static multiply(e,t,s){var r=e.x,i=e.y,a=e.z,n=e.w,o=t.x,l=t.y,h=t.z,d=t.w,u=i*h-a*l,c=a*o-r*h,_=r*l-i*o,p=r*o+i*l+a*h;s.x=r*d+o*n+u,s.y=i*d+l*n+c,s.z=a*d+h*n+_,s.w=n*d-p}static rotationAxisAngle(e,t,s){const r=a.TEMP;a.normalize(e,r),t*=.5;const i=Math.sin(t);s.x=r.x*i,s.y=r.y*i,s.z=r.z*i,s.w=Math.cos(t)}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,t,s){a.subtract(t,e,Hs),a.normalize(Hs,Hs),s.x=Math.asin(Hs.y),s.y=zs.arcTanAngle(-Hs.z,-Hs.x)}static createFromAxisAngle(e,t,s){t*=.5;var r=Math.sin(t);s.x=r*e.x,s.y=r*e.y,s.z=r*e.z,s.w=Math.cos(t)}static createFromMatrix4x4(e,t){var s,r,i=e.elements,a=i[0]+i[5]+i[10];a>0?(s=Math.sqrt(a+1),t.w=.5*s,s=.5/s,t.x=(i[6]-i[9])*s,t.y=(i[8]-i[2])*s,t.z=(i[1]-i[4])*s):i[0]>=i[5]&&i[0]>=i[10]?(r=.5/(s=Math.sqrt(1+i[0]-i[5]-i[10])),t.x=.5*s,t.y=(i[1]+i[4])*r,t.z=(i[2]+i[8])*r,t.w=(i[6]-i[9])*r):i[5]>i[10]?(r=.5/(s=Math.sqrt(1+i[5]-i[0]-i[10])),t.x=(i[4]+i[1])*r,t.y=.5*s,t.z=(i[9]+i[6])*r,t.w=(i[8]-i[2])*r):(r=.5/(s=Math.sqrt(1+i[10]-i[0]-i[5])),t.x=(i[8]+i[2])*r,t.y=(i[9]+i[6])*r,t.z=.5*s,t.w=(i[1]-i[4])*r)}static slerp(e,t,s,r){var i,a,n,o,l,h=e.x,d=e.y,u=e.z,c=e.w,_=t.x,p=t.y,g=t.z,m=t.w;return(a=h*_+d*p+u*g+c*m)<0&&(a=-a,_=-_,p=-p,g=-g,m=-m),1-a>1e-6?(i=Math.acos(a),n=Math.sin(i),o=Math.sin((1-s)*i)/n,l=Math.sin(s*i)/n):(o=1-s,l=s),r.x=o*h+l*_,r.y=o*d+l*p,r.z=o*u+l*g,r.w=o*c+l*m,r}static lerp(e,t,s,r){var i=1-s;zs.dot(e,t)>=0?(r.x=i*e.x+s*t.x,r.y=i*e.y+s*t.y,r.z=i*e.z+s*t.z,r.w=i*e.w+s*t.w):(r.x=i*e.x-s*t.x,r.y=i*e.y-s*t.y,r.z=i*e.z-s*t.z,r.w=i*e.w-s*t.w),r.normalize(r)}static add(e,t,s){s.x=e.x+t.x,s.y=e.y+t.y,s.z=e.z+t.z,s.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}constructor(e=0,t=0,s=0,r=1){this.x=e,this.y=t,this.z=s,this.w=r}setValue(e,t,s,r){this.x=e,this.y=t,this.z=s,this.w=r}set(e,t,s,r){return this.x=e,this.y=t,this.z=s,this.w=r,this}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var s=Math.sin(e),r=Math.cos(e);t.x=this.x*r+this.w*s,t.y=this.y*r+this.z*s,t.z=this.z*r-this.y*s,t.w=this.w*r-this.x*s}rotateY(e,t){e*=.5;var s=Math.sin(e),r=Math.cos(e);t.x=this.x*r-this.z*s,t.y=this.y*r+this.w*s,t.z=this.z*r+this.x*s,t.w=this.w*r-this.y*s}rotateZ(e,t){e*=.5;var s=Math.sin(e),r=Math.cos(e);t.x=this.x*r+this.y*s,t.y=this.y*r-this.x*s,t.z=this.z*r+this.w*s,t.w=this.w*r-this.z*s}getYawPitchRoll(e){a.transformQuat(a.ForwardRH,this,Ws);let t=Xs,s=Ys;a.transformQuat(a.Up,this,t),zs.angleTo(a.ZERO,Ws,s),s.x==Math.PI/2?(s.y=zs.arcTanAngle(t.z,t.x),s.z=0):s.x==-Math.PI/2?(s.y=zs.arcTanAngle(-t.z,-t.x),s.z=0):(js.createRotationY(-s.y,js.TEMP),a.transformCoordinate(t,js.TEMP,t),js.createRotationX(-s.x,js.TEMP),a.transformCoordinate(t,js.TEMP,t),s.z=zs.arcTanAngle(t.y,-t.x)),s.y<=-Math.PI&&(s.y=Math.PI),s.z<=-Math.PI&&(s.z=Math.PI),s.y>=Math.PI&&s.z>=Math.PI&&(s.y=0,s.z=0,s.x=Math.PI-s.x);var r=e;r.x=s.y,r.y=s.x,r.z=s.z}invert(e){var t=this.x,s=this.y,r=this.z,i=this.w,a=t*t+s*s+r*r+i*i,n=a?1/a:0;e.x=-t*n,e.y=-s*n,e.z=-r*n,e.w=i*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var e=new zs;return this.cloneTo(e),e}equals(e){return r.nearEqual(this.x,e.x)&&r.nearEqual(this.y,e.y)&&r.nearEqual(this.z,e.z)&&r.nearEqual(this.w,e.w)}static rotationLookAt(e,t,s){zs.lookAt(a.ZERO,e,t,s)}static lookAt(e,t,s,r){Us.lookAt(e,t,s,Us.TEMP),zs.rotationMatrix(Us.TEMP,r)}static forwardLookAt(e,t,s,r){Us.forwardLookAt(e,t,s,Us.TEMP),zs.rotationMatrix(Us.TEMP,r)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var s=e.lengthSquared();r.isZero(s)||(s=1/s,t.x=-e.x*s,t.y=-e.y*s,t.z=-e.z*s,t.w=e.w*s)}static rotationMatrix(e,t){var s,r,i=e.elements,a=i[0],n=i[1],o=i[2],l=i[3],h=i[4],d=i[5],u=i[6],c=i[7],_=i[8],p=a+h+_;p>0?(s=Math.sqrt(p+1),t.w=.5*s,s=.5/s,t.x=(d-c)*s,t.y=(u-o)*s,t.z=(n-l)*s):a>=h&&a>=_?(r=.5/(s=Math.sqrt(1+a-h-_)),t.x=.5*s,t.y=(n+l)*r,t.z=(o+u)*r,t.w=(d-c)*r):h>_?(r=.5/(s=Math.sqrt(1+h-a-_)),t.x=(l+n)*r,t.y=.5*s,t.z=(c+d)*r,t.w=(u-o)*r):(r=.5/(s=Math.sqrt(1+_-a-h)),t.x=(u+o)*r,t.y=(c+d)*r,t.z=.5*s,t.w=(n-l)*r)}}zs.TEMP=new zs,zs.DEFAULT=new zs,zs.NAN=new zs(NaN,NaN,NaN,NaN);const Hs=new a,Ws=new a,Xs=new a,Ys=new a,qs=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class js{static createRotationX(e,t){var s=t.elements,r=Math.sin(e),i=Math.cos(e);s[1]=s[2]=s[3]=s[4]=s[7]=s[8]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[15]=1,s[5]=s[10]=i,s[6]=r,s[9]=-r}static createRotationY(e,t){var s=t.elements,r=Math.sin(e),i=Math.cos(e);s[1]=s[3]=s[4]=s[6]=s[7]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[5]=s[15]=1,s[0]=s[10]=i,s[2]=-r,s[8]=r}static createRotationZ(e,t){var s=t.elements,r=Math.sin(e),i=Math.cos(e);s[2]=s[3]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[10]=s[15]=1,s[0]=s[5]=i,s[1]=r,s[4]=-r}static createRotationYawPitchRoll(e,t,s,r){zs.createFromYawPitchRoll(e,t,s,zs.TEMP),js.createRotationQuaternion(zs.TEMP,r)}static createRotationAxis(e,t,s){var r=e.x,i=e.y,a=e.z,n=Math.cos(t),o=Math.sin(t),l=r*r,h=i*i,d=a*a,u=r*i,c=r*a,_=i*a,p=s.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=l+n*(1-l),p[1]=u-n*u+o*a,p[2]=c-n*c-o*i,p[4]=u-n*u-o*a,p[5]=h+n*(1-h),p[6]=_-n*_+o*r,p[8]=c-n*c+o*i,p[9]=_-n*_-o*r,p[10]=d+n*(1-d)}static createRotationQuaternion(e,t){var s=t.elements,r=e.x,i=e.y,a=e.z,n=e.w,o=r*r,l=i*i,h=a*a,d=r*i,u=a*n,c=a*r,_=i*n,p=i*a,g=r*n;s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=1-2*(l+h),s[1]=2*(d+u),s[2]=2*(c-_),s[4]=2*(d-u),s[5]=1-2*(h+o),s[6]=2*(p+g),s[8]=2*(c+_),s[9]=2*(p-g),s[10]=1-2*(l+o)}static createTranslate(e,t){var s=t.elements;s[4]=s[8]=s[1]=s[9]=s[2]=s[6]=s[3]=s[7]=s[11]=0,s[0]=s[5]=s[10]=s[15]=1,s[12]=e.x,s[13]=e.y,s[14]=e.z}static createScaling(e,t){var s=t.elements;s[0]=e.x,s[5]=e.y,s[10]=e.z,s[1]=s[4]=s[8]=s[12]=s[9]=s[13]=s[2]=s[6]=s[14]=s[3]=s[7]=s[11]=0,s[15]=1}static multiply(e,t,s){var r=t.elements,i=e.elements,a=s.elements,n=r[0],o=r[1],l=r[2],h=r[3],d=r[4],u=r[5],c=r[6],_=r[7],p=r[8],g=r[9],m=r[10],f=r[11],T=r[12],y=r[13],x=r[14],S=r[15],E=i[0],v=i[1],D=i[2],w=i[3],b=i[4],C=i[5],R=i[6],M=i[7],A=i[8],I=i[9],P=i[10],B=i[11],L=i[12],N=i[13],F=i[14],O=i[15];a[0]=n*E+o*b+l*A+h*L,a[1]=n*v+o*C+l*I+h*N,a[2]=n*D+o*R+l*P+h*F,a[3]=n*w+o*M+l*B+h*O,a[4]=d*E+u*b+c*A+_*L,a[5]=d*v+u*C+c*I+_*N,a[6]=d*D+u*R+c*P+_*F,a[7]=d*w+u*M+c*B+_*O,a[8]=p*E+g*b+m*A+f*L,a[9]=p*v+g*C+m*I+f*N,a[10]=p*D+g*R+m*P+f*F,a[11]=p*w+g*M+m*B+f*O,a[12]=T*E+y*b+x*A+S*L,a[13]=T*v+y*C+x*I+S*N,a[14]=T*D+y*R+x*P+S*F,a[15]=T*w+y*M+x*B+S*O}static createFromQuaternion(e,t){var s=t.elements,r=e.x,i=e.y,a=e.z,n=e.w,o=r+r,l=i+i,h=a+a,d=r*o,u=i*o,c=i*l,_=a*o,p=a*l,g=a*h,m=n*o,f=n*l,T=n*h;s[0]=1-c-g,s[1]=u+T,s[2]=_-f,s[3]=0,s[4]=u-T,s[5]=1-d-g,s[6]=p+m,s[7]=0,s[8]=_+f,s[9]=p-m,s[10]=1-d-c,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1}static createAffineTransformation(e,t,s,r){var i=r.elements,a=t.x,n=t.y,o=t.z,l=t.w,h=a+a,d=n+n,u=o+o,c=a*h,_=a*d,p=a*u,g=n*d,m=n*u,f=o*u,T=l*h,y=l*d,x=l*u,S=s.x,E=s.y,v=s.z;i[0]=(1-(g+f))*S,i[1]=(_+x)*S,i[2]=(p-y)*S,i[3]=0,i[4]=(_-x)*E,i[5]=(1-(c+f))*E,i[6]=(m+T)*E,i[7]=0,i[8]=(p+y)*v,i[9]=(m-T)*v,i[10]=(1-(c+g))*v,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}static createLookAt(e,t,s,r){var i=r.elements,n=Ks,o=$s,l=Qs;a.subtract(e,t,l),a.normalize(l,l),a.cross(s,l,n),a.normalize(n,n),a.cross(l,n,o),i[3]=i[7]=i[11]=0,i[15]=1,i[0]=n.x,i[4]=n.y,i[8]=n.z,i[1]=o.x,i[5]=o.y,i[9]=o.z,i[2]=l.x,i[6]=l.y,i[10]=l.z,i[12]=-a.dot(n,e),i[13]=-a.dot(o,e),i[14]=-a.dot(l,e)}static createPerspective(e,t,s,r,i){var a=1/Math.tan(.5*e),n=s/(a/t),o=s/a;js.createPerspectiveOffCenter(-n,n,-o,o,s,r,i)}static createPerspectiveOffCenter(e,t,s,r,i,a,n){var o=n.elements,l=a/(a-i);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[12]=o[13]=o[15]=0,o[0]=2*i/(t-e),o[5]=2*i/(r-s),o[8]=(e+t)/(t-e),o[9]=(r+s)/(r-s),o[10]=-l,o[11]=-1,o[14]=-i*l}static createOrthoOffCenter(e,t,s,r,i,a,n){var o=n.elements,l=1/(a-i);o[1]=o[2]=o[3]=o[4]=o[6]=o[8]=o[7]=o[9]=o[11]=0,o[15]=1,o[0]=2/(t-e),o[5]=2/(r-s),o[10]=-l,o[12]=(e+t)/(e-t),o[13]=(r+s)/(s-r),o[14]=-i*l}constructor(e=1,t=0,s=0,r=0,i=0,a=1,n=0,o=0,l=0,h=0,d=1,u=0,c=0,_=0,p=0,g=1,m=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var f=this.elements=m||new Float32Array(16);f[0]=e,f[1]=t,f[2]=s,f[3]=r,f[4]=i,f[5]=a,f[6]=n,f[7]=o,f[8]=l,f[9]=h,f[10]=d,f[11]=u,f[12]=c,f[13]=_,f[14]=p,f[15]=g}}else this.elements=qs.slice()}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,s){if(e<0||e>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=s}setRotation(e){var t=e.x,s=e.y,r=e.z,i=e.w,a=t*t,n=s*s,o=r*r,l=t*s,h=r*i,d=r*t,u=s*i,c=s*r,_=t*i,p=this.elements;p[0]=1-2*(n+o),p[1]=2*(l+h),p[2]=2*(d-u),p[4]=2*(l-h),p[5]=1-2*(o+a),p[6]=2*(c+_),p[8]=2*(d+u),p[9]=2*(c-_),p[10]=1-2*(n+a)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}equalsOtherMatrix(e){var t=this.elements,s=e.elements;return r.nearEqual(t[0],s[0])&&r.nearEqual(t[1],s[1])&&r.nearEqual(t[2],s[2])&&r.nearEqual(t[3],s[3])&&r.nearEqual(t[4],s[4])&&r.nearEqual(t[5],s[5])&&r.nearEqual(t[6],s[6])&&r.nearEqual(t[7],s[7])&&r.nearEqual(t[8],s[8])&&r.nearEqual(t[9],s[9])&&r.nearEqual(t[10],s[10])&&r.nearEqual(t[11],s[11])&&r.nearEqual(t[12],s[12])&&r.nearEqual(t[13],s[13])&&r.nearEqual(t[14],s[14])&&r.nearEqual(t[15],s[15])}decomposeTransRotScale(e,t,s){var r=Js;return this.decomposeTransRotMatScale(e,r,s)?(zs.createFromMatrix4x4(r,t),!0):(t.identity(),!1)}decomposeTransRotMatScale(e,t,s){var i=this.elements,n=e,o=t.elements,l=s;n.x=i[12],n.y=i[13],n.z=i[14];var h=i[0],d=i[1],u=i[2],c=i[4],_=i[5],p=i[6],g=i[8],m=i[9],f=i[10],T=l.x=Math.sqrt(h*h+d*d+u*u),y=l.y=Math.sqrt(c*c+_*_+p*p),x=l.z=Math.sqrt(g*g+m*m+f*f);if(r.isZero(T)||r.isZero(y)||r.isZero(x))return o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=o[12]=o[13]=o[14]=0,o[0]=o[5]=o[10]=o[15]=1,!1;var S=Ks;S.x=g/x,S.y=m/x,S.z=f/x;var E=$s;E.x=h/T,E.y=d/T,E.z=u/T;var v=Qs;a.cross(S,E,v);var D=$s;return a.cross(v,S,D),o[3]=o[7]=o[11]=o[12]=o[13]=o[14]=0,o[15]=1,o[0]=D.x,o[1]=D.y,o[2]=D.z,o[4]=v.x,o[5]=v.y,o[6]=v.z,o[8]=S.x,o[9]=S.y,o[10]=S.z,o[0]*h+o[1]*d+o[2]*u<0&&(l.x=-T),o[4]*c+o[5]*_+o[6]*p<0&&(l.y=-y),o[8]*g+o[9]*m+o[10]*f<0&&(l.z=-x),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>r.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],s=e[1],r=e[2],i=Math.sqrt(t*t+s*s+r*r);if(!i)return e[0]=0,e[1]=0,void(e[2]=0);1!=i&&(i=1/i,e[0]=t*i,e[1]=s*i,e[2]=r*i)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,s=e.elements,r=t[0],i=t[1],a=t[2],n=t[3],o=t[4],l=t[5],h=t[6],d=t[7],u=t[8],c=t[9],_=t[10],p=t[11],g=t[12],m=t[13],f=t[14],T=t[15],y=r*l-i*o,x=r*h-a*o,S=r*d-n*o,E=i*h-a*l,v=i*d-n*l,D=a*d-n*h,w=u*m-c*g,b=u*f-_*g,C=u*T-p*g,R=c*f-_*m,M=c*T-p*m,A=_*T-p*f,I=y*A-x*M+S*R+E*C-v*b+D*w;0!==Math.abs(I)&&(I=1/I,s[0]=(l*A-h*M+d*R)*I,s[1]=(a*M-i*A-n*R)*I,s[2]=(m*D-f*v+T*E)*I,s[3]=(_*v-c*D-p*E)*I,s[4]=(h*C-o*A-d*b)*I,s[5]=(r*A-a*C+n*b)*I,s[6]=(f*S-g*D-T*x)*I,s[7]=(u*D-_*S+p*x)*I,s[8]=(o*M-l*C+d*w)*I,s[9]=(i*C-r*M-n*w)*I,s[10]=(g*v-m*S+T*y)*I,s[11]=(c*S-u*v-p*y)*I,s[12]=(l*b-o*R-h*w)*I,s[13]=(r*R-i*b+a*w)*I,s[14]=(m*x-g*E-f*y)*I,s[15]=(u*E-c*x+_*y)*I)}static billboard(e,t,s,i,n){a.subtract(e,t,Ks);var o=a.scalarLengthSquared(Ks);r.isZero(o)?(a.scale(i,-1,$s),$s.cloneTo(Ks)):a.scale(Ks,1/Math.sqrt(o),Ks),a.cross(s,Ks,Qs),a.normalize(Qs,Qs),a.cross(Ks,Qs,Zs);var l=Qs,h=Zs,d=Ks,u=e,c=n.elements;c[0]=l.x,c[1]=l.y,c[2]=l.z,c[3]=0,c[4]=h.x,c[5]=h.y,c[6]=h.z,c[7]=0,c[8]=d.x,c[9]=d.y,c[10]=d.z,c[11]=0,c[12]=u.x,c[13]=u.y,c[14]=u.z,c[15]=1}identity(){this.elements.set(qs)}isIdentity(){let e=function(e,t){return Math.abs(e-t)<1e-7},t=this.elements,s=js.DEFAULT.elements;for(let r=0,i=t.length;r<i;r++)if(!e(t[r],s[r]))return!1;return!0}cloneTo(e){this.elements!==e.elements&&e.elements.set(this.elements)}cloneByArray(e){this.elements.set(e)}clone(){var e=new js(null);return e.elements=this.elements.slice(),e}static translation(e,t){var s=t.elements;s[0]=s[5]=s[10]=s[15]=1,s[12]=e.x,s[13]=e.y,s[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,s=e;t[12]=s.x,t[13]=s.y,t[14]=s.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}getInvertFront(){this.decomposeTransRotScale(Ks,zs.TEMP,$s);var e=$s,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}js.TEMP=new js,js.DEFAULT=new js,js.DEFAULTINVERT=new js(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),js.ZERO=new js(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Ks=new a,$s=new a,Qs=new a,Zs=new a,Js=new js;var er;function tr(t,s){let r=!1;switch(s){case e.ShaderDataType.Int:case e.ShaderDataType.Float:r="number"==typeof t;break;case e.ShaderDataType.Bool:r="boolean"==typeof t;break;case e.ShaderDataType.Vector2:r=t instanceof ct;break;case e.ShaderDataType.Vector3:r=t instanceof a;break;case e.ShaderDataType.Vector4:r=t instanceof i;break;case e.ShaderDataType.Color:r=t instanceof y;break;case e.ShaderDataType.Matrix4x4:r=t instanceof js;break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:r=t instanceof G;break;case e.ShaderDataType.Buffer:r=t instanceof ArrayBuffer;break;case e.ShaderDataType.Matrix3x3:r=t instanceof Us;break;default:r=!1}return r||console.warn("The setting value and Shader type do not match"),r}function sr(t){switch(t){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return ct.ZERO;case e.ShaderDataType.Vector3:return a.ZERO;case e.ShaderDataType.Vector4:return i.ZERO;case e.ShaderDataType.Color:return y.BLACK;case e.ShaderDataType.Matrix4x4:return js.DEFAULT;case e.ShaderDataType.Matrix3x3:return Us.DEFAULT}return null}e.ShaderDataType=void 0,(er=e.ShaderDataType||(e.ShaderDataType={}))[er.None=0]="None",er[er.Int=1]="Int",er[er.Bool=2]="Bool",er[er.Float=3]="Float",er[er.Vector2=4]="Vector2",er[er.Vector3=5]="Vector3",er[er.Vector4=6]="Vector4",er[er.Color=7]="Color",er[er.Matrix4x4=8]="Matrix4x4",er[er.Buffer=9]="Buffer",er[er.Matrix3x3=10]="Matrix3x3",er[er.ReadOnlyDeviceBuffer=11]="ReadOnlyDeviceBuffer",er[er.DeviceBuffer=12]="DeviceBuffer",er[er.StorageTexture2D=13]="StorageTexture2D",er[er.Texture2D=14]="Texture2D",er[er.Texture3D=15]="Texture3D",er[er.TextureCube=16]="TextureCube",er[er.Texture2DArray=17]="Texture2DArray";class rr{constructor(e,t,s){this._owner=e,this.name=t,this._VS=s.vsNode,this._PS=s.psNode,this._defs=s.defs,this._validDefine=f.unitRenderModuleDataFactory.createDefineDatas();for(let e of s.defs)this._validDefine.add(gr.getDefineByName(e));this._validDefine.add(gr.getDefineByName("VBONEW")),this._validDefine.add(gr.getDefineByName("VBONEI"))}withCompile(e){return null}}class ir extends rr{get pipelineMode(){return this._pipelineMode}set pipelineMode(e){this._pipelineMode=e,this.moduleData.pipelineMode=e}set nodeCommonMap(e){this.moduleData.nodeCommonMap=e}get nodeCommonMap(){return this.moduleData.nodeCommonMap}set additionShaderData(e){this.moduleData.additionShaderData=e}get additionShaderData(){return this.moduleData.additionShaderData}get statefirst(){return this._statefirst}set statefirst(e){this._statefirst=e,this.moduleData.statefirst=e}get attributeLocations(){return this.moduleData.attributeLocations}set attributeLocations(e){this.moduleData.attributeLocations=e}get renderState(){return this.moduleData.renderState}constructor(e,t){super(e,e._owner.name,t),this._statefirst=!1,this.moduleData=f.unitRenderModuleDataFactory.createShaderPass(this),this.moduleData.validDefine=this._validDefine,this.moduleData.name=this.name}static createShaderInstance(e,t,s){ar.length=0,gr._getNamesByDefineData(s,ar);let r={is2D:t,vs:e._VS,ps:e._PS,attributeMap:e._owner._attributeMap,uniformMap:e._owner._uniformMap,defineString:ar};return f.renderDeviceFactory.createShaderInstance(r,e)}withCompile(e,t=!1){var s=this.moduleData.getCacheShader(e);return s||(s=ir.createShaderInstance(this,t,e),this.moduleData.setCacheShader(e,s),s)}withComplieByBin(e,t=!1,s){var r=this.moduleData.getCacheShader(e);return r||(this.moduleData.setCacheShader(e,r),null)}}const ar=[];class nr{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(e,t,s){this._offset=e,this._elementFormat=t,this._elementUsage=s}}var or,lr,hr;e.RenderParams=void 0,(or=e.RenderParams||(e.RenderParams={}))[or.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",or[or.Max_Uniform_Count=1]="Max_Uniform_Count",or[or.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",or[or.MAX_Texture_Size=3]="MAX_Texture_Size",or[or.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",or[or.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",or[or.FLOAT=6]="FLOAT",or[or.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",or[or.BYTE=8]="BYTE",or[or.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class dr{static __init__(){dr._elementInfos={single:[1,f.renderEngine.getParams(e.RenderParams.FLOAT),0],vector2:[2,f.renderEngine.getParams(e.RenderParams.FLOAT),0],vector3:[3,f.renderEngine.getParams(e.RenderParams.FLOAT),0],vector4:[4,f.renderEngine.getParams(e.RenderParams.FLOAT),0],color:[4,f.renderEngine.getParams(e.RenderParams.FLOAT),0],byte4:[4,f.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte3:[3,f.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte2:[2,f.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte:[1,f.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],short2:[2,f.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],short4:[4,f.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,f.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,f.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,f.renderEngine.getParams(e.RenderParams.FLOAT),0],halfvector4:[4,f.renderEngine.getParams(e.RenderParams.FLOAT),0],nbyte4:[4,f.renderEngine.getParams(e.RenderParams.BYTE),1],ubyte4:[4,f.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(e){var t=dr._elementInfos[e];if(t)return t;throw new C}}dr.Single="single",dr.Vector2="vector2",dr.Vector3="vector3",dr.Vector4="vector4",dr.Color="color",dr.Byte4="byte4",dr.Byte3="byte3",dr.Byte2="byte2",dr.ByteOne="byte",dr.Short2="short2",dr.Short4="short4",dr.NormalizedShort2="normalizedshort2",dr.NormalizedShort4="normalizedshort4",dr.HalfVector2="halfvector2",dr.HalfVector4="halfvector4",dr.NorByte4="nbyte4",dr.NorUByte4="ubyte4";class ur{}class cr{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(e,t){this._id=++cr._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t,this._VAElements=[];var s=t.length;this._shaderValues={};for(var r=0;r<s;r++){var i=t[r],a=i._elementUsage;this._vertexElementsDic[a]=i;var n=new ur,o=dr.getElementInfos(i._elementFormat);n.elementString=i._elementFormat,n.elementCount=o[0],n.elementType=o[1],n.normalized=o[2],n.vertexStride=this._vertexStride,n.elementOffset=i._offset,this._shaderValues[a]=n,this._VAElements.push({format:i._elementFormat,stride:i._offset,shaderLocation:a})}}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}cr._uniqueIDCounter=1;class _r{static __init__(){_r.instanceWorldMatrixDeclaration=new cr(80,[new nr(0,dr.Vector4,_r.MESH_WORLDMATRIX_ROW0),new nr(16,dr.Vector4,_r.MESH_WORLDMATRIX_ROW1),new nr(32,dr.Vector4,_r.MESH_WORLDMATRIX_ROW2),new nr(48,dr.Vector4,_r.MESH_WORLDMATRIX_ROW3),new nr(64,dr.Vector4,_r.MESH_CUSTOME2)]),_r.instanceSimpleAnimatorDeclaration=new cr(16,[new nr(0,dr.Vector4,_r.MESH_SIMPLEANIMATOR)]),_r.instanceLightMapScaleOffsetDeclaration=new cr(16,[new nr(0,dr.Vector4,_r.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(e,t=!0){var s=_r._vertexDeclarationMap[e+(t?"_0":"_1")];if(!s){for(var r=e.split(","),i=0,a=[],n=0,o=r.length;n<o;n++){var l;switch(r[n]){case"POSITION":l=new nr(i,dr.Vector3,_r.MESH_POSITION0),i+=12;break;case"NORMAL":l=new nr(i,dr.Vector3,_r.MESH_NORMAL0),i+=12;break;case"COLOR":l=new nr(i,dr.Vector4,_r.MESH_COLOR0),i+=16;break;case"UV":l=new nr(i,dr.Vector2,_r.MESH_TEXTURECOORDINATE0),i+=8;break;case"UV1":l=new nr(i,dr.Vector2,_r.MESH_TEXTURECOORDINATE1),i+=8;break;case"BLENDWEIGHT":l=new nr(i,dr.Vector4,_r.MESH_BLENDWEIGHT0),i+=16;break;case"BLENDINDICES":t?(l=new nr(i,dr.Vector4,_r.MESH_BLENDINDICES0),i+=16):(l=new nr(i,dr.Byte4,_r.MESH_BLENDINDICES0),i+=4);break;case"TANGENT":l=new nr(i,dr.Vector4,_r.MESH_TANGENT0),i+=16;break;case"NORMAL_BYTE":l=new nr(i,dr.NorByte4,_r.MESH_NORMAL0),i+=4;break;default:throw"VertexMesh: unknown vertex flag."}a.push(l)}s=new cr(i,a),_r._vertexDeclarationMap[e+(t?"_0":"_1")]=s}return s}}_r.MESH_POSITION0=0,_r.MESH_COLOR0=1,_r.MESH_TEXTURECOORDINATE0=2,_r.MESH_NORMAL0=3,_r.MESH_TANGENT0=4,_r.MESH_BLENDINDICES0=5,_r.MESH_BLENDWEIGHT0=6,_r.MESH_TEXTURECOORDINATE1=7,_r.MESH_WORLDMATRIX_ROW0=8,_r.MESH_WORLDMATRIX_ROW1=9,_r.MESH_WORLDMATRIX_ROW2=10,_r.MESH_WORLDMATRIX_ROW3=11,_r.MESH_SIMPLEANIMATOR=12,_r.MESH_LIGHTMAPSCALEOFFSET=13,_r.MESH_CUSTOME0=12,_r.MESH_CUSTOME1=13,_r.MESH_CUSTOME2=14,_r.MESH_CUSTOME3=15,_r._vertexDeclarationMap={};class pr{static regIncludeBindUnifrom(e,t,s){let r={},i=r[e]={};i.uniformMap=t,i.defaultValue=s,Object.assign(pr.IncludeUniformMap,r)}constructor(t=pr.DefaultAttributeMap,s={},r=null){this._flags={},this._passes=[],this.moduleData=f.unitRenderModuleDataFactory.createSubShader(),this._attributeMap=t,this._uniformDefaultValue=r,this._uniformMap=new Map;for(const t in s)if("object"==typeof s[t]){let e=s[t];for(const t in e){let s=e[t];this.addUniform(t,s)}}else{let r=s[t];if(this.addUniform(t,r),r==e.ShaderDataType.Texture2D||r==e.ShaderDataType.TextureCube||r==e.ShaderDataType.Texture3D||r==e.ShaderDataType.Texture2DArray){let e=gr.getDefineByName(`Gamma_${t}`),s=gr.propertyNameToID(t);f.renderEngine.addTexGammaDefine(s,e)}}this.moduleData.setUniformMap(this._uniformMap)}addUniform(t,s){let r=t,i=function(e){let t=e.lastIndexOf("]"),s=e.lastIndexOf("[");if(-1!=s&&t==e.length-1){let r=e.slice(s+1,t),i=parseInt(r);if(!isNaN(i)&&i>0)return i}return 0}(t);i>0&&(r=t.substring(0,t.lastIndexOf("[")));let a={id:gr.propertyNameToID(r),propertyName:r,uniformtype:s,arrayLength:i};if(this._uniformMap.set(a.id,a),s==e.ShaderDataType.Texture2D||s==e.ShaderDataType.TextureCube||s==e.ShaderDataType.Texture3D||s==e.ShaderDataType.Texture2DArray){let e=gr.getDefineByName(`Gamma_${t}`);f.renderEngine.addTexGammaDefine(a.id,e)}}addShaderPass(e,t,s="Forward"){return this._addShaderPass(Fs.compile(e,t),s)}_addShaderPass(e,t="Forward"){var s=new ir(this,e);return s.pipelineMode=t,this._passes.push(s),this.moduleData.addShaderPass(s.moduleData),this._addIncludeUniform(e.includeNames),s}_addIncludeUniform(e){for(let s of e)if(pr.IncludeUniformMap[s]){let e=pr.IncludeUniformMap[s],r=e.uniformMap,i=e.defaultValue;for(var t in r)this._uniformMap.has(gr.propertyNameToID(t))||this.addUniform(t,r[t]);for(var t in i)this._uniformDefaultValue[t]||(this._uniformDefaultValue[t]=i[t])}}}pr.IncludeUniformMap={},pr.DefaultAttributeMap={a_Position:[_r.MESH_POSITION0,e.ShaderDataType.Vector4],a_Normal:[_r.MESH_NORMAL0,e.ShaderDataType.Vector3],a_Tangent0:[_r.MESH_TANGENT0,e.ShaderDataType.Vector4],a_Texcoord0:[_r.MESH_TEXTURECOORDINATE0,e.ShaderDataType.Vector2],a_Texcoord1:[_r.MESH_TEXTURECOORDINATE1,e.ShaderDataType.Vector2],a_Color:[_r.MESH_COLOR0,e.ShaderDataType.Vector4],a_BoneWeights:[_r.MESH_BLENDWEIGHT0,e.ShaderDataType.Vector4],a_BoneIndices:[_r.MESH_BLENDINDICES0,e.ShaderDataType.Vector4],a_WorldMat:[_r.MESH_WORLDMATRIX_ROW0,e.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[_r.MESH_SIMPLEANIMATOR,e.ShaderDataType.Vector4],a_LightmapScaleOffset:[_r.MESH_LIGHTMAPSCALEOFFSET,e.ShaderDataType.Vector4],a_WorldInvertFront:[_r.MESH_CUSTOME2,e.ShaderDataType.Vector4]},e.ShaderFeatureType=void 0,(lr=e.ShaderFeatureType||(e.ShaderFeatureType={}))[lr.None=-1]="None",lr[lr.Default=0]="Default",lr[lr.D3=1]="D3",lr[lr.D2_primitive=2]="D2_primitive",lr[lr.D2_TextureSV=3]="D2_TextureSV",lr[lr.D2_BaseRenderNode2D=4]="D2_BaseRenderNode2D",lr[lr.PostProcess=5]="PostProcess",lr[lr.Sky=6]="Sky",lr[lr.Effect=7]="Effect";class gr{static init(){gr._configDefineValues=f.unitRenderModuleDataFactory.createDefineDatas(),gr.SHADERDEFINE_REMAP_POSITIONZ=gr.getDefineByName("REMAP_Z"),gr.SHADERDEFINE_LOD_TEXTURE_SAMPLE=gr.getDefineByName("LOD_TEXTURE_SAMPLE"),gr.SHADERDEFINE_BREAK_TEXTURE_SAMPLE=gr.getDefineByName("BREAK_TEXTURE_SAMPLE"),f.renderEngine._remapZ&&gr._configDefineValues.add(gr.SHADERDEFINE_REMAP_POSITIONZ),f.renderEngine._lodTextureSample&&gr._configDefineValues.add(gr.SHADERDEFINE_LOD_TEXTURE_SAMPLE),f.renderEngine._breakTextureSample&&gr._configDefineValues.add(gr.SHADERDEFINE_BREAK_TEXTURE_SAMPLE),gr._compileDefineDatas=f.unitRenderModuleDataFactory.createDefineDatas()}static _getNamesByDefineData(e,t){return f.renderEngine.getNamesByDefineData(e,t),t}static getDefineByName(e){return f.renderEngine.getDefineByName(e)}static propertyNameToID(e){return f.renderEngine.propertyNameToID(e)}static propertyIDToName(e){return f.renderEngine.propertyIDToName(e)}static addInclude(e,t){Fs.addInclude(e,t)}static compileShaderByDefineNames(e,t,s,r,i,a,n,o){var l=gr.find(e);if(l){var h=l.getSubShaderAt(t);if(h){var d=h._passes[s];if(d){d.nodeCommonMap=i,d.additionShaderData=a,d.attributeLocations=new Set(o);var u=gr._compileDefineDatas;gr._configDefineValues.cloneTo(u);for(let e of r)u.add(gr.getDefineByName(e));return d.withCompile(u,n),!0}}}return!1}static compileShaderByBin(e,t,s,r,i,a){var n=gr.find(e);if(n){var o=n.getSubShaderAt(t);if(o){var l=o._passes[s];if(l.nodeCommonMap=i,l){var h=gr._compileDefineDatas;h.clear();for(let e of r)h.add(gr.getDefineByName(e));l.withComplieByBin(h,!1,a)}}}}static add(e,t=!1,s=!1){return gr._preCompileShader[e]=new gr(e,t,s)}static find(e){return gr._preCompileShader[e]}static parse(e,t){var s;e.name||console.warn("shader name is empty",e),e.uniformMap||console.warn(`${e.name}: uniformMap is empty`);let r=gr.add(e.name,e.enableInstancing,e.supportReflectionProbe);r._supportVolumetricGI=e.supportVolumetricGI,r.shaderType=e.shaderType;let i=new pr(e.attributeMap?e.attributeMap:pr.DefaultAttributeMap,e.uniformMap,e.defaultValue);r.addSubShader(i);let a=e.shaderPass;for(var n in a){let r=a[n];if(!r.VS){console.warn(`${e.name}: VS of pass ${n} is empty`);continue}if(!r.FS){console.warn(`${e.name}: FS of pass ${n} is empty`);continue}let o=i._addShaderPass(Fs.compile(r.VS,r.FS,t),r.pipeline);o.statefirst=null!==(s=r.statefirst)&&void 0!==s&&s,Fs.getRenderState(r.renderState,o.renderState)}return r}get name(){return this._name}constructor(t,s,r){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._supportVolumetricGI=!1,this._subShaders=[],this.shaderType=e.ShaderFeatureType.None,this._name=t,this._enableInstancing=s,this._supportReflectionProbe=r}addSubShader(e){this._subShaders.push(e),e._owner=this,e.moduleData.enableInstance=this._enableInstancing,e.moduleData.shaderName=this._name}getSubShaderAt(e){return this._subShaders[e]}}gr.PERIOD_CUSTOM=0,gr.PERIOD_MATERIAL=1,gr.PERIOD_SPRITE=2,gr.PERIOD_CAMERA=3,gr.PERIOD_SCENE=4,gr._propertyNameMap={},gr._preCompileShader={},gr.debugMode=!1;class mr{static __init__(){mr.VERTEX_SIZE=gr.getDefineByName("VERTEX_SIZE"),mr.FILLTEXTURE=gr.getDefineByName("FILLTEXTURE"),mr.RENDERTEXTURE=gr.getDefineByName("RENDERTEXTURE"),mr.MATERIALCLIP=gr.getDefineByName("MATERIALCLIP"),mr.GAMMASPACE=gr.getDefineByName("GAMMASPACE"),mr.INVERTY=gr.getDefineByName("INVERTY"),mr.GAMMATEXTURE=gr.getDefineByName("GAMMATEXTURE"),mr.TEXTURESHADER=gr.getDefineByName("TEXTUREVS"),mr.PRIMITIVESHADER=gr.getDefineByName("PRIMITIVEMESH"),mr.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){mr.UNIFORM_NMATRIX_0=gr.propertyNameToID("u_NMatrix_0"),mr.UNIFORM_NMATRIX_1=gr.propertyNameToID("u_NMatrix_1"),mr.UNIFORM_INVERTMAT_0=gr.propertyNameToID("u_InvertMat_0"),mr.UNIFORM_INVERTMAT_1=gr.propertyNameToID("u_InvertMat_1"),mr.UNIFORM_CLIPMATDIR=gr.propertyNameToID("u_clipMatDir"),mr.UNIFORM_CLIPMATPOS=gr.propertyNameToID("u_clipMatPos"),mr.UNIFORM_SIZE=gr.propertyNameToID("u_size"),mr.UNIFORM_VERTALPHA=gr.propertyNameToID("u_VertAlpha");const t=f.renderDeviceFactory.createGlobalUniformMap("Sprite2D");t.addShaderUniform(mr.UNIFORM_NMATRIX_0,"u_NMatrix_0",e.ShaderDataType.Vector3),t.addShaderUniform(mr.UNIFORM_NMATRIX_1,"u_NMatrix_1",e.ShaderDataType.Vector3),t.addShaderUniform(mr.UNIFORM_VERTALPHA,"u_VertAlpha",e.ShaderDataType.Float),t.addShaderUniform(mr.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(mr.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector4);let s=f.renderDeviceFactory.createGlobalUniformMap("Sprite2DPass");s.addShaderUniform(mr.UNIFORM_SIZE,"u_size",e.ShaderDataType.Vector2),s.addShaderUniform(mr.UNIFORM_INVERTMAT_0,"u_InvertMat_0",e.ShaderDataType.Vector3),s.addShaderUniform(mr.UNIFORM_INVERTMAT_1,"u_InvertMat_1",e.ShaderDataType.Vector3),mr.UNIFORM_MATERIAL_CLIPMATDIR=gr.propertyNameToID("u_mClipMatDir"),mr.UNIFORM_MATERIAL_CLIPMATPOS=gr.propertyNameToID("u_mClipMatPos"),mr.UNIFORM_VERTEX_SIZE=gr.propertyNameToID("u_vertexSize"),mr.UNIFORM_TEXRANGE=gr.propertyNameToID("u_TexRange"),mr.UNIFORM_SPRITETEXTURE=gr.propertyNameToID("u_spriteTexture");const r=f.renderDeviceFactory.createGlobalUniformMap("Sprite2DGraphics");r.addShaderUniform(mr.UNIFORM_MATERIAL_CLIPMATDIR,"u_mClipMatDir",e.ShaderDataType.Vector4),r.addShaderUniform(mr.UNIFORM_MATERIAL_CLIPMATPOS,"u_mClipMatPos",e.ShaderDataType.Vector4),r.addShaderUniform(mr.UNIFORM_VERTEX_SIZE,"u_vertexSize",e.ShaderDataType.Vector4),r.addShaderUniform(mr.UNIFORM_TEXRANGE,"u_TexRange",e.ShaderDataType.Vector4),r.addShaderUniform(mr.UNIFORM_SPRITETEXTURE,"u_spriteTexture",e.ShaderDataType.Texture2D)}}e.BlendMode=void 0,(hr=e.BlendMode||(e.BlendMode={}))[hr.invalid=0]="invalid",hr[hr.normal=1]="normal",hr[hr.add=2]="add",hr[hr.multiply=3]="multiply",hr[hr.screen=4]="screen",hr[hr.overlay=5]="overlay",hr[hr.light=6]="light",hr[hr.lighter=7]="lighter",hr[hr.mask=8]="mask",hr[hr.destinationOut=9]="destinationOut",hr[hr.addOld=10]="addOld",hr[hr.lighterOld=11]="lighterOld",hr[hr.sourceAlpha=12]="sourceAlpha";const fr={[e.BlendMode.normal]:0,[e.BlendMode.add]:1,[e.BlendMode.multiply]:2,[e.BlendMode.screen]:3,[e.BlendMode.overlay]:4,[e.BlendMode.light]:5,[e.BlendMode.mask]:6,[e.BlendMode.destinationOut]:7,[e.BlendMode.lighter]:1,[e.BlendMode.lighterOld]:8,[e.BlendMode.addOld]:8,[e.BlendMode.sourceAlpha]:9};class Tr{static _init_(){}static setShaderData(e,t,s=!0){switch(fr[e]){case 1:case 3:case 5:t.setInt(gr.BLEND_SRC,ws.BLENDPARAM_ONE),t.setInt(gr.BLEND_DST,ws.BLENDPARAM_ONE);break;case 2:t.setInt(gr.BLEND_SRC,ws.BLENDPARAM_DST_COLOR),t.setInt(gr.BLEND_DST,ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:t.setInt(gr.BLEND_SRC,ws.BLENDPARAM_ZERO),t.setInt(gr.BLEND_DST,ws.BLENDPARAM_SRC_ALPHA);break;case 7:t.setInt(gr.BLEND_SRC,ws.BLENDPARAM_ZERO),t.setInt(gr.BLEND_DST,ws.BLENDPARAM_ZERO);break;case 9:t.setInt(gr.BLEND_SRC,ws.BLENDPARAM_SRC_ALPHA),t.setInt(gr.BLEND_DST,ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:t.setInt(gr.BLEND_SRC,s?ws.BLENDPARAM_ONE:ws.BLENDPARAM_SRC_ALPHA),t.setInt(gr.BLEND_DST,ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}}static initBlendMode(e){e.setBool(gr.DEPTH_WRITE,!1),e.setInt(gr.DEPTH_TEST,ws.DEPTHTEST_OFF),e.setInt(gr.BLEND,ws.BLEND_ENABLE_ALL),e.setInt(gr.BLEND_EQUATION,ws.BLENDEQUATION_ADD),e.setInt(gr.BLEND_SRC,ws.BLENDPARAM_ONE),e.setInt(gr.BLEND_DST,ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA),e.setNumber(mr.UNIFORM_VERTALPHA,1),e.setInt(gr.CULL,ws.CULL_NONE)}}class yr{static create(e){if(null!=e){let t=e instanceof ht?e:ht.create(e);return t._drawStyle||(t._drawStyle=new yr(e))}return yr.DEFAULT}constructor(e){this._color=null!=e?e instanceof ht?e:ht.create(e):ht.create(0)}equal(e){return"string"==typeof e?this._color.strColor===e:e instanceof ht&&this._color.numColor===e.numColor}}yr.DEFAULT=yr.create(0);class xr{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(e){this.paths.length=1,this._curPath=this.paths[0]=new Sr,this._curPath.convex=e}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new Sr,this.paths.push(this._curPath)}addPoint(e,t){this._curPath.path.push(e,t)}push(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new Sr,this.paths.push(this._curPath)):(this._curPath=new Sr,this.paths.push(this._curPath));var s=this._curPath;s.path=e.slice(),s.convex=t}reset(){this.paths.length=0}}class Sr{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class Er{constructor(){}static _createArray(){var e=[];return e._length=0,e}static _init(){var e=Er._namemap={};return e[Er.TYPE_ALPHA]="_alpha",e[Er.TYPE_FONT]="font",e[Er.TYPE_LINEWIDTH]="lineWidth",e[Er.TYPE_ENABLEMERGE]="_mergeID",e[Er.TYPE_MARK]=e[Er.TYPE_TRANSFORM]=e[Er.TYPE_TRANSLATE]=[],e[Er.TYPE_TEXTBASELINE]="textBaseline",e[Er.TYPE_TEXTALIGN]="textAlign",e[Er.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[Er.TYPE_SHADER]="shader",e[Er.TYPE_FILTERS]="filters",e}isSaveMark(){return!1}restore(e){this._dataObj[this._valueName]=this._value,Er.POOL[Er.POOL._length++]=this,this._newSubmit&&e.breakNextMerge()}static save(e,t,s,r){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var i=Er.POOL,a=i._length>0?i[--i._length]:new Er;a._value=s[a._valueName=Er._namemap[t]],a._dataObj=s,a._newSubmit=r;var n=e._save;n[n._length++]=a}}}Er.TYPE_ALPHA=1,Er.TYPE_STYLE=2,Er.TYPE_FONT=8,Er.TYPE_LINEWIDTH=256,Er.TYPE_MARK=1024,Er.TYPE_TRANSFORM=2048,Er.TYPE_TRANSLATE=4096,Er.TYPE_ENABLEMERGE=8192,Er.TYPE_TEXTBASELINE=16384,Er.TYPE_TEXTALIGN=32768,Er.TYPE_GLOBALCOMPOSITEOPERATION=65536,Er.TYPE_CLIPRECT=131072,Er.TYPE_CLIPRECT_STENCIL=262144,Er.TYPE_IBVB=524288,Er.TYPE_SHADER=1048576,Er.TYPE_FILTERS=2097152,Er.TYPE_FILTERS_TYPE=4194304,Er.POOL=Er._createArray(),Er._namemap=Er._init();class vr{constructor(){this._globalClipMatrix=new Ce,this._clipInfoID=-1,this._clipRect=new te,this._clip_x=0,this._clip_y=0}isSaveMark(){return!1}restore(e){this._clipRect.width==vr.MAX.width&&this._clipRect.height==vr.MAX.height&&this._clip_x==vr.MAX.x&&this._clip_y==vr.MAX.y?e._clipRect=vr.MAX:this._clipRect.clone(e._clipRect),e._clip_x=this._clip_x,e._clip_y=this._clip_y,this._globalClipMatrix.copyTo(e._globalClipMatrix),e._clipInfoID=this._clipInfoID,vr.POOL[vr.POOL._length++]=this}static save(e){if((e._saveMark._saveuse&Er.TYPE_CLIPRECT)!=Er.TYPE_CLIPRECT){e._saveMark._saveuse|=Er.TYPE_CLIPRECT;var t=vr.POOL,s=t._length>0?t[--t._length]:new vr;e._globalClipMatrix.copyTo(s._globalClipMatrix),e._clipRect.clone(s._clipRect),s._clipInfoID=e._clipInfoID,s._clip_x=e._clip_x,s._clip_y=e._clip_y;var r=e._save;r[r._length++]=s}}}vr.MAX=new te(0,0,De.MAX_CLIP_SIZE,De.MAX_CLIP_SIZE),vr.POOL=Er._createArray();class Dr{constructor(){}isSaveMark(){return!1}restore(e){e["_"+this._key]=this._fillStyle,e._submitKey.other=this._other,Dr.POOL[Dr.POOL._length++]=this}static save(e,t){let s=e._saveMark;if((s._saveuse&Er.TYPE_STYLE)===Er.TYPE_STYLE)return;s._saveuse|=Er.TYPE_STYLE;let r=Dr.POOL,i=r._length>0?r[--r._length]:new Dr;i._fillStyle=e[t],i._other=e._submitKey.other,i._key=t}}Dr.POOL=Er._createArray();class wr{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(e){e._saveMark=this._preSaveMark,wr.POOL[wr.POOL._length++]=this}static Create(e){var t=wr.POOL,s=t._length>0?t[--t._length]:new wr;return s._saveuse=0,s._preSaveMark=e._saveMark,e._saveMark=s,s}}wr.POOL=Er._createArray();class br{constructor(){this._matrix=new Ce}isSaveMark(){return!1}restore(e){e._curMat=this._savematrix,e._matrixChanged=!1,br.POOL[br.POOL._length++]=this}static save(e){var t=e._saveMark;if((t._saveuse&Er.TYPE_TRANSFORM)!==Er.TYPE_TRANSFORM){t._saveuse|=Er.TYPE_TRANSFORM;var s=br.POOL,r=s._length>0?s[--s._length]:new br;r._savematrix=e._curMat,e._curMat=e._curMat.copyTo(r._matrix);var i=e._save;i[i._length++]=r}}}br.POOL=Er._createArray();class Cr{constructor(){this._mat=new Ce}isSaveMark(){return!1}restore(e){this._mat.copyTo(e._curMat),Cr.POOL[Cr.POOL._length++]=this}static save(e){var t=Cr.POOL,s=t._length>0?t[--t._length]:new Cr;e._curMat.copyTo(s._mat);var r=e._save;r[r._length++]=s}}Cr.POOL=Er._createArray();const Rr=new Array(256),Mr=new ct;class Ar{static createLine2(e,t,s,r,i,a){if(e.length<4)return null;let n=r;var o=Rr.length>e.length+2?Rr:new Array(e.length+2);o[0]=e[0],o[1]=e[1];var l=2,h=0,d=e.length;for(h=2;h<d;h+=2)Math.abs(e[h]-e[h-2])+Math.abs(e[h+1]-e[h-1])>.01&&(o[l++]=e[h],o[l++]=e[h+1]);let u=Math.abs(e[0]-o[l-2])+Math.abs(e[1]-o[l-1]);a&&u>0&&(u>1e-13?(o[l++]=e[0],o[l++]=e[1]):(o[l-2]=e[0],o[l-1]=e[1]));var c=i;let _=c.length;d=l/2;var p=s/2;let g,m,f=o[0],T=o[1],y=o[2],x=o[3];this.getNormal(f,T,y,x,p,Mr),c.push(f-Mr.x,T-Mr.y,f+Mr.x,T+Mr.y);let S=[],E=0;for(h=1;h<d-1;h++)f=o[2*(h-1)],T=o[2*(h-1)+1],y=o[2*h],x=o[2*h+1],g=o[2*(h+1)],m=o[2*(h+1)+1],E=this._setMiddleVertexs(f,T,y,x,g,m,p,c,Mr,S,E);if(f=o[l-4],T=o[l-3],y=o[l-2],x=o[l-1],y==o[0]&&x==o[1]){g=o[2],m=o[3],E=this._setMiddleVertexs(f,T,y,x,g,m,p,c,Mr,S,E);let e=c.length;c[_]=c[e-4],c[_+1]=c[e-3],c[_+2]=c[e-2],c[_+3]=c[e-1],S.push(E,E+1,1,E+1,1,0)}else this.getNormal(f,T,y,x,p,Mr),c.push(y-Mr.x,x-Mr.y,y+Mr.x,x+Mr.y),S.push(E,E+1,E+2,E+1,E+2,E+3);for(let e=0,s=S.length;e<s;e++){const s=S[e]+n;t.push(s)}return c}static _setMiddleVertexs(e,t,s,r,i,a,n,o,l,h,d){this.getNormal(e,t,s,r,n,l);let u=e-l.x,c=t-l.y,_=s-l.x,p=r-l.y,g=e+l.x,m=t+l.y,f=s+l.x,T=r+l.y;this.getNormal(s,r,i,a,n,l);let y=s-l.x,x=r-l.y,S=i-l.x,E=a-l.y,v=s+l.x,D=r+l.y,w=i+l.x,b=a+l.y,C=1,R=Ar.checkCrossPoint(u,c,_,p,y,x,S,E,o,g,m,w,b,s,r,n);return!1===R?this._createSimpleLineVertices(e,t,s,r,i,a,o,h,d,f,T,_,p):(C=Ar.checkCrossPoint(g,m,f,T,v,D,w,b,o,u,c,S,E,s,r,n),!1===C?(o.splice(o.length-2*R,2*R),this._createSimpleLineVertices(e,t,s,r,i,a,o,h,d,f,T,_,p)):(2===C?(this._setTurnPoint(o,2),h.push(d,d+1,d+3,d+1,d+3,d+2),d+=2,h.push(d,d+1,d+2),d+=1):2===R?(h.push(d,d+1,d+2,d+1,d+2,d+4),d+=2,h.push(d,d+1,d+2),d+=1):(h.push(d,d+1,d+2,d+1,d+2,d+3),d+=2),d))}static angleBetweenPoints(e,t,s,r,i,a){const n=e-s,o=t-r,l=i-s,h=a-r,d=n*l+o*h,u=Math.hypot(n,o),c=Math.hypot(l,h);if(0===u||0===c)return 0;let _=d/(u*c);return _=Math.min(1,Math.max(-1,_)),Math.acos(_)}static _createSimpleLineVertices(e,t,s,r,i,a,n,o,l,h,d,u,c){return this.angleBetweenPoints(e,t,s,r,i,a)>Math.PI/2?(n.push(u,c,h,d),o.push(l,l+1,l+2,l+1,l+2,l+3),l+=2):(n.push(h,d,u,c),o.push(l,l+1,l+3,l+1,l+3,l+2),l+=2)}static _setTurnPoint(e,t=0){let s=e[e.length-2-t],r=e[e.length-1-t],i=e[e.length-4-t],a=e[e.length-3-t];e[e.length-2-t]=i,e[e.length-1-t]=a,e[e.length-4-t]=s,e[e.length-3-t]=r}static checkCrossPoint(e,t,s,r,i,a,n,o,l,h,d,u,c,_,p,g){const m=this.getCrossPoint(e,t,s,r,i,a,n,o,!0);if(m)return l.push(m.x,m.y),1;if(!1===m)return!1;if(this.getCrossPoint(h,d,e,t,i,a,n,o,!0))return!1;if(this.getCrossPoint(e,t,s,r,n,o,u,c,!0))return!1;const f=this.getCrossPoint(e,t,s,r,i,a,n,o);if(f){return Math.abs(this.getDistance(_,p,f.x,f.y))>1.5*g?(l.push(s,r),l.push(i,a),2):(l.push(f.x,f.y),1)}return!1}static getCrossPoint(e,t,s,r,i,a,n,o,l=!1){const h=s-e,d=r-t,u=n-i,c=o-a,_=h*c-u*d;if(Math.abs(_)<1e-10)return!1;const p=((i-e)*c-(a-t)*u)/_,g=((i-e)*d-(a-t)*h)/_;if(l){if(p<0||p>1)return null;if(g<0||g>1)return null}return{x:e+p*h,y:t+p*d}}static getDistance(e,t,s,r){return Math.sqrt((e-s)*(e-s)+(t-r)*(t-r))}static getNormal(e,t,s,r,i,a){a||(a=new ct);let n=r-t,o=e-s,l=Math.sqrt(n*n+o*o);return a.x=n/l*i,a.y=o/l*i,a}static createLineTriangle(e,t,s,r,i,a,n){var o=e.slice(),l=o.length,h=o[0],d=o[1],u=o[2],c=(o[2],0),_=0,p=0,g=0,m=l/2;if(!(m<=1)&&2!=m){for(var f=new Array(4*m),T=0,y=0,x=0;x<m-1;x++)h=o[y++],d=o[y++],u=o[y++],g=o[y++]-d,0!=(p=u-h)&&0!=g&&(c=Math.sqrt(p*p+g*g))>.001&&(f[_=4*T]=h,f[_+1]=d,f[_+2]=p/c,f[_+3]=g/c,T++);for(r?(h=o[l-2],d=o[l-1],u=o[0],g=o[1]-d,0!=(p=u-h)&&0!=g&&(c=Math.sqrt(p*p+g*g))>.001&&(f[_=4*T]=h,f[_+1]=d,f[_+2]=p/c,f[_+3]=g/c,T++)):(f[_=4*T]=h,f[_+1]=d,f[_+2]=p/c,f[_+3]=g/c,T++),y=0,x=0;x<m;x++)h=o[y],d=o[y+1],u=o[y+2],o[y+3]}}}class Ir{constructor(e,t,s){this.i=e,this.x=t,this.y=s,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Pr{static earcut(e,t,s){s=s||2;var r,i,a,n,o,l,h,d=t&&t.length,u=d?t[0]*s:e.length,c=Pr.linkedList(e,0,u,s,!0),_=[];if(!c)return _;if(d&&(c=Pr.eliminateHoles(e,t,c,s)),e.length>80*s){r=a=e[0],i=n=e[1];for(var p=s;p<u;p+=s)(o=e[p])<r&&(r=o),(l=e[p+1])<i&&(i=l),o>a&&(a=o),l>n&&(n=l);h=0!==(h=Math.max(a-r,n-i))?1/h:0}return Pr.earcutLinked(c,_,s,r,i,h),_}static linkedList(e,t,s,r,i){var a,n;if(i===Pr.signedArea(e,t,s,r)>0)for(a=t;a<s;a+=r)n=Pr.insertNode(a,e[a],e[a+1],n);else for(a=s-r;a>=t;a-=r)n=Pr.insertNode(a,e[a],e[a+1],n);return n&&Pr.equals(n,n.next)&&(Pr.removeNode(n),n=n.next),n}static filterPoints(e,t){if(!e)return e;t||(t=e);var s,r=e;do{if(s=!1,r.steiner||!Pr.equals(r,r.next)&&0!==Pr.area(r.prev,r,r.next))r=r.next;else{if(Pr.removeNode(r),(r=t=r.prev)===r.next)break;s=!0}}while(s||r!==t);return t}static earcutLinked(e,t,s,r,i,a,n=null){if(e){!n&&a&&Pr.indexCurve(e,r,i,a);for(var o,l,h=e;e.prev!==e.next;)if(o=e.prev,l=e.next,a?Pr.isEarHashed(e,r,i,a):Pr.isEar(e))t.push(o.i/s),t.push(e.i/s),t.push(l.i/s),Pr.removeNode(e),e=l.next,h=l.next;else if((e=l)===h){n?1===n?(e=Pr.cureLocalIntersections(e,t,s),Pr.earcutLinked(e,t,s,r,i,a,2)):2===n&&Pr.splitEarcut(e,t,s,r,i,a):Pr.earcutLinked(Pr.filterPoints(e,null),t,s,r,i,a,1);break}}}static isEar(e){var t=e.prev,s=e,r=e.next;if(Pr.area(t,s,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(Pr.pointInTriangle(t.x,t.y,s.x,s.y,r.x,r.y,i.x,i.y)&&Pr.area(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}static isEarHashed(e,t,s,r){var i=e.prev,a=e,n=e.next;if(Pr.area(i,a,n)>=0)return!1;for(var o=i.x<a.x?i.x<n.x?i.x:n.x:a.x<n.x?a.x:n.x,l=i.y<a.y?i.y<n.y?i.y:n.y:a.y<n.y?a.y:n.y,h=i.x>a.x?i.x>n.x?i.x:n.x:a.x>n.x?a.x:n.x,d=i.y>a.y?i.y>n.y?i.y:n.y:a.y>n.y?a.y:n.y,u=Pr.zOrder(o,l,t,s,r),c=Pr.zOrder(h,d,t,s,r),_=e.nextZ;_&&_.z<=c;){if(_!==e.prev&&_!==e.next&&Pr.pointInTriangle(i.x,i.y,a.x,a.y,n.x,n.y,_.x,_.y)&&Pr.area(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=u;){if(_!==e.prev&&_!==e.next&&Pr.pointInTriangle(i.x,i.y,a.x,a.y,n.x,n.y,_.x,_.y)&&Pr.area(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}static cureLocalIntersections(e,t,s){var r=e;do{var i=r.prev,a=r.next.next;!Pr.equals(i,a)&&Pr.intersects(i,r,r.next,a)&&Pr.locallyInside(i,a)&&Pr.locallyInside(a,i)&&(t.push(i.i/s),t.push(r.i/s),t.push(a.i/s),Pr.removeNode(r),Pr.removeNode(r.next),r=e=a),r=r.next}while(r!==e);return r}static splitEarcut(e,t,s,r,i,a){var n=e;do{for(var o=n.next.next;o!==n.prev;){if(n.i!==o.i&&Pr.isValidDiagonal(n,o)){var l=Pr.splitPolygon(n,o);return n=Pr.filterPoints(n,n.next),l=Pr.filterPoints(l,l.next),Pr.earcutLinked(n,t,s,r,i,a),void Pr.earcutLinked(l,t,s,r,i,a)}o=o.next}n=n.next}while(n!==e)}static eliminateHoles(e,t,s,r){var i,a,n,o,l,h=[];for(i=0,a=t.length;i<a;i++)n=t[i]*r,o=i<a-1?t[i+1]*r:e.length,(l=Pr.linkedList(e,n,o,r,!1))===l.next&&(l.steiner=!0),h.push(Pr.getLeftmost(l));for(h.sort(Pr.compareX),i=0;i<h.length;i++)Pr.eliminateHole(h[i],s),s=Pr.filterPoints(s,s.next);return s}static compareX(e,t){return e.x-t.x}static eliminateHole(e,t){if(t=Pr.findHoleBridge(e,t)){var s=Pr.splitPolygon(t,e);Pr.filterPoints(s,s.next)}}static findHoleBridge(e,t){var s,r=t,i=e.x,a=e.y,n=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var o=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=i&&o>n){if(n=o,o===i){if(a===r.y)return r;if(a===r.next.y)return r.next}s=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!s)return null;if(i===n)return s.prev;var l,h=s,d=s.x,u=s.y,c=1/0;for(r=s.next;r!==h;)i>=r.x&&r.x>=d&&i!==r.x&&Pr.pointInTriangle(a<u?i:n,a,d,u,a<u?n:i,a,r.x,r.y)&&((l=Math.abs(a-r.y)/(i-r.x))<c||l===c&&r.x>s.x)&&Pr.locallyInside(r,e)&&(s=r,c=l),r=r.next;return s}static indexCurve(e,t,s,r){var i=e;do{null===i.z&&(i.z=Pr.zOrder(i.x,i.y,t,s,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,Pr.sortLinked(i)}static sortLinked(e){var t,s,r,i,a,n,o,l,h=1;do{for(s=e,e=null,a=null,n=0;s;){for(n++,r=s,o=0,t=0;t<h&&(o++,r=r.nextZ);t++);for(l=h;o>0||l>0&&r;)0!==o&&(0===l||!r||s.z<=r.z)?(i=s,s=s.nextZ,o--):(i=r,r=r.nextZ,l--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;s=r}a.nextZ=null,h*=2}while(n>1);return e}static zOrder(e,t,s,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}static getLeftmost(e){var t=e,s=e;do{t.x<s.x&&(s=t),t=t.next}while(t!==e);return s}static pointInTriangle(e,t,s,r,i,a,n,o){return(i-n)*(t-o)-(e-n)*(a-o)>=0&&(e-n)*(r-o)-(s-n)*(t-o)>=0&&(s-n)*(a-o)-(i-n)*(r-o)>=0}static isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!Pr.intersectsPolygon(e,t)&&Pr.locallyInside(e,t)&&Pr.locallyInside(t,e)&&Pr.middleInside(e,t)}static area(e,t,s){return(t.y-e.y)*(s.x-t.x)-(t.x-e.x)*(s.y-t.y)}static equals(e,t){return e.x===t.x&&e.y===t.y}static intersects(e,t,s,r){return!!(Pr.equals(e,t)&&Pr.equals(s,r)||Pr.equals(e,r)&&Pr.equals(s,t))||Pr.area(e,t,s)>0!=Pr.area(e,t,r)>0&&Pr.area(s,r,e)>0!=Pr.area(s,r,t)>0}static intersectsPolygon(e,t){var s=e;do{if(s.i!==e.i&&s.next.i!==e.i&&s.i!==t.i&&s.next.i!==t.i&&Pr.intersects(s,s.next,e,t))return!0;s=s.next}while(s!==e);return!1}static locallyInside(e,t){return Pr.area(e.prev,e,e.next)<0?Pr.area(e,t,e.next)>=0&&Pr.area(e,e.prev,t)>=0:Pr.area(e,t,e.prev)<0||Pr.area(e,e.next,t)<0}static middleInside(e,t){var s=e,r=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{s.y>a!=s.next.y>a&&s.next.y!==s.y&&i<(s.next.x-s.x)*(a-s.y)/(s.next.y-s.y)+s.x&&(r=!r),s=s.next}while(s!==e);return r}static splitPolygon(e,t){var s=new Ir(e.i,e.x,e.y),r=new Ir(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,s.next=i,i.prev=s,r.next=s,s.prev=r,a.next=r,r.prev=a,r}static insertNode(e,t,s,r){var i=new Ir(e,t,s);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}static removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}static signedArea(e,t,s,r){for(var i=0,a=t,n=s-r;a<s;a+=r)i+=(e[n]-e[a])*(e[a+1]+e[n+1]),n=a;return i}}const Br=new i(De.MAX_CLIP_SIZE,0,0,De.MAX_CLIP_SIZE);class Lr{constructor(){this.shaderData=f.renderDeviceFactory.createShaderData(),this.toDefault()}toDefault(){this.clipMatDir=Br,this.clipMatPos=i.ZERO,this.vertexSize=i.ZERO,Tr.initBlendMode(this.shaderData),this.shaderData.addDefine(mr.TEXTURESHADER),this.textureHost=null,this.enableVertexSize=!1,this.materialClip=!1,this.fillTexture=!1}get textureHost(){return this._textureHost}set textureHost(e){this._textureHost=e;let t,s=!1;this.textureHost&&(this.textureHost instanceof G?s=1!=this.textureHost.gammaCorrection:this.textureHost instanceof ie&&this.textureHost.bitmap&&(s=1!=this.textureHost.bitmap.gammaCorrection)),s?this.shaderData.addDefine(mr.GAMMATEXTURE):this.shaderData.removeDefine(mr.GAMMATEXTURE),t=e instanceof ie?e.bitmap:e,t||(t=fs.whiteTexture),this.shaderData.setTexture(mr.UNIFORM_SPRITETEXTURE,t)}set enableVertexSize(e){e?this.shaderData.addDefine(mr.VERTEX_SIZE):this.shaderData.removeDefine(mr.VERTEX_SIZE)}get enableVertexSize(){return this.shaderData.hasDefine(mr.VERTEX_SIZE)}set vertexSize(e){this.shaderData.setVector(mr.UNIFORM_VERTEX_SIZE,e)}get vertexSize(){return this.shaderData.getVector(mr.UNIFORM_VERTEX_SIZE)}set materialClip(e){e?this.shaderData.addDefine(mr.MATERIALCLIP):this.shaderData.removeDefine(mr.MATERIALCLIP)}get materialClip(){return this.shaderData.hasDefine(mr.MATERIALCLIP)}set clipMatDir(e){this.shaderData.setVector(mr.UNIFORM_MATERIAL_CLIPMATDIR,e)}get clipMatDir(){return this.shaderData.getVector(mr.UNIFORM_MATERIAL_CLIPMATDIR)}set clipMatPos(e){this.shaderData.setVector(mr.UNIFORM_MATERIAL_CLIPMATPOS,e)}get clipMatPos(){return this.shaderData.getVector(mr.UNIFORM_MATERIAL_CLIPMATPOS)}get u_TexRange(){return this.shaderData.getVector(mr.UNIFORM_TEXRANGE)}set u_TexRange(e){this.shaderData.setVector(mr.UNIFORM_TEXRANGE,e)}set fillTexture(e){e?this.shaderData.addDefine(mr.FILLTEXTURE):this.shaderData.removeDefine(mr.FILLTEXTURE)}get fillTexture(){return this.shaderData.hasDefine(mr.FILLTEXTURE)}cloneTo(e){this.enableVertexSize&&(e.addDefine(mr.VERTEX_SIZE),e.setVector(mr.UNIFORM_VERTEX_SIZE,this.vertexSize)),this.materialClip&&(e.addDefine(mr.MATERIALCLIP),e.setVector(mr.UNIFORM_MATERIAL_CLIPMATDIR,this.clipMatDir),e.setVector(mr.UNIFORM_MATERIAL_CLIPMATPOS,this.clipMatPos)),this.shaderData.hasDefine(mr.GAMMATEXTURE)?e.addDefine(mr.GAMMATEXTURE):e.removeDefine(mr.GAMMATEXTURE);let t=this._textureHost.bitmap;t||(t=this._textureHost),this.shaderData.hasDefine(mr.FILLTEXTURE)?(e.addDefine(mr.FILLTEXTURE),e.setVector(mr.UNIFORM_TEXRANGE,this.u_TexRange)):e.removeDefine(mr.FILLTEXTURE),e.setTexture(mr.UNIFORM_SPRITETEXTURE,t)}clear(){this.toDefault()}destroy(){this.shaderData.destroy(),this._textureHost=null}}class Nr{constructor(){this.clear()}clear(){this.blendShader=this.other=0}}class Fr{constructor(){this.clipInfoID=-1,this._id=0,this._renderType=0,this._key=new Nr,this.vertexs=[],this.blockIndexs=[],this.indexCount=0,this.indices=[],this._internalInfo=null,this.renderStateIsBySprite=!0,this._id=++Fr.ID}clear(){this._key.clear(),this._internalInfo.clear(),this.material=null,this.mesh&&(this.mesh.clearBlocks(this.blockIndexs),this.mesh.clearIndexView(this.indexView),this.vertexs.length=0,this.blockIndexs.length=0,this.mesh=null)}destroy(){this.clear(),this.indexView&&(this.indexView.destroy(),this.indexView=null),this._internalInfo.destroy(),this._internalInfo=null}appendData(e){this.blockIndexs.push(...e.vertexBlocks);let t=f.render2DRenderPassFactory.createGraphic2DVertexBlock();t.positions=e.positions,t.vertexViews=e.vertexViews,this.vertexs.push(t)}update(e,t,s){var r=e._nBlendType;let i=e.sprite._struct.blendMode;this._key.blendShader=r,e.globalCompositeOperation!=i&&(Tr.setShaderData(r,this._internalInfo.shaderData),this.renderStateIsBySprite=!1),this.mesh=t,this.material=s}static create(e,t,s){var r=new Fr;return r._internalInfo=new Lr,r.update(e,t,s),r}}Fr.ID=1,Fr.RENDERBASE=new Fr;class Or{}function Ur(e,t,s){let r=Or.standardFontSize;e.font=(s?"bold ":"")+r+"px "+t,e.setTransform(1,0,0,1,0,0),e.textBaseline="middle",e.lineWidth=0,e.fillStyle="red";const i=[0,0,0,0];return i[0]=r/2,i[1]=r/2,i[2]=r,i[3]=r,kr(e,"g",r,16,i),kr(e,"有",r,16,i),kr(e,"🤡",r,16,i,!0),{xoff:Math.max(16-i[0],0),yoff:Math.max(16-i[1],0),bbxw:i[2]-i[0],bbxh:i[3]-i[1]}}function kr(e,t,s,r,i,a){let n=e.measureText(t).width,o=n+2*r,l=s+2*r;e.clearRect(0,0,o,l),e.fillText(t,r,r+s/2),function(e,t,s){let r=new Uint32Array(e.data.buffer);function i(e,t,s,i){let a=e.width*t+s;for(let e=s;e<i;e++)if(0!==r[a++])return!0;return!1}let a=e.width,n=e.height,o=0,l=t[1],h=0,d=l;if(i(e,l,0,a))for(;;){if(d=(l+h)/2|0,d+1>=l){t[1]=d;break}i(e,d,0,a)?l=d:h=d}if(t[3]>n)t[3]=n;else if(d=l=t[3],h=n,i(e,l,0,a))for(;;){if(d=(l+h)/2|0,d-1<=l){t[3]=d;break}i(e,d,0,a)?l=d:h=d}if(s)return;let u=t[0],c=a*t[1];for(d=t[1];d<t[3];d++){for(o=0;o<u;o++)if(0!==r[c+o]){u=o;break}c+=a}t[0]=u;let _=t[2];for(c=a*t[1],d=t[1];d<t[3];d++){for(o=_;o<a;o++)if(0!==r[c+o]){_=o;break}c+=a}t[2]=_}(e.getImageData(0,0,o,l),i,a),i[2]<r+n&&(i[2]=r+n)}var Vr;Or.maxCanvasWidth=4096,Or.atlasWidth=1024,Or.atlasGridW=16,Or.standardFontSize=32,Or.noAtlas=!1,Or.forceSplitRender=!1,Or.forceWholeRender=!1,Or.scaleFontWithCtx=!0,Or.maxFontScale=3,Or.fontScale=1,e.WrapMode=void 0,(Vr=e.WrapMode||(e.WrapMode={}))[Vr.Repeat=0]="Repeat",Vr[Vr.Clamp=1]="Clamp",Vr[Vr.Mirrored=2]="Mirrored";class Gr{constructor(e,t,s){this.atlasWidth=e,this.atlasHeight=t,this.cellSize=s,this.cols=Math.floor(this.atlasWidth/this.cellSize),this.rows=Math.floor(this.atlasHeight/this.cellSize),this.freeCells=this.totalCells=this.cols*this.rows,this.columnHeights=new Uint8Array(this.cols)}allocate(e,t){if(e<=0||t<=0)return null;const s=this.cellSize,r=Math.ceil(e/s),i=Math.ceil(t/s);if(r<=0||i<=0)return null;if(r>this.cols||i>this.rows)return null;const a=this.cols,n=this.rows,o=this.columnHeights;let l=-1,h=Number.MAX_SAFE_INTEGER;e:for(let e=0;e<=a-r;e++){let t=0;for(let s=e;s<e+r;s++){const e=o[s];if(e>t&&(t=e),t+i>n)continue e}if(t<h&&(h=t,l=e,0===h))break}if(l<0)return null;const d=l*s,u=h*s,c=h+i;for(let e=l;e<l+r;e++){const t=o[e];o[e]=c,this.freeCells-=c-t}return{x:d,y:u,w:r*s,h:i*s,_cx:r,_cy:i}}reset(){this.freeCells!==this.totalCells&&(this.columnHeights.fill(0),this.freeCells=this.totalCells)}}class zr{constructor(e){this.fontMap=new Map,this.textAtlases=[],this.charMap=new Map,this.textMap=new Map,this.freeRegions=[],this.freeIsoTextures=[],this.owner=e;let t=Y.createElement("canvas");this.canvas=t,t.width=1024,t.height=512,Y.isDomSupported&&(t.style.left="-10000px",t.style.position="absolute",Y.document.body.appendChild(t)),this.ctx=t.getContext("2d",{willReadFrequently:!0}),l.systemTimer.loop(5e3,this,this.GC)}draw(e,t,s,r,i,a,n,o,l,h,d,u,c){let _=this.getFont(r),p=a?_.bold:_.normal,g=i/Or.standardFontSize;Jr=Math.ceil(p.xoff*g),ei=Math.ceil(p.yoff*g),Zr=Math.ceil(p.bbxh*g),Qr=Or.fontScale,ti=n?13:0;let m=1e4*_.id+i+(a?"b_":"_"),f=ht.create(o).numColor,T=l>0||!d&&Wr.test(e);T&&(m+=f+"_"),l>0&&(m+=ht.create(h).numColor+"_"+l+"_");let y=this.ctx;y.font=(a?"bold ":"")+i+"px "+r,y.setTransform(Qr,0,0,Qr,0,0),y.textBaseline="middle",y.fillStyle=T?o:"white",l>0?(y.lineJoin="round",y.strokeStyle=h,y.lineWidth=l):y.lineWidth=0,c||(c=[]);let x=T?4294967295:f;if(!d&&!Or.forceSplitRender||Or.forceWholeRender){let r=m+e,a=this.textMap.get(r);a&&a.ref++,c[0]&&this.free(c[0]),a||(null==u&&(u=y.measureText(e).width),a=this.drawOffscreen(y,e,u,i,l,!1),a.key=r,a.ref=1,this.textMap.set(r,a)),c[0]=a,this.owner._inner_drawTexture(a.tex,a.tex.id,t+a.x,s+a.y,a.w,a.h,this.owner._curMat,a.uv,1,x,ti,!0);for(let e=1,t=c.length;e<t;e++)this.free(c[e]);c.length=1}else{let r=this.owner._curMat;c.length>0&&this.freeRenderInfo(c);for(let a=0,n=e.length;a<n;a++){let o=e.charAt(a),h=o.charCodeAt(0);h>=55296&&h<=56319&&a+1<n&&(o+=e.charAt(++a));let d=m+o,u=this.charMap.get(d);if(!u){let e=y.measureText(o).width;u=this.drawOffscreen(y,o,e,i,l,!0),u.key=d,u.isChar=!0,this.charMap.set(d,u)}u.ref++,c.push(u),this.owner._inner_drawTexture(u.tex,u.tex.id,t+u.x,s+u.y,u.w,u.h,r,u.uv,1,o.length>1?4294967295:x,ti,!0),t+=u.advance}}return c}drawOffscreen(e,t,s,r,i,a){let n=r/3|0+i,o=((n-Jr-i)*Qr|0)-Hr,l=((n-ei-i)*Qr|0)-Hr,h=Math.ceil((s+Jr+2*i)*Qr)+2*Hr,d=Math.ceil((Zr+2*i)*Qr)+2*Hr,u=Math.min(h+Math.ceil(2*n*Qr),Or.maxCanvasWidth),c=Math.min(d+Math.ceil(2*n*Qr),Or.maxCanvasWidth);(u>this.canvas.width||c>this.canvas.height)&&this.resizeCanvas(e,u,c),e.clearRect(0,0,Math.ceil(u/Qr),Math.ceil(c/Qr)),i>0&&e.strokeText(t,n,n+r/2),e.fillText(t,n,n+r/2);let _=e.getImageData(o,l,h,d),p={x:-(Jr+i),y:-i,w:(_.width-2*Hr)/Qr,h:(_.height-2*Hr)/Qr,advance:s,uv:new Array(8),tex:null,region:null,ref:0};return _.width>Or.atlasWidth||_.height>Or.atlasWidth||!a&&Or.noAtlas?(p.tex=this.createIsoTexture(_.width,_.height),this.setPixelsToTexture(_,p.tex,0,0,p.uv)):(p.region=this.addToAtlas(_.width,_.height),p.tex=p.region.owner.tex,this.setPixelsToTexture(_,p.tex,p.region.x,p.region.y,p.uv)),p}resizeCanvas(e,t,s){t=512*Math.ceil(t/512),s=512*Math.ceil(s/512);let r=e.font,i=e.fillStyle,a=e.strokeStyle,n=e.lineWidth;this.canvas.width=t,this.canvas.height=s,e.setTransform(Qr,0,0,Qr,0,0),e.font=r,e.textBaseline="middle",e.lineJoin="round",e.fillStyle=i,e.strokeStyle=a,e.lineWidth=n}createIsoTexture(e,t){let s=this.freeIsoTextures.findIndex(s=>null!=s&&s.width>=e&&s.width<=e+t&&s.height>=t&&s.height<=t+t);if(-1!==s){let e=this.freeIsoTextures[s];return this.freeIsoTextures[s]=null,++ri>50&&(this.freeIsoTextures=this.freeIsoTextures.filter(e=>null!=e),ri=0),e}return this.createTextTexture(e,t)}addToAtlas(e,t){let s,r=this.freeRegions.findIndex(s=>null!=s&&s.w>=e&&s.w<=e+t&&s.h>=t&&s.h<=t+t);if(-1!==r){let e=this.freeRegions[r];return this.freeRegions[r]=null,++si>50&&(this.freeRegions=this.freeRegions.filter(e=>null!=e),si=0),e.owner.ref++,e}for(let r of this.textAtlases)if(s=r.grid.allocate(e,t))return s.owner=r,r.ref++,s;let i=Or.atlasWidth,a={tex:this.createTextTexture(i,i),grid:new Gr(i,i,Or.atlasGridW),ref:1};return this.textAtlases.push(a),s=a.grid.allocate(e,t),s.owner=a,s}createTextTexture(t,s){let r=new fs(t,s,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0);return r.name="TextTexture",r.setPixelsData(null,!0,!1),r.lock=!0,r.filterMode=e.FilterMode.Bilinear,r.wrapModeU=e.WrapMode.Clamp,r.wrapModeV=e.WrapMode.Clamp,r}setPixelsToTexture(e,t,s,r,i){let a=e.data;a instanceof Uint8ClampedArray&&(a=new Uint8Array(a.buffer)),f.textureContext.setTextureSubPixelsData(t._texture,a,0,!1,s,r,e.width,e.height,!0,!1);let n=(s+Hr)/t.width,o=(r+Hr)/t.height,l=(s+e.width-Hr)/t.width,h=(r+e.height-Hr)/t.height;i[0]=n,i[1]=o,i[2]=l,i[3]=o,i[4]=l,i[5]=h,i[6]=n,i[7]=h}freeRenderInfo(e){for(let t of e)this.free(t);e.length=0}free(e){if(e.ref--,!(e.ref>0)){if(e.isChar){if(0===e.ref)return;this.charMap.delete(e.key)}else this.textMap.delete(e.key);if(null!=e.region){let t=e.region.owner;if(t.ref--,0===t.ref)if(this.freeRegions.length>0&&(this.freeRegions=this.freeRegions.filter(e=>null!=e&&e.owner!==t)),si=0,this.textAtlases.length>2&&-1!==this.textAtlases.findIndex(e=>0===e.ref)){t.tex.destroy();let e=this.textAtlases.indexOf(t);this.textAtlases.splice(e,1)}else t.grid.reset();else this.freeRegions.push(e.region)}else this.freeIsoTextures.push(e.tex)}}getFontHeight(e,t,s){let r=this.getFont(e),i=t/Or.standardFontSize,a=s?r.bold:r.normal;return Math.ceil(a.bbxh*i)}getFont(e){let t=this.fontMap.get(e);return null==t&&(t={id:$r++,normal:Ur(this.ctx,e,!1),bold:Ur(this.ctx,e,!0)},this.fontMap.set(e,t)),t}onFontScaleChanged(){this.textMap.clear(),ii.length=0;for(let[e,t]of this.charMap)0===t.ref?ii.push(t):t.ref--;for(let e of ii)this.free(e);this.charMap.clear()}GC(){if(this.freeIsoTextures.length>0){for(let e of this.freeIsoTextures)null==e||e.destroy();this.freeIsoTextures.length=0,ri=0}ii.length=0;for(let[e,t]of this.charMap)0===t.ref&&ii.push(t);for(let e of ii)this.free(e)}}const Hr=1,Wr=/[\uD800-\uDBFF][\uDC00-\uDFFF]/;var Xr,Yr,qr,jr,Kr,$r=0,Qr=1,Zr=0,Jr=0,ei=0,ti=0,si=0,ri=0,ii=[];e.BufferTargetType=void 0,(Xr=e.BufferTargetType||(e.BufferTargetType={}))[Xr.ARRAY_BUFFER=0]="ARRAY_BUFFER",Xr[Xr.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",Xr[Xr.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",Xr[Xr.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",Xr[Xr.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",Xr[Xr.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",e.BufferUsage=void 0,(Yr=e.BufferUsage||(e.BufferUsage={}))[Yr.Static=0]="Static",Yr[Yr.Dynamic=1]="Dynamic",Yr[Yr.Stream=2]="Stream",e.IndexFormat=void 0,(qr=e.IndexFormat||(e.IndexFormat={}))[qr.UInt8=0]="UInt8",qr[qr.UInt16=1]="UInt16",qr[qr.UInt32=2]="UInt32";class ai{get vertexBuffer(){return this._vertexBuffer}get indexBuffer(){return this._indexBuffer}get bufferState(){return this._bufferState}constructor(t,s){this._vertexViews=[],this._indexBufferLength=0,this._indexBufferMaxLength=0,this._vertexFreeBlocks=[],this._vertexBlockSize=t,this._vertexBuffer=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic),this._wholeVertex=f.render2DRenderPassFactory.create2DGraphicVertexBuffer(),this._wholeVertex.buffer=this._vertexBuffer,this._indexBuffer=f.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Dynamic),this._indexBuffer.indexType=e.IndexFormat.UInt16,this._wholeIndex=f.render2DRenderPassFactory.create2DGraphicIndexBuffer(),this._wholeIndex.buffer=this._indexBuffer,this._bufferState=f.renderDeviceFactory.createBufferState(),this._vertexBuffer.vertexDeclaration=s,this._vertexDeclaration=s,this._vertexStride=s.vertexStride,this._vertexElementLength=this._vertexStride/4,this._vertexBlockLength=this._vertexBlockSize*this._vertexElementLength,this._bufferState.applyState([this._vertexBuffer],this._indexBuffer);let r=ai.MAX_VERTEX/this._vertexBlockSize;this.resizeVertexBuffer(r);let i=ai.DEFAULT_BLOCK_SIZE;this.resizeIndexBuffer(i),this._tempVertexData=new Float32Array(this._vertexBlockSize*this._vertexElementLength)}resizeVertexBuffer(e){let t=e*this._vertexBlockSize*this._vertexStride;this._wholeVertex.resetData(t),this._vertexBuffer.setDataLength(t),this._canVBlockCount=e}resizeIndexBuffer(e){let t=2*e;this._wholeIndex.resetData(t),this._indexBuffer._setIndexDataLength(t),this._indexBufferMaxLength=e}indexExtendBlock(e){let t=Math.ceil((this._indexBufferLength+e)/ai.DEFAULT_BLOCK_SIZE)*ai.DEFAULT_BLOCK_SIZE;this.resizeIndexBuffer(t)}checkVertexBuffer(e){let t=Math.ceil(e/this._vertexBlockSize);if(t-(this._vertexFreeBlocks.length+(this._canVBlockCount-this._vertexViews.length))>0)return null;let s=[],r=[],i=t;for(;i>0&&this._vertexFreeBlocks.length>0;){let e=this._vertexFreeBlocks.shift();s.push(e),r.push(this._vertexViews[e]),i--}for(;i>0;){let e=this._vertexViews.length;s.push(e);let t=f.render2DRenderPassFactory.create2DGraphicVertexDataView(this._wholeVertex,e*this._vertexBlockLength,this._vertexBlockLength,this._vertexElementLength);this._vertexViews[e]=t,r.push(t),i--}return{buffer:this,vertexViews:r,vertexBlocks:s}}checkIndexBuffer(e){let t;return this._indexBufferLength+e>this._indexBufferMaxLength&&this.indexExtendBlock(e),t=f.render2DRenderPassFactory.create2DGraphicIndexDataView(this._wholeIndex,e),this._indexBufferLength+=e,t}_releaseBlocks(e,t,s){e&&0!==e.length&&s.push(...e)}releaseVertexBlocks(e){this._releaseBlocks(e,this._vertexViews,this._vertexFreeBlocks)}releaseIndexView(e){this._indexBufferLength-=e.length,this._wholeIndex.removeDataView(e)}clear(){this._vertexViews.forEach(e=>null),this._vertexFreeBlocks=[]}destroy(){this.clear(),this._vertexBuffer.destroy(),this._indexBuffer.destroy()}}ai.MAX_VERTEX=32768,ai.DEFAULT_BLOCK_SIZE=1024;class ni{static __init__(){ni.vertexDeclarition=new cr(64,[new nr(0,dr.Vector4,0),new nr(16,dr.Vector4,1),new nr(32,dr.Vector4,2),new nr(48,dr.Vector4,3)]),ni.stride=ni.vertexDeclarition.vertexStride/4}get bufferState(){return this._buffer.bufferState}constructor(){this._buffer=new ai(4,ni.vertexDeclarition)}checkVertex(e){let t=this._buffer.checkVertexBuffer(e);return t?{mesh:this,vertexBlocks:t.vertexBlocks,vertexViews:t.vertexViews}:null}checkIndex(e){return this._buffer.checkIndexBuffer(e)}clearBlocks(e){this._buffer.releaseVertexBlocks(e)}clearIndexView(e){this._buffer.releaseIndexView(e)}clear(){this._buffer.clear()}destroy(){this._buffer.destroy(),this._buffer=null}}ni.stride=0,e.MeshTopology=void 0,(jr=e.MeshTopology||(e.MeshTopology={}))[jr.Points=0]="Points",jr[jr.Lines=1]="Lines",jr[jr.LineLoop=2]="LineLoop",jr[jr.LineStrip=3]="LineStrip",jr[jr.Triangles=4]="Triangles",jr[jr.TriangleStrip=5]="TriangleStrip",jr[jr.TriangleFan=6]="TriangleFan",e.DrawType=void 0,(Kr=e.DrawType||(e.DrawType={}))[Kr.DrawArray=0]="DrawArray",Kr[Kr.DrawArrayInstance=1]="DrawArrayInstance",Kr[Kr.DrawArrayIndirect=2]="DrawArrayIndirect",Kr[Kr.DrawElement=3]="DrawElement",Kr[Kr.DrawElementInstance=4]="DrawElementInstance",Kr[Kr.DrawElementIndirect=5]="DrawElementIndirect";const oi=new Ce(De.MAX_CLIP_SIZE,0,0,De.MAX_CLIP_SIZE,0,0),li=new Ce,hi=new Float32Array(8),di=new Uint16Array([0,1,2,0,2,3]),ui=new Uint16Array([0,2,1,0,3,2]);class ci{constructor(){this._alpha=1,this._material=null,this._fillStyle=yr.DEFAULT,this._strokeStyle=yr.DEFAULT,this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._other=null,this._path=null,this._curSubmit=null,this._submitKey=new Nr,this._graphicsData=null,this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=vr.MAX,this._globalClipMatrix=oi.clone(),this._clip_x=0,this._clip_y=0,this._clipInfoID=0,this._clipID_Gen=0,this._meshPool=[],this._matrixChanged=!1,this._matBuffer=new Float32Array(6),this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=e.BlendMode.normal,this._save=null,this._saveMark=null,this.sprite=null,this._lastTex=null,this._defTexture=null,this._defTexture=new ie(fs.whiteTexture),this._textRender=new zr(this),this._other=_i.DEFAULT,this._curMat=Ce.create(),this._save=[wr.Create(this)],this._save.length=10,this.clear(),this.initDefalutMesh()}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}transformByMatrix(e,t,s){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+s)}drawRect(e,t,s,r,i,a,n){var o=this;null!=i&&(o.fillStyle=i,o.fillRect(e,t,s,r)),null!=a&&(o.strokeStyle=a,o.lineWidth=n,o.strokeRect(e,t,s,r))}alpha(e){this.globalAlpha*=e}_transform(e,t,s){this.translate(t,s),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-s)}_rotate(e,t,s){this.translate(t,s),this.rotate(e),this.translate(-t,-s)}_scale(e,t,s,r){this.translate(s,r),this.scale(e,t),this.translate(-s,-r)}_drawLine(e,t,s,r,i,a,n,o,l){this.beginPath(),this.strokeStyle=n,this.lineWidth=o,this.moveTo(e+s,t+r),this.lineTo(e+i,t+a),this.stroke()}_drawLines(e,t,s,r,i,a){this.beginPath(),this.strokeStyle=r,this.lineWidth=i,this.addPath(s.slice(),!1,!1,e,t),this.stroke()}drawCurves(e,t,s,r,i){this.beginPath(),this.strokeStyle=r,this.lineWidth=i,this.moveTo(e+s[0],t+s[1]);for(var a=2,n=s.length;a<n;)this.quadraticCurveTo(e+s[a++],t+s[a++],e+s[a++],t+s[a++]);this.stroke()}_fillAndStroke(e,t,s,r=!1){null!=e&&(this.fillStyle=e,this.fill()),null!=t&&s>0&&(this.strokeStyle=t,this.lineWidth=s,this.stroke())}_drawCircle(e,t,s,r,i,a,n){this.beginPath(!0),this.arc(e,t,s,s,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(r,i,a)}_drawEllipse(e,t,s,r,i,a,n){this.beginPath(!0),this.arc(e,t,s,r,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(i,a,n)}_drawRoundRect(e,t,s,r,i,a,n,o,l,h,d){if(s<=0)return;if(r<=0)return;this.beginPath(!0);var u=this._getPath();if(0>=i)u.addPoint(e,t);else{let o=Math.PI,l=1.5*Math.PI;if(s<i+a){let e=i*(i+a-s)/(i+a),t=Math.sqrt(i*i-e*e),r=Math.atan2(t,e);l-=.5*Math.PI-r}if(r<i+n){let e=i*(i+n-r)/(i+n),t=Math.sqrt(i*i-e*e);o+=Math.atan2(e,t)}o>l||this.arc(e+i,t+i,i,i,o,l,!1,!0,5)}let c=e+s-a;if(0>=a)u.addPoint(c,t);else{let e=1.5*Math.PI,n=2*Math.PI;if(s<i+a){let t=a*(i+a-s)/(i+a),r=Math.sqrt(i*i-t*t),n=Math.atan2(r,t);e+=.5*Math.PI-n}if(r<a+o){let e=a*(a+o-r)/(a+o),t=Math.sqrt(a*a-e*e);n-=Math.atan2(e,t)}e>n||this.arc(c,t+a,a,a,e,n,!1,!0,5)}c=e+s-o;let _=t+r-o;if(0>=o)u.addPoint(c,_);else{let e=0,t=.5*Math.PI;if(s<n+o){let e=o*(n+o-s)/(n+o),r=Math.sqrt(n*n-e*e),i=Math.atan2(r,e);t-=.5*Math.PI-i}if(r<a+o){let t=o*(a+o-r)/(a+o),s=Math.sqrt(o*o-t*t);e+=Math.atan2(t,s)}e>t||this.arc(c,_,o,o,e,t,!1,!0,5)}if(c=e+n,_=t+r-n,0>=n)u.addPoint(c,_);else{let e=.5*Math.PI,t=Math.PI;if(s<n+o){let t=o*(n+o-s)/(n+o),r=Math.sqrt(n*n-t*t),i=Math.atan2(r,t);e+=.5*Math.PI-i}if(r<i+n){let e=n*(i+n-r)/(i+n),s=Math.sqrt(n*n-e*e);t-=Math.atan2(e,s)}e>t||this.arc(c,_,n,n,e,t,!1,!0,5)}this.closePath(),this._fillAndStroke(l,h,d)}_drawPie(e,t,s,r,i,a,n,o,l){this.beginPath(),this.moveTo(e,t),this.arc(e,t,s,s,r,i),this.closePath(),this._fillAndStroke(a,n,o)}_drawPoly(e,t,s,r,i,a,n,o){this.beginPath(),this.addPath(s.slice(),!0,n,e,t),this.closePath(),this._fillAndStroke(r,i,a,n)}_drawPath(e,t,s,r,i){this.beginPath();for(var a=0,n=s.length;a<n;a++){var o=s[a];switch(o[0]){case"moveTo":this.moveTo(e+o[1],t+o[2]);break;case"lineTo":this.lineTo(e+o[1],t+o[2]);break;case"arcTo":this.arcTo(e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.closePath()}}null!=r&&(this.fillStyle=r.fillStyle,this.fill()),null!=i&&(this.strokeStyle=i.strokeStyle,this.lineWidth=i.lineWidth||1,this.lineJoin=i.lineJoin,this.lineCap=i.lineCap,this.miterLimit=i.miterLimit,this.stroke())}destroy(){for(let e=0;e<this._meshPool.length;e++)this._meshPool[e].destroy();this._meshPool=null,this.sprite=null,this._path=null,this._save=null}clear(){this._submitKey.clear(),this._curSubmit=Fr.RENDERBASE,this._curMat.identity(),this._other=_i.DEFAULT,this._other.clear(),this._clipRect=vr.MAX,this._clip_x=0,this._clip_y=0,this._alpha=1,this._nBlendType=e.BlendMode.normal,this._fillStyle=this._strokeStyle=yr.DEFAULT,this._lastTex=null,this._saveMark=this._save[0],this._save._length=1}getCurrentScaleX(){let e=this.getMatScaleX();if(this.sprite&&this.sprite.globalTrans){const t=this.sprite.globalTrans.getMatrix();e*=Math.hypot(t.a,t.b)}return Math.abs(e)}getCurrentScaleY(){let e=this.getMatScaleY();if(this.sprite&&this.sprite.globalTrans){const t=this.sprite.globalTrans.getMatrix();e*=Math.hypot(t.c,t.d)}return Math.abs(e)}getMatScaleX(){return this._lastMat_a===this._curMat.a&&this._lastMat_b===this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c===this._curMat.c&&this._lastMat_d===this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}set fillStyle(e){this._fillStyle.equal(e)||(Dr.save(this,"fillStyle"),this._fillStyle=yr.create(e),this._submitKey.other=-this._fillStyle._color.numColor)}get fillStyle(){return this._fillStyle}set globalAlpha(e){(e=Math.floor(1e3*e)/1e3)!=this._alpha&&(Er.save(this,Er.TYPE_ALPHA,this,!1),this._alpha=e)}get globalAlpha(){return this._alpha}set textAlign(e){this._other.textAlign===e||(this._other=this._other.make(),Er.save(this,Er.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)}get textAlign(){return this._other.textAlign}set textBaseline(e){this._other.textBaseline===e||(this._other=this._other.make(),Er.save(this,Er.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(e){null==e||this._nBlendType===e||(Er.save(this,Er.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=Fr.RENDERBASE,this._nBlendType=e)}get globalCompositeOperation(){return this._nBlendType}set strokeStyle(e){this._strokeStyle.equal(e)||(Dr.save(this,"strokeStyle"),this._strokeStyle=yr.create(e),this._submitKey.other=-this._strokeStyle._color.numColor)}get strokeStyle(){return this._strokeStyle}translate(e,t){0===e&&0===t||(Cr.save(this),this._curMat._bTransform?(br.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t),this._matrixChanged=!0)}set lineWidth(e){this._other.lineWidth===e||(this._other=this._other.make(),Er.save(this,Er.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=wr.Create(this)}restore(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var s=e-1;s>=0;s--){var r=this._save[s];if(r.restore(this),r.isSaveMark())return void(this._save._length=s)}t!=this._nBlendType&&this.breakNextMerge()}}_fillRect(e,t,s,r,i){var a=this._curSubmit;this.transformQuad(e,t,s,r,0,this._curMat,this._transedPoints);let n=this.acquire(4),o=n.mesh;var l=a&&a.mesh===o&&a._key.blendShader===this._nBlendType;if(l&&(l=l&&this.isSameClipInfo(a)),!this.clipedOff(this._transedPoints)){if(!l){let e=(a=this._curSubmit=this.createSubmit(o))._internalInfo;this._setClipInfo(e),a.clipInfoID=this._clipInfoID,e.textureHost=this._lastTex,a._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1}this.appendData(this._transedPoints,ui,n,a,null,i,null,null,!1),this._appendBlockInfo(n)}}_appendBlockInfo(e){this._curSubmit.appendData(e)}fillRect(e,t,s,r,i=null){var a=i?yr.create(i):this._fillStyle,n=this.mixRGBandAlpha(a._color.numColor);this._fillRect(e,t,s,r,n)}fillTexture(e,t,s,r,i,a,n,o){this._getImageSource(e)&&(this._graphicsData.addResRef(e),this._fillTexture(e,e.width,e.height,e.uvrect,t,s,r,i,a,n.x,n.y,o))}_fillTexture(e,t,s,r,a,n,o,l,h,d,u,c){var _=this._curSubmit;let p=this.acquire(4),g=p.mesh;var m=!0,f=!0;switch(h){case"repeat":break;case"repeat-x":f=!1;break;case"repeat-y":m=!1;break;case"no-repeat":m=f=!1}var T=this._temp4Points,y=0,x=0,S=0,E=0,v=0,D=0;if(d<0?(S=a,y=-d%t/t):S=a+d,u<0?(E=n,x=-u%s/s):E=n+u,v=a+o,D=n+l,!m&&(v=Math.min(v,a+d+t)),!f&&(D=Math.min(D,n+u+s)),!(v<a||D<n||S>v||E>D)){var w=(v-a-d)/t,b=(D-n-u)/s;if(this.transformQuad(S,E,v-S,D-E,0,this._curMat,this._transedPoints),T[0]=y,T[1]=x,T[2]=w,T[3]=x,T[4]=w,T[5]=b,T[6]=y,T[7]=b,!this.clipedOff(this._transedPoints)){let t=(_=this._curSubmit=this.createSubmit(g))._internalInfo;t.fillTexture=!0;var C=r.concat();i.TEMP.setValue(C[0],C[1],C[2],C[3]),t.u_TexRange=i.TEMP,this._setClipInfo(t),_.clipInfoID=this._clipInfoID,_._internalInfo.textureHost=e;var R=this._mixRGBandAlpha(c,this._alpha);this.appendData(this._transedPoints,ui,p,_,T,R,null,null,!0),this._appendBlockInfo(p)}this.breakNextMerge()}}createSubmit(e){return this._graphicsData.createSubmit(this,e,this._material)}drawTexture(e,t,s,r,i,a=4294967295){this._drawTextureM(e,t,s,r,i,null,1,null,a)}drawTextures(e,t,s,r,i){if(this._getImageSource(e)){this._graphicsData.addResRef(e);for(var a=t.length/2,n=0,o=e.bitmap.id,l=0;l<a;l++){const a="number"==typeof i[l]?i[l]:4294967295;this._inner_drawTexture(e,o,t[n++]+s,t[n++]+r,0,0,null,null,1,a)}}}_drawTextureM(e,t,s,r,i,a,n,o,l){return!!this._getImageSource(e)&&(this._graphicsData.addResRef(e),this._inner_drawTexture(e,e.bitmap.id,t,s,r,i,a,o,n,l))}_setClipInfo(e){if(this._clipRect===vr.MAX)return void(e.materialClip=!1);let t=this._globalClipMatrix;var s=e.clipMatDir;e.materialClip=!0,s.x=t.a,s.y=t.b,s.z=t.c,s.w=t.d,e.clipMatDir=s;var r=e.clipMatPos;r.x=t.tx,r.y=t.ty,r.z=this._clip_x,r.w=this._clip_y,e.clipMatPos=r}isSameClipInfo(e){return e.clipInfoID!==this._clipInfoID}_inner_drawTexture(e,t,s,r,i,a,n,o,l,h,d,u){if(i<=0||a<=0)return!1;null==d&&(d=0);var c=this._curSubmit._key;if(o=o||e._uv,c.other===t){let t=0;0!==d&&(t=Math.tan(d*Math.PI/180)*a);var _=hi;_[0]=s+t,_[1]=r,_[2]=s+i+t,_[3]=r,_[4]=s+i,_[5]=r+a,_[6]=s,_[7]=r+a,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=o[0],p[1]=o[1],p[2]=o[2],p[3]=o[3],p[4]=o[4],p[5]=o[5],p[6]=o[6],p[7]=o[7],this.drawTriangles(e,0,0,_,p,di,n||this._curMat,l,null,h),this._drawTriUseAbsMatrix=!1,!0}var g=this._curSubmit,m=this._transedPoints;if(this.transformQuad(s,r,i||e.width,a||e.height,d,n||this._curMat,m),u){var f=Math.round;m[0]=f(m[0]),m[1]=f(m[1]),m[2]=f(m[2]),m[3]=f(m[3]),m[4]=f(m[4]),m[5]=f(m[5]),m[6]=f(m[6]),m[7]=f(m[7])}var T=this._mixRGBandAlpha(h,this._alpha*l);let y=this.acquire(4),x=y.mesh,S=t>=0&&g.mesh===x&&c.other===t&&!this.isSameClipInfo(this._curSubmit);if(this._lastTex=e,!S){this._curSubmit=g=this.createSubmit(x);let s=g._internalInfo;this._setClipInfo(s),s.textureHost=e,g._key.other=t,g.clipInfoID=this._clipInfoID}return this.appendData(m,ui,y,g,o,T,null,null,!0),this._appendBlockInfo(y),!0}clipedOff(e){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(e,t,s,r,i,a,n){var o=0;0!=i&&(o=Math.tan(i*Math.PI/180)*r);var l=e+s,h=t+r,d=a.tx,u=a.ty,c=a.a,_=a.b,p=a.c,g=a.d,m=e+o,f=t,T=l+o,y=t,x=l,S=h,E=e,v=h;a!==this._curMat||this._matrixChanged?a._bTransform?(n[0]=m*c+f*p+d,n[1]=m*_+f*g+u,n[2]=T*c+y*p+d,n[3]=T*_+y*g+u,n[4]=x*c+S*p+d,n[5]=x*_+S*g+u,n[6]=E*c+v*p+d,n[7]=E*_+v*g+u):(n[0]=m+d,n[1]=f+u,n[2]=T+d,n[3]=y+u,n[4]=x+d,n[5]=S+u,n[6]=E+d,n[7]=v+u):(n[0]=m,n[1]=f,n[2]=T,n[3]=y,n[4]=x,n[5]=S,n[6]=E,n[7]=v)}breakNextMerge(){this._curSubmit=Fr.RENDERBASE}drawTextureWithTransform(t,s,r,i,a,n,o,l,h,d,u,c=4294967295){var _,p,g=this._curMat;if(null!=d&&("string"==typeof d&&(d=null!==(_=e.BlendMode[d])&&void 0!==_?_:"destination-out"===d?e.BlendMode.destinationOut:0),p=this.globalCompositeOperation,this.globalCompositeOperation=d),!n)return this._drawTextureM(t,s+o,r+l,i,a,g,h,u,c),void(d&&(this.globalCompositeOperation=p));li.a=n.a,li.b=n.b,li.c=n.c,li.d=n.d,li.tx=n.tx+o,li.ty=n.ty+l,li._bTransform=n._bTransform,n&&g._bTransform?(Ce.mul(li,g,li),(n=li)._bTransform=!0):(li.tx+=g.tx,li.ty+=g.ty,n=li),this._drawTextureM(t,s,r,i,a,n,h,u,c),null!=d&&(this.globalCompositeOperation=p)}drawTriangles(t,s,r,i,a,n,o,l,h,d,u,c){var _;if(t){if(!this._getImageSource(t))return;this._graphicsData.addResRef(t)}null==l&&(l=1),null==d&&(d=4294967295);let p=null;null!=h&&("string"==typeof h&&(h=null!==(_=e.BlendMode[h])&&void 0!==_?_:"destination-out"===h?e.BlendMode.destinationOut:0),p=this.globalCompositeOperation,this.globalCompositeOperation=h);let g=i.length/2,m=this.acquire(g),f=m.mesh;var T=t instanceof ie?t.bitmap:t,y=this._curSubmit._key,x=this._curSubmit.mesh===f&&(!T||y.other===T.id)&&y.blendShader===this._nBlendType;let S=this._curSubmit;x||(S=this._curSubmit=this.createSubmit(f),S._internalInfo.textureHost=t,this._setClipInfo(S._internalInfo),S._key.other=T?T.id:-1,S.clipInfoID=this._clipInfoID);var E=this._mixRGBandAlpha(d,this._alpha*l);if(this._drawTriUseAbsMatrix){let e=this._curMat==o?this._matrixChanged?this._curMat:null:o;this.appendData(i,n,m,S,a,E,e,null,!!t,u,c)}else o?(li.a=o.a,li.b=o.b,li.c=o.c,li.d=o.d,li.tx=o.tx+s,li.ty=o.ty+r):(li.a=1,li.b=0,li.c=0,li.d=1,li.tx=s,li.ty=r),Ce.mul(li,this._curMat,li),this.appendData(i,n,m,S,a,E,li,null,!!t,u,c);this._appendBlockInfo(m),null!=h&&(this.globalCompositeOperation=p)}transform(e,t,s,r,i,a){br.save(this),Ce.mul(Ce.TEMP.setTo(e,t,s,r,i,a),this._curMat,this._curMat),this._curMat._checkTransform(),this._matrixChanged=!0}rotate(e){br.save(this),this._curMat.rotateEx(e),this._matrixChanged=!0}scale(e,t){br.save(this),this._curMat.scaleEx(e,t),this._matrixChanged=!0}clipRect(e,t,s,r,i){if(vr.save(this),this._clipRect===vr.MAX?this._clipRect=new te(e,t,s,r):(this._clipRect.width=s,this._clipRect.height=r,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,i)return void oi.copyTo(this._globalClipMatrix);var a=this._globalClipMatrix,n=a.tx,o=a.ty,l=n+a.a,h=o+a.d;let d=this.sprite.globalTrans.getMatrix();if(this._clipRect.width>=De.MAX_CLIP_SIZE)a.a=a.d=De.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0;else{let{x:e,y:t,width:s,height:r}=this._clipRect;a.tx=e*d.a+t*d.c+d.tx,a.ty=e*d.b+t*d.d+d.ty,a.a=s*d.a,a.b=s*d.b,a.c=r*d.c,a.d=r*d.d}if(a.a>0&&a.d>0){var u=a.tx+a.a,c=a.ty+a.d;u<=n||c<=o||a.tx>=l||a.ty>=h?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>l&&(a.a-=u-l),a.ty<o&&(a.d-=o-a.ty,a.ty=o),c>h&&(a.d-=c-h),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}this._clip_x=d.tx,this._clip_y=d.ty}beginPath(e=!1){this._getPath().beginPath(e)}closePath(){this._path.closePath()}addPath(e,t,s,r,i){let a=e.length;for(let t=0;t<a-1;t+=2)e[t]+=r,e[t+1]+=i;t&&a>5&&(e[a-2]!=e[0]||e[a-1]!=e[1])&&e.push(e[0],e[1]),this._getPath().push(e,s)}fill(){var e=this._curMat,t=this._getPath(),s=this._curSubmit;let r;var i,a=s._key.blendShader===this._nBlendType&&!this.isSameClipInfo(s),n=this.mixRGBandAlpha(this._fillStyle._color.numColor);let o=0;for(var l=0,h=t.paths.length;l<h;l++){var d=t.paths[l],u=d.path.length/2;if(u<3||3===u&&!d.convex)continue;let h,m,f,T,y,x=d.path.concat(),S=0;if(this._matrixChanged)if(e._bTransform)for(S=0;S<u;S++)h=S<<1,m=h+1,f=x[h],T=x[m],x[h]=e.a*f+e.c*T+e.tx,x[m]=e.b*f+e.d*T+e.ty;else for(S=0;S<u;S++)h=S<<1,m=h+1,f=x[h],T=x[m],x[h]=f+e.tx,x[m]=T+e.ty;if(r&&(y=r.checkVertex(u)),a&&y||(o=0,y=this.acquire(u),r=y.mesh,a&&this._curSubmit.mesh===r||(s=this._curSubmit=this.addVGSubmit(r),a=!0)),d.convex){var c=u-2;i=new Array(3*c);for(var _=0,p=0;p<c;p++)i[_++]=o,i[_++]=p+1+o,i[_++]=p+2+o}else if(i=Pr.earcut(x,null,2),o>0)for(var g=0;g<i.length;g++)i[g]+=o;this.appendData(x,i,y,s,null,n,null,null,!1),i.length,this._appendBlockInfo(y)}}addVGSubmit(e){var t=this.createSubmit(e);return this._setClipInfo(t._internalInfo),t.clipInfoID=this._clipInfoID,t}stroke(){if(this.lineWidth<=0)return;var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),s=this._curSubmit,r=s._key.blendShader===this._nBlendType&&!this.isSameClipInfo(s);let i=this._meshPool[this._currentMeshIndex];let a=this._curMat;for(var n=0,o=t.paths.length;n<o;n++){var l=t.paths[n];if(l.path.length<=0)continue;var h=[],d=[];if(2*l.path.length<2)continue;Ar.createLine2(l.path,h,this.lineWidth,0,d,l.loop);let o,u=d.length/2;i&&(o=i.checkVertex(u)),r&&o||(o=this.acquire(u),i=o.mesh,r&&this._curSubmit.mesh===i||(s=this._curSubmit=this.addVGSubmit(i),r=!0));let c,_,p,g,m=0;if(this._matrixChanged)if(a._bTransform)for(m=0;m<u;m++)c=m<<1,_=c+1,p=d[c],g=d[_],d[c]=a.a*p+a.c*g+a.tx,d[_]=a.b*p+a.d*g+a.ty;else for(m=0;m<u;m++)c=m<<1,_=c+1,p=d[c],g=d[_],d[c]=p+a.tx,d[_]=g+a.ty;this.appendData(d,h,o,s,null,e,null,null,!1),this._appendBlockInfo(o)}}moveTo(e,t){var s=this._getPath();s.newPath(),s._lastOriX=e,s._lastOriY=t,s.addPoint(e,t)}lineTo(e,t){var s=this._getPath();Math.abs(e-s._lastOriX)<.001&&Math.abs(t-s._lastOriY)<.001||(s._lastOriX=e,s._lastOriY=t,s.addPoint(e,t))}arcTo(e,t,s,r,i){var a=0,n=0,o=0,l=this._path._lastOriX-e,h=this._path._lastOriY-t,d=Math.sqrt(l*l+h*h);if(!(d<=1e-6)){var u=l/d,c=h/d,_=s-e,p=r-t,g=_*_+p*p,m=Math.sqrt(g);if(!(m<=1e-6)){var f=_/m,T=p/m,y=u+f,x=c+T,S=Math.sqrt(y*y+x*x);if(!(S<=1e-6)){var E=y/S,v=x/S,D=Math.acos(E*u+v*c),w=Math.PI/2-D,b=(d=i*Math.tan(w))*u+e,C=d*c+t,R=Math.sqrt(d*d+i*i),M=e+E*R,A=t+v*R,I=0,P=0;if(u*T-c*f>=0){var B=2*w/ci.SEGNUM;I=Math.sin(B),P=Math.cos(B)}else B=2*-w/ci.SEGNUM,I=Math.sin(B),P=Math.cos(B);var L=this._path._lastOriX,N=this._path._lastOriY,F=b,O=C;(Math.abs(F-this._path._lastOriX)>.1||Math.abs(O-this._path._lastOriY)>.1)&&(n=F,o=O,L=F,N=O,this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o));var U=b-M,k=C-A;for(a=0;a<ci.SEGNUM;a++){var V=U*P+k*I,G=-U*I+k*P;n=V+M,o=G+A,(Math.abs(L-n)>.1||Math.abs(N-o)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o),L=n,N=o),U=V,k=G}}}}}arc(e,t,s,r,i,a,n=!1,o=!0,l=20){i>a&&([i,a]=[a,i]);var h=this.getCurrentScaleX(),d=this.getCurrentScaleY(),u=s*(h>d?h:d),c=2*Math.PI*u;let _=0|Math.max(c/5,l),p=2*Math.PI/_;var g=this._getPath();let m=e+Math.cos(i)*s,f=t+Math.sin(i)*r;m==this._path._lastOriX&&f==this._path._lastOriY||g.addPoint(m,f);let T=Math.ceil(i/p)*p;for(;a-T>=p;)m=e+Math.cos(T)*s,f=t+Math.sin(T)*r,g.addPoint(m,f),T+=p;m=e+Math.cos(a)*s,f=t+Math.sin(a)*r,m==this._path._lastOriX&&f==this._path._lastOriY||g.addPoint(m,f)}quadraticCurveTo(e,t,s,r){for(var i=yt.getPoints([this._path._lastOriX,this._path._lastOriY,e,t,s,r],30,2),a=0,n=i.length/2;a<n;a++)this.lineTo(i[2*a],i[2*a+1]);this.lineTo(s,r)}mixRGBandAlpha(e){return this._mixRGBandAlpha(e,this._alpha)}_mixRGBandAlpha(e,t){if(t>=1)return e;var s=(4278190080&e)>>>24;return 0!=s?s*=t:s=255*t,16777215&e|s<<24}strokeRect(e,t,s,r,i=0){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(e-n,t-n,s+this.lineWidth,this.lineWidth,a),this._fillRect(e-n,t-n+r,s+this.lineWidth,this.lineWidth,a),this._fillRect(e-n,t+n,this.lineWidth,r-this.lineWidth,a),this._fillRect(e-n+s,t+n,this.lineWidth,r-this.lineWidth,a)}}drawParticle(e,t,s){}_getPath(){return this._path||(this._path=new xr)}_getImageSource(e){let t=this.sprite;return e._getSource(function(){t&&(t._graphics?t._graphics.repaint():t.repaint())})}acquire(e){let t=this._meshPool;for(let s=0;s<t.length;s++){let r=t[s].checkVertex(e);if(r)return this._currentMeshIndex=s,r}let s=new ni;return this._meshPool.push(s),this._currentMeshIndex=this._meshPool.length-1,s.checkVertex(e)}appendData(e,t,s,r,i,a,n,o,l,h,d){let u,c,_,p,g,m,f=e.length/2,T=0,y=0,x=1,S=1;o&&(T=o[0],y=o[1],x=o[2],S=o[3]),n&&(u=n.a,c=n.b,_=n.c,p=n.d,g=n.tx,m=n.ty);let E,v=(255&a)/255,D=(a>>>16&255)/255,w=(a>>>8&255)/255,b=(a>>>24)/255,C=l?255:0,R=d?255:0,M=0,A=s.vertexViews,I=[],P=0,B=[],L=s.mesh._buffer._tempVertexData,N=ni.stride;for(let t=0,s=0,r=0,a=0;t<f;t++){(!E||E.length<=a)&&(E&&E.setData(L),E=A[M],M++,a=0,P=E.start/E.stride);let o=e[s],l=e[s+1];n?n._bTransform?(L[a]=B[s]=o*u+l*_+g,L[a+1]=B[s+1]=o*c+l*p+m):(L[a]=B[s]=o+g,L[a+1]=B[s+1]=l+m):(L[a]=B[s]=o,L[a+1]=B[s+1]=l),i&&(L[a+2]=T+i[s]*x,L[a+3]=y+i[s+1]*S),null!=h?(L[a+4]=h[r],L[a+5]=h[r+1],L[a+6]=h[r+2],L[a+7]=h[r+3]):(L[a+4]=v,L[a+5]=w,L[a+6]=D,L[a+7]=b),L[a+8]=C,L[a+9]=R,d&&(L[a+12]=d[0],L[a+13]=d[1],L[a+14]=d[2],L[a+15]=d[3]),a+=N,s+=2,r+=4,I[t]=P++}E&&E.setData(L),s.positions=B;let F=r.indexCount,O=t.length,U=r.indices;for(let e=0;e<O;e++)U[e+F]=I[t[e]];r.indexCount+=O}initDefalutMesh(){if(!this.def_geometry){let t=4*ni.stride,s=new Float32Array(t),r=new Float32Array(t),i=ie.DEF_UV,a=ie.INV_UV,n=[0,0,1,0,1,1,0,1],o=0;for(let e=0;e<4;e++){let t=e*ni.stride;r[t]=s[t]=n[o],r[t+1]=s[t+1]=n[o+1],s[t+2]=i[o],s[t+3]=i[o+1],r[t+2]=a[o],r[t+3]=a[o+1],r[t+4]=s[t+4]=1,r[t+5]=s[t+5]=1,r[t+6]=s[t+6]=1,r[t+7]=s[t+7]=1,r[t+8]=s[t+8]=255,o+=2}let l=ui,h=f.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Static);h.indexType=e.IndexFormat.UInt16,h.indexCount=l.length,h._setIndexDataLength(l.byteLength),h._setIndexData(l,0);let d=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Static);d.vertexDeclaration=ni.vertexDeclarition,d.setDataLength(s.byteLength),d.setData(s.buffer,0,0,s.byteLength);let u=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Static);u.vertexDeclaration=ni.vertexDeclarition,u.setDataLength(r.byteLength),u.setData(r.buffer,0,0,r.byteLength),this.def_geometry=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement);let c=f.renderDeviceFactory.createBufferState();c.applyState([d],h),this.def_geometry.bufferState=c,this.def_geometry.indexFormat=e.IndexFormat.UInt16,this.def_geometry.setDrawElemenParams(6,0),this.inv_geometry=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement);let _=f.renderDeviceFactory.createBufferState();_.applyState([u],h),this.inv_geometry.bufferState=_,this.inv_geometry.indexFormat=e.IndexFormat.UInt16,this.inv_geometry.setDrawElemenParams(6,0)}}}ci.SEGNUM=32;class _i{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===_i.DEFAULT?new _i:this}}_i.DEFAULT=new _i;class pi{static __init__(){pi.runner=new ci,pi.rendercontext2D=f.render2DRenderPassFactory.createRenderContext2D()}get basePass(){return this._basePass}constructor(){this._basePass=f.render2DRenderPassFactory.createRender2DPass(),this._manager=f.render2DRenderPassFactory.createRender2DPassManager(),this._basePass.doClearColor=!1,this._basePass.priority=0,this.addPass(this._basePass)}addPass(e){this._manager.addPass(e)}removePass(e){this._manager.removePass(e)}apply(t){let s=performance.now();this._manager.apply(t),f.statAgent.recordTimeData(e.StatElement.T_2DPass,performance.now()-s)}clear(){this._manager.clear()}}const gi="FillTextCmd";class mi{constructor(){this.x=0,this.y=0,this.color="#ffffff",this.strokeColor="#000000",this.stroke=0,this.align="left",this.fontSize=20}static create(e,t,s,r,i,a,n,o){let l=h.getItemByClass(gi,mi);return l.text=null,l.x=t,l.y=s,l.font=r,l.color=null!=i?i:"#ffffff",l.stroke=null!=n?n:0,l.strokeColor=null!=o?o:"#000000",l.text=e,l.align=null!=a?a:"left",l.singleCharRender=!1,l._preMeasuredWidth=null,l}get font(){return this._font||(this._font=(this.bold?"bold ":"")+this.fontSize+"px "+(this.fontFamily?this.fontFamily:t.defaultFont)),this._font}set font(e){if(this._font=e,!e)return this.fontFamily=null,void(this.fontSize=t.defaultFontSize);let s=e.split(" "),r=s.length;if(r<2)return 1==r&&s[0].indexOf("px")>0&&(this.fontSize=parseInt(s[0])),void(this.fontFamily=null);let i=-1;for(let t=0;t<r;t++)if(s[t].indexOf("px")>0||s[t].indexOf("pt")>0){i=t,this.fontSize=parseInt(s[t]),this.fontSize<=0&&(console.debug("font parse error:"+e),this.fontSize=20);break}let a=i+1,n=s[a];for(a++;a<r;a++)n+=" "+s[a];this.fontFamily=n.split(",")[0],this.italic=s.indexOf("italic")>=0,this.bold=s.indexOf("bold")>=0}recover(){h.recover(gi,this),this._preMeasuredWidth=null,this._renderInfo&&pi.runner._textRender.freeRenderInfo(this._renderInfo)}get cmdID(){return mi.ID}run(e,s,r){if(!this.text)return void(this._renderInfo&&e._textRender.freeRenderInfo(this._renderInfo));let i=this.getTextWidth();switch(this.align){case"center":s-=i/2;break;case"right":s-=i}this._renderInfo=e._textRender.draw(this.text,this.x+s,this.y+r,this.fontFamily?this.fontFamily:t.defaultFont,this.fontSize,this.bold,this.italic,this.color,this.stroke,this.strokeColor,this.singleCharRender,i,this._renderInfo)}getTextWidth(){if(null!=this._preMeasuredWidth)return this._preMeasuredWidth;let e=Y.context;return e.font=this.font,e.measureText(this.text).width}getBounds(e){let t=this.getTextWidth(),s=this.x,r=this.y;switch(this.align){case"center":s-=t/2;break;case"right":s-=t}s-=4,r-=this.fontSize/2,te.TEMP.setTo(s,r,t+8,2*this.fontSize).getBoundPoints(e.points)}}mi.ID=gi,Ee.regClass(gi,mi);const fi="FillTextureCmd";class Ti{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.type="repeat",this.percent=!0,this.color=4294967295}static create(e,t,s,r,i,a,n,o,l){null==r&&(r=e.width),null==i&&(i=e.height);var d=h.getItemByClass(fi,Ti);return d.texture=e,e._addReference(),d.x=t,d.y=s,d.width=r,d.height=i,d.type=a,d.offset=n,d.color=null!=o?ht.create(o).numColor:4294967295,d.percent=l,d}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,h.recover(fi,this)}run(e,t,s){if(this.texture)if(this.percent&&e.sprite){let r=e.sprite.width,i=e.sprite.height;e.fillTexture(this.texture,this.x*r+t,this.y*i+s,this.width*r,this.height*i,this.type,this.offset||u.EMPTY,this.color)}else e.fillTexture(this.texture,this.x+t,this.y+s,this.width,this.height,this.type,this.offset||u.EMPTY,this.color)}getBounds(e){let t=te.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}get cmdID(){return Ti.ID}}Ti.ID=fi,Ee.regClass(fi,Ti);const yi="RotateCmd";class xi{static create(e,t,s){var r=h.getItemByClass(yi,xi);return r.angle=e,r.pivotX=t,r.pivotY=s,r}recover(){h.recover(yi,this)}run(e,t,s){e._rotate(this.angle,this.pivotX+t,this.pivotY+s)}getBounds(e){Si.identity(),Si.translate(-this.pivotX,-this.pivotY),Si.rotate(this.angle),Si.translate(this.pivotX,this.pivotY),e.concatMatrix(Si)}get cmdID(){return xi.ID}}xi.ID=yi;const Si=new Ce,Ei="ScaleCmd";class vi{static create(e,t,s,r){var i=h.getItemByClass(Ei,vi);return i.scaleX=e,i.scaleY=t,i.pivotX=s,i.pivotY=r,i}recover(){h.recover(Ei,this)}run(e,t,s){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+s)}getBounds(e){Di.identity(),Di.translate(-this.pivotX,-this.pivotY),Di.scale(this.scaleX,this.scaleY),Di.translate(this.pivotX,this.pivotY),e.concatMatrix(Di)}get cmdID(){return vi.ID}}vi.ID=Ei;const Di=new Ce,wi="TransformCmd";class bi{static create(e,t,s){var r=h.getItemByClass(wi,bi);return r.matrix=e,r.pivotX=t,r.pivotY=s,r}recover(){this.matrix=null,h.recover(wi,this)}run(e,t,s){e._transform(this.matrix,this.pivotX+t,this.pivotY+s)}getBounds(e){Ci.identity(),Ci.translate(-this.pivotX,-this.pivotY),Ci.concat(this.matrix),Ci.translate(this.pivotX,this.pivotY),e.concatMatrix(Ci)}get cmdID(){return bi.ID}}bi.ID=wi;const Ci=new Ce,Ri="TranslateCmd";class Mi{static create(e,t){var s=h.getItemByClass(Ri,Mi);return s.tx=e,s.ty=t,s}recover(){h.recover(Ri,this)}run(e){e.translate(this.tx,this.ty)}getBounds(e){Ai.identity(),Ai.translate(this.tx,this.ty),e.concatMatrix(Ai)}get cmdID(){return Mi.ID}}Mi.ID=Ri;const Ai=new Ce,Ii="DrawEllipseCmd";class Pi{constructor(){this.lineWidth=0}static create(e,t,s,r,i,a,n,o){var l=h.getItemByClass(Ii,Pi);return l.x=e,l.y=t,l.width=s,l.height=r,l.fillColor=i,l.lineColor=a,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,h.recover(Ii,this)}run(e,t,s){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let i=e.sprite.width,a=e.sprite.height;e._drawEllipse(this.x*i+t,this.y*a+s,this.width*i-r,this.height*a-r,this.fillColor,this.lineColor,this.lineWidth)}else e._drawEllipse(this.x+t,this.y+s,this.width-r,this.height-r,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Pi.ID}getBounds(e){let t=te.TEMP.setTo(this.x-this.width,this.y-this.height,2*this.width,2*this.height);this.percent&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}}Pi.ID=Ii,Ee.regClass(Ii,Pi);const Bi="DrawRoundRectCmd";class Li{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.lt=6,this.rt=6,this.lb=6,this.rb=6,this.lineWidth=0,this.percent=!0}static create(e,t,s,r,i,a,n,o,l,d,u,c){var _=h.getItemByClass(Bi,Li);return _.x=e,_.y=t,_.width=s,_.height=r,_.lt=i,_.rt=a,_.lb=n,_.rb=o,_.fillColor=l,_.lineColor=d,_.lineWidth=u,_.percent=c,_}recover(){this.fillColor=null,this.lineColor=null,h.recover(Bi,this)}run(e,t,s){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,i=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let a=e.sprite.width,n=e.sprite.height;e._drawRoundRect(this.x*a+r+t,this.y*n+r+s,this.width*a-i,this.height*n-i,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else e._drawRoundRect(this.x+r+t,this.y+r+s,this.width-i,this.height-i,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Li.ID}getBounds(e){let t=te.TEMP.setTo(this.x,this.y,this.width,this.height);this&&t.scale(e.width,e.height),t.getBoundPoints(e.points)}}Li.ID=Bi,Ee.regClass(Bi,Li);class Ni{static add2DGlobalUniformData(e,t,s){f.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(e,t,s)}get useSpriteState(){return this._useSpriteState}set useSpriteState(e){this._useSpriteState!=e&&(this._useSpriteState=e,this.repaint())}constructor(){this.owner=null,this._useSpriteState=!0,this._useSpriteRect=!1,this._cmds=[],this._graphicBounds=null,this._modified=!1,this._display=!1,this._renderDataHandle=f.render2DRenderPassFactory.create2D2DPrimitiveDataHandle()}destroy(){this.owner&&this.owner._graphics===this&&this.owner.setGraphics(null,!1);for(let e of this._cmds)e.lock||e.recover();this._cmds.length=0,this._material&&(this._material._removeReference(),this._material=null),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._renderDataHandle&&this._renderDataHandle.destroy(),this._data=null,this.owner=null}clear(e,t){if(0!==this._cmds.length){if(e||null==e)for(let e of this._cmds)e.lock||e==t||e.recover();t?(this._cmds[0]=t,this._cmds.length=1):this._cmds.length=0,this._data&&this._data.clear(),this.repaint()}}_repaint(){this.repaint()}repaint(){var t,s;this._modified=!0,null===(t=this._graphicBounds)||void 0===t||t.reset(),this._checkDisplay(),null===(s=this.owner)||void 0===s||s.repaint(e.RepaintFlag.Graphics)}get cmds(){return this._cmds}set cmds(e){this._cmds.length>0&&this._cmds.filter(t=>!e.includes(t)).forEach(e=>{e.lock||e.recover()}),this._cmds=e,this.repaint()}addCmd(e,t){if(null==e)throw new Error("null cmd");return null==t||t>=this._cmds.length?this._cmds.push(e):this._cmds.splice(t,0,e),this.repaint(),e}removeCmd(e,t){let s=this.cmds.indexOf(e);-1!=s&&(this._cmds.splice(s,1),this.repaint()),t&&(e.lock=!1,e.recover())}replaceCmd(e,t,s){let r=this._cmds.indexOf(e);return null!=t?(-1!==r?this._cmds[r]=t:this._cmds.push(t),this.repaint()):-1!=r&&(this._cmds.splice(r,1),this.repaint()),e&&s&&(e.lock=!1,e.recover()),t}_checkDisplay(){if(!this.owner||this.owner.destroyed)return void(this._display=!1);let t=!this.owner._renderNode&&(this._cmds.length>0||null!=this.owner._texture);if(this._display===t)return;this._display=t;let s=this.owner._struct;t?(this._modified=!0,this.owner._initShaderData(),this.owner._renderType|=$e.GRAPHICS,s.renderType=e.BaseRender2DType.graphics,s.renderDataHandler=this._renderDataHandle,s.renderElements=this._data._renderElements,this.owner._updateStruct()):(this.owner._renderType&=~$e.GRAPHICS,s.renderElements===this._data._renderElements&&(s.renderElements=[]),this._data&&this._data.clear(),s.renderType=-1,s.renderDataHandler=null)}getBounds(){return this._graphicBounds||(this._graphicBounds=Ve.create()),this._graphicBounds.getBounds(this)}getBoundPoints(){return this._graphicBounds||(this._graphicBounds=Ve.create()),this._graphicBounds.getBoundPoints(this)}get material(){return this._material}set material(t){t&&!t.checkType(e.ShaderFeatureType.D2_TextureSV)||this._material!=t&&(this._material&&this._material._removeReference(),this._material=t,this.repaint(),null!=t&&t._addReference())}drawImage(e,t=0,s=0,r=null,i=null,a=null){return e&&e.bitmap?this.addCmd(It.create(e,t,s,r,i,a)):null}drawTexture(e,t=0,s=0,r=null,i=null,a=null,n=1,o=null,l=null,h){return!e||n<.01?null:e.bitmap?this.addCmd(Xt.create(e,t,s,r,i,a,n,o,l,h)):null}drawTextures(e,t,s){return e?this.addCmd(qt.create(e,t,s)):null}drawTriangles(e,t,s,r,i,a,n=null,o=1,l=null,h=null){return this.addCmd(Kt.create(e,t,s,r,i,a,n,o,l,h))}fillTexture(e,t,s,r=0,i=0,a="repeat",n=null,o=null,l=!1){return e&&e.bitmap?this.addCmd(Ti.create(e,t,s,r,i,a,n||u.EMPTY,o,l)):null}clipRect(e,t,s,r){return this.addCmd(et.create(e,t,s,r))}fillText(e,t,s,r,i,a){return this.addCmd(mi.create(e,t,s,r,i,a,0,""))}fillBorderText(e,t,s,r,i,a,n,o){return this.addCmd(mi.create(e,t,s,r,i,a,n,o))}strokeText(e,t,s,r,i,a,n){return this.addCmd(mi.create(e,t,s,r,null,n,a,i))}alpha(e){return this.addCmd(Ze.create(e))}transform(e,t=0,s=0){return this.addCmd(bi.create(e,t,s))}rotate(e,t=0,s=0){return this.addCmd(xi.create(e,t,s))}scale(e,t,s=0,r=0){return this.addCmd(vi.create(e,t,s,r))}translate(e,t){return this.addCmd(Mi.create(e,t))}save(){return this.addCmd(ke.create())}restore(){return this.addCmd(Ae.create())}replaceTextColor(e){this.repaint();let t=this._cmds;for(let s=t.length-1;s>-1;s--){let r=t[s];switch(r.cmdID){case mi.ID:r.color=e;break;case It.ID:r.color=null!=e?ht.create(e).numColor:4294967295}}}loadImage(e,t=0,s=0,r=null,i=null,a=null){let n=l.loader.getRes(e);n?(this.drawImage(n,t,s,r,i),a&&a.call(this.owner)):l.loader.load(e).then(e=>{this.drawImage(e,t,s,r,i),a&&a.call(this.owner)})}_render(t,s=0,r=0){if(!this.owner||this.owner.destroyed||this.owner._struct.renderType!==e.BaseRender2DType.graphics)return;if(!this._modified&&this._check())return void this._data.setRenderElement(this.owner._struct,this._renderDataHandle);this._data.clear(),t.clear(),t.sprite=this.owner,t._graphicsData=this._data,t._material=this._material;let i=t.globalCompositeOperation;t.globalCompositeOperation=this.owner._struct.blendMode;var a=this._cmds;for(let e=0,i=a.length;e<i;e++)a[e].run(t,s,r);this._renderSpriteTexture(t,s,r),this._data.updateRenderElement(this,this.owner._struct,this._renderDataHandle),t.globalCompositeOperation=i,t._material=null,t._graphicsData=null,t.sprite=null,this._modified=!1}_check(){let e=this._data._submits.length;for(let t=0;t<e;t++){let e=this._data._submits.elements[t]._internalInfo.textureHost;if(!e)continue;let s=e.bitmap;if(s&&s.destroyed)return!1}return!0}_renderSpriteTexture(e,t,s){let r=this.owner,i=r._texture;if(i&&i._getSource(()=>{this.owner.graphics.repaint()})){var a=r._isWidthSet?r._width:i.sourceWidth,n=r._isHeightSet?r._height:i.sourceHeight,o=a/i.sourceWidth,l=n/i.sourceHeight;if(a=i.width*o,n=i.height*l,a>0&&n>0){let r=t+i.offsetX*o,h=s+i.offsetY*l;e.drawTexture(i,r,h,a,n,4294967295)}}}drawLine(e,t,s,r,i,a=1){return this.addCmd(Bt.create(e,t,s,r,i,a))}drawLines(e,t,s,r,i=1){return!s||s.length<4?null:this.addCmd(Nt.create(e,t,s,r,i))}drawCurves(e,t,s,r,i=1){return this.addCmd(Mt.create(e,t,s,r,i))}drawRect(e,t,s,r,i,a=null,n=1,o){return this.addCmd(Ht.create(e,t,s,r,i,a,n,o))}drawRoundRect(e,t,s,r,i,a,n,o,l,h=null,d=1,u){return this.addCmd(Li.create(e,t,s,r,i,a,n,o,l,h,d,u))}drawCircle(e,t,s,r,i=null,a=1,n){return this.addCmd(Tt.create(e,t,s,r,i,a,n))}drawEllipse(e,t,s,r,i,a,n,o){return this.addCmd(Pi.create(e,t,s,r,i,a,n,o))}drawPie(e,t,s,r,i,a,n=null,o=1){return this.addCmd(kt.create(e,t,s,Q.toRadian(r),Q.toRadian(i),a,n,o))}drawPoly(e,t,s,r,i=null,a=1){return this.addCmd(Gt.create(e,t,s,r,i,a))}drawPath(e,t,s,r=null,i=null){return this.addCmd(Ot.create(e,t,s,r,i))}draw9Grid(e,t=0,s=0,r=0,i=0,a,n){this.addCmd(gt.create(e,t,s,r,i,a,!1,n))}}const Fi=[],Oi=we.ACTIVE,Ui=we.DISPLAY;class ki extends N{get url(){return this._url}set url(e){this._url=e}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}get is3D(){return 1===this._nodeType}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._reactiveBits=0,this._hideFlags=0,this._parent=null,this._destroyed=!1,this._nodeType=0,this.name="",this._bits=Oi,this._reactiveBits=Ui,this._children=[],this._$children=this._children,this._$container=this,this._initialize()}_initialize(){this._extra={}}_setBit(e,t){return 0===(this._bits&e)!=!t&&(t?this._bits|=e:this._bits&=~e,0!=(e&this._reactiveBits)&&this._onSetBit(e,t),!0)}_getBit(e){return 0!==(this._bits&e)}_onSetBit(e,t){if(0!==(e&we.DISPLAY)){let e=this._parent,t=l.stage,s=this===t;for(;e;){if(0!==(e._bits&we.DISPLAY)){s=0!==(e._bits&we.DISPLAYED_INSTAGE);break}if(e===t){s=!0;break}e=e._parent}this._setBit(we.DISPLAYED_INSTAGE,s)}}_setBitUp(e){let t=this;for(t._setBit(e,!0),t=t._parent;t;){if(0!==(t._bits&e))return;t._setBit(e,!0),t=t._parent}}onStartListeningToType(e){e!==c.DISPLAY&&e!==c.UNDISPLAY||0!==(this._bits&we.DISPLAY)||this._setBitUp(we.DISPLAY)}bubbleEvent(e,t){let s=[];s.length=0;let r,i=this;for(;i;)i.activeInHierarchy&&s.push(i),i=i._parent;t instanceof c&&(r=t,r._stopped=!1);for(let i of s)if(r){if(r.setTo(e,i,this),i.event(e,t),r._stopped)break}else i.event(e,t)}hasHideFlag(e){return 0!=(this._hideFlags&e)}destroy(e=!0){if(!this._destroyed){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent._removeChild(this);for(let t=0,s=this._children.length;t<s;t++){let t=this._children[0];this._children.shift(),t&&(t._setParent(null),e&&t.destroy())}this.onDestroy(),this.offAll()}}onDestroy(){}destroyChildren(){for(let e=0,t=this._$children.length;e<t;e++)this._$children[0].destroy(!0)}get children(){return this._$children}addChild(e){return this.addChildAt(e,this._$children.length)}addChildren(...e){let t=0,s=e.length;for(;t<s;)this.addChildAt(e[t++],this._$children.length)}addChildAt(e,t){if(t>=0&&t<=this._$children.length)return e._$parent===this?this.setChildIndex(e,t):(e._parent&&e._parent.removeChild(e),this._$children.splice(t,0,e),e._$parent=this,e._setParent(this._$container)),e;throw new R(t)}getChildIndex(e){return this._$children.indexOf(e)}getChild(e,t){for(let t of this._$children)if(t.name===e)return t;return null}getChildByName(e,t){return this.getChild(e,t)}getChildAt(e,t){if(e>=0&&e<this.numChildren)return this._$children[e];throw new R(e)}getChildByPath(e,t){let s,r=e.split("."),i=r.length,a=this;for(let e=0;e<i&&(s=a.getChild(r[e],t),s);++e)a=s;return s}findChild(e,t){for(let s of this._$children){if(s.name==e)return s;if(!s.url&&(s=s.findChild(e,t),s))return s}return null}setChildIndex(e,t){let s=this._$children.indexOf(e);if(s<0)throw new Error("not a child of this node");return this._setChildIndex(e,s,t),e}setChildIndexBefore(e,t){let s=this._$children.indexOf(e);if(-1==s)throw new Error("not a child of this node");return s<t?this._setChildIndex(e,s,t-1):this._setChildIndex(e,s,t)}_setChildIndex(e,t,s){let r=this._$children.length;return s>r&&(s=r),t==s?t:(this._$children.splice(t,1),s>=this._$children.length?this._$children.push(e):this._$children.splice(s,0,e),this._$container._childChanged(),s)}_childChanged(e){}removeChild(e,t){let s=this._$children.indexOf(e);if(-1==s)throw new Error("not a child of this node");return this._$children.splice(s,1),e._setParent(null),t&&e.destroy(),e}removeSelf(){return this._parent&&this._parent._removeChild(this),this}removeChildByName(e,t){let s=this.getChild(e);return s&&this.removeChild(s,t),s}removeChildAt(e,t){let s=this._$children[e];return this._$children.splice(e,1),s._setParent(null),t&&s.destroy(),s}removeChildren(e,t,s){e=e||0,null==t&&(t=-1),(t<0||t>=this._$children.length)&&(t=this._$children.length-1);for(let r=e;r<=t;++r)this.removeChildAt(e,s)}replaceChild(e,t){let s=this._$children.indexOf(t);if(-1==s)throw new Error("not a child of this node");return this.removeChildAt(s),this.addChildAt(e,s)}_setContainer(e){this._$container=e,this._$children=e._children}_addChild(e,t){let s=this._children;if(null==t&&(t=s.length),t>=0&&t<=s.length){if(e._parent===this){let r=s.indexOf(e);s.splice(r,1),t>=s.length?s.push(e):s.splice(t,0,e),this._childChanged(e)}else e._parent&&e._parent.removeChild(e),s.splice(t,0,e),e._$parent=this,e._setParent(this);return e}throw new R(t)}_removeChild(e){let t=this._children.indexOf(e);if(-1==t)throw new Error("not a child of this node");return this._children.splice(t,1),e._setParent(null),e}get numChildren(){return this._$children.length}get parent(){return this._$parent}isAncestorOf(e){if(!e)return!1;let t=e._parent;for(;t;){if(t==this)return!0;t=t._parent}return!1}_setParent(e){if(e)this._parent=e,this._onAdded(),this.event(c.ADDED),0!==(this._bits&we.DISPLAY)&&(this._setBitUp(we.DISPLAY),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this);else{this._onRemoved(),this.event(c.REMOVED);let e=this._parent;0!==(this._bits&we.DISPLAY)&&this._displayChild(this,!1),this._parent=null,this._$parent=null,e._destroyed||e._childChanged(this)}}get displayedInStage(){return 0===(this._bits&we.DISPLAY)&&this._setBitUp(we.DISPLAY),0!==(this._bits&we.DISPLAYED_INSTAGE)}_setDisplay(e){0!==(this._bits&we.DISPLAYED_INSTAGE)!==e&&(this._setBit(we.DISPLAYED_INSTAGE,e),e?this.event(c.DISPLAY):this.event(c.UNDISPLAY))}_displayChild(e,t){for(let s of e._children)0!==(s._bits&we.DISPLAY)&&(s._children.length>0?this._displayChild(s,t):s._setDisplay(t));e._setDisplay(t)}contains(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}timerLoop(e,t,s,r=null,i=!0,a=!1){this.timer.loop(e,t,s,r,i,a)}timerOnce(e,t,s,r=null,i=!0){this.timer._create(!1,!1,e,t,s,r,i)}frameLoop(e,t,s,r=null,i=!0){this.timer._create(!0,!0,e,t,s,r,i)}frameOnce(e,t,s,r=null,i=!0){this.timer._create(!0,!1,e,t,s,r,i)}clearTimer(e,t){this.timer.clear(e,t)}callLater(e,t=null){this.timer.callLater(this,e,t)}runCallLater(e){this.timer.runCallLater(this,e)}get scene(){return this._scene}get stage(){return l.stage}get active(){return 0!==(this._bits&we.ACTIVE)}set active(e){var t;if(e=!!e,0!==(this._bits&we.ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._setBit(we.ACTIVE,e),(null===(t=this._parent)||void 0===t?void 0:t.activeInHierarchy)&&0==(this._bits&we.NOT_IN_PAGE)&&this._processActive(e,!0)}}get activeInHierarchy(){return 0!==(this._bits&we.ACTIVE_INHIERARCHY)}_onActive(){}_onInActive(){}_onActiveInScene(){}_onInActiveInScene(){}onAwake(){}onEnable(){}onDisable(){}_parse(e,t){}_setBelongScene(e){if(!this._scene||this._scene!=e){this._scene=e,this._onActiveInScene();for(let t of this._children)t._setBelongScene(e)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let e of this._children)e._setUnBelongScene()}}_processActive(e,t){this._activeChangeScripts||(this._activeChangeScripts=[]);let s=this._activeChangeScripts;e?this._activeHierarchy(s,t):this._inActiveHierarchy(s,t);for(let t=0,r=s.length;t<r;t++){let r=s[t];r.owner&&r._setActive(e)}s.length=0}_activeHierarchy(t,s){if(this._setBit(we.ACTIVE_INHIERARCHY,!0),this._components)for(let e=0,s=this._components.length;e<s;e++){let s=this._components[e];s._isScript()?s._enabled&&t.push(s):s._setActive(!0)}this._onActive(),f.statAgent.recordCountData(e.StatElement.C_Sprite2DCount,1);for(let e of this._children)0!==(e._bits&we.ACTIVE)&&0===(e._bits&we.NOT_IN_PAGE)&&e._activeHierarchy(t,s);0===(this._bits&we.AWAKED)&&(this._setBit(we.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(t,s){if(this._onInActive(),f.statAgent.recordCountData(e.StatElement.C_Sprite2DCount,-1),this._components)for(let e=0,s=this._components.length;e<s;e++){let s=this._components[e];s._isScript()?s._enabled&&t.push(s):s._setActive(!1)}this._setBit(we.ACTIVE_INHIERARCHY,!1);for(let e of this._children)0!==(e._bits&we.ACTIVE_INHIERARCHY)&&e._inActiveHierarchy(t,s);this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");{let e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&0!==(this._bits&we.ACTIVE)&&0===(this._bits&we.NOT_IN_PAGE)&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._parent.activeInHierarchy&&0!==(this._bits&we.ACTIVE)&&0===(this._bits&we.NOT_IN_PAGE)&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(e){var t;e._singleton&&this.getComponent(e.constructor)?console.warn("the component is singleton, can't add the second one.",e):(this._components||(this._components=[]),this._components.push(e),e._setOwner(this),this.activeInHierarchy&&e._setActive(!0),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,0))}_destroyComponent(e){var t;if(!this._components)return;let s=this._components.indexOf(e);-1!=s&&(this._components.splice(s,1),e._destroy(),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,1))}destroyAllComponent(){var e;if(this._components){for(let e=0,t=this._components.length;e<t;e++){let t=this._components[e];t&&!t.destroyed&&t._destroy()}this._components.length=0,null===(e=this._componentsChanged)||void 0===e||e.call(this,null,2)}}_cloneTo(e,t,s){if(this._components)for(let t=0,s=this._components.length;t<s;t++){let s=e.addComponent(this._components[t].constructor);this._components[t]._cloneTo(s)}}addComponentInstance(e){if(e.owner)throw new Error("the component is belong to other node.");return this._addComponentInstance(e),e}addComponent(e){let t=h.createByClass(e);if(!t)throw new Error("missing "+e.toString());return this._addComponentInstance(t),t}getComponent(e){if(this._components)for(let t=0,s=this._components.length;t<s;t++){let s=this._components[t];if(s instanceof e)return s}return null}get components(){return this._components||Fi}getComponents(e){let t=[];if(this._components)for(let s=0,r=this._components.length;s<r;s++){let r=this._components[s];r instanceof e&&(t=t||[],t.push(r))}return t}get timer(){return this._scene?this._scene.timer:l.timer}onAfterDeserialize(){}}class Vi{static get FPS(){return f.statAgent.getElementData(e.StatElement.CT_FPS)}static show(t,r,i){if(Vi._statUI||(Vi._statUI=new Vi._statUIClass),this.hide(),i&&(Vi.elements.length=0,Vi.elements.push(...i)),0===Vi.elements.length){const t=s.statEnum;if(t){for(let s in t)t[s]&&Vi.elements.push(e.StatElement[s]);Vi.elements.sort()}}0===Vi.elements.length&&Vi.elements.push(...Gi),Vi._show=!0,Vi._statUI.show(t,r),l.systemTimer.frameLoop(1,null,Vi.loop)}static hide(){Vi._show&&(Vi._show=!1,Vi._statUI.hide(),l.systemTimer.clear(null,Vi.loop))}static loop(){Vi._show&&Vi._statUI.update()}static render(){Vi._show&&Vi._statUI.render()}}Vi.elements=[],Vi.loopCount=0,Vi.render2DCount=0,Vi.enableShadow=!0,Vi.enableMulLight=!0,Vi.enableLight=!0,Vi.enableCameraCMD=!0,Vi.enablePostprocess=!0,Vi.enableSkin=!0,Vi.enableTransparent=!0,Vi.enableParticle=!0,Vi.enableAnimatorUpdate=!0,Vi.enablePhysicsUpdate=!0,Vi.enablemsaa=!0,Vi.enableOpaque=!0;const Gi=[e.StatElement.CT_FPS,e.StatElement.T_Frame_Time,e.StatElement.C_Sprite2DCount,e.StatElement.C_Sprite3DCount,e.StatElement.CT_DrawCall,e.StatElement.CT_Triangle,e.StatElement.C_BaseRenderCount,e.StatElement.C_SkinnedMeshRenderCount,e.StatElement.C_ShurikenParticleRenderCount,e.StatElement.T_CullMain,e.StatElement.CT_OpaqueDrawCall,e.StatElement.CT_TransDrawCall,e.StatElement.CT_ShadowDrawCall,e.StatElement.CT_DepthCastDrawCall,e.StatElement.CT_Instancing_DrawCall,e.StatElement.M_GPUMemory,e.StatElement.M_AllTexture,e.StatElement.M_RenderTexture,e.StatElement.M_GPUBuffer];window.Stat=Vi;class zi extends G{static __init__(){zi._empty=new zi(1,1,e.RenderTargetFormat.R8G8B8,e.RenderTargetFormat.None),zi._empty.width=0,zi._empty.height=0,zi._empty.lock=!0}static createFromPool(e,t,s,r){for(let i=zi._pool.length-1;i>=0;i--){let a=zi._pool[i];if(a.destroyed){zi._pool.splice(i,1);let e=a._renderTarget?a._renderTarget.gpuMemory/1024/1024:0;zi._poolMemory-=e,zi._poolTimeouts.delete(a._id);continue}if(a.width==e&&a.height==t&&a.getColorFormat()==s&&a.depthStencilFormat==r)return a._inPool=!1,zi._pool.splice(i,1),zi._poolMemory-=a._renderTarget.gpuMemory/1024/1024,zi._poolTimeouts.delete(a._id),a}let i=new zi(e,t,s,r);return i.lock=!0,i}static recoverToPool(e){e._inPool||e.destroyed||(zi._pool.push(e),zi._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0,zi._poolTimeouts.set(e.id,performance.now()))}static clearPool(){if(!(zi._poolMemory<256)){for(var e in zi._pool)zi._pool[e].destroy();zi._pool=[],zi._poolMemory=0,zi._poolTimeouts.clear()}}static cleanupExpired(){let e=Vi.loopCount;if(e-zi._lastCleanupFrame<zi.cleanupFrameInterval)return-1;zi._lastCleanupFrame=e;let t=zi.cleanupTimeout,s=performance.now(),r=0;for(let e=zi._pool.length-1;e>=0;e--){let i=zi._pool[e],a=zi._poolTimeouts.get(i.id);a&&s-a>t&&(zi._pool.splice(e,1),zi._poolMemory-=i._renderTarget.gpuMemory/1024/1024,zi._poolTimeouts.delete(i.id),i.destroy(),r++)}return r}static get currentActive(){return zi._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return fs.grayTexture}getIsReady(){return!0}getColorFormat(){return this._colorFormat}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,s,r=e.RenderTargetFormat.R8G8B8,i=e.RenderTargetFormat.None){super(t,s,r),this._mgrKey=0,this._invertY=!1,this._inPool=!1,this._colorFormat=r,this._depthStencilFormat=i,0!=t&&0!=s&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new C}_end(){throw new C}_create(){this._renderTarget=f.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1,!1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}clear(e=0,t=0,s=0,r=1){zi._clearColor.r=e,zi._clearColor.g=t,zi._clearColor.b=s,zi._clearColor.a=r,zi._clear=!0}getData(t,s,r,i){const a=r*i*4;let n;switch(this._renderTarget.colorFormat){case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:n=new Uint8Array(a);break;case e.RenderTargetFormat.R16G16B16A16:n=new Float32Array(a);break;default:throw new Error("getData is not supported "+this._renderTarget.colorFormat.toString()+"format")}return f.textureContext.readRenderTargetPixelData(this._renderTarget,t,s,r,i,n),n}getDataAsync(e,t,s,r,i){return f.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,e,t,s,r,i)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}zi._pool=[],zi._poolMemory=0,zi._poolTimeouts=new Map,zi.cleanupTimeout=3e4,zi.cleanupFrameInterval=360,zi._lastCleanupFrame=0,zi._clearColor=new y(0,0,0,0),zi._clear=!1;var Hi={linear:Yi,linearNone:Yi,linearIn:function(e,t,s,r){return s*e/r+t},linearInOut:function(e,t,s,r){return s*e/r+t},linearOut:function(e,t,s,r){return s*e/r+t},bounceIn:function(e,t,s,r){return s-Hi.bounceOut(r-e,0,s,r)+t},bounceInOut:function(e,t,s,r){return e<.5*r?.5*Hi.bounceIn(2*e,0,s,r)+t:.5*Hi.bounceOut(2*e-r,0,s,r)+.5*s+t},bounceOut:function(e,t,s,r){return(e/=r)<1/2.75?s*(7.5625*e*e)+t:e<2/2.75?s*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?s*(7.5625*(e-=2.25/2.75)*e+.9375)+t:s*(7.5625*(e-=2.625/2.75)*e+.984375)+t},backIn:function(e,t,s,r,i=1.70158){return s*(e/=r)*e*((i+1)*e-i)+t},backInOut:function(e,t,s,r,i=1.70158){return(e/=.5*r)<1?.5*s*(e*e*((1+(i*=1.525))*e-i))+t:s/2*((e-=2)*e*((1+(i*=1.525))*e+i)+2)+t},backOut:function(e,t,s,r,i=1.70158){return s*((e=e/r-1)*e*((i+1)*e+i)+1)+t},elasticIn:function(e,t,s,r,i=0,a=0){var n;if(0==e)return t;if(1==(e/=r))return t+s;a||(a=.3*r);!i||s>0&&i<s||s<0&&i<-s?(i=s,n=a/4):n=a/Xi*Math.asin(s/i);return-i*Math.pow(2,10*(e-=1))*Math.sin((e*r-n)*Xi/a)+t},elasticInOut:function(e,t,s,r,i=0,a=0){var n;if(0==e)return t;if(2==(e/=.5*r))return t+s;a||(a=r*(.3*1.5));!i||s>0&&i<s||s<0&&i<-s?(i=s,n=a/4):n=a/Xi*Math.asin(s/i);return e<1?i*Math.pow(2,10*(e-=1))*Math.sin((e*r-n)*Xi/a)*-.5+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-n)*Xi/a)*.5+s+t},elasticOut:function(e,t,s,r,i=0,a=0){var n;if(0==e)return t;if(1==(e/=r))return t+s;a||(a=.3*r);!i||s>0&&i<s||s<0&&i<-s?(i=s,n=a/4):n=a/Xi*Math.asin(s/i);return i*Math.pow(2,-10*e)*Math.sin((e*r-n)*Xi/a)+s+t},strongIn:function(e,t,s,r){return s*(e/=r)*e*e*e*e+t},strongInOut:function(e,t,s,r){return(e/=.5*r)<1?.5*s*e*e*e*e*e+t:.5*s*((e-=2)*e*e*e*e+2)+t},strongOut:function(e,t,s,r){return s*((e=e/r-1)*e*e*e*e+1)+t},sineInOut:function(e,t,s,r){return.5*-s*(Math.cos(Math.PI*e/r)-1)+t},sineIn:function(e,t,s,r){return-s*Math.cos(e/r*Wi)+s+t},sineOut:function(e,t,s,r){return s*Math.sin(e/r*Wi)+t},quintIn:function(e,t,s,r){return s*(e/=r)*e*e*e*e+t},quintInOut:function(e,t,s,r){return(e/=.5*r)<1?.5*s*e*e*e*e*e+t:.5*s*((e-=2)*e*e*e*e+2)+t},quintOut:function(e,t,s,r){return s*((e=e/r-1)*e*e*e*e+1)+t},quartIn:function(e,t,s,r){return s*(e/=r)*e*e*e+t},quartInOut:function(e,t,s,r){return(e/=.5*r)<1?.5*s*e*e*e*e+t:.5*-s*((e-=2)*e*e*e-2)+t},quartOut:function(e,t,s,r){return-s*((e=e/r-1)*e*e*e-1)+t},cubicIn:function(e,t,s,r){return s*(e/=r)*e*e+t},cubicInOut:function(e,t,s,r){return(e/=.5*r)<1?.5*s*e*e*e+t:.5*s*((e-=2)*e*e+2)+t},cubicOut:function(e,t,s,r){return s*((e=e/r-1)*e*e+1)+t},quadIn:function(e,t,s,r){return s*(e/=r)*e+t},quadInOut:function(e,t,s,r){return(e/=.5*r)<1?.5*s*e*e+t:.5*-s*(--e*(e-2)-1)+t},quadOut:function(e,t,s,r){return-s*(e/=r)*(e-2)+t},expoIn:function(e,t,s,r){return 0==e?t:s*Math.pow(2,10*(e/r-1))+t-.001*s},expoInOut:function(e,t,s,r){return 0==e?t:e==r?t+s:(e/=.5*r)<1?.5*s*Math.pow(2,10*(e-1))+t:.5*s*(2-Math.pow(2,-10*--e))+t},expoOut:function(e,t,s,r){return e==r?t+s:s*(1-Math.pow(2,-10*e/r))+t},circIn:function(e,t,s,r){return-s*(Math.sqrt(1-(e/=r)*e)-1)+t},circInOut:function(e,t,s,r){return(e/=.5*r)<1?.5*-s*(Math.sqrt(1-e*e)-1)+t:.5*s*(Math.sqrt(1-(e-=2)*e)+1)+t},circOut:function(e,t,s,r){return s*Math.sqrt(1-(e=e/r-1)*e)+t}};const Wi=.5*Math.PI,Xi=2*Math.PI;function Yi(e,t,s,r){return s*e/r+t}class qi{constructor(e){this._props=e,this.nums=[]}get(e){let t=this._props.find(t=>t.name==e);if(!t)throw new Error(`Property '${e}' is not in tween.`);return this.read(t.type,t.offset)}set(e,t){let s=this._props.find(t=>t.name==e);if(!s)throw new Error(`Property '${e}' is not in tween.`);this.write(s.type,s.offset,t)}getAt(e){let t=this._props[e];if(!t)throw new R(e);return this.read(t.type,t.offset)}setAt(e,t){let s=this._props[e];if(!s)throw new R(e);this.write(s.type,s.offset,t)}get count(){return this._props.length}copy(e){return this.nums.length=0,this.nums.push(...e.nums),this}read(e,t){switch(e){case 0:return this.nums[t];case 1:return!!this.nums[t];case 2:return y.hexToString(this.nums[t]);default:return e.read(this.nums,t)}}write(e,t,s){switch(e){case 0:this.nums[t]=s;break;case 1:this.nums[t]=s?1:0;break;case 2:this.nums[t]=y.stringToHex(s);break;default:t===this.nums.length?e.write(this.nums,s):(ji.length=0,e.write(ji,s),ji.forEach((e,s)=>this.nums[t+s]=e))}}}const ji=[];function Ki(e,t){t.writeTo(e,e.length)}const $i=Symbol(),Qi=new ct;ct.prototype[$i]={write:Ki,read:(e,t)=>Qi.setValue(e[t],e[t+1])};const Zi=new a;a.prototype[$i]={write:Ki,read:(e,t)=>Zi.setValue(e[t],e[t+1],e[t+2])};const Ji=new i;i.prototype[$i]={write:Ki,read:(e,t)=>Ji.setValue(e[t],e[t+1],e[t+2],e[t+3])};const ea=new y;y.prototype[$i]={write:Ki,read:(e,t)=>ea.setValue(e[t],e[t+1],e[t+2],e[t+3])};const ta=new u;u.prototype[$i]={write:(e,t)=>{e.push(t.x,t.y)},read:(e,t)=>ta.setTo(e[t],e[t+1])};class sa{static create(e){let t=sa._pool.take();return aa[ia++]=t,t.owner=e,t}static getTween(e){return na.get(e)}static isTweening(e){if(null==e)return!1;for(let t=0;t<ia;t++){let s=aa[t];if(s&&s.target==e&&!s._killed)return!0}return!1}static getTweens(e,t){if(t=t||[],null==e)return t;let s=ia;for(let r=0;r<s;r++){let s=aa[r];s&&s.target==e&&!s._killed&&t.push(s.owner)}return t}static kill(e,t){let s=na.get(e);return!(!s||s._killed)&&(s.kill(t),!0)}static killAll(e,t){if(null==e)return!1;let s=!1,r=ia;for(let i=0;i<r;i++){let r=aa[i];r&&r.target==e&&!r._killed&&(r.kill(t),s=!0)}return s}constructor(){this.props=[],this.easeArgs=[],this.interpArgs=[],this.startValue=new qi(this.props),this.endValue=new qi(this.props),this.value=new qi(this.props),this.deltaValue=new qi(this.props)}go(e,t,s){let r=oa.take();this.props.push(r),r.name=e,r.offset=this.startValue.nums.length,this._active?(r.renewFlags=0,void 0===t&&(t=this.target[e]),void 0===s&&(s=this.target[e])):r.renewFlags=void 0===t?1:void 0===s?2:0;const i=null!=t?typeof t:typeof s;let a;return"number"===i?r.type=0:"string"===i?r.type=2:"object"==i&&null!=(a=t[$i])?r.type=a:r.type=1,this.startValue.write(r.type,r.offset,void 0!==t?t:s),this.endValue.write(r.type,r.offset,void 0!==s?s:t),this}get normalizedTime(){return this._normalizedTime}get breaking(){return 1==this._ended}get remainTime(){return this.breakpoint>=0?this.delay+this.breakpoint-this._elapsedTime:this.repeat>=0?this.delay+this.duration*(this.repeat+1)-this._elapsedTime:this.delay+2*this.duration-this._elapsedTime}activate(){this._active=!0,this._startFrame=l.timer.currFrame;for(let e of this.props)1==e.renewFlags?this.startValue.write(e.type,e.offset,this.target[e.name]):2==e.renewFlags&&this.endValue.write(e.type,e.offset,this.target[e.name])}seek(e){if(!this._killed){if(this._elapsedTime=e,this._elapsedTime<this.delay){if(!this._started)return;this._elapsedTime=this.delay}this.update2()}}kill(e){this._killed||(e?(0==this._ended&&(this._elapsedTime=0,this._elapsedTime=this.remainTime,this.update2()),this.callCompleteCallback()):this.onCompleteResolvers&&this.onCompleteResolvers.forEach(e=>e()),this._killed=!0)}init(){++ra<1&&(ra=1),this.id=ra,na.set(this.id,this),this.name=null,this.delay=0,this.duration=0,this.breakpoint=-1,this.startValue.nums.length=0,this.endValue.nums.length=0,this.value.nums.length=0,this.ease=Hi.linear,this.easeArgs.length=0,this.timeScale=1,this.snapping=!1,this.repeat=0,this.yoyo=!1,this.interp=null,this.interpArgs.length=0,this._started=!1,this.paused=!1,this._killed=!1,this._startFrame=l.timer.currFrame,this._elapsedTime=0,this._normalizedTime=0,this._ended=0,this._active=!1}reset(){this.id=-1,this.owner=null,this.target=null,this.lifecycleOwner=null,this.userData=null,oa.recover(this.props),this.onStart=this.onUpdate=this.onComplete=this.onCompleteResolvers=null,this.onStartCaller=this.onUpdateCaller=this.onCompleteCaller=null}update(e){if(1!=this.timeScale&&(e*=this.timeScale),0!=e){if(0!=this._ended)return this.callCompleteCallback(),void(this._killed=!0);this._elapsedTime+=e,this.update2(),0!=this._ended&&(this._killed||(this.callCompleteCallback(),this._killed=!0))}}update2(){if(this._ended=0,!this._started){if(this._elapsedTime<this.delay)return;if(this._started=!0,this.value.copy(this.startValue),this.deltaValue.nums.length=this.startValue.nums.length,this.deltaValue.nums.fill(0),this.callStartCallback(),this._killed)return}let e=!1,t=this.duration,s=this._elapsedTime-this.delay;if(this.breakpoint>=0&&s>=this.breakpoint&&(s=this.breakpoint,this._ended=2),0!=this.repeat){let r=Math.floor(s/t);s-=t*r,this.yoyo&&(e=r%2==1),this.repeat>0&&this.repeat-r<0&&(this.yoyo&&(e=this.repeat%2==1),s=t,this._ended=1)}else s>=t&&(s=t,this._ended=1);let r=t>0?this.ease(e?t-s:s,0,1,t,...this.easeArgs):1;this._normalizedTime=r;let i=this.startValue.nums,a=this.endValue.nums,n=this.value.nums,o=this.deltaValue.nums;if(n.fill(0),o.fill(0),this.interp){this.interp(r,i,a,n,...this.interpArgs);for(let e=0,t=i.length;e<t;e++){let t=n[e];this.snapping&&(t=Math.round(t)),o[e]=t-n[e]}}else for(let e=0,t=i.length;e<t;e++){let t=i[e],s=t+(a[e]-t)*r;this.snapping&&(s=Math.round(s)),o[e]=s-n[e],n[e]=s}if(null!=this.target)for(let e of this.props)if(e.name){let t=1===e.type?1===this._ended?this.endValue.read(e.type,e.offset):this.startValue.read(e.type,e.offset):this.value.read(e.type,e.offset);if((0===e.type||1===e.type||2===e.type)&&this.target[e.name]===t)continue;this.target[e.name]=t}this.callUpdateCallback()}callStartCallback(){if(this.onStart)try{this.onStart.call(this.onStartCaller,this)}catch(e){console.error("error in start callback > ",e)}}callUpdateCallback(){if(this.onUpdate)try{this.onUpdate.call(this.onUpdateCaller,this)}catch(e){console.error("error in update callback > ",e)}}callCompleteCallback(){if(this.onComplete)try{this.onComplete.call(this.onCompleteCaller,this)}catch(e){console.error("error in complete callback > ",e)}this.onCompleteResolvers&&this.onCompleteResolvers.forEach(e=>e())}static _runAll(){var e;let t=ia;if(0==t)return;let s=l.timer.currFrame,r=l.timer.delta,i=l.timer.unscaledDelta,a=-1;for(let n=0;n<t;n++){let t=aa[n];null==t?-1==a&&(a=n):t._killed?(na.delete(t.id),null===(e=t.owner)||void 0===e||e._check(),sa._pool.recover(t),aa[n]=null,-1==a&&(a=n)):(t.target&&t.target.destroyed||t.lifecycleOwner&&t.lifecycleOwner.destroyed?t._killed=!0:!t.paused&&t._active&&t.update(t._startFrame==s?0:t.ignoreEngineTimeScale?i:r),-1!=a&&(aa[a]=t,aa[n]=null,a++))}if(a>=0){if(ia!=t){let e=t;t=ia-t;for(let s=0;s<t;s++)aa[a++]=aa[e],aa[e]=null,e++}ia=a}}static _getMap(){return na}}sa._pool=h.createPool(sa,e=>e.init(),e=>e.reset());var ra=0,ia=0;const aa=[],na=new Map,oa=h.createPool(Object);class la{static create(e,t){let s=la._pool.take();return s._target=e,s._lo=t,s}static isTweening(e){return sa.isTweening(e)}static getTween(e){return ha.length=0,this.getTweens(e,ha),ha.length>0?ha[0]:null}static getTweens(e,t){return sa.getTweens(e,t)}static kill(e){e&&e.kill()}static clear(e){e&&e.kill()}static killAll(e,t){return sa.killAll(e,t)}static clearAll(e){la.killAll(e)}static to(e,t,s,r,i,a,n){n&&la.killAll(e);let o=la.create(e);return la.tweenLegacy(o.cur(!0),t,s,r,i,a,!0),o}static from(e,t,s,r,i,a,n){n&&la.killAll(e);let o=la.create(e);return la.tweenLegacy(o.cur(!0),t,s,r,i,a,!1),o}static tweenLegacy(e,t,s,r,i,a,n){e.duration=s;for(let s in t){if("ease"==s||"easeArgs"==s||"update"==s||"complete"==s)continue;let r=t[s];s in e.target&&(n?e.go(s,e.target[s],r):e.go(s,r,e.target[s]))}t.ease&&(e.ease=t.ease,t.easeArgs&&e.easeArgs.push(...t.easeArgs)),t.update&&(e.onUpdate=t.update.runWith,e.onUpdateCaller=t.update),t.complete&&(e.onComplete=t.complete.runWith,e.onCompleteCaller=t.complete),null!=r&&(e.ease=r),null!=a&&(e.delay=a),i&&(e.onComplete=i.runWith,e.onCompleteCaller=i)}to(e,t){return this.cur(!0).go(e,void 0,t),this}from(e,t){return this.cur(!0).go(e,t,void 0),this}go(e,t,s){return this.cur(!0).go(e,t,s),this}chain(e,t){return void 0!==e&&(this._target=e,this._lo=t),0==this._queue.length||(null!=this._par&&(this._queue.push(-2),this._par=null),this._cur=sa.create(this),this._cur.target=this._target,this._cur.lifecycleOwner=this._lo,this._queue.push(this._cur.id)),this}parallel(e,t){return 0==this._queue.length?(void 0!==e&&(this._target=e,this._lo=t),this):(null==this._par&&(this._queue.push(-1),this._par=this._cur),this._cur=sa.create(this),void 0!==e?(this._cur.target=e,this._cur.lifecycleOwner=t):(this._cur.target=this._par.target,this._cur.lifecycleOwner=this._par.lifecycleOwner),this._cur.duration=this._par.duration,this._par._active&&this._cur.activate(),this._queue.push(this._cur.id),this)}delay(e){return this.cur(!1).delay=e,this}duration(e){return this.cur(!1).duration=e,this}breakpoint(e){return this.cur(!1).breakpoint=e,this}ease(e,...t){let s=this.cur(!1);return s.ease="string"==typeof e?Hi[e]:e,s.easeArgs.length=0,t&&s.easeArgs.push(...t),this}interp(e,...t){let s=this.cur(!1);return s.interp=e,s.interpArgs.length=0,t&&s.interpArgs.push(...t),this}repeat(e,t){let s=this.cur(!1);return s.repeat=e,s.yoyo=t,this}timeScale(e){return this.cur(!1).timeScale=e,this}ignoreEngineTimeScale(e){return this.cur(!1).ignoreEngineTimeScale=e,this}snapping(e){return this.cur(!1).snapping=e,this}userData(e){return this.cur(!1).userData=e,this}name(e){return this.cur(!1).name=e,this}onUpdate(e,t){let s=this.cur(!1);return s.onUpdate=e,s.onUpdateCaller=t,this}onStart(e,t){let s=this.cur(!1);return s.onStart=e,s.onStartCaller=t,this}then(e,t){let s=this.cur(!1);return s.onComplete=e,s.onCompleteCaller=t,this}waitForCompletion(){return new Promise(e=>{let t=this.cur(!1);t.onCompleteResolvers||(t.onCompleteResolvers=[]),t.onCompleteResolvers.push(e)})}seek(e){return this.cur(!1).seek(e),this}pause(){return da(this._queue,e=>e.paused=!0),this}resume(){return da(this._queue,e=>e.paused=!1),this}findTweener(e){for(let t=0,s=this._queue.length;t<s;t++){if(t<0)continue;let s=sa.getTween(this._queue[t]);if(s&&s.name==e)return s}return null}kill(e){if(0==this._queue.length)return;let t;for(let e of this._queue)if(e>0){let s=sa.getTween(e);s&&(s._killed||(t||(t=[]),t.push(s)),s.owner=null)}this._head=-1,this._cur=null,this._queue.length=0,null!=t&&t.forEach(t=>t.kill(e))}get completed(){return this._head>=0&&0===this._queue.length}complete(){this.kill(!0)}clear(){this.kill(!1)}recover(){this.kill(!1),la._pool.recover(this)}constructor(){this._queue=[],this._head=-1}cur(e){if(!this._cur){if(-1!=this._head){if(!e)throw new Error("Tween has been started. clear first!");this.kill(!1)}this._cur=sa.create(this),this._cur.target=this._target,this._cur.lifecycleOwner=this._lo,this._cur.activate(),this._queue.push(this._cur.id)}return this._cur}_check(){this._cur&&(this._head=0,this._cur=null);let e=this._head,t=this._queue.length;for(;e<t;e++){let s=this._queue[e];if(s<0)continue;let r=sa.getTween(s);if(r&&!r._killed){if(r._active)break;if(r.activate(),-1==this._queue[e+1])for(let s=e+2;s<t;s++){let t=this._queue[s];if(t<0)break;let r=sa.getTween(t);r&&!r._killed?r.activate():this._queue[e]=-3}break}this._queue[e]=-3}this._head=e,e>=t&&(this._queue.length=0)}static shake(e,t,s,r,i){if(1==e)r.length=0,r.push(...t);else{let s=i*(1-e)*(Math.random()>.5?1:-1);for(let e=0;e<t.length;e++)r[e]=t[e]+s}}static seperateChannel(e,t,s,r,i){i=i||3;for(let a=0;a<t.length;a++)r[a]=ua(e,t[a],s[a],i)}static useCurvePath(e,t,s,r,i){let a=i.getPointAt(e);r[0]=a.x,r.length>1&&(r[1]=a.y),r.length>2&&(r[2]=a.z)}}la._pool=h.createPool(la);const ha=[];function da(e,t){for(let s of e)if(s>0){let e=sa.getTween(s);e&&!e._killed&&t(e)}}function ua(e,t,s,r){let i=0;for(let a=0;a<r;a++){let r=8*a,n=t>>r&255;i+=n+((s>>r&255)-n)*e<<r}return i}class ca{constructor(e){this.ratio=.92,this.maxOffset=60,this.hasInertia=!1,this.elasticDistance=0,this.elasticBackTime=300,this.autoStart=!1,this._testing=!1,this._dragging=!1,this.target=e,this.area=new te,this._points=[],this.target.on(c.MOUSE_DOWN,this,this.onMouseDown)}get dragging(){return this._dragging}start(e){this.reset(),this._touchId=l.InputManager.lastTouchId,this._dragging=!0,this._testing=!1,this._elasticRateX=this._elasticRateY=1;let t=this.target._parent.getMousePoint();this._points.length=0,this._points.push(t.x,t.y,performance.now()),this._data=e,l.stage.on(c.MOUSE_MOVE,this,this.onMouseMove),l.stage.on(c.MOUSE_UP,this,this.onMouseUp)}reset(){this._dragging=!1,this._testing=!1,this._data=null,l.systemTimer.clear(this,this.tweenMove),l.stage.off(c.MOUSE_MOVE,this,this.onMouseMove),l.stage.off(c.MOUSE_UP,this,this.onMouseUp),null!=this._tween&&(this._tween.kill(),this._tween=null)}stop(){this._dragging?(this._dragging=!1,this._testing?this.reset():(this.moveTarget(0,0),this.clear(!0))):this.reset()}onMouseDown(){!this.autoStart||this._dragging||this._testing||(this.start(),this._testing=!0)}onMouseMove(e){if(!this._testing&&!this._dragging)return;if(this._touchId!=e.touchId)return;let t=this.target._parent.getMousePoint(),s=t.x,r=t.y,i=s-this._points[this._points.length-3],a=r-this._points[this._points.length-2];if(this._testing){if(Math.abs(i*l.stage._canvasTransform.getScaleX())<1&&Math.abs(a*l.stage._canvasTransform.getScaleY())<1)return;if(this._dragging=!0,this.target.event(c.DRAG_START,this._data),!this._dragging)return;this._testing=!1}let n=performance.now();for(;this._points.length>0&&this._points[2]<n-100;)this._points.splice(0,3);this._points.push(s,r,n),this.moveTarget(i*this._elasticRateX,a*this._elasticRateY),this.target.event(c.DRAG_MOVE,this._data)}onMouseUp(e){if(this._dragging){if(this._touchId==e.touchId)if(this.hasInertia){let e=ca.computeVelocity(this._points,this.maxOffset);this._points[0]=e.x,this._points[1]=e.y,this._dragging=!1,l.systemTimer.frameLoop(1,this,this.tweenMove)}else!this.area.isEmpty()&&this.elasticDistance>0?this.checkElastic():this.clear()}else this.reset()}moveTarget(e,t){let s=this.target._x+e,r=this.target._y+t;if(this.area.isEmpty())this.target.pos(s,r);else if(this.elasticDistance>0&&this._dragging){this.target.pos(s,r);let e=this.checkArea();this._elasticRateX=Math.max(0,1-Math.abs(e.x)/this.elasticDistance),this._elasticRateY=Math.max(0,1-Math.abs(e.y)/this.elasticDistance)}else{let i=this.checkArea(e,t);this.target.pos(s+i.x,r+i.y)}}checkArea(e=0,t=0){let s,r,i=te.TEMP.setTo(this.target.x+e-this.target.pivotX,this.target.y+t-this.target.pivotY,this.target.width,this.target.height);return s=i.x<this.area.x?this.area.x-i.x:i.right>this.area.right?this.area.right-i.right:0,r=i.y<this.area.y?this.area.y-i.y:i.bottom>this.area.bottom?this.area.bottom-i.bottom:0,_a.setTo(s,r)}checkElastic(){let e=this.checkArea();0!=e.x||0!=e.y?(this._tween=la.create(this.target).duration(this.elasticBackTime).ease(Hi.sineOut).then(()=>this.clear()),0!=e.x&&this._tween.to("x",this.target.x+e.x),0!=e.y&&this._tween.to("y",this.target.y+e.y)):this.clear()}tweenMove(){let e=Math.pow(this.ratio,l.timer.delta/16.6),t=this.ratio*(1-e)/(1-this.ratio),s=this._points[0]*t*this._elasticRateX,r=this._points[1]*t*this._elasticRateY;this._points[0]=s,this._points[1]=r,s=s<0?Math.ceil(s):Math.floor(s),r=r<0?Math.ceil(r):Math.floor(r),Math.abs(s)<1&&Math.abs(r)<1||this._elasticRateX<.5||this._elasticRateY<.5?(l.systemTimer.clear(this,this.tweenMove),!this.area.isEmpty()&&this.elasticDistance>0?this.checkElastic():this.clear()):(this.moveTarget(s,r),this.target.event(c.DRAG_MOVE,this._data))}clear(e){let t=this._data;this.reset(),this.target.event(c.DRAG_END,[t,e])}static computeVelocity(e,t){let s=performance.now();for(;e.length>0&&e[2]<s-100;)e.splice(0,3);let r=e.length/3,i=0,a=0,n=0;for(let t=1;t<r;t++)i+=e[3*t]-e[3*t-3],a+=e[3*t+1]-e[3*t-2],n+=e[3*t+2]-e[3*t-1];return 0!=n?(n/=16.6,i/=n,a/=n):i=a=0,null!=t&&(Math.abs(i)>t&&(i=i>0?t:-t),Math.abs(a)>t&&(a=a>0?t:-t)),_a.setTo(i,a),_a}}const _a=new u;class pa{static getGlobalRecByPoints(e,t,s,r,i,a){let n,o;n=u.create().setTo(t,s),n=e.localToGlobal(n),o=u.create().setTo(r,i),o=e.localToGlobal(o);let l=te._getWrapRec([n.x,n.y,o.x,o.y],a);return n.recover(),o.recover(),l}static getGlobalPosAndScale(e){let t=te.create();pa.getGlobalRecByPoints(e,0,0,1,1,t);let s={x:t.x,y:t.y,scaleX:t.width,scaleY:t.height};return t.recover(),s}static getTransformRelativeToWindow(e,t,s){let r=l.stage,i=pa.getGlobalPosAndScale(e),a=Ce.create();r._canvasTransform.copyTo(a);let n=a.tx,o=a.ty;a.rotate(-Math.PI/180*r.canvasDegree),a.scale(r.clientScaleX,r.clientScaleY);let h,d,u,c,_=r.canvasDegree%180!=0;return _?(h=s+i.y,d=t+i.x,h*=a.d,d*=a.a,90==r.canvasDegree?(h=n-h,d+=o):(h+=n,d=o-d)):(h=t+i.x,d=s+i.y,h*=a.a,d*=a.d,h+=n,d+=o),_?(u=a.d*i.scaleY,c=a.a*i.scaleX):(u=a.a*i.scaleX,c=a.d*i.scaleY),a.recover(),i.x=Math.round(h),i.y=Math.round(d),i.scaleX=Math.round(1e5*u)/1e5,i.scaleY=Math.round(1e5*c)/1e5,i}static fitDOMElementInArea(e,t,s,r,i,a){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,W.browser.setStyleTransformOrigin(e.style,"left top"),e.style.position="absolute");let n=pa.getTransformRelativeToWindow(t,s,r);W.browser.setStyleTransform(e.style,"scale("+n.scaleX+","+n.scaleY+") rotate("+l.stage.canvasDegree+"deg)"),e.style.width=i+"px",e.style.height=a+"px",e.style.left=n.x+"px",e.style.top=n.y+"px"}static localToGlobalRect(e,t,s){s=s||te.create();let r=e.localToGlobal(u.TEMP.setTo(t.x,t.y)),i=r.x,a=r.y;return e.localToGlobal(r.setTo(t.right,t.bottom)),s.setTo(i,a,i+r.x,a+r.y)}static globalToLocalRect(e,t,s){s=s||te.create();let r=e.globalToLocal(u.TEMP.setTo(t.x,t.y)),i=r.x,a=r.y;return e.globalToLocal(r.setTo(t.right,t.bottom)),s.setTo(i,a,i+r.x,a+r.y)}static transformRect(e,t,s,r){if(s=s||l.stage,ma.length=0,t.getBoundPoints(ma),s===e._parent)for(let t=0,s=ma.length;t<s;t+=2){let s=e.toParentPoint(u.TEMP.setTo(ma[t],ma[t+1]));ma[t]=s.x,ma[t+1]=s.y}else for(let t=0,r=ma.length;t<r;t+=2){let r=e.localToGlobal(u.TEMP.setTo(ma[t],ma[t+1]));s.globalToLocal(r),ma[t]=r.x,ma[t+1]=r.y}return te._getWrapRec(ma,r)}static getRect(e,t,s){return s=s||te.create(),null==t||t?s.setTo(0,0,e.width,e.height):e.getSelfBounds(s),s.x-=e.pivotX,s.y-=e.pivotY,e.scrollRect&&(s.x-=e.scrollRect.x,s.y-=e.scrollRect.y),s.x=Math.floor(s.x),s.y=Math.floor(s.y),s.width=Math.floor(s.width),s.height=Math.floor(s.height),s.width<0&&(s.width=0),s.height<0&&(s.height=0),s}static setRect(e,t){e.size(t.width,t.height),e.pos(t.x+e.pivotX,t.y+e.pivotY)}static getChildrenBounds(e,t,s,r,i){(i=i||new te).setTo(0,0,0,0);let a=t?e._children:e._$children;for(let e of a){if(s&&!e._struct.enabled)continue;let a=e.width,n=e.height;if(r||(a*=Math.abs(e._scaleX),n*=Math.abs(e._scaleY)),i.union(ga.setTo(e._x-a*e._anchorX,e._y-n*e._anchorY,a,n),i),t&&e._children.length>0){let a=pa.getChildrenBounds(e,t,s,r);a.x+=e._x,a.y+=e._y,i.union(a,i)}}return i}}const ga=new te,ma=[];class fa{get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}constructor(){var e;this._hideFlags=0,this._status=0,this._enabled=!0,this._id=ya++,this._singleton=null===(e=Object.getPrototypeOf(this)._$singleton)||void 0===e||e,this._initialize()}_initialize(){this._extra={}}hasHideFlag(e){return 0!=(this._hideFlags&e)}get id(){return this._id}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this.owner&&this._setActive(e&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(e){if(0!=this._status)throw new Error("reuse a destroyed component");this.owner=e,this._isScript()&&e._setBit(we.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(e,t=null){}_parseInteractive(e=null,t=null){}_cloneTo(e){}_setActive(e){var t;e?(0==this._status&&(this._status=1,(p.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,(p.isPlaying||this.runInEditor)&&(this._driver=(null===(t=this.owner._scene)||void 0===t?void 0:t._componentDriver)||l.stage._componentDriver,this._driver.add(this),p.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()))):this._enableState&&(this._enableState=!1,(p.isPlaying||this.runInEditor)&&(this._driver&&this._driver.remove(this),l.stage.offAllCaller(this),this._onDisable()))}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(e){var t;e?(p.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),null===(t=this.owner)||void 0===t||t.offAllCaller(this),this._resetComp(),h.recoverByClass(this))):(this._setActive(!1),this._status=4,(p.isPlaying||this.runInEditor)&&(this._driver||l.stage._componentDriver)._toDestroys.add(this),this._driver=null)}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}var Ta,ya=0;e.Render2DOrderMode=void 0,(Ta=e.Render2DOrderMode||(e.Render2DOrderMode={}))[Ta.elementIndex=0]="elementIndex",Ta[Ta.ysort=1]="ysort";class xa extends fa{static initBaseRender2DCommandEncoder(){xa.BASERENDER2DCOLOR=gr.propertyNameToID("u_baseRenderColor"),xa.BASERENDER2DTEXTURE=gr.propertyNameToID("u_baseRender2DTexture"),xa.TILINGOFFSET=gr.propertyNameToID("u_tilingOffset"),xa.NORMAL2DTEXTURE=gr.propertyNameToID("u_normal2DTexture"),xa.NORMAL2DSTRENGTH=gr.propertyNameToID("u_normal2DStrength"),xa.SHADERDEFINE_BASERENDER2D=gr.getDefineByName("BASERENDER2D"),xa.SHADERDEFINE_LIGHT2D_ENABLE=gr.getDefineByName("LIGHT2D_ENABLE"),xa.SHADERDEFINE_LIGHT2D_EMPTY=gr.getDefineByName("LIGHT2D_EMPTY"),xa.SHADERDEFINE_LIGHT2D_ADDMODE=gr.getDefineByName("LIGHT2D_SCENEMODE_ADD"),xa.SHADERDEFINE_LIGHT2D_SUBMODE=gr.getDefineByName("LIGHT2D_SCENEMODE_SUB"),xa.SHADERDEFINE_LIGHT2D_NORMAL_PARAM=gr.getDefineByName("LIGHT2D_NORMAL_PARAM");const t=f.renderDeviceFactory.createGlobalUniformMap("BaseRender2D");t.addShaderUniform(mr.UNIFORM_NMATRIX_0,"u_NMatrix_0",e.ShaderDataType.Vector3),t.addShaderUniform(mr.UNIFORM_NMATRIX_1,"u_NMatrix_1",e.ShaderDataType.Vector3),t.addShaderUniform(xa.BASERENDER2DCOLOR,"u_baseRenderColor",e.ShaderDataType.Color),t.addShaderUniform(xa.BASERENDER2DTEXTURE,"u_baseRender2DTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(xa.TILINGOFFSET,"u_tilingOffset",e.ShaderDataType.Vector4),t.addShaderUniform(xa.NORMAL2DTEXTURE,"u_normal2DTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(xa.NORMAL2DSTRENGTH,"u_normal2DStrength",e.ShaderDataType.Float),t.addShaderUniform(mr.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(mr.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector4)}static _setRenderElement2DMaterial(e,t){e.subShader=t._shader.getSubShaderAt(0),t._setOwner2DElement(e),e.materialShaderData=t._shaderValues}get renderLayer(){return this._renderLayer}set renderLayer(e){this._renderLayer=e}get rect(){return this._boundsChange&&(this._boundsChange=!1),this._rect}get boundsChange(){return this._boundsChange}set boundsChange(e){this._boundsChange=e}_getcommonUniformMap(){return["BaseRender2D"]}_transformChange(){this.boundsChange=!0}_changeMaterialReference(e,t){e&&e._removeReference(),t&&t._addReference()}constructor(){super(),this._renderType=e.BaseRender2DType.baseRenderNode,this._renderUpdateMask=0,this._layer=0,this._rtsize=new ct,this._lightReceive=!1,this._lightUpdateMark=0,this._lightRecord=!1,this._renderLayer=1,this._rect=new i,this._boundsChange=!1,this._renderid=xa._uniqueIDCounter++,this._renderType=e.BaseRender2DType.baseRenderNode,this._ordingMode=e.Render2DOrderMode.elementIndex,this._renderHandle=this._createRenderHandle()}_onAdded(){this.owner._initShaderData(),this.owner.renderNode2D=this,this._struct=this.owner._struct,this._spriteShaderData=this._struct.spriteShaderData,this.owner._struct.renderDataHandler=this._renderHandle,this.owner._struct.renderElements=this._renderElements,this.owner._struct.renderType=this._renderType,this.owner._updateStruct(),this._initDefaultRenderData&&this._initDefaultRenderData()}_onEnable(){this.owner.renderNode2D=this,super._onEnable(),this.owner.globalTrans._spTransChanged(e.TransformKind.TRS),this._lightReceive&&this._addRenderToLightManager()}_onDisable(){this.owner.renderNode2D=null,this._lightReceive&&this._removeRenderFromLightManager(),super._onDisable()}_onDestroy(){for(var e=0,t=this._materials.length;e<t;e++){let t=this._materials[e];t&&!t.destroyed&&t._removeReference()}this._renderHandle.destroy()}_getRenderHandle(){return this._renderHandle}_createRenderHandle(){return f.render2DRenderPassFactory.create2DBaseRenderDataHandle()}_isMaterialVaild(e){return!0}get layer(){return this._layer}set layer(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._removeRenderFromLightManager(),this._layer=e,this._addRenderToLightManager(),this._resetUpdateMark()}}set lightReceive(e){e!==this._lightReceive&&(this._lightReceive=e,e?this._addRenderToLightManager():this._removeRenderFromLightManager(),this._renderHandle.lightReceive=e,this._resetUpdateMark())}get lightReceive(){return this._lightReceive}_resetUpdateMark(){this._lightUpdateMark=0}_updateLight(){if(!this.lightReceive||!this.owner.scene||!this.owner.scene._light2DManager)return;const e=this.owner.scene._light2DManager,t=e._getLayerUpdateMark(this.layer);this._lightUpdateMark!==t&&(this._lightUpdateMark=t,e._updateShaderDataByLayer(this.layer,this.owner._struct.spriteShaderData))}_addRenderToLightManager(){if(this.owner.scene){let e=this.owner.scene._light2DManager;e&&!this._lightRecord&&(e.addRender(this),this._lightRecord=!0)}}_removeRenderFromLightManager(){if(this.owner.scene){const e=this.owner.scene._light2DManager;e&&this._lightRecord&&(e.removeRender(this),this._lightRecord=!1)}}get sharedMaterial(){return this._materials[0]}set sharedMaterial(e){if(e&&!this._isMaterialVaild(e))return;const t=this._materials[0];t!==e&&(this._materials[0]=e,this._changeMaterialReference(t,e),this._renderElements[0]&&xa._setRenderElement2DMaterial(this._renderElements[0],e))}_getRenderElements(){return this._renderElements}getRenderID(){return this._renderid}clear(){this._renderElements.length=0}}xa._uniqueIDCounter=0;class Sa{constructor(e){this._flags=0,this._x=0,this._y=0,this._rot=0,this._scaleX=1,this._scaleY=1,this._modifiedFrame=0,this._sp=e,this.cache=!0,this._notifyRenderSpriteTransChange()}get cache(){return this._cache}set cache(t){t&&this._setFlag(e.TransformKind.Matrix|e.TransformKind.TRS,!0),this._cache=t}getMatrix(){if(null==this._matrix&&(this._matrix=new Ce),this._cache&&!this._getFlag(e.TransformKind.Matrix))return this._matrix;let t=this._sp;return this._matrix.setMatrix(t._x,t._y,t._scaleX,t._scaleY,t._rotation,t._skewX,t._skewY,t._pivotX,t._pivotY),t._parent?(Ce.mul(this._matrix,t._parent.globalTrans.getMatrix(),this._matrix),this._setFlag(e.TransformKind.Matrix,!1)):t._maskParent&&(Ce.mul(this._matrix,t._maskParent.globalTrans.getMatrix(),this._matrix),this._setFlag(e.TransformKind.Matrix,!1)),this._matrix}getMatrixInv(e){return this.getMatrix().copyTo(e),e.invert(),e}get x(){return this.getPos(Ea).x}get y(){return this.getPos(Ea).y}getSceneMatrix(e){return this._sp.scene?(this._sp.scene.globalTrans.getMatrixInv(va).copyTo(e),Ce.mul(this.getMatrix(),e,e),e):this.getMatrix()}getScenePos(e){return this._sp.scene?this._sp.scene.globalTrans.getMatrixInv(va).transformPoint(this.getPos(e)):this.getPos(e)}getSceneScale(e){if(e.x=this.scaleX,e.y=this.scaleY,this._sp.scene){const t=this._sp.scene.globalTrans.getMatrix();e.x/=t.getScaleX(),e.y/=t.getScaleY()}return e}getSceneRotation(){let e=this.rotation;return this._sp.scene&&(e-=this._sp.scene.globalTrans.rotation),e}getPos(e){return this._cache?(this._cachePos(),e.x=this._x,e.y=this._y):this._sp.localToGlobal(e.setTo(0,0),!1,null),e}setPos(t,s){let r=this._sp;if(this._cache){if(this._cachePos(),t==this._x&&s==this._y)return;let i=r._parent.globalTrans.getMatrix().invertTransformPoint(Ea.setTo(t,s));this._cache=!1,r.pos(i.x,i.y),this._cache=!0,this._x=t,this._y=s,this._setFlag(e.TransformKind.Pos,!1),this._setFlag(e.TransformKind.Matrix,!0),this._syncFlag(e.TransformKind.Pos|e.TransformKind.Matrix,!0)}else{Ea.setTo(t,s);let e=r.globalToLocal(Ea,!1,null);e=r.toParentPoint(e),r.pos(e.x,e.y)}}get rotation(){let t=this._sp;if(this._cache)return this._getFlag(e.TransformKind.Rotation)&&(this._setFlag(e.TransformKind.Rotation,!1),t._parent!=t._scene&&t._parent?this._rot=t._rotation+t._parent.globalTrans.rotation:this._rot=t._rotation),this._rot;{let e=0,s=t;for(;s&&s!==t._scene;)e+=s._rotation,s=s._parent;return e}}set rotation(t){if(t==this.rotation)return;let s=this._sp;s._parent!=s._scene&&s._parent?s.rotation=t-s._parent.globalTrans.rotation:s.rotation=t,this._cache&&(this._rot=t,this._setFlag(e.TransformKind.Rotation,!1),this._setFlag(e.TransformKind.Matrix,!0),this._syncFlag(e.TransformKind.Matrix,!0))}get scaleX(){if(this._cache)return this._cacheScale(),this._scaleX;{let e=1,t=this._sp;for(;t&&t!==l.stage;)e*=t._scaleX,t=t._parent;return e}}get scaleY(){if(this._cache)return this._cacheScale(),this._scaleY;{let e=1,t=this._sp;for(;t&&t!==l.stage;)e*=t._scaleY,t=t._parent;return e}}_cachePos(){if(this._getFlag(e.TransformKind.Matrix|e.TransformKind.Pos)){this._setFlag(e.TransformKind.Pos,!1);let t=this.getMatrix().transformPoint(Ea.setTo(this._sp.pivotX,this._sp.pivotY));this._x=t.x,this._y=t.y}}_cacheScale(){if(this._getFlag(e.TransformKind.Matrix|e.TransformKind.Scale)){this._setFlag(e.TransformKind.Scale,!1);let t=this.getMatrix();this._scaleX=t.getScaleX(),this._scaleY=t.getScaleY()}}_getFlag(e){return 0!=(this._flags&e)}_setFlag(e,t,s=!0){t?this._flags|=e:this._flags&=~e,t&&(this._sp.event(Sa.CHANGED,e),s&&this._notifyRenderSpriteTransChange())}_notifyRenderSpriteTransChange(){this._sp._renderType&$e.UPDATETRANS&&(l.stage._tranMatrixUpdateList.add(this._sp),this._modifiedFrame=Vi.loopCount)}_syncFlag(e,t){if(this._cache)for(let s of this._sp._children){let r=s.globalTrans;r&&(r._setFlag(e,t),r._syncFlag(e,t))}}_spTransChanged(t){this._cache&&this._setFlag(t|e.TransformKind.Matrix,!0),this._syncFlag(t|e.TransformKind.Matrix,!0)}localToGlobal(e,t){return this._cache?this.getMatrix().transformPoint(Ea.setTo(this._sp.pivotX+e,this._sp.pivotY+t)):this._sp.localToGlobal(Ea.setTo(e,t))}globalToLocal(e,t){if(this._cache){let s=this.getMatrix().invertTransformPoint(Ea.setTo(e,t));return s.x-=this._sp.pivotX,s.y-=this._sp.pivotY,s}return this._sp.globalToLocal(Ea.setTo(e,t))}}Sa.CHANGED="globalTransChanged";const Ea=new u,va=new Ce;class Da{constructor(){this.elements=[],this.length=0}add(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length||(this.elements[this.length++]=e)}addList(e){let t=this.length,s=e.length;this.length=t+s;let r=this.elements,i=e.elements;r.length<this.length&&(r.length=this.length);for(let e=0;e<s;e++)r[t+e]=i[e]}indexof(e){let t=this.elements.indexOf(e);return-1!=t&&t<this.length?t:-1}remove(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length&&(this.elements[t]=this.elements[this.length-1],this.elements[this.length-1]=null,this.length--)}clear(){this.elements.length=0,this.length=0}clean(){this.elements.length=this.length}cloneTo(e){e.length=this.length,e.elements=this.elements.slice()}destroy(){this.elements=null}}class wa extends Da{add(e){this.elements[this.length++]=e}}class ba{destroy(){}static __init__(){gr.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value){return pow((value+0.055)/1.055,vec3(2.4));}vec4 gammaToLinear(in vec4 value){return vec4(gammaToLinear(value.rgb),value.a);}vec3 linearToGamma(in vec3 value){return vec3(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055),value.rgb*12.92,vec3(lessThanEqual(value.rgb,vec3(0.0031308)))));}vec4 linearToGamma(in vec4 value){return vec4(linearToGamma(value.rgb),value.a);}vec4 transspaceColor(vec4 color){\n#ifndef GAMMATEXTURE\n#ifdef GAMMASPACE\ncolor.xyz=linearToGamma(color.xyz);\n#endif\n#else\n#ifndef GAMMASPACE\ncolor.xyz=gammaToLinear(color.xyz);\n#endif\n#endif\nreturn color;}varying vec2 v_cliped;\n#ifdef TEXTUREVS\nvarying vec4 v_texcoordAlpha;varying vec4 v_color;varying float v_useTex;varying float v_useClip;varying vec4 v_customs;uniform sampler2D u_spriteTexture;\n#ifdef FILLTEXTURE\nuniform vec4 u_TexRange;\n#endif\nvec4 getSpriteTextureColor(){\n#ifdef FILLTEXTURE\nvec4 color=texture2D(u_spriteTexture,fract(v_texcoordAlpha.xy)*u_TexRange.zw+u_TexRange.xy);\n#else\nvec4 color=texture2D(u_spriteTexture,v_texcoordAlpha.xy);\n#endif\nreturn transspaceColor(color);}void setglColor(in vec4 color){float useTex=step(1.0,v_useTex);color=mix(vec4(1.,1.,1.,1.),color,useTex);vec4 clampedRange=v_customs;clampedRange.xy=max(v_customs.xy,vec2(0.0,0.0));clampedRange.zw=min(v_customs.xy+v_customs.zw,vec2(1.0,1.0));vec2 inRange=step(clampedRange.xy,v_texcoordAlpha.xy)*step(v_texcoordAlpha.xy,clampedRange.zw);float useTexture=inRange.x*inRange.y;float useClip=step(1.0,v_useClip);float clipAlpha=mix(1.0,useTexture,useClip);color*=clipAlpha;color.a*=v_color.w;vec4 transColor=v_color;\n#ifndef GAMMASPACE\ntransColor=gammaToLinear(v_color);\n#endif\ncolor.rgb*=transColor.rgb;gl_FragColor=color;}\n#endif\n#ifdef BASERENDER2D\nvarying vec2 v_texcoord;varying vec4 v_color;uniform sampler2D u_baseRender2DTexture;uniform vec4 u_baseRenderColor;uniform vec4 u_tilingOffset;\n#ifdef LIGHT2D_ENABLE\nvarying vec2 v_lightUV;uniform vec3 u_LightDirection;uniform vec4 u_LightAndShadow2DParam;uniform vec4 u_LightAndShadow2DAmbient;uniform sampler2D u_LightAndShadow2D;\n#ifdef LIGHT2D_SCENEMODE_ADD\nuniform sampler2D u_LightAndShadow2D_AddMode;\n#endif\n#ifdef LIGHT2D_SCENEMODE_SUB\nuniform sampler2D u_LightAndShadow2D_SubMode;\n#endif\n#ifdef LIGHT2D_NORMAL_PARAM\nuniform sampler2D u_normal2DTexture;uniform float u_normal2DStrength;\n#endif\nvoid lightAndShadow(inout vec4 color){\n#ifdef LIGHT2D_EMPTY\ncolor.rgb*=u_LightAndShadow2DAmbient.rgb;\n#else\nvec2 uv=v_lightUV;vec2 tt=step(vec2(0.0),uv)*step(uv,vec2(1.0));float side=tt.x*tt.y;vec3 ambient=color.rgb*u_LightAndShadow2DAmbient.rgb;color.rgb=color.rgb*texture2D(u_LightAndShadow2D,uv).rgb*side;side*=color.a;\n#ifdef LIGHT2D_SCENEMODE_ADD\ncolor.rgb=min(vec3(1.0),color.rgb+texture2D(u_LightAndShadow2D_AddMode,uv).rgb*side);\n#endif\n#ifdef LIGHT2D_SCENEMODE_SUB\ncolor.rgb=max(vec3(0.0),color.rgb-texture2D(u_LightAndShadow2D_SubMode,uv).rgb*side);\n#endif\n#ifdef LIGHT2D_NORMAL_PARAM\nvec3 dr=normalize(u_LightDirection);vec3 normal=normalize(texture2D(u_normal2DTexture,v_texcoord).rgb*2.0-1.0);color.rgb=color.rgb*((1.0-u_normal2DStrength)+abs(dot(dr,normal.rgb))*u_normal2DStrength);\n#endif\ncolor.rgb=min(vec3(1.0),color.rgb+ambient);\n#endif\n}\n#endif\nvoid setglColor(in vec4 color){color.a*=v_color.w;vec4 transColor=v_color;\n#ifndef GAMMASPACE\ntransColor=gammaToLinear(v_color);\n#endif\ncolor.rgb*=transColor.rgb;gl_FragColor=color;}vec2 transformUV(in vec2 texcoord,in vec4 tilingOffset){vec2 uv=texcoord*tilingOffset.zw+tilingOffset.xy;return uv;}\n#endif\nvoid clip(){if(v_cliped.x<0.)discard;if(v_cliped.x>1.)discard;if(v_cliped.y<0.)discard;if(v_cliped.y>1.)discard;}"),gr.addInclude("Sprite2DVertex.glsl","#ifdef CAMERA2D\nuniform mat3 u_view2D;\n#endif\n#ifdef SPRITE2DGLOBAL\n#endif\n#ifdef RENDERTEXTURE\nuniform vec3 u_InvertMat_0;uniform vec3 u_InvertMat_1;\n#endif\n#ifdef VERTEX_SIZE\nuniform vec4 u_vertexSize;\n#endif\nuniform vec3 u_NMatrix_0;uniform vec3 u_NMatrix_1;uniform vec2 u_size;\n#ifdef MATERIALCLIP\nuniform vec4 u_mClipMatDir;uniform vec4 u_mClipMatPos;\n#endif\nuniform vec4 u_clipMatDir;uniform vec4 u_clipMatPos;varying vec2 v_cliped;varying vec4 v_color;void transfrom(vec2 pos,vec3 xDir,vec3 yDir,out vec2 outPos){outPos.x=xDir.x*pos.x+xDir.y*pos.y+xDir.z;outPos.y=yDir.x*pos.x+yDir.y*pos.y+yDir.z;}void clip(inout vec2 globalPos){vec4 clipMatDir;vec4 clipMatPos;\n#ifdef MATERIALCLIP\nclipMatDir=u_mClipMatDir;clipMatPos=u_mClipMatPos;float tx=clipMatPos.z;float ty=clipMatPos.w;float cmaxx=tx+clipMatDir.x;float cmaxy=ty+clipMatDir.w;float parentMinX=u_clipMatPos.x;float parentMinY=u_clipMatPos.y;float offsetx=u_clipMatPos.z-parentMinX;float offsety=u_clipMatPos.w-parentMinY;float parentMaxX=parentMinX+u_clipMatDir.x;float parentMaxY=parentMinY+u_clipMatDir.w;if(tx<parentMinX){clipMatDir.x-=(parentMinX-tx);tx=clipMatPos.x=parentMinX;}if(cmaxx>parentMaxX){clipMatDir.x-=(cmaxx-parentMaxX);}if(ty<parentMinY){clipMatDir.w-=(parentMinY-ty);ty=clipMatPos.y=parentMinY;}if(cmaxy>parentMaxY){clipMatDir.w-=(cmaxy-parentMaxY);}clipMatPos.zw=vec2(tx+offsetx,ty+offsety);\n#else\nclipMatDir=u_clipMatDir;clipMatPos=u_clipMatPos;\n#endif\nvec2 cliped;float clipw=length(clipMatDir.xy);float cliph=length(clipMatDir.zw);vec2 clippos=globalPos-clipMatPos.xy;if(clipw>20000.&&cliph>20000.)cliped=vec2(0.5,0.5);else{cliped=vec2(dot(clippos,clipMatDir.xy)/clipw/clipw,dot(clippos,clipMatDir.zw)/cliph/cliph);}globalPos=clippos+clipMatPos.zw;v_cliped=cliped;}void getGlobalPos(in vec2 localPos,out vec2 globalPos){transfrom(localPos,u_NMatrix_0,u_NMatrix_1,globalPos);}void getProjectPos(in vec2 viewPos,out vec4 projectPos){projectPos=vec4((viewPos.x/u_size.x-0.5)*2.0,(0.5-viewPos.y/u_size.y)*2.0,0.,1.0);\n#ifdef INVERTY\nprojectPos.y=-projectPos.y;\n#endif\n}void getViewPos(in vec2 globalPos,out vec2 viewPos){\n#ifdef RENDERTEXTURE\nvec2 tempPos;transfrom(globalPos,u_InvertMat_0,u_InvertMat_1,tempPos);\n#ifdef CAMERA2D\nviewPos.xy=(u_view2D*vec3(tempPos,1.0)).xy+u_size/2.;\n#else\nviewPos.xy=tempPos;\n#endif\n#else\n#ifdef CAMERA2D\nviewPos.xy=(u_view2D*vec3(globalPos,1.0)).xy+u_size/2.;\n#else\nviewPos.xy=globalPos;\n#endif\n#endif\n}\n#ifdef TEXTUREVS\nstruct vertexInfo{vec2 pos;vec4 color;vec2 cliped;vec4 texcoordAlpha;float useTex;float useClip;vec4 customs;};uniform float u_VertAlpha;varying vec4 v_texcoordAlpha;varying float v_useTex;varying float v_useClip;varying vec4 v_customs;void getVertexInfo(inout vertexInfo info){info.texcoordAlpha.xy=a_posuv.zw;info.color=a_attribColor;info.color.a*=u_VertAlpha;info.color.xyz*=info.color.w;info.useTex=a_attribFlags.r;info.useClip=a_attribFlags.g;info.customs=a_customs;vec2 pos;\n#ifdef VERTEX_SIZE\npos=(a_posuv.xy*u_vertexSize.zw)+u_vertexSize.xy;\n#else\npos=a_posuv.xy;\n#endif\ninfo.pos=pos;}vec4 getPosition(in vec2 positionOS){vec2 globalPos;\n#ifdef VERTEX_SIZE\ngetGlobalPos(positionOS,globalPos);\n#else\nglobalPos=positionOS;\n#endif\nclip(globalPos);vec2 viewPos;getViewPos(globalPos,viewPos);vec4 pos;getProjectPos(viewPos,pos);return pos;}\n#endif\n#ifdef BASERENDER2D\nvarying vec2 v_texcoord;uniform vec4 u_baseRenderColor;struct vertexInfo{vec4 color;vec2 uv;vec2 pos;vec2 lightUV;};\n#ifdef LIGHT2D_ENABLE\nvarying vec2 v_lightUV;uniform vec4 u_LightAndShadow2DParam;void lightAndShadow(vertexInfo info){v_lightUV=info.lightUV;}void invertMat(inout vec3 v1,inout vec3 v2){float a1=v1.x;float b1=v2.x;float c1=v1.y;float d1=v2.y;float tx1=v1.z;float ty1=v2.z;float n=a1*d1-b1*c1;v1.x=d1/n;v2.x=-b1/n;v1.y=-c1/n;v2.y=a1/n;v1.z=(c1*ty1-d1*tx1)/n;v2.z=-(a1*ty1-b1*tx1)/n;}\n#endif\nvec4 linearToGamma(in vec4 value){return vec4(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055),value.rgb*12.92,vec3(lessThanEqual(value.rgb,vec3(0.0031308)))),value.a);}void getVertexInfo(inout vertexInfo info){info.pos=a_position.xy;info.color=vec4(1.0,1.0,1.0,1.0);\n#ifdef COLOR\ninfo.color=a_color;info.color.rgb*=a_color.a;\n#endif\ninfo.color*=linearToGamma(u_baseRenderColor);\n#ifdef UV\ninfo.uv=a_uv;\n#endif\n#ifdef LIGHT2D_ENABLE\nvec2 global;getGlobalPos(info.pos,global);info.lightUV.x=(global.x-u_LightAndShadow2DParam.x)/u_LightAndShadow2DParam.z;info.lightUV.y=1.0-(global.y-u_LightAndShadow2DParam.y)/u_LightAndShadow2DParam.w;\n#endif\n}vec4 getPosition(in vec2 positionOS){vec2 globalPos;getGlobalPos(positionOS,globalPos);clip(globalPos);vec2 viewPos;getViewPos(globalPos,viewPos);vec4 pos;getProjectPos(viewPos,pos);return pos;}\n#endif\n"),gr.addInclude("Color.glsl",'#if !defined(Color_lib)\n#define Color_lib\n#include "Math.glsl";\nvec3 linearToGamma(in vec3 value){return pow(value,vec3(1.0/2.2));}vec4 linearToGamma(in vec4 value){return vec4(linearToGamma(value.rgb),value.a);}vec3 gammaToLinear(in vec3 value){return pow(value,vec3(2.2));}vec4 gammaToLinear(in vec4 value){return vec4(gammaToLinear(value.rgb),value.a);}const float c_RGBDMaxRange=255.0;vec4 encodeRGBD(in vec3 color){float maxRGB=max(vecmax(color),FLT_EPS);float d=max(1.0,c_RGBDMaxRange/maxRGB);d=saturate(d/255.0);vec3 rgb=color.rgb*d;rgb=saturate(rgb);return vec4(rgb,d);}vec3 decodeRGBD(in vec4 rgbd){vec3 color=rgbd.rgb*(1.0/rgbd.a);return color;}vec4 encodeRGBM(in vec3 color,float range){color*=1.0/range;float maxRGB=max(vecmax(color),FLT_EPS);float m=ceil(maxRGB*255.0)/255.0;vec3 rgb=color.rgb*1.0/m;vec4 rgbm=vec4(rgb,m);return rgbm;}vec3 decodeRGBM(in vec4 rgbm,float range){return range*rgbm.rgb*rgbm.a;}\n#include "OutputTransform.glsl";\n#endif\n'),gr.addInclude("Math.glsl","#if !defined(Math_lib)\n#define Math_lib\n#ifndef GRAPHICS_API_GLES3\nmat2 inverse(mat2 m){return mat2(m[1][1],-m[0][1],-m[1][0],m[0][0])/(m[0][0]*m[1][1]-m[0][1]*m[1][0]);}mat3 inverse(mat3 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2];float a10=m[1][0],a11=m[1][1],a12=m[1][2];float a20=m[2][0],a21=m[2][1],a22=m[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}mat4 inverse(mat4 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return mat4(a11*b11-a12*b10+a13*b09,a02*b10-a01*b11-a03*b09,a31*b05-a32*b04+a33*b03,a22*b04-a21*b05-a23*b03,a12*b08-a10*b11-a13*b07,a00*b11-a02*b08+a03*b07,a32*b02-a30*b05-a33*b01,a20*b05-a22*b02+a23*b01,a10*b10-a11*b08+a13*b06,a01*b08-a00*b10-a03*b06,a30*b04-a31*b02+a33*b00,a21*b02-a20*b04-a23*b00,a11*b07-a10*b09-a12*b06,a00*b09-a01*b07+a02*b06,a31*b01-a30*b03-a32*b00,a20*b03-a21*b01+a22*b00)/det;}mat4 transpose(mat4 m){return mat4(m[0][0],m[1][0],m[2][0],m[3][0],m[0][1],m[1][1],m[2][1],m[3][1],m[0][2],m[1][2],m[2][2],m[3][2],m[0][3],m[1][3],m[2][3],m[3][3]);}mat3 transpose(mat3 m){return mat3(m[0][0],m[1][0],m[2][0],m[0][1],m[1][1],m[2][1],m[0][2],m[1][2],m[2][2]);}\n#endif\n#define PI 3.14159265359\n#define INVERT_PI 0.31830988618\n#define HALF_PI 1.570796327\n#define MEDIUMP_FLT_MAX 65504.0\n#define MEDIUMP_FLT_MIN 0.00006103515625\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n#define FLT_EPS 1e-5\n#define saturateMediump(x) x\n#else\n#define FLT_EPS MEDIUMP_FLT_MIN\n#define saturateMediump(x) min(x, MEDIUMP_FLT_MAX)\n#endif\n#define saturate(x) clamp(x, 0.0, 1.0)\nfloat pow2(float x){return x*x;}vec3 pow2(vec3 x){return x*x;}float pow5(float x){float x2=x*x;return x2*x2*x;}const float INVERT_LOG10=0.43429448190325176;float log10(float x){return log(x)*INVERT_LOG10;}float vecmax(const vec2 v){return max(v.x,v.y);}float vecmax(const vec3 v){return max(v.x,max(v.y,v.z));}float vecmax(const vec4 v){return max(max(v.x,v.y),max(v.z,v.w));}float vecmin(const vec2 v){return min(v.x,v.y);}float vecmin(const vec3 v){return min(v.x,min(v.y,v.z));}float vecmin(const vec4 v){return min(min(v.x,v.y),min(v.z,v.w));}vec3 SafeNormalize(in vec3 inVec){float dp3=max(0.001,dot(inVec,inVec));return inVec*inversesqrt(dp3);}vec3 normalScale(in vec3 normal,in float scale){normal*=vec3(scale,scale,1.0);return normalize(normal);}float acosFast(float x){float y=abs(x);float p=-0.1565827*y+1.570796;p*=sqrt(1.0-y);return x>=0.0 ? p : PI-p;}float acosFastPositive(float x){float p=-0.1565827*x+1.570796;return p*sqrt(1.0-x);}float interleavedGradientNoise(const highp vec2 w){const vec3 m=vec3(0.06711056,0.00583715,52.9829189);return fract(m.z*fract(dot(w,m.xy)));}vec3 rotationByEuler(in vec3 vector,in vec3 rot){float halfRoll=rot.z*0.5;float halfPitch=rot.x*0.5;float halfYaw=rot.y*0.5;float sinRoll=sin(halfRoll);float cosRoll=cos(halfRoll);float sinPitch=sin(halfPitch);float cosPitch=cos(halfPitch);float sinYaw=sin(halfYaw);float cosYaw=cos(halfYaw);float quaX=(cosYaw*sinPitch*cosRoll)+(sinYaw*cosPitch*sinRoll);float quaY=(sinYaw*cosPitch*cosRoll)-(cosYaw*sinPitch*sinRoll);float quaZ=(cosYaw*cosPitch*sinRoll)-(sinYaw*sinPitch*cosRoll);float quaW=(cosYaw*cosPitch*cosRoll)+(sinYaw*sinPitch*sinRoll);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}vec3 rotationByAxis(in vec3 vector,in vec3 axis,in float angle){float halfAngle=angle*0.5;float sinf=sin(halfAngle);float quaX=axis.x*sinf;float quaY=axis.y*sinf;float quaZ=axis.z*sinf;float quaW=cos(halfAngle);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}vec3 rotationByQuaternions(in vec3 v,in vec4 q){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}\n#endif\n"),gr.addInclude("OutputTransform.glsl","#if !defined(OutputTransform_lib)\n#define OutputTransform_lib\nvec3 gammaCorrect(in vec3 color,float gammaValue){return pow(color,vec3(gammaValue));}vec4 gammaCorrect(in vec4 color){float gammaValue=1.0/2.2;return vec4(gammaCorrect(color.rgb,gammaValue),color.a);}vec4 outputTransform(in vec4 color){\n#ifdef GAMMACORRECT\nreturn gammaCorrect(color);\n#else\nreturn color;\n#endif\n}\n#endif\n"),ba.graphicsShader=gr.add("Sprite2DTexture",!1,!1),ba.graphicsShader.shaderType=e.ShaderFeatureType.D2_TextureSV;let t=new pr(ba.graphicsAttribute,{},{});ba.graphicsShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME TextureVS2D\n#include "Sprite2DVertex.glsl";\nvoid main(){vertexInfo info;getVertexInfo(info);v_texcoordAlpha=info.texcoordAlpha;v_color=info.color;v_useTex=info.useTex;v_useClip=info.useClip;v_customs=info.customs;gl_Position=getPosition(info.pos);}','#define SHADER_NAME TextureFS2D\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n#include "Sprite2DFrag.glsl";\nvoid main(){clip();vec4 color=getSpriteTextureColor();setglColor(color);}'),ba.render2DNodeShader=gr.add("baseRender2D",!1,!1),ba.render2DNodeShader.shaderType=e.ShaderFeatureType.D2_BaseRenderNode2D,t=new pr(ba.Render2DNodeAttribute,{},{}),ba.render2DNodeShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME BaseRender2DVS\n#include "Sprite2DVertex.glsl";\nvoid main(){vertexInfo info;getVertexInfo(info);v_texcoord=info.uv;v_color=info.color;\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(info);\n#endif\ngl_Position=getPosition(info.pos);}','#define SHADER_NAME BaseRender2DPS\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n#include "Sprite2DFrag.glsl";\nvoid main(){clip();vec2 texcoord=v_texcoord.xy*u_tilingOffset.zw+u_tilingOffset.xy;vec4 textureColor=texture2D(u_baseRender2DTexture,texcoord);\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(textureColor);\n#endif\ntextureColor=transspaceColor(textureColor);setglColor(textureColor);}')}}ba.graphicsAttribute={a_posuv:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4],a_attribFlags:[2,e.ShaderDataType.Vector4],a_customs:[3,e.ShaderDataType.Vector4]},ba.Render2DNodeAttribute={a_position:[0,e.ShaderDataType.Vector4],a_color:[1,e.ShaderDataType.Vector4],a_uv:[2,e.ShaderDataType.Vector2]};class Ca{constructor(e){this._renderElements=[],this._submits=new wa,this._bufferBlocks=[],this.texturesMap=new Map,this.owner=e}clear(){let e=this._submits.length,t=0;for(t=0;t<e;t++)this._submits.elements[t].clear();this._bufferBlocks.length=0,this._submits.length=0}destroy(){this.clear();let e=this.owner.material,t=this._renderElements;for(let s=0;s<t.length;s++)e&&e._removeOwnerElement(t[s]),Ca._pool.recover(t[s]);t.length=0,this.texturesMap.forEach(e=>{e.off(c.CHANGE,this,this._resourceRepaint)}),this.texturesMap.clear();let s=this._submits.elements;for(let e=0;e<this._submits.length;e++)s[e].destroy();this._submits.destroy(),this._submits=null,this.owner=null}_check(){let e=!0;return this.texturesMap.forEach(t=>{e=t._getSource()&&e}),e}updateRenderElement(e,t,s){let r=this._renderElements.length,i=this._submits,a=i.length,n=r!==a,o=Math.max(r,a),l=this._bufferBlocks;for(let s=0;s<o;s++){let r=i.elements[s],n=this._renderElements[s];if(s<a){n||(n=Ca._pool.take(),n.value2DShaderData=t.spriteShaderData,n.owner=t,this._renderElements[s]=n),n.primitiveShaderData=r._internalInfo.shaderData,n.renderStateIsBySprite=r.renderStateIsBySprite&&e._useSpriteState,r.material?(n.subShader=r.material.shader.getSubShaderAt(0),n.materialShaderData=r.material.shaderData,r.material._setOwner2DElement(n)):n.subShader=ba.graphicsShader.getSubShaderAt(0);let i=n.geometry;i.bufferState=r.mesh.bufferState,i.clearRenderParams();let a=this._updateIndexViews(r,i),o=r.mesh._buffer.vertexBuffer;{let e=f.render2DRenderPassFactory.createGraphic2DBufferBlock();e.vertexs=r.vertexs,e.indexView=a,e.vertexBuffer=o,l.push(e)}this._updateGraphicsKeys(n,r)}else e.material&&e.material._removeOwnerElement(n),Ca._pool.recover(n)}this._renderElements.length=a,n&&(t.renderElements=this._renderElements),s.applyVertexBufferBlock(l)}_updateIndexViews(e,t){let s=e.mesh.checkIndex(e.indexCount);return s.setGeometry(t),e.indexView=s,s.setData(e.indices),e.indexCount=0,e.indices.length=0,s}_updateGraphicsKeys(e,t){let s,r=t.material?1:0,i=0===r&&t._internalInfo.materialClip?1:0,a=t._internalInfo.textureHost;a&&(s=a.bitmap||a),e.type=t._key.blendShader|r<<4|i<<5|(s?s.id:0)<<6}setRenderElement(e,t){e.renderElements=this._renderElements,t.applyVertexBufferBlock(this._bufferBlocks)}createSubmit(e,t,s){let r=this._submits.elements,i=null;return r.length>this._submits.length?(i=r[this._submits.length],i.update(e,t,s),this._submits.length++):(i=Fr.create(e,t,s),this._submits.add(i)),i}addResRef(e){if(e instanceof ie){this.texturesMap.get(e.id)||(e.on("dispose",this,this._resourceRepaint),this.texturesMap.set(e.id,e))}}_resourceRepaint(){this.owner._needGraphicsUpdate()?this.owner._graphics.repaint():this.owner._graphics._modified=!0}}Ca._pool=h.createPool2(()=>{let e=f.render2DRenderPassFactory.createPrimitiveRenderElement2D();return e.renderStateIsBySprite=!1,e.nodeCommonMap=["Sprite2D"],e},(t,s)=>{s||null==s?(t.geometry=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement),t.geometry.indexFormat=e.IndexFormat.UInt16):t.geometry&&(t.geometry.destroy(),t.geometry=null)},e=>{e.geometry&&(e.geometry.clearRenderParams(),e.geometry.bufferState=null),e.materialShaderData=null,e.value2DShaderData=null,e.primitiveShaderData=null,e.globalShaderData=null,e.owner=null,e.subShader=null,e.renderStateIsBySprite=!1,e.type=0});class Ra{constructor(){this._renderElement=null,this._shaderData=null,this._handle=null,this._submit=null,this._internalInfo=null,this._rtRect=new te,this._oriRect=new te,this._needUpdateVertexSize=!0,this._scaleX=1,this._scaleY=1,this._shaderData=f.renderDeviceFactory.createShaderData(),this._handle=f.render2DRenderPassFactory.create2D2DPrimitiveDataHandle(),this._submit=new Fr,this._internalInfo=new Lr,this._submit._internalInfo=this._internalInfo,this._renderElement=Ca._pool.take(),this._renderElement.value2DShaderData=this._shaderData,this._renderElement.subShader=ba.graphicsShader.getSubShaderAt(0),this._renderElement.primitiveShaderData=this._submit._internalInfo.shaderData,this._renderElement.nodeCommonMap=["Sprite2D"],this._renderElement.geometry=pi.runner.inv_geometry,Tr.initBlendMode(this._shaderData),this._internalInfo.enableVertexSize=!0}bind(t,s,r){this._sprite=t,this._subRenderPass=s,this._subStruct=r,this._subStruct.spriteShaderData=this._shaderData,this._subStruct.renderType=e.BaseRender2DType.graphics,this._submit.material=t.material,r.renderDataHandler=this._handle,r.renderMatrix=t.globalTrans.getMatrix(),r.renderElements=[this._renderElement],this._renderElement.owner=this._subStruct,this._renderElement.type=this._subStruct.blendMode}_updateRenderOffset(e,t,s,r){e.cloneTo(this._rtRect),t.equals(this._oriRect)||(this._needUpdateVertexSize=!0),t.cloneTo(this._oriRect),this._scaleX=s,this._scaleY=r;let i=this._subRenderPass,a=i.offsetMatrix,n=this._sprite;n.mask?this._updateLogicMatrix(n.mask,n.globalTrans.getMatrix(),e.x,e.y,a):n._maskParent&&n.transform?this._updateLogicMatrix(n,n.globalTrans.getMatrix(),e.x,e.y,a):(this._handle.logicMatrix=null,a.identity(),a.tx=e.x,a.ty=e.y),a.scale(1/s,1/r),i.offsetMatrix=a}_updateLogicMatrix(e,t,s,r,i){this._logicMatrix||(this._logicMatrix=new Ce);let a=this._logicMatrix,n=e.globalTrans.getMatrix(),o=(e.parent?e.parent:e._maskParent).globalTrans.getMatrix();o.copyTo(a);let l=e.x-e._pivotX,h=e.y-e._pivotY;a.tx=l*o.a+h*o.c+o.tx,a.ty=l*o.b+h*o.d+o.ty,a.copyTo(i),Ce.mul(a,t.copyTo(Ce.TEMP).invert(),a),this._handle.logicMatrix=this._logicMatrix,i.tx=s*i.a+r*i.c+i.tx,i.ty=s*i.b+r*i.d+i.ty,Ce.mul(n,i.invert(),i),i.invert()}_updateRenderTexture(e,t){var s;if(this._handle.mask=null===(s=this._sprite.mask)||void 0===s?void 0:s._struct,this._submit._key.blendShader!==this._subStruct.blendMode&&(this._submit._key.blendShader=this._subStruct.blendMode,Tr.setShaderData(this._subStruct.blendMode,this._internalInfo.shaderData)),this._internalInfo.textureHost==t&&!this._needUpdateVertexSize)return;this._renderElement.type=t?t._id<<6:0,this._internalInfo.textureHost=t;let r=this._oriRect,a=i.TEMP;a.x=r.x,a.y=r.y;let n=t.sourceWidth,o=t.sourceHeight;n>0&&o>0?(a.z=Math.round(n/this._scaleX),a.w=Math.round(o/this._scaleY),a.x-=(a.z-r.width)/2,a.y-=(a.w-r.height)/2):(a.z=r.width,a.w=r.height),this._internalInfo.vertexSize=a,this._needUpdateVertexSize=!1}destroy(){this._renderElement.geometry=null,Ca._pool.recover(this._renderElement),this._submit.destroy(),this._submit=null,this._internalInfo=null,this._handle=null,this._subRenderPass=null,this._subStruct=null,this._sprite=null}}class Ma{static colorEffect2DShaderInit(){let t={a_PositionTexcoord:[0,e.ShaderDataType.Vector4]},s={u_centerScale:e.ShaderDataType.Vector2,u_MainTex:e.ShaderDataType.Texture2D,u_colorMat:e.ShaderDataType.Matrix4x4,u_colorAlpha:e.ShaderDataType.Vector4},r=gr.add("ColorEffect2D");r.shaderType=e.ShaderFeatureType.PostProcess;let i=new pr(t,s);r.addSubShader(i);let a=i.addShaderPass("#define SHADER_NAME colorEffect2D\nvarying vec2 v_Texcoord0;void main(){gl_Position=vec4((a_PositionTexcoord.x)*u_centerScale.x,(a_PositionTexcoord.y)*u_centerScale.y,0.0,1.0);v_Texcoord0=a_PositionTexcoord.zw;\n#ifdef INVERTY\ngl_Position.y=-gl_Position.y;\n#endif\n}",'#define SHADER_NAME colorEffect2D\n#include "Color.glsl"\n#include "OutputTransform.glsl";\nvarying vec2 v_Texcoord0;void main(){vec4 mainColor=texture2D(u_MainTex,v_Texcoord0);gl_FragColor=mainColor;\n#ifdef COLORFILTER\nmat4 alphaMat=u_colorMat;alphaMat[0][3]*=gl_FragColor.a;alphaMat[1][3]*=gl_FragColor.a;alphaMat[2][3]*=gl_FragColor.a;gl_FragColor=gl_FragColor*alphaMat;gl_FragColor+=u_colorAlpha/255.0*gl_FragColor.a;\n#endif\ngl_FragColor=outputTransform(gl_FragColor);}');a.statefirst=!0,a.renderState.depthWrite=!1,a.renderState.depthTest=ws.DEPTHTEST_OFF,a.renderState.blend=ws.BLEND_ENABLE_ALL,a.renderState.blendEquation=ws.BLENDEQUATION_ADD,a.renderState.srcBlend=ws.BLENDPARAM_ONE,a.renderState.dstBlend=ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA,a.renderState.cull=ws.CULL_NONE}static blurEffect2DShaderInit(){let t={a_PositionTexcoord:[0,e.ShaderDataType.Vector4]},s={u_centerScale:e.ShaderDataType.Vector2,u_MainTex:e.ShaderDataType.Texture2D,u_strength_sig2_2sig2_gauss1:e.ShaderDataType.Vector4,u_blurInfo:e.ShaderDataType.Vector2},r=gr.add("BlurEffect2D");r.shaderType=e.ShaderFeatureType.PostProcess;let i=new pr(t,s);r.addSubShader(i);let a=i.addShaderPass("\n#define SHADER_NAME blurEffect2D\nvarying vec2 v_Texcoord0;void main(){gl_Position=vec4((a_PositionTexcoord.x)*u_centerScale.x,(a_PositionTexcoord.y)*u_centerScale.y,0.0,1.0);v_Texcoord0=a_PositionTexcoord.zw;\n#ifdef INVERTY\ngl_Position.y=-gl_Position.y;\n#endif\n}",'\n#define SHADER_NAME blurEffect2D\n#include "Color.glsl"\n#include "OutputTransform.glsl";\nvec4 transspaceColor(vec4 color){\n#ifndef GAMMATEXTURE\n#ifdef GAMMASPACE\ncolor.xyz=linearToGamma(color.xyz);\n#endif\n#else\n#ifndef GAMMASPACE\ncolor.xyz=gammaToLinear(color.xyz);\n#endif\n#endif\nreturn color;}varying vec2 v_Texcoord0;float getGaussian(float x,float y){return u_strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/u_strength_sig2_2sig2_gauss1.z);}vec4 blur(){const float blurw=9.0;vec4 vec4Color=vec4(0.0,0.0,0.0,0.0);vec2 halfsz=vec2(blurw,blurw)/2.0/u_blurInfo;vec2 startpos=v_Texcoord0.xy-halfsz;vec2 ctexcoord=startpos;vec2 step=1.0/u_blurInfo;for(float y=0.0;y<=blurw;++y){ctexcoord.x=startpos.x;for(float x=0.0;x<=blurw;++x){vec4Color+=texture2D(u_MainTex,ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0);ctexcoord.x+=step.x;}ctexcoord.y+=step.y;}return vec4Color;}void main(){gl_FragColor=blur();}');a.statefirst=!0,a.renderState.depthWrite=!1,a.renderState.depthTest=ws.DEPTHTEST_OFF,a.renderState.blend=ws.BLEND_ENABLE_ALL,a.renderState.blendEquation=ws.BLENDEQUATION_ADD,a.renderState.srcBlend=ws.BLENDPARAM_ONE,a.renderState.dstBlend=ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA,a.renderState.cull=ws.CULL_NONE}static glow2DShaderInit(){let t={a_PositionTexcoord:[0,e.ShaderDataType.Vector4]},s={u_centerScale:e.ShaderDataType.Vector2,u_MainTex:e.ShaderDataType.Texture2D,u_color:e.ShaderDataType.Vector4,u_blurInfo1:e.ShaderDataType.Vector4,u_blurInfo2:e.ShaderDataType.Vector4},r=gr.add("glow2D");r.shaderType=e.ShaderFeatureType.PostProcess;let i=new pr(t,s);r.addSubShader(i);let a=i.addShaderPass("#define SHADER_NAME glow2D\nvarying vec2 v_Texcoord0;void main(){gl_Position=vec4((a_PositionTexcoord.x)*u_centerScale.x,(a_PositionTexcoord.y)*u_centerScale.y,0.0,1.0);v_Texcoord0=a_PositionTexcoord.zw;\n#ifdef INVERTY\ngl_Position.y=-gl_Position.y;\n#endif\n}",'#define SHADER_NAME glow2D\n#include "OutputTransform.glsl";\nvarying vec2 v_Texcoord0;void main(){const float c_IterationTime=10.0;float floatIterationTotalTime=c_IterationTime*c_IterationTime;vec4 vec4Color=vec4(0.0,0.0,0.0,0.0);vec2 vec2FilterDir=vec2(-u_blurInfo1.z/u_blurInfo2.x,-u_blurInfo1.w/u_blurInfo2.y);vec2 vec2FilterOff=vec2(u_blurInfo1.x/u_blurInfo2.x/c_IterationTime*2.0,u_blurInfo1.y/u_blurInfo2.y/c_IterationTime*2.0);float maxNum=u_blurInfo1.x*u_blurInfo1.y;vec2 vec2Off=vec2(0.0,0.0);float floatOff=c_IterationTime/2.0;for(float i=0.0;i<=c_IterationTime;++i){for(float j=0.0;j<=c_IterationTime;++j){vec2Off=vec2(vec2FilterOff.x*(i-floatOff),vec2FilterOff.y*(j-floatOff));vec4Color+=texture2D(u_MainTex,v_Texcoord0.xy+vec2FilterDir+vec2Off);}}vec4Color/=floatIterationTotalTime;gl_FragColor=vec4(u_color.rgb,vec4Color.a*u_blurInfo2.z);gl_FragColor.rgb*=gl_FragColor.a;}');a.statefirst=!0,a.renderState.depthWrite=!1,a.renderState.depthTest=ws.DEPTHTEST_OFF,a.renderState.blend=ws.BLEND_ENABLE_ALL,a.renderState.blendEquation=ws.BLENDEQUATION_ADD,a.renderState.srcBlend=ws.BLENDPARAM_ONE,a.renderState.dstBlend=ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA,a.renderState.cull=ws.CULL_NONE}}const Aa=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];class Ia{static restoreTempArray(){Aa[0]=1,Aa[1]=0,Aa[4]=0,Aa[5]=1,Aa[12]=0,Aa[13]=0}static clear(){Ia.worldAlpha=1}}var Pa;Ia.worldMatrix4=Aa,Ia.worldMatrix=new Ce,Ia.matWVP=null,Ia.worldAlpha=1,Ia.worldScissorTest=!1,Ia.width=0,Ia.height=0,Ia.InvertY=!1,e.MaterialRenderMode=void 0,(Pa=e.MaterialRenderMode||(e.MaterialRenderMode={}))[Pa.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",Pa[Pa.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",Pa[Pa.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",Pa[Pa.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",Pa[Pa.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",Pa[Pa.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class Ba extends V{static load(e,t){l.loader.load(e,t,null,Te.MATERIAL)}static __initDefine__(){Ba.SHADERDEFINE_ALPHATEST=gr.getDefineByName("ALPHATEST"),Ba.SHADERDEFINE_MAINTEXTURE=gr.getDefineByName("MAINTEXTURE"),Ba.SHADERDEFINE_ADDTIVEFOG=gr.getDefineByName("ADDTIVEFOG"),Ba.ALPHATESTVALUE=gr.propertyNameToID("u_AlphaTestValue"),gr.CULL=gr.propertyNameToID("s_Cull"),gr.BLEND=gr.propertyNameToID("s_Blend"),gr.BLEND_SRC=gr.propertyNameToID("s_BlendSrc"),gr.BLEND_DST=gr.propertyNameToID("s_BlendDst"),gr.BLEND_SRC_RGB=gr.propertyNameToID("s_BlendSrcRGB"),gr.BLEND_DST_RGB=gr.propertyNameToID("s_BlendDstRGB"),gr.BLEND_SRC_ALPHA=gr.propertyNameToID("s_BlendSrcAlpha"),gr.BLEND_DST_ALPHA=gr.propertyNameToID("s_BlendDstAlpha"),gr.BLEND_EQUATION=gr.propertyNameToID("s_BlendEquation"),gr.BLEND_EQUATION_RGB=gr.propertyNameToID("s_BlendEquationRGB"),gr.BLEND_EQUATION_ALPHA=gr.propertyNameToID("s_BlendEquationAlpha"),gr.DEPTH_TEST=gr.propertyNameToID("s_DepthTest"),gr.DEPTH_WRITE=gr.propertyNameToID("s_DepthWrite"),gr.STENCIL_WRITE_MASK=gr.propertyNameToID("s_StencilWriteMask"),gr.STENCIL_READ_MASK=gr.propertyNameToID("s_StencilReadMask"),gr.STENCIL_Ref=gr.propertyNameToID("s_StencilRef"),gr.STENCIL_TEST=gr.propertyNameToID("s_StencilTest"),gr.STENCIL_WRITE=gr.propertyNameToID("s_StencilWrite"),gr.STENCIL_Op=gr.propertyNameToID("s_StencilOp"),gr.DEPTH_BIAS=gr.propertyNameToID("s_DepthBias"),gr.DEPTH_BIAS_CONSTANT=gr.propertyNameToID("s_DepthBiasConstant"),gr.DEPTH_BIAS_SLOPESCALE=gr.propertyNameToID("s_DepthBiasSlopeScale"),gr.DEPTH_BIAS_CLAMP=gr.propertyNameToID("s_DepthBiasClamp")}get renderQueue(){return this._renderQueue}set renderQueue(e){this._renderQueue=e,this._notifyOwnerElements()}_setOwner3DElement(e){this.ownerElements.add(e),e.materialShaderData=this._shaderValues,e.materialRenderQueue=this.renderQueue,e.subShader=this._shader.getSubShaderAt(0),e.materialId=this.id}_setOwner2DElement(e){this.ownerElements.add(e),e.materialShaderData=this._shaderValues,e.subShader=this._shader.getSubShaderAt(0)}_removeOwnerElement(e){this.ownerElements.delete(e)}_notifyOwnerElements(){this.ownerElements.forEach(e=>{e.materialId?this._setOwner3DElement(e):this._setOwner2DElement(e)})}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(Ba.ALPHATESTVALUE)}set alphaTestValue(e){this._shaderValues.setNumber(Ba.ALPHATESTVALUE,e)}get alphaTest(){return this.shaderData.hasDefine(Ba.SHADERDEFINE_ALPHATEST)}set alphaTest(e){e?this._shaderValues.addDefine(Ba.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Ba.SHADERDEFINE_ALPHATEST)}addDefine(e){this._shaderValues.addDefine(e)}removeDefine(e){this._shaderValues.removeDefine(e)}setDefine(e,t){t?this._shaderValues.addDefine(e):this._shaderValues.removeDefine(e)}hasDefine(e){return this._shaderValues.hasDefine(e)}get depthWrite(){return this._shaderValues.getBool(gr.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(gr.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(gr.CULL)}set cull(e){this._shaderValues.setInt(gr.CULL,e)}get blend(){return this._shaderValues.getInt(gr.BLEND)}set blend(e){this._shaderValues.setInt(gr.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(gr.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(gr.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(gr.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(gr.BLEND_DST,e)}get blendSrcAlpha(){return this._shaderValues.getInt(gr.BLEND_SRC_ALPHA)}set blendSrcAlpha(e){this._shaderValues.setInt(gr.BLEND_SRC_ALPHA,e)}get blendSrcRGB(){return this._shaderValues.getInt(gr.BLEND_SRC_RGB)}set blendSrcRGB(e){this._shaderValues.setInt(gr.BLEND_SRC_RGB,e)}get blendDstRGB(){return this._shaderValues.getInt(gr.BLEND_DST_RGB)}set blendDstRGB(e){this._shaderValues.setInt(gr.BLEND_DST_RGB,e)}get blendDstAlpha(){return this._shaderValues.getInt(gr.BLEND_DST_ALPHA)}set blendDstAlpha(e){this._shaderValues.setInt(gr.BLEND_DST_ALPHA,e)}get blendEquation(){return this._shaderValues.getInt(gr.BLEND_EQUATION)}set blendEquation(e){this._shaderValues.setInt(gr.BLEND_EQUATION,e)}get blendEquationRGB(){return this._shaderValues.getInt(gr.BLEND_EQUATION_RGB)}set blendEquationRGB(e){this._shaderValues.setInt(gr.BLEND_EQUATION_RGB,e)}get blendEquationAlpha(){return this._shaderValues.getInt(gr.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(e){this._shaderValues.setInt(gr.BLEND_EQUATION_ALPHA,e)}get depthTest(){return this._shaderValues.getInt(gr.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(gr.DEPTH_TEST,e)}get stencilTest(){return this._shaderValues.getInt(gr.STENCIL_TEST)}set stencilTest(e){this._shaderValues.setInt(gr.STENCIL_TEST,e)}get stencilWrite(){return this._shaderValues.getBool(gr.STENCIL_WRITE)}set stencilWrite(e){this._shaderValues.setBool(gr.STENCIL_WRITE,e)}get stencilWriteMask(){return this._shaderValues.getInt(gr.STENCIL_WRITE_MASK)}set stencilWriteMask(e){this._shaderValues.setInt(gr.STENCIL_WRITE_MASK,e)}get stencilReadMask(){return this._shaderValues.getInt(gr.STENCIL_READ_MASK)}set stencilReadMask(e){this._shaderValues.setInt(gr.STENCIL_READ_MASK,e)}get stencilRef(){return this._shaderValues.getInt(gr.STENCIL_Ref)}set stencilRef(e){this._shaderValues.setInt(gr.STENCIL_Ref,e)}get stencilOp(){return this._shaderValues.getVector3(gr.STENCIL_Op)}set stencilOp(e){this._shaderValues.setVector3(gr.STENCIL_Op,e)}get depthBias(){return this._shaderValues.getBool(gr.DEPTH_BIAS)}set depthBias(e){this._shaderValues.setBool(gr.DEPTH_BIAS,e)}get depthBiasConstant(){return this._shaderValues.getNumber(gr.DEPTH_BIAS_CONSTANT)}set depthBiasConstant(e){this._shaderValues.setNumber(gr.DEPTH_BIAS_CONSTANT,e)}get dephtBiasSlopeScale(){return this._shaderValues.getNumber(gr.DEPTH_BIAS_SLOPESCALE)}set dephtBiasSlopeScale(e){this._shaderValues.setNumber(gr.DEPTH_BIAS_SLOPESCALE,e)}get depthBiasClamp(){return this._shaderValues.getNumber(gr.DEPTH_BIAS_CLAMP)}set depthBiasClamp(e){this._shaderValues.setNumber(gr.DEPTH_BIAS_CLAMP,e)}get MaterialProperty(){let e={};var t=this._shaderValues.getData();for(let s in t)e[f.renderEngine.propertyIDToName(parseInt(s))]=t[s];return e}get MaterialDefine(){let e=new Array,t=this._shaderValues.getDefineData();return gr._getNamesByDefineData(t,e),e}get materialRenderMode(){return this._matRenderNode}set materialRenderMode(t){switch(this._matRenderNode=t,t){case e.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Ba.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=ws.BLEND_DISABLE,this.depthTest=ws.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=Ba.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=ws.BLEND_DISABLE,this.depthTest=ws.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=Ba.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=ws.BLEND_ENABLE_ALL,this.blendSrc=ws.BLENDPARAM_SRC_ALPHA,this.blendDst=ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ws.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=Ba.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=ws.BLEND_ENABLE_ALL,this.blendSrc=ws.BLENDPARAM_SRC_ALPHA,this.blendDst=ws.BLENDPARAM_ONE,this.depthTest=ws.DEPTHTEST_LESS,this._shaderValues.addDefine(Ba.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=Ba.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=ws.BLEND_ENABLE_ALL,this.blendSrc=ws.BLENDPARAM_SRC_ALPHA,this.blendDst=ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ws.DEPTHTEST_LESS,this._shaderValues.removeDefine(Ba.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${t}).`)}}constructor(){super(),this.ownerElements=new Set,this._shaderValues=f.renderDeviceFactory.createShaderData(this),this.renderQueue=Ba.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=ws.CULL_BACK,this.blend=ws.BLEND_DISABLE,this.blendSrc=ws.BLENDPARAM_ONE,this.blendDst=ws.BLENDPARAM_ZERO,this.blendSrcRGB=ws.BLENDPARAM_ONE,this.blendDstRGB=ws.BLENDPARAM_ZERO,this.blendSrcAlpha=ws.BLENDPARAM_ONE,this.blendDstAlpha=ws.BLENDPARAM_ZERO,this.blendEquation=ws.BLENDEQUATION_ADD,this.blendEquationRGB=ws.BLENDEQUATION_ADD,this.blendEquationAlpha=ws.BLENDEQUATION_ADD,this.depthTest=ws.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilReadMask=255,this.stencilRef=1,this.stencilTest=ws.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new a(ws.STENCILOP_KEEP,ws.STENCILOP_KEEP,ws.STENCILOP_REPLACE),this.depthBias=!1,this.depthBiasConstant=0,this.dephtBiasSlopeScale=0,this.depthBiasClamp=0,this.destroyedImmediately=t.destroyResourceImmediatelyDefault}_disposeResource(){this._shaderValues.destroy(),this._shaderValues=null,this.ownerElements.clear()}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformMap}setShaderName(e){this._shader=gr.find(e),this._shader||(console.warn(`Material: unknown shader name '${e}'`),this._shader=gr.find("BLINNPHONG")),this.shaderData.clearDefine(),this.shaderData.clearData();let t=this._shader.getSubShaderAt(0),s=t._uniformDefaultValue,r=t._uniformMap;this.applyUniformDefaultValue(r,s),this._notifyOwnerElements()}applyUniformDefaultValue(e,t){e.forEach((e,s)=>{if(e.arrayLength<=0){let s=e.uniformtype,r=e.propertyName;if(t&&null!=t[r]){let e=t[r];this.setShaderData(r,s,e)}else{let e=sr(s);e&&this.setShaderData(r,s,e)}}})}getBoolByIndex(e){return this.shaderData.getBool(e)}setBoolByIndex(e,t){this.shaderData.setBool(e,t)}getBool(e){let t=gr.propertyNameToID(e);return this.getBoolByIndex(t)}setBool(e,t){let s=gr.propertyNameToID(e);this.setBoolByIndex(s,t)}getFloatByIndex(e){return this.shaderData.getNumber(e)}setFloatByIndex(e,t){this.shaderData.setNumber(e,t)}getFloat(e){let t=gr.propertyNameToID(e);return this.getFloatByIndex(t)}setFloat(e,t){let s=gr.propertyNameToID(e);this.setFloatByIndex(s,t)}getIntByIndex(e){return this.shaderData.getInt(e)}setIntByIndex(e,t){this.shaderData.setInt(e,t)}getInt(e){let t=gr.propertyNameToID(e);return this.getIntByIndex(t)}setInt(e,t){let s=gr.propertyNameToID(e);this.setIntByIndex(s,t)}getVector2ByIndex(e){return this.shaderData.getVector2(e)}setVector2ByIndex(e,t){this.shaderData.setVector2(e,t)}getVector2(e){let t=gr.propertyNameToID(e);return this.getVector2ByIndex(t)}setVector2(e,t){let s=gr.propertyNameToID(e);this.setVector2ByIndex(s,t)}getVector3ByIndex(e){return this.shaderData.getVector3(e)}setVector3ByIndex(e,t){this.shaderData.setVector3(e,t)}getVector3(e){let t=gr.propertyNameToID(e);return this.getVector3ByIndex(t)}setVector3(e,t){let s=gr.propertyNameToID(e);this.setVector3ByIndex(s,t)}setVector4ByIndex(e,t){this.shaderData.setVector(e,t)}getVector4ByIndex(e){return this.shaderData.getVector(e)}setVector4(e,t){let s=gr.propertyNameToID(e);this.setVector4ByIndex(s,t)}getVector4(e){let t=gr.propertyNameToID(e);return this.getVector4ByIndex(t)}getColorByIndex(e){return this.shaderData.getColor(e)}setColorByIndex(e,t){this.shaderData.setColor(e,t)}getColor(e){let t=gr.propertyNameToID(e);return this.shaderData.getColor(t)}setColor(e,t){let s=gr.propertyNameToID(e);this.setColorByIndex(s,t)}getMatrix4x4ByIndex(e){return this.shaderData.getMatrix4x4(e)}setMatrix4x4ByIndex(e,t){this.shaderData.setMatrix4x4(e,t)}getMatrix4x4(e){let t=gr.propertyNameToID(e);return this.getMatrix4x4ByIndex(t)}setMatrix4x4(e,t){let s=gr.propertyNameToID(e);this.setMatrix4x4ByIndex(s,t)}getMatrix3x3ByIndex(e){return this.shaderData.getMatrix3x3(e)}setMatrix3x3ByIndex(e,t){this.shaderData.setMatrix3x3(e,t)}getMatrix3x3(e){let t=gr.propertyNameToID(e);return this.getMatrix3x3ByIndex(t)}setMatrix3x3(e,t){let s=gr.propertyNameToID(e);this.setMatrix3x3ByIndex(s,t)}setTextureByIndex(e,t){p.isConch?(this.shaderData.setTexture(e,t),t&&!t._texture&&t.once(c.READY,this,this.reSetTexture,[e,t])):this.shaderData.setTexture(e,t)}reSetTexture(e,t){this.setTextureByIndex(e,t)}getTextureByIndex(e){return this.shaderData.getTexture(e)}setTexture(e,t){let s=gr.propertyNameToID(e);this.setTextureByIndex(s,t)}getTexture(e){let t=gr.propertyNameToID(e);return this.getTextureByIndex(t)}getBufferByIndex(e){return this.shaderData.getBuffer(e)}setBufferByIndex(e,t){this.shaderData.setBuffer(e,t)}getBuffer(e){let t=gr.propertyNameToID(e);return this.getBufferByIndex(t)}setBuffer(e,t){let s=gr.propertyNameToID(e);this.setBufferByIndex(s,t)}setShaderDataByIndex(e,t,s){this.shaderData.setShaderData(e,t,s)}setShaderData(e,t,s){let r=gr.propertyNameToID(e);this.setShaderDataByIndex(r,t,s)}getShaderData(e,t){let s=gr.propertyNameToID(e);return this.getShaderDataByIndex(s,t)}getShaderDataByIndex(e,t){return this._shaderValues.getShaderData(e,t)}cloneTo(e){e.name=this.name,e.renderQueue=this.renderQueue,e.setShaderName(this._shader._name),this._shaderValues.cloneTo(e._shaderValues)}clone(){var e=new Ba;return this.cloneTo(e),e}checkType(t){if(this._shader&&this._shader.shaderType===e.ShaderFeatureType.None)return!0;let s=this._shader&&this._shader.shaderType==t;return s||console.warn("This Renderer expect Material shader type is "+e.ShaderFeatureType[t]+", but the Material shader type is "+e.ShaderFeatureType[this._shader.shaderType]+"."),s}get _defineDatas(){return this._shaderValues.getDefineData()}oldparseEndEvent(){}}Ba.RENDERQUEUE_OPAQUE=2e3,Ba.RENDERQUEUE_ALPHATEST=2450,Ba.RENDERQUEUE_TRANSPARENT=3e3;class La{static getVertexDeclaration(e,t=!0){let s=[];for(let o=0,l=e.length;o<l;o++){let l=e[o],h=La._vertexDeclarationMap[l+(t?"_0":"_1")];if(!h){var r=l.split(","),i=0,a=[];for(let e=0,s=r.length;e<s;e++){var n;switch(r[e]){case"POSITION":n=new nr(i,dr.Vector3,_r.MESH_POSITION0),i+=12;break;case"COLOR":n=new nr(i,dr.Vector4,_r.MESH_COLOR0),i+=16;break;case"UV":n=new nr(i,dr.Vector2,_r.MESH_TEXTURECOORDINATE0),i+=8;break;case"BLENDWEIGHT":n=new nr(i,dr.Vector4,_r.MESH_BLENDWEIGHT0),i+=16;break;case"BLENDINDICES":t?(n=new nr(i,dr.Vector4,_r.MESH_BLENDINDICES0),i+=16):(n=new nr(i,dr.Byte4,_r.MESH_BLENDINDICES0),i+=4);break;default:throw"VertexMesh: unknown vertex flag."}a.push(n)}h=new cr(i,a),La._vertexDeclarationMap[l+(t?"_0":"_1")]=h}s.push(h)}return s}static getMeshDefine(e,t){t.length=0;let s=e._vertexBuffers;for(var r=0,i=s.length;r<i;r++){let e=s[r].vertexDeclaration._vertexElements;for(const s of e)switch(s.elementUsage){case _r.MESH_COLOR0:t.push(gr.getDefineByName("COLOR"));break;case _r.MESH_TEXTURECOORDINATE0:t.push(gr.getDefineByName("UV"))}}}}La._vertexDeclarationMap={};class Na extends V{static createMesh2DByPrimitive(t,s,r,i,a,n=!1){let o=new Na;o.canRead=n;let l=[],h=[];for(var d=0,u=t.length;d<u;d++){let r=t[d],i=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);i.vertexDeclaration=s[d],i.setDataLength(r.buffer.byteLength),i.setData(r.buffer,0,0,r.buffer.byteLength),l.push(i),h[d]=r.buffer}let c=f.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Dynamic);c._setIndexDataLength(r.buffer.byteLength),c._setIndexData(r,0),c.indexType=i,o._setBuffers(l,c);let _=[];for(d=0;d<a.length;d++){let t=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement);t.bufferState=o._bufferState,t.setDrawElemenParams(a[d].length,a[d].start),t.indexFormat=i,_.push(t)}return o._setSubMeshes(_),n&&(o._vertices=h,o._indices=r),o}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get vertexCount(){return this._vertexCount}get indexCount(){return this._indexBuffer.indexCount}get subMeshCount(){return this._subMeshes.length}get indexFormat(){return this._indexFormat}constructor(){super(),this._instanceBufferStateType=0,this._vertexBuffers=null,this._indexBuffer=null,this._vertexCount=0,this._indexFormat=e.IndexFormat.UInt16,this.canRead=!1,this._vertices=null,this._indices=null,this._bufferState=f.renderDeviceFactory.createBufferState(),this._subMeshes=[],this.destroyedImmediately=t.destroyResourceImmediatelyDefault}_disposeResource(){for(let e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();for(let e=0,t=this._vertexBuffers.length;e<t;e++)this._vertexBuffers[e].destroy();this._indexBuffer&&this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState&&this._instanceBufferState.destroy(),this._instanceWorldVertexBuffer&&this._instanceWorldVertexBuffer.destroy(),this._instanceSimpleAniVertexBuffer&&this._instanceSimpleAniVertexBuffer.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffers=null,this._indexBuffer=null,this._subMeshes=null,this._indexBuffer=null}_setSubMeshes(e){this._subMeshes=e}_setBuffers(e,t){var s=this._bufferState;this._vertexBuffers=e,this._indexBuffer=t,s.applyState(e,t)}getSubMesh(e){return this._subMeshes[e]}setVertices(e){for(let t=0,s=e.length;t<s;t++)e[t]&&this._vertexBuffers[t]&&this._vertexBuffers[t].setData(e[t],0,0,e[t].byteLength);this.canRead&&(this._vertices=e)}getVertices(){if(this.canRead&&this._vertices)return this._vertices;throw new Error("Can't getVertices without the canRead flag, or if the canRead flag is false before setVertices!")}setVertexByIndex(e,t,s=0){this._vertexBuffers[t].setData(e,s,0,e.byteLength)}setIndices(t){var s;t instanceof Uint32Array?s=e.IndexFormat.UInt32:t instanceof Uint16Array?s=e.IndexFormat.UInt16:t instanceof Uint8Array&&(s=e.IndexFormat.UInt8);let r=this._indexBuffer;r.indexCount<t.length&&console.error("Mesh2D:set indices buffer large than ori indices");var i=!1;(this._indexFormat!==s||r.indexCount<t.length)&&(r.destroy(),i=!0,this._indexBuffer=r=f.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Static),this._indexBuffer._setIndexDataLength(t.byteLength),r.indexCount=r.indexCount,r.indexType=s),r._setIndexData(t,0),i&&this._bufferState.applyState(this._bufferState._vertexBuffers,r),this.canRead&&(this._indices=t)}getIndices(){if(this.canRead&&this._indices)return this._indices;throw new Error("Can't getIndices without the canRead flag, or if the canRead flag is false before setIndices!")}}class Fa extends xa{static __init__(){Fa.mesh2DDefaultMaterial||(Fa.mesh2DDefaultMaterial=new Ba,Fa.mesh2DDefaultMaterial.setShaderName("baseRender2D"),Fa.mesh2DDefaultMaterial.setBoolByIndex(gr.DEPTH_WRITE,!1),Fa.mesh2DDefaultMaterial.setIntByIndex(gr.DEPTH_TEST,ws.DEPTHTEST_OFF),Fa.mesh2DDefaultMaterial.setIntByIndex(gr.BLEND,ws.BLEND_ENABLE_ALL),Fa.mesh2DDefaultMaterial.setIntByIndex(gr.BLEND_EQUATION,ws.BLENDEQUATION_ADD),Fa.mesh2DDefaultMaterial.setIntByIndex(gr.BLEND_SRC,ws.BLENDPARAM_ONE),Fa.mesh2DDefaultMaterial.setIntByIndex(gr.BLEND_DST,ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA),Fa.mesh2DDefaultMaterial.setFloatByIndex(mr.UNIFORM_VERTALPHA,1),Fa.mesh2DDefaultMaterial.setIntByIndex(gr.CULL,ws.CULL_NONE),Fa.mesh2DDefaultMaterial.lock=!0)}_createRenderHandle(){return f.render2DRenderPassFactory.createMesh2DRenderDataHandle()}_initDefaultRenderData(){this.color=new y,this.tilingOffset=new i(0,0,1,1),this.texture=null}_isMaterialVaild(t){return t.checkType(e.ShaderFeatureType.D2_BaseRenderNode2D)}renderUpdate(e){this._updateLight()}set sharedMesh(e){if(this._sharedMesh==e)return;let t=new Array;if(this._sharedMesh){La.getMeshDefine(this._sharedMesh,t);for(var s=0,r=t.length;s<r;s++)this._spriteShaderData.removeDefine(t[s]);this._sharedMesh._removeReference()}if(t.length=0,e)if(e._vertexBuffers){La.getMeshDefine(e,t);for(s=0,r=t.length;s<r;s++)this._spriteShaderData.addDefine(t[s]);e._addReference()}else e=null,console.warn("not a 2D mesh");this._sharedMesh=e,this._changeMesh()}get sharedMesh(){return this._sharedMesh}set color(e){this._renderHandle.baseColor=e}get color(){return this._renderHandle.baseColor}set tilingOffset(e){this._renderHandle.tilingOffset=e}get tilingOffset(){return this._renderHandle.tilingOffset}set texture(e){this._renderHandle.baseTexture=e}get texture(){return this._renderHandle.baseTexture}set normalTexture(e){this._renderHandle.normal2DTexture=e}get normalTexture(){return this._renderHandle.normal2DTexture}set normalStrength(e){this._renderHandle.normal2DStrength=e}get normalStrength(){return this._renderHandle.normal2DStrength}set sharedMaterial(e){super.sharedMaterial=e,this._changeMesh()}get sharedMaterial(){return this._materials[0]}_changeMesh(){let e=this._sharedMesh?this._sharedMesh.subMeshCount:0;if(e<this._renderElements.length){for(var t=this._renderElements.length,s=e;s<t;t--){this._renderElements[t-1].destroy()}this._renderElements.length=e}for(t=0,s=e;t<s;t++){let e=this._renderElements[t];e||(e=this._renderElements[t]=f.render2DRenderPassFactory.createRenderElement2D()),e.geometry=this._sharedMesh.getSubMesh(t),e.value2DShaderData=this._spriteShaderData,xa._setRenderElement2DMaterial(e,this._materials[t]?this._materials[t]:Fa.mesh2DDefaultMaterial),e.renderStateIsBySprite=!1,e.nodeCommonMap=this._getcommonUniformMap(),e.owner=this._struct}this._struct.renderElements=this._renderElements}constructor(){super(),this._renderElements=[],this._materials=[]}}class Oa{constructor(){this._commandBuffer=null}recover(){this._commandBuffer=null,this._context=null}destroy(){this._commandBuffer=null,this._context=null}}class Ua extends Oa{static __initBlitShader__(){let t={a_PositionTexcoord:[0,e.ShaderDataType.Vector4]},s={u_OffsetScale:e.ShaderDataType.Vector4,u_MainTex:e.ShaderDataType.Texture2D,u_MainTex_TexelSize:e.ShaderDataType.Vector4},r=gr.add("Blit2DCMD");r.shaderType=e.ShaderFeatureType.PostProcess;let i=new pr(t,s);r.addSubShader(i);let a=i.addShaderPass("\n        #define SHADER_NAME Blit2DVS\n\n        varying vec2 v_Texcoord0;\n\n        void main()\n        {\n            gl_Position = vec4(u_OffsetScale.x * 2.0 - 1.0 + (a_PositionTexcoord.x + 1.0) * u_OffsetScale.z, (1.0 - ((u_OffsetScale.y * 2.0 - 1.0 + (-a_PositionTexcoord.y + 1.0) * u_OffsetScale.w) + 1.0) / 2.0) * 2.0 - 1.0, 0.0, 1.0);\n\n            v_Texcoord0 = a_PositionTexcoord.zw;\n\n            #ifdef INVERTY\n            gl_Position.y = -gl_Position.y;\n            #endif\n        }\n        ",'\n        #define SHADER_NAME Blit2DFS\n\n        #include "Color.glsl";\n\n        varying vec2 v_Texcoord0;\n\n        void main()\n        {\n            vec4 mainColor = texture2D(u_MainTex, v_Texcoord0);\n            #ifdef Gamma_u_MainTex\n            mainColor = gammaToLinear(mainColor);\n            #endif // Gamma_u_AlbedoTexture\n            gl_FragColor = mainColor;\n            gl_FragColor = outputTransform(gl_FragColor);\n        }\n        ');a.statefirst=!0,a.renderState.depthWrite=!1,a.renderState.depthTest=ws.DEPTHTEST_OFF,a.renderState.blend=ws.BLEND_ENABLE_ALL,a.renderState.blendEquation=ws.BLENDEQUATION_ADD,a.renderState.srcBlend=ws.BLENDPARAM_ONE,a.renderState.dstBlend=ws.BLENDPARAM_ONE_MINUS_SRC_ALPHA,a.renderState.cull=ws.CULL_NONE}static __initGeometryElement__(){let t=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),s=new cr(16,[new nr(0,dr.Vector4,0)]),r=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);r.vertexDeclaration=s,r.setDataLength(t.buffer.byteLength),r.setData(t.buffer,0,0,t.buffer.byteLength);let i=f.renderDeviceFactory.createBufferState();i.applyState([r],null);let a=Ua.QuadGeometry=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.TriangleStrip,e.DrawType.DrawArray);a.setDrawArrayParams(0,4),a.bufferState=i,Ua.__initInvertGeometryElement__()}static __initInvertGeometryElement__(){let t=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]),s=new cr(16,[new nr(0,dr.Vector4,0)]),r=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);r.vertexDeclaration=s,r.setDataLength(t.buffer.byteLength),r.setData(t.buffer,0,0,t.buffer.byteLength);let i=f.renderDeviceFactory.createBufferState();i.applyState([r],null);let a=Ua.InvertQuadGeometry=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.TriangleStrip,e.DrawType.DrawArray);a.setDrawArrayParams(0,4),a.bufferState=i}static __init__(){Ua.__initBlitShader__(),Ua.__initGeometryElement__(),Ua._blitShaderData=f.renderDeviceFactory.createShaderData(),Ua._defaultShader=gr.find("Blit2DCMD")}static create(e,t,s=null,r=null,i=null){Ua._blitShaderData||Ua.__init__();let a=Ua._pool.take();return a.source=e,a.dest=t,a.offsetScale=s,a.setshader(r,i),a}constructor(){super(),this._source=null,this._dest=null,this._offsetScale=new i,this._shader=null,this._shaderData=null,this._renderElement=f.render2DRenderPassFactory.createRenderElement2D(),this._blitQuadCMDData=f.render2DRenderPassFactory.createBlit2DQuadCMDData(),this._blitQuadCMDData.element=this._renderElement,this._renderElement.geometry=Ua.QuadGeometry,this._renderElement.nodeCommonMap=null,this._renderElement.renderStateIsBySprite=!1}get offsetScale(){return this._offsetScale}set offsetScale(e){e?e.cloneTo(this._offsetScale):Ua._defaultOffsetScale.cloneTo(this._offsetScale),this._blitQuadCMDData.offsetScale=this._offsetScale}get source(){return this._source}set source(e){this._source=e,this._blitQuadCMDData.source=e?e._texture:fs.blackTexture._texture}get dest(){return this._dest}set dest(e){this._dest=e,this._blitQuadCMDData.dest=e?e._renderTarget:null}set shaderData(e){this._shaderData=e||Ua._blitShaderData,this._renderElement.materialShaderData=this._shaderData}getRenderCMD(){return this._blitQuadCMDData}setshader(e,t){this._shader=e||Ua._defaultShader,this.shaderData=t,this._renderElement.subShader=this._shader.getSubShaderAt(0)}destroy(){this._commandBuffer=null,this._context=null}recover(){super.recover(),Ua._pool.recover(this)}}Ua._defaultOffsetScale=new i(0,0,1,1),Ua._pool=h.createPool(Ua);class ka extends Oa{static create(e,t,s,r,i){let a=ka._pool.take();return a.mesh=e,a.material=i||Fa.mesh2DDefaultMaterial,a.texture=s,a.color=r,a._setMatrix(t),a}constructor(){super(),this._renderElements=[],this._renderColor=new y(1,1,1,1),this._drawElementData=f.render2DRenderPassFactory.createDraw2DElementCMDData(),this._shaderData=f.renderDeviceFactory.createShaderData(),this._shaderData.addDefine(xa.SHADERDEFINE_BASERENDER2D);let e=i.TEMP.setValue(0,0,0,0);this._shaderData.setVector(mr.UNIFORM_CLIPMATPOS,e),e.x=e.w=De.MAX_CLIP_SIZE,this._shaderData.setVector(mr.UNIFORM_CLIPMATDIR,e),this._needUpdateElement=!0,this._matrix=new Ce}_setMatrix(e){e?e.copyTo(this._matrix):Ce.EMPTY.copyTo(this._matrix);let t=this._matrix,s=a.TEMP;s.x=t.a,s.y=t.c,s.z=t.tx,this._shaderData.setVector3(mr.UNIFORM_NMATRIX_0,s),s.x=t.b,s.y=t.d,s.z=t.ty,this._shaderData.setVector3(mr.UNIFORM_NMATRIX_1,s)}set material(e){e!=this.material&&(e||(e=Fa.mesh2DDefaultMaterial),this._material=e,this._needUpdateElement=!0)}get material(){return this._material}set mesh(e){if(e!=this.mesh){if(this._mesh){let e=[];La.getMeshDefine(this._mesh,e);for(var t=0,s=e.length;t<s;t++)this._shaderData.removeDefine(e[t])}if(e){let r=[];La.getMeshDefine(e,r);for(t=0,s=r.length;t<s;t++)this._shaderData.addDefine(r[t])}this._mesh=e,this._needUpdateElement=!0}}get mesh(){return this._mesh}set texture(e){1!=(e=e||fs.whiteTexture).gammaCorrection?this._shaderData.addDefine(mr.GAMMATEXTURE):this._shaderData.removeDefine(mr.GAMMATEXTURE),this._texture=e,this._shaderData.setTexture(xa.BASERENDER2DTEXTURE,e)}get texture(){return this._texture}set color(e){this._color=e;let t=e.a,s=this._renderColor;s.setValue(e.r*t,e.g*t,e.b*t,t),this._shaderData.setColor(xa.BASERENDER2DCOLOR,s)}get color(){return this._color}getRenderCMD(){return this._drawElementData}run(){if(this._needUpdateElement){let e=this._renderElements.length,t=this._mesh.subMeshCount,s=Math.max(e,t);for(let e=0;e<s;e++){let t=this._mesh.getSubMesh(e),s=this._renderElements[e];t?(s||(s=this._renderElements[e]=f.render2DRenderPassFactory.createRenderElement2D()),s.nodeCommonMap=["BaseRender2D"],s.geometry=t,s.renderStateIsBySprite=!1,s.value2DShaderData=this._shaderData,s.materialShaderData=this._material.shaderData,s.subShader=this._material._shader.getSubShaderAt(0)):s.destroy()}this._renderElements.length=s,this._drawElementData.setRenderelements(this._renderElements),this._needUpdateElement=!1}}recover(){ka._pool.recover(this),super.recover(),this.material=null,this.texture=null,this.mesh=null}destroy(){super.destroy(),this._shaderData.destroy(),this._shaderData=null,this._mesh=null,this._material=null}}ka._pool=h.createPool(ka);class Va extends Oa{static create(e,t=null){let s=Va._pool.take();return s.renderElement=e,s._setMatrix(t),s}get renderElement(){return this._renderElement}set renderElement(e){this._renderElement=e,this._drawElementCMDData.setRenderelements([this._renderElement])}constructor(){super(),this._drawElementCMDData=f.render2DRenderPassFactory.createDraw2DElementCMDData()}_setMatrix(e){if(this._matreix=e?e.clone():null,this._matreix&&this.renderElement.nodeCommonMap&&-1!=this.renderElement.nodeCommonMap.indexOf("BaseRender2D")){let e=a.TEMP;e.x=this._matreix.a,e.y=this._matreix.c,e.z=this._matreix.tx,this._renderElement.value2DShaderData.setVector3(mr.UNIFORM_NMATRIX_0,e),e.x=this._matreix.b,e.y=this._matreix.d,e.z=this._matreix.ty,this._renderElement.value2DShaderData.setVector3(mr.UNIFORM_NMATRIX_1,e)}}run(){}recover(){super.recover(),Va._pool.recover(this)}getRenderCMD(){return this._drawElementCMDData}destroy(){this._renderElement=null,this._drawElementCMDData=null}}Va._pool=h.createPool(Va);class Ga extends Oa{static create(e,t,s,r=!0){let i=Ga._pool.take();return i.renderTexture=e,i._setRenderTargetCMD.clearColor=t,i._setRenderTargetCMD.clearColorValue=s,i._setRenderTargetCMD.invertY=r,i}get renderTexture(){return this._renderTexture}set renderTexture(e){this._renderTexture=e,e?(this._setRenderTargetCMD.size.setValue(e.width,e.height),this._setRenderTargetCMD.rt=e._renderTarget):(this._setRenderTargetCMD.size.setValue(Ia.width,Ia.height),this._setRenderTargetCMD.rt=null)}constructor(){super(),this._renderTexture=null,this._setRenderTargetCMD=f.render2DRenderPassFactory.createSetRendertarget2DCMD()}run(){}getRenderCMD(){return this._setRenderTargetCMD}recover(){Ga._pool.recover(this),this._renderTexture=null}}Ga._pool=h.createPool(Ga);class za extends Oa{static create(e,t,s,r){let i=za._pool.take();return i.setDest(e),i._setRenderDataCMD.propertyID=t,i._setRenderDataCMD.dataType=r,i._setRenderDataCMD.value=s,i}constructor(){super(),this._globalMode=!1,this._setRenderDataCMD=f.render2DRenderPassFactory.createSetRenderDataCMD()}getRenderCMD(){return this._setRenderDataCMD}setDest(e){this._setRenderDataCMD.dest=e}recover(){za._pool.recover(this),this._globalMode=!1}}za._pool=h.createPool(za);class Ha extends Oa{static create(e,t,s){let r=Ha._pool.take();return r.setDest(e),r._setRenderDefineCMD.add=s,r._setRenderDefineCMD.define=t,r}constructor(){super(),this._globalMode=!1,this._setRenderDefineCMD=f.render2DRenderPassFactory.createSetShaderDefineCMD()}setDest(e){this._setRenderDefineCMD.dest=e}getRenderCMD(){return this._setRenderDefineCMD}recover(){Ha._pool.recover(this),this._globalMode=!1}}Ha._pool=h.createPool(Ha);class Wa{constructor(e){this._scene=null,this._renderCMDs=[],this.cacheData={},this._name=e,this.shaderData=f.renderDeviceFactory.createShaderData(),this._context=pi.rendercontext2D,this._commands=[]}getName(){return this._name}_cacheContextState(){this.cacheData.rt=this._context.getRenderTarget(),this.cacheData.pipeline=this._context.pipelineMode,this.cacheData.invertY=this._context.invertY}_recoverContextState(){this._context.setRenderTarget(this.cacheData.rt,!1,y.BLACK),this._context.pipelineMode=this.cacheData.pipeline,this._context.invertY=this.cacheData.invertY}apply(e=!0,t=!0){this.shaderData.clearData();let s=this._context.passData;s&&s.getDefineData()?s.cloneTo(this.shaderData):this.shaderData.setVector2(mr.UNIFORM_SIZE,ct.TEMP.setValue(Ia.width,Ia.height)),this._context.passData=this.shaderData,t&&this._cacheContextState();for(var r=0,i=this._commands.length;r<i;r++){let e=this._commands[r];e.run&&e.run()}e&&this._context.runCMDList(this._renderCMDs),this._context.passData=s,t&&this._recoverContextState()}applyOne(e=!0){if(e&&this._cacheContextState(),this._commands.length){var t=this._commands.shift();t.run&&t.run(),t.getRenderCMD&&this._context.runOneCMD(this._renderCMDs.shift()),t.recover()}return e&&this._recoverContextState(),this._commands.length>0}clear(e=!0){if(e)for(var t=0,s=this._commands.length;t<s;t++)this._commands[t].recover();this._commands.length=0,this._renderCMDs.length=0}getCommandsSize(){return this._commands.length}setShaderDataValue(e,t,s,r){if(!tr(r,s))return;let i=za.create(e,t,r,s);i._globalMode=!1,this._commands.push(i),i._commandBuffer=this,i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalShaderDataValue(e,t,s){if(!tr(s,t))return;if(!this._scene||!this._scene._specialManager)return;let r=za.create(this._scene._specialManager._shaderData,e,s,t);r._globalMode=!0,this._commands.push(r),r._commandBuffer=this,r.getRenderCMD&&this._renderCMDs.push(r.getRenderCMD())}setShaderDefine(e,t,s){let r=Ha.create(e,t,s);r._globalMode=!1,this._commands.push(r),r._commandBuffer=this,r.getRenderCMD&&this._renderCMDs.push(r.getRenderCMD())}blitTextureQuad(e,t,s,r,i){let a=Ua.create(e,t,s,r,i);this._commands.push(a),a._commandBuffer=this,a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}blitTextureBlur(e,t,s){}setRenderTarget(e,t,s=y.BLACK,r=!0){let i=Ga.create(e,t,s,r);this._commands.push(i),i._commandBuffer=this,i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}drawRenderElement(e,t){let s=Va.create(e,t);this._commands.push(s),s._commandBuffer=this,s.getRenderCMD&&this._renderCMDs.push(s.getRenderCMD())}drawMesh(e,t,s,r,i){let a=ka.create(e,t,s||fs.whiteTexture,r||y.WHITE,i||Fa.mesh2DDefaultMaterial);this._commands.push(a),a._commandBuffer=this,a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}drawQuad(){}drawLine(){}addCacheCommand(e){this._scene&&(e instanceof za&&e._commandBuffer&&e.setDest(this._scene._specialManager._shaderData),e instanceof Ha&&e._commandBuffer&&e.setDest(this._scene._specialManager._shaderData)),this._commands.push(e),e._commandBuffer=this,e.getRenderCMD&&this._renderCMDs.push(e.getRenderCMD())}}class Xa extends N{static init(){Ma.colorEffect2DShaderInit(),Ma.blurEffect2DShaderInit(),Ma.glow2DShaderInit()}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this._context.command.clear(!0),this._onChangeRender())}constructor(){super(),this._effects=[],this._enabled=!0,this._hasCleanRT=!1,this._context=new Ya,this._context.compositeShaderData=f.renderDeviceFactory.createShaderData(null),this._context.command=new Wa}get owner(){return this._owner}set owner(e){this._owner&&(this._owner._renderType&=~$e.POSTPROCESS),this._owner=e,this._owner&&this._effects.length>0&&this._enabled&&(this._owner._renderType|=$e.POSTPROCESS)}_checkEnabled(){if(0===this._effects.length||!this._enabled)return!1;for(let e=0;e<this._effects.length;e++)if(this._effects[e].active)return!0;return!1}_onChangeRender(){this._owner&&(this._checkEnabled()?this._owner._renderType|=$e.POSTPROCESS:this._owner._renderType&=~$e.POSTPROCESS,this._owner.setSubpassFlag(e.SubPassFlag.PostProcess),this._owner.repaint(e.RepaintFlag.Graphics))}getEffect(e){return this._effects.find(t=>t instanceof e)||null}setResource(e){this._context.source=e}getDestRT(){return this._context.destination}get effects(){return this._effects}set effects(e){this._effects.filter(t=>!e.includes(t)).forEach(e=>e.destroy()),this._effects.length=0;for(let t=0,s=e.length;t<s;t++)e[t]&&this.addEffect(e[t]);this._onChangeRender()}addEffect(e){return e.destroyed?(console.error("the target effect is destroyed",e),null):e.singleton&&this.getEffect(e.constructor)?(console.error("the target effect is a singleton",e),null):(this._effects.push(e),e.effectInit(this),this._onChangeRender(),e)}removeEffect(e){let t=this._effects.indexOf(e);-1!==t&&(this._effects.splice(t,1),e.destroy(),this._onChangeRender())}_render(){this._context.command.clear(!0),this._context.indirectTarget=this._context.source,this._context.destination=this._context.source;for(var e=0,t=this._effects.length;e<t;e++){let t=this._effects[e];t.active&&!t.destroyed&&(t.render(this._context),this._context.indirectTarget=this._context.destination)}this._hasCleanRT=!1}clear(){this._effects.length=0,this._onChangeRender()}clearCMD(){this._context.command.clear()}recoverAllRTS(){this._context.destination=null;for(let e of this._effects)e.clearRT(this._context);this._hasCleanRT=!0}apply(){this._hasCleanRT&&(this.clearCMD(),this._render(),this._hasCleanRT=!1),this._context._apply();for(let e=0,t=this._effects.length;e<t;e++){this._effects[e].clearRT(this._context)}this._hasCleanRT=!0}destroy(){this.owner=null,this._context.compositeShaderData.destroy(),this._context.compositeShaderData=null,this._effects.forEach(e=>e.destroy()),this._effects.length=0}}class Ya{constructor(){this.deferredReleaseTextures=[],this.oriOffset=new ct}getRenderTexture(e,t,s,r){return zi.createFromPool(e,t,s,r)}_apply(){this.command.apply(!0)}}const qa=we.NOT_IN_PAGE;class ja extends ki{constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._scaleX=1,this._scaleY=1,this._skewX=0,this._skewY=0,this._pivotX=0,this._pivotY=0,this._anchorX=0,this._anchorY=0,this._rotation=0,this._alpha=1,this._blendMode=e.BlendMode.invalid,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._subpassUpdateFlag=0,this.mouseThrough=!1,this.hitTestPrior=!1,this._autosize=!1,this._repaint=-1,this._repaintCount=-1,this._previousType=0,this._sizeFlag=0,this._cacheAsBmp=!1,this._layer=0,this._struct=f.render2DRenderPassFactory.createRenderStruct2D(),this._struct.owner=this,this._globalTrans=new Sa(this)}_initShaderData(){this._shaderData||(this._shaderData=f.renderDeviceFactory.createShaderData(),Tr.initBlendMode(this._shaderData),Tr.setShaderData(this._struct.blendMode,this._shaderData),this._struct.spriteShaderData=this._shaderData,this._struct.isRenderStruct=!0)}destroy(e=!0){super.destroy(e),this._texture&&(this._texture._removeReference(),this._texture=null),this._oriRenderPass&&(l.stage.passManager.removePass(this._oriRenderPass),this._oriRenderPass.postProcess&&(this._oriRenderPass.postProcess.destroy(),this._oriRenderPass.postProcess=null),this._oriRenderPass.destroy(),this._oriRenderPass=null),this._subStructRender&&(this._subStructRender.destroy(),this._subStructRender=null),this._drawOriRT&&(this._drawOriRT!==zi._empty&&zi.recoverToPool(this._drawOriRT),this._drawOriRT=null),this.setGraphics(null),this._struct=null}get parent(){return this._$parent}get scene(){return this._scene}get x(){return this._x}set x(e){this.pos(e,this._y)}get y(){return this._y}set y(e){this.pos(this._x,e)}get width(){return this._autosize?this.getSelfBounds(Ka).width:1&this._sizeFlag?this._width:this.measureWidth()}set width(e){this.size(e,2&this._sizeFlag?this._height:null)}get height(){return this._autosize?this.getSelfBounds(Ka).height:2&this._sizeFlag?this._height:this.measureHeight()}set height(e){this.size(1&this._sizeFlag?this._width:null,e)}get _isWidthSet(){return!!(1&this._sizeFlag)}get _isHeightSet(){return!!(2&this._sizeFlag)}measureWidth(){return this._texture?this._texture.width:0}measureHeight(){return this._texture?this._texture.height:0}_isMaterialVaild(t){return t.checkType(e.ShaderFeatureType.D2_TextureSV)}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}get scaleX(){return this._scaleX}set scaleX(e){this.scale(e,this._scaleY)}get scaleY(){return this._scaleY}set scaleY(e){this.scale(this._scaleX,e)}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this._transChanged(e.TransformKind.Rotation))}get skewX(){return this._skewX}set skewX(e){this.skew(e,this._skewY)}get skewY(){return this._skewY}set skewY(e){this.skew(this._skewX,e)}get transform(){if(!this._tfChanged)return this._transform;this._tfChanged=!1;let e=this._transform||(this._transform=new Ce),t=this._scaleX,s=this._scaleY,r=this._skewX,i=this._skewY,a=this._rotation;if(a||1!==t||1!==s||0!==r||0!==i){e._bTransform=!0;let n=.0174532922222222*(a-r),o=.0174532922222222*(a+i),l=Math.cos(o),h=Math.sin(o),d=Math.sin(n),u=Math.cos(n);e.a=t*l,e.b=t*h,e.c=-s*d,e.d=s*u,e.tx=e.ty=0}else e.identity();return e}set transform(t){this._tfChanged=!1;let s=this._transform||(this._transform=new Ce);if(t!==s&&t.copyTo(s),t){let r=Ce.extractTransformInfo(t);this._x=r.x,this._y=r.y,this._scaleX=r.scaleX,this._scaleY=r.scaleY,this._skewX=r.skewX,this._skewY=r.skewY,this._rotation=r.rotation,s.tx=s.ty=0,this._transChanged(e.TransformKind.TRS)}this.parentRepaint()}get globalTrans(){return this._globalTrans}get pivotX(){return this._pivotX}set pivotX(e){this.pivot(e,this._pivotY)}get pivotY(){return this._pivotY}set pivotY(e){this.pivot(this._pivotX,e)}get anchorX(){return this._anchorX}set anchorX(e){this.anchor(e,this._anchorY)}get anchorY(){return this._anchorY}set anchorY(e){this.anchor(this._anchorX,e)}get alpha(){return this._alpha}set alpha(e){e=e<0?0:e>1?1:e,this._alpha!==e&&(this._alpha=e,this._struct.alpha=e,this.repaint())}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._processVisible())}get blendMode(){return 0===this._blendMode?null:e.BlendMode[this._blendMode]}set blendMode(t){let s=e.BlendMode[t];"number"!=typeof s&&(s="destination-out"===t?e.BlendMode.destinationOut:0),this._blendMode!=s&&(this._blendMode=s,this._initShaderData(),this._struct.blendMode=this._blendMode,this.repaint(e.RepaintFlag.Graphics))}get layer(){return this._layer}set layer(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e,this._struct.renderLayer=1<<e}}get graphics(){return this._graphics||(this.graphics=new Ni,this._ownGraphics=!0),this._graphics}set graphics(e){this.setGraphics(e,!1)}setGraphics(t,s){let r=this._graphics;this._graphics=null,r&&(this._ownGraphics?r.destroy():(r._data=null,r.owner=null,r._checkDisplay())),this._ownGraphics=s,this._graphics=t,t?(this._graphicsData?this._graphicsData.clear():this._graphicsData=new Ca(this),t._data=this._graphicsData,t.owner=this,t._checkDisplay()):(this._graphicsData&&(this._graphicsData.destroy(),this._graphicsData=null),this._renderType&=~$e.GRAPHICS),this.repaint(e.RepaintFlag.Graphics)}get filters(){return this._filterArr}set filters(e){if(e&&0===e.length&&(e=null),this._filterArr=e,e){let e=this.getPostProcess(!0);e.clear();for(let t of this._filterArr)e.addEffect(t.getEffect())}else this.postProcess=null;this.repaint()}getPostProcess(e=!0){if(!this._oriRenderPass||!this._oriRenderPass.postProcess){if(!e)return null;this.postProcess=new Xa}return this._oriRenderPass.postProcess}get postProcess(){return this.getPostProcess(!1)}set postProcess(t){var s;if(null===(s=this._oriRenderPass)||void 0===s?void 0:s.postProcess){if(this._oriRenderPass.postProcess===t)return;this._oriRenderPass.postProcess.owner=null,this._oriRenderPass.postProcess=null,this.setSubpassFlag(e.SubPassFlag.PostProcess)}t&&(this._oriRenderPass||this.createSubRenderPass(),t.owner=this,this._oriRenderPass.postProcess=t,this.setSubpassFlag(e.SubPassFlag.PostProcess))}get cacheAs(){return this._cacheAsBmp?"bitmap":"none"}set cacheAs(t){let s="bitmap"===t;s!==this._cacheAsBmp&&(this._cacheAsBmp=s,s?this._renderType|=$e.CANVAS:this._renderType&=~$e.CANVAS,this.setSubpassFlag(e.SubPassFlag.CacheAsBitmap),this.repaint(e.RepaintFlag.Graphics))}get mask(){return this._mask}set mask(t){if(!(t==this||t&&this._mask==t&&t._maskParent==this)){if(t&&t.isAncestorOf(this))throw new Error("Mask cannot be ancestor of the masked object");this._mask&&(this._mask.cacheAs="none",this._mask._maskParent=null),this._mask=t,t?(t._maskParent=this,t.cacheAs="bitmap",this._renderType|=$e.MASK):this._renderType&=~$e.MASK,this.setSubpassFlag(e.SubPassFlag.Mask),this.repaint()}}clearSubpassFlag(e){this._subpassUpdateFlag&=~e}setSubpassFlag(e){this._subpassUpdateFlag|=e,this._needUpdateSubpass()&&(this.stage._subpassUpdateList.add(this),this._globalTrans._notifyRenderSpriteTransChange())}_needUpdateSubpass(){let e=this._maskParent||this;return e.displayedInStage&&e._struct.enabled}get scrollRect(){return this._scrollRect}set scrollRect(t){null==this._scrollRect&&null==t||(this._scrollRect=t,t?this._renderType|=$e.CLIP:this._renderType&=~$e.CLIP,this._struct.setClipRect(t),this._oriRenderPass&&(this._oriRenderPass.repaint=!0),this._globalTrans._spTransChanged(e.TransformKind.Layout),this.repaint())}get viewport(){return null}set viewport(e){}set drawCallOptimize(t){this._struct.dcOptimize!==t&&(this._struct.dcOptimize=t,this._struct.setRepaint(),this.parentRepaint(),t&&this._globalTrans._spTransChanged(e.TransformKind.Layout))}get drawCallOptimize(){return this._struct.dcOptimize}set enableCulling(t){this._struct.enableCulling!==t&&(this._struct.enableCulling=t,this._struct.setRepaint(),this.parentRepaint(),t&&this._globalTrans._spTransChanged(e.TransformKind.Layout))}get enableCulling(){return this._struct.enableCulling}get hitArea(){return this._hitArea}set hitArea(e){this._hitArea=e}get mouseEnabled(){return 2===this._mouseState}set mouseEnabled(e){let t=e?2:1;this._mouseState!==t&&(this._mouseState=t,2===t&&this.setMouseEnabledUp())}setMouseEnabledUp(){let e=this._parent;for(;e&&e!==l.stage&&0===e._mouseState&&e._setBit(we.CHECK_INPUT,!0);)e=e._parent}getMousePoint(){return this.globalToLocal($a.setTo(l.stage.mouseX,l.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get globalScaleX(){return this.globalTrans.scaleX}get globalScaleY(){return this.globalTrans.scaleY}get zOrder(){return this._zOrder}set zOrder(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(we.HAS_ZORDER,!0),l.systemTimer.callLater(this._parent,this.updateZOrder)))}get zIndex(){return this._struct.zIndex}set zIndex(e){this._struct.zIndex!==e&&(this._struct.zIndex=e,this.parentRepaint())}get stackingRoot(){return this._struct.stackingRoot}set stackingRoot(e){this._struct.stackingRoot=e}updateZOrder(){let e=this._$children;if(!e||e.length<2)return;let t,s,r,i,a=1,n=e.length,o=this._struct.children;for(;a<n;){for(t=a,r=e[t],i=o[t],s=e[t]._zOrder;--t>-1&&e[t]._zOrder>s;)e[t+1]=e[t],o[t+1]=o[t];e[t+1]=r,o[t+1]=i,a++}this._struct.children=o;let l=this._setBit(we.HAS_ZORDER,!1);this._childChanged(),l&&this._setBit(we.HAS_ZORDER,!0)}get texture(){return this._texture}set texture(e){this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e?(e._addReference(),this.graphics.repaint()):this._graphics?this._graphics.repaint():this.repaint())}get material(){var e;return null===(e=this._graphics)||void 0===e?void 0:e.material}set material(e){e&&!this._isMaterialVaild(e)||null==this._graphics&&null==e||(this.graphics.material=e)}get renderNode2D(){return this._renderNode}set renderNode2D(e){this._renderNode=e,e?(e.renderUpdate&&this._struct.setRenderUpdateCallback(e.renderUpdate.bind(e)),this._renderType|=$e.RENDERNODE2D):(this._struct.setRenderUpdateCallback(null),this._renderType&=~$e.RENDERNODE2D),this._graphics&&this._graphics.repaint()}get autoSize(){return this._autosize}set autoSize(e){this._autosize=e}pos(t,s){return this._x==t&&this._y==s||(this._x=t,this._y=s,this._transChanged(e.TransformKind.Pos)),this}pivot(t,s){if(this._pivotX!=t||this._pivotY!=s){this._pivotX=t,this._pivotY=s;let r=this.width;0!=r&&(this._anchorX=t/r),r=this.height,0!=r&&(this._anchorY=s/r),this._transChanged(e.TransformKind.Anchor)}return this}anchor(t,s){return this._anchorX==t&&this._anchorY==s||(this._anchorX=t,this._anchorY=s,this._pivotX=t*this.width,this._pivotY=s*this.height,this._transChanged(e.TransformKind.Anchor)),this}size(t,s){let r,i;return null==t?(r=!!(1&this._sizeFlag),this._sizeFlag&=-2):(r=this._width!=t||!(1&this._sizeFlag),this._width=t,this._pivotX=this._anchorX*t,this._sizeFlag|=1),null==s?(i=!!(2&this._sizeFlag),this._sizeFlag&=-3):(i=this._height!=s||!(2&this._sizeFlag),this._height=s,this._pivotY=this._anchorY*s,this._sizeFlag|=2),(r||i)&&this._transChanged((r?e.TransformKind.Width:0)|(i?e.TransformKind.Height:0)),this}scale(t,s){return this._scaleX===t&&this._scaleY===s||(this._scaleX=t,this._scaleY=s,this._transChanged(e.TransformKind.Scale)),this}skew(t,s){return this._skewX===t&&this._skewY===s||(this._skewX=t,this._skewY=s,this._transChanged(e.TransformKind.Skew)),this}_transChanged(t){var s;this._destroyed||(this._oriRenderPass&&(this._oriRenderPass.repaint=!0),t!==e.TransformKind.Pos&&t!==e.TransformKind.Anchor?(this._tfChanged=!0,0!==(t&e.TransformKind.Size)&&this._graphics?this._graphics.repaint():0!==(this._renderType&$e.DRAW2RT)?this.repaint():this.parentRepaint()):this.parentRepaint(),null===(s=this._maskParent)||void 0===s||s.repaint(e.RepaintFlag.ChildChange),(0!==(t&e.TransformKind.TRS)||0!==(t&e.TransformKind.Anchor)||0!==(t&e.TransformKind.Size)&&(0!==this._anchorX||0!==this._anchorY||this._struct.inheritedDcOptimize))&&(this._globalTrans._spTransChanged(t),this._getBit(we.DEMAND_TRANS_EVENT)&&Za(this)))}drawToCanvas(e,t,s,r){return ja.drawToCanvas(this,e,t,s,r)}static drawToCanvas(e,t,s,r,i){let a=ja.drawToRenderTexture2D(e,t,s,r,i,null);for(var n=a.getData(0,0,t,s),o=new ImageData(t,s),l=4*t,h=o.data,d=s-1,u=d*l,c=0;d>=0;d--)h.set(n.subarray(c,c+l),u),u-=l,c+=l;let _=new Re;return _.size(t,s),_.context.putImageData(o,0,0),a.destroy(),_}drawToTexture(e,t,s,r,i=null,a=!0){return ja.drawToTexture(this,e,t,s,r,i,a)}static drawToTexture(e,t,s,r,i,a=null,n=!0){return ja.drawToRenderTexture2D(e,t,s,r,i,a,n)}drawToRenderTexture2D(e,t,s,r,i,a,n,o,l=1,h=1){return ja.drawToRenderTexture2D(this,e,t,s,r,i,a,n,o,l,h)}static drawToRenderTexture2D(t,s,r,i,a,n,o,l,h,d=1,u=1){let c=n||new zi(s,r,e.RenderTargetFormat.R8G8B8A8);c._invertY=l,f.renderEngine._screenInvertY&&(c._invertY=!c._invertY);let _=pi.runner,p=new Set,g=new pi;const m=function(t){if(t._struct&&t._struct.enabled){if(t._subpassUpdateFlag&&(t.updateSubRenderPassState(),t._oriRenderPass)){let s=t.updateRenderTexture(),r=t._drawOriRT;if(r){t._oriRenderPass.renderTexture=r,t.mask?t._oriRenderPass.mask=t.mask._struct:t._oriRenderPass.mask=null,s&&(t._oriRenderPass.renderTexture=r);let i=t._renderType&$e.POSTPROCESS?t.postProcess:null;i&&r!=zi._empty&&((s||t._subpassUpdateFlag&e.SubPassFlag.UPDATE_POSTPROCESS)&&(i.setResource(r),i.clearCMD(),i._render()),i.enabled&&(r=i._context.destination)),t._subStructRender._updateRenderTexture(t._drawOriRT,r),t._subpassUpdateFlag=0}else t.setSubRenderPassState(!1)}t._struct&&(t._updateStruct(),t._struct.pass&&p.add(t._struct.pass)),t._graphics&&t._graphics._render(_,0,0);for(let e=0,s=t._children.length;e<s;e++)m(t._children[e])}};m(t);let T=g.basePass;h&&(T.setClearColor(h.r,h.g,h.b,h.a),T.doClearColor=!0),T.renderTexture=c;let y=t._oriRenderPass&&t._oriRenderPass.enable?t._subStruct:t._struct;T.root=y;let x=T.offsetMatrix;x.identity();let S=t.transform;S&&S.copyTo(x),x.scale(d,u),x.invert(),x.tx=-i,x.ty=-a,T.offsetMatrix=x;for(let e of p)e.priority>0&&g.addPass(e);return g.apply(pi.rendercontext2D),g.clear(),T.destroy(),c}hitTestPoint(e,t){let s=this.globalToLocal($a.setTo(e,t));return e=s.x,t=s.y,(this._hitArea?this._hitArea:this._isWidthSet&&this._isHeightSet?Ka.setTo(0,0,this._width,this._height):this.getGraphicBounds(!1,Ka)).contains(e,t,this)}setSelfBounds(e){this._userBounds=e}getBounds(e){return e=this.getSelfBounds(e,!0),pa.transformRect(this,e,this._parent,e)}getSelfBounds(e,t){var s;if(null==t&&(t=!0),null!=this._userBounds)return this._userBounds.clone(e);if(null==this._scrollRect||this._getBit(we.DISABLE_INNER_CLIPPING)){if(!t&&(null===(s=this._oriRenderPass)||void 0===s?void 0:s.enable))return this._subStructRender._rtRect.clone(e);if(e=this.getGraphicBounds(!1,e),t&&this._children.length>0){let t=te.create();for(let s of this._children)s._struct.enabled&&s._maskParent!=this&&(s.getBounds(t),e.union(t,e));t.recover()}return e}return this._scrollRect.clone(e)}getGraphicBounds(e,t){if(t?t.setTo(0,0,0,0):t=new te,null!=this._graphics&&t.union(this._graphics.getBounds(),t),null!=this._texture&&t.union(Ka.setTo(0,0,this._width||this._texture.width,this._height||this._texture.height),t),null!=this._renderNode){let e=this._renderNode.rect;te.minMaxRect(e.x,e.y,e.z,e.w,Ka),t.union(Ka,t),Ka.setTo(0,0,this._width,this._height),t.union(Ka,t)}return t}localToGlobal(e,t,s){t&&(e=new u(e.x,e.y));let r=this;for(s=s||l.stage;r&&!r._destroyed&&r!=s;)e=r.toParentPoint(e),r=r._parent;return e}globalToLocal(e,t,s){t&&(e=new u(e.x,e.y));let r=this;for(Qa.length=0,s=s||l.stage;r&&!r._destroyed&&r!=s;)Qa.push(r),r=r._parent;let i=Qa.length-1;for(;i>=0;)r=Qa[i],e=r.fromParentPoint(e),i--;return e}toParentPoint(e){var t;if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,null===(t=this.transform)||void 0===t||t.transformPoint(e),e.x+=this._x,e.y+=this._y;let s=this._scrollRect;return s&&(e.x-=s.x*this._scaleX,e.y-=s.y*this._scaleY),e}fromParentPoint(e){var t;if(!e)return e;e.x-=this._x,e.y-=this._y;var s=this._scrollRect;return s&&(e.x+=s.x*this._scaleX,e.y+=s.y*this._scaleY),null===(t=this.transform)||void 0===t||t.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}loadImage(e,t){if(e){let s=l.loader.getRes(e);s?(this.texture=s,t&&t.run()):(this._skinBaseUrl&&(e=ee.formatURL(e,this._skinBaseUrl)),l.loader.load(e).then(e=>{this.texture=e,t&&t.run()}))}else this.texture=null,t&&t.run();return this}static fromImage(e){return(new ja).loadImage(e)}reCache(){(this._cacheAsBmp||this._mask)&&this.repaint()}getRepaint(){return this._repaint}repaint(t){this._destroyed||((this._repaint<Vi.loopCount||this._repaint===Vi.loopCount&&this._repaintCount<Vi.render2DCount||!this._previousType)&&(this._repaint=Vi.loopCount,this._repaintCount=Vi.render2DCount,this._previousType=this._renderType,this._struct.setRepaint(),this.stage._graphicUpdateList.add(this),this.parentRepaint(),this._renderType&$e.DRAW2RT&&(!this._drawOriRT||this._subpassUpdateFlag||t&e.RepaintFlag.UpdateRT||this.transform&&this._maskParent)&&this.setSubpassFlag(e.SubPassFlag.RenderTexture),this._renderType&$e.GRAPHICS&&(t&e.RepaintFlag.Graphics&&this._graphics&&(this._graphics._modified=!0),this._globalTrans._notifyRenderSpriteTransChange())),this._maskParent&&(this._maskParent.setSubpassFlag(e.SubPassFlag.Mask),this._maskParent.repaint(t)))}_needGraphicsUpdate(){return!this._destroyed&&this._struct.enabled&&this._graphics&&this._graphics._display&&!(!this.displayedInStage&&!this._maskParent)}clearRepaint(){this._repaint=-1,this._repaintCount=-1}_needRepaint(){return!!(this._repaint>=Vi.loopCount&&this._repaintCount>=f.renderEngine._framePassCount&&0===this._previousType)}parentRepaint(){let t=this._parent;if(!t)return;let s=t._struct,r=s?s.pass:null;s&&r&&(r.renderTexture?(t.parentRepaint(),t._renderType&$e.DRAW2RT&&!t._needRepaint()&&(t.setSubpassFlag(e.SubPassFlag.RenderTexture),s.setRepaint())):s.setRepaint())}get dragSupport(){return this._dragSupport||(this._dragSupport=new ca(this))}startDrag(e,t,s,r,i,a){let n=this.dragSupport;null!=e?n.area.copyFrom(e):n.area.reset(),n.hasInertia=!!t,null!=s&&(n.elasticDistance=s),null!=r&&(n.elasticBackTime=r),null!=a&&(n.ratio=a),n.start(i)}stopDrag(){this._dragSupport&&this._dragSupport.stop()}onAfterDeserialize(){super.onAfterDeserialize(),p.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters)),2===this._mouseState&&this.setMouseEnabledUp()}onStartListeningToType(e){super.onStartListeningToType(e),c.isMouseEvent(e)?0===this._mouseState&&(this._setBit(we.CHECK_INPUT,!0),this.setMouseEnabledUp()):e===c.TRANSFORM_CHANGED&&(this._setBit(we.DEMAND_TRANS_EVENT,!0),this.setDemandTransEventUp())}setDemandTransEventUp(){let e=this._parent;for(;e&&e!==l.stage&&e._setBit(we.DEMAND_TRANS_EVENT,!0);)e=e._parent}_processVisible(){let e=this._visible&&!this._getBit(qa);return!(!this._struct||this._struct.enabled===e)&&(this._struct.enabled=e,e?this.repaint():this._struct.setRepaint(),this.parentRepaint(),this._checkSubRenderPass(),this._refreshRenderPass(),!0)}_setUnBelongScene(){null!=this._ownerArea&&(this._ownerArea=null),super._setUnBelongScene()}_setBelongScene(e){super._setBelongScene(e),this._findOwnerArea()}_findOwnerArea(){let e=this;for(;e&&e!==this._scene&&e!==l.stage;){if(e._globalRenderData){this._ownerArea=e;break}e=e._parent}}_setStructParent(e){let t=this._struct;if(t&&t.parent&&(t.parent.removeChild(t),t.parent=null),e&&e._struct){let s=e._children.indexOf(this);e._struct.addChild(t,s)}}createSubRenderPass(){let e=f.render2DRenderPassFactory.createRender2DPass();e.root=this._struct,e.enable=!1,e.setClearColor(0,0,0,0);let t=f.render2DRenderPassFactory.createRenderStruct2D();t.owner=this,t.pass=e,this._subStructRender=new Ra,this._subStructRender.bind(this,e,t),this._subStruct=t,this._oriRenderPass=e,t.renderMatrix=this.globalTrans.getMatrix()}updateRenderTexture(){let s=te.create(),r=te.create();this._mask?(pa.getRect(this._mask,!1,s),this._mask.transform&&s.transform(this._mask.transform,s),s.x+=this._mask._pivotX,s.y+=this._mask._pivotY):(pa.getRect(this,!1,s),this._maskParent&&this.transform&&s.transform(this.transform,s),s.x+=this._pivotX,s.y+=this._pivotY);let i=1,a=1,n=this._drawOriRT,o=this._subStructRender._rtRect;if(s.width=ut.roundTo(s.width),s.height=ut.roundTo(s.height),s.cloneTo(r),t.useRetinalCanvas&&(i=l.stage._scaleX,a=l.stage._scaleY,s.width=Math.round(s.width*i),s.height=Math.round(s.height*a),s.x=s.x*i,s.y=s.y*a),n){if(o.width===s.width&&o.height===s.height)return this._subStructRender._updateRenderOffset(s,r,i,a),s.recover(),r.recover(),!1;n!==zi._empty&&zi.recoverToPool(n)}if(this._subStructRender._updateRenderOffset(s,r,i,a),0===s.width||0===s.height)this._drawOriRT=zi._empty;else{let t=zi.createFromPool(s.width,s.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);t._invertY=f.renderEngine._screenInvertY,this._drawOriRT=t}return s.recover(),r.recover(),!0}updateSubRenderPassState(){this.setSubRenderPassState(0!==(this._renderType&$e.DRAW2RT))}_updateStruct(){let e=this.globalTrans;if(this._destroyed||!e)return;let t=e.getMatrix(),s=this._struct;this._struct.renderMatrix=t,this._subStruct&&(this._subStruct.renderMatrix=t);let r=s.rect;this._struct.inheritedEnableCulling||this._struct.inheritedDcOptimize?(this.getSelfBounds(r,!1),r.transform(t,r),s.rect=r):s.rect.reset(),this._subStruct&&(r.cloneTo(this._subStruct.rect),this._subStruct.rect=this._subStruct.rect)}setSubRenderPassState(t){if(!this._oriRenderPass){if(!t)return;this.createSubRenderPass()}t&&!this._oriRenderPass.enable?(this._struct.pass=this._oriRenderPass,this._struct.subStruct=this._subStruct,this._subStruct.enabled=!0,this._maskParent&&(this._subStruct.blendMode=e.BlendMode.mask)):!t&&this._oriRenderPass&&this._oriRenderPass.enable&&(this._struct.pass=null,this._subStruct.enabled=!1,this._subStruct.blendMode=this._blendMode,this._struct.subStruct=null,this._struct.setRepaint()),this._oriRenderPass.enable=t,this._refreshRenderPass()}_setParent(t){this._globalTrans._spTransChanged(e.TransformKind.TRS),super._setParent(t),this._setStructParent(t),t&&(2===this._mouseState||0===this._mouseState&&this._getBit(we.CHECK_INPUT))&&!t._getBit(we.CHECK_INPUT)&&this.setMouseEnabledUp(),t&&this._getBit(we.DEMAND_TRANS_EVENT)&&!t._getBit(we.DEMAND_TRANS_EVENT)&&this.setDemandTransEventUp()}_checkSubRenderPass(){this._needUpdateSubpass()?(this._subpassUpdateFlag||this._renderType&$e.DRAW2RT&&!this._drawOriRT)&&this.setSubpassFlag(e.SubPassFlag.RenderTexture):this._subpassUpdateFlag&&l.stage._subpassUpdateList.delete(this),this._mask&&this._mask._checkSubRenderPass()}_refreshRenderPass(){if(this._oriRenderPass){this._needUpdateSubpass()&&this._oriRenderPass.enable&&this._renderType&$e.DRAW2RT?l.stage.passManager.addPass(this._oriRenderPass):(this._drawOriRT&&this._drawOriRT!==zi._empty&&zi.recoverToPool(this._drawOriRT),this._drawOriRT=null,this._oriRenderPass.postProcess&&this._oriRenderPass.postProcess.recoverAllRTS(),this._oriRenderPass.repaint=!0,l.stage.passManager.removePass(this._oriRenderPass))}this._mask&&(this._mask._refreshRenderPass(),this._mask.displayedInStage||this._mask.repaint(e.RepaintFlag.Graphics))}_setDisplay(e){super._setDisplay(e),this._needGraphicsUpdate()&&(this._graphics&&(this._graphics._modified=!0),this.stage._graphicUpdateList.add(this),this._globalTrans._notifyRenderSpriteTransChange()),this._checkSubRenderPass(),this._refreshRenderPass()}_setChildIndex(e,t,s){let r=super._setChildIndex(e,t,s);return e._struct&&e._parent._struct.updateChildIndex(e._struct,t,r),r}_childChanged(t){super._childChanged(t),t&&t._zOrder&&this._setBit(we.HAS_ZORDER,!0),this._getBit(we.HAS_ZORDER)&&l.systemTimer.callLater(this,this.updateZOrder),this.repaint(e.RepaintFlag.ChildChange)}_addComponentInstance(e){var t;e instanceof xa&&(null===(t=this._components)||void 0===t?void 0:t.some(e=>e instanceof xa))?console.warn(`${this.name} add RenderNode2D invalid, one sprite can only add one RenderNode`):super._addComponentInstance(e)}}const Ka=new te,$a=new u,Qa=[];function Za(e){e.event(c.TRANSFORM_CHANGED);for(let t of e._children)t._getBit(we.DEMAND_TRANS_EVENT)&&Za(t)}var Ja=!0;const en=new u,tn=new te,sn=[],rn=[];var an;class nn{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new ln(this._touches),this._pressKeys=new Set,this._keyEvent=new c,this._keyEvent._touches=this._touches}static get inst(){return an}static getTouchPos(e){var t;return null==e&&(e=nn.lastTouchId),(null===(t=an.getTouch(e))||void 0===t?void 0:t.pos)||an._mouseTouch.pos}static get touchTarget(){return an._touchTarget}static get touches(){return an._touches}static get touchCount(){return an._touches.length}static cancelClick(e){null==e&&(e=nn.lastTouchId);let t=an.getTouch(e);t&&(t.clickCancelled=!0)}static hasKeyDown(e){return an._pressKeys.has(e)}static __init__(){let e=an=new nn;e._stage=l.stage;let t=Y.mainCanvas.source,s={passive:!1};t.oncontextmenu=()=>!1,t.addEventListener("mousedown",t=>{Y.onIE||t.cancelable&&t.preventDefault(),e.handleMouse(t,0)},s),t.addEventListener("mouseup",t=>{t.cancelable&&t.preventDefault(),e.handleMouse(t,1)},s),t.addEventListener("mousemove",t=>{t.cancelable&&t.preventDefault(),e.handleMouse(t,2)},s),t.addEventListener("mouseout",t=>{e.handleMouse(t,3)},s),t.addEventListener("touchstart",t=>{Ja||W.textInput.target||t.cancelable&&t.preventDefault(),e.handleTouch(t,0)},s),t.addEventListener("touchend",t=>{Ja||W.textInput.target||t.cancelable&&t.preventDefault(),Ja=!1,e.handleTouch(t,1)},s),t.addEventListener("touchmove",t=>{t.cancelable&&t.preventDefault(),e.handleTouch(t,2)},s),t.addEventListener("touchcancel",t=>{t.cancelable&&t.preventDefault(),e.handleTouch(t,3)},s),t.addEventListener("wheel",t=>{e.handleMouse(t,4)},s),"function"==typeof t.setPointerCapture&&(t.addEventListener("pointerdown",e=>{t.setPointerCapture(e.pointerId)}),t.addEventListener("pointerup",e=>{t.releasePointerCapture(e.pointerId)},!0));let r=Y.document;r.addEventListener("keydown",t=>{e.handleKeys(t)},!0),r.addEventListener("keypress",t=>{e.handleKeys(t)},!0),r.addEventListener("keyup",t=>{e.handleKeys(t)},!0)}handleMouse(e,t){this._eventType=t,this._nativeEvent=e,nn.lastTouchId=0;let s=performance.now();if(null!=this._lastTouchTime&&s-this._lastTouchTime<100)return;let r=this._mouseTouch;en.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform.invertTransformPoint(en),nn.mouseX=en.x,nn.mouseY=en.y;let i=en.x/this._stage.clientScaleX,a=en.y/this._stage.clientScaleY;if(r.event.nativeEvent=e,3!=t&&nn.mouseEventsEnabled){r.target=this._touchTarget=this.getNodeUnderPoint(i,a);let e=Math.round(i),t=Math.round(a);if((e!=r.pos.x||t!=r.pos.y)&&(nn.lastMouseTime=s,r.pos.setTo(e,t),r.move(),nn.mouseEventsEnabled)){r.bubble(c.MOUSE_MOVE);for(let e of r.downTargets)if(r.event._stopped=!1,e.event(c.MOUSE_DRAG,r.event),r.event._stopped)break}}else r.target=this._touchTarget=null;if(r.lastRollOver!=r.target&&this.handleRollOver(r),0==t)r.began||(r.begin(),this._touches[0]=r,r.event.button=e.button,r.downButton=e.button,nn.onMouseDownCapture.invoke(r.touchId),nn.mouseEventsEnabled&&(0==e.button?r.bubble(c.MOUSE_DOWN):r.bubble(c.RIGHT_MOUSE_DOWN)));else if(1==t){if(r.began&&e.button==r.downButton){if(r.end(),this._touches.length=0,r.event.button=e.button,nn.mouseEventsEnabled){if(0==e.button?r.bubble(c.MOUSE_UP):r.bubble(c.RIGHT_MOUSE_UP),r.moved)for(let e of r.downTargets)e.event(c.MOUSE_DRAG_END,r.event);let t=r.clickTest();t&&(0==e.button?(r.event.isDblClick=2==r.clickCount,r.bubble(c.CLICK,t),2==r.clickCount&&r.bubble(c.DOUBLE_CLICK,t),r.event.isDblClick=!1):(r.event.isDblClick=2==r.clickCount,r.bubble(c.RIGHT_CLICK,t),r.event.isDblClick=!1))}r.event.button=0}}else 4==t&&nn.mouseEventsEnabled&&(r.event.delta=.025*e.deltaY,r.bubble(c.MOUSE_WHEEL),r.event.delta=0)}handleTouch(e,t){this._eventType=t,this._nativeEvent=e,this._lastTouchTime=performance.now();let s=e.changedTouches;for(let r=0;r<s.length;++r){let i=s[r];if(!nn.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=i.identifier)continue;en.setTo(i.pageX,i.pageY),this._stage._canvasTransform.invertTransformPoint(en),nn.mouseX=en.x,nn.mouseY=en.y;let a=en.x/this._stage.clientScaleX,n=en.y/this._stage.clientScaleY,o=this.getTouch(i.identifier,0==t);if(o){if(o.event.nativeEvent=e,o.event.touchId=o.touchId,nn.lastTouchId=o.touchId,3!=t&&nn.mouseEventsEnabled){o.target=this._touchTarget=this.getNodeUnderPoint(a,n),nn.lastMouseTime=this._lastTouchTime;let e=Math.round(a),s=Math.round(n);if((Math.abs(e-o.pos.x)>1.5||Math.abs(s-o.pos.y)>1.5)&&(o.pos.setTo(e,s),2==t&&(o.move(),nn.mouseEventsEnabled))){o.bubble(c.MOUSE_MOVE);for(let e of o.downTargets)if(o.event._stopped=!1,e.event(c.MOUSE_DRAG,o.event),o.event._stopped)break}}else o.target=this._touchTarget=null;if(o.lastRollOver!=o.target&&this.handleRollOver(o),0==t)o.began||(o.begin(),nn.onMouseDownCapture.invoke(o.touchId),nn.mouseEventsEnabled&&o.bubble(c.MOUSE_DOWN));else if(1==t||3==t){if(o.began){if(o.end(),nn.mouseEventsEnabled){if(o.bubble(c.MOUSE_UP),o.moved)for(let e of o.downTargets)e.event(c.MOUSE_DRAG_END,o.event);if(3!=t){let e=o.clickTest();null!=e&&(o.event.isDblClick=2==o.clickCount,o.bubble(c.CLICK,e),2==o.clickCount&&o.bubble(c.DOUBLE_CLICK,e),o.event.isDblClick=!1)}}o.target=null,this.handleRollOver(o)}o.reset(),this._touches.splice(this._touches.indexOf(o),1),this._touchPool.push(o)}}}}getTouch(e,t){let s=this._touches.find(t=>t.touchId==e);return s||!t||(s=this._touchPool.length>0?this._touchPool.pop():new ln(this._touches),s.touchId=e,this._touches.push(s)),s}handleKeys(e){let t=e.type,s=e.keyCode;if("keydown"===t?(0!=s&&this._pressKeys.add(s),this._pressKeys.add(e.key)):"keyup"===t&&(0!=s&&this._pressKeys.delete(s),this._pressKeys.delete(e.key)),this._keyEvent.nativeEvent=e,this._keyEvent._defaultPrevented=!1,nn.keyEventsEnabled){let e=this._stage.focus&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,s=e;for(;s;)s.event(t,this._keyEvent.setTo(t,s,e)),s=s._parent}this._keyEvent._defaultPrevented&&e.preventDefault(),this._keyEvent.nativeEvent=null}getNodeUnderPoint(e,t){let s=this.getSpriteUnderPoint(this._stage,e,t);return s||(s=this.getSprite3DUnderPoint(e,t)),s||this._stage}getSpriteUnderPoint(e,t,s){0!==(e._renderType&$e.AREA2D)&&p.isPlaying&&(e.localToView(t,s,u.TEMP),t=u.TEMP.x,s=u.TEMP.y);let r=e._scrollRect;if(r&&!e._getBit(we.DISABLE_INNER_CLIPPING)&&(tn.setTo(r.x,r.y,r.width,r.height),!tn.contains(t,s)))return null;let i=e._getBit(we.EDITING_NODE);if(!i&&e.hitTestPrior&&!e.mouseThrough&&e!=this._stage&&!this.hitTest(e,t,s))return null;for(let r=e._children.length-1;r>-1;r--){let a=e._children[r],n=i||a._getBit(we.EDITING_NODE);if(!a._destroyed&&1!==a._nodeType&&(n?(!a.hasHideFlag(be.HideInHierarchy)||a.mouseThrough)&&!a._getBit(we.HIDE_BY_EDITOR):2===a._mouseState||0===a._mouseState&&a._getBit(we.CHECK_INPUT))&&a._struct.enabled){en.setTo(t,s),a.fromParentPoint(en);let e=this.getSpriteUnderPoint(a,en.x,en.y);if(e)return e}}if(i){if(!e._getBit(we.LOCK_BY_EDITOR)&&!e.hasHideFlag(be.HideInHierarchy)&&this.hitTest(e,t,s,i))return e}else if(e!=this._stage&&(e.hitTestPrior&&!e.mouseThrough||this.hitTest(e,t,s)))return e;return null}getSprite3DUnderPoint(e,t){return null}hitTest(e,t,s,r){let i=!1;e._scrollRect&&(t-=e._scrollRect.x,s-=e._scrollRect.y);let a=e._hitArea,n=e.mouseThrough;return r&&(a=null,n=!1),a?a.contains(t,s,e):((e.width>0&&e.height>0||n||a)&&(i=n?e.getGraphicBounds(!1,te.TEMP).contains(t,s):(a||tn.setTo(0,0,e.width,e.height)).contains(t,s,e)),i)}handleRollOver(e){if(!nn.mouseEventsEnabled)return void(e.lastRollOver=e.target);sn.length=0,rn.length=0;let t=e.lastRollOver;for(;t;)rn.push(t),t=t._parent;for(e.lastRollOver=e.target,t=e.target;t;){let e=rn.indexOf(t);if(-1!=e){rn.splice(e,rn.length-e);break}sn.push(t),t=t._parent}let s=rn.length;if(s>0){for(let r=0;r<s;r++)t=rn[r],t._destroyed||t.event(c.MOUSE_OUT,e.event.setTo(c.MOUSE_OUT,t,t));rn.length=0}if(s=sn.length,s>0){for(let r=0;r<s;r++)t=sn[r],t.activeInHierarchy&&t.event(c.MOUSE_OVER,e.event.setTo(c.MOUSE_OVER,t,t));sn.length=0}}}nn.multiTouchEnabled=!0,nn.mouseEventsEnabled=!0,nn.keyEventsEnabled=!0,nn.clickTestThreshold=10,nn.mouseX=0,nn.mouseY=0,nn.lastMouseTime=0,nn.lastTouchId=0,nn.onMouseDownCapture=new B;const on={};class ln{constructor(e){this.downPos=new u,this.downTargets=[],this.bubbleChain=[],this.event=new c,this.event._touches=e,this.pos=this.event.touchPos,this.touchId=0,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let e=this.target;for(;e;)this.downTargets.push(e),e=e._parent}}move(){this.moved=!0;let e=Math.abs(this.pos.x-this.downPos.x)*l.stage._canvasTransform.getScaleX(),t=Math.abs(this.pos.y-this.downPos.y)*l.stage._canvasTransform.getScaleY();(e>nn.clickTestThreshold||t>nn.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let e=performance.now(),t=on[this.touchId];t||(t={pos:new u,time:0,button:0},on[this.touchId]=t),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>nn.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>nn.clickTestThreshold?(this.clickCancelled=!0,t.time=0,this.clickCount=1):(e-t.time<350&&Math.abs(this.pos.x-t.pos.x)<nn.clickTestThreshold&&Math.abs(this.pos.y-t.pos.y)<nn.clickTestThreshold&&t.button==this.event.button?this.clickCount=2:this.clickCount=1,t.time=e,t.pos.copy(this.pos),t.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let e=this.downTargets[0];if(e.activeInHierarchy)return this.downTargets.length=0,e;for(e=this.target;e;){if(-1!=this.downTargets.indexOf(e)&&e.activeInHierarchy)break;e=e._parent}return this.downTargets.length=0,e}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1,this.downButton=0}bubble(e,t){let s=this.bubbleChain;s.length=0;let r=t=t||this.target||l.stage;for(;r;)r.activeInHierarchy&&s.push(r),r=r._parent;let i=this.event;i._stopped=!1;for(let r of s)if(i.setTo(e,r,t),r.event(e,i),i._stopped){if(e===c.MOUSE_DOWN||e===c.RIGHT_MOUSE_DOWN){let e=this.downTargets.indexOf(r);-1!=e&&this.downTargets.splice(e+1,this.downTargets.length-e-1)}break}if(e===c.MOUSE_UP||e===c.RIGHT_MOUSE_UP)for(let r of this.downTargets)if(r&&-1==s.indexOf(r)&&(i.setTo(e,r,t),r.event(e,i),i&&i._stopped))break}}class hn{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let e of this._toStarts)if(2==e._status){e._status=3;try{e.onStart()}catch(e){this.onError(e)}}this._toStarts.clear()}callUpdate(){let t=performance.now();for(let e of this._onUpdates)if(3==e._status)try{e.onUpdate()}catch(e){this.onError(e)}f.statAgent.recordTimeData(e.StatElement.T_ScriptUpdateTime,performance.now()-t)}callLateUpdate(){let t=performance.now();for(let e of this._onLateUpdates)if(3==e._status)try{e.onLateUpdate()}catch(e){this.onError(e)}f.statAgent.recordTimeData(e.StatElement.T_ScriptLateUpdateTime,performance.now()-t)}callPreRender(){for(let e of this._onPreRenders)if(3==e._status)try{e.onPreRender()}catch(e){this.onError(e)}}callPostRender(){for(let e of this._onPostRenders)if(3==e._status)try{e.onPostRender()}catch(e){this.onError(e)}}callDestroy(){for(let e of this._toDestroys)try{e._destroy(!0)}catch(e){this.onError(e)}this._toDestroys.clear()}add(e){1==e._status&&(e.onStart?(e._status=2,this._toStarts.add(e)):e._status=3),e.onUpdate&&this._onUpdates.add(e),e.onLateUpdate&&this._onLateUpdates.add(e),e.onPreRender&&this._onPreRenders.add(e),e.onPostRender&&this._onPostRenders.add(e)}remove(e){2==e._status&&(e._status=1),e.onUpdate&&this._onUpdates.delete(e),e.onLateUpdate&&this._onLateUpdates.delete(e),e.onPreRender&&this._onPreRenders.delete(e),e.onPostRender&&this._onPostRenders.delete(e)}destroy(){}onError(e){console.error(e)}}class dn{constructor(e,t){this.scale=1,this.currFrame=0,this.delta=0,this.unscaledDelta=0,this._map={},this._handlers=[],(e||null==e)&&dn.gSysTimer&&dn.gSysTimer.frameLoop(1,this,this._update),this.currTimer=performance.now(),this._lastTimer=performance.now(),this._greedy=!!t}get totalTime(){return this._lastTimer}_update(e){if(null==e&&(e=performance.now()),this.scale<=0)return this._lastTimer=e,void(this.delta=0);let t=this.currFrame=this.currFrame+this.scale;this.unscaledDelta=e-this._lastTimer;let s=this.unscaledDelta>3e4;this.delta=this.unscaledDelta*this.scale;let r=this.currTimer=this.currTimer+this.delta;this._lastTimer=e;let i=this._handlers,a=0;for(let e=0,n=i.length-1;e<=n;e++){let o=i[e];if(o.method){let e=o.userFrame?t:r;if(e>=o.exeTime)if(o.repeat)if(!o.jumpFrame||s)o.exeTime+=o.delay,o.run(!1),e>o.exeTime&&(o.exeTime+=Math.ceil((e-o.exeTime)/o.delay)*o.delay);else for(;e>=o.exeTime;)o.exeTime+=o.delay,o.run(!1);else o.run(!0)}else a++;e===n&&this._greedy&&(n=i.length-1)}(a>30||t%200==0)&&this._clearHandlers()}_clearHandlers(){let e=this._handlers,t=0;for(let s=0,r=e.length;s<r;s++){let r=e[s];null!==r.method?t!==s?e[t++]=r:t++:(this._map[r.key]==r&&delete this._map[r.key],r.clear(),dn._pool.push(r))}e.length=t}_create(e,t,s,r,i,a,n){let o=Q.getGID(r,i);if(null==n||n){let n=this._map[o];if(n)return n.repeat=t,n.userFrame=e,n.delay=s,n.caller=r,n.method=i,n.args=a,n.exeTime=s+(e?this.currFrame:this.currTimer+performance.now()-this._lastTimer),n}let l=dn._pool.length>0?dn._pool.pop():new un;return l.key=o,l.repeat=t,l.userFrame=e,l.delay=s,l.caller=r,l.method=i,l.args=a,l.exeTime=s+(e?this.currFrame:this.currTimer+performance.now()-this._lastTimer),this._map[o]=l,this._handlers.push(l),l}once(e,t,s,r,i){this._create(!1,!1,e,t,s,r,i)}loop(e,t,s,r,i,a){let n=this._create(!1,!0,e,t,s,r,i);n&&(n.jumpFrame=a)}frameOnce(e,t,s,r,i){this._create(!0,!1,e,t,s,r,i)}frameLoop(e,t,s,r,i){this._create(!0,!0,e,t,s,r,i)}toString(){return" handlers:"+this._handlers.length+" pool:"+dn._pool.length}clear(e,t){let s=this._map[Q.getGID(e,t)];s&&s.clear()}clearAll(e){if(e)for(let t=0,s=this._handlers.length;t<s;t++){let s=this._handlers[t];s.caller===e&&s.clear()}}callLater(e,t,s){dn.callLaters._create(!1,!1,0,e,t,s,!0).exeTime=0}runCallLater(e,t,s){!dn.callLaters.runTimer(e,t)&&s&&t.apply(e)}clearCallLater(e,t){dn.callLaters.clear(e,t)}runTimer(e,t){let s=this._map[Q.getGID(e,t)];return!(!s||null==s.method)&&(this._map[s.key]=null,s.run(!0),!0)}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(let e=0,t=this._handlers.length;e<t;e++){this._handlers[e].clear()}this._handlers.length=0}}dn.gSysTimer=null,dn.callLaters=new dn(!1,!0),dn._pool=[];class un{clear(){this.caller=null,this.method=null,this.args=null}run(e){let t=this.caller;if(t&&t.destroyed)return this.clear();let s=this.method,r=this.args;e&&this.clear(),null!=s&&(r?s.apply(t,r):s.call(t))}}class cn extends ja{constructor(){super(),this.offset=new u,this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new Ce,this._scene3Ds=[],this._scene2Ds=[],this._frameRate="fast",this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="gray",this._renderCount=0,this._frameStartTime=0,this._wgColor=new y(0,0,0,0),this._needUpdateCanvasSize=!1,this._graphicUpdateList=new Set,this._subpassUpdateList=new Set,this._tranMatrixUpdateList=new Set,this.mouseEnabled=!0,this.hitTestPrior=!0,this._setBit(we.DISPLAYED_INSTAGE,!0),this._setBit(we.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._transform=new Ce,this._componentDriver=new hn,this.passManager=new pi,W.browser.on(c.FOCUS,()=>{this._isFocused||(this._isFocused=!0,this.event(c.FOCUS),this.event(c.FOCUS_CHANGE))}),W.browser.on(c.BLUR,()=>{this._isFocused&&(this._isFocused=!1,this.event(c.BLUR),this.event(c.FOCUS_CHANGE))}),W.browser.on(c.VISIBILITY_CHANGE,e=>{this.renderingEnabled=e,this.event(c.VISIBILITY_CHANGE,e)}),W.browser.on(c.RESIZE,()=>{W.textInput.target||this.screenAdaptationEnabled&&(this.event(c.WILL_RESIZE),this.updateCanvasSize(!0))}),W.browser.on(c.ORIENTATION_CHANGE,e=>{this.screenAdaptationEnabled&&(this.event(c.WILL_RESIZE),this.updateCanvasSize(!0))}),this.passManager.basePass.root=this._struct,this._struct.pass=this.passManager.basePass}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Size)&&(this.designWidth=this._width,this.designHeight=this._height,this.updateCanvasSize(!0))}measureWidth(){return this.needUpdateCanvasSize(),this._width}measureHeight(){return this.needUpdateCanvasSize(),this._height}get isFocused(){return this._isFocused}get isVisibility(){return W.browser.getVisibility()}updateCanvasSize(e){e?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,l.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(Y.clientWidth*Y.pixelRatio,Y.clientHeight*Y.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(e,s){var r;this._needUpdateCanvasSize=!1;let i=Y.pixelRatio;if(e/=i,s/=i,this._screenMode!==cn.SCREEN_NONE){let t=e/s<1?cn.SCREEN_VERTICAL:cn.SCREEN_HORIZONTAL;if(this.canvasRotation=t!==this._screenMode,this.canvasRotation){let t=s;s=e,e=t}}else this.canvasRotation=!1;let a=Y.mainCanvas,n=this._canvasTransform.identity(),o=this._scaleMode,h=this.designWidth,d=this.designHeight,u=1;switch(Y.isDomSupported||o!==cn.SCALE_NOSCALE&&o!=cn.SCALE_SHOWALL&&o!==cn.SCALE_NOBORDER||(o=cn.SCALE_FIXED_AUTO),o){case cn.SCALE_NOSCALE:break;case cn.SCALE_FULL:h=e,d=s;break;case cn.SCALE_SHOWALL:u=Math.min(e/h,s/d);break;case cn.SCALE_NOBORDER:u=Math.max(e/h,s/d);break;case cn.SCALE_FIXED_WIDTH:case cn.SCALE_FIXED_HEIGHT:case cn.SCALE_FIXED_AUTO:o===cn.SCALE_FIXED_WIDTH||o===cn.SCALE_FIXED_AUTO&&e/s<h/d?(u=e/h,d=s/u):(u=s/d,h=e/u)}if(this._width=h,this._height=d,!t.useRetinalCanvas&&Y.isDomSupported||(h*=u,d*=u,u=1,i>4&&Y.isDomSupported&&(i=4),h*=i,d*=i,u/=i),n.scale(u,u),Y.isDomSupported){let t=0,r=0;t=this._alignH===cn.ALIGN_LEFT?0:this._alignH===cn.ALIGN_RIGHT?e-h*u:.5*(e-h*u),r=this._alignV===cn.ALIGN_TOP?0:this._alignV===cn.ALIGN_BOTTOM?s-d*u:.5*(s-d*u),t+=this.offset.x,r+=this.offset.y,n.translate(Math.round(t),Math.round(r))}if(this.canvasRotation?this._screenMode===cn.SCREEN_HORIZONTAL?(n.rotate(Math.PI/2),n.translate(s,0),this.canvasDegree=90):(n.rotate(-Math.PI/2),n.translate(0,e),this.canvasDegree=-90):this.canvasDegree=0,n.a=pn(n.a),n.d=pn(n.d),n.tx=pn(n.tx),n.ty=pn(n.ty),h=Math.round(h),d=Math.round(d),a.size(h,d),Y.isDomSupported){let e=Y.mainCanvas.source.style;W.browser.setStyleTransformOrigin(e,"0px 0px 0px"),W.browser.setStyleTransform(e,"matrix("+n.toString()+")"),e.width=h+"px",e.height=d+"px",n.translate(parseInt(e.left)||0,parseInt(e.top)||0)}if(this.scale(pn(h/this._width),pn(d/this._height)),Ia.width=h,Ia.height=d,null===(r=window.Laya3D)||void 0===r||r._changeWebGLSize(h,d),f.renderEngine.resizeOffScreen(h,d),Or.scaleFontWithCtx){let e=Math.min(Math.max(1,l.stage.scaleX,l.stage.scaleY),Or.maxFontScale);if(e=.2*Math.ceil(e/.2),Or.fontScale!==e){Or.fontScale=e,pi.runner._textRender.onFontScaleChanged();(e=>{for(let t of e._children)0!==(t._renderType&$e.TEXT)&&t.repaint()})(this)}}this.visible=!0,this.repaint(),this.event(c.RESIZE)}get scaleMode(){return this._scaleMode}set scaleMode(e){this._scaleMode=e,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(e){this._alignH=e,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(e){this._alignV=e,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(e){if(this._bgColor=e,e){let t=ht.create(e).arrColor;this._wgColor.setValue(t[0],t[1],t[2],t[3])}else this._wgColor.setValue(0,0,0,0);Y.isDomSupported&&(Y.mainCanvas.source.style.background=null!=e?e:"none")}get mouseX(){return Math.round(nn.mouseX/this.clientScaleX)}get mouseY(){return Math.round(nn.mouseY/this.clientScaleY)}getMousePoint(){return u.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._scaleX}get clientScaleY(){return this.needUpdateCanvasSize(),this._scaleY}get screenMode(){return this._screenMode}set screenMode(e){this._screenMode=e}getTimeFromFrameStart(){return performance.now()-this._frameStartTime}get visible(){return super.visible}set visible(e){super.visible=e,Y.isDomSupported&&(Y.mainCanvas.source.style.visibility=e?"visible":"hidden")}render(t){if(this._frameRate===cn.FRAME_SLEEP){if(t-this._frameStartTime<1e3)return;this._frameStartTime=t}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(dn.callLaters._update(t),Vi.loopCount++,this._runComponents(),this._updateTimers(t)));this._frameStartTime=t}this._renderCount++;let s=(this._frameRate===cn.FRAME_MOUSE?t-nn.lastMouseTime<2e3?cn.FRAME_FAST:cn.FRAME_SLOW:this._frameRate)!==cn.FRAME_SLOW,r=this._renderCount%2==0;if(s||r){if(dn.callLaters._update(t),Vi.loopCount++,f.renderEngine.startFrame(),this.renderingEnabled){this._runComponents();for(let e=0,t=this._scene2Ds.length;e<t;e++)this._scene2Ds[e]._update();for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._componentDriver.callPreRender(),pi.rendercontext2D.setRenderTarget(null,!0,this._wgColor);let t=performance.now();for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e].renderSubmit();f.statAgent.recordTimeData(e.StatElement.T_AllRender3D,performance.now()-t),t=performance.now(),this._render2d(),f.statAgent.recordTimeData(e.StatElement.T_AllRender2D,performance.now()-t),this._componentDriver.callPostRender()}else this._runComponents();this._updateTimers(t),Vi.render(),f.renderEngine.endFrame()}}_render2d(){for(let e=0,t=this._scene2Ds.length;e<t;e++)this._scene2Ds[e].render(0,0);for(let t of this._subpassUpdateList){if(t._destroyed||!t._subpassUpdateFlag)continue;if(t.updateSubRenderPassState(),!t._oriRenderPass||!t._oriRenderPass.enable){t._subpassUpdateFlag=0;continue}let s=t.updateRenderTexture(),r=t._drawOriRT;if(!r){t.setSubRenderPassState(!1);continue}t.mask?t._oriRenderPass.mask=t.mask._struct:t._oriRenderPass.mask=null,s&&(t._oriRenderPass.renderTexture=r);let i=t._renderType&$e.POSTPROCESS?t._oriRenderPass.postProcess:null;i&&r!=zi._empty&&((s||t._subpassUpdateFlag&e.SubPassFlag.UPDATE_POSTPROCESS)&&(i.setResource(r),i.clearCMD(),i._render()),i.enabled&&(r=i._context.destination)),t._subStructRender._updateRenderTexture(t._drawOriRT,r),t._subpassUpdateFlag=0}this._updateMatrixList(this._tranMatrixUpdateList,Vi.loopCount);for(let e of this._graphicUpdateList)e._needGraphicsUpdate()&&e._graphics._render(pi.runner);this.passManager.apply(pi.rendercontext2D),this._graphicUpdateList.clear(),this._subpassUpdateList.clear(),this._tranMatrixUpdateList.clear(),zi.cleanupExpired(),Vi.render2DCount++}_updateMatrixList(e,t){for(let t of e)t._updateStruct()}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(e){l.systemTimer._update(e),l.physicsTimer._update(e),l.timer._update(e),sa._runAll()}set fullScreenEnabled(e){let t=Y.mainCanvas.source;e?(t.addEventListener("mousedown",_n),t.addEventListener("touchstart",_n),W.browser.on("fullscreenchange",this,this.fullScreenChanged)):(t.removeEventListener("mousedown",_n),t.removeEventListener("touchstart",_n),W.browser.off("fullscreenchange",this,this.fullScreenChanged))}fullScreenChanged(){this.event(c.FULL_SCREEN_CHANGE)}exitFullscreen(){W.browser.exitFullscreen()}get frameRate(){return this._frameRate}set frameRate(e){this._frameRate=e}}function _n(){W.browser.requestFullscreen();let e=Y.mainCanvas.source;e.removeEventListener("mousedown",_n),e.removeEventListener("touchstart",_n)}function pn(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}cn.SCALE_NOSCALE="noscale",cn.SCALE_SHOWALL="showall",cn.SCALE_NOBORDER="noborder",cn.SCALE_FULL="full",cn.SCALE_FIXED_WIDTH="fixedwidth",cn.SCALE_FIXED_HEIGHT="fixedheight",cn.SCALE_FIXED_AUTO="fixedauto",cn.ALIGN_LEFT="left",cn.ALIGN_RIGHT="right",cn.ALIGN_CENTER="center",cn.ALIGN_TOP="top",cn.ALIGN_MIDDLE="middle",cn.ALIGN_BOTTOM="bottom",cn.SCREEN_NONE="none",cn.SCREEN_HORIZONTAL="horizontal",cn.SCREEN_VERTICAL="vertical",cn.FRAME_FAST="fast",cn.FRAME_SLOW="slow",cn.FRAME_MOUSE="mouse",cn.FRAME_SLEEP="sleep";class gn{static __init__(){gn.frameInterval=1e3/t.FPS;let e=0;W.browser.on("visibilitychange",t=>{t?0!=e&&window.clearInterval(e):e=window.setInterval(gn.loop,1e3)}),gn.startLoop()}static startLoop(){let e=W.browser.requestFrame,s=null,r=!0,i=0,a=0;e(function n(o){null!=o&&null===W.g||(o=performance.now());let l=gn.frameInterval;r&&(i=Math.floor(o/l)*l,r=!1);let h=a+o-s;(h+1>=l||!t.fixedFrames)&&(a=Math.min(h-l,l),s=o,gn.lastFrame=Math.floor((o-i)/l),gn.loop(o)),e(n)})}static loop(e){f.statAgent.startFrameLogic(e),l.stage.render(e),f.statAgent.endFrameLogic(e)}static vsyncTime(){return gn.lastFrame*gn.frameInterval}static get canvas(){return Y.mainCanvas.source}}gn.frameInterval=1e3/60,gn.lastFrame=0;class mn extends G{static get defaultTexture(){return this._defaultTexture}static __init__(){f.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new mn(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}constructor(t,s,r,i,a=!0,n,o=!1){super(t,s,i),this._dimension=e.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=r;let l=f.textureContext;this._texture=l.createTexture3DInternal(this._dimension,t,s,r,i,a,o,!1)}setImageData(e,t,s){let r=this._texture;f.textureContext.setTexture3DImageData(r,e,this.depth,t,s)}setPixelsData(e,t,s){let r=this._texture;f.textureContext.setTexture3DPixelsData(r,e,this.depth,t,s)}setSubPixelsData(e,t,s,r,i,a,n,o,l,h,d){let u=this._texture;f.textureContext.setTexture3DSubPixelsData(u,n,o,l,e,t,s,r,i,a,h,d)}}var fn;e.TextureCubeFace=void 0,(fn=e.TextureCubeFace||(e.TextureCubeFace={}))[fn.PositiveX=0]="PositiveX",fn[fn.NegativeX=1]="NegativeX",fn[fn.PositiveY=2]="PositiveY",fn[fn.NegativeY=3]="NegativeY",fn[fn.PositiveZ=4]="PositiveZ",fn[fn.NegativeZ=5]="NegativeZ";const Tn=new Uint8Array(4);class yn extends G{static get blackTexture(){return yn._blackTexture}static get grayTexture(){return yn._grayTexture}static get whiteTexture(){return yn._whiteTexture}static get errorTexture(){return yn._errorTexture}static __init__(){var t=new yn(1,e.TextureFormat.R8G8B8A8,!1),s=new yn(1,e.TextureFormat.R8G8B8A8,!1),r=new yn(1,e.TextureFormat.R8G8B8A8,!1),i=Tn;i[0]=0,i[1]=0,i[2]=0,i[3]=255,t.setPixelsData([i,i,i,i,i,i],!1,!1),t.lock=!0,i[0]=128,i[1]=128,i[2]=128,i[3]=255,s.setPixelsData([i,i,i,i,i,i],!1,!1),s.lock=!0,i[0]=255,i[1]=255,i[2]=255,i[3]=255,r.setPixelsData([i,i,i,i,i,i],!1,!1),r.lock=!0,yn._grayTexture=s,yn._blackTexture=t,yn._whiteTexture=r,yn._errorTexture=r}constructor(t,s,r=!0,i=!1,a=!1){super(t,t,s),this._dimension=e.TextureDimension.Cube,this._texture=f.textureContext.createTextureInternal(this._dimension,t,t,s,r,i,a)}setImageData(e,t,s){let r=!1,i=e.findIndex(e=>null!=e);if(-1!=i){let t=e[i];e.every(e=>null!=e&&e.width==t.width&&e.height==t.height)||(r=!0)}else r=!0;let a=this._texture;if(r){let e=Tn;f.textureContext.setCubePixelsData(a,[e,e,e,e,e,e],t,s)}else f.textureContext.setCubeImageData(a,e,t,s)}setPixelsData(e,t,s){let r=this._texture;f.textureContext.setCubePixelsData(r,e,t,s)}updateSubPixelsData(e,t,s,r,i,a,n,o,l){let h=this._texture;f.textureContext.setCubeSubPixelData(h,e,a,n,t,s,r,i,o,l)}setDDSData(e){let t=this._texture;f.textureContext.setCubeDDSData(t,e)}setKTXData(e){let t=this._texture;f.textureContext.setCubeKTXData(t,e)}get defaultTexture(){return yn.grayTexture}}class xn{static __init__(){l.stage.on(c.BLUR,()=>{Sn.autoStopMusic&&Sn._musicChannel&&!Sn._musicChannel.paused&&W.media.resumeUntilGotFocus(Sn._musicChannel)})}static get musicVolume(){return Sn._musicVolume}static set musicVolume(e){(e=ut.clamp(e,0,1))!==Sn._musicVolume&&(Sn._musicVolume=e,Sn._musicChannel&&(Sn._musicChannel.volume=Sn._musicChannel.volume))}static get soundVolume(){return Sn._soundVolume}static set soundVolume(e){if((e=ut.clamp(e,0,1))!==Sn._soundVolume){Sn._soundVolume=e;for(let e of Sn._channels)e!==Sn._musicChannel&&(e.volume=e.volume)}}static get muted(){return Sn._muted}static set muted(e){(e=!!e)!==Sn._muted&&(Sn._muted=e,this.updateMutedStatus())}static get soundMuted(){return Sn._soundMuted}static set soundMuted(e){(e=!!e)!==Sn._soundMuted&&(Sn._soundMuted=e,this.updateMutedStatus())}static get musicMuted(){return Sn._musicMuted}static set musicMuted(e){(e=!!e)!==Sn._musicMuted&&(Sn._musicMuted=e,this.updateMutedStatus())}static playSound(e,t,s,r,i){if(!e)return null;"number"==typeof r&&(i=r);let a=W.media.createSoundChannel(e,!1);return a._isMusic=!1,a.loops=null!=t?t:1,a.startTime=null!=i?i:0,a.playbackRate=this.playbackRate,a.volume=1,a.muted=Sn._soundMuted||Sn._muted,a.completeHandler=s,a.play(),a}static playMusic(e,t,s,r){if(Sn._musicChannel&&(Sn._musicChannel.stop(),Sn._musicChannel=null),!e)return null;let i=W.media.createSoundChannel(e,Sn.useAudioMusic);return i._isMusic=!0,i.loops=null!=t?t:1,i.startTime=null!=r?r:0,i.playbackRate=this.playbackRate,i.volume=1,i.muted=Sn._musicMuted||Sn._muted,i.completeHandler=s,i.play(),i}static stopSound(e){for(let t of Sn._channels)t.url==e&&(t.stop(),t===Sn._musicChannel&&(Sn._musicChannel=null))}static stopAll(){Sn._musicChannel=null;for(let e of Sn._channels)e.stop()}static stopAllSound(){for(let e of Sn._channels)e!==Sn._musicChannel&&e.stop()}static stopMusic(){Sn._musicChannel&&Sn._musicChannel.stop(),Sn._musicChannel=null}static setSoundVolume(e,t){if(t){let s=this.findChannel(t);s&&(s.volume=e)}else this.soundVolume=e}static setMusicVolume(e){this.musicVolume=e}static findChannel(e){for(let t of Sn._channels)if(t.url==e)return t;return null}static updateMutedStatus(){let e=Sn._muted||Sn._soundMuted,t=Sn._muted||Sn._musicMuted;for(let s of Sn._channels)s===Sn._musicChannel?s.muted=t:s.muted=e}static addChannel(e){Sn._channels.add(e),e._isMusic&&(Sn._musicChannel=e)}static removeChannel(e){Sn._channels.delete(e),e===Sn._musicChannel&&(Sn._musicChannel=null)}}xn.playbackRate=1,xn.useAudioMusic=!0,xn.autoStopMusic=!0,xn._muted=!1,xn._soundMuted=!1,xn._musicMuted=!1,xn._musicVolume=1,xn._soundVolume=1,xn._musicChannel=null,xn._channels=new Set;const Sn=xn;class En extends fa{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=be.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(c.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(c.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(c.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(c.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var e=this.resetLayoutX(),t=this.resetLayoutY();(e||t)&&this.owner.event(c.RESIZE)}resetLayoutX(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerX)e.x=Math.round(.5*(t.width-e.displayWidth)+this._centerX+e.pivotX*e.scaleX);else if(null!=this._left){if(e.x=Math.round(this._left+e.pivotX*e.scaleX),null!=this._right){if(!t._width)return!1;var s=(t._width-this._left-this._right)/(e.scaleX||.01);if(s!=e._width)return e.width=s,!0}}else null!=this._right&&(e.x=Math.round(t.width-e.displayWidth-this._right+e.pivotX*e.scaleX));return!1}resetLayoutY(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerY)e.y=Math.round(.5*(t.height-e.displayHeight)+this._centerY+e.pivotY*e.scaleY);else if(null!=this._top){if(e.y=Math.round(this._top+e.pivotY*e.scaleY),null!=this._bottom){if(!t._height)return!1;var s=(t._height-this._top-this._bottom)/(e.scaleY||.01);if(s!=e._height)return e.height=s,!0}}else null!=this._bottom&&(e.y=Math.round(t.height-e.displayHeight-this._bottom+e.pivotY*e.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(e){isNaN(e)&&(e=null),this._top!=e&&(this._top=e,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(e){isNaN(e)&&(e=null),this._bottom!=e&&(this._bottom=e,this.resetLayoutY())}get left(){return this._left}set left(e){isNaN(e)&&(e=null),this._left!=e&&(this._left=e,this.resetLayoutX())}get right(){return this._right}set right(e){isNaN(e)&&(e=null),this._right!=e&&(this._right=e,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(e){isNaN(e)&&(e=null),this._centerX!=e&&(this._centerX=e,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(e){isNaN(e)&&(e=null),this._centerY!=e&&(this._centerY=e,this.resetLayoutY())}}En.EMPTY=null,En.EMPTY=new En;class vn{constructor(){this.componentElementMap=new Map,this._shaderData=f.renderDeviceFactory.createShaderData(null),vn.SPRITE2DGLOBAL||(vn.SPRITE2DGLOBAL=gr.getDefineByName("SPRITE2DGLOBAL")),this._shaderData.addDefine(vn.SPRITE2DGLOBAL)}}class Dn extends ja{static shaderValueInit(){Dn.VIEW2D=gr.propertyNameToID("u_view2D"),Dn.SHADERDEFINE_CAMERA2D=gr.getDefineByName("CAMERA2D")}get ignoreRotation(){return this._ignoreRotation}set ignoreRotation(e){this._ignoreRotation=e}get isMain(){return this._isMain}set isMain(e){this._ownerArea&&(e?(this._ownerArea._setMainCamera(this),this._isMain=!0):this._ownerArea.mainCamera==this&&(this._ownerArea._setMainCamera(null),this._isMain=!1)),this._isMain=e}_setUnBelongScene(){null!=this._ownerArea&&(this._ownerArea.mainCamera==this&&this._ownerArea._setMainCamera(null),this._ownerArea=null),super._setUnBelongScene()}_findOwnerArea(){let e=this;for(;e&&e!==this._scene&&e!==l.stage;){if(0!==(e._renderType&$e.AREA2D)){this._ownerArea=e,this._isMain&&!this._ownerArea.mainCamera&&this._ownerArea._setMainCamera(this);break}e=e._parent}null==this._ownerArea&&console.warn("Camera2D must be a descendant of Area2D")}get zoom(){return this._zoom}set zoom(e){e&&(e.cloneTo(this._zoom),this._struct.setRepaint(),this.parentRepaint())}get limit_Left(){return this._limit_Left}set limit_Left(e){this._limit_Left=e}get limit_Right(){return this._limit_Right}set limit_Right(e){this._limit_Right=e}get limit_Bottom(){return this._limit_Bottom}set limit_Bottom(e){this._limit_Bottom=e}get limit_Top(){return this._limit_Top}set limit_Top(e){this._limit_Top=e}get positionSmooth(){return this._positionSmooth}set positionSmooth(e){this._positionSmooth=e}get positionSpeed(){return this._positionSpeed}set positionSpeed(e){this._positionSpeed=e}get dragHorizontalEnable(){return this._dragHorizontalEnable}set dragHorizontalEnable(e){this._dragHorizontalEnable=e}get dragVerticalEnable(){return this._dragVerticalEnable}set dragVerticalEnable(e){this._dragVerticalEnable=e}get drag_Left(){return this._drag_Left}set drag_Left(e){this._drag_Left=e}get drag_Right(){return this._drag_Right}set drag_Right(e){this._drag_Right=e}get drag_Top(){return this._drag_Top}set drag_Top(e){this._drag_Top=e}get drag_Bottom(){return this._drag_Bottom}set drag_Bottom(e){this._drag_Bottom=e}get cameraMatrix(){return this._cameraMatrix}getCameraPos(){return this._cameraPos}constructor(){super(),this._cameraPos=new ct,this._cameraSmoothPos=new ct,this._firstUpdate=!0,this._cameraMatrix=new Us,this._cameraInvertMatrix=new Us,this._ignoreRotation=!0,this.visiableLayer=-1,this._viewRect=new ct,this.limit_Left=-1e7,this.limit_Right=1e7,this.limit_Top=-1e7,this.limit_Bottom=1e7,this.drag_Left=.2,this.drag_Right=.2,this.drag_Top=.2,this.drag_Bottom=.2,this.positionSmooth=!1,this._rect=new i,this._zoom=new ct(1,1)}_getScreenSize(){return this._viewRect.setValue(Ia.width,Ia.height),this._viewRect}onEnable(){this.on(c.TRANSFORM_CHANGED,this,this._onTransChanged)}onDisable(){this.off(c.TRANSFORM_CHANGED,this,this._onTransChanged)}_onTransChanged(e){this._struct.setRepaint(),this.parentRepaint()}_getCameraTransform(){let e=this._getScreenSize(),t=u.TEMP;this.globalTrans.getPos(t);let s=.5*e.x*this._zoom.x,r=.5*e.y*this._zoom.y;if(this._firstUpdate)this._cameraSmoothPos.x=this._cameraPos.x=t.x,this._cameraSmoothPos.y=this._cameraPos.y=t.y,this._firstUpdate=!1;else{this.dragHorizontalEnable?(this._cameraPos.x=Math.min(this._cameraPos.x,t.x+s*this.drag_Left),this._cameraPos.x=Math.max(this._cameraPos.x,t.x-s*this.drag_Right)):this._cameraPos.x=t.x,this.dragVerticalEnable?(this._cameraPos.y=Math.min(this._cameraPos.y,t.y+r*this.drag_Top),this._cameraPos.y=Math.max(this._cameraPos.y,t.y-r*this.drag_Bottom)):this._cameraPos.y=t.y;let i=this._cameraPos.x-s,a=i+e.x,n=this._cameraPos.y-r,o=n+e.y;if(i<this.limit_Left&&(this._cameraPos.x-=i-this.limit_Left),a>this.limit_Right&&(this._cameraPos.x-=a-this.limit_Right),o>this.limit_Bottom&&(this._cameraPos.y-=o-this.limit_Bottom),n<this.limit_Top&&(this._cameraPos.y-=n-this.limit_Top),this.positionSmooth){let e=.01,t=Math.max(e,Math.min(1,.16*this.positionSpeed)),s=(this._cameraPos.x-this._cameraSmoothPos.x)*t,r=(this._cameraPos.y-this._cameraSmoothPos.y)*t;Math.abs(s)<e&&Math.abs(r)<e?(this._cameraSmoothPos.x=this._cameraPos.x,this._cameraSmoothPos.y=this._cameraPos.y):(this._cameraSmoothPos.x+=s,this._cameraSmoothPos.y+=r)}else this._cameraSmoothPos.x=this._cameraPos.x,this._cameraSmoothPos.y=this._cameraPos.y}return this.ignoreRotation?this._cameraRotation=0:this.rotationSmooth||(this._cameraRotation=this.globalTrans.rotation),this._rect.setValue(this._cameraSmoothPos.x-s,this._cameraSmoothPos.x+s,this._cameraSmoothPos.y-r,this._cameraSmoothPos.y+r),Us.createMatrixFromValue(this._cameraSmoothPos,this._cameraRotation*Math.PI/180,this._zoom,this._cameraMatrix),this._cameraMatrix.invert(this._cameraInvertMatrix),this._cameraInvertMatrix}}class wn extends ja{static regManager(e,t){wn.componentManagerMap.set(e,t)}static __init__(){Dn.shaderValueInit(),(wn.scene2DUniformMap=f.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal")).addShaderUniform(Dn.VIEW2D,"u_view2D",e.ShaderDataType.Matrix3x3)}constructor(){super(),this.autoDestroyAtClosed=!1,this._componentElementDatasMap={},this._specialManager=new vn,this._timer=l.timer,this._widget=En.EMPTY,this._area2Ds=new Set,this._scene=this,wn.componentManagerMap.forEach((e,t)=>{this._specialManager.componentElementMap.set(t,new e(this))}),this._globalRenderData=f.render2DRenderPassFactory.create2DGlobalRenderDataHandle(),this._globalRenderData.globalShaderData=this._shaderData=this._specialManager._shaderData,this._globalRenderData.renderLayerMask=-1,this._struct.globalRenderData=this._globalRenderData,this._struct.spriteShaderData=this._shaderData,Tr.initBlendMode(this._shaderData)}set componentElementDatasMap(e){this._componentElementDatasMap=e,this._specialManager.componentElementMap.forEach((e,t)=>{this._componentElementDatasMap[t]&&e.Init(this._componentElementDatasMap[t])})}get componentElementDatasMap(){return this._componentElementDatasMap}_update(){var e=.001*l.timer.delta;this._specialManager.componentElementMap.forEach(t=>{t.update(e)})}getComponentElementManager(e){return this._specialManager.componentElementMap.get(e)}getNodeByID(e){return this._idMap?this._idMap[e]:null}open(e,t){(null==e||e)&&wn.closeAll(),wn.root.addChild(this),this._scene3D&&l.stage.addChildAt(this._scene3D,0),this.onOpened(t)}onOpened(e){}close(e=null){this.onClosed(e),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(e){}destroy(e=!0){super.destroy(e),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,wn.unDestroyedScenes.delete(this),this._specialManager.componentElementMap.forEach(e=>{e.destroy()})}get timer(){return this._timer}set timer(e){this._timer=e}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}render(e,t){this._preRenderUpdate(e,t);for(let e of this._area2Ds)e.render()}setglobalRenderData(e,t,s){this._shaderData&&this._shaderData.setShaderData(e,t,s);for(let r of this._area2Ds)r._globalShaderData.setShaderData(e,t,s)}_preRenderUpdate(e,t){this._specialManager._shaderData,this._light2DManager&&this._light2DManager.preRenderUpdate()}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Layout)&&this.callLater(this._sizeChanged)}_sizeChanged(){this.event(c.RESIZE),this._widget!==En.EMPTY&&this._widget.resetLayout()}_onAdded(){super._onAdded(),l.stage._scene2Ds.push(this)}_onRemoved(){super._onRemoved();let e=l.stage._scene2Ds.indexOf(this);l.stage._scene2Ds.splice(e,1)}freshLayout(){this.refreshLayout()}refreshLayout(){this._widget!=En.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===En.EMPTY&&(this._widget=this.addComponent(En)),this._widget}static get root(){let e=wn._root;return e||(e=wn._root=l.stage.addChild(new ja),e.name="root",e.mouseThrough=!0,l.stage.on("resize",null,()=>{e.size(l.stage.width,l.stage.height),e.event(c.RESIZE)}),e.size(l.stage.width,l.stage.height),e.event(c.RESIZE)),e}static load(e,t,s){return wn._load(e,s?e=>s.runWith(e):null).then(e=>(t&&t.runWith(e),e))}static open(e,t,s,r,i){if("function"==typeof r&&(i=r,r=null),"function"==typeof s&&(r=s,s=null),i instanceof he){let e=i;i=t=>e.runWith(t)}return wn._load(e,i).then(e=>(e.open(t,s),r instanceof he?r.runWith(e):r&&r(e),e))}static _load(e,t){return wn.showLoadingPage(),l.loader.load(e,null,e=>{wn._loadPage&&wn._loadPage.event("progress",e),t&&t(e)}).then(t=>{if(wn.hideLoadingPage(),!t)throw new Error("Can not find scene:"+e);let s,r=[],i=t.create(null,r);if(r.length>0&&console.warn(`Error loading ${e}: \n${r.join("\n")}`),i instanceof wn)s=i;else{if(1!==i._nodeType)throw new Error("Not a scene:"+e);s=new wn,s.left=s.right=s.top=s.bottom=0,s._scene3D=i}return s._scene3D&&(s._scene3D._scene2D=s),wn.unDestroyedScenes.add(s),s})}static close(e,t){let s=!1;for(let r of wn.unDestroyedScenes)if(r&&r.parent&&r.url===e&&(null==t||r.name==t)){r.close(),s=!0;break}return s}static closeAll(){let e=wn.root;for(let s=0,r=e.numChildren;s<r;s++){var t=e.getChildAt(0);t instanceof wn?t.close():t.removeSelf()}}static destroy(e,t){let s=!1;for(let r of wn.unDestroyedScenes)if(r.url===e&&(null==t||r.name==t)&&!r._destroyed){r.destroy(),s=!0;break}return s}static gc(){V.destroyUnusedResources()}static setLoadingPage(e){wn._loadPage=e}static showLoadingPage(e=null,t=500){wn._loadPage&&(l.systemTimer.clear(null,wn._showLoading),l.systemTimer.clear(null,wn._hideLoading),l.systemTimer.once(t,null,wn._showLoading,[e],!1))}static _showLoading(e){l.stage.addChild(wn._loadPage),wn._loadPage instanceof wn&&wn._loadPage.onOpened(e)}static _hideLoading(){wn._loadPage instanceof wn?wn._loadPage.close():wn._loadPage.removeSelf()}static hideLoadingPage(e=500){wn._loadPage&&(l.systemTimer.clear(null,wn._showLoading),l.systemTimer.clear(null,wn._hideLoading),l.systemTimer.once(e,null,wn._hideLoading))}}wn.unDestroyedScenes=new Set,wn.componentManagerMap=new Map;class bn{static init(...t){if(bn._inited)return Promise.resolve();let s;bn._inited=!0,s="number"==typeof t[0]?{designWidth:t[0],designHeight:t[1]}:t[0],l.systemTimer=bn.systemTimer=dn.gSysTimer=e.systemTimer=new dn(!1),l.timer=bn.timer=e.timer=new dn(!1),l.physicsTimer=bn.physicsTimer=e.physicsTimer=new dn(!1),l.loader=bn.loader=e.loader=new Te,W.__init__();let r=[];r.push(()=>((Y.mainCanvas=new Re(!1)).source=W.browser.createMainCanvas(),Y.canvas=new Re(!0),Y.context=Y.canvas.context,W.browser.start())),p.beforeInit&&r.push(()=>p.beforeInit(s)),bn._beforeInitCallbacks.forEach(e=>r.push(()=>e(s))),r.push(()=>f.renderDeviceFactory.createEngine(null,Y.mainCanvas)),r.push(()=>bn.initRender2D(s));let i=window.Laya3D;i&&r.push(()=>i.__init__()),r.push(()=>Promise.all(bn._initCallbacks.map(e=>e()))),r.push(()=>{let e=Promise.resolve();for(let t of bn._afterInitCallbacks)e=e.then(t);return e}),p.afterInit&&r.push(()=>p.afterInit());let a=Promise.resolve();for(let e of r)a=a.then(e);return a}static initRender2D(s){W.browser.onInitRender(),e.stage=window.stage=l.stage=bn.stage=new cn,e.stage.size(s.designWidth,s.designHeight),s.scaleMode&&(e.stage.scaleMode=s.scaleMode),s.screenMode&&(e.stage.screenMode=s.screenMode),s.alignV&&(e.stage.alignV=s.alignV),s.alignH&&(e.stage.alignH=s.alignH),t.isAlpha?e.stage.bgColor="#00000000":s.backgroundColor&&(e.stage.bgColor=s.backgroundColor),dr.__init__(),_r.__init__(),gr.init(),ni.__init__(),mr.__init__(),gn.__init__(),ba.__init__(),Tr._init_(),fs.__init__(),zi.__init__(),yn.__init__(),mn.__init__(),Qt.__init__(),wn.__init__(),pi.__init__(),xa.initBaseRender2DCommandEncoder(),Ua.__init__(),Xa.init(),Ba.__initDefine__(),Fa.__init__(),nn.__init__(),xn.__init__()}static alertGlobalError(e){e?W.browser.captureGlobalError(bn._onGlobalError):W.browser.captureGlobalError(null)}static _onGlobalError(e){var t;let s="Something went wrong\n"+(e.message||e.reason)+"\n"+(e.stack||(null===(t=e.error)||void 0===t?void 0:t.stack));Cn++<5?W.browser.alert(s):console.error(s)}static addInitCallback(e){bn._initCallbacks.push(e)}static addBeforeInitCallback(e){bn._beforeInitCallbacks.push(e)}static addAfterInitCallback(e){bn._afterInitCallbacks.push(e)}static importNative(e){if(!p.isConch)return null;let t=window.$DLL_PATHS[e],s=window.importNative(t||e);if(!s)throw new Error(`failed to load ${e}`);return s}}bn.stage=null,bn.systemTimer=null,bn.physicsTimer=null,bn.timer=null,bn.loader=null,bn._inited=!1,bn._initCallbacks=[],bn._beforeInitCallbacks=[],bn._afterInitCallbacks=[];var Cn=0;l.Laya=bn,l.Loader=Te,l.InputManager=nn;var Rn=bn.init;e.stage=void 0,e.systemTimer=void 0,e.physicsTimer=void 0,e.timer=void 0,e.loader=void 0;var Mn,An,In,Pn=bn.alertGlobalError,Bn=bn.addInitCallback,Ln=bn.addBeforeInitCallback,Nn=bn.addAfterInitCallback,Fn=bn.importNative;e.AnimationWrapMode=void 0,(Mn=e.AnimationWrapMode||(e.AnimationWrapMode={}))[Mn.Positive=0]="Positive",Mn[Mn.Reverse=1]="Reverse",Mn[Mn.PingPong=2]="PingPong",e.AnimationStretchMode=void 0,(An=e.AnimationStretchMode||(e.AnimationStretchMode={}))[An.None=0]="None",An[An.Fill=1]="Fill",An[An.ResizeToFit=2]="ResizeToFit";class On extends fa{constructor(){super(),this.repeatDelay=0,this.timeScale=1,this._wrapMode=0,this._loop=!0,this._frame=0,this._autoPlay=!0,this._stretchMode=0,this._source="",this._playing=!1,this._count=0,this._index=0,this._elapsed=0,this._loadId=0,this.interval=t.animationInterval,this._frames=[],this._drawCmds=[],this._delays=[],this._offset=new u,this._color=new y(1,1,1,1),this._singleton=!1,this.runInEditor=!0}get frame(){return p.isPlaying?this._frame:this._index}set frame(e){var t;this._index=this._frame=e,this.drawFrame(),(null===(t=this._labels)||void 0===t?void 0:t[e])&&this.owner.event(c.LABEL,this._labels[e])}get frames(){return this._frames}set frames(t){var s;this._drawCmd&&(null===(s=this.owner._graphics)||void 0===s||s.removeCmd(this._drawCmd),this._drawCmd=null);for(let e of this._drawCmds)e.lock=!1,e.recover();if(this._drawCmds.length=0,this._frames.length=0,null!=t&&t.length>0){this._frames.push(...t);let s=0,r=0;this._stretchMode===e.AnimationStretchMode.None&&(s=this._offset.x,r=this._offset.y);let i=this._stretchMode===e.AnimationStretchMode.Fill;for(let e of t){let t=i?Xt.create(e,0,0,1,1,null,1,null,null,null,!0):Xt.create(e,s,r);t.lock=!0,this._drawCmds.push(t)}if(this._count=this._frames.length,this._elapsed=0,this._wrapMode===e.AnimationWrapMode.Reverse?this._frame=this._count-1:(this._reversed=!1,this._frame=0),this._stretchMode===e.AnimationStretchMode.ResizeToFit){let e=this.width,t=this.height;(e>0&&t>0||p.isPlaying)&&(this._changingSize=!0,this.owner.size(e,t),this._changingSize=!1)}this.drawFrame()}else this._count=0}get frameDelays(){return this._delays}get isPlaying(){return this._playing}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,this.enabled&&(e?this.play():this.stop())}get wrapMode(){return this._wrapMode}set wrapMode(t){this._wrapMode!=t&&(this._wrapMode=t,this._playing&&(t===e.AnimationWrapMode.Reverse?this._reversed=!0:t===e.AnimationWrapMode.Positive&&(this._reversed=!1)))}get loop(){return this._loop}set loop(e){this._loop!=e&&(this._loop=e,e&&!this._playing&&this._autoPlay&&this.play())}get stretchMode(){return this._stretchMode}set stretchMode(t){if(!this._changingSize&&this._stretchMode!=t&&(this._stretchMode=t,this._count>0)){if(this._stretchMode===e.AnimationStretchMode.ResizeToFit){let e=this.width,t=this.height;(e>0&&t>0||p.isPlaying)&&(this._changingSize=!0,this.owner.size(e,t),this._changingSize=!1)}this.applyStretchMode(),this.drawFrame()}}get offset(){return this._offset}set offset(e){this._offset.copy(e),this.applyStretchMode(),this.drawFrame()}get color(){return this._color}set color(e){this._color=e,this.drawFrame()}get width(){return this._count>0?this._frames[0].sourceWidth:0}get height(){return this._count>0?this._frames[0].sourceHeight:0}applyStretchMode(){if(this._stretchMode===e.AnimationStretchMode.Fill)for(let e of this._drawCmds)e.x=e.y=0,e.width=e.height=1,e.percent=!0;else{let t=0,s=0;this._stretchMode===e.AnimationStretchMode.None&&(t=this._offset.x,s=this._offset.y);for(let e of this._drawCmds)e.x=t,e.y=s,e.texture&&(e.width=e.texture.sourceWidth,e.height=e.texture.sourceHeight),e.percent=!1}}play(){this._playing||(this._playing=!0,this._elapsed=0,this._reversed=this._wrapMode===e.AnimationWrapMode.Reverse)}stop(){this._playing=!1,p.isPlaying||(this._frame=this._index,this.drawFrame())}_onEnable(){this._autoPlay&&this.play()}_onDestroy(){super._onDestroy(),this.frames=null,this._atlas&&(this.owner._getBit(we.EDITING_NODE)&&this._atlas.off("reload",this,this.onAtlasReload),this._atlas=null)}onUpdate(){var t;if(!this._playing||0==this._count)return;let s=l.timer.delta;s>100&&(s=100),1!=this.timeScale&&(s*=this.timeScale);let r=this._frame;this._elapsed+=s;let i=this.interval;if(this._reversed?i+=r>0?this._delays[r-1]||0:this.repeatDelay:(i+=this._delays[r]||0,r===this._count-1&&(i+=this.repeatDelay)),this._elapsed<i)return;this._elapsed-=i,this._elapsed>this.interval&&(this._elapsed=this.interval);let a=!1;this._reversed?(r--,r<0&&(this._loop?(this._wrapMode===e.AnimationWrapMode.PingPong?(this._reversed=!1,r=1):r=this._count-1,a=!0):(r=0,this._playing=!1,a=!0))):(r++,r>this._count-1&&(this._loop?(this._wrapMode===e.AnimationWrapMode.PingPong?(this._reversed=!0,r=Math.max(0,this._count-2)):r=0,a=!0):(r=this._count-1,this._playing=!1,a=!0))),this._frame=r,this._playing&&(this.drawFrame(),(null===(t=this._labels)||void 0===t?void 0:t[r])&&this.owner.event(c.LABEL,this._labels[r])),a&&this.owner.event(c.COMPLETE)}drawFrame(){let e=this._drawCmds[this._frame];e!=this._drawCmd&&(this._drawCmd=this.owner.graphics.replaceCmd(this._drawCmd,e)),this._drawCmd&&(this._drawCmd.color=this._color.getABGR())}get source(){return this._source}set source(e){null==e&&(e=""),this._source=e,this.load()}get images(){return this._images}set images(e){this._images=e,this.load()}load(){this._atlas&&(this.owner._getBit(we.EDITING_NODE)&&this._atlas.off("reload",this,this.onAtlasReload),this._atlas=null),this._source?this.loadAtlas(this._source):this._images&&this._images.length>0?this.loadImages(this._images):this.onLoaded(null,++this._loadId)}loadImages(e){let t=++this._loadId,s=e.map(e=>Te.getRes(e));return-1===s.indexOf(null)?(this.frames=s,this.owner.event(c.LOADED)):l.loader.load(e).then(e=>{t!=this._loadId||this.destroyed||(this.frames=e,this.owner.event(c.LOADED))}),this}loadAtlas(e){let t=++this._loadId,s=Te.getRes(e,Te.ATLAS);return s?this.onLoaded(s,t):l.loader.load(e,Te.ATLAS).then(e=>this.onLoaded(e,t)),this}setAtlas(e){this.onLoaded(e,++this._loadId)}onLoaded(e,t){var s,r;if(t==this._loadId&&!this.destroyed){if(this._atlas=e,e){this.owner._getBit(we.EDITING_NODE)&&this._atlas.on("reload",this,this.onAtlasReload);let t=e.animation;t&&(this.interval=t.interval,this.repeatDelay=null!==(s=t.repeatDelay)&&void 0!==s?s:0,this.wrapMode=null!==(r=t.wrapMode)&&void 0!==r?r:0,this._delays.length=0,t.frameDelays&&this._delays.push(...t.frameDelays)),this.frames=e.frames}else this.frames=null;this.owner.event(c.LOADED)}}onAtlasReload(){this.onLoaded(this._atlas,this._loadId)}}class Un extends ja{constructor(){super(),this._comp=this.addComponent(On),this._comp.hideFlags|=be.HideAndDontSave,this._comp.autoPlay=!1}get loop(){return this._comp.loop}set loop(e){this._comp.loop=e}get wrapMode(){return this._comp.wrapMode}set wrapMode(e){this._comp.wrapMode=e}get interval(){return this._comp.interval}set interval(e){this._comp.interval=e}get index(){return this._comp.frame}set index(e){this._comp.frame=e}get count(){return this._comp.frames.length}get source(){return this._comp.source}set source(e){this._comp.source=e}get images(){return this._comp.images}set images(e){this._comp.images=e}get isPlaying(){return this._comp.isPlaying}set autoPlay(e){this._comp.autoPlay=e}get autoPlay(){return this._comp.autoPlay}play(e,t,s=""){s&&this._setFramesFromCache(s,!0),null!=e&&(this._comp.frame="string"==typeof e?this.getFrameByLabel(e):e),null!=t&&(this._comp.loop=t),this._comp.play()}clear(){return this._comp.stop(),this._comp.frames=null,this._labels=null,this}stop(){this._comp.stop()}gotoAndStop(e){this.index="string"==typeof e?this.getFrameByLabel(e):e,this.stop()}addLabel(e,t){this._labels||(this._labels=[],this._comp._labels=this._labels),this._labels[t]=e}removeLabel(e){if(this._labels)for(let t=0,s=this._labels.length;t<s;t++)this._labels[t]==e&&delete this._labels[t]}loadImages(e){return this._comp.images=e,this}loadAtlas(e){return this._comp.source=e,this}getFrameByLabel(e){if(!this._labels)return 0;let t=this._labels.indexOf(e);return-1!=t?t:0}static createFrames(e,t){Un.framesMap[t]=e,l.loader.load(e)}static clearCache(e){delete Un.framesMap[e]}_setFramesFromCache(e,t=!1){let s=Un.framesMap[e];return s?(this.images=s,!0):(t&&console.log("ani not found:",e),!1)}}Un.framesMap={};class kn extends V{static loadFont(e,t){l.loader.load(e,Te.FONT).then(e=>{t&&t.runWith(e)})}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(e,t){var s;if(null==e||null==t)return;this.texture=t,t._addReference();let r=e.getNode("info");this.fontSize=r.getAttrInt("size",12),this.autoScaleSize=r.getAttrBool("autoScaleSize"),this.lineHeight=r.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let i=r.getAttrString("padding","").split(",");this.padding=[parseInt(i[0]),parseInt(i[1]),parseInt(i[2]),parseInt(i[3])];let a=(null===(s=e.getNode("chars"))||void 0===s?void 0:s.elements("char"))||[],n=0,o=this.dict;for(let e=0,s=a.length;e<s;e++){let s=a[e],r=s.getAttrInt("id"),i=s.getAttrInt("xoffset")/1,l=s.getAttrInt("yoffset")/1,h=s.getAttrInt("xadvance")/1,d=s.getAttrInt("x"),u=s.getAttrInt("y"),c=s.getAttrInt("width"),_=s.getAttrInt("height"),p=ie.create(t,d,u,c,_,i,l);0==h&&(h=c),h+=this.letterSpacing,n=Math.max(n,h),o[r]={x:0,y:0,width:c,height:_,advance:h,texture:p}}this.maxWidth=n>0?n:this.fontSize,o[32]||(o[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var e;if(this.texture){for(let t in this.dict)null===(e=this.dict[t].texture)||void 0===e||e.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(e,t){let s=0;for(let r=0,i=e.length;r<i;r++){let i=this.dict[e.charCodeAt(r)];if(i){let e=this.autoScaleSize?t/this.fontSize:1;s+=Math.round(i.advance*e)}}return s}getMaxWidth(e){return null!=e&&this.autoScaleSize?Math.round(this.maxWidth*(e/this.fontSize)):this.maxWidth}getMaxHeight(e){return null!=e&&this.autoScaleSize?Math.round(this.lineHeight*(e/this.fontSize)):this.lineHeight}}class Vn{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.strikethrough=!1,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}e.HtmlElementType=void 0,(In=e.HtmlElementType||(e.HtmlElementType={}))[In.Text=0]="Text",In[In.Link=1]="Link",In[In.Image=2]="Image",In[In.Input=3]="Input",In[In.Select=4]="Select",In[In.Object=5]="Object",In[In.LinkEnd=6]="LinkEnd";class Gn{constructor(){this.style=new Vn}getAttr(e){return null==this._attrs?null:this._attrs[e]}setAttr(e,t){null==this._attrs&&(this._attrs={}),this._attrs[e]=t}getAttrString(e,t){return de.getString(this._attrs,e,t)}getAttrInt(e,t){return de.getInt(this._attrs,e,t)}getAttrFloat(e,t){return de.getFloat(this._attrs,e,t)}getAttrBool(e,t){return de.getBool(this._attrs,e,t)}fetchAttributes(){this._attrs=Object.assign({},ce.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),h.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(t){let s;return s=this.pool.length>0?this.pool.pop():new Gn,s.type=t,s.type==e.HtmlElementType.Text||s._attrs||(s._attrs={}),s}static returnToPool(e){if(Array.isArray(e)){for(let t of e)t.reset();this.pool.push(...e),e.length=0}else e.reset(),this.pool.push(e)}}Gn.pool=[];class zn{constructor(){this._v=0,this.obj=new ja}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this.obj);let s=this._element.getAttrString("src");s&&this.loadTexture(s)}loadTexture(e){let t=this._element.getAttrInt("width",-1),s=this._element.getAttrInt("height",-1);-1!=t&&(this.obj.width=t),-1!=s&&(this.obj.height=s),this._w=t,this._h=s;let r=Te.getRes(e);if(r)this.onLoaded(r,++this._v);else{let t=++this._v;l.loader.load(e,{silent:!0}).then(e=>this.onLoaded(e,t,!0))}}onLoaded(t,s,r){if(!this._owner||this.obj.destroyed)return;if(s!=this._v)return;let i=this.obj,a=this._ani;t instanceof ie?(i.texture=t,a&&a.setAtlas(null),-1==this._w&&(i.width=t.sourceWidth),-1==this._h&&(i.height=t.sourceHeight)):t instanceof oe?(i.texture=null,a||(a=this._ani=i.addComponent(On),a.stretchMode=e.AnimationStretchMode.Fill,a.autoPlay=!0,a.loop=!0),a.setAtlas(t),-1==this._w&&(i.width=a.width),-1==this._h&&(i.height=a.height)):(i.texture=null,a&&a.setAtlas(null),-1==this._w&&(i.width=0),-1==this._h&&(i.height=0)),r&&this._owner.refreshLayout()}pos(e,t){this.obj.pos(e,t)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._ani&&this._ani.setAtlas(null),this._owner=null,this._element=null,this._v++}destroy(){this.obj.destroy()}}class Hn{constructor(){this._shape=new ja,this._shape.hitArea=this,this._shape.on(c.CLICK,()=>{this._owner.bubbleEvent(c.LINK,this._element.getAttrString("href"))}),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(e,t,s,r){let i=this._rects[this._rectCnt];i||(i=this._rects[this._rectCnt]=new te),this._rectCnt++,i.setTo(e,t,s,r)}contains(e,t){for(let s=0;s<this._rectCnt;s++)if(this._rects[s].contains(e,t))return!0;return!1}pos(e,t){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class Wn{constructor(){this.linkUnderline=Wn.defaultLinkUnderline,this.linkColor=Wn.defaultLinkColor}}Wn.defaultLinkUnderline=!0,Wn.defaultLinkColor=null,Ee.regClass("HtmlParseOptions",Wn);const Xn=new Array,Yn=new Array;class qn{constructor(){this._styleStack=new Array,this._style=new Vn,this._options=new Wn}parse(t,s,r,i){null==i&&(i=this._options),this._elements=r,this._styleStackTop=0,Object.assign(this._style,s),this._style.colorChanged=!1;let a,n=0,o=i.ignoreWhiteSpace,l=!1;for(ce.begin(t,!0);ce.nextTag();)switch(0==n&&(a=ce.getText(o),a.length>0&&(l&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),l=!1,ce.tagName){case"b":ce.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":ce.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":ce.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":ce.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(ce.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.fontSize=de.getInt(ce.attributes,"size",this._style.fontSize);let e=ce.getAttribute("color");null!=e&&(this._style.color=e,this._style.colorChanged=!0)}else ce.tagType==e.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(ce.tagType==e.XMLTagType.Start||ce.tagType==e.XMLTagType.Void){let t=Gn.getFromPool(e.HtmlElementType.Image);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,t.style.underline=this._style.underline,t.style.underlineColor=this._style.underlineColor,this._elements.push(t)}break;case"a":if(ce.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||i.linkUnderline,this._style.colorChanged||null==i.linkColor||(this._style.color=i.linkColor);let t=Gn.getFromPool(e.HtmlElementType.Link);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,this._elements.push(t)}else if(ce.tagType==e.XMLTagType.End){this.popStyle();let t=Gn.getFromPool(e.HtmlElementType.LinkEnd);this._elements.push(t)}break;case"input":{let t=Gn.getFromPool(e.HtmlElementType.Input);t.fetchAttributes(),t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"select":if(ce.tagType==e.XMLTagType.Start||ce.tagType==e.XMLTagType.Void){let t=Gn.getFromPool(e.HtmlElementType.Select);if(t.fetchAttributes(),ce.tagType==e.XMLTagType.Start){for(Xn.length=0,Yn.length=0;ce.nextTag()&&"select"!=ce.tagName;)"option"==ce.tagName&&(ce.tagType==e.XMLTagType.Start||ce.tagType==e.XMLTagType.Void?Yn.push(de.getString(ce.attributes,"value","")):Xn.push(ce.getText()));t.setAttr("items",Xn.slice()),t.setAttr("values",Yn.slice())}t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"p":ce.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.align=ce.getAttribute("align"),this.isNewLine()||this.appendText("\n")):ce.tagType==e.XMLTagType.End&&(this.appendText("\n"),l=!0,this.popStyle());break;case"ui":case"div":case"li":ce.tagType==e.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),l=!0);break;case"html":case"body":o=!0;break;case"head":case"style":case"script":case"form":ce.tagType==e.XMLTagType.Start?n++:ce.tagType==e.XMLTagType.End&&n--}0==n&&(a=ce.getText(o),a.length>0&&(l&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),this._elements=null}pushStyle(){let e;this._styleStack.length<=this._styleStackTop?(e=new Vn,this._styleStack.push(e)):e=this._styleStack[this._styleStackTop],Object.assign(e,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let e=this._styleStack[this._styleStackTop-1];Object.assign(this._style,e),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let t=this._elements[this._elements.length-1];return!(!t||t.type!=e.HtmlElementType.Text)&&t.text.endsWith("\n")}return!0}appendText(t){let s;this._elements.length>0&&(s=this._elements[this._elements.length-1],s.type==e.HtmlElementType.Text&&function(e,t){for(let s in e)if(!s.startsWith("_")&&e[s]!=t[s])return!1;return!0}(s.style,this._style))?s.text+=t:(s=Gn.getFromPool(e.HtmlElementType.Text),s.text=t,Object.assign(s.style,this._style),this._elements.push(s))}}qn.defaultParser=new qn,qn.classMap={[e.HtmlElementType.Image]:zn,[e.HtmlElementType.Link]:Hn};class jn{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(e,t,s){return t?"</a>":null!=s?'<a href="'+s+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(e,t,s){if(t)return null;var r=this.getTagText(!0);return r?this.defaultImgWidth?'<img src="'+r+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+r+'"/>':null}onTag_B(e,t,s){return t?"</b>":"<b>"}onTag_I(e,t,s){return t?"</i>":"<i>"}onTag_U(e,t,s){return t?"</u>":"<u>"}onTag_Simple(e,t,s){return t?"</"+e+">":"<"+e+">"}onTag_COLOR(e,t,s){return t?"</font>":(this.lastColor=s,'<font color="'+s+'">')}onTag_FONT(e,t,s){return t?"</font>":'<font face="'+s+'">'}onTag_SIZE(e,t,s){return t?"</font>":(this.lastSize=s,'<font size="'+s+'">')}getTagText(e){for(var t,s=this._readPos,r="";-1!=(t=this._text.indexOf("[",s));){if(92!=this._text.charCodeAt(t-1)){r+=this._text.substring(s,t);break}r+=this._text.substring(s,t-1),r+="[",s=t+1}return-1==t?null:(e&&(this._readPos=t),r)}parse(e,t){this._text=e,this.lastColor=null,this.lastSize=null;for(var s,r,i,a,n,o,l,h=0,d="";-1!=(s=e.indexOf("[",h));)if(s>0&&92==e.charCodeAt(s-1))d+=e.substring(h,s-1),d+="[",h=s+1;else{if(d+=e.substring(h,s),h=s,-1==(s=e.indexOf("]",h)))break;i="/"==e.charAt(h+1),a=e.substring(i?h+2:h+1,s),this._readPos=s+1,n=null,o=null,-1!=(r=a.indexOf("="))&&(n=a.substring(r+1),a=a.substring(0,r)),a=a.toLowerCase(),null!=(l=this._handlers[a])?t||null!=(o=l.call(this,a,i,n))&&(d+=o):d+=e.substring(h,this._readPos),h=this._readPos}return h<e.length&&(d+=e.substring(h)),this._text=null,d}}jn.defaultParser=new jn;class Kn extends ja{constructor(){super(),this._overflow=Kn.VISIBLE,this._singleCharRender=!1,this._prompt="",this._wordWrap=!1,this._asPassword=!1,this._textWidth=0,this._textHeight=0,this._html=!1,this._ubb=!1,this._maxWidth=0,this._hideText=!1,this._renderType|=$e.TEXT,this._textStyle=new Vn,this._textStyle.fontSize=t.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1,this.graphics._useSpriteRect=!0}static registerBitmapFont(e,t){t._addReference(),Kn._bitmapFonts[e]=t}static unregisterBitmapFont(e,t=!0){let s=Kn._bitmapFonts[e];s&&(s._removeReference(),t&&s.destroy(),delete Kn._bitmapFonts[e])}destroy(e=!0){Zn(this._lines),Gn.returnToPool(this._elements),this._bgDrawCmd&&(this._bgDrawCmd.lock=!1),super.destroy(e)}measureWidth(){return this.typeset(),this._textWidth}measureHeight(){return this.typeset(),this._textHeight}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Size)&&(null!=this._scrollRect&&this._updateScrollRect(),this._updatingLayout?this.drawBg():this.markChanged())}_updateScrollRect(){let e=this._scrollRect||new te,t=this._isWidthSet?this._width:this._textWidth,s=this._isHeightSet?this._height:this._textHeight;e.setTo(0,0,t,s),this.scrollRect=e}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),!this.ignoreLang&&Kn.langPacks&&(e=Kn.langPacks[e]||e),this._text!=e&&(this._text=e,this.markChanged(),this.event(c.CHANGE))}changeText(e){this.text=e}get font(){return this._textStyle.font}set font(e){if(this._textStyle.font=e,e||(e=t.defaultFont)||(e="Arial"),this._realFont=e,this._bitmapFont=Kn._bitmapFonts[e],this._bitmapFont)this._text&&this.markChanged();else if(e&&(Q.getFileExtension(e)||e.startsWith("res://"))){let t=l.loader.getRes(e);if(!t||t.obsolute){this._realFont="Arial";let t=this._textStyle.font;l.loader.load(e).then(e=>{this._textStyle.font==t&&e&&(e instanceof kn?this._bitmapFont=e:this._realFont=e.family,this._text&&this.markChanged())})}else t instanceof kn?this._bitmapFont=t:this._realFont=t.family,this._text&&this.markChanged()}else this._realFont=Y.onIPhone&&t.fontFamilyMap[e]||e,this._text&&this.markChanged()}get realFont(){return this._realFont}get fontSize(){return this._textStyle.fontSize}set fontSize(e){this._textStyle.fontSize!=e&&(this._textStyle.fontSize=e,this.markChanged())}get color(){return this._textStyle.color}set color(e){this._textStyle.color!=e&&(this._textStyle.color=e,this._isChanged||this._html||this._ubb?this.markChanged():this._graphics.replaceTextColor(this._textStyle.color))}get bold(){return this._textStyle.bold}set bold(e){this._textStyle.bold!=e&&(this._textStyle.bold=e,this.markChanged())}get italic(){return this._textStyle.italic}set italic(e){this._textStyle.italic!=e&&(this._textStyle.italic=e,this.markChanged())}get align(){return this._textStyle.align}set align(e){this._textStyle.align!=e&&(this._textStyle.align=e,this.markChanged())}get valign(){return this._textStyle.valign}set valign(e){this._textStyle.valign!=e&&(this._textStyle.valign=e,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(e){this._textStyle.alignItems!=e&&(this._textStyle.alignItems=e,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!=e&&(this._wordWrap=e,this.markChanged())}get leading(){return this._textStyle.leading}set leading(e){this._textStyle.leading!=e&&(this._textStyle.leading=e,this.markChanged())}get padding(){return this._padding}set padding(e){if("string"==typeof e){let t=e.split(",");this._padding.length=0;for(let e=0;e<4;e++){let s=parseFloat(t[e]);isNaN(s)&&(s=0),this._padding.push(s)}}else this._padding=e;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor=e,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(e){this._textStyle.stroke!=e&&(this._textStyle.stroke=e,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(e){this._textStyle.strokeColor!=e&&(this._textStyle.strokeColor=e,this.markChanged())}get overflow(){return this._overflow}set overflow(e){this._overflow!=e&&(this._overflow=e,e!==Kn.VISIBLE?this._updateScrollRect():this.scrollRect=null)}get underline(){return this._textStyle.underline}set underline(e){this._textStyle.underline!=e&&(this._textStyle.underline=e,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(e){this._textStyle.underlineColor!=e&&(this._textStyle.underlineColor=e,this.markChanged())}get strikethrough(){return this._textStyle.strikethrough}set strikethrough(e){this._textStyle.strikethrough!=e&&(this._textStyle.strikethrough=e,this.markChanged())}get strikethroughColor(){return this._textStyle.strikethroughColor}set strikethroughColor(e){this._textStyle.strikethroughColor!=e&&(this._textStyle.strikethroughColor=e,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(e){this._singleCharRender!==e&&(this._singleCharRender=e,this.markChanged())}get html(){return this._html}set html(e){this._html!=e&&(this._html=e,this.markChanged())}get ubb(){return this._ubb}set ubb(e){this._ubb!=e&&(this._ubb=e,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!=e&&(this._maxWidth=e,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(e){this._htmlParseOptions=e}get templateVars(){return this._templateVars}set templateVars(e){(this._templateVars||e)&&(this._templateVars=!0===e?{}:!1===e?null:e,this.markChanged())}setVar(e,t){return this._templateVars||(this._templateVars={}),this._templateVars[e]=t,this.markChanged(),this}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollX(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollX;e=(e=e<0?0:e)>t?t:e,this._scrollPos.x=e,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}set scrollY(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollY;e=(e=e<0?0:e)>t?t:e,this._scrollPos.y=e,this.renderText()}get maxScrollX(){let e=this.textWidth-this._width;return e<0?0:e}get maxScrollY(){let e=this.textHeight-this._height;return e<0?0:e}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,l.systemTimer.callLater(this,this._typeset))}typeset(e){(this._isChanged||e)&&l.systemTimer.runCallLater(this,this._typeset,!0)}refreshLayout(){l.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new ja,this._objContainer.hideFlags|=be.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}hideText(e){this._hideText=e,e?this.graphics.clear(!0,this._bgDrawCmd):(this.markChanged(),this.typeset())}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;Gn.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let t,s=this._text;if(this._onTranslate&&(s=this._onTranslate(s,this._templateVars)),!s&&this._prompt&&(s=this._prompt,this._onTranslate&&(s=this._onTranslate(s,null,1)),t=!0),!s)return this.graphics.clear(!0,this._bgDrawCmd),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let r,i=this._html;if(s=s.replace(ro,"\n"),this._parseEscapeChars&&(s=s.replace(io,lo)),!t&&this._templateVars&&(s=Q.parseTemplate(s,this._templateVars)),this._ubb&&(s=jn.defaultParser.parse(s),i=!0),!t&&this._asPassword&&(s=Kn._passwordChar.repeat(s.length)),t&&(r=this._textStyle.color,this._textStyle.color=this._promptColor),i)qn.defaultParser.parse(s,this._textStyle,this._elements,this._htmlParseOptions);else{let t=Gn.getFromPool(e.HtmlElementType.Text);Object.assign(t.style,this._textStyle),t.text=s,this._elements.push(t)}t&&(this._textStyle.color=r),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let t,s=this._wordWrap||this._overflow==Kn.ELLIPSIS,r=this._wordWrap,i=this._padding;if(t=this._isWidthSet?this._width-i[3]-i[1]:Number.MAX_VALUE,this._maxWidth>0){let e=this._maxWidth-i[3]-i[1];(!s||e<t)&&(t=e),s=!0}let a,n,o,l,d,c,_,p,g=this._isHeightSet?this._height-i[0]-i[2]:Number.MAX_VALUE,m="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,f=this._bitmapFont,T=pi.runner._textRender,y=e=>{if(f)return f.getTextWidth(e,_);{let t=Y.context.measureText(e);return t?t.width:100}},x=(e,t,s)=>{if(f)return f.getTextWidth(e,s);{let s=Y.context.font;Y.context.font=t;let r=Y.context.measureText(e);return Y.context.font=s,r?r.width:100}},S=(e,t)=>{_=Math.floor(t.fontSize*this._fontSizeScale),0==_&&(_=1),f?(d=f.getMaxWidth(_),c=f.getMaxHeight(_)):(Y.context.font=p=(t.bold?"bold ":"")+_+"px "+this._realFont,d=_,c=T.getFontHeight(this._realFont,_,t.bold));let r=e.split("\n");if(s)for(let e=0,s=r.length;e<s;e++){let i=r[e];i.length>0&&b(i,t),e!=s-1&&w()}else for(let e=0,s=r.length;e<s;e++){let i=r[e];i.length>0&&E(i,t,null),e!=s-1&&w()}},E=(e,t,s)=>{let r=$n.length>0?$n.pop():{};r.x=a,r.y=n,"string"==typeof e?(s||(s=y(e)),r.text=e,r.ctxFont=p,r.fontSize=_,r.width=s,r.height=c):(r.obj=e,r.width=e.width,r.height=e.height,e.width>0&&(r.x++,r.width+=2)),r.style=t,r.linkEnd=!1,r.next=null,r.prev=l,a+=Math.round(r.width),l?l.next=r:o.cmd=r,l=r},v=e=>{for(;e.linkEnd&&e.next;)e=e.next;if(e)for(e.prev.next=null;e;){let t=e.next;e.x=a,e.y=n,e.next=null,e.prev=l,a+=Math.round(e.width),l?l.next=e:o.cmd=e,l=e,e=t}},D=(e,t)=>{if(uo(e.text.charCodeAt(t))&&t--,0==t)return!1;let s=e.text.substring(t);e.text=e.text.substring(0,t),e.width=x(e.text,e.ctxFont,e.fontSize);let r=$n.length>0?$n.pop():{};return r.text=s,r.style=e.style,r.ctxFont=e.ctxFont,r.fontSize=e.fontSize,r.width=x(s,e.ctxFont,e.fontSize),r.height=e.height,r.next=e.next,r.prev=e,e.next=r,!0},w=e=>{if(a=0,o){let e=0,t=0,s=o.cmd;for(;s;)s.height>e&&(e=s.height),t+=s.width,s=s.next;for(s=o.cmd;s;)s.y=1==m?Math.floor(.5*(e-s.height)):2==m?Math.floor(e-s.height):0,s=s.next;0==e&&(e=c),e++,o.height=e,o.width=Math.round(t),n+=o.height+Math.floor(this._textStyle.leading*this._fontSizeScale)}return e?null:(o=Qn.length>0?Qn.pop():{},o.x=0,o.y=n,this._lines.push(o),l=null,o)},b=(e,s)=>{let i=Math.max(0,t-a),n=y(e);if(n<=i)return void E(e,s,n);let o,h,u=0,c=0,_=0,p=eo.test(e);f||p||(u=Math.floor(i/d),0!=u&&(c=y(e.substring(0,u))));let g=e.length;for(let d=u;d<g;d++){let m=e.charAt(d),f=m.charCodeAt(0);if(p&&ho(f)&&d+1<g&&(m+=e.charAt(d+1)),n=y(m),c+=n,c<=i||d===_&&0===a){m.length>1&&d++;continue}let T=e.substring(_,d);if(c-=n,r&&(f>=65&&f<=90||f>=97&&f<=122||f>=48&&f<=57||(o=so.includes(f)))){let s=T.length>0?(h=to.exec(T))?h.index:null:0;if(s>0)s>T.length-oo&&(d=_+s,T=e.substring(_,d),c=null,n=null);else if(null!=s&&null!=l){let e=l,s=T.length,r=!1;for(;e;){if(e.width>0){if(null!=e.obj)break;h=to.exec(e.text);let t=e.text.length;if(null==h){w(),o&&0==s?D(e,t-1)?v(e.next):e.x>0&&v(e):null!=e.next&&v(e.next),r=!0;break}if(h.index>0){h.index>t-(oo-s)&&(w(),D(e,h.index),v(e.next),r=!0);break}if(s+=t,s>=oo)break}e=e.prev}if(r&&(i=t-a,c+n<i)){c+=n;continue}}else if(o){let t=p&&d>=1&&uo(e.charCodeAt(d-1))?2:1;(d-t>_||a>0)&&(d-=t,T=e.substring(_,d),c=null,n=null)}}T.length>0&&E(T,s,c),w(),_=d,i=t,c=null,u>1?d+=u-1:null!=n?(c=n,m.length>1&&d++):p&&ho(e.charCodeAt(d))&&d++,null==c&&d<g-1&&(c=y(e.substring(_,d+1)))}E(e.substring(_,g),s)},C=()=>{let e=0,t=0;for(let t of this._lines)t.width>e&&(e=t.width);e>0&&(e+=i[1]+i[3]),this._textWidth=e;let s=this._lines[this._lines.length-1];s&&(t=s.y+s.height),t>0&&(t+=i[0]+i[2]),this._textHeight=t},R=()=>{a=n=d=c=0,o=null,l=null,Zn(this._lines),w();let r=this._elements;for(let i=0,n=r.length;i<n;i++){let n=r[i];if(n.type==e.HtmlElementType.Text)S(n.text,n.style);else if(n.type==e.HtmlElementType.LinkEnd)l&&(l.linkEnd=!0);else{let e=n.obj;if(!e){let t=qn.classMap[n.type];t&&(e=h.createByClass(t),e.create(this,n),n.obj=e)}if(e){if(s){let s=t-a;e.width>0&&s<e.width+1&&a>0&&w()}E(e,n.style)}}}w(!0),C()};if(R(),this._overflow==Kn.SHRINK){if(this._lines.length>1&&this._textHeight>g){let e=0,s=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(g/this._textHeight);let r=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;R(),this._textWidth>t||this._textHeight>g?s=r:e=r,s-e>1||s!=e&&r==s;)r=e+(s-e)/2,this._fontSizeScale=r/this._textStyle.fontSize}else if(this._textWidth>t&&(this._fontSizeScale=t/this._textWidth,R(),this._textWidth>t)){let e=Math.floor(this._textStyle.fontSize*this._fontSizeScale);e--,this._fontSizeScale=e/this._textStyle.fontSize,R()}}else if(this._overflow==Kn.ELLIPSIS&&(this._textWidth>t||this._textHeight>g||!this._wordWrap&&this._lines.length>1)){let e;!this._wordWrap&&this._lines.length>1?e=1:(e=this._lines.findIndex(e=>e.y+e.height>g),0===e&&(e=1));let s=!1;-1!=e&&this._lines.length>e&&(Zn(this._lines.splice(e,this._lines.length-e),!0),s=!0),o=this._lines[this._lines.length-1];let r,i,a=o.cmd,n=!1;for(;a;){if(r=a.next,a.obj||(i=a),n)Jn(a,!0),$n.push(a);else if(!r&&s||a.x+a.width>t-10){if(a.obj)Jn(a,!0),a.text=no,i?(a.ctxFont=i.ctxFont,a.fontSize=i.fontSize,a.height=i.height,a.style=i.style):(a.ctxFont=p,a.fontSize=_,a.height=c,a.style=this._textStyle);else{let e=a.x+a.width-t,s=e<5?2:e<10?1:0,r=a===o.cmd?1:0,i=a.text.length;for(;i>r&&s>0;)uo(a.text.charCodeAt(i-1))&&i--,i--,s--;a.text=a.text.substring(0,i)+no}a.width=x(a.text,a.ctxFont,a.fontSize),a.next=null,n=!0,w(!0)}a=r}(n||s)&&C()}this._onPostLayout&&this._onPostLayout();let M="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=M&&this._isWidthSet){let e=this._width-i[3]-i[1];for(let t of this._lines){let s=0;1==M?s=Math.floor(.5*(e-t.width)):2==M&&(s=e-t.width),s>0&&(t.x=s)}}if(this._isHeightSet&&this._textHeight<this._height){let e=0;if("middle"===this._textStyle.valign?e=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(e=this._height-this._textHeight),e>0)for(let t of this._lines)t.y+=e}if(this._overflow==Kn.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let e=this.maxScrollX,t=this.maxScrollY;this._scrollPos.x>e&&(this._scrollPos.x=e),this._scrollPos.y>t&&(this._scrollPos.y=t)}else this._scrollPos=new u(0,0);else this._scrollPos=null;if(this._objContainer)if(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Kn.HIDDEN&&this._objContainer.numChildren>0){let e=this._objContainer.scrollRect||new te,t=this._isWidthSet?this._width:this._textWidth,s=this._isHeightSet?this._height:this._textHeight;this._objContainer.scrollRect=e.setTo(0,0,t,s)}else this._objContainer.scrollRect=null;this._updatingLayout=!1,this.renderText()}renderText(){let t=this.graphics;t.clear(!0,this._bgDrawCmd),this._fontGlobalScale=Or.fontScale;let s=this._padding,r=s[3],i=s[0],a=this._bitmapFont,n=this._scrollPos,o=this._isWidthSet?this._width:this._textWidth,l=this._isHeightSet?this._height:this._textHeight,h=l-s[2],d=this._overflow==Kn.HIDDEN||this._overflow==Kn.SCROLL;o-=s[3]+s[1],l-=s[0]+s[2];let u,c,_=0,p=0,g=this._lines,m=g.length;for(let s=0;s<m;s++){let l=g[s];_=r+l.x,p=i+l.y,n&&(_-=n.x,p-=n.y);let m=d&&(p+l.height<=i||p>=h),f=l.cmd;for(;f;){if(f.linkEnd&&u&&(u.addRect(c,p,_+f.x+f.width-c,l.height),u=null),f.obj)f.obj.pos(_+f.x,p+f.y),f.obj.element.type==e.HtmlElementType.Link&&(u=f.obj,u.resetArea(),c=_+f.x);else if(!m)if(a){let e=0,s=f.text,r=a.tint?f.style.color:"#FFFFFF",i=Math.floor((a.autoScaleSize?f.style.fontSize:a.fontSize)*this._fontSizeScale)/a.fontSize;for(let n=0,o=s.length;n<o;n++){let o=s.charCodeAt(n),l=a.dict[o];l&&(l.texture&&t.drawImage(l.texture,_+f.x+e+l.x*i,p+f.y+l.y*i,l.width*i,l.height*i,r),e+=Math.round(l.advance*i))}}else{let e=mi.create(f.text,_+f.x,p+f.y,null,f.style.color,null,f.style.stroke,f.style.strokeColor);e.fontFamily=this._realFont,e.fontSize=f.fontSize,e.bold=f.style.bold,e.italic=f.style.italic,e.singleCharRender=this._singleCharRender,e._preMeasuredWidth=f.width,t.addCmd(e)}if(!m&&f.width>0){if(f.style.underline){let e=Math.max(1,f.fontSize/16);t.drawLine(_+f.x,p+l.height-e,_+f.x+f.width,p+l.height-e,f.style.underlineColor||f.style.color,e)}if(f.style.strikethrough){let e=Math.max(1,f.fontSize/16),s=_+f.x,r=p+l.height/2-e|0,i=4;t.drawLine(s-i,r,s+f.width+i,r,f.style.strikethroughColor||f.style.color,e)}}f=f.next}u&&(u.addRect(c,p,o-c+r,l.height),c=r)}d&&this._updateScrollRect()}drawBg(){let e=this._bgDrawCmd;if(this._bgColor||this._borderColor){e||(e=new Ht,e.x=e.y=0,e.width=e.height=1,e.percent=!0,e.lock=!0,this._bgDrawCmd=e),e.fillColor=this._bgColor,e.lineColor=this._borderColor,e.lineWidth=this._borderColor?1:0;let t=this.graphics.cmds,s=t.indexOf(e);0!==s?(-1!==s&&t.splice(s,1),t.unshift(e),this.graphics.cmds=t):this.graphics.repaint()}else e&&(this.graphics.removeCmd(e,!0),this._bgDrawCmd=null)}_setParent(e){super._setParent(e),e&&null!=this._fontGlobalScale&&this._fontGlobalScale!==Or.fontScale&&this.repaint()}}Kn.VISIBLE="visible",Kn.SCROLL="scroll",Kn.HIDDEN="hidden",Kn.SHRINK="shrink",Kn.ELLIPSIS="ellipsis",Kn.RightToLeft=!1,Kn._passwordChar="●",Kn._bitmapFonts={};const $n=[],Qn=[];function Zn(e,t){for(let s of e){let e=s.cmd;for(;e;)Jn(e,t),$n.push(e),e=e.next;s.cmd=null}Qn.push(...e),e.length=0}function Jn(e,t){e.obj&&(t&&(e.obj.element.obj=null,e.obj.release(),h.recoverByClass(e.obj)),e.obj=null)}const eo=/[\uD800-\uDBFF][\uDC00-\uDFFF]/,to=/[a-zA-Z0-9\!-\+\/_]+$/,so=Array.from(".,，。、!！；;”’)）]】}》").map(e=>e.charCodeAt(0)),ro=/\r\n/g,io=/\\(\w)/g,ao={"\\n":"\n","\\t":"\t"},no="…",oo=20;function lo(e){return ao[e]}function ho(e){return e>=55296&&e<=56319}function uo(e){return e>=56320&&e<=57343}class co extends Kn{constructor(){super(),this.confirmType="done",this.maxChars=0,this._multiline=!1,this._editable=!0,this._width=100,this._height=20,this._type="text",this._promptColor="#a9a9a9",this.overflow=Kn.SCROLL,this.valign="middle",this.mouseEnabled=!0}get multiline(){return this._multiline}set multiline(e){this._multiline!=e&&(this._multiline=e,this.wordWrap=e,this.valign=e?"top":"middle")}get focus(){return W.textInput.target===this}set focus(e){e?W.textInput.begin(this):this===W.textInput.target&&W.textInput.end()}get text(){return W.textInput.target===this&&W.textInput.syncText(),super.text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),W.textInput.target===this?(W.textInput.setText(e),this.event(c.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),super.text=e)}get editable(){return this._editable}set editable(e){this._editable=e}get prompt(){return this._prompt}set prompt(e){var t;null==e&&(e=""),e=(null===(t=Kn.langPacks)||void 0===t?void 0:t[e])||e,this._prompt!=e&&(this._prompt=e,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(e){this._promptColor!=e&&(this._promptColor=e,this.markChanged())}get type(){return this._type}set type(e){this._asPassword="password"===e,this._type=e,this.markChanged()}setSelection(e,t){this.focus=!0,W.textInput.setSelection(e,t)}select(){this.focus=!0,W.textInput.setSelection(0,-1)}}co.TYPE_TEXT="text",co.TYPE_PASSWORD="password",co.TYPE_EMAIL="email",co.TYPE_URL="url",co.TYPE_NUMBER="number",co.TYPE_RANGE="range",co.TYPE_DATE="date",co.TYPE_MONTH="month",co.TYPE_WEEK="week",co.TYPE_TIME="time",co.TYPE_DATE_TIME="datetime",co.TYPE_DATE_TIME_LOCAL="datetime-local",co.TYPE_SEARCH="search";class _o extends ja{constructor(){super(),this._loop=1,p.isPlaying&&(this.on(c.ADDED,()=>{this.target=this.parent}),this.on(c.REMOVED,()=>{this.target=null}),this.on(c.DISPLAY,this,this.onDisplay),this.on(c.UNDISPLAY,this,this.onUndisplay))}get source(){return this._source}set source(e){this._source=e,e?this.activeInHierarchy&&(this._autoPlay||this._channel)&&p.isPlaying&&this.play(this._loop):this.stop()}get isMusic(){return this._isMusic}set isMusic(e){this._isMusic=e}get loop(){return this._loop}set loop(e){this._loop=e}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,this.activeInHierarchy&&e&&!this._channel&&p.isPlaying&&this.play(this._loop)}play(e,t,s){this._source&&((null==e||isNaN(e))&&(e=this._loop),this.stop(),this._isMusic?this._channel=xn.playMusic(this._source,e,t,s):this._channel=xn.playSound(this._source,e,t,s))}stop(){this._channel&&this._channel.stop(),this._channel=null}_setPlayAction(e,t,s,r=!0){this[s]&&e&&(r?e.on(t,this,this[s]):e.off(t,this,this[s]))}_setPlayActions(e,t,s,r=!0){if(!e)return;if(!t)return;let i=t.split(","),a=i.length;for(let t=0;t<a;t++)this._setPlayAction(e,i[t],s,r)}set playEvent(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}set target(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}onDisplay(){this._autoPlay&&!this._channel&&this.play(this._loop)}onUndisplay(){this.stop()}}class po extends ja{constructor(){super(),this.options={controls:!1,objectFit:"contain"},this.mode="decoder",this._autoPlay=!1,this._loop=!1,this._volume=1,this._muted=!1,this._playbackRate=1,this._allowBackground=!1,this._paused=!1,this.on(c.DISPLAY,this,this.onDisplay),this.on(c.UNDISPLAY,this,this.onUndisplay)}get player(){return this._api}get source(){return this._source}set source(e){this._source=e,e?this.activeInHierarchy&&this._load():this._unload()}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,this._api&&p.isPlaying&&(e?this._api.play():this._api.pause())}get allowBackground(){return this._allowBackground}set allowBackground(e){this._allowBackground=e,this._api&&(this._api.allowBackground=e)}get currentTime(){var e;return null===(e=this._api)||void 0===e?void 0:e.currentTime}set currentTime(e){this._api&&(this._api.currentTime=e)}get readyState(){var e,t;return null!==(t=null===(e=this._vtex)||void 0===e?void 0:e.readyState)&&void 0!==t?t:0}get videoWidth(){var e;return null===(e=this._vtex)||void 0===e?void 0:e.videoWidth}get videoHeight(){var e;return null===(e=this._vtex)||void 0===e?void 0:e.videoHeight}get duration(){var e;return null===(e=this._api)||void 0===e?void 0:e.duration}get ended(){var e;return null===(e=this._api)||void 0===e?void 0:e.ended}get loop(){return this._loop}set loop(e){this._loop=e,this._api&&(this._api.loop=e)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._api&&(this._api.playbackRate=e)}get volume(){return this._volume}set volume(e){this._volume=e,this._api&&(this._api.volume=e)}get muted(){return this._muted}set muted(e){this._muted=e,this._api&&(this._api.muted=e)}get paused(){return this._paused}load(e){this.source=e}play(){this._api&&this._api.play()}pause(){this._paused=!0,this._api&&this._api.pause()}reload(){this.source=this._source}canPlayType(e){return W.media.canPlayType(e)}_load(){let e,t;"player"===(p.isPlaying?this.mode:"decoder")?(e=this._player||W.media.createVideoPlayer(),e||(t=W.media.createVideoTexture())):(t=this._vtex||W.media.createVideoTexture(),t||(e=W.media.createVideoPlayer())),e?(this._player!==e&&(this._player=e,this._player.attachTo(this),this._player.options=this.options),this._vtex&&(this._vtex.destroy(),this._vtex=null,this.texture=null)):(this._vtex!==t&&(this._vtex=t,this._vtex.on(c.READY,this,this._vtReady),this._vtex.on("videoUpdate",this,this.reCache),this._tex||(this.texture=this._tex=new ie)),this._player&&(this._player.destroy(),this._player=null)),this._api=e||t,this._api.loop=this._loop,this._api.volume=this._volume,this._api.muted=this._muted,this._api.playbackRate=this._playbackRate,this._api.allowBackground=this._allowBackground,this._autoPlay&&!this._paused&&p.isPlaying?this._api.play():this._api.pause(),this._api.load(this._source)}_vtReady(){this._tex.setTo(this._vtex),this.graphics.repaint()}_unload(){var e;this._vtex&&(this._vtex.off(c.READY,this,this._vtReady),this._vtex.off("videoUpdate",this,this.reCache),this._vtex.destroy(),this._vtex=null),null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._api=null}onDisplay(){!this._api&&this._source&&this._load()}onUndisplay(){this._unload()}destroy(e=!0){this._unload(),super.destroy(e)}get currentSrc(){return this._source}get videoTexture(){return this._vtex}set videoTexture(e){this.source=e?e.source:null}}class go{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var s=this._elapsedTime/t%1;this._normalizedPlayTime=s<0?s+1:s,this._frontPlay=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playNum=this._playNum,e._parentPlayTime=this._parentPlayTime,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront,e._frontPlay=this._frontPlay,e._playAllTime=this._playAllTime}}class mo{constructor(e){this._referenceCount=0,this._playStateInfo=new go,this._crossPlayStateInfo=new go,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=mo.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=e}get states(){return this._states}set states(e){if(this._states!==e){for(let e=this.states.length-1;e>=0;e--)this.removeState(this.states[e]);for(let t=e.length-1;t>=0;t--)this.addState(e[t])}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}set defaultStateName(e){if(this._defaultState=this.getStateByName(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}_removeClip(e,t,s){e.splice(t,1)}_getReferenceCount(){return this._referenceCount}_addReference(e){for(var t=0,s=this._states.length;t<s;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,s=this._states.length;t<s;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(e){for(let t=this._states.length-1;t>=0;t--)if(this._states[t].name==e)return this._states[t];return null}addState(e){var t=e.name;if(this.getStateByName(t))throw new Error("AnimatorControllerLayer:this stat's name has exist.");this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null)}removeState(e){for(var t=this._states,s=-1,r=0,i=t.length;r<i;r++)if(t[r]===e){s=r;break}-1!=s&&this._removeClip(t,s,e)}clone(){var e=new mo(this.name);return this.cloneTo(e),e}cloneTo(e){e.name=this.name}destroy(){this._removeReference();for(var e=0,t=this._states.length;e<t;e++)this._states[e].destroy();this._states.length=0}}var fo,To,yo,xo,So;mo.BLENDINGMODE_OVERRIDE=0,mo.BLENDINGMODE_ADDTIVE=1,e.AniParmType=void 0,(fo=e.AniParmType||(e.AniParmType={}))[fo.Float=0]="Float",fo[fo.Bool=1]="Bool",fo[fo.Trigger=2]="Trigger",e.AniStateConditionType=void 0,(To=e.AniStateConditionType||(e.AniStateConditionType={}))[To.Number=0]="Number",To[To.Bool=1]="Bool",To[To.Trigger=2]="Trigger",e.AniStateConditionNumberCompressType=void 0,(yo=e.AniStateConditionNumberCompressType||(e.AniStateConditionNumberCompressType={}))[yo.Less=0]="Less",yo[yo.Greater=1]="Greater";class Eo{static parse(e){let t=e,s=t.controllerLayers;null==s&&(s=[]);let r=[];for(let e=s.length-1;e>=0;e--){let i=s[e],a=i.states;a||(a=[],i.states=a),i.defaultStateName=null;let n=this.checkStates(a,r,t);n?i.defaultStateName=n.enterName:s.splice(e,1)}return{ret:t,clipsID:r}}static checkStates(e,t,s){let r=null,i=null;for(let a=e.length-1;a>=0;a--){let n=e[a];n.states?null==this.checkStates(n.states,t,s)?e.splice(a,1):(null==r&&(r=[]),r.push(n)):"-1"==n.id?i=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?e.splice(a,1):(0>t.indexOf(n.clip._$uuid)&&t.push(n.clip._$uuid),this.checkNext(n,e,s),null==r&&(r=[]),r.push(n)))}let a=null;if(r&&i){let e=this.checkDefault(i,r);null!=e&&(a={states:r,enterName:e})}return a}static checkNext(e,t,s){let r=e.soloTransitions;if(r)for(let e=r.length-1;e>=0;e--){let i=r[e],a=this.getStateByID(t,i.id);!a||null==a.clip&&"-3"!=a.id&&null==a.states?r.splice(e,1):(i.name=a.name,i.conditions=this.checkConditions(i.conditions,s))}}static checkConditions(t,s){if(!t||0==t.length||null==s.animatorParams||0==s.animatorParams.length)return[];let r=s.animatorParams;for(let s=t.length-1;s>=0;s--){let i=t[s],a=null;for(let e=r.length-1;e>=0;e--)if(r[e].id==i.id){a=r[e];break}if(null==a)t.splice(s,1);else if(i.name=a.name,a.type==e.AniParmType.Float){let e=Number(i.checkValue);isNaN(e)&&(i.checkValue=0),e=Number(i.type),isNaN(e)&&(i.type=0)}}return t}static checkDefault(e,t){let s=e.soloTransitions,r=null;s&&0<s.length&&(r=s[0].id);let i=null;if(null!=r&&(i=this.getStateByID(t,r)),null!=i&&(null!=i.clip||null!=i.states))return i.name;for(let e=t.length-1;e>=0;e--)if(t[e].clip)return t[e].name;return null}static getStateByID(e,t){if(e)for(let s=e.length-1;s>=0;s--)if(e[s].id==t)return e[s];return null}}e.AnimatorUpdateMode=void 0,(xo=e.AnimatorUpdateMode||(e.AnimatorUpdateMode={}))[xo.Normal=0]="Normal",xo[xo.LowFrame=1]="LowFrame",xo[xo.UnScaleTime=2]="UnScaleTime";class vo extends fa{constructor(){super(),this._speed=1,this._updateMode=e.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._isPlayBack=!1,this._controllerLayers=[],this._parameters={}}get controller(){return this._controller}set controller(e){this._controller&&this._controller._removeReference(),this._controller=e,e&&(e._addReference(),e.updateTo(this))}get parameters(){return this._parameters}set parameters(e){this._parameters=e}get speed(){return this._speed}set speed(e){this._speed=e}get isPlaying(){return this._isPlaying}_updateStateFinish(e,t){t._finish&&(this.owner._renderType&$e.GRAPHICS&&this.owner.graphics.repaint(),e._eventExit())}_switchState(e,t){e&&e._eventSwitch(t)}_setClipDatasToNode(e,t,s,r=null){for(var i=e._realtimeDatas,a=e._clip._nodes,n=0,o=a.count;n<o;n++)if(null!=i[n]){var l=a.getNodeByIndex(n),h=this.getOwner(l);h&&this._applyFloat(h,t,s,i[n])}}_applyFloat(e,t,s,r){var i=e.pro;if(i&&i.ower)if(t&&"number"==typeof r)i.ower[i.key]=i.defVal+s*r;else if("number"==typeof r)i.ower[i.key]=s*r;else{if("string"==typeof r&&r.startsWith("tres://")){let e=r.replace("tres://",""),t=Te.getRes(e,Te.IMAGE);if(!t)return void l.loader.load(e,{type:Te.IMAGE}).then(e=>{this.destroyed||(i.ower[i.key]=e)});r=t}i.ower[i.key]=r}}getOwner(e){var t;if(this._ownerMap&&(t=this._ownerMap.get(e)))return t;for(var s=this.owner,r=0,i=e.ownerPathCount;r<i;r++){var a=e.getOwnerPathByIndex(r);if(""!=a&&!(s=s.getChild(a)))break}if(t={ower:s},s){var n=s,o=e.propertyCount;if(1==o){var l=e.getPropertyByIndex(0);t.pro={ower:s,key:l,defVal:s[l]}}else for(var h=0;h<o;h++){l=e.getPropertyByIndex(h);if(h==o-1||null==n){t.pro={ower:n,key:l,defVal:n?n[l]:null};break}if("_gcmds"===l&&null==n[l]&&n.graphics&&(n=n.graphics,l="cmds"),null==n[l]&&s==n){n=null;var d=Ee.getClass(l);d&&(n=s.getComponent(d))}else n=n[l]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(e,t),t}_updateClipDatas(e,t,s){var r=e._clip,i=r._duration,a=e.clipStart*i+s._normalizedPlayTime*s._duration,n=e._currentFrameIndices;let o=s._frontPlay;r._evaluateClipDatasRealTime(a,n,t,o,e._realtimeDatas)}_updatePlayer(e,t,s,r,i){t._playAllTime+=Math.abs(s);const a=e.clipEnd-e.clipStart;var n=e._clip._duration*a,o=t._elapsedTime,l=o+s;t._lastElapsedTime=o,t._elapsedTime=l;var h=l/n%1;const d=h<0?h+1:h;t._normalizedPlayTime=d,t._duration=n;let u=Math.floor(Math.abs(o)/n),c=Math.floor(Math.abs(l)/n);e.yoyo&&(this._isPlayBack=0!=Math.floor(c)%2,this._isPlayBack&&(t._normalizedPlayTime=1-t._normalizedPlayTime),u=Math.floor(u/2),c=Math.floor(c/2)),0<r&&r<=c&&(t._finish=!0,e.yoyo?t._normalizedPlayTime=0:t._normalizedPlayTime=1);const _=u!=c;_&&e._eventLoop(),e._eventStateUpdate(t._normalizedPlayTime),this._applyTransition(i,e._eventtransition(d,this.parameters,_))}_updateEventScript(e,t){let s=e._clip,r=s._animationEvents;if(!r||0==r.length)return;let i=s._duration;var a=t.animatorState.clipStart*i+t._normalizedPlayTime*t._duration;let n=t._frontPlay;0>t._currentState.speed&&(n=!n),this._isPlayBack&&(n=!n);let o=t._parentPlayTime,l=t._parentPlayTime;if(null==l&&(l=n?i*t.animatorState.clipStart:i*t.animatorState.clipEnd),n){if(a<l){const e=t.animatorState.clipStart*i+t._duration;this._eventScript(r,l,e,!0),l=t.animatorState.clipStart*i}}else if(a>l){const e=t.animatorState.clipStart*i;this._eventScript(r,l,e,!1),l=t.animatorState.clipStart*i+t._duration}this._eventScript(r,l,a,n),o==t._parentPlayTime&&(t._parentPlayTime=a)}_eventScript(e,t,s,r){let i=this.owner.components;if(r)for(let r=0,a=e.length;r<a;r++){let a=e[r];if(a.time>t&&a.time<=s)for(let e=0,t=i.length;e<t;e++){let t=i[e];if(t._isScript()){let e=t[a.eventName];e&&e.apply(t,a.params)}}else if(a.time>s)break}else for(let r=e.length-1;r>=0;r--){let a=e[r];if(a.time<t&&a.time>=s)for(let e=0,t=i.length;e<t;e++){let t=i[e];if(t._isScript()){let e=t[a.eventName];e&&e.apply(t,a.params)}}else if(a.time<s)break}}_applyTransition(e,t){return!!t&&this.crossFade(t.destState.name,e,t.transstartoffset,t.transduration)}_applyUpdateMode(t){let s;switch(this._updateMode){case e.AnimatorUpdateMode.Normal:s=t;break;case e.AnimatorUpdateMode.LowFrame:s=Vi.loopCount%this._lowUpdateDelty==0?t*this._lowUpdateDelty:0;break;case e.AnimatorUpdateMode.UnScaleTime:s=0}return s}gotoAndStopByFrame(e,t,s){var r=this._controllerLayers[t];if(r){var i=r.getStateByName(e);if(!i||!i._clip)return;let a=s/(i._clip._duration*i._clip._frameRate);1<a&&(a=1),this.gotoAndStop(e,t,a)}}getControllerLayer(e=0){return this._controllerLayers[e]}gotoAndStop(e,t,s){var r=this._controllerLayers[t];if(r){var i=r.getStateByName(e);if(!i||!i._clip)return;var a=r._playStateInfo,n=a._currentState,o=i._clip._duration,l=i._clip._duration*(i.clipEnd-i.clipStart);a._resetPlayState(o*s,l),a._normalizedPlayTime=s,r._playType=0,n!==i&&(a._currentState=i,this._switchState(n,i)),i._eventStart(this,t);let h=r.blendingMode!=mo.BLENDINGMODE_OVERRIDE;this._updateClipDatas(i,h,a),this._setClipDatasToNode(i,h,r.defaultWeight,r),this.stop()}}play(e,t=0,s=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let e=this._checkEnterIndex.indexOf(t);0<=e&&this._checkEnterIndex.splice(e,1)}this._isPlaying=!0;var r=this._controllerLayers[t];if(r){var i=r.defaultState;if(!e&&!i)throw new Error("Animator:must have default clip value,please set clip property.");var a=r._playStateInfo,n=a._currentState,o=e?r.getStateByName(e):i;if(!o._clip)return;var l=o._clip._duration,h=o._clip._duration*(o.clipEnd-o.clipStart);n!==o?(s!==Number.NEGATIVE_INFINITY?a._resetPlayState(l*s,h):a._resetPlayState(0,h),r._playType=0,a._currentState=o):s!==Number.NEGATIVE_INFINITY?(a._resetPlayState(l*s,h),r._playType=0):a._resetPlayState(l*o.clipStart,h),this._switchState(n,o),o._eventStart(this,t)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let t=this._checkEnterIndex.length-1;t>=0;t--){let s=this._checkEnterIndex[t];if(this._controllerLayers[s]._enterTransition.check(0,this.parameters,!0)){var e=this.getDefaultState(s);this.play(null,s,e.cycleOffset)}}var t=this.owner.timer.delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var s=0,r=this._controllerLayers.length;s<r;s++){var i=this._controllerLayers[s];if(i.enable){var a=i._playStateInfo,n=i.blendingMode!=mo.BLENDINGMODE_OVERRIDE;if(0===i._playType){var o=a._currentState,l=this._speed*o.speed,h=a._finish,d=o.loop;-1>=d&&(d=o._clip.islooping?0:1);let e=1;a._frontPlay||(e=-1),h||this._updatePlayer(o,a,t*l*e,d,s),o=(a=i._playStateInfo)._currentState,this._updateClipDatas(o,n,a),h||(this._setClipDatasToNode(o,n,i.defaultWeight,i),this._updateEventScript(o,a)),h||this._updateStateFinish(o,a)}}}}}addControllerLayer(e){this._controllerLayers.push(e)}crossFade(e,t=0,s=Number.NEGATIVE_INFINITY,r){var i=this._controllerLayers[t];if(i){if(i.getStateByName(e))return this.play(e,t,s),!0;console.warn("Invalid layerIndex "+t+".")}return!1}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){var s=this.getDefaultState(e);if(s){let t=this._controllerLayers[e]._enterTransition;t?(this._isPlaying=!0,t.check(0,this.parameters,!0)?this.play(null,e,s.cycleOffset):this._checkEnterIndex.push(e)):this.play(null,e,s.cycleOffset)}}}getDefaultState(e=0){return this._controllerLayers[e].defaultState}setParamsTrigger(t){const s=this._parameters[t];s&&s.type===e.AniParmType.Trigger?s.value=!0:this._parameters[t]={name:t,type:e.AniParmType.Trigger,value:!0}}setParamsNumber(t,s){const r=this._parameters[t];r&&r.type===e.AniParmType.Float?r.value=s:this._parameters[t]={name:t,type:e.AniParmType.Float,value:s}}setParamsBool(t,s){const r=this._parameters[t];r&&r.type===e.AniParmType.Bool?r.value=s:this._parameters[t]={name:t,type:e.AniParmType.Bool,value:s}}getParamsvalue(e){let t=this._parameters[e];return t?t.value:null}onDestroy(){this._controller&&(this._controller._removeReference(),this._controller=null);for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class Do extends N{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(e){if(this._clip!=e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=e._nodes.count;this._currentFrameIndices=new Int16Array(t),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=t}this._clip=e}}_eventStateUpdate(e){if(this.event(Do.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,s=this._scripts.length;t<s;t++)this._scripts[t].onStateUpdate(e)}_eventStart(e,t){if(this.event(Do.EVENT_OnStateEnter),this._scripts)for(var s=0,r=this._scripts.length;s<r;s++)this._scripts[s].setPlayScriptInfo(e,t,this),this._scripts[s].onStateEnter()}_eventExit(){if(this.event(Do.EVENT_OnStateExit),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventSwitch(e){if(this.event(Do.EVENT_OnStateSwitch,e),this._scripts)for(let t=0,s=this._scripts.length;t<s;t++)this._scripts[t].onStateSwitch&&this._scripts[t].onStateSwitch(e)}_eventLoop(){if(this.event(Do.EVENT_OnStateLoop),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateLoop&&this._scripts[e].onStateLoop()}_eventtransition(e,t,s){let r=this.soloTransitions.length;if(r>0){for(var i=0;i<r;i++)if(this.soloTransitions[i].check(e,t,s))return this.soloTransitions[i];return null}let a=this.transitions.length;for(i=0;i<a;i++)if(this.transitions[i].check(e,t,s))return this.transitions[i];return null}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}_getReferenceCount(){return this._referenceCount}_addReference(e){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,s=this._scripts.length;t<s;t++){var r=this._scripts[t];if(r instanceof e)return r}return null}getScripts(e){var t=null;if(this._scripts)for(var s=0,r=this._scripts.length;s<r;s++){var i=this._scripts[s];i instanceof e&&(t=t||[]).push(i)}return t}clone(){var e=new Do;return this.cloneTo(e),e}cloneTo(e){e.name=this.name,e.speed=this.speed,e.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}Do.EVENT_OnStateEnter="OnStartEnter",Do.EVENT_OnStateUpdate="OnStateUpdate",Do.EVENT_OnStateExit="OnStateExit",Do.EVENT_OnStateSwitch="OnStateSwitch",Do.EVENT_OnStateLoop="OnStateLoop";class wo{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_setKeyframeCount(e){this._keyFrames.length=e}_joinOwnerPath(e){return this._ownerPath.join(e)}_joinProperty(e){return this._propertys.join(e)}getKeyframeByIndex(e){return this._keyFrames[e]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}}class bo{clone(){var e=new bo;return this.cloneTo(e),e}cloneTo(e){e.time=this.time}}bo.defaultWeight=.33333;class Co{constructor(){}}e.CurveType=void 0,(So=e.CurveType||(e.CurveType={}))[So.CRSpline=0]="CRSpline",So[So.Bezier=1]="Bezier",So[So.CubicBezier=2]="CubicBezier",So[So.Straight=3]="Straight";class Ro{constructor(){this.pos=new a,this.c1=new a,this.c2=new a,this.curve=0}static create(e,t,s,r){let i=Mo.take();return i.pos.set(e,t,s),i.curve=r||0,i}recover(){Mo.recover(this)}clone(){let e=Mo.take();return this.pos.cloneTo(e.pos),this.c1.cloneTo(e.c1),this.c2.cloneTo(e.c2),e.curve=this.curve,e}_reset(){this.pos.set(0,0,0),this.c1.set(0,0,0),this.c2.set(0,0,0),this.curve=0}}const Mo=h.createPool(Ro,null,e=>e._reset());class Ao{constructor(){this._segments=[],this._points=[],this._curPt=new a}get length(){return this._fullLength}create(...t){this._segments.length=0;let s=this._points;Lo.recover(this._points),this._fullLength=0,this._cacheT=null;let r=t.length;if(0==r)return;let i=[],n=t[0];n.curve==e.CurveType.CRSpline&&i.push(n.pos.cloneTo(Lo.take()));for(let o=1;o<r;o++){let r=t[o];if(n.curve!=e.CurveType.CRSpline){let t={};t.type=n.curve,t.ptStart=s.length,n.curve==e.CurveType.Straight?(t.ptCount=2,s.push(n.pos.cloneTo(Lo.take())),s.push(r.pos.cloneTo(Lo.take()))):n.curve==e.CurveType.Bezier?(t.ptCount=3,s.push(n.pos.cloneTo(Lo.take())),s.push(r.pos.cloneTo(Lo.take())),s.push(n.c1.cloneTo(Lo.take()))):n.curve==e.CurveType.CubicBezier&&(t.ptCount=4,s.push(n.pos.cloneTo(Lo.take())),s.push(r.pos.cloneTo(Lo.take())),s.push(n.c1.cloneTo(Lo.take())),s.push(n.c2.cloneTo(Lo.take()))),t.length=a.distance(n.pos,r.pos),this._fullLength+=t.length,this._segments.push(t)}r.curve!=e.CurveType.CRSpline?i.length>0&&(i.push(r.pos.cloneTo(Lo.take())),this.createSplineSegment(i)):i.push(r.pos.cloneTo(Lo.take())),n=r}i.length>1&&this.createSplineSegment(i)}createSplineSegment(t){let s=t.length;t.splice(0,0,t[0].cloneTo(Lo.take())),t.push(t[s].cloneTo(Lo.take())),t.push(t[s].cloneTo(Lo.take())),s+=3;let r={};r.type=e.CurveType.CRSpline,r.ptStart=this._points.length,r.ptCount=s,this._points.push(...t),r.length=0;for(let e=1;e<s;e++)r.length+=a.distance(t[e-1],t[e]);this._fullLength+=r.length,this._segments.push(r),t.length=0}clear(){this._segments.length=0,this._points.length=0}getPointAt(t){let s=this._curPt;if((t=ut.clamp01(t))===this._cacheT)return s;s.set(0,0,0),this._cacheT=t;let r=this._segments.length;if(0==r)return s;let i=this._points;if(1==t){let n=this._segments[r-1];return n.type==e.CurveType.Straight?a.lerp(i[n.ptStart],i[n.ptStart+1],t,s):n.type==e.CurveType.Bezier||n.type==e.CurveType.CubicBezier?this.onBezierCurve(n.ptStart,n.ptCount,t,s):this.onCRSplineCurve(n.ptStart,n.ptCount,t,s),s}for(let n=0,o=t*this._fullLength;n<r;n++){let r=this._segments[n];if(o-=r.length,o<0){t=1+o/r.length,r.type==e.CurveType.Straight?a.lerp(i[r.ptStart],i[r.ptStart+1],t,s):r.type==e.CurveType.Bezier||r.type==e.CurveType.CubicBezier?this.onBezierCurve(r.ptStart,r.ptCount,t,s):this.onCRSplineCurve(r.ptStart,r.ptCount,t,s);break}}return s}get segmentCount(){return this._segments.length}getAnchorsInSegment(e,t){null==t&&(t=[]);let s=this._points,r=this._segments[e];for(let e=0;e<r.ptCount;e++)t.push(s[r.ptStart+e]);return t}getPointsInSegment(t,s,r,i,n,o){null==i&&(i=[]),o&&!isNaN(o)||(o=.1);let l=this._points;n&&n.push(s);let h=this._segments[t];if(h.type==e.CurveType.Straight){let e=new a;a.lerp(l[h.ptStart],l[h.ptStart+1],s,e),i.push(e),e=new a,a.lerp(l[h.ptStart],l[h.ptStart+1],r,e),i.push(e)}else{let t;t=h.type==e.CurveType.Bezier||h.type==e.CurveType.CubicBezier?this.onBezierCurve:this.onCRSplineCurve,i.push(t.call(this,h.ptStart,h.ptCount,s,new a));let l=Math.min(h.length*o,50);for(let e=0;e<=l;e++){let o=e/l;o>s&&o<r&&(i.push(t.call(this,h.ptStart,h.ptCount,o,new a)),n&&n.push(o))}i.push(t.call(this,h.ptStart,h.ptCount,r,new a))}return n&&n.push(r),i}getAllPoints(e,t,s){null==e&&(e=[]),s&&!isNaN(s)||(s=.1);for(let r=0,i=this._segments.length;r<i;r++)this.getPointsInSegment(r,0,1,e,t,s);return e}onCRSplineCurve(e,t,s,r){let i=Math.floor(s*(t-4))+e,a=this._points,n=a[i],o=a[i+1],l=a[i+2],h=a[i+3],d=1==s?1:ut.repeat(s*(t-4),1),u=((2-d)*d-1)*d*.5,c=.5*((3*d-5)*d*d+2),_=((-3*d+4)*d+1)*d*.5,p=(d-1)*d*d*.5;return r.x=n.x*u+o.x*c+l.x*_+h.x*p,r.y=n.y*u+o.y*c+l.y*_+h.y*p,r.z=n.z*u+o.z*c+l.z*_+h.z*p,r}onBezierCurve(e,t,s,r){let i=1-s,n=this._points,o=n[e],l=n[e+1],h=n[e+2];if(4==t){let t=n[e+3];a.add(o.scale(i*i*i,Io),h.scale(3*i*i*s,Po),Po),a.add(t.scale(3*i*s*s,Io),l.scale(s*s*s,Bo),Bo),a.add(Po,Bo,r)}else a.add(o.scale(i*i,Io),h.scale(2*i*s,Po),Io),a.add(Io,l.scale(s*s,Po),r);return r}}const Io=new a,Po=new a,Bo=new a,Lo=h.createPool(a,null,e=>e.set(0,0,0));class No{static READ_DATA(){this._DATA.offset=this._reader.readUint32(),this._DATA.size=this._reader.readUint32()}static READ_BLOCK(){for(var e=this._BLOCK.count=this._reader.readUint16(),t=this._BLOCK.blockStarts=[],s=this._BLOCK.blockLengths=[],r=0;r<e;r++)t.push(this._reader.readUint32()),s.push(this._reader.readUint32())}static READ_STRINGS(){var e=this._reader.readUint32(),t=this._reader.readUint16(),s=this._reader.pos;this._reader.pos=e+this._DATA.offset;for(var r=0;r<t;r++)this._strings[r]=this._reader.readUTFString();this._reader.pos=s}static parse(e,t,s){this._clip=e,this._reader=t,this._version=s,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var r=0,i=this._BLOCK.count;r<i;r++){var a=t.readUint16(),n=this._strings[a],o=this["READ_"+n];if(!o)throw new Error("model file err,no this function:"+a+" "+n);o.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(e,t){return Math.round(e*t)}static createPathPoints(e){const t=[];for(var s=0,r=e.length;s<r;s++){const r=e[s],i=new Ro;i.pos.x=r.pos.x,i.pos.y=r.pos.y,i.pos.z=r.pos.z,i.c1.x=r.c1.x,i.c1.y=r.c1.y,i.c1.z=r.c1.z,i.c2.x=r.c2.x,i.c2.y=r.c2.y,i.c2.z=r.c2.z,i.curve=r.curve,t.push(i)}return t}static READ_ANIMATIONS2D(){var e,t,s,r=this._reader,i=this._clip,a=[],n=r.readUint16();for(a.length=n,e=0;e<n;e++)a[e]=r.readFloat32();i._duration=a[r.readInt16()],i.islooping=!!r.readByte(),i._frameRate=r.readInt16();var o=r.readInt16(),l=i._nodes;l.count=o;var h=i._nodesMap={},d=i._nodesDic={};for(e=0;e<o;e++){s=new wo,l.setNodeByIndex(e,s),s._indexInList=e;var u=r.readUint16();for(s._setOwnerPathCount(u),t=0;t<u;t++)s._setOwnerPathByIndex(t,this._strings[r.readUint16()]);var c=s._joinOwnerPath("/"),_=h[c];_||(h[c]=_=[]),_.push(s);var p=r.readUint16();for(s._setPropertyCount(p),t=0;t<p;t++)s._setPropertyByIndex(t,this._strings[r.readUint16()]);var g=c+"."+s._joinProperty(".");d[g]=s,s.fullPath=g,s.nodePath=c;var m=r.readUint16();for(t=0;t<m;t++){var f=new bo;f.time=a[r.readUint16()],f.data={f:this.timeToFrame(f.time,i._frameRate),val:0},1==r.readByte()&&(f.data.tweenType=this._strings[r.readUint16()]),1==r.readByte()&&(f.data.tweenInfo={},f.data.tweenInfo.inTangent=a[r.readUint16()],f.data.tweenInfo.outTangent=a[r.readUint16()],1==r.readByte()&&(f.data.tweenInfo.inWeight=a[r.readUint16()]),1==r.readByte()&&(f.data.tweenInfo.outWeight=a[r.readUint16()]));var T=r.readByte();if(0==T)f.data.val=a[r.readUint16()];else if(1==T)f.data.val=this._strings[r.readUint16()];else if(2==T)f.data.val=!!r.readByte();else if(3==T){const e=JSON.parse(r.readUTFString());if(Array.isArray(e)){const t=new Ao;f.data.val=t,t._$data=e,t.create(...this.createPathPoints(e))}else f.data.val=e}if(1==r.readByte())try{f.data.extend=JSON.parse(this._strings[r.readUint16()])}catch(e){}s._keyFrames.push(f)}}var y=r.readUint16();for(e=0;e<y;e++){var x=new Co;x.time=a[r.readUint16()],x.eventName=this._strings[r.readUint16()];var S=[],E=r.readUint16();for(E>0&&(x.params=S=[]),t=0;t<E;t++){switch(r.readByte()){case 0:S.push(!!r.readByte());break;case 1:S.push(r.readInt32());break;case 2:S.push(a[r.readUint16()]);break;case 3:S.push(this._strings[r.readUint16()]);break;default:throw new Error("unknown type.")}}i.addEvent(x)}}}No._strings=[],No._DATA={offset:0,size:0},No._BLOCK={count:0};class Fo{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class Oo extends V{static _parse(e){var t=new Oo,s=new $t(e),r=s.readUTFString();if("LAYAANIMATION2D:01"!==r)throw"unknown animationClip version.";return No.parse(t,s,r),t}constructor(){super(),this._nodes=new Fo,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(e,t,s,r,i){for(var a=this._nodes,n=0,o=a.count;n<o;n++){var l,h=a.getNodeByIndex(n)._keyFrames,d=h.length;if(0!=d){var u=t[n];if(r)for(-1!=u&&e<h[u].time&&(u=-1,t[n]=u),l=u+1;l<d&&!(h[l].time>e);)u++,l++,t[n]=u;else for((l=u+1)!=d&&e>h[l].time&&(u=d-1,t[n]=u),l=u+1;u>-1&&!(h[u].time<e);)u--,l--,t[n]=u;var c=l==d;if(-1!=u){var _=h[u];if(c)_.data.val instanceof Ao?i[n]=_.data.val.getPointAt(0):i[n]=_.data.val;else{var p,g=h[l],m=g.time-_.time;p=0!==m?(e-_.time)/m:0,i[n]=this._getTweenVal(_,g,p,m)}}else h[0].data.val instanceof Ao?i[n]=h[0].data.val.getPointAt(0):i[n]=h[0].data.val;s&&"number"==typeof h[0].data.val&&(i[n]=i[n]-h[0].data.val)}}}_getTweenVal(e,t,s,r){var i=e.data,a=t.data;if(i.val instanceof Ao)return i.val.getPointAt(s);if("number"!=typeof i.val||"number"!=typeof a.val)return i.val;var n=function(e){if(!e)return null;let t=Uo[e];t||(e=(e=e.replace("_Ease","")).charAt(0).toLowerCase()+e.substring(1),t=Hi[e],null!=t&&(Uo[e]=t));return t}(i.tweenType),o=i.val,l=a.val;if(null!=n)return n(s,o,l-o,1);var h,d=0,u=0,c=NaN,_=NaN;return null!=i.tweenInfo&&(d=i.tweenInfo.outTangent,c=i.tweenInfo.outWeight),null!=a.tweenInfo&&(u=a.tweenInfo.inTangent,_=a.tweenInfo.inWeight),(isNaN(c)||0>=c)&&(c=bo.defaultWeight),(isNaN(_)||0>=_)&&(_=bo.defaultWeight),isNaN(d)&&(d=0),isNaN(u)&&(u=0),Math.abs(d)==Number.MAX_VALUE&&(d=0>d?-1/0:1/0),Math.abs(u)==Number.MAX_VALUE&&(u=0>u?-1/0:1/0),h=!i.tweenInfo&&!a.tweenInfo||bo.defaultWeight==_&&bo.defaultWeight==c?function(e,t,s,r,i,a){if(Math.abs(e)==1/0||Math.abs(t)==1/0)return s;var n=i*i,o=n*i,l=o-2*n+i,h=o-n;return(2*o-3*n+1)*s+l*e*a+h*t*a+(-2*o+3*n)*r}(d,u,o,l,s,r):this.hermiteCurveSplineWeight(o,e.time,c,d,l,t.time,_,u,s),h}_binarySearchEventIndex(e){for(var t,s=0,r=this._animationEvents.length-1;s<=r;){t=s+r>>1;var i=this._animationEvents[t].time;if(i==e)return t;i>e?r=t-1:s=t+1}return s}hermiteCurveSplineWeight(e,t,s,r,i,a,n,o,l){let h=222e-18,d=l,u=e,c=s,_=n,p=a-t,g=i-u;g=Math.max(Math.abs(g),h)*(g<0?-1:1);let m=r,f=o;if(!Number.isFinite(m)||!Number.isFinite(f))return e;m=m*p/g,f=f*p/g;let T=1-_,y=.5,x=0;if(Math.abs(c-.33333334)<1e-4&&Math.abs(_-.33333334)<1e-4)y=d,x=1-y;else for(;;){x=1-y;let e=3*x*x*y*c+3*x*y*y*T+y*y*y-d;if(Math.abs(e)<=2.5*h)break;let t=3*x*x*c+6*x*y*(T-c)+3*y*y*(1-T),s=6*x*(T-2*c)+6*y*(1-2*T+c);y-=(6*e*t*t-3*e*e*s)/(6*t*t*t-6*e*t*s+e*e*(18*c-18*T+6))}return(3*x*x*y*c*m+3*x*y*y*(1-_*f)+y*y*y)*g+u}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}}const Uo={};class ko{}var Vo;e.AniConditionType=void 0,(Vo=e.AniConditionType||(e.AniConditionType={}))[Vo.Greater=0]="Greater",Vo[Vo.Less=1]="Less",Vo[Vo.Equals=2]="Equals",Vo[Vo.NotEqual=3]="NotEqual";class Go{}class zo extends V{constructor(){super(!1),this.fromDCC=!1,this._traceDeps=!0}onLoad(){return V._idResourcesMap[this._id]=this,this}create(e,t){return null}static instantiate(e,t){return l.loader.load(e,Te.HIERARCHY).then(e=>e.create())}}var Ho,Wo=zo;class Xo{static conditionNameToID(e){if(null!=Xo._conditionNameMap[e])return Xo._conditionNameMap[e];var t=this._propertyNameCounter++;return this._conditionNameMap[e]=t,this._conditionNameMap[t]=e,t}static conditionIDToName(e){return this._conditionNameMap[e]}constructor(e=null){e&&(this._id=Xo.conditionNameToID(e),this._name=e)}get id(){return this._id}get name(){return this._name}set name(e){this._id=Xo.conditionNameToID(e),this._name=e}get type(){return this._type}checkState(e){return!1}}Xo._conditionNameMap={},Xo._propertyNameCounter=0;class Yo extends Xo{constructor(t){super(t),this._numberValue=0,this._numberCompareFlag=e.AniStateConditionNumberCompressType.Greater,this._type=e.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(e){this._numberValue=e}get compareFlag(){return this._numberCompareFlag}set compareFlag(e){this._numberCompareFlag=e}checkState(t){return e.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?t>this._numberValue:t<this._numberValue}}class qo extends Xo{constructor(t){super(t),this._compareFlag=!0,this._type=e.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(e){this._compareFlag=e}checkState(e){return this._compareFlag==e}}class jo extends Xo{constructor(t){super(t),this._type=e.AniStateConditionType.Trigger}checkState(e){return e}}class Ko{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(e){-1==this.conditions.indexOf(e)&&this.conditions.push(e)}removeCondition(e){let t=this.conditions.indexOf(e);-1!=t&&this.conditions.splice(t,0)}check(t,s,r){if(this.mute)return!1;if(this.exitByTime&&t<this.exitTime&&!r)return!1;if(!this.conditions||0===this.conditions.length)return!0;if(this.isAndOperEnabled){for(let t=0;t<this.conditions.length;t++){const r=this.conditions[t];if(!r.checkState(s[r.name].value))return!1;r.type===e.AniStateConditionType.Trigger&&(s[r.name].value=!1)}return!0}for(let t=0;t<this.conditions.length;t++){const r=this.conditions[t];if(r.checkState(s[r.name].value))return r.type===e.AniStateConditionType.Trigger&&(s[r.name].value=!1),!0}return!1}}class $o extends V{constructor(e){super();let t=Eo.parse(e);this.data=t.ret,this.clipsID=t.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let s=e.length-1;s>=0;s--){let r=e[s],i=new mo(r.name);t.unshift(i);for(let e in r)if("name"!=e&&"states"!=e&&null!=r[e])try{i[e]=r[e]}catch(e){console.error(e)}this.getState(r.states,i,this.data)}return t}createState(e,t,s){if(!e)return null;let r={},i=null;for(let a=e.length-1;a>=0;a--){let n=e[a],o=n.states;if(o){let e=this.createState(o,t,s);e&&(t[n.id]=e.states[e.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let e=n.soloTransitions;e&&0<e.length&&(i=e[0].id)}continue}let l=new Do;t[n.id]=l,r[n.id]=l;for(let e in n)try{if("scripts"==e){let t=n[e];if(t&&Array.isArray(t))for(let e=t.length-1;e>=0;e--){let s=t[e];s&&0==s.indexOf("res://")&&(s=s.substring(6));let r=Ee.getClass(s);r&&l.addScript(r)}continue}if("soloTransitions"==e)continue;null!=n[e]&&(l[e]=n[e])}catch(e){}s.addState(l)}return{id:i,states:r}}getState(e,t,s){if(e){let r={};this.createState(e,r,t),this.setTransitions(e,r,t,s)}}setExitTransition(e,t,s,r,i){for(let a in e){let n=s[a];if(n){let o=n.transitions,l=n.soloTransitions,h=e[a];for(let e=t.length-1;e>=0;e--){let n=t[e];if("-3"!=n.id)for(let e=h.length-1;e>=0;e--){let t=h[e],i=new Ko;i.destState=s[n.id],n.conditions&&this.addConditions(n.conditions,i,r),t.conditions&&this.addConditions(t.conditions,i,r);for(let e in n)"solo"!=e&&"id"!=e&&"conditions"!=e&&(i[e]=n[e]);n.solo?l.unshift(i):o.unshift(i)}else null==i[a]&&(i[a]=[]),i[a].push(n)}}}}_getAnimatorTransition2D(e,t,s){let r=new Ko;t[e.id]&&(r.destState=t[e.id]),e.conditions&&this.addConditions(e.conditions,r,s);for(let t in e)"solo"!=t&&"id"!=t&&"conditions"!=t&&(r[t]=e[t]);return r}setTransitions(e,t,s,r,i){if(!e)return null;let a={};for(let i=e.length-1;i>=0;i--){let n=e[i];if(n.states){let e=this.setTransitions(n.states,t,s,r,n);if(e){let s=n.soloTransitions;s&&this.setExitTransition(e,s,t,r,a)}}}for(let n=e.length-1;n>=0;n--){let o=e[n];if(o.states)continue;if("-1"==o.id){if(o.soloTransitions&&0<o.soloTransitions.length){null==i?(s.defaultState=t[o.soloTransitions[0].id],s._enterTransition=this._getAnimatorTransition2D(o.soloTransitions[0],t,r)):t[i.id]=t[o.soloTransitions[0].id];continue}}else{if("-2"==o.id){let e=o.soloTransitions;if(e)for(let s=e.length-1;s>=0;s--){let i=e[s];if(t[i.id])for(let e in t){let s=t[e],a=this._getAnimatorTransition2D(i,t,r);i.solo?s.soloTransitions.unshift(a):s.transitions.unshift(a)}}continue}if("-3"==o.id)continue}let l=o.soloTransitions;if(l&&t[o.id]){let e=t[o.id].transitions,s=t[o.id].soloTransitions;for(let i=l.length-1;i>=0;i--){let n=l[i];if("-3"==n.id){null==a[o.id]&&(a[o.id]=[]),a[o.id].push(n);continue}let h=this._getAnimatorTransition2D(n,t,r);n.solo?s.unshift(h):e.unshift(h)}}}return a}addConditions(t,s,r){let i=r.animatorParams;if(null!=i&&0!=i.length)for(let r=0,a=t.length;r<a;r++){let a,n=t[r],o=null;for(let e=i.length-1;e>=0;e--)if(i[e].id==n.id){o=i[e];break}if(null==o)return;if(o.type==e.AniParmType.Bool){let e=new qo(o.name);e.compareFlag=Boolean(n.checkValue),a=e}else if(o.type==e.AniParmType.Float){let e=new Yo(o.name);e.numberValue=Number(n.checkValue),e.compareFlag=n.type,a=e}else if(o.type==e.AniParmType.Trigger){a=new jo(o.name)}s.addCondition(a)}}updateTo(e){let t=e._controllerLayers;for(let e=0,s=t.length;e<s;e++)t[e].destroy();t.length=0;let s=this.getLayers();for(let t=0,r=s.length;t<r;t++)e.addControllerLayer(s[t]);let r=this.data.animatorParams;if(r){let t={};for(let e=r.length-1;e>=0;e--){let s=r[e],i=new ko;i.name=s.name,i.type=s.type,i.value=s.val,t[s.name]=i}e.parameters=t}}}class Qo extends fa{_isScript(){return!0}setupScript(){let e,t=this.owner;(e=this.onTriggerEnter)&&t.on(c.TRIGGER_ENTER,this,e),(e=this.onTriggerStay)&&t.on(c.TRIGGER_STAY,this,e),(e=this.onTriggerExit)&&t.on(c.TRIGGER_EXIT,this,e),(e=this.onCollisionEnter)&&t.on(c.COLLISION_ENTER,this,e),(e=this.onCollisionStay)&&t.on(c.COLLISION_STAY,this,e),(e=this.onCollisionExit)&&t.on(c.COLLISION_EXIT,this,e),(e=this.onJointBreak)&&t.on(c.JOINT_BREAK,this,e),(e=this.onMouseDown)&&t.on(c.MOUSE_DOWN,this,e),(e=this.onMouseUp)&&t.on(c.MOUSE_UP,this,e),(e=this.onRightMouseDown)&&t.on(c.RIGHT_MOUSE_DOWN,this,e),(e=this.onRightMouseUp)&&t.on(c.RIGHT_MOUSE_UP,this,e),(e=this.onMouseMove)&&t.on(c.MOUSE_MOVE,this,e),(e=this.onMouseDrag)&&t.on(c.MOUSE_DRAG,this,e),(e=this.onMouseDragEnd)&&t.on(c.MOUSE_DRAG_END,this,e),(e=this.onMouseOver)&&t.on(c.MOUSE_OVER,this,e),(e=this.onMouseOut)&&t.on(c.MOUSE_OUT,this,e),(e=this.onMouseClick)&&t.on(c.CLICK,this,e),(e=this.onMouseDoubleClick)&&t.on(c.DOUBLE_CLICK,this,e),(e=this.onMouseRightClick)&&t.on(c.RIGHT_CLICK,this,e),(e=this.onKeyDown)&&l.stage.on(c.KEY_DOWN,this,e),(e=this.onKeyPress)&&l.stage.on(c.KEY_PRESS,this,e),(e=this.onKeyUp)&&l.stage.on(c.KEY_UP,this,e)}}class Zo{static parse(e,t,s,r){Zo._mesh=s,Zo._subMeshes=r,Zo._version=t,Zo._readData=e,Zo.READ_DATA(),Zo.READ_BLOCK(),Zo.READ_STRINGS();for(var i=0,a=Zo._BLOCK.count;i<a;i++){Zo._readData.pos=Zo._BLOCK.blockStarts[i];var n=Zo._readData.readUint16(),o=Zo._strings[n],l=Zo["READ_"+o];null==l?console.warn("model file err,no this function:"+n+" "+o):l.call(null)}Zo._strings.length=0,Zo._readData=null,Zo._version=null,Zo._mesh=null,Zo._subMeshes=null}static _readString(){return Zo._strings[Zo._readData.readUint16()]}static READ_DATA(){Zo._DATA.offset=Zo._readData.readUint32(),Zo._DATA.size=Zo._readData.readUint32()}static READ_BLOCK(){for(var e=Zo._BLOCK.count=Zo._readData.readUint16(),t=Zo._BLOCK.blockStarts=[],s=Zo._BLOCK.blockLengths=[],r=0;r<e;r++)t.push(Zo._readData.readUint32()),s.push(Zo._readData.readUint32())}static READ_STRINGS(){var e=Zo._readData.readUint32(),t=Zo._readData.readUint16(),s=Zo._readData.pos;Zo._readData.pos=e+Zo._DATA.offset;for(var r=0;r<t;r++)Zo._strings[r]=Zo._readData.readUTFString();Zo._readData.pos=s}static READ_MESH(){var t,s=0,r=Zo._readString(),i=Zo._readData,a=i.rawBuffer,n=i.readInt16(),o=Zo._DATA.offset,l=Zo._mesh;let h=[];var d=0;let u=[];for(t=0;t<n;t++){var c=o+i.readUint32(),_=i.readUint32(),p=Zo._readString(),g=_r.getVertexDeclaration(p,!1),m=a.slice(c,c+_);u[t]=m;var T=f.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Static);T.vertexDeclaration=g,T.setDataLength(_),T.setData(m,0,0,_),d=_/g.vertexStride,s+=_,h[t]=T}l._indexFormat=d>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16;var y,x,S=o+i.readUint32(),E=i.readUint32();l.indexFormat==e.IndexFormat.UInt32?(y=new Uint32Array(a.slice(S,S+E)),x=4):(y=new Uint16Array(a.slice(S,S+E)),x=2);var v=f.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Static);return v.indexType=l.indexFormat,v.indexCount=E/x,v._setIndexDataLength(E),v._setIndexData(y,0),l._setBuffers(h,v),l.canRead=!0,l._vertices=u,l._indices=y,s+=y.byteLength,l._setCPUMemory(s),l._setGPUMemory(s),l.name=r,!0}static READ_SUBMESH(){var t=Zo._readData,s=f.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement);t.readInt16();let r=Zo._mesh;s.bufferState=r._bufferState,s.indexFormat=r.indexFormat;for(var i=t.readUint16(),a=0;a<i;a++){let e=t.readUint32(),r=t.readUint32();s.setDrawElemenParams(r,e)}return Zo._subMeshes.push(s),!0}}Zo._BLOCK={count:0},Zo._DATA={offset:0,size:0},Zo._strings=[];class Jo{load(e){let t=J.inst.getSubAssetURL(e.url,e.uuid,null,"lm");return e.loader.fetch(t,"arraybuffer",e.progress.createCallback(),e.options).then(t=>t?this._parse(e,t):null)}_parse(e,t){var s=new $t(t);s.pos=0;var r=s.readUTFString();if(!r||!r.startsWith("LAYAMODEL"))return console.warn(`Unknow version:${r} ! Model : ${e.url}`),null;return r.startsWith("LAYAMODEL2D")?Jo.v2d.parse(s,r):Jo.v3d?Jo.v3d.parse(s,r):(console.warn(`Loading ${e.url} , you need load the laya.d3 lib!`),null)}}class el{static parse(e,t){var s=new Na;let r=s._subMeshes;if("LAYAMODEL2D:01"!==t)throw new Error("unknown mesh version: "+t);return Zo.parse(e,t,s,r),s._setSubMeshes(r),s}}Jo.v2d=el,Te.registerLoader(["lm"],Jo,Te.MESH),e.TextResourceFormat=void 0,(Ho=e.TextResourceFormat||(e.TextResourceFormat={}))[Ho.Buffer=0]="Buffer",Ho[Ho.Plain=1]="Plain",Ho[Ho.JSON=2]="JSON",Ho[Ho.XML=3]="XML";class tl extends V{constructor(e,t){super(),this.data=e,this.format=t}}Te.registerLoader(["txt","csv"],class{load(t){return t.loader.fetch(t.url,"text",t.progress.createCallback(),t.options).then(t=>t?new tl(t,e.TextResourceFormat.Plain):null)}},Te.TEXT),Te.registerLoader(["bin","bytes","fui"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then(t=>t?new tl(t,e.TextResourceFormat.Buffer):null)}},Te.BUFFER),Te.registerLoader(["json"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then(t=>t?new tl(t,e.TextResourceFormat.JSON):null)}},Te.JSON),Te.registerLoader(["xml"],class{load(t){return t.loader.fetch(t.url,"xml",t.progress.createCallback(),t.options).then(t=>t?new tl(t,e.TextResourceFormat.XML):null)}},Te.XML);Te.registerLoader(["atlas"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then(t=>{if(!t)return null;let s=[];if(t.meta&&t.meta.image){let r="",i=e.url.lastIndexOf("/");-1!=i&&(r=e.url.substring(0,i+1));let a="";i=e.url.lastIndexOf("?"),-1!=i&&(a=e.url.substring(i));let n=t.meta.image.split(",");for(let t of n)t.startsWith("res://")||(t=r+t+a),s.push(e.loader.load(t,null,e.progress.createCallback()))}else s.push(e.loader.load(Q.replaceFileExtension(e.url,"png"),null,e.progress.createCallback()));return Promise.all(s).then(s=>{s=s.filter(e=>null!=e);let r=e.options.baseUrl||"",i=t.frames,a=t.meta&&null!=t.meta.prefix?t.meta.prefix:e.url.substring(0,e.url.lastIndexOf("."))+"/",n=[],o=1;t.meta&&t.meta.scale&&1!=t.meta.scale&&(o=parseFloat(t.meta.scale));for(let e of s)e.scaleRate=o;for(let t in i){let o=i[t],l=s[o.frame.idx?o.frame.idx:0];if(!l)continue;let h=r+a+(o.filename||t),d=ie.create(l,o.frame.x,o.frame.y,o.frame.w,o.frame.h,o.spriteSourceSize.x,o.spriteSourceSize.y,o.sourceSize.w,o.sourceSize.h);d._sizeGrid=o.sizeGrid,d._stateNum=o.stateNum,e.loader.cacheRes(h,d),d.url=h,n.push(d)}let l=e.obsoluteInst;return l?(l.update(s,n),l.dir=a,l.animation=t.animation,l.event("reload"),l):(l=new oe(a,s,n),l.animation=t.animation,l)})})}},Te.ATLAS,!0);const sl={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};class rl{static hasProp(...e){for(let t of e)if(void 0!==rl._data[t])return!0;return!1}static decodeObj(e,t){return nl.decodeObj(e,t)}static getLoadTypeByEngineType(e){return Te.assetTypeToLoadType[e]}static bakeOverrideData(e){let t=null;for(let s=e.length,r=s-1;r>=0;r--){let i=e[r];if(i&&i.length>0)for(let e of i){let i,a=e._$override||e._$parent;if(Array.isArray(a)?i=a[s-r-1]:r===s-1&&(i=a),null!=i){t||(t={});let a=t[i];a||(t[i]=a=[]),a.push(s-r,e)}}}return t}static applyOverrideData(e,t){return function e(s){if(t[s._$id])return!0;let r=s._$child;return!(!r||!r.find(t=>e(t)))}(e)&&(e=function e(t){let s=Object.assign({},t),r=s._$child;r&&(s._$child=r.map(t=>e(t)));let i=s._$comp;return i&&(s._$comp=i.map(e=>Object.assign({},e))),s}(e),function e(s){let r=s._$child;if(r)for(let t of r)t._$id&&e(t);let i=t[s._$id];if(i)for(let e=0;e<i.length;e+=2){let t,a=i[e],n=i[e+1];if(t=n._$override){let e;if(Array.isArray(t))if(a===t.length-1){let i=t[a];r?e=r.find(e=>e._$override==i):s._$child=r=[],e||(e={_$override:i},r.push(e))}else if(a<t.length-1){let i=t.slice(a);r?e=r.find(e=>{let t=e._$override;return Array.isArray(t)&&al(t,i)}):s._$child=r=[],e||(e={_$override:i},r.push(e))}else e=s;else e=s;if(il(e,n),n._$comp){let t=e._$comp;t||(e._$comp=t=[]);for(let e of n._$comp){let s=e._$type||e._$override,r=t.find(e=>e._$override==s||e._$type==s||e._$id==s);r||(r={},e._$type?r._$type=s:r._$override=s,t.push(r)),il(r,e)}}}else if(t=n._$parent){let e;if(r||(s._$child=r=[]),a<t.length){e=a===t.length-1?t[a]:t.slice(a);let s=Object.assign({},n);s._$parent=e,r.push(s)}else{let e=Object.assign({},n);delete e._$parent,s._$prefab?r.push(e):(delete e._$index,n._$index<r.length?r.splice(n._$index,0,e):r.push(e))}}}}(e)),e}}function il(e,t){for(let s in t){if(s.startsWith("_$"))continue;let r=t[s];if(null==r||"object"!=typeof r||Array.isArray(r)||(r._$type||r._$uuid||r._$ref))e[s]=r;else{let t=e[s];null!=t&&"object"==typeof t?(e[s]=t=Object.assign({},t),il(t,r)):e[s]=r}}}function al(e,t){if(e.length===t.length){for(var s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}return!1}rl.isDeserializing=!1;class nl{constructor(){this.getNodeByRef=ol,this.getNodeData=ol}static decodeObj(e,t){return hl.errors=null,hl.getNodeByRef=ol,hl.getNodeData=ol,hl.decodeObj(e,t)}decodeObj(e,t,s){rl.isDeserializing=!0;try{return this._decode(e,t,s)}finally{rl.isDeserializing=!1}}decodeObjBounds(e,t){rl.isDeserializing=!0;try{let s=e.x,r=e.y;void 0!==s&&void 0!==r?t.pos(s,r):void 0!==s?t.x=s:void 0!==r&&(t.y=r),s=e.width,r=e.height,void 0!==s&&void 0!==r?t.size(s,r):void 0!==s?t.width=s:void 0!==r&&(t.height=r),s=e.controllers,void 0!==s&&(t.controllers=this._decode(s))}finally{rl.isDeserializing=!1}}_decode(e,t,s){if(null==e)return null;if(Array.isArray(e)){let t=[];for(let s=0;s<e.length;s++){let r=e[s];if(null!=r)try{t[s]=this._decode(r)}catch(e){this.errors?this.errors.push(e):console.error(e),t[s]=null}else t[s]=null}return t}if("object"==typeof e){if(null!=e._$uuid){let t=ee.getResURLByUUID(e._$uuid);return l.loader.getRes(t,Te.assetTypeToLoadType[e._$type])}if(null!=e._$ref){let t=this.getNodeByRef(e._$ref);if(!t)return null;if(e._$type){let s=Ee.getClass(e._$type);return s?t.getComponent(s):null}if(void 0!==e._$ctrl){let s=ll||(ll=Ee.getClass("ControllerRef"));return s?new s(t,e._$ctrl):null}return t}let r=e._$type;if("any"===r)return e._$type?e.value:e;let i=sl[r];if(null!=i)return e._$type?new i(e.value):new i(e);if(!t){let e=Ee.getClass(r);if(!e)return null;t=new e}for(let r in e){if(r.startsWith("_$")||s&&s.has(r))continue;let i=e[r];if(null==i||"object"!=typeof i||Array.isArray(i)||i._$type||i._$uuid||i._$ref)try{let e=this._decode(i);t[r]=e,null!=e&&null!=i&&i._$tmpl&&(t[i._$tmpl]=new cl(null,this.getNodeData(e)))}catch(e){this.errors?this.errors.push(e):console.error(e)}else{let e=t[r];if(e)try{this._decode(i,e)}catch(e){this.errors?this.errors.push(e):console.error(e)}}}if(t.onAfterDeserialize)try{rl._data=e,t.onAfterDeserialize()}catch(e){this.errors?this.errors.push(e):console.error(e)}return t}return e}}function ol(...e){return null}var ll;const hl=new nl,dl=new Set(["x","y","width","height","controllers","relations","gears"]);class ul{static parse(e,t,s){let r=null==s;s=s||[];let i,a,n,o,l,h,d,u,c={},_=[],p=[],g=[],m=[];function f(e,t){for(let s of e._$child)if(s._$child){let e=T(s,t);f(s,s._$prefab?e:t),_.push(s),p.push(e)}else{let e=T(s,t);_.push(s),p.push(e)}}function T(e,t){let r,i;if(i=e._$override){if(t&&n)if(Array.isArray(i)){r=t;for(let e=0,s=i.length;e<s;e++){let s=n.get(r);if(r=null==s?void 0:s[i[e]],!r)break;if(r==t){r=null;break}}}else{let s=n.get(t);s&&(r=s[e._$override],r==t&&(r=null))}}else{if(i=e._$prefab){let t=Te.getRes(ee.getResURLByUUID(i),Te.HIERARCHY);if(t){n||(n=new Map);let i=[],a=e._$id;if(l)for(let e=0,t=l.length;e<t;e++){let s=l[e];s&&s.length>0?i[e]=s.filter(s=>{let r=s._$override||s._$parent;return Array.isArray(r)&&r.length>t-e&&r[t-e-1]==a}):i[e]=s}i.push(e._$child),r=t.create({inPrefab:!0,prefabNodeDict:n,overrideData:i},s)}}else if(i=e._$type){let t=Ee.getClass(i);if(t)try{r=new t}catch(e){s.push(e)}else s.push(new Error(`missing node type '${i}' (in ${e.name||"noname"})`))}r&&(c[e._$id]=r,2===r._nodeType&&(d=!0))}return r}function y(e,t,s=0){if(!t)return e;let r=null==n?void 0:n.get(e);if(!r)return null;if(Array.isArray(t)){let e;for(let i=s,a=t.length;i<a;i++){if(!r)return null;if(e=r[t[i]],!e)break;r=n.get(e)}return e}return r[t]}if(t&&(a=t.inPrefab,a&&(n=t.prefabNodeDict),o=t.skinBaseUrl,l=t.overrideData),e._$type||e._$prefab){let r,a=e._$runtime;a&&(h=!0,a.startsWith("res://")&&(a=a.substring(6)),a=Ee.getClass(a),a||s.push(new Error(`missing runtime class '${e._$runtime}'`))),t&&t.runtime&&(a=t.runtime),a?(r=new a,r instanceof ki||(s.push(new Error(`runtime class invalid - '${a}', must derive from Node`)),r=null),c[e._$id]=r):r=T(e,null),r&&(e._$child&&f(e,e._$prefab?r:null),_.push(e),p.push(r),r instanceof wn&&(i=r))}else e._$child&&f(e,null);let x=_.length,S=0,E=[];for(let e=0;e<x;e++){let t=_[e],s=p[e],r=t._$child;if(r){let e=r.length;if(s)if(t._$prefab)for(let t=0;t<e;t++){let r=S-e+t,i=g[r];if(i&&!i.parent){let e=E[r],t=y(s,e._$parent);if(t){let s=e._$index;null!=s&&s<t.numChildren?t.addChildAt(i,s):t.addChild(i)}else s.addChildAt(i,0)}}else for(let t=0;t<e;t++){let r=g[S-e+t];r&&(s===i&&r.is3D?i._scene3D=r:s.addChild(r))}S-=e}g[S]=s,E[S]=t,S++}g.length=S,g=g.filter(e=>null!=e);let v=g[0],D=[];for(let e=0;e<x;e++){let t=_[e]._$comp;if(!t)continue;let r=p[e];if(r)for(let i of t){let t,a=i._$override;if(i._$override){let e=Ee.getClass(a);t=e?r.getComponent(e):r.components.find(e=>e._extra.storeId==a)}else{let a=Ee.getClass(i._$type);if(a){if(i._$id||(t=r.getComponent(a)),!t)try{t=r.addComponent(a),t._extra.storeId=i._$id}catch(e){s.push(e)}}else s.push(new Error(`missing component type '${i._$type}' (in ${_[e].name||"noname"})`))}t&&D.push(i,t)}}const w=new nl;w.errors=s,w.getNodeByRef=function(e){if(Array.isArray(e)){let t=c[e[0]];return t&&e.length>1?y(t,e,1):t}return c[e]},w.getNodeData=function(e){let t=p.indexOf(e),s=_[t];return e.removeSelf(),m.push(s._$id),p[t]=null,l?(void 0===u&&(u=rl.bakeOverrideData(l)),u?rl.applyOverrideData(s,u):s):s};for(let e=0;e<x;e++){let t=_[e],s=p[e];!s||2!==s._nodeType&&s!==i||w.decodeObjBounds(t,s)}if(d){2===v._nodeType&&(v.sourceWidth=v.width,v.sourceHeight=v.height);for(let e=0;e<x;e++){let t=_[e],s=p[e];if(s&&2===s._nodeType){let e=t.relations;null!=e&&(null!=t._$prefab?s._addRelations(w.decodeObj(e)):s.relations=w.decodeObj(e))}}}for(let e=0;e<x;e++){let t=_[e],r=p[e];if(r&&(null!=o&&0===r._nodeType&&(r._skinBaseUrl=o),w.decodeObj(t,r,2===r._nodeType||r===i?dl:null),h&&t._$var&&r.name))try{v[r.name]=r}catch(e){s.push(e)}}let b=D.length;for(let e=0;e<b;e+=2){let t=D[e],s=D[e+1];w.decodeObj(t,s)}if(d){for(let e=0;e<x;e++){let t=_[e],s=p[e];if(s&&2===s._nodeType){let e=t.gears;null!=e&&(null!=t._$prefab?s._addGears(w.decodeObj(e)):s.gears=w.decodeObj(e))}}if(!(2!==v._nodeType||n&&n.has(v)))try{v._onConstruct(a)}catch(e){s.push(e)}}for(let e of m){let t=c[e];t._destroyed||t.destroy(),delete c[e]}return a&&n&&v&&n.set(v,c),r&&s.length>0&&s.forEach(e=>console.error(e)),g}static collectResourceLinks(e,t){let s,r={},i=[];function a(e,s,a){if(!e)return"";let n=r[e];if(void 0===n){let o;o=Q.isUUID(e)?"res://"+e:a?e:ee.join(t,e),i.push({url:o,type:s}),r[e]=n=[o,s]}else-1==n.indexOf(s,1)&&(n.push(s),i.push({url:n[0],type:s}));return n[0]}function n(e){if(null==e._$uuid){if(null!=e._$prefab)e._$prefab=a(e._$prefab,Te.HIERARCHY);else if(null!=(s=e._$type))if(s.endsWith(".bp"))a(s,null,!0);else if(p.isPreview&&Q.isUUID(s)){let e=Ee.getClass(s);(null==e||e._$loadable)&&a("res://"+s,null)}o(e)}else e._$uuid=a(e._$uuid,Te.assetTypeToLoadType[e._$type])}function o(e){for(let t in e){let s=e[t];if(null!=s)if(Array.isArray(s)){for(let e of s)if(null!=e)if("object"==typeof e)n(e);else if("string"==typeof e&&e.startsWith("i18n:")){let t=e.indexOf(":",5);-1!=t&&a(J.inst.getI18nSettingsURL(e.substring(5,t)),null)}}else if("object"==typeof s)n(s);else if("string"==typeof s&&s.startsWith("i18n:")){let e=s.indexOf(":",5);-1!=e&&a(J.inst.getI18nSettingsURL(s.substring(5,e)),null)}}}if(o(e),e._$preloads){let t=e._$preloadTypes,s=0;for(let r of e._$preloads)t&&t[s]?a(r,Te.assetTypeToLoadType[t[s]]):i.push(r),s++}return i}}class cl extends zo{constructor(e,t){super(),this.api=e||cl.v3,this.data=t}create(e,t){let s=Ee.getRuntime(this.url);s&&(e?e.runtime||(e=Object.assign({runtime:s},e)):e={runtime:s});let r=this.api.parse(this.data,e,t);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}cl.v3=ul,cl.v2=null;class _l{load(e){let t=e.url,s="gltf"==e.ext||"fbx"==e.ext||"glb"==e.ext||"obj"==e.ext;return s&&(t=J.inst.getSubAssetURL(t,e.uuid,"0","lh")),e.loader.fetch(t,"json",e.progress.createCallback(.2),e.options).then(t=>t?null!=t._$ver?this._load(cl.v3,e,t,s):"ls"==e.ext||"lh"==e.ext?this._load(cl.v2,e,t,s):"scene"==e.ext||"prefab"==e.ext?this._load(cl.legacySceneOrPrefab,e,t,s):null:null)}_load(e,t,s,r){let i=ee.getPath(t.url),a=e.collectResourceLinks(s,i),n=Object.assign({},t.options);return n.initiator=t,delete n.cache,delete n.ignoreCache,t.loader.load(a,n,t.progress.createCallback()).then(t=>{let i=new cl(e,s);return i.fromDCC=r,i.onLoad(),i.addDeps(t),i})}}Te.registerLoader(["lh","ls","scene","prefab"],_l,Te.HIERARCHY);class pl{static _parseHDRTexture(e,t=null,s=null){let r=pl.getHDRInfo(e),i=new fs(r.width,r.height,r.format,!1,!1,!1);return i.setHDRData(r),t&&(null!=t.wrapModeU&&(i.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(i.wrapModeV=t.wrapModeV),null!=t.filterMode&&(i.filterMode=t.filterMode),null!=t.anisoLevel&&(i.anisoLevel=t.anisoLevel)),i}static getHDRInfo(t){let s=new Uint8Array(t),r=0;const i=()=>{let e=pl.getLineString(s,r);return r+=e.length+1,e};if("#?RADIANCE"!=i())throw"HDR image: identifier wrong.";let a=new Map,n="";do{if(n=i(),"#"!=n[0]){let e=n.split("=");a.set(e[0],e[1])}}while(""!=n);if("32-bit_rle_rgbe"!=a.get("FORMAT"))throw"HDR image: unsupported format.";let o=i().split(" "),l="-Y"==o[0],h="-X"==o[2],d=parseInt(o[1]),u=parseInt(o[3]);return new pl(t,r,h,l,u,d,e.TextureFormat.R32G32B32A32)}static getLineString(e,t){let s=e.length,r=t,i="",a="";for(;r<s&&"\n"!=a;)i=`${i}${a}`,a=String.fromCharCode(e[r]),r++;return i}constructor(e,t,s,r,i,a,n){this.source=e,this.byteOffset=t,this.decreaseX=s,this.decreaseY=r,this.width=i,this.height=a,this.format=n}get_32_bit_rle_rgbe(){let e=this.width,t=this.height;this.decreaseX,this.decreaseY;let s=new Uint8Array(this.source,this.byteOffset),r=0,i=new ArrayBuffer(4*e),a=new Uint8Array(i),n=new ArrayBuffer(e*t*4*3),o=new Float32Array(n);for(let i=t;i>0;i--){s[r++],s[r++];let n=s[r++]<<8|s[r++];if(n!=e)throw"HDR info: scanlineLength wrong.";let l=0;for(let e=0;e<4;e++){let t=(e+1)*n;for(;l<t;){let e=s[r++],i=s[r++];if(e>128){let s=e-128;if(s>t-l)throw"HDR info: ??";for(;s-- >0;)a[l++]=i}else{let n=e;if(0==n||n>t-l)throw"HDR info: ??";if(a[l++]=i,--n>0)for(let e=0;e<n;e++)a[l++]=s[r++]}}}for(let e=0;e<n;e++){let s=a[e],r=a[e+n],l=a[e+2*n],h=a[e+3*n],d=(t-i)*n*3+3*e;const u=(e,t)=>t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t);if(h>0){let e=u(1,h-136);o[d]=s*e,o[d+1]=r*e,o[d+2]=l*e}else o[d]=0,o[d+1]=0,o[d+2]=0}}return o}readScanLine(){let t=this.width,s=this.height,r=this.decreaseX,i=this.decreaseY,a=3;this.format==e.TextureFormat.R32G32B32A32&&(a=4);let n=new Float32Array(t*s*a),o=new Uint8Array(4*t),l=new Uint8Array(this.source,this.byteOffset),h=l.length,d=0;const u=()=>{if(d>=h)throw"HDR info: data wrong.";return l[d++]},c=()=>{throw"HDR info: data wrong."};for(let e=s-1;e>=0;e--){this.readcolors(o,u,c);for(let l=0;l<t;l++){let h=4*l,d=o[h],u=o[h+1],c=o[h+2],_=o[h+3],p=e,g=l;i&&(p=s-1-e),r&&(g=t-1-l);let m=p*t*a+g*a;if(0==_)n[m]=0,n[m+1]=0,n[m+2]=0,4==a&&(n[m+3]=1);else{let e=gl(1,_-136);n[m]=(d+.5)*e,n[m+1]=(u+.5)*e,n[m+2]=(c+.5)*e,4==a&&(n[m+3]=1)}}}return n}readcolors(e,t,s){const r=(t,s,r)=>{e[4*t+s]=r};let i=this.width,a=t(),n=t(),o=t(),l=t();if(i<8||i>32767)this.olddreadcolors(e,t,a,n,o,l);else if(2!=a||2!=n||128&o)this.olddreadcolors(e,t,a,n,o,l);else{(o<<8|l)!=i&&s();for(let e=0;e<4;e++)for(let a=0;a<i;){let n=t();if(n>128){n&=127;let o=t();for(a+n>i&&s();n--;)r(a++,e,o)}else for(a+n>i&&s();n--;){r(a++,e,t())}}}}olddreadcolors(e,t,s,r,i,a){let n=0,o=this.width;e[0]=s,e[1]=r,e[2]=i,e[3]=a;for(let s=1;s<o;s++){let r=t(),i=t(),a=t(),o=t(),l=4*s;if(e[l]=r,e[l+1]=i,e[l+2]=a,e[l+3]=o,1==r&&1==i&&1==a){let t=l-4;for(let s=o<<n;s>0;s--)e[l]=e[t],e[l+1]=e[t+1],e[l+2]=e[t+2],e[l+3]=e[t+3];n+=8}else n=0}}color_color(e,t){let s=0;0==t.w?e.x=e.y=e.z=0:(s=gl(1,t.w-136),e.x=t.x*s,e.y=t.y*s,e.z=t.z*s)}}function gl(e,t){return e*Math.pow(2,t)}pl.HDRTEXTURE="HDRTEXTURE";class ml extends G{static createInstance(){return W.media.createVideoTexture()}constructor(){super(1,1,e.RenderTargetFormat.R8G8B8),this.allowBackground=!1,this._playing=!1,this._loaded=!1,this._frameRender=!0,this._interval=0,this._lastTimer=0,this._frameRate=0,this._useMediaFrameRate=!0,this._loop=!1,this._autoResume=!1,this._dimension=e.TextureDimension.Tex2D}get frameRate(){return this._frameRate}set frameRate(e){this._interval=e<.001?0:1e3/e,this._frameRate=e}get useMediaFrameRate(){return this._useMediaFrameRate}set useMediaFrameRate(e){this._useMediaFrameRate=e}get frameRender(){return this._frameRender}set frameRender(e){this._loaded&&(this._frameRender&&!e&&l.timer.clear(this,this.render),!this._frameRender&&e&&this._playing&&l.timer.frameLoop(1,this,this.render)),this._frameRender=e}get source(){return this._source}set source(e){this.load(e)}get currentTime(){return 0}set currentTime(e){}get volume(){return 0}set volume(e){}get muted(){return!1}set muted(e){}get readyState(){return 0}get videoWidth(){return this._width}get videoHeight(){return this._height}get duration(){return 0}get ended(){return!1}get loop(){return this._loop}set loop(e){this._loop=e}get playbackRate(){return 1}set playbackRate(e){}get paused(){return!1}canPlayType(e){return W.media.canPlayType(e)}setLoaded(t,s,r){this._width=t,this._height=s,this._loaded=!0,this._texture=f.textureContext.createTextureInternal(this._dimension,t,s,r?e.TextureFormat.R8G8B8A8:e.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,this.filterMode=e.FilterMode.Bilinear,f.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this._frameRender&&this._playing&&l.timer.frameLoop(1,this,this.render),this._playing&&this.onPlay(),this.event(c.READY,this)}render(e){if(this._loaded){if(!this._useMediaFrameRate&&!e){let e=performance.now();if(e-this._lastTimer<this._interval)return;this._lastTimer=e}this.onRender()&&this.event("videoUpdate")}}load(e){this._source=e,e?(this._texture&&(this._texture.dispose(),this._texture=null),J.inst.resolveURL(e,t=>{this._source===e&&this.onLoad(t)})):this.pause()}play(){!this._playing&&p.isPlaying&&(this._playing=!0,l.stage.on(c.BLUR,this,this.onBlur),this._loaded&&(this._frameRender&&l.timer.frameLoop(1,this,this.render),this.onPlay()))}pause(){this._autoResume=!1,this._playing&&(this._playing=!1,l.stage.off(c.BLUR,this,this.onBlur),l.timer.clear(this,this.render),this._loaded&&this.onPause())}resume(){this.play()}get gammaCorrection(){return 2.2}_getSource(){return this._texture?this._texture.resource:fs.blackTexture._getSource()}get defaultTexture(){return fs.blackTexture}destroy(){this._playing=!1,l.timer.clear(this,this.render),l.stage.off(c.BLUR,this,this.onBlur),this.onDestroy(),super.destroy()}onBlur(){this.allowBackground||W.media.resumeUntilGotFocus(this)}onLoad(e){}onRender(){return!1}onPlay(){}onPause(){}onDestroy(){}get currentSrc(){return this._source}get updateFrame(){return this.frameRate}set updateFrame(e){this.frameRate=e}get useFrame(){return this.useMediaFrameRate}set useFrame(e){this.useMediaFrameRate=e}}var fl;class Tl{constructor(){fl||(fl={"WhiteTexture.png":fs.whiteTexture,"BlackTexture.png":fs.blackTexture,"GrayTexture.png":fs.grayTexture,"NormalTexture.png":fs.normalTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let t=fl[Q.getBaseName(e.url)];if(t)return Promise.resolve(t)}let t;return e.url.startsWith("data:")||(t=J.inst.metaMap[e.url],t||!p.isPreview)?this.load2(e,t):J.inst.getMeta(e.url,e.uuid).then(t=>this.load2(e,t))}load2(t,s){let r,i,a=t.ext,n=t.url;if(s){const o={format:e.TextureFormat.R8G8B8A8,file:null,ext:null};let l=o;if(s.platforms&&s.files){if(Y.platform in s.platforms){const e=s.platforms[Y.platform];l=s.files[e]}let e=b(l.format);if(e&&!f.renderEngine.getCapable(e)){const e=s.files.find(e=>{const t=b(e.format);return f.renderEngine.getCapable(t)});l=e||o}if(null==l.file){l=s.files.find(e=>e.ext===a)||o}}l.file&&(n=J.inst.getSubAssetURL(n,t.uuid,l.file,l.ext),a=l.ext),r=[0,0,l.format,s.mipmap,s.readWrite,s.sRGB],i={wrapModeU:s.wrapMode,wrapModeV:s.wrapMode,filterMode:s.filterMode,anisoLevel:s.anisoLevel,premultiplyAlpha:!!s.pma,hdrEncodeFormat:s.hdrEncodeFormat}}else r=t.options.constructParams,i=t.options.propertyParams;let o=-1!=Dl.indexOf(a)?a:null;if(null!=o)return t.loader.fetch(n,"arraybuffer",t.progress.createCallback(),t.options).then(a=>{if(!a)return null;let n;switch(o){case"dds":let t=cs.getDDSTextureInfo(a);if(t.isCube){let e=Ee.getClass("TextureCube");if(!e)return null;{let s=!!r&&!!r[5],i=new e(t.width,t.format,t.mipmapCount>1,s);i.setDDSData(t),n=i}}else n=fs._parseDDS(a,i,r);break;case"ktx":let s=ms.getKTXTextureInfo(a);if(s.dimension==e.TextureDimension.Cube){let e=Ee.getClass("TextureCube");if(!e)return null;{let t=new e(s.width,s.format,s.mipmapCount>1,s.sRGB);t.setKTXData(s),n=t}}else s.dimension==e.TextureDimension.Tex2D&&(n=fs._parseKTX(a,i,r));break;case"pvr":n=fs._parsePVR(a,i,r);break;case"hdr":n=pl._parseHDRTexture(a,i,r);break;case"lanit.ls":n=fs._SimpleAnimatorTextureParse(a,i,r)}let l=t.obsoluteInst;return l&&Object.getPrototypeOf(l)==Object.getPrototypeOf(n)&&(n=this.move(l,n)),i&&i.hdrEncodeFormat&&(n.hdrEncodeFormat=i.hdrEncodeFormat),s&&(n._sizeGrid=s.sizeGrid,n._stateNum=s.stateNum),n});{let e=t.options,a=i&&i.premultiplyAlpha?"premultiply":"none";return e.useWorkerLoader&&"none"===a&&(e=Object.assign({workerLoaderOptions:{premultiplyAlpha:a}},e)),t.loader.fetch(n,"image",t.progress.createCallback(),e).then(t=>f.textureContext.needBitmap?t instanceof ImageBitmap?t:createImageBitmap(t,e.workerLoaderOptions||{premultiplyAlpha:a}):t).then(e=>{if(!e)return null;let a=fs._parseImage(e,i,r),n=t.obsoluteInst;return n&&Object.getPrototypeOf(n)==Object.getPrototypeOf(a)&&(a=this.move(n,a)),s&&(a._sizeGrid=s.sizeGrid,a._stateNum=s.stateNum),a})}}move(e,t){return e._texture=t._texture,e._format=t.format,e.width=t.width,e.height=t.height,e.obsolute=!1,delete V._idResourcesMap[t.id],e}}class yl{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then(s=>{if(!s)return null;null==s.width&&(s.width=256),null==s.height&&(s.height=256),null==s.colorFormat&&(s.colorFormat=e.RenderTargetFormat.R8G8B8A8),null==s.depthFormat&&(s.depthFormat=e.RenderTargetFormat.DEPTHSTENCIL_24_8),null==s.multiSamples&&(s.multiSamples=1);let r=t.obsoluteInst;return r?r.recreate(s.width,s.height,s.colorFormat,s.depthFormat,!!s.generateMipmap,s.multiSamples,!!s.generateDepthTexture,!!s.sRGB,!!s.storage):r=new z(s.width,s.height,s.colorFormat,s.depthFormat,!!s.generateMipmap,s.multiSamples,!!s.generateDepthTexture,!!s.sRGB,!!s.storage),null!=s.anisoLevel&&(r.anisoLevel=s.anisoLevel),null!=s.filterMode&&(r.filterMode=s.filterMode),null!=s.wrapModeU&&(r.wrapModeU=s.wrapModeU),null!=s.wrapModeV&&(r.wrapModeV=s.wrapModeV),r})}}class xl{load(e){let t=e.obsoluteInst||ml.createInstance();return t.source=e.url,Promise.resolve(t)}}const Sl={premultiplyAlpha:!0},El=[null,null,e.TextureFormat.R8G8B8A8,!1,!1,!0];class vl{wrapTex2D(e,t){if(!t)return null;let s=e.obsoluteInst;return s?(s.setTo(t),s.obsolute=!1,s._sizeGrid=t._sizeGrid,s._stateNum=t._stateNum,s.event("reload"),s._clipCache&&s._clipCache.forEach(e=>{e.event("reload"),e._sizeGrid=s._sizeGrid,e._stateNum=s._stateNum})):(s=new ie(t),s._sizeGrid=t._sizeGrid,s._stateNum=t._stateNum),s}load(e){let t=e.loader.getRes(e.url,Te.TEXTURE2D);if(!t||t.obsolute){let t={url:e.url,type:Te.TEXTURE2D};return e.options.propertyParams?null==e.options.propertyParams.premultiplyAlpha&&(t.propertyParams=Object.assign({},Sl,e.options.propertyParams)):t.propertyParams=Sl,e.options.constructParams?null==e.options.constructParams[5]&&(t.constructParams=Object.assign([],El,e.options.constructParams)):t.constructParams=El,e.loader.load(t,e.options,e.progress.createCallback()).then(t=>this.wrapTex2D(e,t))}return Promise.resolve(this.wrapTex2D(e,t))}}const Dl=["ktx","pvr","dds","hdr","exr","lanit.ls"],wl=["mp4","webm"];Te.registerLoader(["tga","tif","tiff","png","jpg","jpeg","webp","rendertexture",...wl,...Dl],vl,Te.IMAGE,!0),Te.registerLoader([],Tl,Te.TEXTURE2D,!0),Te.registerLoader(["rendertexture"],yl,Te.TEXTURE2D,!0),Te.registerLoader(wl,xl,Te.TEXTURE2D);Te.registerLoader(["mc"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then(e=>e?Oo._parse(e):null)}});Te.registerLoader(["mcc"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then(t=>{let s=new $o(t);if(s.data&&s.data.controllerLayers){let t=s.data.controllerLayers,r=[];for(let s=t.length-1;s>=0;s--){let i=t[s].states;this.loadStates(i,r,e)}return Promise.all(r).then(e=>(s.addDeps(e),s))}return s})}loadStates(e,t,s){let r=ee.getPath(s.url);for(let i=e.length-1;i>=0;i--){if(e[i].clip&&e[i].clip._$uuid){let a=ee.getResURLByUUID(e[i].clip._$uuid);a.startsWith("res://")||(a=ee.join(r,a)),t.push(s.loader.load(a).then(t=>(e[i].clip=t,t)))}e[i].states&&this.loadStates(e[i].states,t,s)}}});class bl{load(e){return Promise.resolve(null)}}Te.registerLoader(["lighting"],bl);Te.registerLoader(["fnt"],class{load(e){let t=Q.replaceFileExtension(e.url,"png");return Promise.all([e.loader.fetch(e.url,"xml",e.progress.createCallback(.2),e.options),e.loader.load(t,e.options,e.progress.createCallback(.8))]).then(([e,t])=>{if(!e||!t)return null;let s=new kn;return s.parseFont(e,t),s})}},Te.FONT);Te.registerLoader(["ttf","woff","woff2","otf"],class{load(e){return W.font.loadFont(e)}},Te.TTF);class Cl{static parse(e){let t=e.props;switch(e.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let t=Cl.parseLegacy(e);return t.oldparseEndEvent(),t;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${e.version}`)}let s,r=new Ba;r.setShaderName(t.type);for(let e in t)switch(e){case"type":case"name":break;case"defines":let o=t[e];for(let e=0,t=o.length;e<t;e++){let t=gr.getDefineByName(o[e]);r._shaderValues.addDefine(t)}break;case"textures":let l=t[e];for(let e=0,t=l.length;e<t;e++){let t=l[e],s=t.path;s&&r._shaderValues.setTexture(gr.propertyNameToID(t.name),Te.getBaseTexture(s))}break;case"renderQueue":s=t[e];break;case"alphaTest":r.alphaTest=t[e];break;case"materialRenderMode":r.materialRenderMode=t[e];break;default:let h=t[e],d=gr.propertyNameToID(e);switch(d){case gr.CULL:r.cull=h;break;case gr.BLEND:r.blend=h;break;case gr.BLEND_SRC:r.blendSrc=h;break;case gr.BLEND_DST:r.blendDst=h;break;case gr.BLEND_DST_ALPHA:r.blendDstAlpha=h;break;case gr.BLEND_SRC_ALPHA:r.blendSrcAlpha=h;break;case gr.BLEND_SRC_RGB:r.blendSrcRGB=h;break;case gr.BLEND_DST_RGB:r.blendDstRGB=h;break;case gr.DEPTH_TEST:r.depthTest=h;break;case gr.DEPTH_WRITE:r.depthWrite=!!t[e];break;case gr.STENCIL_TEST:r.stencilTest=h;break;case gr.STENCIL_Op:r.stencilOp=h;break;case gr.STENCIL_Ref:r.stencilRef=h;break;case gr.STENCIL_WRITE:r.stencilWrite=h;break;case gr.BLEND_EQUATION:r.blendEquation=h;break;case gr.BLEND_EQUATION_RGB:r.blendEquationRGB=h;break;case gr.BLEND_EQUATION_ALPHA:r.blendEquationAlpha=h;break;default:if(h.length){var n=h;switch(n.length){case 2:r._shaderValues.setVector2(d,new ct(n[0],n[1]));break;case 3:r._shaderValues.setVector3(d,new a(n[0],n[1],n[2]));break;case 4:r._shaderValues.getColor(d)?r._shaderValues.setColor(d,new y(n[0],n[1],n[2],n[3])):r._shaderValues.setVector(d,new i(n[0],n[1],n[2],n[3]));break;case 9:let e=new Us;e.elements=new Float32Array(n),r._shaderValues.setMatrix3x3(d,e);break;case 16:let t=new js;t.elements=new Float32Array(n),r._shaderValues.setMatrix4x4(d,t);break;default:r._shaderValues.setBuffer(d,n)}}else"boolean"==typeof h?r._shaderValues.setBool(d,t[e]):r._shaderValues.setNumber(d,t[e])}}return null!=s&&(r.renderQueue=s),r}static collectLinks(e,t){var s;let r=[],i=null===(s=e.props)||void 0===s?void 0:s.textures;if(i)for(let e=0,s=i.length;e<s;e++){let s=i[e],a=s.path;a&&(s.path=ee.join(t,a),r.push({url:s.path,type:Te.TEXTURE2D,constructParams:s.constructParams,propertyParams:s.propertyParams}))}return r}static parseLegacy(e){let t,s=e,r=s.props,n=r.type,o=Ee.getClass(n);switch(!o&&n&&n.startsWith("Laya.")&&(o=Ee.getClass(n.substring(5))),o?t=new o:(t=new Ba,t.setShaderName(n)),s.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let e in r)switch(e){case"type":break;case"vectors":let s=r[e];for(let e=0,r=s.length;e<r;e++){let r=s[e],n=r.value;switch(n.length){case 2:t[r.name]=new ct(n[0],n[1]);break;case 3:t[r.name]instanceof y?t[r.name]=new y(n[0],n[1],n[2],1):t[r.name]=new a(n[0],n[1],n[2]);break;case 4:t[r.name]instanceof y?t[r.name]=new y(n[0],n[1],n[2],n[3]):t[r.name]=new i(n[0],n[1],n[2],n[3]);break;default:throw new Error("unknown material color length: "+n.length)}}break;case"colors":let n=r[e];for(let e=0,s=n.length;e<s;e++){let s=n[e],r=s.value;t[s.name]=new y(r[0],r[1],r[2],r[3])}break;case"textures":let o=r[e];for(let e=0,s=o.length;e<s;e++){let s=o[e],r=s.path;r&&(t[s.name]=Te.getBaseTexture(r))}break;case"defines":let l=r[e];for(let e=0,s=l.length;e<s;e++){let s=gr.getDefineByName(l[e]);t._shaderValues.addDefine(s)}break;case"renderStates":let h=r[e][0];t.blend=h.blend,t.cull=this._getRenderStateParams(h.cull),t.depthTest=this._getRenderStateParams(h.depthTest),t.depthWrite=h.depthWrite,t.blendSrc=this._getRenderStateParams(h.srcBlend),t.blendDst=this._getRenderStateParams(h.dstBlend);break;case"cull":t.cull=this._getRenderStateParams(r[e]);break;case"blend":t.blend=this._getRenderStateParams(r[e]);break;case"depthWrite":t.depthWrite=!!r[e];break;case"srcBlend":case"blendSrc":t.blendSrc=this._getRenderStateParams(r[e]);break;case"dstBlend":case"blendDst":t.blendDst=this._getRenderStateParams(r[e]);break;case"depthTest":t.depthTest=this._getRenderStateParams(r[e]);break;default:t[e]=r[e]}break;case"LAYAMATERIAL:03":for(let e in r)switch(e){case"type":case"name":break;case"defines":let s=r[e];for(let e=0,r=s.length;e<r;e++){let r=gr.getDefineByName(s[e]);t._shaderValues.addDefine(r)}break;case"textures":let n=r[e];for(let e=0,s=n.length;e<s;e++){let s=n[e],r=s.path;r&&t._shaderValues.setTexture(gr.propertyNameToID(s.name),Te.getBaseTexture(r))}break;case"renderQueue":t.renderQueue=r[e];break;default:let o=r[e],h=gr.propertyNameToID(e);switch(h){case gr.CULL:t.cull=this._getRenderStateParams(o);break;case gr.BLEND:t.blend=this._getRenderStateParams(o);break;case gr.BLEND_SRC:t.blendSrc=this._getRenderStateParams(o);break;case gr.BLEND_DST:t.blendDst=this._getRenderStateParams(o);break;case gr.DEPTH_TEST:t.depthTest=this._getRenderStateParams(o);break;case gr.DEPTH_WRITE:t.depthWrite=!!r[e];break;case gr.BLEND_EQUATION:t.blendEquation=r[e];break;case gr.BLEND_EQUATION_ALPHA:t.blendEquationAlpha=r[e];break;case gr.BLEND_EQUATION_RGB:t.blendEquationRGB=r[e];break;default:if(o.length){var l=o;switch(l.length){case 2:t._shaderValues.setVector2(h,new ct(l[0],l[1]));break;case 3:t._shaderValues.setVector3(h,new a(l[0],l[1],l[2]));break;case 4:t._shaderValues.getColor(h)?t._shaderValues.setColor(h,new y(l[0],l[1],l[2],l[3])):t._shaderValues.setVector(h,new i(l[0],l[1],l[2],l[3]));break;default:throw new Error("unknown material color length: "+l.length)}}else"boolean"==typeof o?t._shaderValues.setBool(h,r[e]):t._shaderValues.setNumber(h,r[e])}}break;default:throw new Error("unknown material version: "+s.version)}return t}static _getRenderStateParams(t){switch(t){case 768:return e.BlendFactor.SourceColor;case 769:return e.BlendFactor.OneMinusSourceColor;case 774:return e.BlendFactor.DestinationColor;case 775:return e.BlendFactor.OneMinusDestinationColor;case 770:return e.BlendFactor.SourceAlpha;case 771:return e.BlendFactor.OneMinusSourceAlpha;case 772:return e.BlendFactor.DestinationAlpha;case 773:return e.BlendFactor.OneMinusDestinationAlpha;case 776:return e.BlendFactor.SourceAlphaSaturate;case 32774:return e.BlendEquationSeparate.ADD;case 32778:return e.BlendEquationSeparate.SUBTRACT;case 32779:return e.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return e.CompareFunction.Never;case 513:return e.CompareFunction.Less;case 514:return e.CompareFunction.Equal;case 515:return e.CompareFunction.LessEqual;case 516:return e.CompareFunction.Greater;case 517:return e.CompareFunction.NotEqual;case 518:return e.CompareFunction.GreaterEqual;case 519:return e.CompareFunction.Always;default:return t}}}class Rl{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.3),e.options).then(t=>{if(!t)return null;let s=ee.getPath(e.url),r=Cl.collectLinks(t,s);if("LAYAMATERIAL:04"===t.version){let i=t.props.type;if(!gr.find(i)){let a=J.inst.shaderName_to_URL(i);if(!a)return J.inst.shaderName_to_URL_async(i).then(a=>(a?r.push(a):t.props.shaderPath?r.push(ee.join(s,t.props.shaderPath)):Te.warn(`unknown shaderName: ${i}`),this.load2(e,t,r)));r.push(a)}}return this.load2(e,t,r)})}load2(e,t,s){if(0==s.length){let s=Cl.parse(t),r=e.obsoluteInst;return r&&(s=this.move(r,s)),Promise.resolve(s)}let r=Object.assign({},e.options);return r.initiator=e,delete r.cache,delete r.ignoreCache,e.loader.load(s,r,e.progress.createCallback()).then(()=>{let s=Cl.parse(t),r=e.obsoluteInst;return e.obsoluteInst&&(s=this.move(r,s)),s})}move(e,t){return e._shaderValues.clearData(),e.setShaderName(t._shader.name),t._shaderValues.cloneTo(e._shaderValues),e.materialRenderMode=t.materialRenderMode,e.renderQueue=t.renderQueue,e.obsolute=!1,t.destroy(),e}}Te.registerLoader(["lmat"],Rl,Te.MATERIAL,!0);class Ml{static parse(e){return this.parseStart(e)}static findIndex(e,t,s,r){var i=e.indexOf(s,t+1);return 0>i&&(i=r),{str:e.substring(t+1,i),i:i}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var e=this.currArr.pop();if(this.cobj.k)if(Array.isArray(e.val)){if(null!=this.cobj.k){var t={};t[this.cobj.k]=this.cobj.val,e.val.push(t)}}else e.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(e.val)?e.val.push(this.cobj.val):e.val=this.cobj.val);return e}static formatVal(e){if(null==e)return null;var t=Number(e);return isNaN(t)?"false"!=e.toLowerCase()&&("true"==e.toLowerCase()||("null"==e?null:e)):t}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(e){this.len=e.length;var t=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;t<this.len;){var s=e.charAt(t);if("/"==s){if(t+1<this.len){t+=1;var r=e.charAt(t),i=null;if("/"==r?i="\n":"*"==r&&(i="*/"),null!=i){this.finCurrStr();var a=e.indexOf(i,t);0>a?(console.log("没有找到注释结尾，应该是一直注释到最后了"),t=this.len):t=a+i.length-1}}}else if("}"==s)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==s)this.currStr="",this.type=1;else if("'"==s||'"'==s||"‘"==s||"“"==s){"‘"==s?s="’":"“"==s&&(s="”");var n=this.findIndex(e,t,s,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),t=n.i}else if(";"==s||","==s||"\n"==s)this.finCurrStr();else if("]"==s)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==s)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==s){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var o=this.cobj;this.cobj={val:{}},o.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=s);t++}return this.ret}}const Al=["GLSL Start","GLSL End"],Il=["#defineGLSL","#endGLSL"],Pl=["Shader3D Start","Shader3D End"],Bl={Color:e.ShaderDataType.Color,Int:e.ShaderDataType.Int,Bool:e.ShaderDataType.Bool,Float:e.ShaderDataType.Float,Vector2:e.ShaderDataType.Vector2,Vector3:e.ShaderDataType.Vector3,Vector4:e.ShaderDataType.Vector4,Matrix4x4:e.ShaderDataType.Matrix4x4,Matrix3x3:e.ShaderDataType.Matrix3x3,Texture2D:e.ShaderDataType.Texture2D,TextureCube:e.ShaderDataType.TextureCube,Texture2DArray:e.ShaderDataType.Texture2DArray,Texture3D:e.ShaderDataType.Texture3D};class Ll{static parse(e,t){let s=Ll.getShaderBlock(e),r=Ll.getCGBlock(e);return Ll.bindCG(s,r),gr.parse(s,t)}static compileToTree(e,t,s){if(s==e.length)return[t];let r=e[s],i=t.split(r);if(1==i.length)return i;let a=[];for(let t=0,n=i.length;t<n;t++)a=a.concat(Ll.compileToTree(e,i[t],s+1)),t!=n-1&&a.push(r);return a}static getMapKey(e){let t=e.indexOf("\n");return e=(e=(e=e.slice(0,t).replace("\r","")).slice(0,t).replace(" ","")).trim()}static getShaderBlock(t){var s,r;let i=null;try{let a=t.indexOf(Pl[0]);if(-1==a)throw new Error(`no '${Pl[0]}' tag`);let n=t.indexOf(Pl[1]);if(-1==n)throw new Error(`no '${Pl[1]}' tag`);let o=t.substring(a+Pl[0].length,n);i=Ml.parse(o),"string"==typeof i.shaderType?i.shaderType=null!==(s=e.ShaderFeatureType[i.shaderType])&&void 0!==s?s:e.ShaderFeatureType.None:i.shaderType=null!==(r=i.shaderType)&&void 0!==r?r:e.ShaderFeatureType.None,i.shaderType===e.ShaderFeatureType.D2_primitive&&(i.shaderType=e.ShaderFeatureType.D2_TextureSV)}catch(e){console.error("Shader parse error: "+e+"\n"+t.substring(0,100)+"...")}return i}static getCGBlock(e){let t={};try{let s=e.indexOf(Al[0]);if(-1==s)throw new Error(`no '${Pl[0]}' tag`);let r=e.indexOf(Al[1]);if(-1==r)throw new Error(`no '${Pl[1]}' tag`);let i=e.substring(s,r),a=Ll.compileToTree(Il,i,0);for(let e=0,s=a.length;e<s;e++){if(a[e]==Il[0]){e+=1;let s=a[e];t[Ll.getMapKey(s)]=s.slice(s.indexOf("\n"),s.length-1)}}}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static bindCG(e,t){let s=e.shaderPass;s&&s.forEach(e=>{e.VS&&(e.VS=t[e.VS]),e.FS&&(e.FS=t[e.FS])});let r=e.attributeMap;if(r){let t=0;for(let s in r)if(r[s]instanceof Array){let t=r[s],i=Ll.getShaderDataType(t[0]);if(null==i){console.warn(`${e.name}: unkown attribute type '${t[0]}'`);continue}r[s]=[t[1],i]}else{let i=Ll.getShaderDataType(r[s]);if(null==i){console.warn(`${e.name}: unkown attribute type '${r[s]}'`);continue}r[s]=[t,i],t++}}let i=e.uniformMap;if(i){let t={};e.defaultValue=t;let s={};e.uniformMap=s;for(let r in i){let a=i[r];if(!1===a.serializable)continue;let n=Ll.getShaderDataType(a.type);if(null!=n)if(null!=a.default&&(t[r]=Ll.getDefaultData(n,a.default)),a.block){let e=s[a.block];e||(s[a.block]=e={}),e[r]=n}else s[r]=n;else console.warn(`${e.name}: unkown uniform type '${a.type}'`)}}}static getShaderDataType(e){return Bl[e]}static getDefaultData(t,s){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Float:case e.ShaderDataType.Bool:return s;case e.ShaderDataType.Vector2:return new ct(s[0],s[1]);case e.ShaderDataType.Vector3:return new a(s[0],s[1],s[2]);case e.ShaderDataType.Vector4:return new i(s[0],s[1],s[2],s[3]);case e.ShaderDataType.Color:return new y(s[0],s[1],s[2],s[3]);case e.ShaderDataType.Matrix4x4:let t=new js;return t.cloneByArray(s),t;case e.ShaderDataType.Matrix3x3:let r=new Us;return r.cloneByArray(s),r;case e.ShaderDataType.Texture2D:let n=null;return"white"==s?n=fs.whiteTexture:"black"==s?n=fs.blackTexture:"gray"==s?n=fs.grayTexture:"normal"==s&&(n=fs.normalTexture),n;case e.ShaderDataType.TextureCube:let o=yn.grayTexture;return"white"==s?o=yn.whiteTexture:"black"==s?o=yn.blackTexture:"gray"==s&&(o=yn.grayTexture),o}}}Te.registerLoader(["shader","bps"],class{load(e){let t=e.url;return"bps"===e.ext&&(t=J.inst.getSubAssetURL(t,e.uuid,"0","shader")),e.loader.fetch(t,"text",e.progress.createCallback(),e.options).then(t=>{if(!t)return null;let s=Ll.getShaderBlock(t),r=Ll.getCGBlock(t);if(Ll.bindCG(s,r),!s.name||!s.uniformMap)return null;let i=ee.getPath(e.url),a=s.shaderPass;return Promise.all(a.map(e=>Fs.compileAsync(e.VS,e.FS,i))).then(t=>{var r;if(-1!=t.findIndex(e=>null==e))return Te.warn("some pass null "+e.url),null;let i=gr.add(s.name,s.enableInstancing,s.supportReflectionProbe);i._supportVolumetricGI=s.supportVolumetricGI,i.shaderType=s.shaderType;let n=new pr(s.attributeMap?s.attributeMap:pr.DefaultAttributeMap,s.uniformMap,s.defaultValue);i.addSubShader(n);for(let e in a){let s=n._addShaderPass(t[e],a[e].pipeline);s.statefirst=null!==(r=a[e].statefirst)&&void 0!==r&&r,Fs.getRenderState(a[e].renderState,s.renderState)}return i})})}});Te.registerLoader(["glsl","vs","fs"],class{load(e){let t=e.url;return e.loader.fetch(t,"text",e.progress.createCallback(),e.options).then(t=>t?Fs.addInclude(e.url,t,!0):null)}});Te.registerLoader(["mp3","wav","ogg"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then(e=>{if(!e)return null;let t=e.byteLength;return W.media.decodeAudioData(e).then(e=>(e&&(e.__byteLength=t),e))})}},Te.SOUND);class Nl{}Nl.Blend=0,Nl.Fixed=1;class Fl{get maxColorRGBKeysCount(){return this._maxColorRGBKeysCount}get colorRGBKeysCount(){return this._colorRGBKeysCount}get _rgbElements(){return this._rgbElementDatas}set _rgbElements(e){this._rgbElementDatas=e,this._maxColorRGBKeysCount=e?e.length/4:0}get maxColorAlphaKeysCount(){return this._maxColorAlphaKeysCount}get colorAlphaKeysCount(){return this._colorAlphaKeysCount}get _alphaElements(){return this._alphaElementDatas}set _alphaElements(e){this._alphaElementDatas=e,this._maxColorAlphaKeysCount=e?e.length/2:0}get maxColorKeysCount(){return Math.max(this._maxColorAlphaKeysCount,this._maxColorRGBKeysCount)}get mode(){return this._mode}set mode(e){this._mode=e}constructor(){this._mode=0,this._maxColorRGBKeysCount=0,this._colorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorAlphaKeysCount=0,this._keyRanges=new i(1,0,1,0)}addColorRGB(e,t){if(this._colorRGBKeysCount>=this._maxColorRGBKeysCount){let e=new Float32Array(4*(this._maxColorRGBKeysCount+4));this._rgbElementDatas&&e.set(this._rgbElementDatas),this._rgbElements=e}let s=4*this._colorRGBKeysCount;this._rgbElementDatas[s]=e,this._rgbElementDatas[s+1]=t.r,this._rgbElementDatas[s+2]=t.g,this._rgbElementDatas[s+3]=t.b,this._colorRGBKeysCount++}addColorAlpha(e,t){if(this._colorAlphaKeysCount>=this._maxColorAlphaKeysCount){let e=new Float32Array(2*(this._maxColorAlphaKeysCount+4));this._alphaElementDatas&&e.set(this._alphaElementDatas),this._alphaElements=e}let s=2*this._colorAlphaKeysCount;this._alphaElementDatas[s]=e,this._alphaElementDatas[s+1]=t,this._colorAlphaKeysCount++}updateColorRGB(e,t,s){if(e<this._colorRGBKeysCount){var r=4*e;this._rgbElements[r]=t,this._rgbElements[r+1]=s.r,this._rgbElements[r+2]=s.g,this._rgbElements[r+3]=s.b,this._gpuRGBData4&&e<4&&(this._gpuRGBData4[r]=t,this._gpuRGBData4[r+1]=s.r,this._gpuRGBData4[r+2]=s.g,this._gpuRGBData4[r+3]=s.b),this._gpuRGBData8&&e<8&&(this._gpuRGBData8[r]=t,this._gpuRGBData8[r+1]=s.r,this._gpuRGBData8[r+2]=s.g,this._gpuRGBData8[r+3]=s.b)}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}updateColorAlpha(e,t,s){if(e<this._colorAlphaKeysCount){var r=2*e;this._alphaElements[r]=t,this._alphaElements[r+1]=s,this._gpuAlphaData4&&e<4&&(this._gpuAlphaData4[r]=t,this._gpuAlphaData4[r+1]=s),this._gpuAlphaData8&&e<8&&(this._gpuAlphaData8[r]=t,this._gpuAlphaData8[r+1]=s)}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}evaluateColorRGB(e,t,s=0,r=!1){e=Math.min(Math.max(e,0),1);var i=this._rgbElements,a=s;if(r)for(var n=a;n>=0;n--){var o=4*n;if(e===(_=i[o]))return t.r=i[o+1],t.g=i[o+2],t.b=i[o+3],a;var l=i[o+4];switch(this._mode){case Nl.Blend:if(e>_&&l){if(e>l)continue;var h=l-_,d=l-e,u=e-_;return t.r=(d*i[o+1]+u*i[o+5])/h,t.g=(d*i[o+2]+u*i[o+6])/h,t.b=(d*i[o+3]+u*i[o+7])/h,a}a--;continue;case Nl.Fixed:if(e>_){if(e>i[o+4])throw"Gradient:wrong startSearchIndex.";return t.r=i[o+5],t.g=i[o+6],t.b=i[o+7],a}a--;continue;default:throw"Gradient:unknown mode."}}else{n=0;for(var c=this._rgbElements.length;n<c;n++){if(e===(l=i[o=4*n]))return t.r=i[o+1],t.g=i[o+2],t.b=i[o+3],a;switch(this._mode){case Nl.Blend:if(e<l){var _;if(e<(_=i[o-4]))throw"Gradient:wrong startSearchIndex.";h=l-_,d=l-e,u=e-_;return t.r=(d*i[o-3]+u*i[o+1])/h,t.g=(d*i[o-2]+u*i[o+2])/h,t.b=(d*i[o-1]+u*i[o+3])/h,a}a++;continue;case Nl.Fixed:if(e<l){if(e<i[o-4])throw"Gradient:wrong startSearchIndex.";return t.r=i[o+1],t.g=i[o+2],t.b=i[o+3],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}evaluateColorAlpha(e,t,s=0,r=!1){e=Math.min(Math.max(e,0),1);var i=this._alphaElements,a=s;if(r)for(var n=a;n>=0;n--){if(e===(_=i[c=2*n]))return t.a=i[c+1],a;var o=i[c+2];switch(this._mode){case Nl.Blend:if(e>_&&o){if(e>o)continue;var l=o-_,h=o-e,d=e-_;return t.a=(h*i[c+1]+d*i[c+3])/l,a}a--;continue;case Nl.Fixed:if(e>_){if(e>i[c+2])throw"Gradient:wrong startSearchIndex.";return t.a=i[c+3],a}a--;continue;default:throw"Gradient:unknown mode."}}else{n=a;for(var u=this._alphaElements.length;n<u;n++){var c;if(e===(o=i[c=2*n]))return t.a=i[c+1],a;switch(this._mode){case Nl.Blend:if(e<o){var _;if(e<(_=i[c-2]))throw"Gradient:wrong startSearchIndex.";l=o-_,h=o-e,d=e-_;return t.a=(h*i[c-1]+d*i[c+1])/l,a}a++;continue;case Nl.Fixed:if(e<o){if(e<i[c-2])throw"Gradient:wrong startSearchIndex.";return t.a=i[c+1],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}_updateGpuData(e,t){let s=Math.min(e.length,t.length);for(let r=0;r<s;r++)e[r]=t[r]}_fixGPUAlphaData(e){if(1==this.colorAlphaKeysCount){let t=this._alphaElements[1];e[0]=0,e[1]=t,e[2]=1,e[3]=t}else 2==this.colorAlphaKeysCount?(e[0]=0,e[1]=this._alphaElements[1],e[2]=1,e[3]=this._alphaElements[3]):this._updateGpuData(e,this._alphaElements)}_fixGPURGBData(e){if(1==this.colorRGBKeysCount){let t=this._rgbElements[1],s=this._rgbElements[2],r=this._rgbElements[3];e[0]=0,e[1]=t,e[2]=s,e[3]=r,e[4]=1,e[5]=t,e[6]=s,e[7]=r}else 2==this.colorRGBKeysCount?(e[0]=0,e[1]=this._rgbElements[1],e[2]=this._rgbElements[2],e[3]=this._rgbElements[3],e[4]=1,e[5]=this._rgbElements[5],e[6]=this._rgbElements[6],e[7]=this._rgbElements[7]):this._updateGpuData(e,this._rgbElements)}_getGPURGBData4(){return this._gpuRGBData4||(this._gpuRGBData4=new Float32Array(16)),this._fixGPURGBData(this._gpuRGBData4),this._gpuRGBData4}_getGPURGBData8(){return this._gpuRGBData8||(this._gpuRGBData8=new Float32Array(32)),this._fixGPURGBData(this._gpuRGBData8),this._gpuRGBData8}_getGPUAlphaData4(){return this._gpuAlphaData4||(this._gpuAlphaData4=new Float32Array(8)),this._fixGPUAlphaData(this._gpuAlphaData4),this._gpuAlphaData4}_getGPUAlphaData8(){return this._gpuAlphaData8||(this._gpuAlphaData8=new Float32Array(16)),this._fixGPUAlphaData(this._gpuAlphaData8),this._gpuAlphaData8}cloneTo(e){e._colorAlphaKeysCount=this._colorAlphaKeysCount;let t=e._alphaElements=new Float32Array(this._alphaElements.length);for(let e=0,s=this._alphaElements.length;e<s;e++)t[e]=this._alphaElements[e];e._colorRGBKeysCount=this._colorRGBKeysCount;var s=e._rgbElements=new Float32Array(this._rgbElements.length);for(let e=0,t=this._rgbElements.length;e<t;e++)s[e]=this._rgbElements[e]}clone(){var e=new Fl;return this.cloneTo(e),e}}var Ol;e.WeightedMode=void 0,(Ol=e.WeightedMode||(e.WeightedMode={}))[Ol.None=0]="None",Ol[Ol.In=1]="In",Ol[Ol.Out=2]="Out",Ol[Ol.Both=3]="Both";class Ul{constructor(){}cloneTo(e){e.time=this.time}clone(){var e=new Ul;return this.cloneTo(e),e}}Ul.defaultWeight=.33333;class kl extends Ul{constructor(){super(),this.inWeight=Ul.defaultWeight,this.outWeight=Ul.defaultWeight,this.weightedMode=e.WeightedMode.None}cloneTo(e){super.cloneTo(e),e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value,e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value,e.inWeight=this.inWeight,e.outWeight=this.outWeight,e.weightedMode=this.weightedMode}clone(){let e=new kl;return this.cloneTo(e),e}}class Vl extends ja{constructor(){super(),this._renderType|=$e.AREA2D,this._initShaderData(),this._globalRenderData=f.render2DRenderPassFactory.create2DGlobalRenderDataHandle(),this._globalRenderData.globalShaderData=this._globalShaderData=f.renderDeviceFactory.createShaderData(null),this._globalRenderData.renderLayerMask=-1,this._struct.globalRenderData=this._globalRenderData}get mainCamera(){return this._mainCamera}_setMainCamera(e){e!=this._mainCamera&&p.isPlaying&&(this._mainCamera&&(this._mainCamera._isMain=!1),e?(e._isMain=!0,this._globalShaderData.addDefine(Dn.SHADERDEFINE_CAMERA2D)):this._globalShaderData.removeDefine(Dn.SHADERDEFINE_CAMERA2D),this._mainCamera=e)}render(){this._mainCamera&&this._globalShaderData&&(this._globalRenderData.renderLayerMask=this._mainCamera.visiableLayer,this._globalRenderData.cullRect=this._mainCamera._rect,this._globalShaderData.setMatrix3x3(Dn.VIEW2D,this._mainCamera._getCameraTransform()))}_setBelongScene(e){super._setBelongScene(e),this._scene._area2Ds.add(this)}_setUnBelongScene(){this._scene._area2Ds.delete(this),super._setUnBelongScene()}localToView(e,t,s){return(s=s||new u).setTo(e,t),this.localToGlobal(s),this.transformPoint(s.x,s.y,s),s}transformPoint(e,t,s){if((s=s||new u).setTo(e,t),!this._mainCamera)return s;let r=e-.5*Ia.width,i=t-.5*Ia.height;this._mainCamera._getCameraTransform();let a=this._mainCamera.cameraMatrix.elements,n=a[0]*r+a[3]*i+a[6],o=a[1]*r+a[4]*i+a[7],l=Ce.TEMP;return this._globalTrans.getMatrixInv(l),s.x=l.a*n+l.c*o+l.tx,s.y=l.b*n+l.d*o+l.ty,s}}class Gl extends ja{constructor(){super(),this._fps=30,this._width=this._height=200,this._widget=En.EMPTY;let t=new ie(new fs(this._width,this._height,e.TextureFormat.R8G8B8A8,!1,!1,!0));t.bitmap.lock=!0,this.texture=t,this._canvas=W.browser.getOpenDataContextCanvas()}get fps(){return this._fps}set fps(e){this._fps!=e&&(this._fps=e,p.isPlaying&&this.activeInHierarchy&&this._canvas&&(l.timer.clear(this,this._onLoop),l.timer.loop(1e3/e,this,this._onLoop)))}_onActive(){p.isPlaying&&this._canvas&&l.timer.loop(1e3/this._fps,this,this._onLoop)}_onInActive(){p.isPlaying&&(this.postMsg({type:"close"}),l.timer.clear(this,this._onLoop))}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}_getWidget(){return this._widget===En.EMPTY&&(this._widget=this.addComponent(En)),this._widget}_onLoop(){let t=this.texture,s=this._canvas;t.width==s.width&&t.height==s.height||(t.bitmap.destroy(),t.bitmap=new fs(s.width,s.height,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0),t.bitmap.lock=!0,this._graphics.repaint()),this._canvas&&t.bitmap.setImageData(s,!0,!1)}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Size)&&(this._canvas&&(this._canvas.width=this._width,this._canvas.height=this._height),this._widget!==En.EMPTY&&this._widget.resetLayout(),this.callLater(this.updateViewPort)),0!=(t&e.TransformKind.Pos)&&this.callLater(this.updateViewPort)}updateViewPort(){let e=l.stage,t=e._canvasTransform.getScaleX()*this.scaleX*e.transform.getScaleX(),s=e._canvasTransform.getScaleY()*this.scaleY*e.transform.getScaleY();this.postMsg({type:"updateViewPort",box:{x:this.x*t,y:this.y*s,width:this.width*t,height:this.height*s}})}postMsg(e){W.browser.postMessageToOpenDataContext(e)}}class zl{constructor(){this._active=!0,this.destroyed=!1,this._singleton=!1}get singleton(){return this._singleton}get active(){return this._active}set active(e){this._active!=e&&(this._active=e,this._owner&&this._owner._onChangeRender())}destroy(){this.destroyed=!0}}let Hl=Ee.regClass;Hl("Record",Object),Hl("Node",ki),Hl("Sprite",ja),Hl("Widget",En),Hl("Text",Kn),Hl("Input",co),Hl("Animation",Un),Hl("SoundNode",_o),Hl("VideoNode",po),Hl("Area2D",Vl),Hl("OpenDataContextView",Gl),Hl("Scene",wn),Hl("Stage",cn),Hl("Component",fa),Hl("Script",Qo),Hl("BitmapFont",kn),Hl("Point",u),Hl("Rectangle",te),Hl("Texture",ie),Hl("Texture2D",fs),Hl("Prefab",zo),Hl("Animator2D",vo),Hl("AnimatorControllerLayer2D",mo),Hl("AnimatorState2D",Do),Hl("AnimationClip2D",Oo),Hl("AnimatorController2D",$o),Hl("Animation2DParm",ko),Hl("Animation2DCondition",Go),Hl("FrameAnimation",On),Hl("Vector2",ct),Hl("Vector3",a),Hl("Vector4",i),Hl("Quaternion",zs),Hl("Color",y),Hl("Matrix",Ce),Hl("Matrix3x3",Us),Hl("Matrix4x4",js),Hl("Camera2D",Dn),Hl("Mesh2DRender",Fa),Hl("BaseRenderNode2D",xa),Hl("Mesh2D",Na),Hl("Gradient",Fl),Hl("FloatKeyframe",kl),Hl("PostProcess2D",Xa),Hl("PostProcess2DEffect",zl);class Wl{static createComputeShader(e,t,s){return Wl._CompileShader[e]?Wl._CompileShader[e]:new Wl(e,t,s)}constructor(e,t,s){this._cacheSharders={},this._cacheShaderHierarchy=1,this.name=e,this.code=t,this.other=s}setCacheShader(e,t){for(var s=this._cacheSharders,r=e._mask,i=e._length-1,a=this._cacheShaderHierarchy-1,n=0;n<a;n++){var o=i<n?0:r[n],l=s[o];l||(s[o]=l={}),s=l}s[i<a?0:r[a]]=t}getCacheShader(e){var t=this._cacheSharders,s=e._length;s>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(t,0,s),this._cacheShaderHierarchy=s);for(var r=e._mask,i=e._length-1,a=this._cacheShaderHierarchy-1,n=0;n<a;n++){var o=i<n?0:r[n],l=t[o];l||(t[o]=l={}),t=l}var h=t[i<a?0:r[a]];return h||(h=f.renderDeviceFactory.createComputeShader({name:this.name,code:this.code,other:this.other,defineData:e}),this.setCacheShader(e,h)),h}_resizeCacheShaderMap(e,t,s){var r=this._cacheShaderHierarchy-1;if(t==r)for(var i in e)for(var a=e[i],n=0,o=s-r;n<o;n++)n===o-1?e[0]=a:e=e[0==n?i:0]={};else for(var i in++t,e)this._resizeCacheShaderMap(e[i],t,s)}}var Xl,Yl,ql,jl,Kl,$l,Ql,Zl,Jl,eh,th,sh;Wl._CompileShader={},e.ComputeCommandType=void 0,(Xl=e.ComputeCommandType||(e.ComputeCommandType={}))[Xl.DispatchCompute=0]="DispatchCompute",Xl[Xl.SetRenderData=1]="SetRenderData",Xl[Xl.ClearBuffer=2]="ClearBuffer",Xl[Xl.CopyBufferToBuffer=3]="CopyBufferToBuffer",Xl[Xl.copyBufferToTexture=4]="copyBufferToTexture",Xl[Xl.copyTextureToBuffer=5]="copyTextureToBuffer",Xl[Xl.copyTextureToTexture=6]="copyTextureToTexture",e.EComputeCMDMemoryOperate=void 0,(Yl=e.EComputeCMDMemoryOperate||(e.EComputeCMDMemoryOperate={}))[Yl.ClearBuffer=0]="ClearBuffer",Yl[Yl.BufferToBuffer=1]="BufferToBuffer",Yl[Yl.BufferToTexture=2]="BufferToTexture",Yl[Yl.TextureToBuffer=3]="TextureToBuffer",Yl[Yl.TextureToTexture=4]="TextureToTexture";e.EDeviceBufferUsage=void 0,(ql=e.EDeviceBufferUsage||(e.EDeviceBufferUsage={}))[ql.MAP_READ=1]="MAP_READ",ql[ql.MAP_WRITE=2]="MAP_WRITE",ql[ql.COPY_SRC=4]="COPY_SRC",ql[ql.COPY_DST=8]="COPY_DST",ql[ql.STORAGE=16]="STORAGE",ql[ql.INDIRECT=32]="INDIRECT",e.RenderCMDType=void 0,(jl=e.RenderCMDType||(e.RenderCMDType={}))[jl.DrawNode=0]="DrawNode",jl[jl.DrawElement=1]="DrawElement",jl[jl.Blit=2]="Blit",jl[jl.ChangeData=3]="ChangeData",jl[jl.ChangeShaderDefine=4]="ChangeShaderDefine",jl[jl.ChangeViewPort=5]="ChangeViewPort",jl[jl.ChangeRenderTarget=6]="ChangeRenderTarget",jl[jl.ComputeCommandAppatch=7]="ComputeCommandAppatch";class rh{constructor(e,t,s,r,i){this._destroyed=!1,this._id=rh._idCounter++,this.cluster=e,this.index=t,this.size=s,this._alignedSize=r,this.offset=r*t,this.user=i,this.uploadNum=0,this.moved=!1}needUpload(){this.cluster._addUploadBlock(this.index),!this.moved&&this.uploadNum++>this.cluster.manager.uploadThreshold&&this.cluster.manager._addOptimizeBufferPos(this.cluster)}destroy(){return this._destroyed?(console.warn("UniformBufferBlock: object alreay destroyed!"),!1):(this._destroyed=!0,this.cluster=null,this.user=null,!0)}}rh._idCounter=0;class ih{constructor(e,t,s){this._inManagerUpdateArray=!1,this._sn=0,this._id=0,this._destroyed=!1,this._blocks=[],this._holeNum=0,this._expand=16,this._id=ih._idCounter++,this.manager=s,this._blockSize=e,this._blockNum=t,this._totalSize=e*t,this._needUpload=new Array(t).fill(!1),this.data=new ArrayBuffer(this._totalSize),this._move=new Uint8Array(this._blockSize),this.buffer=this.manager.createGPUBuffer(this._totalSize),this.manager.statisGPUMemory(this._totalSize)}get usedNum(){return this._blocks.length}_expandBuffer(){let e=this._blockNum;if(this._blockNum+=this._expand,this._blockNum>this.manager.clusterMaxBlock&&(this._blockNum=this.manager.clusterMaxBlock),e=this._blockNum-e,e<1)return!1;this._totalSize=this._blockSize*this._blockNum;const t=this._blockSize*this._expand;this._needUpload=this._needUpload.concat(new Array(e).fill(!1));const s=new ArrayBuffer(this._totalSize);return new Uint8Array(s).set(new Uint8Array(this.data)),this.data=s,this.buffer=this.manager.createGPUBuffer(this._totalSize,null,this.data),this.manager.statisGPUMemory(t),this._blocks.forEach(e=>e&&e.user.notifyGPUBufferChange("expand")),!0}_moveBlock(e){const t=this._blocks.length;if(e>=t)return!1;const s=new Uint8Array(this.data),r=this._blockSize;for(let i=e+1;i<t;i++){const e=i*r,t=e+r,a=e-r;s.copyWithin(a,e,t),this._needUpload[i-1]=this._needUpload[i],this._blocks[i-1]=this._blocks[i],this._blocks[i-1]&&(this._blocks[i-1].index--,this._blocks[i-1].offset-=r,this._blocks[i-1].user.notifyGPUBufferChange("moveBlock"))}return this._blocks.length--,!0}_createBufferBlock(e,t,s,r){return new rh(this,e,t,s,r)}getBlock(e,t){const s=ah(e,this.manager.byteAlign);if(s!==this._blockSize)return console.warn("WebGPUBufferCluster: 获取内存块时, 长度错误!"),null;const r=this._getBlockWithExpand(),i=this._createBufferBlock(r,e,s,t);return this._blocks[r]=i,i}freeBlock(e){const t=this._blocks.indexOf(e);return-1!==t&&(t===this._blocks.length-1?this._blocks.length--:(this._blocks[t]=null,this._holeNum++),e.destroy(),this._holeNum>this.manager.removeHoleThreshold&&(this.manager._addRemoveHoleCluster(this),this._holeNum=0),!0)}upload(){var e;let t=!1,s=-1,r=-1,i=0,a=0;for(let n=0,o=this._blocks.length;n<o;n++)this._needUpload[n]?(-1===s&&(s=n),r=n,t=!0,this._needUpload[n]=!1,null===(e=this._blocks[n])||void 0===e||e.user.updateOver()):t&&(i=s*this._blockSize,a=(r-s+1)*this._blockSize,this.manager.writeBuffer(this.buffer,this.data,i,a),s=-1,r=-1,t=!1);t&&(i=s*this._blockSize,a=(r-s+1)*this._blockSize,this.manager.writeBuffer(this.buffer,this.data,i,a))}_addUploadBlock(e){this._needUpload[e]=!0,this._inManagerUpdateArray||this.manager._addUpdateArray(this)}optimize(){let e=!1;for(let t=0,s=this._blocks.length;t<s;t++){const s=this._blocks[t];if(s&&!s.moved&&s.uploadNum>this.manager.uploadThreshold&&t>0){const r=this._blockSize,i=new Uint8Array(this.data);this._move.set(new Uint8Array(this.data,r*t,r));for(let e=t-1;e>=0;e--){const t=e*r,s=t+r,a=t+r;i.copyWithin(a,t,s),this._needUpload[e+1]=this._needUpload[e],this._blocks[e+1]=this._blocks[e],this._blocks[e+1]&&(this._blocks[e+1].index++,this._blocks[e+1].offset+=r,this._blocks[e+1].user.notifyGPUBufferChange("optimize"))}i.set(this._move),s.index=0,s.offset=0,s.moved=!0,this._blocks[0]=s,this._blocks[0].user.notifyGPUBufferChange("optimize"),e=!0}}return e}removeHole(){let e=!1;for(let t=this._blocks.length-1;t>-1;t--)this._blocks[t]||this._moveBlock(t)&&(e=!0);return this._holeNum=0,e}clear(e){this._blocks.forEach(e=>e&&e.destroy()),this._blocks.length=0,null!=e&&e>0&&e!==this._blockNum?(this._blockNum=e,this._totalSize=this._blockSize*this._blockNum,this.buffer=this.manager.createGPUBuffer(this._totalSize),this.data=new ArrayBuffer(this._totalSize)):(this._blockNum=0,this._totalSize=0,this.buffer=null,this.data=null),this._needUpload.length=this._blockNum,this._needUpload.fill(!1)}_getBlockWithExpand(){for(let e=this._blocks.length-1;e>-1;e--)if(!this._blocks[e])return this._holeNum--,e;return this._blocks.length<this._blockNum||this._expandBuffer(),this._blocks.length}destroy(){var e;return this._destroyed?(console.warn("UniformBufferCluster: object alreay destroyed!"),!1):(this.clear(),null!==(e=this.buffer.destroy)&&void 0!==e||this.buffer.destroy(),this.manager.statisGPUMemory(-this._totalSize),this._destroyed=!0,!0)}}function ah(e,t){return((e+t-1)/t|0)*t}ih._idCounter=0;class nh{constructor(e,t,s){this._destroyed=!1,this.uploadNum=0,this.data=new ArrayBuffer(e),this.buffer=t.getBufferAlone(e),this._manager=t,this._size=e,this._alignedSize=ah(e,t.byteAlign),this.user=s,t.aloneBuffers.push(this)}upload(){this._manager.writeBuffer(this.buffer,this.data,0,this._size)}destroy(){return this._destroyed?(console.warn("UniformBufferAlone: object alreay destroyed!"),!1):(this.data=null,this.buffer.destroy&&this.buffer.destroy(),this._manager.statisGPUMemory(-this._size),this._manager.aloneBuffers.splice(this._manager.aloneBuffers.indexOf(this),1),this._destroyed=!0,!0)}}class oh{constructor(e,t,s,r){this.destroyed=!1,this.name=e,this._strId="",this._items=new Map,this._itemNum=0,this.data=r,this._size=t,this.manager=s,this.needUpload=!1,s._useBigBuffer?(this.bufferBlock=s.getBlock(t,this),this.offset=this.bufferBlock.offset):this.bufferAlone=this._createBufferAlone(t,s)}_createBufferAlone(e,t){return new nh(e,t,this)}updateOver(){this.needUpload=!1}notifyGPUBufferChange(){const e=this.bufferBlock.offset-this.offset;this.offset=this.bufferBlock.offset,this._items.forEach(t=>{const s=oh._typeArray(t.type);t.view=new s(this.bufferBlock.cluster.data,t.view.byteOffset+e,t.size/s.BYTES_PER_ELEMENT)}),this.clearGPUBufferBind(),this.needUpload=!0}clearGPUBufferBind(){}addUniform(e,t,s,r,i,a,n,o){this._items.has(e)||(this._items.set(e,this._getUniformItem(t,oh._typeArray(s),s,r,i,a,n,o)),this._strId.length>0&&(this._strId+="|"),this._strId+=e,this._itemNum++)}setUniformData(e,t){const s=this._items.get(e);if(s)if(this.needUpload=!0,1==s.count)switch(s.type){case"int":case"float":s.view[0]=t;break;case"vec2":s.view[0]=t.x,s.view[1]=t.y;break;case"vec3":s.view[0]=t.x,s.view[1]=t.y,s.view[2]=t.z;break;case"vec4":s.view[0]=t.x,s.view[1]=t.y,s.view[2]=t.z,s.view[3]=t.w;break;case"mat3":for(let e=0;e<3;e++)s.view[4*e+0]=t.elements[3*e+0],s.view[4*e+1]=t.elements[3*e+1],s.view[4*e+2]=t.elements[3*e+2];break;case"mat4":s.view.set(t.elements)}else{const e=s.count*s.elements,r=s.size/s.count/s.view.BYTES_PER_ELEMENT;for(let i=0,a=0;i<e;i+=s.elements,a+=r)s.view.set(t.subarray(i,i+s.elements),a)}}setBool(e,t){const s=this._items.get(e);s&&(s.view[0]=t?1:0,this.needUpload=!0)}setBoolArray(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view[e]=t[e]?1:0;this.needUpload=!0}}setInt(e,t){const s=this._items.get(e);s&&(s.view[0]=t,this.needUpload=!0)}setIntArray(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view[e]=t[e];this.needUpload=!0}}setFloat(e,t){const s=this._items.get(e);s&&(s.view[0]=t,this.needUpload=!0)}setFloatArray(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view[e]=t[e];this.needUpload=!0}}setVector2(e,t){const s=this._items.get(e);s&&(s.view[0]=t.x,s.view[1]=t.y,this.needUpload=!0)}setVector2Array(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view[2*e+0]=t[e].x,s.view[2*e+1]=t[e].y;this.needUpload=!0}}setVector3(e,t){const s=this._items.get(e);s&&(s.view[0]=t.x,s.view[1]=t.y,s.view[2]=t.z,this.needUpload=!0)}setVector3Array(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view[4*e+0]=t[e].x,s.view[4*e+1]=t[e].y,s.view[4*e+2]=t[e].z;this.needUpload=!0}}setVector4(e,t){const s=this._items.get(e);s&&(s.view[0]=t.x,s.view[1]=t.y,s.view[2]=t.z,s.view[3]=t.w,this.needUpload=!0)}setVector4Array(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view[4*e+0]=t[e].x,s.view[4*e+1]=t[e].y,s.view[4*e+2]=t[e].z,s.view[4*e+3]=t[e].w;this.needUpload=!0}}setMatrix3x3(e,t){const s=this._items.get(e);if(s){for(let e=0;e<3;e++)s.view[4*e+0]=t.elements[3*e+0],s.view[4*e+1]=t.elements[3*e+1],s.view[4*e+2]=t.elements[3*e+2];this.needUpload=!0}}setMatrix3x3Array(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)for(let r=0;r<3;r++)s.view[16*e+4*r+0]=t[e].elements[3*r+0],s.view[16*e+4*r+1]=t[e].elements[3*r+1],s.view[16*e+4*r+2]=t[e].elements[3*r+2];this.needUpload=!0}}setMatrix4x4(e,t){const s=this._items.get(e);s&&(s.view.set(t.elements),this.needUpload=!0)}setMatrix4x4Array(e,t){const s=this._items.get(e);if(s){for(let e=0,r=Math.min(s.count,t.length);e<r;e++)s.view.set(t[e].elements,16*e);this.needUpload=!0}}setBuffer(e,t){this.setUniformData(e,t)}getUniform(e){return this._items.get(e)}hasUniform(e){return this._items.has(e)}isMe(e){return this._strId===e}upload(){this.needUpload&&(this.manager._useBigBuffer?this.bufferBlock.needUpload():this.bufferAlone.upload(),this.needUpload=!1)}clear(){this.manager._useBigBuffer?new Uint8Array(this.bufferBlock.cluster.data).fill(0,this.bufferBlock.offset,this.bufferBlock.offset+this.bufferBlock.size):new Uint8Array(this.bufferAlone.data).fill(0),this._strId="",this._items.clear(),this._itemNum=0,this.needUpload=!1}destroy(){return this.destroyed?(console.warn("UniformBufferUser: object alreay destroyed!"),!1):(this.manager._useBigBuffer?this.manager.freeBlock(this.bufferBlock):this.bufferAlone.destroy(),this.destroyed=!0,!0)}_getUniformItem(e,t,s,r,i,a,n,o){let l;return l=this.manager._useBigBuffer?new t(this.bufferBlock.cluster.data,this.bufferBlock.offset+r,a/t.BYTES_PER_ELEMENT):new t(this.bufferAlone.data,r,a/t.BYTES_PER_ELEMENT),{name:e,view:l,type:s,align:i,size:a,elements:n,count:o}}static _typeArray(e){return"int"===e?Int32Array:Float32Array}}e.BaseRenderType=void 0,(Kl=e.BaseRenderType||(e.BaseRenderType={}))[Kl.BaseRender=0]="BaseRender",Kl[Kl.MeshRender=1]="MeshRender",Kl[Kl.ParticleRender=2]="ParticleRender",Kl[Kl.TrailRender=3]="TrailRender",Kl[Kl.LineRender=4]="LineRender",Kl[Kl.TerrainRender=5]="TerrainRender",Kl[Kl.SkyRender=7]="SkyRender",Kl[Kl.SimpleSkinRender=8]="SimpleSkinRender",Kl[Kl.SkinnedMeshRender=9]="SkinnedMeshRender",e.ENodeCustomData=void 0,($l=e.ENodeCustomData||(e.ENodeCustomData={}))[$l.custom_0=0]="custom_0",$l[$l.custom_1=1]="custom_1",$l[$l.custom_2=2]="custom_2";class lh{static create(e,t,s){}constructor(e){this.blendType=0}}lh._blend_All_pool={},lh._blend_seperate_pool={};class hh{static getHash(e,t,s){return e+(t<<3)+(s<<7)}static getBlendComponent(e,t,s){let r=hh.getHash(e,t,s);return hh._pool[r]||(hh._pool[r]=new hh(e,t,s,r)),hh._pool[r]}constructor(e,t,s,r){this._hashIndex=0,this._hashIndex=r,this._blendOperationGLData=e,this._sourceBlendFactor=t,this._destinationFactor=s}}hh._pool={};class dh{get bufferUsage(){return this._bufferUsage}constructor(e,t){this._byteLength=0,this._bufferType=e,this._bufferUsage=t}destroy(){}}e.RenderClearFlag=void 0,(Ql=e.RenderClearFlag||(e.RenderClearFlag={}))[Ql.Nothing=0]="Nothing",Ql[Ql.Color=1]="Color",Ql[Ql.Depth=2]="Depth",Ql[Ql.Stencil=4]="Stencil",e.RenderDrawMode=void 0,(Zl=e.RenderDrawMode||(e.RenderDrawMode={}))[Zl.TRIANGLES=0]="TRIANGLES",Zl[Zl.POINTS=1]="POINTS",Zl[Zl.LINES=2]="LINES",e.RenderIndexMode=void 0,(Jl=e.RenderIndexMode||(e.RenderIndexMode={}))[Jl.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Jl[Jl.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Jl[Jl.UNSIGNED_INT=2]="UNSIGNED_INT",e.RenderStateType=void 0,(eh=e.RenderStateType||(e.RenderStateType={}))[eh.DepthTest=0]="DepthTest",eh[eh.DepthMask=1]="DepthMask",eh[eh.DepthFunc=2]="DepthFunc",eh[eh.StencilTest=3]="StencilTest",eh[eh.StencilMask=4]="StencilMask",eh[eh.StencilFunc=5]="StencilFunc",eh[eh.StencilOp=6]="StencilOp",eh[eh.BlendType=7]="BlendType",eh[eh.BlendEquation=8]="BlendEquation",eh[eh.BlendEquationSeparate=9]="BlendEquationSeparate",eh[eh.BlendFunc=10]="BlendFunc",eh[eh.BlendFuncSeperate=11]="BlendFuncSeperate",eh[eh.CullFace=12]="CullFace",eh[eh.FrontFace=13]="FrontFace",e.TextureCompareMode=void 0,(th=e.TextureCompareMode||(e.TextureCompareMode={}))[th.None=0]="None",th[th.LEQUAL=1]="LEQUAL",th[th.GEQUAL=2]="GEQUAL",th[th.LESS=3]="LESS",th[th.GREATER=4]="GREATER",th[th.EQUAL=5]="EQUAL",th[th.NOTEQUAL=6]="NOTEQUAL",th[th.ALWAYS=7]="ALWAYS",th[th.NEVER=8]="NEVER",e.TextureDecodeFormat=void 0,(sh=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[sh.Normal=0]="Normal",sh[sh.RGBM=1]="RGBM";class uh{static glslAttributeString(e){let t="";for(const s in e){let r=ch(e[s][1]);""!=r&&(t=`${t}attribute ${r} ${s};\n`)}return t}static glslUniformString(t,s,r){if(0==t.size)return"";if(s){let s="",i=`uniform ${r}{\n`,a=0;return t.forEach((t,r)=>{let n=t.uniformtype,o=t.propertyName;t.arrayLength>0&&(o=`${o}[${t.arrayLength}]`);let l=ch(n);""!=l&&(!function(t){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Float:case e.ShaderDataType.Vector2:case e.ShaderDataType.Vector3:case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:case e.ShaderDataType.Matrix4x4:case e.ShaderDataType.Matrix3x3:case e.ShaderDataType.Bool:return!0;default:return!1}}(n)?s+=`uniform ${l} ${o};\n`:(i+=`${l} ${o};\n`,a++))}),i+="};\n",a>0?i+s:s}{let e="";return t.forEach((t,s)=>{let r=t.uniformtype,i=t.propertyName;t.arrayLength;let a=ch(r);""!=a&&(e+=`uniform ${a} ${i};\n`)}),e}}static GLShaderLanguageProcess3D(s,r,i,a,n){var l,h,d=o.lightClusterCount,u={},c="";let _=t.matUseUBO,p=uh.glslAttributeString(r),g=uh.glslUniformString(i,_,"Material");f.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)>30?(-1===s.indexOf("GRAPHICS_API_GLES3")&&s.push("GRAPHICS_API_GLES3"),l=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${p}\n\n${g}\n`,h=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n\n${g}`):(l=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${p}\n${g}`,h=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${g}`),c+="#define MAX_LIGHT_COUNT "+o.maxLightCount+"\n",c+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+o._maxAreaLightCountPerClusterAverage+"\n",c+="#define CLUSTER_X_COUNT "+d.x+"\n",c+="#define CLUSTER_Y_COUNT "+d.y+"\n",c+="#define CLUSTER_Z_COUNT "+d.z+"\n",c+="#define MORPH_MAX_COUNT "+o.maxMorphTargetCount+"\n",c+="#define SHADER_CAPAILITY_LEVEL "+f.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var m=0,T=s.length;m<T;m++){var y=s[m];c+="#define "+y+"\n",u[y]=!0}var x=a.toscript(u,[]),S="";0==x[0].indexOf("#version")&&(S=x[0]+"\n",x.shift());var E=n.toscript(u,[]),v="";return 0==E[0].indexOf("#version")&&(v=E[0]+"\n",E.shift()),{vs:S+l+c+x.join("\n"),fs:v+h+c+E.join("\n")}}}function ch(t){switch(t){case e.ShaderDataType.Int:return"int";case e.ShaderDataType.Bool:return"bool";case e.ShaderDataType.Float:return"float";case e.ShaderDataType.Vector2:return"vec2";case e.ShaderDataType.Vector3:return"vec3";case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return"vec4";case e.ShaderDataType.Matrix4x4:return"mat4";case e.ShaderDataType.Matrix3x3:return"mat3";case e.ShaderDataType.Texture2D:return"sampler2D";case e.ShaderDataType.TextureCube:return"samplerCube";case e.ShaderDataType.Texture2DArray:return f.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler2DArray":"";case e.ShaderDataType.Texture3D:return f.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class _h{constructor(){this.onID=_h.pointID++,this.textureID=-1}}_h.pointID=0;class ph{constructor(e){this.items=e||{}}add(e,t,s){let r=e._owner._owner,i=r._subShaders.indexOf(e._owner),a=e._owner._passes.indexOf(e),n=e.nodeCommonMap?e.nodeCommonMap.slice().sort():[],o=e.additionShaderData?e.additionShaderData.slice().sort():[],l=e.moduleData.attributeLocations,h=l?Array.from(l):[],d=[];t=t.slice().filter(e=>{let t=gr._configDefineValues.has(gr.getDefineByName(e));return"GRAPHICS_API_GLES3"==e&&(t=!0),t&&d.push(e),!t}).sort();let u=this.items[r._name];u||(u=[],this.items[r._name]=u),u.some(e=>e.is2D===s&&e.subShaderIndex===i&&e.passIndex===a&&e.defines.length===t.length&&e.defines.every((e,s)=>e===t[s])&&e.nodeCommonMap.length===n.length&&e.nodeCommonMap.every((e,t)=>e===n[t])&&e.additionMap.length===o.length&&e.additionMap.every((e,t)=>e===o[t])&&e.attributeLocations.length===h.length&&e.attributeLocations.every((e,t)=>e===h[t]))||(u.push({is2D:s,subShaderIndex:i,passIndex:a,defines:t,nodeCommonMap:n,additionMap:o,attributeLocations:h}),console.debug(`Shader variant: ${r._name}/${i}/${a}/${t.join(",")}/${n?n.join(","):""}/${o?o.join(","):""}_${d.join(",")}`))}compileAll(){let e=this.items;for(let t in e){let s=e[t];for(let e of s){let s=gr.compileShaderByDefineNames(t,e.subShaderIndex,e.passIndex,e.defines,e.nodeCommonMap,e.additionMap,e.is2D,e.attributeLocations),r=`${t}/${e.subShaderIndex}/${e.passIndex}/${e.defines.join(",")}/${e.nodeCommonMap?e.nodeCommonMap.join(","):""}/${e.additionMap?e.additionMap.join(","):""}`;s?console.debug("Warm up",r):console.warn("Warm up failed!",r)}}}destroy(){this.items={}}}ph.active=new ph;class gh{static getVertexLayoutByPool(e){let t=gh._pool;for(var s in t){let r=t[s];if(r.deepthEqaul(e))return r}return new gh(e)}constructor(e){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let t=0;t<e.length;t++){let s=[],r=e[t].vertexDeclaration.vertexStride,i=e[t].vertexDeclaration._VAElements;for(let e=0;e<i.length;e++)s.push({format:i[e].format,stride:i[e].stride,shaderLocation:i[e].shaderLocation});this.attributeByteSize.push(r),this.VAElements.push(s),this.instanceMode.push(e[t].instanceBuffer)}this.id=gh.IPoint,gh._pool[gh.IPoint++]=this}deepthEqaul(e){if(e.length!=this.VAElements.length)return!1;for(var t=0;t<e.length;t++){let i=e[t]._vertexDeclaration._VAElements,a=this.VAElements[t];if(i.length!=a.length)return!1;for(var s=0,r=i.length;s<r;s++){let e=i[s],t=a[s];if(e.format!=t.format||e.stride!=t.stride||e.shaderLocation!=t.shaderLocation)return!1}}return!0}}gh.IPoint=0,gh._pool={};var mh={};class fh extends zl{get shaderV1(){return this._shaderV1}set shaderV1(e){e!=this._shaderV1&&e.cloneTo(this._shaderV1),this._mat&&this._mat.setVector4("u_strength_sig2_2sig2_gauss1",this._shaderV1),this._owner&&this._owner._onChangeRender()}constructor(e){super(),this._centerScale=new ct,this._shaderV1=new i,this._blurInfo=new ct,this._shaderV1=new i,this.strength=null!=e?e:4}effectInit(e){this._owner=e,!this._mat&&(this._mat=new Ba),this._mat.setShaderName("BlurEffect2D"),this._renderElement||(this._renderElement=f.render2DRenderPassFactory.createRenderElement2D(),this._renderElement.geometry=Ua.InvertQuadGeometry,this._renderElement.nodeCommonMap=null,this._renderElement.renderStateIsBySprite=!1,this._renderElement.materialShaderData=this._mat.shaderData,this._renderElement.subShader=this._mat.shader.getSubShaderAt(0)),this._mat.setVector4("u_strength_sig2_2sig2_gauss1",this._shaderV1),this._mat.setVector2("u_centerScale",this._centerScale),this._mat.lock=!0}render(e){let t=e.indirectTarget.width,s=e.indirectTarget.height,r=t+100,i=s+100;this._blurInfo.setValue(r,i),this._checkRenderTarget(r,i,e),this._centerScale.setValue(t/r,s/i),this._mat.setVector2("u_centerScale",this._centerScale),this._mat.setVector2("u_blurInfo",this._blurInfo),this._mat.setTexture("u_MainTex",e.indirectTarget),e.command.setRenderTarget(this._destRT,!0,y.CLEAR),e.command.drawRenderElement(this._renderElement,Ce.EMPTY),e.destination=this._destRT}_checkRenderTarget(t,s,r){this._destRT&&(this._destRT._inPool||this._destRT.destroyed||this._destRT.width!==t||this._destRT.height!==s)&&(zi.recoverToPool(this._destRT),this._destRT=null),this._destRT||(this._destRT=r.getRenderTexture(t,s,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None))}clearRT(e){this._destRT&&this._destRT!==e.destination&&(zi.recoverToPool(this._destRT),this._destRT=null)}get strength(){return this._strength}set strength(e){if(e==this._strength)return;this._strength=Math.max(Math.abs(e),2);var t=this._strength/3,s=t*t;let r=this._shaderV1.setValue(this.strength,s,2*s,1/(2*Math.PI*s)),i=0,a=Math.floor(10*this.strength);if(null!=mh[a])i=mh[a];else{for(let e=-4;e<=4;++e)for(let t=-4;t<=4;++t)i+=r.w*Math.exp(-(t*t+e*e)/r.z);mh[a]=i}r.w/=i,this.shaderV1=r}destroy(){var e;super.destroy(),this._destRT&&zi.recoverToPool(this._destRT),this._destRT=null,this._mat.destroy(),this._mat=null,null===(e=this._renderElement)||void 0===e||e.destroy(),this._renderElement=null}}Ee.regClass("BlurEffect2D",fh);const Th=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],yh=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],xh=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class Sh extends zl{constructor(e){super(),this._colorMat=new js,this._centerScale=new ct,this._alpha=new i,this._colorArray=new Float32Array(16),this._alphaArray=new Float32Array(4),this.setByMatrix(e||xh)}get colorMat(){return this._colorMat}set colorMat(e){e!=this._colorMat&&e.cloneTo(this._colorMat),this._mat&&this._mat.setMatrix4x4("u_colorMat",this.colorMat),this._owner&&this._owner._onChangeRender()}gray(){return this.setByMatrix(yh)}get alpha(){return this._alpha}set alpha(e){e!=this._alpha&&e.cloneTo(this._alpha),this._mat&&this._mat.setVector4("u_colorAlpha",this.alpha),this._owner&&this._owner._onChangeRender()}effectInit(e){this._owner=e,(!this._mat||this._mat.destroyed)&&(this._mat=new Ba),this._mat.setShaderName("ColorEffect2D"),this._mat.setMatrix4x4("u_colorMat",this._colorMat),this._mat.setVector4("u_colorAlpha",this._alpha),this._mat.addDefine(gr.getDefineByName("COLORFILTER")),this._centerScale.setValue(1,1),this._mat.setVector2("u_centerScale",this._centerScale),this._mat.lock=!0,this._renderElement||(this._renderElement=f.render2DRenderPassFactory.createRenderElement2D(),this._renderElement.geometry=Ua.InvertQuadGeometry,this._renderElement.nodeCommonMap=null,this._renderElement.renderStateIsBySprite=!1,this._renderElement.materialShaderData=this._mat.shaderData,this._renderElement.subShader=this._mat.shader.getSubShaderAt(0))}setByMatrix(e){if(this._matrix!=e){this._matrix||(this._matrix=[]);for(var t=0;t<25;t++)this._matrix[t]=e[t]}var s=0,r=0;for(t=0;t<20;t++)t%5!=4?this._colorArray[s++]=e[t]:this._alphaArray[r++]=e[t];return this.alpha.setValue(this._alphaArray[0],this._alphaArray[1],this._alphaArray[2],this._alphaArray[3]),this.alpha=this.alpha,js.TEMP.cloneByArray(this._colorArray),this.colorMat=js.TEMP,this}color(e=0,t=0,s=0,r=1){return this.setByMatrix([e,0,0,0,1,0,t,0,0,1,0,0,s,0,1,0,0,0,r,0])}setColor(e){return Eh.parse(e),this.color(Eh.r,Eh.g,Eh.b,1)}adjustColor(e,t,s,r){return this.adjustHue(r),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(s),this}adjustBrightness(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}adjustContrast(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,s=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?Th[e]:Th[e|0]*(1-t)+Th[1+(e|0)]*t)+127)/127,r=.5*(127-t);return this._multiplyMatrix([s,0,0,0,r,0,s,0,0,r,0,0,s,0,r,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),s=1-t,r=.3086*s,i=.6094*s,a=.082*s;return this._multiplyMatrix([r+t,i,a,0,0,r,i+t,a,0,0,r,i,a+t,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),s=Math.sin(e),r=.213,i=.715,a=.072;return this._multiplyMatrix([r+t*(1-r)+s*-r,i+t*-i+s*-i,a+t*-a+s*(1-a),0,0,r+t*-r+.143*s,i+t*(1-i)+.14*s,a+t*-a+-.283*s,0,0,r+t*-r+-.787*s,i+t*-i+s*i,a+t*(1-a)+s*a,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(xh)}_multiplyMatrix(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var s=0;s<5;s++){for(var r=0;r<5;r++)t[r]=this._matrix[r+5*s];for(r=0;r<5;r++){for(var i=0,a=0;a<5;a++)i+=e[r+5*a]*t[a];this._matrix[r+5*s]=i}}return this.setByMatrix(this._matrix)}_fixMatrix(e=null){return null==e?xh:(e.length<25?e=e.slice(0,e.length).concat(xh.slice(e.length,25)):e.length>25&&(e=e.slice(0,25)),e)}_clampValue(e,t){return Math.min(t,Math.max(-t,e))}render(e){this._checkRenderTarget(e.indirectTarget.width,e.indirectTarget.height,e),this._mat.setTexture("u_MainTex",e.indirectTarget),e.command.setRenderTarget(this._destRT,!0,y.CLEAR),e.command.drawRenderElement(this._renderElement,Ce.EMPTY),e.destination=this._destRT}_checkRenderTarget(t,s,r){this._destRT&&(this._destRT._inPool||this._destRT.destroyed||this._destRT.width!==t||this._destRT.height!==s)&&(zi.recoverToPool(this._destRT),this._destRT=null),this._destRT||(this._destRT=r.getRenderTexture(t,s,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None))}clearRT(e){this._destRT&&this._destRT!==e.destination&&(zi.recoverToPool(this._destRT),this._destRT=null)}onAfterDeserialize(){rl.hasProp("_color")&&this.setColor(this._color||"#ffffff"),rl.hasProp("_brightness","_contrast","_saturation","_hue")&&this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}destroy(){super.destroy(),this._destRT&&zi.recoverToPool(this._destRT),this._destRT=null,this._mat&&this._mat.destroy(),this._renderElement&&this._renderElement.destroy()}}const Eh=new y;Ee.regClass("ColorEffect2D",Sh);class vh extends Sh{constructor(){super(yh)}}Ee.regClass("GrayscaleEffect2D",vh);class Dh extends zl{get sv_blurInfo1(){return this._sv_blurInfo1}set sv_blurInfo1(e){e!==this._sv_blurInfo1&&e.cloneTo(this._sv_blurInfo1),this._glowMat&&this._glowMat.setVector4("u_blurInfo1",this._sv_blurInfo1),this._owner&&this._owner._onChangeRender()}get sv_blurInfo2(){return this._sv_blurInfo2}set sv_blurInfo2(e){e!==this._sv_blurInfo2&&e.cloneTo(this._sv_blurInfo2),this._glowMat&&this._glowMat.setVector4("u_blurInfo2",this._sv_blurInfo2),this._owner&&this._owner._onChangeRender()}get color(){return this._color}set color(e){this._color=e,this._colorVec.fromArray(ht.create(e).arrColor),this._glowMat&&this._glowMat.setVector4("u_color",this._colorVec),this._owner&&this._owner._onChangeRender()}get blur(){return this._sv_blurInfo1.y}set blur(e){this._sv_blurInfo1.x=this._sv_blurInfo1.y=e,this.sv_blurInfo1=this._sv_blurInfo1}get offsetY(){return this._sv_blurInfo1.w}set offsetY(e){e!==this._sv_blurInfo1.w&&(this._sv_blurInfo1.w=e,this.sv_blurInfo1=this._sv_blurInfo1)}get offsetX(){return this._sv_blurInfo1.z}set offsetX(e){e!==this._sv_blurInfo1.z&&(this._sv_blurInfo1.z=e,this.sv_blurInfo1=this._sv_blurInfo1)}constructor(e,t,s,r){super(),this._blitcenterScale=new ct,this._sv_blurInfo1=new i,this._sv_blurInfo2=new i(0,0,1,0),this._colorVec=new i,this.color=e||"#000",this.blur=null!=t?t:4,this.offsetX=null!=s?s:6,this.offsetY=null!=r?r:6}effectInit(e){this._owner=e,!this._blitmat&&(this._blitmat=new Ba),this._blitmat.setShaderName("ColorEffect2D"),this._blitElement||(this._blitElement=f.render2DRenderPassFactory.createRenderElement2D(),this._blitElement.geometry=Ua.InvertQuadGeometry,this._blitElement.nodeCommonMap=null,this._blitElement.renderStateIsBySprite=!1,this._blitElement.materialShaderData=this._blitmat.shaderData,this._blitElement.subShader=this._blitmat.shader.getSubShaderAt(0)),!this._glowMat&&(this._glowMat=new Ba),this._glowMat.setShaderName("glow2D"),this._glowMat.setVector4("u_color",this._colorVec),this._glowMat.setVector4("u_blurInfo1",this.sv_blurInfo1),this._glowMat.lock=!0,this._glowElement||(this._glowElement=f.render2DRenderPassFactory.createRenderElement2D(),this._glowElement.geometry=Ua.InvertQuadGeometry,this._glowElement.nodeCommonMap=null,this._glowElement.renderStateIsBySprite=!1,this._glowElement.materialShaderData=this._glowMat.shaderData,this._glowElement.subShader=this._glowMat.shader.getSubShaderAt(0)),!this._compositeMat&&(this._compositeMat=new Ba),this._compositeMat.setShaderName("ColorEffect2D"),this._compositeElement||(this._compositeElement=f.render2DRenderPassFactory.createRenderElement2D(),this._compositeElement.geometry=Ua.InvertQuadGeometry,this._compositeElement.nodeCommonMap=null,this._compositeElement.renderStateIsBySprite=!1,this._compositeElement.materialShaderData=this._compositeMat.shaderData,this._compositeElement.subShader=this._compositeMat.shader.getSubShaderAt(0))}render(e){let t=e.indirectTarget.width,s=e.indirectTarget.height,r=t+100,i=s+100;this._checkRenderTarget(r,i,e),this._blitmat.setTexture("u_MainTex",e.indirectTarget),this._blitcenterScale.setValue(t/r,s/i),this._blitmat.setVector2("u_centerScale",this._blitcenterScale),e.command.setRenderTarget(this._blitExtendRT,!0,y.CLEAR),e.command.drawRenderElement(this._blitElement,Ce.EMPTY),this._glowMat.setVector2("u_centerScale",ct.ONE),this._glowMat.setTexture("u_MainTex",this._blitExtendRT),this._sv_blurInfo2.x=t,this._sv_blurInfo2.y=s,this._glowMat.setVector4("u_blurInfo2",this._sv_blurInfo2),e.command.setRenderTarget(this._destRT,!0,y.CLEAR),e.command.drawRenderElement(this._glowElement,Ce.EMPTY),this._compositeMat.setTexture("u_MainTex",this._blitExtendRT),this._compositeMat.setVector2("u_centerScale",ct.ONE),e.command.drawRenderElement(this._compositeElement,Ce.EMPTY),e.destination=this._destRT}_checkRenderTarget(t,s,r){this._destRT&&(this._destRT._inPool||this._destRT.destroyed||this._destRT.width!==t||this._destRT.height!==s)&&(zi.recoverToPool(this._destRT),this._destRT=null),this._blitExtendRT&&(this._blitExtendRT._inPool||this._blitExtendRT.destroyed||this._blitExtendRT.width!==t||this._blitExtendRT.height!==s)&&(zi.recoverToPool(this._blitExtendRT),this._blitExtendRT=null),this._destRT||(this._destRT=r.getRenderTexture(t,s,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)),this._blitExtendRT||(this._blitExtendRT=r.getRenderTexture(t,s,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None))}clearRT(e){this._blitExtendRT&&this._blitExtendRT!==e.destination&&(zi.recoverToPool(this._blitExtendRT),this._blitExtendRT=null),this._destRT&&this._destRT!==e.destination&&(zi.recoverToPool(this._destRT),this._destRT=null)}destroy(){super.destroy(),this._destRT&&zi.recoverToPool(this._destRT),this._destRT=null,this._blitExtendRT&&zi.recoverToPool(this._blitExtendRT),this._blitExtendRT=null,this._blitmat&&this._blitmat.destroy(),this._blitmat=null,this._blitElement&&this._blitElement.destroy(),this._blitElement=null,this._glowMat&&this._glowMat.destroy(),this._glowMat=null,this._glowElement&&this._glowElement.destroy(),this._glowElement=null,this._compositeMat&&this._compositeMat.destroy(),this._compositeMat=null,this._compositeElement&&this._compositeElement.destroy(),this._compositeElement=null}}Ee.regClass("GlowEffect2D",Dh);class wh{onPopulateMesh(e){let t=e.contentRect;const s=t.width/2,r=t.height/2;let i=Math.ceil(Math.PI*(s+r)/4);i=ut.clamp(i,40,800);const a=2*Math.PI/i;let n=0;const o=t.x+s,l=t.y+r;e.addVert(o,l);for(let t=0;t<i;t++){let t=Math.cos(n)*s+o,i=Math.sin(n)*r+l;e.addVert(t,i),n+=a}for(let t=0;t<i;t++)t!=i-1?e.addTriangle(0,t+1,t+2):e.addTriangle(0,t+1,1)}}Ee.regClass("CircleMesh",wh);class bh{constructor(){this.flipX=!0,this.flipY=!1}onPopulateMesh(e){var t;const s=te.create();let r=s.copyFrom(e.uvRect);if(this.flipX){let e=r.x;r.x=r.right,r.right=e}if(this.flipY){let e=r.y;r.y=r.bottom,r.bottom=e}let i=null===(t=e.mainTex)||void 0===t?void 0:t._sizeGrid;if(i){let t=te.create(),s=e.mainTex.sourceWidth,a=e.mainTex.sourceHeight;t.setTo(i[3],i[0],s-i[1]-i[3],a-i[0]-i[2]),this.flipX&&(t.x=s-t.right),this.flipY&&(t.y=a-t.bottom),ot(e,e.contentRect,r,t,1===i[4]?255:0)}else e.addQuad(e.contentRect,null,r),e.triangulateQuad(0);s.recover()}}var Ch,Rh;Ee.regClass("FlipMesh",bh),e.FillMethod=void 0,(Ch=e.FillMethod||(e.FillMethod={}))[Ch.None=0]="None",Ch[Ch.Horizontal=1]="Horizontal",Ch[Ch.Vertical=2]="Vertical",Ch[Ch.Radial90=3]="Radial90",Ch[Ch.Radial180=4]="Radial180",Ch[Ch.Radial360=5]="Radial360",e.FillOrigin=void 0,(Rh=e.FillOrigin||(e.FillOrigin={}))[Rh.Top=0]="Top",Rh[Rh.Bottom=1]="Bottom",Rh[Rh.Left=2]="Left",Rh[Rh.Right=3]="Right",Rh[Rh.TopLeft=0]="TopLeft",Rh[Rh.TopRight=1]="TopRight",Rh[Rh.BottomLeft=2]="BottomLeft",Rh[Rh.BottomRight=3]="BottomRight";class Mh{constructor(){this.origin=0,this.amount=.6,this.clockwise=!0,this._method=5}get method(){return this._method}set method(t){this._method!=t&&(this._method=t,!p.isPlaying&&(t===e.FillMethod.Horizontal||t===e.FillMethod.Vertical)&&this.origin>1&&(this.origin=0))}onPopulateMesh(t){let s=ut.clamp01(this.amount);switch(this.method){case e.FillMethod.Horizontal:!function(t,s,r,i){const a=te.create();let n=a.copyFrom(s),o=n.width*i;r!==e.FillOrigin.Right&&r!==e.FillOrigin.Bottom||(n.x+=n.width-o);n.width=o,t.addQuad(n),t.triangulateQuad(0),a.recover()}(t,t.contentRect,this.origin,s);break;case e.FillMethod.Vertical:!function(t,s,r,i){const a=te.create();let n=a.copyFrom(s),o=n.height*i;r!==e.FillOrigin.Right&&r!==e.FillOrigin.Bottom||(n.y+=n.height-o);n.height=o,t.addQuad(n),t.triangulateQuad(0),a.recover()}(t,t.contentRect,this.origin,s);break;case e.FillMethod.Radial90:Ah(t,t.contentRect,this.origin,s,this.clockwise);break;case e.FillMethod.Radial180:Ih(t,t.contentRect,this.origin,s,this.clockwise);break;case e.FillMethod.Radial360:!function(t,s,r,i,a){const n=te.create();let o=n.copyFrom(s);switch(r){case e.FillOrigin.Top:if(i<.5){o.width/=2,a&&(o.x+=o.width),Ih(t,o,a?e.FillOrigin.Left:e.FillOrigin.Right,i/.5,a);let s=t.getPos(-8);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.width/=2,a||(o.x+=o.width),Ih(t,o,a?e.FillOrigin.Right:e.FillOrigin.Left,(i-.5)/.5,a),a?o.x+=o.width:o.x-=o.width,t.addQuad(o),t.triangulateQuad(-4);break;case e.FillOrigin.Bottom:if(i<.5){o.width/=2,a||(o.x+=o.width),Ih(t,o,a?e.FillOrigin.Right:e.FillOrigin.Left,i/.5,a);let s=t.getPos(-8);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.width/=2,a&&(o.x+=o.width),Ih(t,o,a?e.FillOrigin.Left:e.FillOrigin.Right,(i-.5)/.5,a),a?o.x-=o.width:o.x+=o.width,t.addQuad(o),t.triangulateQuad(-4);break;case e.FillOrigin.Left:if(i<.5){o.height/=2,a||(o.y+=o.height),Ih(t,o,a?e.FillOrigin.Bottom:e.FillOrigin.Top,i/.5,a);let s=t.getPos(-8);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.height/=2,a&&(o.y+=o.height),Ih(t,o,a?e.FillOrigin.Top:e.FillOrigin.Bottom,(i-.5)/.5,a),a?o.y-=o.height:o.y+=o.height,t.addQuad(o),t.triangulateQuad(-4);break;case e.FillOrigin.Right:if(i<.5){o.height/=2,a&&(o.y+=o.height),Ih(t,o,a?e.FillOrigin.Top:e.FillOrigin.Bottom,i/.5,a);let s=t.getPos(-8);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.height/=2,a||(o.y+=o.height),Ih(t,o,a?e.FillOrigin.Bottom:e.FillOrigin.Top,(i-.5)/.5,a),a?o.y+=o.height:o.y-=o.height,t.addQuad(o),t.triangulateQuad(-4)}n.recover()}(t,t.contentRect,this.origin,s,this.clockwise);break;default:t.addQuad(t.contentRect),t.triangulateQuad(0)}}}function Ah(t,s,r,i,a){let n=r===e.FillOrigin.TopRight||r===e.FillOrigin.BottomRight,o=r===e.FillOrigin.BottomLeft||r===e.FillOrigin.BottomRight;n!==o&&(a=!a);let l=a?i:1-i,h=Math.tan(.5*Math.PI*l),d=!1;1!==l&&(d=s.height/s.width-h>0),a||(d=!d);let u=s.x+(0===l?Number.MAX_VALUE:s.height/h),c=s.y+(1===l?Number.MAX_VALUE:s.width*h),_=u,p=c;n&&(_=s.width-u),o&&(p=s.height-c);let g=n?s.width-s.x:s.x,m=o?s.height-s.y:s.y,f=n?-s.x:s.right,T=o?-s.y:s.bottom;t.addVert(g,m),a&&t.addVert(f,m),c>s.bottom?d?t.addVert(_,T):t.addVert(f,T):t.addVert(f,p),u>s.right?d?t.addVert(f,p):t.addVert(f,T):t.addVert(_,T),a||t.addVert(g,T),n===o?(t.addTriangle(0,1,2),t.addTriangle(0,2,3)):(t.addTriangle(2,1,0),t.addTriangle(3,2,0))}function Ih(t,s,r,i,a){const n=te.create();let o=n.copyFrom(s);switch(r){case e.FillOrigin.Top:if(i<=.5){o.width/=2,a&&(o.x+=o.width),Ah(t,o,a?e.FillOrigin.TopLeft:e.FillOrigin.TopRight,i/.5,a);let s=t.getPos(-4);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.width/=2,a||(o.x+=o.width),Ah(t,o,a?e.FillOrigin.TopRight:e.FillOrigin.TopLeft,(i-.5)/.5,a),a?o.x+=o.width:o.x-=o.width,t.addQuad(o),t.triangulateQuad(-4);break;case e.FillOrigin.Bottom:if(i<=.5){o.width/=2,a||(o.x+=o.width),Ah(t,o,a?e.FillOrigin.BottomRight:e.FillOrigin.BottomLeft,i/.5,a);let s=t.getPos(-4);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.width/=2,a&&(o.x+=o.width),Ah(t,o,a?e.FillOrigin.BottomLeft:e.FillOrigin.BottomRight,(i-.5)/.5,a),a?o.x-=o.width:o.x+=o.width,t.addQuad(o),t.triangulateQuad(-4);break;case e.FillOrigin.Left:if(i<=.5){o.height/=2,a||(o.y+=o.height),Ah(t,o,a?e.FillOrigin.BottomLeft:e.FillOrigin.TopLeft,i/.5,a);let s=t.getPos(-4);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.height/=2,a&&(o.y+=o.height),Ah(t,o,a?e.FillOrigin.TopLeft:e.FillOrigin.BottomLeft,(i-.5)/.5,a),a?o.y-=o.height:o.y+=o.height,t.addQuad(o),t.triangulateQuad(-4);break;case e.FillOrigin.Right:if(i<=.5){o.height/=2,a&&(o.y+=o.height),Ah(t,o,a?e.FillOrigin.TopRight:e.FillOrigin.BottomRight,i/.5,a);let s=t.getPos(-4);t.addQuad(te.TEMP.setTo(s.x,s.y,0,0)),t.triangulateQuad(-4)}else o.height/=2,a||(o.y+=o.height),Ah(t,o,a?e.FillOrigin.BottomRight:e.FillOrigin.TopRight,(i-.5)/.5,a),a?o.y+=o.height:o.y-=o.height,t.addQuad(o),t.triangulateQuad(-4)}n.recover()}Ee.regClass("ProgressMesh",Mh);class Ph{constructor(){this.sides=6,this.distances=[],this.rotation=0,this.lineWidth=0,this.lineColor=null,this.centerColor=null,this.fillColor=null}onPopulateMesh(e){var t;let s=this.fillColor||e.color,i=this.lineColor||e.color;const a=2*Math.PI/this.sides;let n=this.rotation*r.Deg2Rad;const o=Math.min(e.contentRect.width/2,e.contentRect.height/2),l=this.lineWidth,h=o+e.contentRect.x,d=o+e.contentRect.y;e.addVert(h,d,this.centerColor||s);for(let r=0;r<this.sides;r++){let u=o;null!=this.distances&&(u*=null!==(t=this.distances[r])&&void 0!==t?t:1);let c=h+Math.cos(n)*(u-l),_=d+Math.sin(n)*(u-l);e.addVert(c,_,s),l>0&&(e.addVert(c,_,i),e.addVert(Math.cos(n)*u+h,Math.sin(n)*u+d,i)),n+=a}if(l>0){let t=3*this.sides;for(let s=0;s<t;s+=3)s!=t-3?(e.addTriangle(0,s+1,s+4),e.addTriangle(s+5,s+2,s+3),e.addTriangle(s+3,s+6,s+5)):(e.addTriangle(0,s+1,1),e.addTriangle(2,s+2,s+3),e.addTriangle(s+3,3,2))}else for(let t=0;t<this.sides;t++)e.addTriangle(0,t+1,t===this.sides-1?1:t+2)}}Ee.regClass("RegularPolygonMesh",Ph);class Bh{constructor(){this.lt=6,this.rt=6,this.lb=6,this.rb=6}onPopulateMesh(e){let t=e.contentRect.x,s=e.contentRect.y,r=e.contentRect.width,i=e.contentRect.height,a=r/2,n=i/2,o=Math.min(a,n),l=t+a,h=s+n;e.addVert(l,h);let d=e.vertCount;for(let a=0;a<4;a++){let n=0;switch(a){case 0:n=this.rb;break;case 1:n=this.lb;break;case 2:n=this.lt;break;case 3:n=this.rt}n=Math.min(o,n);let l=0,h=0;if(0!==a&&3!==a||(l=r-2*n),0!==a&&1!==a||(h=i-2*n),l+=t,h+=s,0!==n){let t=Math.max(1,Math.ceil(Math.PI*n/8))+1,s=Math.PI/2/t,r=Math.PI/2*a,i=r;for(let a=1;a<=t;a++)a===t&&(r=i+Math.PI/2),e.addVert(l+Math.cos(r)*n+n,h+Math.sin(r)*n+n),r+=s}else e.addVert(l,h)}d=e.vertCount-d;for(let t=0;t<d;t++)e.addTriangle(0,t+1,t===d-1?1:t+2)}}Ee.regClass("RoundedRectMesh",Bh);class Lh{constructor(){this.repeatX=!0,this.repeatY=!0}onPopulateMesh(t){let s=t.mainTex;if(null!=s&&0==t.uvRect.x&&0==t.uvRect.y&&1==t.uvRect.width&&1==t.uvRect.height&&s.bitmap.wrapModeU==e.WrapMode.Repeat&&s.bitmap.wrapModeV==e.WrapMode.Repeat){let e=te.create();e.copyFrom(t.uvRect),this.repeatX&&(e.width*=t.contentRect.width/s.width),this.repeatY&&(e.height*=t.contentRect.height/s.height),t.addQuad(t.contentRect,null,e),t.triangulateQuad(0),e.recover()}else lt(t,t.contentRect,t.uvRect,s?s.sourceWidth:t.contentRect.width,s?s.sourceHeight:t.contentRect.height,this.repeatX,this.repeatY)}}Ee.regClass("TileMesh",Lh);class Nh extends fa{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=he.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat(this.repeat)}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class Fh{}Fh.STANDARD=0,Fh.LEFT=1,Fh.RIGHT=2,Fh.NUM_PAD=3;class Oh{}Oh.NUMBER_0=48,Oh.NUMBER_1=49,Oh.NUMBER_2=50,Oh.NUMBER_3=51,Oh.NUMBER_4=52,Oh.NUMBER_5=53,Oh.NUMBER_6=54,Oh.NUMBER_7=55,Oh.NUMBER_8=56,Oh.NUMBER_9=57,Oh.A=65,Oh.B=66,Oh.C=67,Oh.D=68,Oh.E=69,Oh.F=70,Oh.G=71,Oh.H=72,Oh.I=73,Oh.J=74,Oh.K=75,Oh.L=76,Oh.M=77,Oh.N=78,Oh.O=79,Oh.P=80,Oh.Q=81,Oh.R=82,Oh.S=83,Oh.T=84,Oh.U=85,Oh.V=86,Oh.W=87,Oh.X=88,Oh.Y=89,Oh.Z=90,Oh.F1=112,Oh.F2=113,Oh.F3=114,Oh.F4=115,Oh.F5=116,Oh.F6=117,Oh.F7=118,Oh.F8=119,Oh.F9=120,Oh.F10=121,Oh.F11=122,Oh.F12=123,Oh.F13=124,Oh.F14=125,Oh.F15=126,Oh.NUMPAD=21,Oh.NUMPAD_0=96,Oh.NUMPAD_1=97,Oh.NUMPAD_2=98,Oh.NUMPAD_3=99,Oh.NUMPAD_4=100,Oh.NUMPAD_5=101,Oh.NUMPAD_6=102,Oh.NUMPAD_7=103,Oh.NUMPAD_8=104,Oh.NUMPAD_9=105,Oh.NUMPAD_ADD=107,Oh.NUMPAD_DECIMAL=110,Oh.NUMPAD_DIVIDE=111,Oh.NUMPAD_ENTER=108,Oh.NUMPAD_MULTIPLY=106,Oh.NUMPAD_SUBTRACT=109,Oh.SEMICOLON=186,Oh.EQUAL=187,Oh.COMMA=188,Oh.MINUS=189,Oh.PERIOD=190,Oh.SLASH=191,Oh.BACKQUOTE=192,Oh.LEFTBRACKET=219,Oh.BACKSLASH=220,Oh.RIGHTBRACKET=221,Oh.QUOTE=222,Oh.ALTERNATE=18,Oh.BACKSPACE=8,Oh.CAPS_LOCK=20,Oh.COMMAND=15,Oh.CONTROL=17,Oh.DELETE=46,Oh.ENTER=13,Oh.ESCAPE=27,Oh.PAGE_UP=33,Oh.PAGE_DOWN=34,Oh.END=35,Oh.HOME=36,Oh.LEFT=37,Oh.UP=38,Oh.RIGHT=39,Oh.DOWN=40,Oh.SHIFT=16,Oh.SPACE=32,Oh.TAB=9,Oh.INSERT=45;class Uh extends N{onChange(){this.event(c.CHANGED)}}class kh extends Uh{getEffect(){return this._effect2D}constructor(e=4){super(),this._effect2D=new fh(e)}get strength(){return this._effect2D.strength}set strength(e){this._effect2D.strength=e,this.onChange()}}Ee.regClass("BlurFilter",kh);class Vh extends Uh{getEffect(){return this._effect2D}constructor(e=null){super(),this._effect2D=new Sh(e)}gray(){return this._effect2D.gray(),this}color(e=0,t=0,s=0,r=1){return this._effect2D.color(e,t,s,r),this}setColor(e){return this._effect2D.setColor(e),this}setByMatrix(e){return this._effect2D.setByMatrix(e),this.onChange(),this}adjustColor(e,t,s,r){return this._effect2D.adjustColor(e,t,s,r),this}adjustBrightness(e){return this._effect2D.adjustBrightness(e),this}adjustContrast(e){return this._effect2D.adjustContrast(e),this}adjustSaturation(e){return this._effect2D.adjustSaturation(e),this}adjustHue(e){return this._effect2D.adjustHue(e),this}reset(){return this._effect2D.reset(),this}onAfterDeserialize(){rl.hasProp("_color")&&this.setColor(this._color),rl.hasProp("_brightness","_contrast","_saturation","_hue")&&this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}Ee.regClass("ColorFilter",Vh);class Gh extends Uh{constructor(e,t=4,s=6,r=6){super(),this._effect2D=new Dh(e,t,s,r)}getEffect(){return this._effect2D}get offY(){return this._effect2D.offsetY}set offY(e){this._effect2D.offsetY=e,this.onChange()}get offX(){return this._effect2D.offsetX}set offX(e){this._effect2D.offsetX=e,this.onChange()}get color(){return this._effect2D.color}set color(e){this._effect2D.color=e,this.onChange()}get blur(){return this._effect2D.blur}set blur(e){this._effect2D.blur=e,this.onChange()}}Ee.regClass("GlowFilter",Gh);class zh extends Ul{cloneTo(e){super.cloneTo(e),e.value=this.value}clone(){let e=new zh;return this.cloneTo(e),e}}class Hh{constructor(e,t,s,r){this.minDepth=0,this.maxDepth=1,this.x=null!=e?e:0,this.y=null!=t?t:0,this.width=null!=s?s:0,this.height=null!=r?r:0}project(e,t,s){a.transformV3ToV4(e,t,s);var r=s.x,i=s.y,n=s.z,o=s.w;1!==o&&(r/=o,i/=o,n/=o),s.x=.5*(r+1)*this.width+this.x,s.y=.5*(1-i)*this.height+this.y,s.z=n*(this.maxDepth-this.minDepth)+this.minDepth}unprojectFromMat(e,t,s){var r=t.elements;s.x=(e.x-this.x)/this.width*2-1,s.y=-((e.y-this.y)/this.height*2-1),s.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var i=s.x*r[3]+s.y*r[7]+s.z*r[11]+r[15];a.transformV3ToV3(s,t,s),1!==i&&(s.x=s.x/i,s.y=s.y/i,s.z=s.z/i)}unprojectFromWVP(e,t,s,r,i){js.multiply(t,s,Wh),r&&js.multiply(Wh,r,Wh),Wh.invert(Wh),this.unprojectFromMat(e,Wh,i)}set(e,t,s,r){this.x=e,this.y=t,this.width=s,this.height=r}cloneTo(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}Hh.TEMP=new Hh(0,0,0,0);const Wh=new js;class Xh{constructor(){this._size=0,this._lastCheck=0,this._items={}}add(e,s,r){this._items[e]&&(this._size-=this._items[e].size);let i=performance.now();if(this._items[e]={obj:s,size:r,time:i},this._size+=r,this._size>t.audioBufferCacheMaxSize&&i-this._lastCheck>1e4){this._lastCheck=i;for(let e in this._items){let t=this._items[e];i-t.time>3e4&&(this._size-=t.size,delete this._items[e],console.debug("AudioDataCache: remove "+e))}}}get(e,t,s){let r=this._items[e];if(null!=r)return r.time=performance.now(),void t.call(s,r.obj);l.loader.load(e,{type:Te.SOUND,cache:!1}).then(r=>{r&&this.add(e,r,r.__byteLength),t.call(s,r)})}}class Yh extends N{constructor(e){super(),this.playbackRate=1,this._started=!1,this._paused=!1,this._loaded=!1,this._completed=!1,this._repeated=0,this._volumeSet=1,this._volume=1,this._muted=!1,this._startTime=0,this._pauseTime=0,this._isMusic=!1,this._autoResume=!1,this.url=e}get volume(){return this._volumeSet}set volume(e){this._volumeSet=e;let t=e*(this._isMusic?xn.musicVolume:xn.soundVolume);t!==this._volume&&(this._volume=t,this._loaded&&this.onVolumeChanged())}get muted(){return this._muted}set muted(e){e=!!e,this._muted!=e&&(this._muted=e,this._loaded&&this.onMuted())}get position(){return this._paused?this._pauseTime:0!=this._startTime?(performance.now()-this._startTime)/1e3+this.startTime:this.startTime}get duration(){return 0}get paused(){return this._paused}get isStopped(){return!this._started}play(){this._started?this._paused&&this.resume():(this._started=!0,this._loaded=!1,this._completed=!1,this._repeated=0,this._startTime=performance.now(),xn.addChannel(this),J.inst.resolveURL(this.url,e=>{this._started&&(e?this.onPlay(e):this.stop())}))}stop(){this._started&&(this._started=!1,this._loaded=!1,xn.removeChannel(this),this.onStop(),this.callComplete(this._completed))}pause(){this._started&&!this._paused&&(this._pauseTime=this.position,this._paused=!0,this._autoResume=!1,this._loaded&&this.onPause())}resume(){this._started&&this._paused&&(this._paused=!1,this._loaded&&this.onResume())}onPlay(e){}onPlayAgain(){}onStop(){}onPause(){}onResume(){}onVolumeChanged(){}onMuted(){}onPlayEnd(){this._repeated++,this.loops>0&&this._repeated>=this.loops?(this._completed=!0,this.stop()):this.onPlayAgain()}callComplete(e){if(e&&this.event(c.COMPLETE),!this.completeHandler)return;let t=this.completeHandler;this.completeHandler=null,t instanceof he?t.runWith(null==e||e):t(null==e||e)}}class qh extends Yh{get position(){return this._ele?this._ele.currentTime:0}get duration(){return this._ele?this._ele.duration:0}onPlay(e){this._ele=qh.elementPool.take(),Y.container.appendChild(this._ele),this._loaded=!0;let t=this._ele;if(t.onerror=e=>{console.error("HTMLAudioChannel: ",e),this.stop()},t.onended=()=>this.onPlayEnd(),t.src=ee.postFormatURL(ee.formatURL(e)),t.playbackRate=this.playbackRate,t.currentTime=this.startTime,t.loop=0===this.loops,t.volume=this._volume,t.muted=this._muted,!this._paused){if(t.readyState>0&&!t.paused)return;Promise.resolve().then(()=>{this._ele&&this._ele.play().catch(e=>{"NotAllowedError"===e.name&&this._isMusic?W.media.resumeUntilGotFocus(this):console.warn(e)})})}}onPlayAgain(){this._ele.currentTime=this.startTime,this._ele.play().catch(e=>{})}onStop(){this._ele.pause(),qh.elementPool.recover(this._ele),this._ele=null}onPause(){this._ele.pause()}onResume(){0===this._ele.readyState&&this._ele.load(),this._ele.play().catch(e=>{})}onVolumeChanged(){this._ele.volume=this._volume}onMuted(){this._ele.muted=this._muted}}qh.elementPool=h.createPool2(()=>Y.createElement("audio"),null,e=>function(e){e.remove(),e.src="",e.onended=null,e.onerror=null,e.oncanplay=null,e.oncanplaythrough=null}(e));class jh{constructor(){this.options={},this.allowBackground=!1,this._playing=!1,this._loaded=!1,this._autoResume=!1}get currentTime(){return 0}set currentTime(e){}get volume(){return 0}set volume(e){}get muted(){return!1}set muted(e){}get duration(){return 0}get ended(){return!1}get loop(){return!1}set loop(e){}get playbackRate(){return 1}set playbackRate(e){}get paused(){return!1}attachTo(e){this._owner&&(this._owner.off(c.TRANSFORM_CHANGED,this,this.onTransformChanged),l.stage.off(c.RESIZE,this,this.onTransformChanged)),this._owner=e,this._owner&&(this._owner.on(c.TRANSFORM_CHANGED,this,this.onTransformChanged),l.stage.on(c.RESIZE,this,this.onTransformChanged))}load(e){e&&J.inst.resolveURL(e,e=>this.onLoad(e))}play(){!this._playing&&p.isPlaying&&(this._playing=!0,l.stage.on(c.BLUR,this,this.onBlur),this._loaded&&this.onPlay())}pause(){this._autoResume=!1,this._playing&&(this._playing=!1,l.stage.off(c.BLUR,this,this.onBlur),this._loaded&&this.onPause())}resume(){this.play()}setLoaded(){this._loaded=!0,this.onTransformChanged(),this._playing&&this.onPlay()}getNodeTransform(){let e;return Y.onTTMiniGame?(e=pa.getGlobalPosAndScale(this._owner),e.x*=l.stage.clientScaleX,e.y*=l.stage.clientScaleY,e.scaleX*=l.stage.clientScaleX,e.scaleY*=l.stage.clientScaleY):e=pa.getTransformRelativeToWindow(this._owner,0,0),{x:e.x,y:e.y,width:Math.round(this._owner.width*e.scaleX),height:Math.round(this._owner.height*e.scaleY)}}onTransformChanged(){}destroy(){this.onDestroy(),this.attachTo(null),l.stage.off(c.BLUR,this,this.onBlur)}onBlur(){this.allowBackground||W.media.resumeUntilGotFocus(this)}onLoad(e){}onPlay(){}onPause(){}onDestroy(){}}class Kh extends jh{constructor(){super(),this.element=Kh.createElement()}get currentTime(){return this.element.currentTime}set currentTime(e){this.element.currentTime=e}get volume(){return this.element.volume}set volume(e){this.element.volume=e}get readyState(){return this.element.readyState}get duration(){return this.element.duration}get ended(){return this.element.ended}get loop(){return this.element.loop}set loop(e){this.element.loop=e}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element.playbackRate=e}get muted(){return this.element.muted}set muted(e){this.element.muted=e}onLoad(e){var t;if(this.element.controls=null!==(t=this.options.controls)&&void 0!==t&&t,Kh.setSrc(this.element,e),this.options.underGameView){let e=Y.container;e!==Y.document.body?Y.document.body.insertBefore(this.element,e):Y.document.body.appendChild(this.element)}else Y.document.body.appendChild(this.element);this.onTransformChanged(),this.setLoaded()}onPlay(){this.element.play().catch(e=>{"NotAllowedError"===e.name?W.media.resumeUntilGotFocus(this):console.warn(e)})}onPause(){this.element.pause()}onTransformChanged(){let{x:e,y:t,width:s,height:r}=this.getNodeTransform(),i=this.element.style;i.left=e+"px",i.top=t+"px",i.width=s+"px",i.height=r+"px",W.browser.setStyleTransform(i,"rotate("+l.stage.canvasDegree+"deg)")}onDestroy(){Kh.setSrc(this.element,null),this.element.remove()}static createElement(){let e=Y.createElement("video"),t=e.style;return t.position="absolute",t.top="0px",t.left="0px",W.browser.setStyleTransformOrigin(t,"0 0"),e.setAttribute("crossorigin","anonymous"),Y.onMobile&&(e["x5-playsInline"]=!0,e["x5-playsinline"]=!0,e.x5PlaysInline=!0,e.playsInline=!0,e["webkit-playsInline"]=!0,e["webkit-playsinline"]=!0,e.webkitPlaysInline=!0,e.playsinline=!0,e.style.playsInline=!0,e.crossOrigin="anonymous",e.setAttribute("playsinline","true"),e.setAttribute("x5-playsinline","true"),e.setAttribute("webkit-playsinline","true"),e.autoplay=!0),e}static setSrc(e,t){for(;e.childElementCount;)e.firstChild.remove();if(t)if(t.startsWith("blob:"))e.src=t;else{let s=Y.createElement("source");s.src=ee.postFormatURL(ee.formatURL(t));let r=Q.getFileExtension(t);s.type="m3u8"==r?"application/vnd.apple.mpegurl":"video/"+r,e.appendChild(s)}else e.pause(),e.src=""}}class $h extends ml{constructor(){super(),this._needUpdate=!0,this._hasRequestVideoFrame=!1;let e=this.element=Kh.createElement();if(e.addEventListener("loadedmetadata",()=>this.setLoaded(this.element.videoWidth,this.element.videoHeight,Y.onLayaRuntime)),e.addEventListener("canplay",()=>{this._playing||this.render(!0)}),e.addEventListener("ended",()=>{this.event("ended")}),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const t=this;function s(){t._needUpdate=!0,e.requestVideoFrameCallback(s)}e.requestVideoFrameCallback(s),this._hasRequestVideoFrame=!0}}get currentTime(){return this.element.currentTime}set currentTime(e){this.element.currentTime=e,!this._playing&&this._loaded&&this.render()}get volume(){return this.element.volume}set volume(e){this.element.volume=e}get readyState(){return this.element.readyState}get duration(){return this.element.duration}get ended(){return this.element.ended}get loop(){return this.element.loop}set loop(e){this.element.loop=e}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element.playbackRate=e}get muted(){return this.element.muted}set muted(e){this.element.muted=e}onLoad(e){Kh.setSrc(this.element,e),this.element.load()}onPlay(){this.element.play().catch(e=>{"NotAllowedError"===e.name?W.media.resumeUntilGotFocus(this):console.warn(e)})}onPause(){this.element.pause()}onRender(){return!(this._hasRequestVideoFrame&&!this._needUpdate)&&(f.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1,!0)}onDestroy(){Kh.setSrc(this.element,null),this.element.remove()}}class Qh extends Yh{get duration(){return this._buffer?this._buffer.duration:0}onPlay(e){W.media.audioDataCache.get(e,this.onLoaded,this)}onPlayAgain(){this.reset(),this.startPlay(!1)}onStop(){this.reset(),this._buffer=null}onPause(){this.reset()}onResume(){this.startPlay(!0)}onVolumeChanged(){if(!this._sourceNode)return;let e=this._muted?0:this._volume;this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,W.media.audioCtx.currentTime,.001):this._gainNode.gain.value=e}onMuted(){this.onVolumeChanged()}onLoaded(e){this._started&&(this._buffer=e,!e||this.startTime>=this.duration?this.stop():(this._loaded=!0,this._paused||this.startPlay(!1)))}startPlay(e){let t=W.media.audioCtx;this._gainNode=Qh.gainNodePool.take();let s=this._sourceNode=t.createBufferSource();s.buffer=this._buffer,s.connect(this._gainNode),s.onended=()=>this.onPlayEnd(),s.playbackRate&&(s.playbackRate.setTargetAtTime?s.playbackRate.setTargetAtTime(this.playbackRate,t.currentTime,.001):s.playbackRate.value=this.playbackRate),s.loop=0===this.loops,s.loopStart=this.startTime,s.loopEnd=this._buffer.duration,this._gainNode.gain.value=this._muted?0:this._volume,s.start(0,e?this._pauseTime:this.startTime),null!=t.state&&"running"!==t.state?(this._startTime=0,W.media.resumeUntilGotFocus(this)):this._startTime=performance.now()}reset(){if(!this._sourceNode)return;let e=this._sourceNode;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,this._sourceNode=null,Qh.gainNodePool.recover(this._gainNode),this._gainNode=null}}Qh.gainNodePool=h.createPool2(()=>function(){let e;e=W.media.audioCtx.createGain?W.media.audioCtx.createGain():W.media.audioCtx.createGainNode();return e}(),e=>function(e){e.connect(W.media.audioCtx.destination)}(e),e=>function(e){e.disconnect(0)}(e));class Zh{open(e,t){let s=null==t?void 0:t.protocols;s&&0!=s.length?this.ws=new Y.window.WebSocket(e,s):this.ws=new Y.window.WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=e=>this.onOpen({}),this.ws.onclose=e=>this.onClose(),this.ws.onerror=e=>this.onError(e),this.ws.onmessage=e=>{e.data&&this.onMessage(e.data)}}close(){this.ws.close()}send(e){return this.ws.send(e),Promise.resolve()}}class Jh extends N{constructor(){super(),this.webSocketClass=Zh,this._pixelRatio=1,this.init(),this.initRequestFrameFunction()}init(){var e;let t=Y.document,s=Y.window;this._pixelRatio=Math.max(1,s.devicePixelRatio||1),this.setPlatform(s.navigator.userAgent||"",s.navigator.platform||"");let r="visibilityState",i="visibilitychange",a="fullscreenchange";void 0!==t.hidden?(i="visibilitychange",r="visibilityState",a="fullscreenchange"):void 0!==t.mozHidden?(i="mozvisibilitychange",r="mozVisibilityState",a="mozfullscreenchange"):void 0!==t.msHidden?(i="msvisibilitychange",r="msVisibilityState",a="msfullscreenchange"):void 0!==t.webkitHidden&&(i="webkitvisibilitychange",r="webkitVisibilityState",a="webkitfullscreenchange"),this._visibilityStateKey=r,t.addEventListener(i,()=>{this.event(c.VISIBILITY_CHANGE,this.getVisibility()),Y.onAndroid&&!Y.onLayaRuntime&&(this.getVisibility()?this.event(c.FOCUS):this.event(c.BLUR))}),t.addEventListener(a,()=>this.event(c.FULL_SCREEN_CHANGE)),s.addEventListener("resize",()=>this.event(c.RESIZE)),s.addEventListener("orientationchange",e=>this.event(c.ORIENTATION_CHANGE,e)),s.addEventListener("focus",()=>this.event(c.FOCUS)),s.addEventListener("blur",()=>this.event(c.BLUR)),s.addEventListener("unhandledrejection",e=>this.event("unhandledrejection",e));let n=t.body.style;n.margin=0,n.overflow="hidden",n["-webkit-user-select"]="none",n["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";let o,l=t.getElementsByTagName("meta"),h={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(let e=0;e<l.length;e++){let t=l[e];if("viewport"===t.name){o=t;break}}if(o){let e=(o.content||"").split(",");for(let t of e){let e=t.split("=");h[e[0].trim()]||(h[e[0]]=e[1])}}else o=t.createElement("meta"),o.name="viewport",null===(e=t.getElementsByTagName("head")[0])||void 0===e||e.appendChild(o);o.content=Object.keys(h).map(e=>e+"="+h[e])}setPlatform(e,t){t=t.toLowerCase(),Y.userAgent=e,Y.onMobile=e.indexOf("Mobile")>-1,Y.onIOS=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),Y.onIPhone=e.indexOf("iPhone")>-1,Y.onMac=e.indexOf("Mac OS X")>-1,Y.onIPad=e.indexOf("iPad")>-1,Y.onAndroid=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,Y.onOpenHarmonyOS=e.indexOf("OpenHarmony")>-1,Y.onWP=e.indexOf("Windows Phone")>-1,Y.onQQBrowser=e.indexOf("QQBrowser")>-1,Y.onMQQBrowser=e.indexOf("MQQBrowser")>-1||e.indexOf("Mobile")>-1&&e.indexOf("QQ")>-1,Y.onIE=!!window.ActiveXObject||"ActiveXObject"in window,Y.onWeiXin=e.indexOf("MicroMessenger")>-1,Y.onSafari=e.indexOf("Safari")>-1&&-1===e.indexOf("Chrome"),Y.onChrome=e.indexOf("Chrome")>-1,Y.onFirefox=e.indexOf("Firefox")>-1,Y.onEdge=e.indexOf("Edge")>-1||e.indexOf("Edg")>-1,-1!==t.indexOf("ios")?(Y.onIOS=!0,Y.onMobile=!0,e||(Y.onIPhone=!0,Y.onIPad=!0),Y.platform=Y.PLATFORM_IOS,Y.platformName="ios"):-1!==t.indexOf("android")?(Y.onAndroid=!0,Y.onMobile=!0,Y.platform=Y.PLATFORM_ANDROID,Y.platformName="android"):-1!==t.indexOf("ohos")?(Y.onOpenHarmonyOS=!0,Y.onMobile=!0,Y.platform=Y.PLATFORM_ANDROID,Y.platformName="ohos"):-1!==t.indexOf("mac")?(Y.onMac=!0,Y.platform=Y.PLATFORM_PC,Y.platformName="mac"):-1!==t.indexOf("win")?(Y.platform=Y.PLATFORM_PC,Y.platformName="windows"):Y.onAndroid?(Y.platform=Y.PLATFORM_ANDROID,Y.platformName="android"):Y.onIOS?(Y.platform=Y.PLATFORM_IOS,Y.platformName="ios"):(Y.platform=Y.PLATFORM_PC,Y.platformName=t),Y.onPC=!Y.onMobile,Y.onDevTools="devtools"===Y.platformName,Y.isTouchDevice=!0,-1!=e.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")&&(this._pixelRatio=2)}initRequestFrameFunction(){this.requestFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,this.requestFrame||(this.requestFrame=function(e){return setTimeout(e,1e3/60)})}start(){return Promise.resolve()}onInitRender(){}getScreenOrientation(){let e=window.screen.orientation.type;if(null==e){switch(window.orientation){case 0:e="portrait-primary";break;case 180:e="portrait-secondary";break;case 90:e="landscape-primary";break;case-90:e="landscape-secondary"}}return e}getPixelRatio(){return this._pixelRatio}getClientWidth(){return Y.window.innerWidth||Y.document.body.clientWidth||Y.document.documentElement.clientWidth}getClientHeight(){return Y.window.innerHeight||Y.document.body.clientHeight||Y.document.documentElement.clientHeight}getVisibility(){return"hidden"!==Y.document[this._visibilityStateKey]}requestFullscreen(){let e=Y.document.documentElement;e&&(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen())}exitFullscreen(){let e=document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}createElement(e){return Y.document.createElement(e)}createMainCanvas(){let e=this.createElement("canvas");e.id="layaCanvas",e.width=2,e.height=2;let t=e.style;t.position="absolute",t.top=t.left="0px",t.background="#000000";let s=Y.document.createElement("div");return s.id="layaContainer",Y.document.body.appendChild(s),s.appendChild(e),e}setCursor(e){Y.isDomSupported&&(Y.document.body.style.cursor=e)}get supportArrayBufferURL(){return!!window.Blob}createBufferURL(e){if(window.Blob){let t=new Blob([e],{type:"application/octet-binary"});return window.URL.createObjectURL(t)}return null}revokeBufferURL(e){window.URL.revokeObjectURL(e)}getOpenDataContextCanvas(){return null}postMessageToOpenDataContext(e){}captureGlobalError(e){this._globalErrorCallback=e,this.onCaptureGlobalError(null!=e,ed)}onCaptureGlobalError(e,t){e?(Y.window.addEventListener("error",t),Y.window.addEventListener("unhandledrejection",t)):(Y.window.removeEventListener("error",t),Y.window.removeEventListener("unhandledrejection",t))}alert(e){Y.window.alert(e)}setStyleTransformOrigin(e,t){e.transformOrigin=e.webkitTransformOrigin=e.msTransformOrigin=e.mozTransformOrigin=e.oTransformOrigin=t}setStyleTransform(e,t){e.transform=e.webkitTransform=e.msTransform=e.mozTransform=e.oTransform=t}createWebSocket(){return this.webSocketClass?new this.webSocketClass:null}}function ed(e){W.browser._globalErrorCallback(e)}W.register("browser",Jh);class td extends N{get supportedLocation(){return!1}get supportedGetUserMedia(){return!1}getCurrentPosition(e,t,s){}watchPosition(e,t,s){return-1}clearWatchPosition(e){}getUserMedia(e,t,s){}onStartListeningToType(e){return"devicemotion"===e?this.startListeningDeviceMotion():"deviceorientation"===e&&this.startListeningDeviceOrientation(),this}startListeningDeviceMotion(){}startListeningDeviceOrientation(){}}W.register("device",td);class sd{readFile(e,t){throw new C}writeFile(e,t,s){throw new C}unlink(e){throw new C}copyFile(e,t){throw new C}exists(e){throw new C}getFileSize(e){throw new C}mkdir(e,t){throw new C}rmdir(e,t){throw new C}readdir(e){throw new C}unzip(e,t){throw new C}}W.register("fs",sd);class rd{loadFont(e){let t=Q.replaceFileExtension(Q.getBaseName(e.url),""),s=ee.postFormatURL(ee.formatURL(e.url));return Y.window.FontFace?this.loadByFontFace(e,s,t):this.loadByCSS(e,s,t)}loadByFontFace(e,t,s){let r=new Y.window.FontFace(s,"url('"+t+"')");return Y.document.fonts.add(r),r.load().then(()=>r)}loadByCSS(e,t,s){let r="40px "+s;Y.context.font=r;let i=Y.context.measureText(id).width,a=Y.createElement("style");return a.type="text/css",Y.document.body.appendChild(a),a.textContent="@font-face { font-family:'"+s+"'; src:url('"+t+"');}",new Promise(e=>{let t=()=>{Y.context.font=r,Y.context.measureText(id).width!=i&&a()},a=()=>{l.systemTimer.clear(this,t),l.systemTimer.clear(this,a),e({family:s})};l.systemTimer.once(1e4,this,a),l.systemTimer.loop(20,this,t)})}}const id="LayaTTFFont";W.register("font",rd);class ad{constructor(){this.touchToStart=!0,this._firstTouch=!0,this.audioDataCache=new Xh,this.suspendedMedias=new Set,this.touchToStart=null==W.g,this.init()}init(){let e=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;null!=e&&(this.audioCtx=new e),this.shortAudioClass=this.audioCtx?Qh:qh,this.longAudioClass=qh,this.videoTextureClass=$h,this.videoPlayerClass=Kh}createSoundChannel(e,t){return t?new this.longAudioClass(e):new this.shortAudioClass(e)}createVideoTexture(){return null==this.videoTextureClass?(W.warnIncompatibility("VideoTexture"),new ml):new this.videoTextureClass}createVideoPlayer(){return null==this.videoPlayerClass?(W.warnIncompatibility("VideoPlayer"),new jh):new this.videoPlayerClass}decodeAudioData(e){return this.audioCtx?this.audioCtx.decodeAudioData(e):Promise.resolve(null)}resumeUntilGotFocus(e){0===this.suspendedMedias.size&&(l.stage.on(c.MOUSE_UP,this,this.onGotFocus),this._firstTouch&&this.touchToStart||l.stage.on(c.FOCUS,this,this.onGotFocus)),this.suspendedMedias.add(e),e.pause(),e._autoResume=!0}canPlayType(e){return"undefined"!=typeof HTMLAudioElement&&"function"==typeof HTMLAudioElement.prototype.canPlayType?(this._testElement||(this._testElement=Y.createElement("audio")),this._testElement.canPlayType(e)):""}onGotFocus(){if(this._firstTouch=!1,l.stage.off(c.MOUSE_UP,this,this.onGotFocus),l.stage.off(c.FOCUS,this,this.onGotFocus),0===this.suspendedMedias.size)return;let e=Array.from(this.suspendedMedias).filter(e=>e._autoResume);this.suspendedMedias.clear(),this.beforeResumeMedias(e).then(()=>{for(let t of e)t._autoResume=!1,t.resume()})}beforeResumeMedias(e){let t=!1;for(let s of e)if(s instanceof Qh&&!t&&(t=!0,"suspended"===this.audioCtx.state))return this.audioCtx.resume().catch(e=>{});return Promise.resolve()}}W.register("media",ad);class nd{constructor(){this._storage=Y.window.localStorage,this._supported=this.checkSupport()}checkSupport(){return null!=this._storage&&"function"==typeof this._storage.getItem&&"function"==typeof this._storage.setItem}getItem(e){return this._supported?this._storage.getItem(e):null}setItem(e,t){this._supported&&this._storage.setItem(e,t)}removeItem(e){this._supported&&this._storage.removeItem(e)}clear(){this._supported&&this._storage.clear()}getCount(){return this._supported&&this._storage.length||0}}W.register("storage",nd);class od{constructor(){this._beginFlag=0,this._editInline=!0,this._enterEvent=new c,this._lastTransform={},bn.addAfterInitCallback(()=>{l.stage.on(c.MOUSE_UP,this,this.onTouchEnd),nn.onMouseDownCapture.add(this.onTouchBegin,this)})}begin(e,t){return this.target===e||0!==this._beginFlag?Promise.resolve():(this._beginFlag=1,(this.target?this.end(!1,this.target.editable):Promise.resolve()).then(()=>(this.target=e,l.stage.focus=e,this.updateRestrictPattern(),this._lastTransform.x=null,e.on(c.UNDISPLAY,this,this.end),this.onBegin().catch(e=>{console.error("TextInputAdapter begin error:",e)}))).then(()=>{this._editInline&&(this.target.hideText(!0),l.stage.on(c.KEY_DOWN,this,this.onKeyDown)),e.event(c.FOCUS)}).then(()=>t?(this._beginFlag=2,Promise.resolve()):(this._beginFlag=0,this.onCanShowKeyboard().catch(e=>{console.error("TextInputAdapter begin error:",e)}))))}end(e,t){let s=this.target;return s?(this.target=null,l.stage.focus=null,s.off(c.UNDISPLAY,this,this.end),this._editInline&&l.stage.off(c.KEY_DOWN,this,this.onKeyDown),this.onEnd(s,!!e,!!t).then(()=>{this._editInline&&s.hideText(!1),s.editable&&s.event(c.CHANGE),s.event(c.BLUR)}).catch(e=>{console.error("TextInputAdapter end error:",e)})):Promise.resolve()}onBegin(){this.showInputElement();let e=this._visEle,t=this.target;e instanceof HTMLInputElement&&(e.type=this.target.type),e.readOnly=!t.editable,e.maxLength=t.maxChars<=0?1e5:t.maxChars,e.value=this.target.text,e.placeholder=t.prompt;let s=e.style;return s.fontFamily=t.realFont,s.color=t.color,s.fontSize=t.fontSize+"px",s.whiteSpace=t.wordWrap?"pre-wrap":"nowrap",s.lineHeight=t.leading+t.fontSize+"px",s.fontStyle=t.italic?"italic":"normal",s.fontWeight=t.bold?"bold":"normal",s.textAlign=t.align,s.padding="0 0",s.direction=Kn.RightToLeft?"rtl":"",this.setPromptColor(),this.syncTransform(),this._editInline&&l.systemTimer.frameLoop(1,this,this.syncTransform),Promise.resolve()}onCanShowKeyboard(){return this._visEle&&this._visEle.focus(),Promise.resolve()}onEnd(e,t,s){return Y.document.body.scrollTop=0,e.text=this._visEle.value,this._visEle.blur(),this.hideInputElement(),this._visEle=null,this._editInline&&l.systemTimer.clear(this,this.syncTransform),Promise.resolve()}syncText(){this._visEle&&0===this._beginFlag&&this.updateTargetText(this._visEle.value)}setText(e){this._visEle&&(this._visEle.value=e)}setSelection(e,t){this._visEle&&(this._visEle.selectionStart=e,this._visEle.selectionEnd=t)}onTouchBegin(){let e=l.stage.focus,t=nn.touchTarget;e!=t&&(t instanceof co?this.begin(t,!0):e instanceof co&&this.end())}onTouchEnd(){0!==this._beginFlag&&(1===this._beginFlag?l.systemTimer.frameOnce(1,this,this.onTouchEnd):(this._beginFlag=0,this.onCanShowKeyboard().catch(e=>{console.error("TextInputAdapter begin error:",e)})))}setPromptColor(){this._promptStyleDOM=Y.document.getElementById("promptStyle"),this._promptStyleDOM||(this._promptStyleDOM=Y.document.createElement("style"),this._promptStyleDOM.setAttribute("id","promptStyle"),Y.document.head.appendChild(this._promptStyleDOM));let e=this.target.promptColor;this._promptStyleDOM.innerText=`input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {\n                color: ${e}\n            }\n            input:-moz-placeholder, textarea:-moz-placeholder {\n                color: ${e}\n            }\n            input::-moz-placeholder, textarea::-moz-placeholder {\n                color: ${e}\n            }\n            input:-ms-input-placeholder, textarea:-ms-input-placeholder {\n                color: ${e}\n            }\n        `}updateRestrictPattern(){let e=this.target.restrict;e?(e="[^"+e+"]",e.indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}validateText(e){return null==e&&(e=""),this.target.multiline||(e=e.replace(/\r?\n/g,"")),this._restrictPattern&&(e=e.replace(/\u2006|\x27/g,""),this._restrictPattern.test(e)&&(e=e.replace(this._restrictPattern,""))),e}showInputElement(){this._eInput||this.createElements();let e="password"===this.target.type,t=this.target.multiline&&!e?this._eTextArea:e?this._ePassword:this._eInput;this._visEle=t,this._container.appendChild(t)}hideInputElement(){this._visEle&&this._visEle.parentElement&&this._visEle.remove()}updateTargetText(e){let t=this.target;this.target=null;let s=t.text!=e;return t.text=e,this.target=t,s}getTargetTransform(){let e=this.target.padding,{x:t,y:s,scaleX:r,scaleY:i}=pa.getTransformRelativeToWindow(this.target,e[3],e[0]),a=this.target.width-e[1]-e[3],n=this.target.height-e[0]-e[2],o=this._lastTransform;return t!==o.x||s!==o.y||a!==o.width||n!==o.height||r!==o.scaleX||i!==o.scaleY?(o.x=t,o.y=s,o.width=a,o.height=n,o.scaleX=r,o.scaleY=i,o):null}syncTransform(){let e=this.getTargetTransform();if(null!=e){let t=this._visEle.style;t.width=e.width+"px",t.height=e.height+"px",W.browser.setStyleTransform(t,"scale("+e.scaleX+","+e.scaleY+") rotate("+l.stage.canvasDegree+"deg)"),this._container.style.left=e.x+"px",this._container.style.top=e.y+"px"}}createElements(){this._container=Y.document.createElement("div"),Y.container.appendChild(this._container);let e=this._container.style;e.position="absolute",e.zIndex="1E5",this.initElement(this._eTextArea=Y.document.createElement("textarea")),this.initElement(this._eInput=Y.document.createElement("input")),this.initElement(this._ePassword=Y.document.createElement("input"))}initElement(e){let t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex="1",W.browser.setStyleTransformOrigin(t,"0 0"),e.addEventListener("input",e=>!e.isComposing&&this.processInputting(e)),e.addEventListener("compositionend",e=>this.processInputting(e)),e.addEventListener("mousemove",e=>this.stopEvent(e),{passive:!1}),e.addEventListener("mousedown",e=>this.stopEvent(e),{passive:!1}),e.addEventListener("touchmove",e=>this.stopEvent(e),{passive:!1})}processInputting(e){if(!this.target)return;let t=e.target,s=this.validateText(t.value);t.value=s,this.updateTargetText(s)&&this.target.event(c.INPUT)}stopEvent(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}onKeyDown(e){if("Enter"===e.key||"NumpadEnter"===e.key){let t=this.target;t.multiline||(e.preventDefault(),this._enterEvent.setTo(c.ENTER,this.target,this.target),t.event(c.ENTER,this._enterEvent),this._enterEvent._defaultPrevented||this.target!==t||this.end())}}}W.register("textInput",od);class ld extends G{static get defaultTexture(){return this._defaultTexture}static __init__(){f.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new ld(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}constructor(t,s,r,i,a=!0,n=!1){super(t,s,i),this._dimension=e.TextureDimension.Tex3D,this.depth=r,this._gammaSpace=n;let o=f.textureContext;this._texture=o.createTexture3DInternal(this._dimension,t,s,r,i,a,n,!1)}setPixelsData(e){let t=this._texture;f.textureContext.setTexture3DPixelsData(t,e,this.depth,!1,!1)}setSubPixelsData(e,t,s,r,i,a,n,o,l){let h=this._texture;f.textureContext.setTexture3DSubPixelsData(h,n,o,l,e,t,s,r,i,a,!1,!1)}}class hd{static getRT(t,s){return s|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new zi(t,s,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)}static releaseRT(e){e.destroy()}}hd.dict={};class dd extends N{constructor(){super(...arguments),this._tweenDic=[],this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(e,t,s,r=null,i=0){return(new dd).to(e,t,s,r,i)}static from(e,t,s,r=null,i=0){return(new dd).from(e,t,s,r,i)}to(e,t,s,r=null,i=0){return this._create(e,t,s,r,i,!0)}from(e,t,s,r=null,i=0){return this._create(e,t,s,r,i,!1)}_create(e,t,s,r,i,a){var n=h.getItemByClass("tweenData",ud);return n.isTo=a,n.type=0,n.target=e,n.duration=s,n.data=t,n.startTime=this._startTime+i,n.endTime=n.startTime+n.duration,n.ease=r,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(e,t){var s=h.getItemByClass("tweenData",ud);return s.type=1,s.data=e,s.endTime=s.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=s,this._tweenDataList.push(s),this}removeLabel(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var s=this._tweenDataList.indexOf(t);s>-1&&this._tweenDataList.splice(s,1)}delete this._labelDic[e]}}gotoTime(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){for(let o in this._firstTweenDic){let l=this._firstTweenDic[o];if(l)for(let h in l)h in l.diyTarget&&(l.diyTarget[h]=l[h])}for(let d of this._tweenDic)la.kill(d);var t,s;if(this._tweenDic.length=0,this._index=0,this._currTime=e,this._lastTime=performance.now(),null==this._endTweenDataList||this._endTimeSort){function u(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=t=this._tweenDataList.concat(),t.sort(u)}else t=this._endTweenDataList;for(var r=0,i=t.length;r<i;r++)if(0==(s=t[r]).type){if(!(e>=s.endTime))break;this._index=Math.max(this._index,r+1);var a=s.data;if(s.isTo)for(var n in a)s.target[n]=a[n]}for(r=0,i=this._tweenDataList.length;r<i;r++)if(0==(s=this._tweenDataList[r]).type&&e>=s.startTime&&e<s.endTime){let c;this._index=Math.max(this._index,r+1),c=s.isTo?la.to(s.target,s.data,s.duration,s.ease,he.create(this,this._animComplete)):la.from(s.target,s.data,s.duration,s.ease,he.create(this,this._animComplete)),this._tweenDic.push(c)}}}gotoLabel(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}pause(){l.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(e=0,t=!1){if(this._tweenDataList){if(this._startTimeSort){function d(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(d);for(var s=0,r=this._tweenDataList.length;s<r;s++){var i=this._tweenDataList[s];if(null!=i&&0==i.type){var a=i.target,n=Q.getGID(a),o=null;for(var h in null==this._firstTweenDic[n]?((o={}).diyTarget=a,this._firstTweenDic[n]=o):o=this._firstTweenDic[n],i.data)null==o[h]&&(o[h]=a[h])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=performance.now(),l.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(let e of this._tweenDic)e.complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var e=performance.now(),t=e-this._lastTime,s=this._currTime+=t*this.scale;if(this._lastTime=e,0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var r=this._tweenDataList[this._index];if(s>=r.startTime)if(this._index++,0==r.type){let e;e=r.isTo?la.to(r.target,r.data,r.duration,r.ease,he.create(this,this._animComplete)):la.from(r.target,r.data,r.duration,r.ease,he.create(this,this._animComplete)),this._tweenDic.push(e)}else this.event(c.LABEL,r.data)}}_animComplete(e){let t=this._tweenDic.indexOf(e.owner);t>-1&&this._tweenDic.splice(t,1)}_complete(){this.event(c.COMPLETE)}get index(){return this._frameIndex}set index(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var e,t,s;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(let e of this._tweenDic)la.kill(e);for(e in this._tweenDic.length=0,this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(s=this._tweenDataList.length,t=0;t<s;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this.scale=1,l.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class ud{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,h.recover("tweenData",this)}}class cd{static init(){if(!cd.lookup){cd.lookup=new Uint8Array(256);for(var e=0;e<cd.chars.length;e++)cd.lookup[cd.chars.charCodeAt(e)]=e}}static isBase64String(e){return cd.reg.test(e)}static encode(e){var t,s=new Uint8Array(e),r=s.length,i="";for(t=0;t<r;t+=3)i+=cd.chars[s[t]>>2],i+=cd.chars[(3&s[t])<<4|s[t+1]>>4],i+=cd.chars[(15&s[t+1])<<2|s[t+2]>>6],i+=cd.chars[63&s[t+2]];return r%3==2?i=i.substring(0,i.length-1)+"=":r%3==1&&(i=i.substring(0,i.length-2)+"=="),i}static decode(e){cd.init();var t,s,r,i,a,n=.75*e.length,o=e.length,l=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var h=new ArrayBuffer(n),d=new Uint8Array(h);for(t=0;t<o;t+=4)s=cd.lookup[e.charCodeAt(t)],r=cd.lookup[e.charCodeAt(t+1)],i=cd.lookup[e.charCodeAt(t+2)],a=cd.lookup[e.charCodeAt(t+3)],l+1>n||(d[l++]=s<<2|r>>4,l+1>n||(d[l++]=(15&r)<<4|i>>2,l+1>n||(d[l++]=(3&i)<<6|63&a)));return h}}cd.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",cd.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,cd.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,cd.lookup=null;const _d=new te;class pd{contains(e,t,s){return!pd._isHitGraphic(e,t,s,this._unHit)&&pd._isHitGraphic(e,t,s,this._hit)}moveTo(e,t,s,r){if(s&&this._hit)for(let s of this._hit.cmds)s.x=e,s.y=t;if(r&&this._unHit)for(let s of this._unHit.cmds)s.x=e,s.y=t}static _isHitGraphic(e,t,s,r){return!!r&&-1!==r.cmds.findIndex(r=>r&&pd._isHitCmd(e,t,s,r))}static _isHitCmd(e,t,s,r){if(!r)return!1;var i=!1;switch(r.cmdID){case Ht.ID:{let a=r;a.percent?_d.setTo(a.x*s.width,a.y*s.height,a.width*s.width,a.height*s.height):_d.setTo(a.x,a.y,a.width,a.height),i=_d.contains(e,t);break}case Tt.ID:{let a,n=r,o=n.radius;n.percent?(e-=n.x*s.width,t-=n.y*s.height,o*=s.width):(e-=n.x,t-=n.y),a=e*e+t*t,i=a<o*o;break}case Pi.ID:{let a,n=r,o=n.width/2,l=n.height/2;n.percent?(e-=n.x*s.width,t-=n.y*s.height,o*=s.width,l*=s.height):(e-=n.x,t-=n.y),a=Math.pow(e/o,2)+Math.pow(e/l,2),i=a<1;break}case Gt.ID:{let s=r;e-=s.x,t-=s.y,i=Q.testPointInPolygon(e,t,s.points);break}}return i}get hit(){return this._hit||(this._hit=new Ni),this._hit}set hit(e){this._hit=e}get unHit(){return this._unHit||(this._unHit=new Ni),this._unHit}set unHit(e){this._unHit=e}onAfterDeserialize(){this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds)}}Ee.regClass("HitArea",pd);class gd{static isJsonBin(e){if(e.byteLength<5)return!1;const t=new Uint32Array(e,0,4)[0];return t===Td||t===yd||t===xd}static parse(e,t){if(!gd.isJsonBin(e)){let t=new $t;t.writeArrayBuffer(e),t.pos=0;let s=t.readUTFBytes();return JSON.parse(s)}su=t;let s,r,i=new $t;switch(i.writeArrayBuffer(e),i.pos=0,uu={},r=i.readInt32(),r){case Td:s=i.readUTFString();break;case yd:case xd:s=i.readUTFString32();break;default:return i.pos=0,null}var a={keys:{},strs:["BEGIN",0],keyArray:[],keyIndex:1};a.strs=s.split(Sd),a.keyArray.length=a.strs.length/2;for(var n=0,o=a.strs.length;n<o;n+=2)a.keyArray[n/2]=[a.strs[n],parseInt(a.strs[n+1])];tu=i.pos;var l={};return au(l,i,null,Od,a),r==xd?l.top:l}static write(e,t){du=t;var s={keys:{},strs:["BEGIN",0],keyArray:[],keyIndex:1};uu={};var r=new $t;fu(r,s,{top:e}),r.writeUint16(eu);var i=new $t;return i.writeInt32(xd),i.writeUTFString32(s.strs.join(Sd)),i.writeArrayBuffer(r.buffer),i.buffer}}class md{static get instance(){return md._instance||(md._instance=new md)}static IsJsonbin(e){return gd.isJsonBin(e)}static parse(e){return gd.parse(e)}read(e,t){return gd.parse(e,t)}}class fd{static get instance(){return fd._instance||(fd._instance=new fd)}write(e,t){return gd.write(e,t)}}const Td=16777215,yd=16777214,xd=16777213,Sd=String.fromCharCode(3),Ed=1,vd=0,Dd=1,wd=2,bd=3,Cd=4,Rd=5,Md=6,Ad=7,Id=8,Pd=9,Bd=10,Ld=11,Nd=12,Fd=14,Od=15,Ud=16,kd=17,Vd=18,Gd=19,zd=20,Hd=21,Wd=22,Xd=23,Yd=24,qd=25,jd=26,Kd=27,$d=28,Qd=29,Zd=30,Jd=31,eu=32767;var tu,su;function ru(e,t,s,r,i){var a,n=[];n.length=s,t>=0&&(a=e.pos,e.pos=t);for(var o=0;o<s;o++)n[o]=au({},e,null,e.readUint8(),i);return t>=0&&(e.pos=a),n}function iu(e){let t=e.readUint8();return 128&t?e.readUint8()|(-129&t)<<8:t}function au(e,t,s,r,i){let a,n;switch(r){case Fd:n=null;break;case vd:n=t.readByte();break;case Dd:n=t.readInt16();break;case wd:n=t.readInt32();break;case Kd:n=nu(t.readInt32(),t.readInt32());break;case bd:n=!!t.readByte();break;case Cd:n=t.readFloat32();break;case Ud:n=t.readInt16()/1e3;break;case kd:n=t.readInt32()/1e3;break;case Rd:n=i.keyArray[t.readUint16()][0];break;case Vd:break;case Id:t.readUint8(),n=[];break;case Pd:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readByte();break;case Bd:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readInt16();break;case Ld:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readInt32();break;case Nd:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readFloat32();break;case Gd:n=t.readArrayBuffer(t.readUint16());break;case Xd:n=t.readArrayBuffer(t.readUint32());break;case $d:a=iu(t),n=t.readInt8Array(t.pos,a);break;case Qd:a=iu(t),n=t.readUint8Array(t.pos,a);break;case Zd:a=iu(t),n=t.readInt16Array(t.pos,a);break;case Jd:a=iu(t),n=t.readFloat32Array(t.pos,a);break;default:return function(e,t,s,r,i){let a,n,o,l,h=e;switch(r){case Md:case Ad:case qd:switch(r){case Md:n=t.readUint8();break;case Ad:n=t.readInt16();break;case qd:n=t.readUint32()}var d=a=[];for(d.length=n,o=0;o<n;o++)r=t.readUint8(),d[o]=au(null,t,null,r,i);break;case Hd:case Wd:n=r===Hd?t.readUint8():t.readInt16(),l=t.pos-tu,a=ru(t,-1,n,0,i),uu[l]={array:a,pos:l};break;case zd:case Yd:o=t.readByte(),l=r===zd?t.readUint16():t.readUint32();let u=uu[l];if(!u)throw new Error("load ref err");a=o===Ed?ru(t,l+tu,u.array.length,0,i):u.array;break;case Od:case jd:if(null!=s||!e){if(r===Od)h={};else if(n=t.readUint16(),h=su(i.keyArray[n][0]),!h)throw new Error("jsonbin read err,no this class:"+i.keyArray[n][0]);s&&e&&(e[s]=h)}let c;for(;n=t.readUint16(),n!==eu;)c=i.keyArray[n],au(h,t,c[0],c[1],i);a=h,h=e}return null!=s&&(h[s]=a),a}(e,t,s,r,i)}return e&&s&&(e[s]=n),n}function nu(e,t){let s=t.toString(16);if(s.length<7)for(let e=s.length;e<7;e++)s="0"+s;return parseInt(e.toString(16)+""+s,16)}const ou="_$TeMpkEy$_CoMpReSs",lu="_$TeMpkEyNoSv$_",hu=15;var du,uu={};function cu(e,t,s,r){var i=e+"/&&__*?/"+t,a=xu(s.keys,i)?s.keys[i]:void 0;a||(a=s.keys[i]=s.keyIndex,s.strs.push(e,t),s.keyIndex++),r.writeUint16(a)}function _u(e){switch(typeof e){case"number":if(Math.floor(e)!==e)return Nd;var t=Math.abs(e);return t<128?Pd:t<32767?Bd:Ld;case"string":return Od;case"boolean":return bd}return Od}function pu(e,t,s,r,i){var a=i?Vd:Rd;null!=t?cu(t,a,e,r):r.writeUint8(a);var n=xu(e.keys,s)?e.keys[s]:void 0;void 0===n&&(n=e.keyIndex,e.keys[s]=n,e.strs.push(s,0),e.keyIndex++),r.writeUint16(n)}function gu(e,t){if(t<128)e.writeUint8(t);else{if(!(t<32768))throw new Error("jsonbin save len must<0x8000 "+t);e.writeUint8(t>>8|128),e.writeUint8(255&t)}}function mu(e,t,s,r,i){if(null==r)return!1;let a=typeof r;if("object"===a&&r){if(r.$__$disbaleJsonBinSv)return r.$__$disbaleJsonBinSv,!1;a=function(e){return e instanceof ArrayBuffer?"ArrayBuffer":e instanceof Uint8Array?"Uint8Array":e instanceof Int8Array?"Int8Array":e instanceof Int16Array?"Int16Array":e instanceof Float32Array?"Float32Array":"object"}(r)}switch(a){case"number":if(Math.floor(r)!==r){var n=1e3*r;if((0|n)===n){if(Math.abs(r)<32)return null!=s?cu(s,Ud,t,e):e.writeUint8(Ud),e.writeInt16(n),!0;if(Math.abs(r)<2147483)return null!=s?cu(s,kd,t,e):e.writeUint8(kd),e.writeInt32(n),!0}return null!=s?cu(s,Cd,t,e):e.writeUint8(Cd),e.writeFloat32(r),!0}var o=Math.abs(r);return o<128?(null!=s?cu(s,vd,t,e):e.writeUint8(vd),e.writeByte(r),!0):o<32767?(null!=s?cu(s,Dd,t,e):e.writeUint8(Dd),e.writeInt16(r),!0):o<2147483647?(null!=s?cu(s,wd,t,e):e.writeUint8(wd),e.writeInt32(r),!0):(null!=s?cu(s,Kd,t,e):e.writeUint8(Kd),function(e,t){let s=t.toString(16),r=parseInt(s.substring(0,s.length-7),16),i=parseInt(s.substring(s.length-7),16);if(e.writeInt32(r),e.writeInt32(i),nu(r,i)!=t)throw new Error("save big number err:"+t)}(e,r),!0);case"string":return pu(t,s,r,e,!1),!0;case"boolean":return null!=s?cu(s,bd,t,e):e.writeUint8(bd),e.writeByte(r?1:0),!0;case"ArrayBuffer":return null!=s?cu(s,Xd,t,e):e.writeUint8(Xd),e.writeUint32(r.byteLength),e.writeArrayBuffer(r),!0;case"Uint8Array":return null!=s?cu(s,Qd,t,e):e.writeUint8(Qd),gu(e,r.length),e.writeArrayBuffer(r.buffer),!0;case"Int8Array":return null!=s?cu(s,$d,t,e):e.writeUint8($d),gu(e,r.length),e.writeArrayBuffer(r.buffer),!0;case"Int16Array":return null!=s?cu(s,Zd,t,e):e.writeUint8(Zd),gu(e,r.length),e.writeArrayBuffer(r.buffer),!0;case"Float32Array":return null!=s?cu(s,Jd,t,e):e.writeUint8(Jd),gu(e,r.length),e.writeArrayBuffer(r.buffer),!0;case"WordText":return pu(t,s,r._text,e,!0),!0;case"object":break;default:throw new Error("jsonbin no this type:"+a)}return r?r instanceof Array?function(e,t,s,r,i){var a,n,o,l=i.length;if(0===l)return null!=r?cu(r,Id,s,t):t.writeUint8(Id),t.writeByte(0),!0;if(l>1&&l<250&&(n=_u(i[0]))!=Od){for(a=1;a<l;a++)if(n!==_u(i[a])){n=Od;break}if(n!=Od&&n!=bd){switch(null!=r?cu(r,n,s,t):t.writeUint8(n),t.writeUint8(i.length),n){case Pd:for(a=0;a<l;a++)t.writeByte(i[a]);break;case Bd:for(a=0;a<l;a++)t.writeInt16(i[a]);break;case Ld:for(a=0;a<l;a++)t.writeInt32(i[a]);break;case Nd:for(a=0;a<l;a++)t.writeFloat32(i[a])}return!0}}o=l<250?Md:l<32700?Ad:qd;var h=t.pos;null!=r?cu(r,o,s,t):t.writeUint8(o);var d=t.pos,u=0;switch(o){case Md:t.writeUint8(l);break;case Ad:t.writeInt16(l);break;case qd:t.writeUint32(l)}var c,_=t.pos;for(a=0;a<l;a++)mu(t,s,null,i[a],e)&&u++;if(u!=l){var p=t.pos;t.pos=d,o===Md?t.writeUint8(u):t.writeInt16(u),t.pos=p}r&&e&&(c=e[ou+r])&&function(e,t,s,r,i,a,n,o){var l,h,d,u,c=e.pos-a,_=function(e,t,s,r=9191891){var i,a=0;for(i=0;i<s;i++)a=(2*a+e[t+i])%r;return a}(e._u8d_,a,c);if(uu[_]){var p=uu[_];for(u=p.length,d=0;d<u;d++)if((h=p[d]).value==r){l=h;break}if(!l)for(d=0;d<u;d++)if(h=p[d],Tu(e._u8d_,h.pos,h.len,e._u8d_,a,c)){l=h;break}}else uu[_]=[];l?(e.pos=i,cu(s,Yd,t,e),e.writeByte(n),e.writeUint32(l.pos)):(uu[_].push({hashCode:_,pos:a,len:c,value:r}),e.pos=i,cu(s,o===Md?Hd:Wd,t,e),e.pos=a+c)}(t,s,r,i,h,_,c,o);return!0}(i,e,t,s,r):(du&&r.__CLASS__?null!=s?cu(s,jd,t,e):e.writeUint8(jd):null!=s?cu(s,Od,t,e):e.writeUint8(Od),fu(e,t,r),e.writeUint16(eu),!0):(null!=s?cu(s,Fd,t,e):e.writeUint8(Fd),!0)}function fu(e,t,s){for(var r in du&&s.__CLASS__&&function(e,t,s){var r=xu(e.keys,t)?e.keys[t]:void 0;void 0===r&&(r=e.keyIndex,e.keys[t]=r,e.strs.push(t,0),e.keyIndex++),s.writeUint16(r)}(t,s.__CLASS__,e),s)r&&r.length>hu&&r.substr(0,hu)==lu||du&&"__CLASS__"==r||mu(e,t,r,s[r],s)}function Tu(e,t,s,r,i,a){if(s!=a)return!1;var n,o;for(o=s,n=0;n<o;n++)if(e[t+n]!=r[i+n])return!1;return!0}const yu=Object.prototype.hasOwnProperty;function xu(e,t){return yu.call(e,t)}class Su{static set cursor(e){this._cursor=e,this._hidden||W.browser.setCursor(e)}static get cursor(){return this._cursor}static hide(){this._hidden=!0,W.browser.setCursor("none")}static show(){this._hidden=!1,W.browser.setCursor(this._cursor)}}Su._cursor="auto",Su._hidden=!1;class Eu{createUI(){this._pass=f.render2DRenderPassFactory.createRender2DPass();let e=this._sp=new ja;this._pass.root=this._sp._struct,this._sp._struct.pass=this._pass,this._pass.doClearColor=!1;let t=this._title=new Kn;t.pos(5,5),t.color="#ffffff",t.name="title",e.addChild(t);let s=this._txt=new Kn;s.singleCharRender=!0,s.pos(100,5),s.color="#ffffff",s.name="txt",e.addChild(s),e.graphics.clear(),e.graphics.alpha(.5),e.graphics.drawRect(0,0,1,1,"#999999",null,null,!0),bn.stage.on(c.RESIZE,this,this.updateSize)}updateSize(){let t=Y.onMobile?10:12;t=Math.max(t,t/(bn.stage._canvasTransform.getScaleX()*bn.stage.clientScaleX)),this._txt.fontSize=t,this._title.fontSize=t,this._txt.x=this._title.textWidth+10,this._sp.size(this._title.textWidth+8*t,this._title.textHeight+10),this._sp._globalTrans._spTransChanged(e.TransformKind.TRS)}_displayChild(e,t){for(let s of e._children)s._children.length>0?this._displayChild(s,t):s._setDisplay(t);e._setDisplay(t)}show(t,s){this._items=new Array,vu.length=0;for(let t of Vi.elements){let s=e.StatElement[t],r=s.replace(/^(T_|C_|M_|CT_)/,"").replace(/_/g," "),i="",a=3;s.startsWith("CT_")||s.startsWith("C_")?a=0:s.startsWith("M_")?i="M":s.startsWith("T_")&&(i="ms"),this._items.push({value:t,fractionDigits:a,unit:i}),vu.push(r)}this._sp||this.createUI(),this._title.text=vu.join("\n"),this._sp.pos(t||0,s||0),this._sp._parent=bn.stage,this.updateSize(),this._displayChild(this._sp,!0)}hide(){this._sp&&(this._title.text=null,this._txt.text=null,this._sp._parent=null,this._displayChild(this._sp,!1))}update(){vu.length=0;for(let e=0;e<this._items.length;e++){let t=this._items[e],s=f.statAgent.getElementData(t.value).toFixed(t.fractionDigits).replace(Du,"$1");"-0"==s&&(s="0"),vu.push(s+" "+t.unit)}this._txt.text=vu.join("\n")}render(){this._pass&&this._pass.fowardRender(pi.rendercontext2D)}}const vu=[],Du=/\.0*$|(\.\d*[1-9])0+$/;Vi._statUIClass=Eu;class wu{static create(e,t){var s;let r;return"undefined"!=typeof document&&(r=null===(s=Y.document.currentScript)||void 0===s?void 0:s.src,r&&(r=r.substring(0,r.replace(/[?#].*/,"").lastIndexOf("/")+1))),()=>{let s={};return null!=wu.instantiateWasm&&(s.instantiateWasm=function(e,s){return wu.instantiateWasm(t,e).then(e=>(s(e.instance),e))}),s.locateFile=function(e,s){return t=null!=wu.locateFile?wu.locateFile(e,s,r):wu.locateFileDefault(e,s)},e(s)}}static locateFileDefault(e,t){return ee.urlMapping[e]?ee.formatURL(e,""):null!=t?t+e:e}}wu.Memory=void 0!==window.WebAssembly?window.WebAssembly.Memory:null;class bu{static get I(){return this._i||(this._i=new bu)}static clearCache(){for(let e=0,t=bu._maps.length;e<t;e++){bu._maps[e]._obj={}}}constructor(){this._obj={},bu._maps?bu._maps.push(this):(bu._maps=[this],l.systemTimer.loop(bu.delInterval,null,bu.clearCache))}set(e,t){null!=e&&("string"==typeof e||"number"==typeof e?this._obj[e]=t:this._obj[Q.getGID(e)]=t)}get(e){return null==e?null:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[Q.getGID(e)]}del(e){null!=e&&("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[Q.getGID(e)])}has(e){return null!=e&&("string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[Q.getGID(e)])}}bu.delInterval=6e5;class Cu{constructor(){this._deviceBufferState=f.renderDeviceFactory.createBufferState()}applyState(e,t){this._vertexBuffers=e,this._bindedIndexBuffer=t,this._deviceBufferState&&(1==e.length?(Cu.vertexBufferArray.length=1,Cu.vertexBufferArray[0]=e[0]._deviceBuffer):(Cu.vertexBufferArray.length=0,e.forEach(e=>{Cu.vertexBufferArray.push(e._deviceBuffer)})),this._deviceBufferState.applyState(Cu.vertexBufferArray,t?t._deviceBuffer:null))}destroy(){this._deviceBufferState&&(this._deviceBufferState.destroy(),this._deviceBufferState=null)}}return Cu.vertexBufferArray=[],e.AlphaCmd=Ze,e.Animation=Un,e.Animation2DCondition=Go,e.Animation2DEvent=Co,e.Animation2DParm=ko,e.AnimationClip2D=Oo,e.AnimationClip2DParse01=No,e.Animator2D=vo,e.AnimatorController2D=$o,e.AnimatorControllerLayer2D=mo,e.AnimatorControllerParse=Eo,e.AnimatorPlayState2D=go,e.AnimatorState2D=Do,e.AnimatorState2DScript=class{setPlayScriptInfo(e,t,s){this.playStateInfo.animator=e,this.playStateInfo.layerindex=t,this.playStateInfo.playState=s}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(e){}onStateExit(){}onStateSwitch(e){}onStateLoop(){}},e.AnimatorStateBoolCondition=qo,e.AnimatorStateCondition=Xo,e.AnimatorStateNumberCondition=Yo,e.AnimatorStateTriggerCondition=jo,e.AnimatorTransition2D=Ko,e.Area2D=Vl,e.AssetDb=J,e.AtlasGrid=Gr,e.AtlasInfoManager=ae,e.AtlasResource=oe,e.AudioDataCache=Xh,e.Base64Tool=cd,e.BasePoly=Ar,e.BaseRenderNode2D=xa,e.BaseTexture=G,e.BatchProgress=le,e.Bezier=yt,e.BitmapFont=kn,e.BlendComponent=hh,e.BlendModeHandler=Tr,e.BlendState=lh,e.Blit2DCMD=Ua,e.Blit2DQuadCMD=class{get element(){return this._element}set element(e){this._element=e}get dest(){return this._dest}set dest(e){this._dest=e}get source(){return this._source}set source(e){this._source=e}get offsetScale(){return this._offsetScale}set offsetScale(e){this._offsetScale=e}apply(e){throw new C}},e.BlurEffect2D=fh,e.BlurFilter=kh,e.BooleanKeyframe=zh,e.Browser=Y,e.BrowserAdapter=Jh,e.Buffer=dh,e.BufferState=Cu,e.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(e){this._tar=e,e.on(c.MOUSE_DOWN,this,this.toChangedState),e.on(c.MOUSE_UP,this,this.toInitState),e.on(c.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&la.clear(this._curTween),this._curTween=la.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Hi[this.effectEase],he.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&la.clear(this._curTween),this._curState=2,this._curTween=la.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Hi[this.backEase],he.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},e.Byte=$t,e.Camera2D=Dn,e.CircleMesh=wh,e.ClassUtils=Ee,e.ClipRectCmd=et,e.Color=y,e.ColorEffect2D=Sh,e.ColorFilter=Vh,e.ColorUtils=ht,e.Command2D=Oa,e.CommandBuffer2D=Wa,e.CommandEncoder=class{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(e){this._idata.push(e)}},e.CommandUniformMap=class{constructor(e){}addShaderUniform(e,t,s){throw"need override it"}addShaderUniformArray(e,t,s,r){throw"need override it"}},e.Component=fa,e.ComponentDriver=hn,e.ComputeCommandAppatchCMD=class{apply(e){throw new C}},e.ComputeCommandBuffer=class{constructor(){f.renderDeviceFactory.createComputeContext&&(this._context=f.renderDeviceFactory.createComputeContext())}getResource(){return this._context}clearCMDs(){this._context.clearCMDs()}addDispatchCommand(e,t,s,r,i){let a={shader:e.getCacheShader(s),Kernel:t,shaderData:r,dispatchParams:i.clone()};this._context.addDispatchCommand(a)}addSetShaderDataCommand(e,t,s,r){this._context.addSetShaderDataCommand(e,t,s,r)}addBufferToBufferCommand(e,t,s,r,i){this._context.addBufferToBufferCommand(e,t,s,r,i)}addClearBufferCommand(e,t,s){this._context.addClearBufferCommand(e,t,s)}addBufferToTextureCommand(e,t,s,r){}addTextureToBufferCommand(e,t,s,r){}addTextureToTextureCommand(e,t,s){this._context.addTextureToTextureCommand(e,t,s)}executeCMDs(){this._context.executeCMDs()}destroy(){this._context.destroy()}},e.ComputeShader=Wl,e.Config=t,e.Config3D=o,e.Const=De,e.CopyTextureInfo=class{constructor(){this.mipLevel=0,this.origin=new a(0,0,0)}},e.CurvePath=Ao,e.DDSTextureInfo=cs,e.DefaultStaticsContext=m,e.Delegate=B,e.DeviceAdapter=td,e.Downloader=ge,e.DragSupport=ca,e.Draw2DElementCMD=class{setRenderelements(e){throw new C}apply(e){throw new C}},e.Draw9GridTextureCmd=gt,e.DrawCircleCmd=Tt,e.DrawCurvesCmd=Mt,e.DrawEllipseCmd=Pi,e.DrawImageCmd=It,e.DrawLineCmd=Bt,e.DrawLinesCmd=Nt,e.DrawMesh2DCMD=ka,e.DrawPathCmd=Ot,e.DrawPieCmd=kt,e.DrawPolyCmd=Gt,e.DrawRectCmd=Ht,e.DrawRenderElement2DCMD=Va,e.DrawRoundRectCmd=Li,e.DrawStyle=yr,e.DrawTextureCmd=Xt,e.DrawTexturesCmd=qt,e.DrawTrianglesCmd=Kt,e.Earcut=Pr,e.EarcutNode=Ir,e.Ease=Hi,e.Effect2DShaderInit=Ma,e.EffectBase=Nh,e.Event=c,e.EventDispatcher=N,e.FadeIn=class extends Nh{_doTween(){return this.target.alpha=0,la.to(this.target,{alpha:1},this.duration,Hi[this.ease],this._comlete,this.delay)}},e.FadeOut=class extends Nh{_doTween(){return this.target.alpha=1,la.to(this.target,{alpha:0},this.duration,Hi[this.ease],this._comlete,this.delay)}},e.FastSinglelist=wa,e.FileSystemAdapter=sd,e.FillTextCmd=mi,e.FillTextureCmd=Ti,e.Filter=Uh,e.FlipMesh=bh,e.FloatKeyframe=kl,e.FontAdapter=rd,e.FrameAnimation=On,e.GLSLCodeGenerator=uh,e.GlowEffect2D=Dh,e.GlowFilter=Gh,e.Gradient=Fl,e.GradientMode=Nl,e.GrahamScan=Ie,e.Graphic2DDynamicVIBuffer=ai,e.Graphics=Ni,e.GraphicsBounds=Ve,e.GraphicsMesh=ni,e.GraphicsRenderData=Ca,e.GraphicsRunner=ci,e.GraphicsShaderInfo=Lr,e.GrayscaleEffect2D=vh,e.HDRTextureInfo=pl,e.HTMLAudioChannel=qh,e.HTMLCanvas=Re,e.HTMLVideoPlayer=Kh,e.HTMLVideoTexture=$h,e.HalfFloatUtils=Qt,e.Handler=he,e.HideFlags=be,e.HierarchyLoader=_l,e.HierarchyParser=ul,e.HierarchyResource=Wo,e.HitArea=pd,e.HtmlElement=Gn,e.HtmlImage=zn,e.HtmlLink=Hn,e.HtmlParseOptions=Wn,e.HtmlParser=qn,e.HttpRequest=pe,e.ILaya=l,e.IncludeFile=bs,e.IndexBuffer=class extends dh{constructor(t,s){super(t,s),this._indexType=e.IndexFormat.UInt16}},e.Input=co,e.InputManager=nn,e.JsonBin=gd,e.JsonBinRead=md,e.JsonBinWrite=fd,e.KTXTextureInfo=ms,e.KeyLocation=Fh,e.Keyboard=Oh,e.Keyframe=Ul,e.Keyframe2D=bo,e.KeyframeNode2D=wo,e.KeyframeNodeList2D=Fo,e.Laya=bn,e.LayaEnv=p,e.LayaGL=f,e.LoadModel2DV01=Zo,e.Loader=Te,e.LocalStorage=class{static setItem(e,t){W.storage.setItem(e,t)}static getItem(e){return W.storage.getItem(e)}static setJSON(e,t){W.storage.setItem(e,JSON.stringify(t))}static getJSON(e){return JSON.parse(W.storage.getItem(e)||null)}static removeItem(e){W.storage.removeItem(e)}static clear(){W.storage.clear()}static get count(){return W.storage.getCount()}},e.Material=Ba,e.MaterialLoader=Rl,e.MaterialParser=Cl,e.MathUtil=ut,e.MathUtils3D=r,e.Matrix=Ce,e.Matrix3x3=Us,e.Matrix4x4=js,e.MediaAdapter=ad,e.Mesh2D=Na,e.Mesh2DReader=el,e.Mesh2DRender=Fa,e.MeshLoader=Jo,e.Mouse=Su,e.Node=ki,e.NodeFlags=we,e.NotImplementedError=C,e.NotReadableError=M,e.NullLoader=bl,e.ObjDecoder=nl,e.OpenDataContextView=Gl,e.OutOfRangeError=R,e.PAL=W,e.ParseJSON=Ml,e.Path=xr,e.PathPoint=Ro,e.PlayerConfig=s,e.Point=u,e.Pool=h,e.PostProcess2D=Xa,e.PostProcess2DEffect=zl,e.PostProcessRenderContext2D=Ya,e.Prefab=zo,e.PrefabImpl=cl,e.ProgressMesh=Mh,e.Quaternion=zs,e.QuaternionKeyframe=class extends Ul{constructor(e=!1){super(),this.inTangent=new i,this.outTangent=new i,this.value=new zs,e&&(this.inWeight=new i,this.outWeight=new i,this.weightedMode=new i)}cloneTo(e){super.cloneTo(e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value),this.weightedMode&&(this.inWeight.cloneTo(t.inWeight),this.outWeight.cloneTo(t.outWeight),this.weightedMode.cloneTo(t.weightedMode))}},e.Rectangle=te,e.RegularPolygonMesh=Ph,e.Render=gn,e.Render2DProcessor=pi,e.RenderState=ws,e.RenderState2D=Ia,e.RenderTexture=z,e.RenderTexture2D=zi,e.RenderTextureCube=class extends z{constructor(e,t,s,r,i){super(e,e,t,s,r,i),this.faceIndex=0}_createRenderTarget(){this._dimension=e.TextureDimension.Cube,this._renderTarget=f.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}},e.RenderTextureLoader=yl,e.Resource=V,e.RestoreCmd=Ae,e.RotateCmd=xi,e.RoundedRectMesh=Bh,e.SaveBase=Er,e.SaveClipRect=vr,e.SaveCmd=ke,e.SaveMark=wr,e.SaveStyle=Dr,e.SaveTransform=br,e.SaveTranslate=Cr,e.ScaleCmd=vi,e.Scene=wn,e.Scene2DSpecialManager=vn,e.Script=Qo,e.SerializeUtil=rl,e.Set2DDefineCMD=Ha,e.Set2DRTCMD=Ga,e.Set2DShaderDataCMD=za,e.SetRenderDataCMD=class{get value(){return this._value}set value(e){this._value=e}get dataType(){return this._dataType}set dataType(e){this._dataType=e}get propertyID(){return this._propertyID}set propertyID(e){this._propertyID=e}get dest(){return this._dest}set dest(e){this._dest=e}apply(e){throw new C}},e.SetRendertarget2DCMD=class{constructor(){this.size=new ct}get invertY(){return this._invertY}set invertY(e){this._invertY=e}get clearColorValue(){return this._clearColorValue}set clearColorValue(e){this._clearColorValue=e}get rt(){return this._rt}set rt(e){this._rt=e}get clearColor(){return this._clearColor}set clearColor(e){this._clearColor=e}apply(e){throw new C}},e.SetShaderDefineCMD=class{get define(){return this._define}set define(e){this._define=e}get dest(){return this._dest}set dest(e){this._dest=e}get add(){return this._add}set add(e){this._add=e}apply(e){throw new C}},e.Shader2D=ba,e.Shader3D=gr,e.ShaderCompile=Fs,e.ShaderCompileDefineBase=rr,e.ShaderData=class{constructor(e=null){this._ownerResource=e}getDefineData(){throw new C}getData(){throw new C}addDefine(e){throw new C}addDefines(e){throw new C}removeDefine(e){throw new C}hasDefine(e){throw new C}clearDefine(){throw new C}clearData(){throw new C}getBool(e){throw new C}setBool(e,t){throw new C}getInt(e){throw new C}setInt(e,t){throw new C}getNumber(e){throw new C}setNumber(e,t){throw new C}getVector2(e){throw new C}setVector2(e,t){throw new C}getVector3(e){throw new C}setVector3(e,t){throw new C}getVector(e){throw new C}setVector(e,t){throw new C}getColor(e){throw new C}setColor(e,t){throw new C}getMatrix4x4(e){throw new C}setMatrix4x4(e,t){throw new C}getMatrix3x3(e){throw new C}setMatrix3x3(e,t){throw new C}getBuffer(e){throw new C}setBuffer(e,t){throw new C}setDeviceBuffer(e,t){throw new C}getStorageBuffer(e){throw new C}setTexture(e,t){throw new C}getTexture(e){throw new C}setShaderData(t,s,r){switch(s){case e.ShaderDataType.Int:this.setInt(t,r);break;case e.ShaderDataType.Bool:this.setBool(t,r);break;case e.ShaderDataType.Float:this.setNumber(t,r);break;case e.ShaderDataType.Vector2:this.setVector2(t,r);break;case e.ShaderDataType.Vector3:this.setVector3(t,r);break;case e.ShaderDataType.Vector4:this.setVector(t,r);break;case e.ShaderDataType.Color:this.setColor(t,r);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,r);break;case e.ShaderDataType.Matrix3x3:this.setMatrix3x3(t,r);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:this.setTexture(t,r);break;case e.ShaderDataType.Buffer:this.setBuffer(t,r);break;default:throw new Error(`unknown shader data type: ${s}`)}}getShaderData(t,s){switch(s){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);case e.ShaderDataType.Matrix3x3:return this.getMatrix3x3(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);default:throw"unknown shader data type."}}_setInternalTexture(e,t){throw new C}cloneTo(e){throw new C}clone(){throw new C}destroy(){throw new C}},e.ShaderDataDefaultValue=sr,e.ShaderDefine=class{constructor(e,t){this._index=e,this._value=t}},e.ShaderDefines2D=mr,e.ShaderNode=Cs,e.ShaderParser=Ll,e.ShaderPass=ir,e.ShaderVariable=_h,e.ShaderVariantCollection=ph,e.SingletonList=Da,e.Socket=class extends N{constructor(e,t,s,r,i){super(),this.disableInput=!1,Array.isArray(s)&&(r=s),"boolean"==typeof r&&(i=r,r=null),this.output=new $t,this.input=new $t,this.endian=$t.BIG_ENDIAN,e&&t>0&&t<65535&&this.connect(e,t,i,r)}get connected(){return this._connected}get endian(){return this.output.endian}set endian(e){this.input.endian=e,this.output.endian=e}connect(e,t,s,r){this.connectByUrl(`${s?"wss":"ws"}://${e}:${t}`,r)}connectByUrl(e,t){null!=this._socket&&this.close(),this.output.length=0,this.input.length=0,this._inputPos=0,Array.isArray(t)&&(t={protocols:t}),this._socket=W.browser.createWebSocket(),null!=this._socket?(this._socket.onOpen=()=>{this._connected=!0,this.event(c.OPEN)},this._socket.onClose=()=>{this._connected=!1,this.event(c.CLOSE)},this._socket.onError=e=>{this.hasListener(c.ERROR)?this.event(c.ERROR,e):console.error("Socket Error: "+A(e))},this._socket.onMessage=e=>this._onMessage(e),this._socket.open(e,t)):console.warn("WebSocket is not supported in this platform.")}close(){if(null!=this._socket){try{this._socket.close()}catch(e){}this._socket=null}this._connected=!1}cleanSocket(){this.close()}send(e){return this._socket.send(e)}flush(){if(0===this.output.length||!this._socket||!this._connected)return;let e;try{this._socket.send(this.output.rawBuffer.slice(0,this.output.length))}catch(t){e=t}this.output.clear(),e&&this.event(c.ERROR,e)}_onMessage(e){if(this.disableInput)return void this.event(c.MESSAGE,e);this.input.length>0&&this.input.bytesAvailable<1&&(this.input.clear(),this._inputPos=0);let t=this.input.pos;!this._inputPos&&(this._inputPos=0),this.input.pos=this._inputPos,"string"==typeof e?this.input.writeUTFBytes(e):this.input.writeArrayBuffer(e),this._inputPos=this.input.pos,this.input.pos=t,this.event(c.MESSAGE,e)}},e.SoundChannel=Yh,e.SoundManager=xn,e.SoundNode=_o,e.Sprite=ja,e.SpriteConst=$e,e.SpriteGlobalTransform=Sa,e.SpriteUtils=pa,e.Stage=cn,e.Stat=Vi,e.StatUI=Eu,e.StencilState=class{},e.StorageAdapter=nd,e.SubShader=pr,e.SubStructRender=Ra,e.SubmitBase=Fr,e.SubmitKey=Nr,e.Text=Kn,e.TextInputAdapter=od,e.TextRender=zr,e.TextRenderConfig=Or,e.TextResource=tl,e.TextStyle=Vn,e.Texture=ie,e.Texture2D=fs,e.Texture2DArray=mn,e.Texture2DLoader=Tl,e.Texture3D=ld,e.TextureCube=yn,e.TextureLoader=vl,e.TileMesh=Lh,e.TimeLine=dd,e.Timer=dn,e.TransformCmd=bi,e.TranslateCmd=Mi,e.Tween=la,e.TweenValue=qi,e.TweenValueAdapterKey=$i,e.Tweener=sa,e.TypedArrayClasses=sl,e.UBBParser=jn,e.URL=ee,e.UniformBufferAlone=nh,e.UniformBufferBlock=rh,e.UniformBufferCluster=ih,e.UniformBufferManager=class{constructor(e){this._destroyed=!1,this._needUpdateClusters=[],this._removeHoleArray=[],this._optimizeBufferPosArray=[],this._useBigBuffer=!0,this.byteAlign=256,this.clusterMaxBlock=256,this.uploadThreshold=200,this.removeHoleThreshold=10,this.aloneBuffers=[],this._useBigBuffer=e,this._clustersAll=new Map,this._clustersCur=new Map}_createBufferCluster(e,t){return new ih(e,t,this)}_addCluster(e,t=16){const s=ah(e,this.byteAlign),r=this._createBufferCluster(s,t),i=this._clustersAll.get(s);return i?(i.push(r),r._sn=i.length-1):this._clustersAll.set(s,[r]),this._clustersCur.set(s,r),r}startFrame(){}endFrame(){}getBufferAlone(e,t){const s=ah(e,this.byteAlign);return this.createGPUBuffer(s,t)}removeCluster(e,t){var s;const r=ah(e,this.byteAlign);if(t<0)return this._clustersAll.delete(r),void this._clustersCur.delete(r);const i=null===(s=this._clustersCur.get(r))||void 0===s?void 0:s._sn,a=this._clustersAll.get(r);if(a.length>t){if(a.splice(t,1),0===a.length)return this._clustersAll.delete(r),void this._clustersCur.delete(r);for(let e=t;e<a.length;e++)a[e]._sn--;if(void 0!==i&&i===t){let e=-1,t=-1,s=-1;for(let r=a.length-1;r>-1;r--)t=a[r].usedNum,t>e&&t<this.clusterMaxBlock&&(s=r,e=t);s>=0?this._clustersCur.set(r,a[s]):this._clustersCur.delete(r)}}}getBlock(e,t){const s=ah(e,this.byteAlign);let r=this._clustersCur.get(s);if(!r)return this._addCluster(s).getBlock(e,t);if(r.usedNum<this.clusterMaxBlock)return r.getBlock(e,t);r=null;const i=this._clustersAll.get(s);let a=-1,n=-1,o=-1;for(let e=i.length-1;e>0;e--)n=i[e].usedNum,n>a&&n<this.clusterMaxBlock&&(o=e,a=n);return o>=0?(r=i[o],this._clustersCur.set(s,r)):this._clustersCur.delete(s),r?r.getBlock(e,t):this._addCluster(s).getBlock(e,t)}freeBlock(e){const t=e.cluster;return!!t&&(!!t.freeBlock(e)&&(0===t.usedNum&&this.removeCluster(t._blockSize,t._sn),!0))}upload(){if(this._useBigBuffer){let e;for(let t=this._needUpdateClusters.length-1;t>-1;t--)e=this._needUpdateClusters[t],e.upload(),e._inManagerUpdateArray=!1;this._needUpdateClusters.length=0}}_addUpdateArray(e){e._inManagerUpdateArray||(this._needUpdateClusters.push(e),e._inManagerUpdateArray=!0)}_addRemoveHoleCluster(e){-1===this._removeHoleArray.indexOf(e)&&this._removeHoleArray.push(e)}_addOptimizeBufferPos(e){-1===this._optimizeBufferPosArray.indexOf(e)&&this._optimizeBufferPosArray.push(e)}clear(){this._clustersAll.forEach(e=>{for(let t=e.length-1;t>-1;t--)e[t].clear()})}destroy(){return this._destroyed?(console.warn("UniformBufferManager: object alreay destroyed!"),!1):(this.clear(),this._clustersAll.clear(),this._clustersCur.clear(),this._destroyed=!0,!0)}createGPUBuffer(e,t,s){}writeBuffer(e,t,s,r){}statisGPUMemory(e){}},e.UniformBufferUser=oh,e.Utils=Q,e.Vector2=ct,e.Vector2Keyframe=class extends Ul{constructor(t=!1){super(),this.inTangent=new ct,this.outTangent=new ct,this.value=new ct,t&&(this.inWeight=new ct(Ul.defaultWeight,Ul.defaultWeight),this.outWeight=new ct(Ul.defaultWeight,Ul.defaultWeight),this.weightedMode=new ct(e.WeightedMode.None,e.WeightedMode.None))}cloneTo(e){super.cloneTo(e),this.inTangent.cloneTo(e.inTangent),this.outTangent.cloneTo(e.outTangent),this.value.cloneTo(e.value),this.weightedMode&&(this.inWeight.cloneTo(e.inWeight),this.outWeight.cloneTo(e.outWeight),this.weightedMode.cloneTo(e.weightedMode))}},e.Vector3=a,e.Vector3Keyframe=class extends Ul{constructor(t=!1){super(),this.inTangent=new a,this.outTangent=new a,this.value=new a,t&&(this.inWeight=new a(Ul.defaultWeight,Ul.defaultWeight,Ul.defaultWeight),this.outWeight=new a(Ul.defaultWeight,Ul.defaultWeight,Ul.defaultWeight),this.weightedMode=new a(e.WeightedMode.None,e.WeightedMode.None,e.WeightedMode.None))}cloneTo(e){super.cloneTo(e),this.inTangent.cloneTo(e.inTangent),this.outTangent.cloneTo(e.outTangent),this.value.cloneTo(e.value),this.weightedMode&&(this.inWeight.cloneTo(e.inWeight),this.outWeight.cloneTo(e.outWeight),this.weightedMode.cloneTo(e.weightedMode))}},e.Vector4=i,e.Vector4Keyframe=class extends Ul{constructor(t=!1){super(),this.inTangent=new i,this.outTangent=new i,this.value=new i,t&&(this.inWeight=new i(Ul.defaultWeight,Ul.defaultWeight,Ul.defaultWeight,Ul.defaultWeight),this.outWeight=new i(Ul.defaultWeight,Ul.defaultWeight,Ul.defaultWeight,Ul.defaultWeight),this.weightedMode=new i(e.WeightedMode.None,e.WeightedMode.None,e.WeightedMode.None,e.WeightedMode.None))}cloneTo(e){super.cloneTo(e),this.inTangent.cloneTo(e.inTangent),this.outTangent.cloneTo(e.outTangent),this.value.cloneTo(e.value),this.weightedMode&&(this.inWeight.cloneTo(e.inWeight),this.outWeight.cloneTo(e.outWeight),this.weightedMode.cloneTo(e.weightedMode))}},e.VertexAttributeLayout=gh,e.VertexBuffer=class extends dh{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(e){this._instanceBuffer=e}constructor(e,t){super(e,t),this._instanceBuffer=!1,this._vertexDeclaration=null}},e.VertexDeclaration=cr,e.VertexElement=nr,e.VertexElementFormat=dr,e.VertexMesh=_r,e.VertexMesh2D=La,e.VertexStateContext=ur,e.VertexStream=_t,e.VideoNode=po,e.VideoPlayer=jh,e.VideoTexture=ml,e.VideoTextureLoader=xl,e.Viewport=Hh,e.WasmAdapter=wu,e.WeakObject=bu,e.WebAudioChannel=Qh,e.WebGLRTMgr=hd,e.Widget=En,e.WorkerLoader=ne,e.XML=_e,e.XMLIterator=ce,e.XMLUtils=de,e._WebSocket=Zh,e.addAfterInitCallback=Nn,e.addBeforeInitCallback=Ln,e.addInitCallback=Bn,e.alertGlobalError=Pn,e.allowMultiple=function(e){e.prototype._$singleton=!1},e.checkShaderDataValueLegal=tr,e.classInfo=function(e){return ve},e.genSliceMesh=ot,e.genTileMesh=lt,e.getCompressTextureRenderCapable=b,e.getErrorMsg=A,e.importNative=Fn,e.init=Rn,e.isUboBufferShaderType=function(t){return!(t===e.ShaderDataType.ReadOnlyDeviceBuffer||t===e.ShaderDataType.DeviceBuffer||t===e.ShaderDataType.StorageTexture2D||t===e.ShaderDataType.Texture2D||t===e.ShaderDataType.Texture3D||t===e.ShaderDataType.TextureCube||t===e.ShaderDataType.Texture2DArray)},e.measureFont=Ur,e.property=function(e){return ve},e.regClass=function(e){return function(t){Ee.regClass(e,t)}},e.regLoader=function(e,t,s){return function(r){Te.registerLoader(e,r,t,s)}},e.roundDown=function(e,t){const s=((e+t-1)/t|0)*t;return s>e?s-t:s},e.roundUp=ah,e.runInEditor=function(e){},e}({});